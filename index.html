<!DOCTYPE html>
<html lang="ko" style="height: 100%; height: -webkit-fill-available">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#6366f1" />
    <title>Foodie</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Foodie" />
    <meta property="og:description" content="Foodie 동아리 웹 서비스" />
    <meta property="og:image" content="./icons/icon-512-new.png" />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta property="og:url" content="" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:title" content="Foodie" />
    <meta property="twitter:description" content="Foodie 동아리 웹 서비스" />
    <meta property="twitter:image" content="./icons/icon-512-new.png" />

    <!-- 일반 메타 -->
    <meta name="description" content="Foodie 동아리 웹 서비스" />

    <!-- 앱 아이콘 -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./icons/favicon-32.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./icons/apple-touch-icon-180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="./icons/icon-192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="./icons/icon-512.png"
    />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Loading Animation -->
    <style>
      @keyframes dot-pulse {
        0%,
        100% {
          transform: scale(0.5);
          opacity: 0.3;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      @keyframes bounce {
        0%,
        100% {
          transform: scale(1) translateY(0);
        }
        50% {
          transform: scale(1.1) translateY(-10px);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(-10px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out;
      }

      /* 부드러운 페이드 효과 애니메이션 */
      @keyframes smoothFade {
        0% {
          opacity: 0;
          transform: translateY(10px) scale(0.95);
        }
        15% {
          opacity: 0;
          transform: translateY(10px) scale(0.95);
        }
        50% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        85% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
      }

      .smooth-fade {
        animation: smoothFade 2.5s ease-in-out;
        display: inline-block;
      }

      /* 말풍선 버튼 스타일 */
      .speech-bubble-btn {
        position: relative;
        background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }

      .speech-bubble-btn::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 20px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #ff6b6b;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.1));
      }

      .speech-bubble-btn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .speech-bubble-btn:active {
        transform: translateY(0) scale(1);
      }

      @keyframes wiggle {
        0%,
        100% {
          transform: rotate(0deg);
        }
        25% {
          transform: rotate(-5deg);
        }
        75% {
          transform: rotate(5deg);
        }
      }

      .speech-bubble-btn:hover {
        animation: wiggle 0.5s ease-in-out;
      }

      /* 모바일 텍스트 잘림 방지 */
      * {
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
      }

      /* 모바일에서 텍스트 크기 최적화 */
      @media (max-width: 768px) {
        .text-sm {
          font-size: 0.875rem !important;
        }
        .text-base {
          font-size: 1rem !important;
        }
        .text-lg {
          font-size: 1.125rem !important;
        }
        .text-xl {
          font-size: 1.25rem !important;
        }
        .text-2xl {
          font-size: 1.5rem !important;
        }

        /* 긴 텍스트 자동 줄바꿈 */
        .truncate {
          white-space: normal !important;
          overflow: visible !important;
          text-overflow: unset !important;
        }

        /* 모바일 확대 방지 및 스크롤바 숨김 */
        body {
          -webkit-text-size-adjust: 100%;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          touch-action: manipulation;
        }

        /* 스크롤바 숨김 */
        ::-webkit-scrollbar {
          width: 0px;
          background: transparent;
        }

        ::-webkit-scrollbar-track {
          background: transparent;
        }

        ::-webkit-scrollbar-thumb {
          background: transparent;
        }

        /* Firefox용 스크롤바 숨김 */
        html {
          scrollbar-width: none;
        }

        /* 전체 화면 스크롤바 숨김 */
        body {
          overflow-x: hidden;
        }

        /* 모바일에서 확대 방지 */
        @media (max-width: 768px) {
          html {
            -webkit-text-size-adjust: none;
            -ms-text-size-adjust: none;
          }

          input,
          textarea,
          select {
            font-size: 16px !important;
          }
        }

        /* 블록 제목 최적화 */
        .block-title {
          word-break: keep-all;
          line-height: 1.4;
          hyphens: auto;
        }

        /* 카드 내 텍스트 최적화 */
        .card-text {
          word-break: keep-all;
          line-height: 1.5;
          overflow-wrap: break-word;
        }

        /* 버튼 텍스트 최적화 */
        .btn-text {
          white-space: normal;
          word-break: keep-all;
        }

        /* 모바일에서 패딩 조정 */
        .mobile-padding {
          padding-left: 0.75rem;
          padding-right: 0.75rem;
        }

        /* 모바일에서 마진 조정 */
        .mobile-margin {
          margin-left: 0.5rem;
          margin-right: 0.5rem;
        }
      }
    </style>
    <script>
      tailwind.config = {
        future: {
          hoverOnlyWhenSupported: true,
        },
        experimental: {
          optimizeUniversalDefaults: true,
        },
        // CDN 사용 경고 무시
        theme: {
          extend: {},
        },
      };
    </script>

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- FontAwesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>

    <!-- XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- DOMPurify (XSS 방지) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

    <style>
      :root {
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Noto Sans KR", sans-serif;
        padding-top: var(--safe-top);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .card-hover {
        transition: 0.3s;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      /* 로딩 화면 전체 화면 차지 */
      #loading-screen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        height: 100dvh !important; /* 동적 뷰포트 높이 (모바일 사파리) */
        min-height: 100vh !important;
        z-index: 9999 !important;
        overflow: hidden !important;
      }

      /* 사파리에서 안전 영역 고려 */
      @supports (padding: max(0px)) {
        #loading-screen {
          padding-top: max(0px, env(safe-area-inset-top)) !important;
          padding-bottom: max(0px, env(safe-area-inset-bottom)) !important;
          padding-left: max(0px, env(safe-area-inset-left)) !important;
          padding-right: max(0px, env(safe-area-inset-right)) !important;
        }
      }

      /* 동아리 설명 문구 스타일 */
      .club-description {
        font-size: 1rem;
        font-weight: 500;
        color: #f97316;
        margin-bottom: 0.5rem;
        text-align: left;
        opacity: 0.8;
        margin-left: 9.5rem;
        margin-top: -0.5rem;
      }

      /* 푸디 로고 스타일 */
      .foodie-logo {
        font-size: 5rem;
        font-weight: bold;
        color: #f97316;
        margin-bottom: 0;
        text-shadow: 2px 2px 4px rgba(249, 115, 22, 0.2);
        line-height: 1;
        position: relative;
      }

      /* 웃는 모양 진행바 컨테이너 - 약간 오른쪽으로 이동 */
      .foodie-loader {
        width: 150px;
        height: 60px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        margin-bottom: 1.5rem;
        margin-top: -5px;
        margin-left: -70px;
      }

      /* SVG 진행바 스타일 - 원래 굵기 유지 */
      .smile-progress-bg {
        stroke: #fed7aa;
        stroke-width: 14;
        fill: none;
        stroke-linecap: round;
      }

      .smile-progress-fill {
        stroke: #f97316;
        stroke-width: 14;
        fill: none;
        stroke-linecap: round;
        stroke-dasharray: 200;
        stroke-dashoffset: 200;
        transition: stroke-dashoffset 0.5s ease-in-out;
      }

      .smile-progress-fill.loading {
        animation: loading-glow 2s ease-in-out infinite;
      }

      @keyframes loading-glow {
        0%,
        100% {
          opacity: 0.8;
        }
        50% {
          opacity: 1;
        }
      }

      /* 조모임 버튼 그라데이션 빛 효과 (2초마다 반복) */
      .rank-button-glow {
        position: relative;
        overflow: hidden;
      }

      .rank-button-glow::before {
        content: "";
        position: absolute;
        top: 0;
        left: -150%;
        width: 150%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.4) 30%,
          rgba(255, 255, 255, 0.6) 50%,
          rgba(255, 255, 255, 0.4) 70%,
          transparent 100%
        );
        animation: rank-shine 2s ease-in-out infinite;
      }

      @keyframes rank-shine {
        0%,
        75% {
          left: -150%;
        }
        90% {
          left: 100%;
        }
        100% {
          left: 100%;
        }
      }
      .tab-btn {
        position: relative;
        overflow: hidden;
      }
      .tab-btn.active {
        color: #fff;
        background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
        box-shadow: 0 6px 12px rgba(249, 115, 22, 0.3),
          0 2px 4px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      .tab-btn:not(.active) {
        background: #ffffff;
        border: 2px solid #e5e7eb;
      }
      .tab-btn:not(.active):hover {
        background: #fff7ed;
        border-color: #fdba74;
        box-shadow: 0 2px 8px rgba(249, 115, 22, 0.15);
        transform: translateY(-1px);
      }
      .roadmap-subtab.active {
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          padding 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 0;
        opacity: 0;
        will-change: max-height, padding, opacity;
      }

      .accordion-item.active .accordion-content {
        max-height: 2000px;
        padding: 0;
        opacity: 1;
      }

      .accordion-item.active .accordion-icon {
        transform: rotate(180deg);
      }
      .accordion-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: background-color;
      }
      .accordion-header:hover {
        background-color: rgba(0, 0, 0, 0.02);
      }
      .accordion-header .fa-chevron-down,
      .accordion-icon {
        flex: 0 0 auto;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
      }
      .accordion-item.active .accordion-header .fa-chevron-down,
      .accordion-item.active .accordion-icon {
        transform: rotate(180deg);
      }

      /* 120Hz 디스플레이 지원 */
      @media (min-resolution: 120dpi) {
        .accordion-content {
          transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            padding 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-header {
          transition: background-color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-header .fa-chevron-down,
        .accordion-icon {
          transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* 로드맵 아코디언 스타일 */
      .roadmap-accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        will-change: max-height, opacity;
      }

      .roadmap-accordion-content.expanded {
        max-height: 2000px;
        opacity: 1;
        padding-top: 1rem;
      }

      .roadmap-accordion-content.expanded .roadmap-timeline {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
      }

      /* 120Hz 디스플레이 지원 */
      @media (min-resolution: 120dpi) {
        .roadmap-accordion-content {
          transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* 일정 블록 스타일 */
      .schedule-blocks-container {
        display: grid;
        gap: 1rem;
        margin-top: 1rem;
      }

      /* 반응형 그리드 레이아웃 */
      .schedule-blocks-container {
        grid-template-columns: 1fr;
      }

      /* 모바일: 2개씩 (320px ~ 640px) */
      @media (max-width: 640px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
          gap: 0.75rem;
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* 작은 태블릿: 2개씩 (641px ~ 768px) */
      @media (min-width: 641px) and (max-width: 768px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* 태블릿: 2개씩 (769px ~ 1024px) */
      @media (min-width: 769px) and (max-width: 1024px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* 데스크톱: 3개씩 (1025px ~ 1280px) */
      @media (min-width: 1025px) and (max-width: 1280px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(3, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 4) {
          display: none;
        }
      }

      /* 대형 데스크톱: 4개씩 (1281px ~ 1440px) */
      @media (min-width: 1281px) and (max-width: 1440px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(4, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 5) {
          display: none;
        }
      }

      /* 초대형 화면: 4개씩 (1441px+) */
      @media (min-width: 1441px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(4, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 5) {
          display: none;
        }
      }

      /* 일정 블록 카드 */
      .schedule-block {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .schedule-block:hover {
        border-color: #f97316;
        box-shadow: 0 8px 25px rgba(249, 115, 22, 0.15);
        transform: translateY(-2px);
      }

      /* 다음 일정 강조 */
      .schedule-block.next-schedule {
        border: 2px solid #fb923c;
        background: white;
        box-shadow: 0 4px 20px rgba(249, 115, 22, 0.15);
      }

      .schedule-block.next-schedule::before {
        content: "다음 일정";
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
      }

      /* 완료된 일정 */
      .schedule-block.completed {
        opacity: 0.7;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-color: #d1d5db;
      }

      .schedule-block.completed::before {
        content: "완료";
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: #ef4444;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      }

      /* 블록 내용 */
      .schedule-block-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .schedule-block-date {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .schedule-block-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        line-height: 1.4;
        flex-grow: 1;
      }

      .schedule-block-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
      }

      .schedule-action-btn {
        padding: 0.5rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
      }

      .schedule-edit-btn {
        background: #3b82f6;
        color: white;
      }

      .schedule-edit-btn:hover {
        background: #2563eb;
        transform: scale(1.05);
      }

      .schedule-delete-btn {
        background: #ef4444;
        color: white;
      }

      .schedule-delete-btn:hover {
        background: #dc2626;
        transform: scale(1.05);
      }

      .schedule-download-btn {
        background: #10b981;
        color: white;
      }

      .schedule-download-btn:hover {
        background: #059669;
        transform: scale(1.05);
      }

      /* 달력 스타일 */
      .calendar-container {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        padding: 1.5rem;
        padding-bottom: 2rem; /* 하단 패딩 증가 */
        margin-top: 1rem;
        margin-bottom: 1rem; /* 하단 마진 추가 */
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        min-height: 500px;
        width: 100%;
        max-width: 100%;
        overflow: visible;
      }

      .calendar-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f97316;
      }

      .calendar-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .calendar-nav-prev {
        order: 1;
      }

      .calendar-month-year {
        order: 2;
        flex: 1;
        text-align: center;
      }

      .calendar-nav-next {
        order: 3;
      }

      .calendar-nav-btn {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.375rem 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        min-width: 2rem;
        height: 2rem;
      }

      .calendar-nav-btn:hover {
        background: linear-gradient(135deg, #ea580c, #dc2626);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      }

      .calendar-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        text-align: center;
      }

      .calendar-nav-btn {
        background: #f97316;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }

      .calendar-nav-btn:hover {
        background: #ea580c;
        transform: scale(1.05);
      }

      .calendar-nav-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
      }

      .calendar-month-year {
        font-size: 1.125rem;
        font-weight: 600;
        color: #374151;
        min-width: 150px;
        text-align: center;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #e5e7eb;
        border-radius: 8px;
        min-height: 450px; /* 데스크톱에서도 충분한 높이 확보 */
        overflow: hidden;
        width: 100%;
        table-layout: fixed;
      }

      .calendar-day-header {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.875rem;
      }

      .calendar-day {
        background: white;
        min-height: 100px;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .calendar-day:hover {
        background: #fef3c7;
      }

      .calendar-day.other-month {
        background: #f9fafb;
        color: #9ca3af;
      }

      .calendar-day.today {
        background: linear-gradient(135deg, #fff7ed, #fed7aa);
        border: 2px solid #f97316;
      }

      .calendar-day-number {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }

      .calendar-event {
        background: #f97316;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: visible;
        white-space: normal;
        line-height: 1.3;
        margin-bottom: 0.125rem;
        width: 100%;
        max-width: 100%;
        min-width: 0;
        flex-shrink: 0;
        box-sizing: border-box;
        /* 글자 크기 자동 조정을 위한 설정 */
        font-size: clamp(0.625rem, 2.5vw, 0.75rem);
        transform-origin: center;
        text-align: center;
      }

      .calendar-event:hover {
        background: #ea580c;
        transform: scale(1.05);
      }

      .calendar-event.completed {
        background: #ef4444;
      }

      .calendar-event.completed:hover {
        background: #dc2626;
      }

      .calendar-event.next {
        background: #10b981;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      }

      .calendar-event.next:hover {
        background: #059669;
      }

      /* 달력 이벤트 텍스트 크기 클래스 */
      .calendar-event.text-xs {
        font-size: 0.625rem;
      }

      .calendar-event.text-sm {
        font-size: 0.6875rem;
      }

      /* 운영진 전용 일정 스타일 (파란색) */
      .calendar-event.admin-only {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
        color: white !important;
        border: 1px solid #1e40af !important;
        font-weight: 500;
      }

      .calendar-event.admin-only:hover {
        background: linear-gradient(135deg, #2563eb, #1e40af) !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }

      /* 달력 반응형 */
      @media (max-width: 768px) {
        .calendar-container {
          padding: 0.75rem;
          padding-bottom: 1.5rem; /* 모바일에서도 하단 패딩 증가 */
          margin-top: 0.5rem;
          margin-bottom: 1rem; /* 모바일에서도 하단 마진 추가 */
          border-radius: 12px;
          width: 100%;
          max-width: 100%;
          overflow: visible;
        }

        .calendar-header {
          flex-direction: column;
          gap: 0.75rem;
          text-align: center;
          margin-bottom: 1rem;
          padding-bottom: 0.75rem;
        }

        .calendar-nav-btn {
          padding: 0.25rem 0.5rem;
          font-size: 0.75rem;
          min-width: 1.75rem;
          height: 1.75rem;
        }

        .calendar-title {
          font-size: 1.25rem;
        }

        .calendar-nav-btn {
          width: 36px;
          height: 36px;
          padding: 0.375rem;
        }

        .calendar-month-year {
          font-size: 1rem;
          min-width: 120px;
        }

        .calendar-grid {
          min-height: 400px; /* 최소 높이 증가 */
          grid-template-columns: repeat(7, 1fr);
          width: 100%;
          table-layout: fixed;
        }

        .calendar-day {
          min-height: 70px;
          padding: 0.25rem;
          overflow: hidden;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }

        .calendar-day-number {
          font-size: 0.75rem;
          margin-bottom: 0.125rem;
        }

        .calendar-event {
          font-size: clamp(0.5rem, 2vw, 0.625rem);
          padding: 0.1875rem 0.375rem;
          border-radius: 8px;
          white-space: nowrap;
          overflow: hidden;
          line-height: 1.1;
          width: 100%;
          max-width: 100%;
          flex-shrink: 0;
          box-sizing: border-box;
          transform-origin: center;
        }

        .calendar-day-header {
          padding: 0.5rem 0.25rem;
          font-size: 0.75rem;
        }

        /* 모바일 달력 이벤트 텍스트 크기 클래스 */
        .calendar-event.text-xs {
          font-size: 0.5rem;
        }

        .calendar-event.text-sm {
          font-size: 0.5625rem;
        }

        /* 모바일 운영진 전용 일정 스타일 */
        .calendar-event.admin-only {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
          color: white !important;
          border: 1px solid #1e40af !important;
          font-weight: 500;
        }
      }

      /* 화면 깜빡거림 방지를 위한 부드러운 전환 효과 */
      .smooth-transition {
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      }

      .content-loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .content-loaded {
        opacity: 1;
        pointer-events: auto;
      }

      /* 관리자 패널 및 특정 영역에서 텍스트 복사 허용 */
      #dashboard-overlay,
      #dashboard-overlay *,
      .admin-panel,
      .admin-panel *,
      #subtab-container,
      #subtab-container *,
      .member-card,
      .member-card *,
      .footer-selectable,
      .footer-selectable *,
      input,
      textarea,
      select {
        -webkit-user-select: text !important;
        -khtml-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
      }

      /* 버튼과 아이콘은 여전히 선택 불가 */
      button,
      button *,
      .fa,
      .fas,
      .far,
      .fab {
        -webkit-user-select: none !important;
        -khtml-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
      }

      /* 로고 이미지 배경색 변경 */
      .logo-image {
        background: linear-gradient(135deg, #f97316, #ea580c);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(249, 115, 22, 0.2);
        transition: all 0.3s ease;
      }

      .logo-image:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(249, 115, 22, 0.3);
      }

      /* 로고 이미지 내부 이미지 스타일링 */
      .logo-image img {
        border-radius: 8px;
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
      }

      /* 모바일 일정 블록 최적화 */
      @media (max-width: 640px) {
        .schedule-blocks-container {
          gap: 0.75rem;
          margin-top: 0.75rem;
        }

        .schedule-block {
          padding: 0.875rem;
          border-radius: 10px;
          min-height: 120px;
        }

        .schedule-block-title {
          font-size: 0.9375rem;
          margin-bottom: 0.5rem;
          line-height: 1.3;
        }

        .schedule-block-date {
          font-size: 0.75rem;
          margin-bottom: 0.25rem;
        }

        .schedule-action-btn {
          padding: 0.25rem;
          font-size: 0.6875rem;
          min-height: 28px;
        }

        .schedule-block.next-schedule::before,
        .schedule-block.completed::before {
          font-size: 0.5625rem;
          padding: 0.125rem 0.375rem;
          top: 0.375rem;
          right: 0.375rem;
        }
      }

      /* 매우 작은 모바일 화면 */
      @media (max-width: 480px) {
        .schedule-blocks-container {
          gap: 0.5rem;
          margin-top: 0.5rem;
        }

        .schedule-block {
          padding: 0.75rem;
          border-radius: 8px;
          min-height: 100px;
        }

        .schedule-block-title {
          font-size: 0.875rem;
          margin-bottom: 0.375rem;
          line-height: 1.2;
        }

        .schedule-block-date {
          font-size: 0.6875rem;
          margin-bottom: 0.25rem;
        }

        .schedule-action-btn {
          padding: 0.1875rem;
          font-size: 0.625rem;
          min-height: 24px;
        }

        .schedule-block.next-schedule::before,
        .schedule-block.completed::before {
          font-size: 0.5rem;
          padding: 0.125rem 0.25rem;
          top: 0.25rem;
          right: 0.25rem;
        }
      }

      .roadmap-item {
        position: relative;
        padding-left: 30px;
        padding-bottom: 1.25rem;
      }
      .roadmap-item:not(:last-child) {
        padding-bottom: 2rem;
      }
      .roadmap-item:not(:last-child)::before {
        content: "";
        position: absolute;
        left: 7px;
        top: 16px;
        width: 2px;
        height: 100%;
        background: #e2e8f0;
      }
      .roadmap-item.completed:not(:last-child)::before {
        background: #6366f1;
      }
      .roadmap-item::after {
        content: "";
        position: absolute;
        left: 0;
        top: 4px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #e2e8f0;
      }
      .roadmap-item.completed::after {
        border-color: #6366f1;
        background: #6366f1;
      }
      .roadmap-item.today::after {
        border-color: #f59e0b;
        background: #f59e0b;
      }
      .table-sticky th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 1;
      }
      input,
      select,
      textarea {
        font-size: 16px !important;
      }
      .btn-lg {
        padding: 0.8rem 1rem;
        border-radius: 0.65rem;
        font-weight: 700;
      }
      .input-lg {
        padding: 0.85rem 1rem;
        border-radius: 0.65rem;
      }
      .section {
        background: #fff;
        border-radius: 1.25rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04),
          0 8px 24px rgba(0, 0, 0, 0.06);
        padding: 1rem;
      }
      @media (min-width: 768px) {
        .section {
          padding: 1.5rem;
        }
      }
      .thumb {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
      }
      .dz {
        width: 64px;
        height: 64px;
        border: 2px dashed #c7d2fe;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #4f46e5;
        cursor: pointer;
        background: #eef2ff;
      }
      .dz.drag {
        border-color: #6366f1;
        background: #e0e7ff;
      }
      .dz-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border-radius: 0.5rem;
      }
      #presence-pop {
        position: absolute;
        transform: translateY(8px);
      }
      .subtab-btn.active {
        background: #111827;
        color: #fff;
      }
      .sortable li {
        user-select: none;
      }
      .dragging {
        opacity: 0.5;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
      }
      /* 타입별 카드 상단 보더(직관적 색상) */
      .accent-tasting {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-general {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-mt {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-assembly {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      body {
        background: #f3f4f6;
        color: #111827;
      }
      .section {
        background: #ffffff;
      }
      #presence-pop,
      .accordion-content,
      .prose {
        color: #111827;
      }

      /* ==== 수평 로드맵 (로그인 후) ==== */
      .h-roadmap {
        display: flex;
        flex-direction: row;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 8px;
        scroll-snap-type: x mandatory;
        scrollbar-width: thin;
      }
      .h-item {
        min-width: 220px;
        scroll-snap-align: start;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 12px;
        padding: 12px;
        position: relative;
        transition: transform 0.2s;
      }
      .h-item:hover {
        transform: translateY(-2px);
      }
      .h-item.completed {
        opacity: 0.65;
        filter: grayscale(0.15);
      }
      .h-item.today::after {
        content: "오늘";
        position: absolute;
        top: 8px;
        right: 10px;
        font-size: 11px;
        color: #f59e0b;
        font-weight: 700;
      }
      .v-item {
        width: 100%;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        position: relative;
        transition: transform 0.2s;
      }
      .v-item:hover {
        transform: translateY(-2px);
      }
      .v-item.completed {
        opacity: 0.65;
        filter: grayscale(0.15);
      }
      .v-item.today::after {
        content: "오늘";
        position: absolute;
        top: 8px;
        right: 10px;
        font-size: 11px;
        color: #f59e0b;
        font-weight: 700;
      }

      .h-pulse {
        animation: hblink 1.6s ease-out infinite;
      }

      /* ==== 컴팩트 가로 스크롤 로드맵 (로그인 화면용) ==== */
      .roadmap-timeline {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        overflow-x: auto;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }

      .roadmap-timeline::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      .timeline-item {
        flex: 0 0 180px;
        min-width: 180px;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .timeline-content {
        background: white;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        border: 1px solid #f3f4f6;
        height: 100%;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 100px;
      }

      .timeline-content:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        border-color: #fb923c;
      }

      .timeline-admin-buttons {
        display: flex;
        gap: 4px;
        margin-left: 8px;
      }

      .timeline-edit-btn,
      .timeline-delete-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
      }

      .timeline-edit-btn {
        background: #3b82f6;
        color: white;
      }

      .timeline-edit-btn:hover {
        background: #2563eb;
        transform: scale(1.1);
      }

      .timeline-delete-btn {
        background: #ef4444;
        color: white;
      }

      .timeline-delete-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      .timeline-item.completed .timeline-content {
        opacity: 0.8;
        background: #fef7ed;
        border-color: #fed7aa;
      }

      /* 관리자용 새 일정 추가 블록 스타일 */
      .timeline-item.admin-placeholder .timeline-content {
        background: #fff7ed;
        border: 2px dashed #fb923c;
        opacity: 0.9;
        transition: all 0.3s ease;
      }

      .timeline-item.admin-placeholder .timeline-content:hover {
        background: #fed7aa;
        border-color: #ea580c;
        opacity: 1;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(251, 146, 60, 0.15);
      }

      .admin-placeholder-content {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .admin-placeholder-icon {
        color: #ea580c;
        font-size: 20px;
        background: #fed7aa;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .timeline-item.admin-placeholder:hover .admin-placeholder-icon {
        background: #fdba74;
        transform: scale(1.1);
      }

      .admin-placeholder-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .admin-placeholder-title {
        font-weight: 600;
        color: #c2410c;
        font-size: 13px;
      }

      .admin-placeholder-subtitle {
        font-size: 11px;
        color: #ea580c;
        line-height: 1.3;
      }

      .timeline-add-btn {
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .timeline-add-btn:hover {
        background: #4b5563;
        transform: scale(1.1);
      }

      .timeline-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 6px;
        font-size: 13px;
        line-height: 1.3;
        min-height: auto;
        display: flex;
        align-items: flex-start;
        flex-wrap: wrap;
        word-break: keep-all;
        overflow-wrap: break-word;
      }

      .timeline-date {
        font-size: 11px;
        color: #6b7280;
        font-weight: 500;
        margin-top: auto;
        padding-top: 6px;
        border-top: 1px solid #f3f4f6;
      }

      .timeline-today-badge {
        display: inline-block;
        background: #fed7aa;
        color: #ea580c;
        padding: 1px 6px;
        border-radius: 8px;
        font-size: 9px;
        font-weight: 600;
        margin-left: 6px;
        margin-top: 1px;
      }

      /* 모바일 최적화 */
      @media (max-width: 768px) {
        .roadmap-timeline {
          gap: 8px;
          padding: 8px 0;
        }

        .timeline-item {
          flex: 0 0 140px;
          min-width: 140px;
        }

        .timeline-content {
          padding: 8px;
          min-height: 85px;
        }

        .timeline-title {
          font-size: 11px;
          min-height: 2.2em;
        }

        .timeline-date {
          font-size: 9px;
        }
      }
      @keyframes hblink {
        0% {
          box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.45);
        }
        70% {
          box-shadow: 0 0 0 14px rgba(99, 102, 241, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
        }
      }

      /* ==== 참가자 카드형 리스트 (텍스트 선택 가능 유지) ==== */
      .participants-wrap {
        display: grid;
        gap: 6px;
      }
      .participant-chip {
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: 10px;
        padding: 6px 8px;
      }
      .participant-chip .avatar {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--accent);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* ==== 모든 화면에서 버튼 방식 순서변경 ==== */
      .mobile-reorder {
        display: flex;
        gap: 6px;
      }
      .mobile-reorder button {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 4px 8px;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
      }
      .mobile-reorder button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
      }
      .mobile-reorder button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .grip {
        display: none !important;
      } /* 모든 화면에서 드래그 핸들 숨김 */
      .sortable [draggable="true"] {
        cursor: default;
      }

      /* 다크모드에서 약간 더 대비 */
      [data-theme="dark"] .accordion-item.active .accordion-content {
        background: #0f1422;
        border-radius: 12px;
      }
      [data-theme="dark"] .dz {
        background: #0f1422;
        border-color: #233055;
        color: #a5b4fc;
      }

      /* 모바일 최적화 - 버튼 위치 조정 */
      @media (max-width: 768px) {
        .block-admin-controls {
          position: absolute !important;
          top: 0.5rem !important;
          right: 0.5rem !important;
          bottom: auto !important;
        }

        .accordion-header {
          padding: 1rem !important;
        }

        .accordion-header h3 {
          font-size: 1rem !important;
          line-height: 1.4 !important;
        }

        .section {
          margin-bottom: 1rem !important;
        }

        .participant-chip {
          flex-direction: column !important;
          align-items: flex-start !important;
          gap: 0.5rem !important;
        }

        .event-card {
          padding: 1rem !important;
        }

        .event-card h3 {
          font-size: 1rem !important;
          margin-bottom: 0.5rem !important;
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-100 flex flex-col min-h-screen"
    style="min-height: 100vh; min-height: -webkit-fill-available"
  >
    <!-- Loading -->
    <div
      id="loading-screen"
      class="fixed bg-white flex flex-col justify-center items-center"
      style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        z-index: 9999;
        overflow: hidden;
      "
    >
      <!-- 뭐먹지 말풍선 버튼 -->
      <div style="margin-bottom: 20px">
        <button
          class="speech-bubble-btn"
          id="loading-food-btn"
          disabled
          style="cursor: default; opacity: 0.9"
        >
          <span style="font-size: 16px">🍽️</span>
          <span
            >오늘
            <span id="meal-time-cube" class="inline-block font-bold">아침</span>
            뭐먹지?</span
          >
        </button>
      </div>

      <!-- F👀die 로고 -->
      <div class="foodie-logo">F👀die</div>

      <!-- 웃는 모양 진행바 (더 긴 길이로 조정) -->
      <div class="foodie-loader">
        <svg
          width="150"
          height="60"
          viewBox="0 0 150 60"
          xmlns="http://www.w3.org/2000/svg"
        >
          <!-- 배경 호 (연한 주황색) -->
          <path
            class="smile-progress-bg"
            d="M 15 30 Q 75 58 135 30"
            stroke-linecap="round"
          />

          <!-- 진행바 호 (주황색) -->
          <path
            id="progress-bar"
            class="smile-progress-fill loading"
            d="M 15 30 Q 75 58 135 30"
            stroke-linecap="round"
          />
        </svg>
      </div>
    </div>

    <div
      class="container mx-auto px-3 sm:px-4 md:px-6 py-4 md:py-8 flex-grow max-w-6xl"
    >
      <header class="text-center mb-6 md:mb-10 relative">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <!-- 뭐먹지 버튼 (맨 왼쪽) -->
          <button
            id="header-food-btn"
            class="speech-bubble-btn"
            style="margin-top: 0px"
          >
            <span style="font-size: 14px">🍽️</span>
            <span>뭐먹지?</span>
          </button>

          <!-- 접속자 명단과 조모임 순위 - 모든 화면에서 오른쪽 끝으로 밀착 -->
          <div
            id="game-buttons-container"
            class="flex items-center gap-2 ml-auto"
          >
            <!-- 접속자(모두 보임) -->
            <button
              id="presence-badge"
              class="text-sm md:text-base bg-gray-800 text-white rounded-full px-3 py-1 hover:bg-gray-700"
            >
              👥 접속 <b id="presence-count">0</b>명
            </button>
            <!-- 조모임 순위(모두 보임) -->
            <button
              id="rank-button"
              class="text-sm md:text-base bg-orange-500 text-white rounded-full px-3 py-1 hover:bg-orange-600 rank-button-glow"
            >
              🏅 조모임
            </button>
            <!-- 받은함 버튼 (알림 + 문의) -->
            <button
              id="notification-badge"
              class="text-sm md:text-base bg-orange-500 text-white rounded-full px-3 py-1 hover:bg-orange-600 shadow-md hover:shadow-lg transition-all relative"
            >
              <i class="fas fa-inbox mr-1"></i>
              <span
                id="notification-count"
                class="hidden bg-red-600 text-white text-xs font-bold rounded-full px-1.5 py-0.5 ml-1"
                >0</span
              >
            </button>
          </div>
        </div>

        <!-- 접속자 팝오버(관리자) -->
        <div
          id="presence-pop"
          class="hidden right-0 left-0 mx-auto md:left-auto md:right-10 md:mx-0 w-full max-w-xs bg-white border rounded-xl shadow-xl p-3 z-30"
        >
          <div class="text-sm font-semibold text-gray-700 mb-2">
            현재 접속자
          </div>
          <div id="presence-list" class="max-h-64 overflow-auto text-sm"></div>
        </div>

        <!-- 알림 팝오버 -->
        <div
          id="notification-pop"
          class="hidden right-0 left-0 mx-auto md:left-auto md:right-10 md:mx-0 w-full max-w-sm bg-white border rounded-xl shadow-xl p-3 z-30 mt-2"
        >
          <div class="flex items-center justify-end mb-2">
            <button
              class="text-xs text-blue-600 hover:text-blue-800"
              onclick="openInquiryModal()"
            >
              <i class="fas fa-paper-plane mr-1"></i>문의 보내기
            </button>
          </div>
          <div id="notification-list" class="max-h-80 overflow-auto text-sm">
            <div class="text-center text-gray-500 py-4">알림이 없습니다</div>
          </div>
        </div>
      </header>

      <main id="app" class="space-y-6 md:space-y-8">
        <div id="app-wrapper">
          <!-- ===== 로그인 전 ===== -->
          <div id="pre-login-info" class="space-y-6 md:space-y-8">
            <!-- 로그인 -->
            <div id="login-section" class="section max-w-lg mx-auto">
              <div class="mb-4">
                <h2 class="text-2xl font-bold text-gray-700 text-center">
                  Foodie 회원 인증
                </h2>
              </div>
              <div class="space-y-3 md:space-y-4">
                <input
                  id="studentId"
                  type="text"
                  placeholder="학번"
                  class="w-full input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
                />
                <input
                  id="studentName"
                  type="text"
                  placeholder="이름"
                  class="w-full input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
                />

                <!-- 자동 로그인 체크박스 -->
                <div class="flex items-center justify-center">
                  <label
                    class="inline-flex items-center cursor-pointer select-none"
                  >
                    <div class="relative">
                      <input
                        id="auto-login-checkbox"
                        type="checkbox"
                        class="sr-only"
                      />
                      <div
                        class="w-5 h-5 bg-white border-2 border-gray-300 rounded-sm flex items-center justify-center transition-all duration-200 hover:border-orange-400"
                      >
                        <svg
                          class="w-3 h-3 text-orange-600 opacity-0 transition-opacity duration-200"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clip-rule="evenodd"
                          ></path>
                        </svg>
                      </div>
                    </div>
                    <span class="ml-3 text-sm text-gray-700 font-medium">
                      자동 로그인
                    </span>
                  </label>
                </div>

                <button
                  id="login-button"
                  type="button"
                  class="w-full bg-orange-500 text-white btn-lg hover:bg-orange-600 transition-colors"
                >
                  <i class="fas fa-right-to-bracket mr-2"></i>로그인
                </button>
                <button
                  id="signup-button"
                  type="button"
                  class="w-full bg-white text-orange-700 border border-orange-300 btn-lg hover:bg-orange-50 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i class="fas fa-user-plus mr-2"></i>회원가입
                </button>
                <div
                  id="signup-banner"
                  class="hidden text-center text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg p-2 mt-2"
                >
                  지금은 <b>회원가입 기간</b>입니다. 미회원은
                  <b>회원가입</b> 버튼으로 가입하세요.
                </div>
              </div>
            </div>

            <!-- 로드맵 (로그인 상태에서만 표시) -->
            <div class="section hidden" id="roadmap-section">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-700">
                  <i class="fas fa-map-signs mr-2 text-orange-500"></i>Foodie
                  활동 로드맵
                </h3>
                <div id="roadmap-admin-controls" class="hidden">
                  <button
                    id="add-roadmap-event"
                    class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"
                    title="새로운 일정을 추가합니다"
                  >
                    <i class="fas fa-plus mr-1"></i>일정 추가
                  </button>
                </div>
              </div>
              <div id="roadmap-container" class="space-y-3"></div>
              <div class="text-center mt-3">
                <button
                  id="roadmap-toggle-btn"
                  type="button"
                  class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-medium py-1.5 px-3 rounded-md transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5 text-sm hidden"
                >
                  <i class="fas fa-calendar-alt text-xs"></i>
                  <span id="roadmap-toggle-text">달력 보기</span>
                </button>
              </div>
            </div>

            <!-- 홈 화면 블록 -->
            <div id="dynamic-blocks" class="space-y-4 md:space-y-6"></div>
          </div>

          <!-- ===== 로그인 후 메인 ===== -->
          <div id="main-content" class="hidden">
            <!-- 로그인 후 메인 화면은 renderAll()에서 동적으로 생성됩니다 -->
          </div>
        </div>
      </main>
    </div>

    <div id="logout-container" class="text-center py-2"></div>

    <footer class="text-center py-4 text-gray-500 text-sm footer-selectable">
      <p>개발자🧑🏻‍💻: Foodie 2025 회장 이대현</p>
      <p>연락처📨: leedaehyun11@naver.com</p>
    </footer>

    <!-- Alert Modal -->

    <!-- Inquiry/Suggestions Modal -->
    <div
      id="inquiry-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div
        class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold text-orange-600">
            <i class="fas fa-question-circle mr-2"></i>문의하기
          </h3>
          <button
            id="inquiry-close"
            class="text-gray-400 hover:text-gray-600 transition-colors"
            title="닫기"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- 문의 작성 폼 -->
        <div class="mb-6 bg-orange-50 p-4 rounded-lg border border-orange-200">
          <div class="mb-3">
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >제목 (선택)</label
            >
            <input
              id="modal-sug-title"
              type="text"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors"
              placeholder="제목을 입력해주세요 (선택사항)"
            />
          </div>
          <div class="mb-3">
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >내용 *</label
            >
            <textarea
              id="modal-sug-text"
              rows="4"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors resize-none"
              placeholder="궁금한 점이나 문의사항을 적어주세요."
            ></textarea>
          </div>
          <button
            id="modal-sug-submit"
            class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg"
          >
            <i class="fas fa-paper-plane mr-2"></i>문의 보내기
          </button>
        </div>

        <!-- 기존 문의 목록 -->
        <div class="border-t pt-4">
          <h4 class="text-lg font-bold text-gray-800 mb-3">
            <i class="fas fa-list mr-2"></i>문의 내역
          </h4>
          <div id="modal-suggestions-list" class="space-y-3">
            <!-- 문의 목록이 여기에 표시됩니다 -->
          </div>
        </div>
      </div>
    </div>

    <!-- Rank Modal -->
    <div
      id="rank-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div
        class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-2xl font-bold text-orange-700">🏅 조모임</h3>
          <div id="rank-admin-controls" class="hidden">
            <button
              id="rank-add-team"
              class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"
              title="새로운 조를 추가합니다"
            >
              <i class="fas fa-plus mr-1"></i>조모임 추가
            </button>
          </div>
        </div>
        <div id="rank-list" class="space-y-2"></div>

        <!-- 점수 변경 기록 (회장/부회장만 보임) -->
        <div id="rank-history-section" class="hidden mt-6">
          <h4 class="text-lg font-bold text-gray-800 mb-3">
            <i class="fas fa-history mr-2 text-blue-600"></i>
            점수 변경 기록
          </h4>
          <div
            id="rank-history-list"
            class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 rounded-lg p-3"
          >
            <!-- 기록이 여기에 표시됩니다 -->
          </div>
        </div>
        <div class="mt-4 flex justify-between">
          <div id="rank-admin-actions" class="hidden space-x-2">
            <button
              id="rank-save-changes"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors"
              title="조모임 순위 변경사항을 저장합니다"
            >
              <i class="fas fa-save mr-1"></i>변경사항 저장
            </button>
          </div>
          <button
            id="rank-close"
            class="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300"
          >
            닫기
          </button>
        </div>
      </div>
    </div>

    <!-- 뭐먹지 Modal -->
    <div
      id="food-recommend-modal"
      class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex justify-center items-center px-4 z-50 overflow-y-auto py-4"
    >
      <div
        class="bg-gradient-to-br from-orange-50 via-white to-red-50 p-1 rounded-3xl shadow-2xl max-w-lg w-full animate-fadeIn my-auto max-h-[95vh] overflow-y-auto"
      >
        <div class="bg-white/95 backdrop-blur-md p-4 md:p-6 rounded-3xl">
          <!-- 헤더 -->
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-2xl md:text-3xl font-black">
              <span
                class="bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent"
              >
                🍽️ 뭐먹지?
              </span>
            </h3>
            <button
              id="menu-manage-btn"
              class="hidden px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors text-sm font-medium"
            >
              <i class="fas fa-cog mr-1"></i>메뉴 관리
            </button>
          </div>

          <!-- 카테고리 필터 -->
          <div class="flex flex-wrap gap-2 mb-4">
            <button
              class="category-filter-btn active px-3 py-1.5 rounded-full bg-orange-500 text-white text-sm font-medium whitespace-nowrap"
              data-category="all"
            >
              전체
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="korean"
            >
              한식
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="japanese"
            >
              일식
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="chinese"
            >
              중식
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="western"
            >
              양식
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="asian"
            >
              아시안
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="snack"
            >
              분식
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="dessert"
            >
              디저트
            </button>
          </div>

          <!-- 룰렛 영역 -->
          <div
            class="relative bg-gradient-to-br from-orange-100 via-yellow-50 to-red-100 rounded-3xl p-8 md:p-12 mb-4 border-4 border-orange-300 shadow-inner overflow-hidden"
          >
            <!-- 장식 요소 -->
            <div
              class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none"
            >
              <div class="absolute top-2 left-2 text-4xl">🍕</div>
              <div class="absolute top-2 right-2 text-4xl">🍜</div>
              <div class="absolute bottom-2 left-2 text-4xl">🍔</div>
              <div class="absolute bottom-2 right-2 text-4xl">🍣</div>
            </div>

            <!-- 룰렛 디스플레이 -->
            <div class="relative z-10 text-center">
              <div
                id="roulette-display"
                class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-xl min-h-[200px] flex flex-col items-center justify-center"
              >
                <div
                  id="roulette-emoji"
                  class="text-6xl md:text-7xl mb-4 transition-all"
                >
                  🍽️
                </div>
                <div
                  id="roulette-text"
                  class="text-xl md:text-2xl font-black text-gray-800"
                >
                  메뉴를 추가하고 버튼을 눌러주세요!
                </div>
                <div id="roulette-category" class="text-sm text-gray-500 mt-2">
                  <!-- 카테고리 표시 -->
                </div>
              </div>
            </div>
          </div>

          <!-- 빠른 메뉴 추가 (회장단만) -->
          <div id="quick-add-section" class="hidden flex gap-2 mb-4">
            <input
              id="quick-menu-input"
              type="text"
              placeholder="빠르게 메뉴 추가 (Enter) - 회장단 전용"
              class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all"
            />
            <button
              id="quick-add-btn"
              class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors font-medium"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>

          <!-- 액션 버튼들 -->
          <div class="flex gap-2 md:gap-3 mb-4">
            <button
              id="spin-roulette-btn"
              class="flex-1 relative overflow-hidden group bg-gradient-to-r from-orange-500 via-orange-600 to-red-600 hover:from-orange-600 hover:via-red-600 hover:to-red-700 text-white font-black py-4 px-6 rounded-2xl transition-all shadow-xl hover:shadow-2xl hover:scale-105"
            >
              <div
                class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"
              ></div>
              <span class="relative flex items-center justify-center gap-2">
                <i class="fas fa-dice text-2xl"></i>
                <span class="text-lg">메뉴 뽑기</span>
              </span>
            </button>
            <button
              id="food-recommend-close"
              class="px-6 py-4 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 hover:from-gray-200 hover:to-gray-300 rounded-2xl transition-all shadow-md hover:shadow-lg font-bold"
            >
              <i class="fas fa-times text-lg"></i>
            </button>
          </div>

          <!-- 최근 추천 메뉴 히스토리 -->
          <div
            id="menu-history-section"
            class="hidden bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 rounded-xl p-4"
          >
            <h4
              class="text-sm font-bold text-orange-800 mb-3 flex items-center gap-2"
            >
              <i class="fas fa-history text-orange-600"></i>
              최근 추천 메뉴
            </h4>
            <div id="roulette-history" class="flex flex-wrap gap-2">
              <!-- 히스토리가 여기 표시됩니다 -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 메뉴 관리 Modal -->
    <div
      id="menu-manage-modal"
      class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex justify-center items-center px-4 z-50 overflow-y-auto py-4"
    >
      <div
        class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full my-auto max-h-[95vh] overflow-y-auto"
      >
        <div class="p-6">
          <!-- 헤더 -->
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-black text-gray-800">
              <i class="fas fa-list-ul text-orange-500 mr-2"></i>메뉴 관리
            </h3>
            <button
              id="menu-manage-close"
              class="text-gray-400 hover:text-gray-600 transition-colors"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>

          <!-- 메뉴 추가 섹션 -->
          <div
            class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 rounded-xl p-4 mb-6"
          >
            <h4 class="font-bold text-gray-800 mb-3">
              <i class="fas fa-plus-circle text-orange-500 mr-2"></i>메뉴
              추가하기
            </h4>

            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                카테고리 선택
              </label>
              <select
                id="menu-category-select"
                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200"
              >
                <option value="korean">한식</option>
                <option value="japanese">일식</option>
                <option value="chinese">중식</option>
                <option value="western">양식</option>
                <option value="asian">아시안</option>
                <option value="snack">분식</option>
                <option value="dessert">디저트</option>
                <option value="cafe">카페</option>
                <option value="etc">기타</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                메뉴 입력 (한 줄에 하나씩)
              </label>
              <textarea
                id="bulk-menu-input"
                rows="6"
                placeholder="메뉴를 한 줄에 하나씩 입력해 주세요. (Enter 키로 줄 바꿈)

예:
김치찌개
초밥
파스타
떡볶이"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200 resize-none"
              ></textarea>
            </div>

            <button
              id="bulk-add-menu-btn"
              class="w-full px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-xl"
            >
              <i class="fas fa-plus mr-2"></i>메뉴 추가하기
            </button>
          </div>

          <!-- 메뉴 목록 -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-bold text-gray-800">
                등록된 메뉴
                <span id="menu-count-badge" class="text-sm text-gray-500"
                  >(0개)</span
                >
              </h4>
              <button
                id="delete-all-menus-btn"
                class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors"
              >
                <i class="fas fa-trash mr-1"></i>전체 삭제
              </button>
            </div>

            <!-- 카테고리별 메뉴 목록 -->
            <div
              id="menu-list-container"
              class="space-y-4 max-h-[400px] overflow-y-auto"
            >
              <!-- 동적으로 생성됩니다 -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="alert-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center max-w-sm w-full"
      >
        <div id="modal-icon" class="text-4xl md:text-5xl mb-3 md:mb-4"></div>
        <p
          id="alert-message"
          class="text-base md:text-lg font-medium text-gray-700"
        ></p>
        <button
          id="modal-close-button"
          type="button"
          class="mt-5 md:mt-6 bg-gray-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700"
        >
          확인
        </button>
      </div>
    </div>

    <!-- Emergency Modal -->
    <div
      id="emergency-modal"
      class="hidden fixed inset-0 bg-black/70 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-sm w-full">
        <h3 class="text-2xl font-bold text-red-600 mb-4 text-center">
          <i class="fas fa-exclamation-triangle mr-2"></i>비상 복구 모드
        </h3>
        <p class="text-center text-gray-600 mb-4 md:mb-6">
          새로운 관리자를 임명하여 시스템 접근 권한을 복구합니다.
        </p>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
          <p class="text-sm text-yellow-800">
            <i class="fas fa-info-circle mr-1"></i>
            <strong>직접 로그인:</strong> 학번에
            <code>foodie_emergency_2024!</code> 입력 후 이름을 입력하면 즉시
            관리자 권한으로 로그인됩니다.
          </p>
        </div>
        <input
          type="text"
          id="new-admin-id"
          placeholder="새 관리자의 학번을 입력"
          class="w-full input-lg border border-gray-300"
        />
        <div class="flex space-x-2 mt-4">
          <button
            id="emergency-add-button"
            type="button"
            class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600"
          >
            관리자 임명
          </button>
          <button
            id="emergency-cancel-button"
            type="button"
            class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400"
          >
            취소
          </button>
        </div>
      </div>
    </div>

    <!-- Signup Modal -->
    <div
      id="signup-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-lg w-full">
        <h3 class="text-2xl font-bold text-orange-700 text-center mb-3 md:mb-4">
          <i class="fas fa-user-plus mr-2"></i>Foodie 회원가입
        </h3>
        <p class="text-sm text-gray-600 text-center">
          회원가입은 운영진이 설정한 기간에만 가능합니다.
        </p>

        <div
          id="dues-box"
          class="hidden mt-4 bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-800"
        >
          <div class="font-bold mb-1">💸 회비/계좌 안내</div>
          <div id="dues-box-content" class="text-sm"></div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input
            id="signupName"
            type="text"
            placeholder="이름"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <select
            id="signupGender"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          >
            <option value="">성별</option>
            <option value="남">남</option>
            <option value="여">여</option>
            <option value="기타">기타</option>
          </select>
          <select
            id="signupYear"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          >
            <option value="">학년</option>
            <option value="1학년">1학년</option>
            <option value="2학년">2학년</option>
            <option value="3학년">3학년</option>
            <option value="4학년">4학년</option>
            <option value="기타">기타</option>
          </select>
          <input
            id="signupCollege"
            type="text"
            placeholder="단과대"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupDept"
            type="text"
            placeholder="학과"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupId"
            type="text"
            placeholder="학번"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupPhone"
            type="text"
            placeholder="000-0000-0000"
            maxlength="13"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 sm:col-span-2"
          />
        </div>
        <div class="flex gap-2 mt-5">
          <button
            id="signup-confirm-button"
            type="button"
            class="flex-1 bg-orange-500 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-orange-600"
          >
            가입 신청
          </button>
          <button
            id="signup-cancel-button"
            type="button"
            class="flex-1 bg-gray-300 text-gray-800 font-bold py-2.5 px-4 rounded-lg hover:bg-gray-400"
          >
            취소
          </button>
        </div>
      </div>
    </div>

    <!-- 회비 확인 모달 -->
    <div
      id="dues-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full">
        <h3 class="text-xl font-bold text-amber-700 text-center mb-3">
          잠깐! 회비는 납부하셨나요?
        </h3>
        <div id="dues-modal-body" class="text-sm text-gray-700 space-y-1"></div>
        <div class="flex gap-2 mt-5">
          <button
            id="dues-copy-button"
            type="button"
            class="flex-1 bg-gray-200 text-gray-800 font-semibold py-2 rounded hover:bg-gray-300"
          >
            계좌 복사
          </button>
          <button
            id="dues-proceed-button"
            type="button"
            class="flex-1 bg-orange-500 text-white font-bold py-2 rounded hover:bg-orange-600"
          >
            납부 완료, 가입
          </button>
        </div>
        <button
          id="dues-cancel-button"
          type="button"
          class="mt-3 w-full bg-gray-100 text-gray-600 py-2 rounded hover:bg-gray-200"
        >
          취소
        </button>
      </div>
    </div>

    <!-- 공용(문단) 에디터 모달 -->
    <div
      id="block-editor"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-5">
        <h3
          class="text-xl font-bold text-gray-800 mb-3"
          id="block-editor-title"
        >
          블록 편집
        </h3>
        <div id="block-editor-body" class="space-y-3"></div>
        <div class="flex gap-2 justify-end mt-4">
          <button
            id="block-editor-cancel"
            class="px-4 py-2 rounded bg-gray-200"
          >
            취소
          </button>
          <button
            id="block-editor-save"
            class="px-4 py-2 rounded bg-orange-500 text-white"
          >
            저장
          </button>
        </div>
      </div>
    </div>

    <!-- App Script -->
    <script type="module">
      /* ==== 공용: 데스크톱 DnD + 모바일 화살표 순서 변경 ==== */
      // 전역 유틸 네임스페이스(여러 번 실행돼도 안전)
      window.FoodieUtils = window.FoodieUtils || {};
      FoodieUtils.enableSimpleDnd =
        FoodieUtils.enableSimpleDnd ||
        function (ul) {
          if (!ul) return;

          // 모바일 화살표 제거 (순서변경 버튼 제거)
          ul.addEventListener("click", (e) => {
            const li = e.target.closest("li");
            if (!li) return;
            if (e.target.closest(".move-up")) {
              li.previousElementSibling &&
                ul.insertBefore(li, li.previousElementSibling);
            }
            if (e.target.closest(".move-down")) {
              li.nextElementSibling &&
                ul.insertBefore(li.nextElementSibling, li);
            }
          });

          // 2) 데스크톱 DnD
          let dragEl = null;
          ul.addEventListener("dragstart", (e) => {
            dragEl = e.target.closest("li[draggable='true']");
            if (dragEl) dragEl.classList.add("dragging");
          });
          ul.addEventListener(
            "dragend",
            () => dragEl && dragEl.classList.remove("dragging")
          );
          ul.addEventListener("dragover", (e) => {
            e.preventDefault();
            const after = [
              ...ul.querySelectorAll("li[draggable='true']:not(.dragging)"),
            ].find((el) => {
              const box = el.getBoundingClientRect();
              return e.clientY <= box.top + box.height / 2;
            });
            if (dragEl) ul.insertBefore(dragEl, after || null);
          });
        };
      /* ==== 로고 경로 & 다크모드 ==== */
      const LOGO_SRC = "./assets/foodie-logo.png"; // <- 실제 경로로 바꾸세요
      function applyLogo() {
        const img = document.getElementById("site-logo");
        if (img && LOGO_SRC) img.src = LOGO_SRC;
      }
      // 다크모드 관련 코드 제거됨
      applyLogo();

      /* ==== 홈 레이아웃 순서(load & apply) ==== */
      let homeLayout = []; // ["login","roadmap","dynamic"]

      function applyHomeLayoutOrder() {
        const host = document.getElementById("pre-login-info");
        if (!host) return;
        const map = {
          login: document.getElementById("login-section"),
          roadmap: document.getElementById("roadmap-section"),
          dynamic: document.getElementById("dynamic-blocks"),
        };

        // 로그아웃 상태에서는 roadmap 섹션을 제외
        const defaultOrder = currentUser
          ? ["login", "roadmap", "dynamic"]
          : ["login", "dynamic"]; // 로그아웃 상태에서는 roadmap 제외

        const order =
          Array.isArray(homeLayout) && homeLayout.length
            ? homeLayout
            : defaultOrder;

        order.forEach((key) => {
          const elx = map[key];
          if (elx) {
            // 로그아웃 상태에서는 roadmap 섹션을 숨김
            if (key === "roadmap") {
              if (!currentUser) {
                elx.style.display = "none";
                elx.classList.add("hidden");
              } else {
                elx.style.display = "";
                elx.classList.remove("hidden");
              }
            } else {
              elx.style.display = "";
            }
            host.appendChild(elx);
          }
        });
      }
      /* ===== Firebase ===== */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        runTransaction,
        collection,
        query,
        orderBy,
        addDoc,
        serverTimestamp,
        writeBatch,
        getDocs,
        where,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import {
        getStorage,
        ref as sRef,
        uploadBytesResumable,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDdrnlSQZa-GD006G9fvgYDL0V_ib3_pcE",
        authDomain: "foodie-club-694ba.firebaseapp.com",
        projectId: "foodie-club-694ba",
        storageBucket: "foodie-club-694ba.appspot.com",
        messagingSenderId: "563737208880",
        appId: "1:563737208880:web:d82b4ea6dd06754eb7e5f5",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const storage = getStorage(app);

      const IS_FILE = location.protocol === "file:";
      const USE_DEMO_OFFLINE = false; // 항상 Firebase 사용하도록 변경

      /* ===== 상태 ===== */
      let currentUser = null;
      let adminList = [];
      let adminPositions = {};
      let customDefaultPositions = [];
      let deletedDefaultPositions = [];
      // 회장단과 일반 임원 직책 분류
      let presidentPositions = []; // 회장단 직책 (회장, 부회장 외 추가 가능)
      let regularPositions = []; // 일반 임원 직책 (운영진 외 추가 가능)
      const MASTER_CODE = "foodie_emergency_2024!";

      // 관리자 대시보드 현재 탭 상태 저장
      let currentDashboardTab = "members"; // 기본값: 회원 탭
      let currentMainTab = "roadmap"; // 메인 탭 상태 저장 (기본값: 미식회)

      // settings
      let signupSettings = { open: false };
      let duesSettings = {
        enabled: false,
        bank: "",
        number: "",
        holder: "",
        amount: "",
        note: "",
      };

      // data
      let roadmapData = [],
        suggestionsData = [];
      let historyData = [],
        eventsData = [];
      let membersData = [];
      let blocksData = [];
      let presenceData = [];
      let onlineUsers = [];
      let inquiriesData = [];
      let notificationsData = [];
      let memberSearchTerm = "";
      let editingEventId = null;
      let restaurantCategories = [
        { name: "한식", emoji: "🍚" },
        { name: "일식", emoji: "🍣" },
        { name: "중식", emoji: "🥟" },
        { name: "양식", emoji: "🍝" },
        { name: "디저트", emoji: "🍰" },
        { name: "기타", emoji: "🍽️" },
      ]; // 미식회 카테고리 목록
      let roadmapShowAll = false;
      let presenceTimer = null;

      // 홈블록 폼 편집 상태
      let editingBlockId_notice = null;
      let editingBlockId_qa = null;
      let editingBlockId_scores = null;

      /* ===== 권한 관리 함수 ===== */
      function isAdmin() {
        return currentUser && adminList.includes(currentUser.studentId);
      }

      function isStaff() {
        if (!currentUser) return false;
        const position = adminPositions[currentUser.studentId];
        return position === "운영진";
      }

      function isFullAdmin() {
        if (!currentUser) return false;
        const position = adminPositions[currentUser.studentId];
        return (
          position &&
          ["회장", "부회장", "총무", "기획부장", "홍보부장", "개발자"].includes(
            position
          )
        );
      }

      function isAdminOrStaff() {
        return isAdmin() || isStaff();
      }

      /* ===== DOM refs & helpers ===== */
      const el = {
        loading: document.getElementById("loading-screen"),
        pre: document.getElementById("pre-login-info"),
        main: document.getElementById("main-content"),
        id: document.getElementById("studentId"),
        name: document.getElementById("studentName"),
        alert: document.getElementById("alert-modal"),
        alertIcon: document.getElementById("modal-icon"),
        alertMsg: document.getElementById("alert-message"),
        emerg: document.getElementById("emergency-modal"),
        signupBanner: document.getElementById("signup-banner"),
        signupBtn: document.getElementById("signup-button"),
        signupModal: document.getElementById("signup-modal"),
        duesBox: document.getElementById("dues-box"),
        duesBoxContent: document.getElementById("dues-box-content"),
        duesModal: document.getElementById("dues-modal"),
        duesModalBody: document.getElementById("dues-modal-body"),
        presenceBadge: document.getElementById("presence-badge"),
        presenceCount: document.getElementById("presence-count"),
        presencePop: document.getElementById("presence-pop"),
        presenceList: document.getElementById("presence-list"),
        notificationBadge: document.getElementById("notification-badge"),
        notificationPop: document.getElementById("notification-pop"),
        notificationList: document.getElementById("notification-list"),
        blockEditor: document.getElementById("block-editor"),
        blockEditorTitle: document.getElementById("block-editor-title"),
        blockEditorBody: document.getElementById("block-editor-body"),
        blockEditorSave: document.getElementById("block-editor-save"),
        blockEditorCancel: document.getElementById("block-editor-cancel"),
      };
      const showAlert = (icon, msg) => {
        if (el.alertIcon) el.alertIcon.innerHTML = icon || "ℹ️";
        if (el.alertMsg) el.alertMsg.innerHTML = msg || "";
        if (el.alert) el.alert.classList.remove("hidden");
      };
      const closeModal = () => {
        if (el.alert) el.alert.classList.add("hidden");
      };
      const closeEmergencyModal = () => el.emerg.classList.add("hidden");

      // 클립보드 복사 함수
      const copyToClipboard = async (text) => {
        try {
          await navigator.clipboard.writeText(text);
          showAlert("✅", "계좌번호가 복사되었습니다!");
        } catch (err) {
          // 클립보드 API가 지원되지 않는 경우 대체 방법
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand("copy");
          document.body.removeChild(textArea);
          showAlert("✅", "계좌번호가 복사되었습니다!");
        }
      };

      // 전역 함수로 등록
      window.copyToClipboard = copyToClipboard;

      // 금액 포맷팅 함수는 아래에 정의됨

      // ===================== 문의하기 모달 =====================
      function openInquiryModal() {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]";
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-800">💬 문의하기</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            
            <div class="space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-blue-800 flex items-center gap-2">
                  <i class="fas fa-info-circle"></i>
                  회원가입, 로그인, 이벤트 관련 문의사항을 남겨주세요. 회장단이 확인 후 연락드립니다.
                </p>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-user text-blue-500 mr-2"></i>
                  이름 <span class="text-red-500">*</span>
                </label>
                <input 
                  id="inquiry-name" 
                  type="text" 
                  placeholder="예: 홍길동" 
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base" 
                  required
                >
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-phone text-blue-500 mr-2"></i>
                  연락처 <span class="text-red-500">*</span>
                </label>
                <input 
                  id="inquiry-contact" 
                  type="tel" 
                  placeholder="예: 010-1234-5678" 
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base" 
                  required
                >
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-comment-dots text-blue-500 mr-2"></i>
                  문의 내용 <span class="text-red-500">*</span>
                </label>
                <textarea 
                  id="inquiry-content" 
                  rows="6" 
                  placeholder="문의하실 내용을 자세히 적어주세요" 
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base resize-none" 
                  required
                ></textarea>
              </div>
            </div>

            <div class="flex gap-3 justify-end mt-6">
              <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                취소
              </button>
              <button onclick="submitInquiry()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                <i class="fas fa-paper-plane mr-2"></i>
                문의 보내기
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // 모달 배경 클릭 시 닫기
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // 전역 함수로 등록
      window.openInquiryModal = openInquiryModal;

      // 문의 제출 함수
      window.submitInquiry = async () => {
        const name = document.getElementById("inquiry-name").value.trim();
        const contact = document.getElementById("inquiry-contact").value.trim();
        const content = document.getElementById("inquiry-content").value.trim();

        // 유효성 검사
        if (!name || !contact || !content) {
          showAlert("😥", "모든 필수 항목을 입력해주세요.");
          return;
        }

        // 연락처 형식 검사
        const phoneRegex = /^[0-9-]+$/;
        if (!phoneRegex.test(contact)) {
          showAlert("😥", "올바른 연락처 형식을 입력해주세요.");
          return;
        }

        try {
          const inquiryData = {
            name,
            contact,
            content,
            status: "pending", // pending, answered
            createdAt: serverTimestamp(),
            answeredAt: null,
            answer: null,
          };

          await addDoc(collection(db, "inquiries"), inquiryData);
          showAlert(
            "✅",
            "문의가 성공적으로 전송되었습니다! 회장단이 확인 후 연락드리겠습니다."
          );

          // 모달 닫기
          document.querySelector(".fixed.inset-0").remove();
        } catch (error) {
          console.error("문의 전송 오류:", error);
          showAlert("😥", "문의 전송에 실패했습니다. 다시 시도해주세요.");
        }
      };

      // ===================== 회원 수동 추가 모달 =====================
      function openAddMemberModal() {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]";
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-800">👤 회원 수동 추가</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            
            <div class="space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-blue-800 flex items-center gap-2">
                  <i class="fas fa-info-circle"></i>
                  회장단이 직접 회원을 추가할 수 있습니다. 모든 필수 정보를 입력해주세요.
                </p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-id-card text-purple-500 mr-2"></i>
                    학번 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="add-member-student-id" 
                    type="text" 
                    placeholder="예: 2023123456" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-user text-purple-500 mr-2"></i>
                    이름 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="add-member-name" 
                    type="text" 
                    placeholder="예: 홍길동" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-venus-mars text-purple-500 mr-2"></i>
                    성별 <span class="text-red-500">*</span>
                  </label>
                  <select 
                    id="add-member-gender" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base bg-white" 
                    required
                  >
                    <option value="">성별 선택</option>
                    <option value="남">남</option>
                    <option value="여">여</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-graduation-cap text-purple-500 mr-2"></i>
                    학년 <span class="text-red-500">*</span>
                  </label>
                  <select 
                    id="add-member-year" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base bg-white" 
                    required
                  >
                    <option value="">학년 선택</option>
                    <option value="1학년">1학년</option>
                    <option value="2학년">2학년</option>
                    <option value="3학년">3학년</option>
                    <option value="4학년">4학년</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-university text-purple-500 mr-2"></i>
                    단과대 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="add-member-college" 
                    type="text" 
                    placeholder="예: 공과대학" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-book text-purple-500 mr-2"></i>
                    학과 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="add-member-department" 
                    type="text" 
                    placeholder="예: 컴퓨터공학과" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-phone text-purple-500 mr-2"></i>
                    전화번호 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="add-member-phone" 
                    type="tel" 
                    placeholder="예: 010-1234-5678" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-toggle-on text-purple-500 mr-2"></i>
                    초기 상태
                  </label>
                  <select 
                    id="add-member-status" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base bg-white"
                  >
                    <option value="active">활성 (즉시 승인)</option>
                    <option value="pending">대기 (승인 필요)</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1">활성으로 설정하면 즉시 승인된 상태로 추가됩니다.</p>
                </div>
              </div>
            </div>

            <div class="flex gap-3 justify-end mt-6">
              <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                취소
              </button>
              <button onclick="saveNewMember()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors">
                <i class="fas fa-save mr-2"></i>
                회원 추가
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // 모달 배경 클릭 시 닫기
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // 회원 저장 함수
      window.saveNewMember = async () => {
        const studentId = document
          .getElementById("add-member-student-id")
          .value.trim();
        const name = document.getElementById("add-member-name").value.trim();
        const gender = document.getElementById("add-member-gender").value;
        const year = document.getElementById("add-member-year").value;
        const college = document
          .getElementById("add-member-college")
          .value.trim();
        const department = document
          .getElementById("add-member-department")
          .value.trim();
        const phone = document.getElementById("add-member-phone").value.trim();
        const status = document.getElementById("add-member-status").value;

        // 유효성 검사
        if (
          !studentId ||
          !name ||
          !gender ||
          !year ||
          !college ||
          !department ||
          !phone
        ) {
          showAlert("😥", "모든 필수 항목을 입력해주세요.");
          return;
        }

        // 학번 중복 확인
        try {
          const mref = doc(db, "members", studentId);
          const ms = await getDoc(mref);
          if (ms.exists()) {
            showAlert("😥", "이미 존재하는 학번입니다.");
            return;
          }
        } catch (error) {
          console.error("학번 확인 오류:", error);
        }

        // 전화번호 형식 검사 (간단한 검사)
        const phoneRegex = /^[0-9-]+$/;
        if (!phoneRegex.test(phone)) {
          showAlert("😥", "올바른 전화번호 형식을 입력해주세요.");
          return;
        }

        try {
          const memberData = {
            studentId,
            name,
            gender,
            year,
            college,
            department,
            phone,
            status,
            requestedAt: serverTimestamp(),
            addedBy: currentUser?.studentId || "admin",
          };

          // members 컬렉션에 학번을 문서 ID로 사용
          await setDoc(doc(db, "members", studentId), memberData);
          showAlert("✅", "회원이 성공적으로 추가되었습니다!");

          // 모달 닫기
          document.querySelector(".fixed.inset-0").remove();

          // 페이지 새로고침하여 변경사항 반영
          setTimeout(() => {
            location.reload();
          }, 1000);
        } catch (error) {
          console.error("회원 추가 오류:", error);
          showAlert("😥", "회원 추가에 실패했습니다.");
        }
      };

      // 식당 정보 수정 모달 열기 함수
      window.openRestaurantEditModal = (
        eventId,
        restaurantName,
        currentInfo
      ) => {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]";
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-800">대표 메뉴 수정</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div class="mb-4">
              <div class="text-sm text-gray-600 mb-2">식당: <span class="font-semibold">${restaurantName}</span></div>
              <label class="block text-sm font-bold text-gray-700 mb-2">
                <i class="fas fa-utensils text-orange-500 mr-2"></i>
                대표 메뉴
              </label>
              <textarea id="restaurant-menu-edit" rows="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base resize-none" placeholder="이 식당의 대표 메뉴를 알려주세요">${currentInfo}</textarea>
            </div>
            <div class="flex gap-3 justify-end">
              <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                취소
              </button>
              <button onclick="saveRestaurantMenu('${eventId}', '${restaurantName.replace(
          /'/g,
          "\\'"
        )}')" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors">
                저장
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // 모달 배경 클릭 시 닫기
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      };

      // 식당 메뉴 저장 함수
      window.saveRestaurantMenu = async (eventId, restaurantName) => {
        const newMenu = document
          .getElementById("restaurant-menu-edit")
          .value.trim();
        if (!newMenu) {
          showAlert("😥", "대표 메뉴를 입력해주세요.");
          return;
        }

        try {
          const eventRef = doc(db, "events", eventId);
          const eventSnap = await getDoc(eventRef);
          if (!eventSnap.exists()) {
            showAlert("😥", "이벤트를 찾을 수 없습니다.");
            return;
          }

          const eventData = eventSnap.data();
          const restaurants = eventData.restaurants || [];
          const restaurantIndex = restaurants.findIndex(
            (r) => r.name === restaurantName
          );

          if (restaurantIndex === -1) {
            showAlert("😥", "식당을 찾을 수 없습니다.");
            return;
          }

          restaurants[restaurantIndex].info = newMenu;

          await updateDoc(eventRef, { restaurants });
          showAlert("✅", "대표 메뉴가 수정되었습니다.");

          // 모달 닫기
          document.querySelector(".fixed.inset-0").remove();

          // 페이지 새로고침하여 변경사항 반영
          setTimeout(() => {
            location.reload();
          }, 1000);
        } catch (error) {
          console.error("메뉴 수정 오류:", error);
          showAlert("😥", "메뉴 수정에 실패했습니다.");
        }
      };
      const mask = (sid) => (sid ? `${String(sid).slice(0, 4)}****` : "");
      const isWithin = (d, s, e) => {
        const x = new Date(d);
        x.setHours(0, 0, 0, 0);
        const S = s ? new Date(s) : null,
          E = e ? new Date(e) : null;
        if (S) S.setHours(0, 0, 0, 0);
        if (E) E.setHours(23, 59, 59, 999);
        return (!S || x >= S) && (!E || x <= E);
      };
      const isSignupOpen = () => {
        return signupSettings.open === true;
      };
      const isUserIn = (arr = []) =>
        arr?.some((p) => p.studentId === currentUser?.studentId);
      const formatKRW = (n) => {
        const v = Number(n || 0);
        return isNaN(v) ? "" : v.toLocaleString("ko-KR") + "원";
      };
      const timeAgo = (ms) => {
        const diff = (Date.now() - ms) / 1000;
        if (diff < 60) return `${Math.max(0, Math.floor(diff))}초 전`;
        const m = diff / 60;
        if (m < 60) return `${Math.floor(m)}분 전`;
        return `${Math.floor(m / 60)}시간 전`;
      };
      const typeLabel = (t) =>
        ({
          tasting: "미식회",
          general: "일반",
          mt: "MT",
          assembly: "총회",
        }[t] || t);
      const typeBadgeClass = (t) =>
        t === "tasting"
          ? "bg-orange-100 text-orange-700"
          : t === "mt"
          ? "bg-orange-100 text-orange-700"
          : t === "assembly"
          ? "bg-pink-100 text-pink-700"
          : "bg-emerald-100 text-emerald-700"; /* general */
      const typeAccentClass = (t) =>
        t === "tasting"
          ? "accent-tasting"
          : t === "mt"
          ? "accent-mt"
          : t === "assembly"
          ? "accent-assembly"
          : "accent-general"; /* general */
      const statusLabel = (s) =>
        ({
          open: "공개",
          archived: "숨김",
          closed: "마감됨",
          completed: "종료됨",
        }[s] || s);
      const saf = (x) =>
        window.DOMPurify
          ? DOMPurify.sanitize(String(x ?? ""))
          : String(x ?? "");

      const getPositionSuffix = () => {
        if (!currentUser) return "";

        // 관리자인 경우
        if (adminList.includes(currentUser.studentId)) {
          const position = adminPositions[currentUser.studentId];
          return position ? ` ${position}` : "";
        }

        // 관리자가 아닌 경우 회원으로 표시
        return " 회원";
      };
      let __renderQueued = false;
      let __isInitialLoading = true;
      let __loadingDataCount = 0;
      const __expectedDataSources = 8; // blocks, roadmap, events, members, suggestions, history, positions, foodMenus

      const scheduleRender = () => {
        if (__renderQueued) return;
        __renderQueued = true;
        requestAnimationFrame(() => {
          __renderQueued = false;

          // 현재 관리자 대시보드가 열려있는 경우, 해당 탭만 업데이트
          if (
            currentMainTab === "dashboard" &&
            currentUser &&
            adminList.includes(currentUser.studentId)
          ) {
            const subtabContainer = document.getElementById("subtab-container");
            if (subtabContainer && currentDashboardTab) {
              // 현재 열려있는 대시보드 서브탭만 다시 렌더링
              if (currentDashboardTab === "members") {
                renderMembersAdmin(subtabContainer);
              } else if (currentDashboardTab === "groups") {
                renderGroupsAdmin(subtabContainer);
              } else {
                // 다른 탭들은 전체 렌더링 필요
                renderAll();
              }
            } else {
              renderAll();
            }
          } else {
            renderAll();
          }
        });
      };

      // 데이터 로딩 재시도 카운터
      let dataLoadRetryCount = 0;
      const MAX_RETRY_COUNT = 5; // 재시도 횟수 증가
      let dataLoadTimeout = null;

      // 카카오톡 인앱 브라우저 감지
      const isKakaoTalkInAppBrowser = /KAKAOTALK/i.test(navigator.userAgent);
      console.log("카카오톡 인앱 브라우저:", isKakaoTalkInAppBrowser);

      const checkLoadingComplete = () => {
        console.log(
          `로딩 완료 체크: ${__loadingDataCount}/${__expectedDataSources}, 초기로딩: ${__isInitialLoading}`
        );

        // 순차적인 로딩 진행률 업데이트
        if (__isInitialLoading) {
          const progressPercentage = Math.min(
            (__loadingDataCount / __expectedDataSources) * 90,
            90
          );

          // 모든 단계에서 "잘 먹겠습니다!" 메시지 표시
          let loadingMessage = "잘 먹겠습니다!";

          updateLoadingProgress(1, loadingMessage);

          // 타임아웃 초기화
          if (dataLoadTimeout) {
            clearTimeout(dataLoadTimeout);
          }

          // 카카오톡 인앱 브라우저는 60초, 일반 브라우저는 40초로 충분한 시간 제공
          const loadingTimeout = isKakaoTalkInAppBrowser ? 60000 : 40000;
          console.log(`로딩 타임아웃 설정: ${loadingTimeout / 1000}초`);

          // 타임아웃 안에 로딩이 완료되지 않으면 재접속
          dataLoadTimeout = setTimeout(() => {
            if (__isInitialLoading) {
              console.error(
                `⚠️ 데이터 로딩 시간 초과 (${loadingTimeout / 1000}초)`
              );
              console.log(
                `로드된 데이터: ${__loadingDataCount}/${__expectedDataSources}`
              );
              // 즉시 재접속
              location.reload();
            }
          }, loadingTimeout);

          if (__loadingDataCount >= __expectedDataSources) {
            console.log("모든 데이터 소스 카운트 완료. 데이터 검증 시작...");
            updateLoadingProgress(2, "데이터 확인 중...");

            // 타임아웃 클리어
            if (dataLoadTimeout) {
              clearTimeout(dataLoadTimeout);
            }

            // 데이터 완전 로드 확인 (로딩 화면은 verifyAllDataLoaded에서만 숨김)
            // __isInitialLoading은 verifyAllDataLoaded에서 실제로 데이터가 확인될 때 false로 설정
            verifyAllDataLoaded();
          }
        }
      };

      // 모든 데이터 로드 완료 검증 함수
      const verifyAllDataLoaded = (retryCount = 0) => {
        console.log("=== 데이터 로드 완전성 검증 ===", retryCount);

        // 배열이면 데이터가 로드된 것으로 간주 (빈 배열도 OK)
        const hasRoadmap = roadmapData && Array.isArray(roadmapData);
        const hasEvents = eventsData && Array.isArray(eventsData);
        const hasBlocks = blocksData && Array.isArray(blocksData);
        const hasMembers = membersData && Array.isArray(membersData);
        const hasAdmins = adminList && Array.isArray(adminList);
        const hasFoodMenus = foodMenusData && Array.isArray(foodMenusData);

        console.log("필수 데이터 확인:");
        console.log("- roadmapData:", hasRoadmap, roadmapData?.length || 0);
        console.log("- eventsData:", hasEvents, eventsData?.length || 0);
        console.log("- blocksData:", hasBlocks, blocksData?.length || 0);
        console.log("- membersData:", hasMembers, membersData?.length || 0);
        console.log("- adminList:", hasAdmins, adminList?.length || 0);
        console.log(
          "- foodMenusData:",
          hasFoodMenus,
          foodMenusData?.length || 0
        );

        // 모든 리스너가 최소 한 번 실행되었는지 확인
        const allDataLoaded =
          hasRoadmap &&
          hasEvents &&
          hasBlocks &&
          hasMembers &&
          hasAdmins &&
          hasFoodMenus;

        if (allDataLoaded) {
          // 모든 데이터가 실제로 로드된 경우에만 로딩 완료 처리
          __isInitialLoading = false;
          console.log("✅ 모든 컨텐츠가 정상적으로 로드되었습니다.");
          console.log("📊 최종 데이터 요약:");
          console.log(`  - 로드맵: ${roadmapData.length}개`);
          console.log(`  - 이벤트: ${eventsData.length}개`);
          console.log(`  - 블록: ${blocksData.length}개`);
          console.log(`  - 회원: ${membersData.length}명`);
          console.log(`  - 관리자: ${adminList.length}명`);
          console.log(`  - 뭐먹지 메뉴: ${foodMenusData.length}개`);

          // 모든 데이터가 로드되었으므로 로딩 화면 닫기
          updateLoadingProgress(100, "잘 먹겠습니다!");
          setTimeout(() => {
            hideLoadingScreen();
            console.log("🎉 데이터 로딩 완료 - 정상 표시됨");
          }, 500);
        } else {
          console.warn(`⚠️ 일부 데이터 미로드 (재확인 ${retryCount + 1}/40)`);

          // 어떤 데이터가 없는지 명시
          if (!hasRoadmap) console.warn("  ❌ 로드맵 데이터 없음");
          if (!hasEvents) console.warn("  ❌ 이벤트 데이터 없음");
          if (!hasBlocks) console.warn("  ❌ 블록 데이터 없음");
          if (!hasMembers) console.warn("  ❌ 회원 데이터 없음");
          if (!hasAdmins) console.warn("  ❌ 관리자 데이터 없음");
          if (!hasFoodMenus) console.warn("  ❌ 뭐먹지 메뉴 데이터 없음");

          // 로딩 화면 유지하면서 계속 재확인 (최대 40회 = 80초)
          if (retryCount < 40) {
            // 진행률 표시 업데이트
            const progress = Math.min(90 + (retryCount / 40) * 5, 95);
            updateLoadingProgress(
              progress,
              `데이터 확인 중... (${retryCount + 1}/40)`
            );

            setTimeout(() => {
              verifyAllDataLoaded(retryCount + 1);
            }, 2000); // 2초마다 재확인
          } else {
            console.error("❌ 최대 대기 시간 초과 (80초)");
            console.log("⚠️ 로딩 화면 유지 - 데이터 로드 실패");
            updateLoadingProgress(
              95,
              "데이터 로드 중 문제 발생. 새로고침을 시도해주세요."
            );
            // 로딩 화면을 계속 유지하여 빈 화면이 나타나지 않도록 함
            // 사용자가 수동으로 새로고침하도록 안내
          }
        }
      };

      // 컨텐츠가 제대로 로드되었는지 확인하는 함수
      const checkContentLoaded = () => {
        console.log("=== 컨텐츠 로드 상태 확인 ===");

        // 네트워크 상태 확인
        const isOnline = navigator.onLine;
        console.log("네트워크 상태:", isOnline ? "온라인" : "오프라인");

        // 우선순위 데이터 확인 (가장 중요한 데이터부터)
        const hasValidRoadmapData =
          roadmapData &&
          roadmapData.length > 0 &&
          roadmapData.some(
            (item) => item && item.id // ID만 있으면 유효한 데이터로 간주
          );
        const hasValidEventsData = eventsData && eventsData.length > 0;
        const hasValidBlocksData = blocksData && blocksData.length > 0;
        const hasValidMembersData = membersData && membersData.length > 0;
        const hasValidFoodMenusData =
          foodMenusData && Array.isArray(foodMenusData);

        console.log("우선순위 데이터 검사:");
        console.log(
          "- roadmapData (최우선):",
          hasValidRoadmapData,
          roadmapData?.length || 0
        );
        console.log(
          "- eventsData:",
          hasValidEventsData,
          eventsData?.length || 0
        );
        console.log(
          "- blocksData:",
          hasValidBlocksData,
          blocksData?.length || 0
        );
        console.log(
          "- membersData:",
          hasValidMembersData,
          membersData?.length || 0
        );
        console.log(
          "- foodMenusData:",
          hasValidFoodMenusData,
          foodMenusData?.length || 0
        );

        // DOM 요소 확인
        const mainContentEl = document.getElementById("main-content");
        const preContentEl = document.getElementById("pre-content");
        const loadingScreenEl = document.getElementById("loading-screen");

        const hasMainContent =
          mainContentEl && !mainContentEl.classList.contains("hidden");
        const hasPreContent =
          preContentEl && !preContentEl.classList.contains("hidden");
        const isLoadingScreenVisible =
          loadingScreenEl &&
          loadingScreenEl.style.display !== "none" &&
          !loadingScreenEl.classList.contains("hidden");

        console.log("hasMainContent:", hasMainContent);
        console.log("hasPreContent:", hasPreContent);
        console.log("isLoadingScreenVisible:", isLoadingScreenVisible);

        // 페이지 로드 시간 확인 (너무 빨리 체크하지 않도록)
        const pageLoadTime =
          Date.now() -
          (window.performance?.timing?.navigationStart || Date.now());
        console.log("페이지 로드 시간:", pageLoadTime + "ms");

        // 로그아웃 상태 확인
        const isLoggedOut = !currentUser;

        // 재접속 조건 완화 (너무 빠른 재접속 방지)
        const criticalDataMissing =
          !hasValidRoadmapData && !hasValidEventsData && !hasValidBlocksData;

        // UI 가시성 확인 (더 긴 시간 대기)
        const uiNotVisible = !hasMainContent && !hasPreContent;
        const stillLoading = isLoadingScreenVisible && pageLoadTime > 15000; // 15초로 증가
        const networkIssues = !isOnline && pageLoadTime > 10000; // 10초로 증가

        // 로그아웃 상태에서는 재접속 안 함
        const needsQuickReconnect =
          !isLoggedOut &&
          (stillLoading || networkIssues) &&
          criticalDataMissing;

        console.log("재접속 조건:");
        console.log("- 핵심 데이터 없음:", criticalDataMissing);
        console.log("- 로딩 지연 (15초 이상):", stillLoading);
        console.log("- 네트워크 문제 (10초 이상):", networkIssues);
        console.log("- 재접속 필요:", needsQuickReconnect);

        // 재접속은 매우 드문 경우에만 실행 (15초 이상 로딩 중이고 데이터 없을 때만)
        if (needsQuickReconnect) {
          console.warn("⚠️ 장시간 로딩 실패! 재접속을 시도합니다.");
          console.log("🔄 재접속 실행");
          location.reload();
        } else {
          console.log("✅ 재접속 불필요 - 정상 로딩 중");
        }
      };

      /* ===== 인증 & 권한 ===== */
      async function login() {
        const sid = el.id.value.trim();
        const nm = el.name.value.trim();

        // 비상복구모드: 마스터 코드 입력 시 이름 없이도 접근 가능
        if (sid === MASTER_CODE) {
          if (nm === "") {
            return el.emerg.classList.remove("hidden");
          } else {
            // 이름이 입력된 경우 비상복구모드로 로그인
            currentUser = { studentId: sid, name: nm };

            // 비상복구모드에서는 관리자 권한 부여
            adminList = [sid];
            adminPositions = { [sid]: "비상복구관리자" };
            currentUser.position = "비상복구관리자";

            localStorage.setItem(
              "foodieUser",
              JSON.stringify({
                studentId: sid,
                name: nm,
                position: currentUser.position,
              })
            );

            console.log("=== 비상복구모드 로그인 ===");
            console.log("currentUser:", currentUser);
            console.log("adminList:", adminList);

            ensureAdminOptionals();
            renderAll();
            return;
          }
        }

        if (!sid || !nm)
          return showAlert("😥", "학번과 이름을 모두 입력해주세요.");
        try {
          console.log("=== 로그인 시도 ===");
          console.log("입력 학번:", sid);
          console.log("입력 이름:", nm);

          const mref = doc(db, "members", sid);
          const ms = await getDoc(mref);

          console.log("Firebase 조회 결과:", {
            exists: ms.exists(),
            data: ms.exists() ? ms.data() : null,
          });

          if (!ms.exists())
            return showAlert(
              "⛔",
              "등록된 회원이 아닙니다. 회원가입 기간에 <b>회원가입</b> 버튼으로 가입해주세요."
            );
          const data = ms.data() || {};

          console.log("회원 데이터:", data);
          console.log("이름 비교:", {
            입력이름: nm,
            저장된이름: (data.name || "").trim(),
            일치여부: (data.name || "").trim() === nm,
          });

          if ((data.name || "").trim() !== nm)
            return showAlert(
              "🙅‍♂️",
              "입력한 이름이 회원 정보와 일치하지 않습니다. 운영진에게 수정 요청해주세요."
            );
          const status = data.status || "active";
          // 개발용: pending 상태도 허용하고 관리자 권한 부여
          if (status === "pending") {
            console.log("⚠️ 개발 모드: pending 상태 사용자도 로그인 허용");
          }
          if (status === "rejected")
            return showAlert(
              "⛔",
              "가입이 거절되었습니다. 운영진에 문의해주세요."
            );
          if (status === "blocked")
            return showAlert(
              "⛔",
              "접근이 제한된 회원입니다. 운영진에 문의해주세요."
            );

          currentUser = { studentId: sid, name: nm };

          // 자동 로그인 체크박스가 체크된 경우 정보 저장
          const autoLoginCheckbox = document.getElementById(
            "auto-login-checkbox"
          );
          if (autoLoginCheckbox && autoLoginCheckbox.checked) {
            saveAutoLogin(sid, nm);
          }
          startPresence();
          try {
            const a = await getDoc(doc(db, "admins", "list"));
            adminList = a.exists() ? a.data().studentIds || [] : [];
            adminPositions = a.exists() ? a.data().positions || {} : {};

            // 관리자인 경우 currentUser.position 설정
            if (currentUser && adminList.includes(currentUser.studentId)) {
              currentUser.position =
                adminPositions[currentUser.studentId] || "일반 회원";
              console.log("=== 사용자 직책 설정 ===");
              console.log("currentUser.studentId:", currentUser.studentId);
              console.log("adminPositions:", adminPositions);
              console.log("설정된 직책:", currentUser.position);
            }
          } catch {}

          // position 정보를 포함하여 localStorage에 저장
          localStorage.setItem(
            "foodieUser",
            JSON.stringify({
              studentId: currentUser.studentId,
              name: currentUser.name,
              position: currentUser.position,
            })
          );
          ensureAdminOptionals();

          // 로그인 성공 시 버튼 가시성 업데이트
          updateGameButtonsVisibility();

          renderAll();
        } catch (e) {
          console.warn(e);
          showAlert("😥", "로그인 중 오류가 발생했습니다.");
        }
      }
      const logout = async () => {
        try {
          stopPresence();
          localStorage.removeItem("foodieUser");
          currentUser = null;
          clearAdmin();
          clearAutoLogin(); // 자동 로그인 정보 삭제
          await signOut(auth);

          // 로그아웃 시 버튼 가시성 업데이트
          updateGameButtonsVisibility();

          // 로딩 화면 표시 및 "잘 먹었습니다" 메시지
          const loadingScreen = document.getElementById("loading-screen");
          const loadingText = document.getElementById("loading-text");
          const progressBar = document.getElementById("progress-bar");

          if (loadingScreen) {
            loadingScreen.classList.remove("hidden");
          }

          // 로딩바와 텍스트 직접 업데이트
          if (progressBar) {
            progressBar.style.width = "100%";
            progressBar.style.transition =
              "width 0.8s cubic-bezier(0.4, 0, 0.2, 1)";
          }

          if (loadingText) {
            loadingText.textContent = "잘 먹었습니다!";
            loadingText.style.opacity = "1";
            loadingText.style.transition = "opacity 0.3s ease";
          }

          // 2초 후 페이지 새로고침
          setTimeout(() => {
            location.reload();
          }, 2000);
        } catch (e) {
          console.warn(e);
          location.reload();
        }
      };
      async function verifyAutoLogin(saved) {
        try {
          const mref = doc(db, "members", saved.studentId);
          const ms = await getDoc(mref);
          if (!ms.exists()) return logout();
          const d = ms.data() || {};
          if ((d.name || "").trim() !== saved.name) return logout();
          // 개발용: pending 상태도 허용
          const status = d.status || "active";
          if (status === "rejected" || status === "blocked") return logout();
          try {
            const a = await getDoc(doc(db, "admins", "list"));
            adminList = a.exists() ? a.data().studentIds || [] : [];
            adminPositions = a.exists() ? a.data().positions || {} : {};

            // 관리자인 경우 currentUser.position 설정
            if (currentUser && adminList.includes(currentUser.studentId)) {
              currentUser.position =
                adminPositions[currentUser.studentId] || "일반 회원";
              console.log("=== 자동 로그인 사용자 직책 설정 ===");
              console.log("currentUser.studentId:", currentUser.studentId);
              console.log("adminPositions:", adminPositions);
              console.log("설정된 직책:", currentUser.position);

              // localStorage에도 업데이트된 position 저장
              localStorage.setItem(
                "foodieUser",
                JSON.stringify({
                  studentId: currentUser.studentId,
                  name: currentUser.name,
                  position: currentUser.position,
                })
              );
            }
          } catch {}
          ensureAdminOptionals();

          // 자동 로그인 성공 시 버튼 가시성 업데이트
          updateGameButtonsVisibility();
        } catch {}
      }

      /* ===== Presence ===== */
      function startPresence() {
        if (!currentUser) return;
        try {
          const ref = doc(db, "presence", currentUser.studentId);
          const ping = () =>
            setDoc(
              ref,
              {
                studentId: currentUser.studentId,
                name: currentUser.name,
                ua: navigator.userAgent,
                lastActiveMs: Date.now(),
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            );
          ping();
          if (presenceTimer) clearInterval(presenceTimer);
          presenceTimer = setInterval(ping, 25000);
          const end = () => ping();
          let hiddenTime = null;
          window.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") {
              hiddenTime = Date.now();
              end();
            } else {
              // 페이지가 다시 보이게 될 때
              if (hiddenTime && Date.now() - hiddenTime > 30000) {
                // 30초 이상 페이지를 벗어났다가 돌아온 경우 리로드
                window.location.reload();
              } else {
                ping();
              }
              hiddenTime = null;
            }
          });
          window.addEventListener("pagehide", end);
          window.addEventListener("beforeunload", end);
        } catch (e) {
          console.warn("presence start err", e);
        }
      }
      function stopPresence() {
        if (presenceTimer) {
          clearInterval(presenceTimer);
          presenceTimer = null;
        }
      }
      function computeOnline() {
        const threshold = Date.now() - 60 * 1000;
        onlineUsers = presenceData
          .filter((p) => (p.lastActiveMs || 0) >= threshold)
          .sort((a, b) => b.lastActiveMs - a.lastActiveMs);
      }
      function renderPresenceUI() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin) {
          el.presenceBadge.classList.add("hidden");
          el.presencePop.classList.add("hidden");
          return;
        }
        el.presenceBadge.classList.remove("hidden");
        el.presenceCount.textContent = onlineUsers.length;
        el.presenceList.innerHTML = onlineUsers.length
          ? onlineUsers
              .map(
                (u) =>
                  `<div class="flex items-center justify-between py-1"><div class="truncate"><b>${saf(
                    u.name || ""
                  )}</b> <span class="text-xs text-gray-500 font-mono">${mask(
                    u.studentId
                  )}</span></div><div class="text-xs text-gray-500 ml-2">${timeAgo(
                    u.lastActiveMs || 0
                  )}</div></div>`
              )
              .join("")
          : `<div class="text-gray-400">지금은 접속자가 없습니다.</div>`;
      }

      function updateGameButtonsVisibility() {
        const gameButtonsContainer = document.getElementById(
          "game-buttons-container"
        );
        const headerFoodBtn = document.getElementById("header-food-btn");

        if (!gameButtonsContainer) return;

        // currentUser가 있으면 로그인 상태, 없으면 로그아웃 상태
        if (currentUser) {
          // 로그인 상태: 버튼 표시
          gameButtonsContainer.classList.remove("hidden");
          if (headerFoodBtn) headerFoodBtn.classList.remove("hidden");
        } else {
          // 로그아웃 상태: 버튼 숨김
          gameButtonsContainer.classList.add("hidden");
          if (headerFoodBtn) headerFoodBtn.classList.add("hidden");
        }
      }
      document.addEventListener("click", (e) => {
        if (
          !e.target.closest("#presence-badge") &&
          !e.target.closest("#presence-pop")
        )
          el.presencePop.classList.add("hidden");
      });
      document
        .getElementById("presence-badge")
        .addEventListener("click", () =>
          el.presencePop.classList.toggle("hidden")
        );

      // 알림 버튼 클릭 이벤트
      const notificationBadgeEl = document.getElementById("notification-badge");
      if (notificationBadgeEl) {
        notificationBadgeEl.addEventListener("click", () => {
          el.notificationPop?.classList.toggle("hidden");
        });
      }

      /* ===== 리스너 ===== */
      const unsubPublic = {
        admins: null,
        signup: null,
        dues: null,
        blocks: null,
        customPositions: null,
        roadmap: null,
        events: null,
        notifications: null,
      };
      const unsubAdmin = {
        suggestions: null,
        history: null,
        members: null,
        presence: null,
      };
      const clearPublic = () =>
        Object.keys(unsubPublic).forEach((k) => {
          if (unsubPublic[k]) {
            unsubPublic[k]();
            unsubPublic[k] = null;
          }
        });
      const clearAdmin = () =>
        Object.keys(unsubAdmin).forEach((k) => {
          if (unsubAdmin[k]) {
            unsubAdmin[k]();
            unsubAdmin[k] = null;
          }
        });

      const DEMO = {
        roadmap: [
          {
            id: "r1",
            activityName: "Foodie 개강총회 🍻",
            activityDate: "2025-09-16",
            order: 0,
          },
          {
            id: "r2",
            activityName: "🙋🏻‍♂️Foodie 조모임 시작 !",
            activityDate: "2025-09-22",
            order: 1,
          },
          {
            id: "r3",
            activityName: "👨🏻‍🍳Foodie 미식회 (퓨전요리)",
            activityDate: "2025-09-24",
            order: 2,
          },
          {
            id: "r4",
            activityName: "🥩 Foodie 미식회 (양식)🍝",
            activityDate: "2025-10-14",
            order: 3,
          },
          {
            id: "r5",
            activityName: "✨ Foodie 미식회 (미정)✨",
            activityDate: "2025-11-05",
            order: 4,
          },
          {
            id: "r6",
            activityName: "Foodie MT 떠나요🚗",
            activityDate: "2025-11-08",
            order: 5,
          },
          {
            id: "r7",
            activityName: "✨ Foodie 미식회 (미정)✨",
            activityDate: "2025-11-12",
            order: 6,
          },
          {
            id: "r8",
            activityName: "✨ Foodie 미식회 (미정)✨",
            activityDate: "2025-11-19",
            order: 7,
          },
          {
            id: "r9",
            activityName: "🙋🏻‍♂️Foodie 조모임 종료👋",
            activityDate: "2025-11-25",
            order: 8,
          },
          {
            id: "r10",
            activityName: "😢아쉬운 종강총회😢",
            activityDate: "2025-12-05",
            order: 9,
          },
        ],
      };

      function startPublicListeners() {
        if (!unsubPublic.homelayout) {
          unsubPublic.homelayout = onSnapshot(
            doc(db, "settings", "homeLayout"),
            (snap) => {
              homeLayout = snap.exists() ? snap.data().order || [] : [];
              applyHomeLayoutOrder();
            }
          );
        }
        if (!unsubPublic.admins) {
          unsubPublic.admins = onSnapshot(doc(db, "admins", "list"), (snap) => {
            adminList = snap.exists() ? snap.data().studentIds || [] : [];
            adminPositions = snap.exists() ? snap.data().positions || {} : {};

            // 관리자인 경우 currentUser.position 업데이트
            if (currentUser && adminList.includes(currentUser.studentId)) {
              currentUser.position =
                adminPositions[currentUser.studentId] || "일반 회원";
              console.log("=== Firebase 리스너 사용자 직책 업데이트 ===");
              console.log("currentUser.studentId:", currentUser.studentId);
              console.log("adminPositions:", adminPositions);
              console.log("업데이트된 직책:", currentUser.position);

              // localStorage에도 업데이트된 position 저장
              localStorage.setItem(
                "foodieUser",
                JSON.stringify({
                  studentId: currentUser.studentId,
                  name: currentUser.name,
                  position: currentUser.position,
                })
              );
            }

            ensureAdminOptionals();
            scheduleRender();
          });
        }
        if (!unsubPublic.signup) {
          unsubPublic.signup = onSnapshot(
            doc(db, "settings", "signup"),
            (snap) => {
              signupSettings = snap.exists()
                ? snap.data()
                : { open: false, start: "", end: "" };
              updateSignupUI();
              scheduleRender();
            }
          );
        }
        if (!unsubPublic.dues) {
          unsubPublic.dues = onSnapshot(doc(db, "settings", "dues"), (snap) => {
            duesSettings = snap.exists()
              ? snap.data()
              : {
                  enabled: false,
                  bank: "",
                  number: "",
                  holder: "",
                  amount: "",
                  note: "",
                };
            updateSignupUI();
            scheduleRender();
          });
        }
        if (!unsubPublic.blocks) {
          unsubPublic.blocks = onSnapshot(
            query(collection(db, "homepageBlocks"), orderBy("order", "asc")),
            (snap) => {
              blocksData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("blocks:", err?.message)
          );
        }
        if (!unsubPublic.customPositions) {
          unsubPublic.customPositions = onSnapshot(
            doc(db, "settings", "customPositions"),
            (snap) => {
              customDefaultPositions = snap.exists()
                ? snap.data().positions || []
                : [];
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("customPositions:", err?.message)
          );
        }
        if (!unsubPublic.deletedPositions) {
          unsubPublic.deletedPositions = onSnapshot(
            doc(db, "settings", "deletedPositions"),
            (snap) => {
              deletedDefaultPositions = snap.exists()
                ? snap.data().positions || []
                : [];
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("deletedPositions:", err?.message)
          );
        }
        if (!unsubPublic.presidentPositions) {
          unsubPublic.presidentPositions = onSnapshot(
            doc(db, "settings", "presidentPositions"),
            async (snap) => {
              if (snap.exists()) {
                const existingPositions = snap.data().positions || [];
                // 기존 데이터가 있으면 그대로 사용
                presidentPositions = existingPositions;
              } else {
                // 문서가 없으면 기본값으로 생성 (회장, 부회장만)
                const defaultPositions = ["회장", "부회장"];
                await setDoc(doc(db, "settings", "presidentPositions"), {
                  positions: defaultPositions,
                });
                presidentPositions = defaultPositions;
              }

              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("presidentPositions:", err?.message)
          );
        }
        if (!unsubPublic.regularPositions) {
          unsubPublic.regularPositions = onSnapshot(
            doc(db, "settings", "regularPositions"),
            (snap) => {
              regularPositions = snap.exists()
                ? snap.data().positions || ["운영진"]
                : ["운영진"];
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("regularPositions:", err?.message)
          );
        }
        if (!unsubPublic.restaurantCategories) {
          unsubPublic.restaurantCategories = onSnapshot(
            doc(db, "settings", "restaurantCategories"),
            async (snap) => {
              if (snap.exists()) {
                restaurantCategories =
                  snap.data().categories || restaurantCategories;
              } else {
                // 문서가 없으면 기본값으로 생성
                await setDoc(doc(db, "settings", "restaurantCategories"), {
                  categories: restaurantCategories,
                });
              }
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("restaurantCategories:", err?.message)
          );
        }
        if (!unsubPublic.roadmap) {
          // 로드맵: order 필드를 관리하므로 정렬은 렌더링 시점에서 처리
          console.log(
            "로드맵 데이터 로딩 시작, USE_DEMO_OFFLINE:",
            USE_DEMO_OFFLINE
          );

          if (USE_DEMO_OFFLINE) {
            // 로컬 파일 모드에서는 데모 데이터 사용
            roadmapData = DEMO.roadmap;
            console.log("DEMO 로드맵 데이터 사용:", roadmapData);
            if (__isInitialLoading) {
              __loadingDataCount++;
              checkLoadingComplete();
            }
            scheduleRender();
          } else {
            console.log("Firebase에서 로드맵 데이터 로딩 중...");
            unsubPublic.roadmap = onSnapshot(
              collection(db, "roadmap"),
              (snap) => {
                roadmapData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
                console.log("Firebase 로드맵 데이터 업데이트:", roadmapData);
                console.log("문서 개수:", snap.docs.length);
                console.log(
                  "변경된 문서들:",
                  snap.docChanges().map((change) => ({
                    type: change.type,
                    docId: change.doc.id,
                    data: change.doc.data(),
                  }))
                );
                if (__isInitialLoading) {
                  __loadingDataCount++;
                  checkLoadingComplete();
                }
                scheduleRender();
              },
              (err) => {
                console.warn("roadmap 로딩 오류:", err?.message);
                roadmapData = DEMO.roadmap;
                console.log("오류로 인해 DEMO 데이터 사용:", roadmapData);
                if (__isInitialLoading) {
                  __loadingDataCount++;
                  checkLoadingComplete();
                }
                scheduleRender();
              }
            );
          }
        }
        if (!unsubPublic.events) {
          unsubPublic.events = onSnapshot(
            query(collection(db, "events")),
            (snap) => {
              eventsData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

              // order 필드가 없는 이벤트들에 기본값 설정
              eventsData.forEach((event, index) => {
                if (event.order === undefined || event.order === null) {
                  event.order = index;
                }
              });

              // order 필드로 정렬
              eventsData.sort((a, b) => (a.order || 0) - (b.order || 0));

              console.log("=== Firebase에서 이벤트 로드 ===");
              console.log(
                "로드된 이벤트 순서:",
                eventsData.map((ev) => ({
                  id: ev.id,
                  order: ev.order,
                  title: ev.title,
                }))
              );
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("events:", err?.message)
          );
        }
        if (!unsubPublic.foodMenus) {
          unsubPublic.foodMenus = onSnapshot(
            collection(db, "foodMenus"),
            (snap) => {
              foodMenusData = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              console.log("뭐먹지 메뉴 로드됨:", foodMenusData.length, "개");
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("foodMenus:", err?.message)
          );
        }
        // 알림 구독 (로그인한 사용자에게만)
        if (!unsubPublic.notifications && currentUser) {
          unsubPublic.notifications = onSnapshot(
            query(
              collection(db, "notifications"),
              orderBy("createdAt", "desc")
            ),
            (snap) => {
              notificationsData = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              console.log("알림 로드됨:", notificationsData.length, "개");
              renderNotifications();
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
            },
            (err) => console.warn("notifications:", err?.message)
          );
        }
      }
      function startAdminListeners() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin) return;
        if (!unsubAdmin.suggestions) {
          unsubAdmin.suggestions = onSnapshot(
            query(collection(db, "suggestions"), orderBy("timestamp", "desc")),
            (snap) => {
              suggestionsData = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("suggestions:", err?.message)
          );
        }
        if (!unsubAdmin.inquiries) {
          unsubAdmin.inquiries = onSnapshot(
            query(collection(db, "inquiries"), orderBy("createdAt", "desc")),
            (snap) => {
              inquiriesData = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              scheduleRender();
            },
            (err) => console.warn("inquiries:", err?.message)
          );
        }
        if (!unsubAdmin.history) {
          unsubAdmin.history = onSnapshot(
            query(collection(db, "history"), orderBy("createdAt", "desc")),
            (snap) => {
              historyData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("history:", err?.message)
          );
        }
        if (!unsubAdmin.members) {
          unsubAdmin.members = onSnapshot(
            query(collection(db, "members"), orderBy("name", "asc")),
            (snap) => {
              membersData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("members:", err?.message)
          );
        }
        if (!unsubAdmin.presence) {
          unsubAdmin.presence = onSnapshot(
            collection(db, "presence"),
            (snap) => {
              presenceData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              computeOnline();
              renderPresenceUI();
            },
            (err) => console.warn("presence:", err?.message)
          );
        }
      }
      function ensureAdminOptionals() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (isAdmin) startAdminListeners();
        else {
          clearAdmin();
          renderPresenceUI();
        }

        // 게임 점수 데이터 로드 (모든 로그인 사용자)
        if (currentUser) {
          loadGameScores();
          loadGroupsData();
        }
      }

      async function main() {
        try {
          await signInAnonymously(auth);
        } catch (e) {
          console.warn("auth fail:", e?.message || e);
        } finally {
          startPublicListeners();
          const saved = JSON.parse(
            localStorage.getItem("foodieUser") || "null"
          );
          if (saved) {
            currentUser = saved;
            verifyAutoLogin(saved).catch(() => {});
            startPresence();
          }
          setTimeout(() => el.loading.classList.add("hidden"), 2000);
          document
            .getElementById("login-button")
            .addEventListener("click", login);

          // 문의하기 버튼 이벤트 리스너 (이벤트 위임 사용)
          document.addEventListener("click", (e) => {
            if (e.target.closest("#inquiry-button")) {
              e.preventDefault();
              openInquiryModal();
            }
          });

          // 자동 로그인 체크박스 이벤트 리스너
          const autoLoginCheckbox = document.getElementById(
            "auto-login-checkbox"
          );
          if (autoLoginCheckbox) {
            autoLoginCheckbox.addEventListener("change", function () {
              const checkbox = this;
              const checkboxContainer = checkbox.nextElementSibling;
              const svg = checkboxContainer.querySelector("svg");

              if (checkbox.checked) {
                checkboxContainer.classList.add(
                  "bg-orange-50",
                  "border-orange-400"
                );
                svg.style.opacity = "1";
              } else {
                checkboxContainer.classList.remove(
                  "bg-orange-50",
                  "border-orange-400"
                );
                svg.style.opacity = "0";
              }
            });
          }
          document
            .getElementById("signup-button")
            .addEventListener("click", openSignupModal);
          document
            .getElementById("modal-close-button")
            .addEventListener("click", closeModal);
          document
            .getElementById("signup-cancel-button")
            .addEventListener("click", () =>
              el.signupModal.classList.add("hidden")
            );
          // 전화번호 자동 포맷
          document
            .getElementById("signupPhone")
            .addEventListener("input", (e) => {
              let value = e.target.value.replace(/[^0-9]/g, ""); // 숫자만 추출
              if (value.length > 11) value = value.slice(0, 11); // 최대 11자리

              // 000-0000-0000 형식으로 변환
              if (value.length > 7) {
                e.target.value = `${value.slice(0, 3)}-${value.slice(
                  3,
                  7
                )}-${value.slice(7)}`;
              } else if (value.length > 3) {
                e.target.value = `${value.slice(0, 3)}-${value.slice(3)}`;
              } else {
                e.target.value = value;
              }
            });

          document
            .getElementById("signup-confirm-button")
            .addEventListener("click", () => confirmSignup(false));
          document
            .getElementById("dues-proceed-button")
            .addEventListener("click", () => {
              el.duesModal.classList.add("hidden");
              confirmSignup(true);
            });
          document
            .getElementById("dues-cancel-button")
            .addEventListener("click", () =>
              el.duesModal.classList.add("hidden")
            );
          document
            .getElementById("dues-copy-button")
            .addEventListener("click", () => {
              const d = duesSettings || {};
              const text = [d.bank, d.number].filter(Boolean).join(" ");
              navigator.clipboard
                ?.writeText(text)
                .then(() => showAlert("✅", "계좌번호가 복사되었습니다."));
            });
          document
            .getElementById("emergency-cancel-button")
            .addEventListener("click", closeEmergencyModal);
          document
            .getElementById("emergency-add-button")
            .addEventListener("click", addEmergencyAdmin);
          renderAll();
        }
      }
      main();

      /* ===== UI 업데이트 ===== */
      function updateSignupUI() {
        const openNow = isSignupOpen();
        if (el.signupBanner)
          el.signupBanner.classList.toggle("hidden", !openNow);
        if (el.signupBtn) {
          el.signupBtn.disabled = !openNow;
          el.signupBtn.title = openNow
            ? "회원가입 가능"
            : "현재는 회원가입 기간이 아닙니다.";

          // 버튼 텍스트 변경
          const iconElement = el.signupBtn.querySelector("i");
          if (openNow) {
            el.signupBtn.innerHTML =
              '<i class="fas fa-user-plus mr-2"></i>회원가입';
          } else {
            el.signupBtn.innerHTML =
              '<i class="fas fa-user-times mr-2"></i>회원모집이 마감됐습니다.';
          }
        }
        renderDuesInfoBox();
      }

      function renderAll() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (currentUser) {
          el.pre.classList.add("hidden");
          el.main.innerHTML = `
            <div class="mb-4 md:mb-6">
              <div class="flex items-center justify-between mb-4">
                <p class="text-gray-700 text-lg md:text-xl font-medium">
                  <span class="text-orange-600 font-bold text-4xl md:text-5xl">F👀die</span> 
                  <b id="userNameDisplay">${saf(
                    currentUser.name
                  )}</b>${getPositionSuffix()}님
                </p>
              </div>
              
              <!-- 로그인 후 블록 표시 영역 (로드맵 위) -->
              <div id="main-dynamic-blocks" class="space-y-4 md:space-y-6 mb-6"></div>
              
              <div id="dashboard-roadmap" class="section mb-4">
                <div class="mb-2 roadmap-accordion">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg md:text-xl font-bold">F👀die 일정</h3>
                  </div>
                  <div class="schedule-blocks-container" id="h-roadmap-list"></div>
                  <div class="roadmap-accordion-content" id="h-roadmap-full-list" style="max-height: 0; overflow: hidden; opacity: 0;">
                    <!-- 전체 일정이 여기에 표시됩니다 -->
                  </div>
                  <div class="mt-4">
                    <button
                      id="h-roadmap-big-btn"
                      type="button"
                      class="w-full md:w-auto md:min-w-[200px] bg-orange-600 hover:bg-orange-700 text-white font-bold px-5 py-3 rounded-xl transition-colors flex items-center justify-center gap-2 mx-auto"
                    >
                      <i class="fas fa-calendar-alt"></i>
                      <span>캘린더</span>
                      <i class="fas fa-chevron-down transition-transform duration-200" id="h-roadmap-big-chevron"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="mb-6 md:mb-8 bg-gradient-to-r from-gray-100 to-gray-50 rounded-2xl p-2 flex flex-nowrap justify-center gap-2 shadow-inner" id="tab-buttons">
              <button type="button" data-tab="roadmap" class="tab-btn flex-1 py-4 sm:py-5 px-4 sm:px-5 md:px-7 rounded-xl font-bold active transition-all duration-300 ease-out whitespace-nowrap">
                <i class="fas fa-utensils mr-1.5 sm:mr-2 text-base sm:text-lg md:text-xl"></i>
                <span class="text-base sm:text-lg md:text-xl">미식회</span>
              </button>
              <button type="button" data-tab="reservation" class="tab-btn flex-1 py-4 sm:py-5 px-4 sm:px-5 md:px-7 rounded-xl font-bold transition-all duration-300 ease-out whitespace-nowrap">
                <i class="fas fa-check mr-1.5 sm:mr-2 text-base sm:text-lg md:text-xl"></i>
                <span class="text-base sm:text-lg md:text-xl">신청</span>
              </button>
              <button type="button" data-tab="dashboard" class="tab-btn flex-1 py-4 sm:py-5 px-4 sm:px-5 md:px-7 rounded-xl font-bold transition-all duration-300 ease-out whitespace-nowrap ${
                isFullAdmin() ? "" : "hidden"
              }">
                <i class="fas fa-crown mr-1.5 sm:mr-2 text-base sm:text-lg md:text-xl"></i>
                <span class="text-base sm:text-lg md:text-xl">관리자</span>
              </button>
            </div>
            <div id="tab-content-container">
              <div id="roadmap-tab" class="tab-content active"></div>
              <div id="reservation-tab" class="tab-content"></div>
              <div id="suggestions-tab" class="tab-content"></div>
              <div id="dashboard-tab" class="tab-content"></div>
            </div>`;
          el.main.classList.remove("hidden");

          // 로그아웃 버튼을 페이지 맨 아래에 추가
          const logoutContainer = document.getElementById("logout-container");
          if (logoutContainer && currentUser) {
            logoutContainer.innerHTML = `
              <button id="logout-button" type="button" class="text-sm md:text-base text-gray-500 hover:text-red-500 bg-white px-4 py-2 rounded-full border shadow-sm transition-all duration-200 hover:shadow-md">
                로그아웃
              </button>
            `;
            document
              .getElementById("logout-button")
              .addEventListener("click", logout);
          }
          document
            .getElementById("tab-buttons")
            .addEventListener("click", (e) => {
              const btn = e.target.closest(".tab-btn");
              if (btn) showTab(btn.dataset.tab);
            });

          // 문의 버튼 이벤트는 위에서 이벤트 위임으로 처리됨

          // 상단 조모임/미니게임 버튼 이벤트
          const rankBtnDup = document.getElementById("rank-button-duplicate");
          if (rankBtnDup) {
            rankBtnDup.addEventListener("click", () => {
              document.getElementById("rank-modal").classList.remove("hidden");
              renderRankList();
            });
          }
          const foodRecommendBtnDup = document.getElementById(
            "food-recommend-button-duplicate"
          );
          if (foodRecommendBtnDup) {
            foodRecommendBtnDup.addEventListener("click", () => {
              openFoodRecommendModal();
            });
          }

          // 문의 모달 닫기
          document
            .getElementById("inquiry-close")
            .addEventListener("click", () => {
              document.getElementById("inquiry-modal").classList.add("hidden");
            });

          // 조모임 순위 버튼 이벤트 리스너
          if (currentUser) {
            document
              .getElementById("rank-button")
              .addEventListener("click", () => {
                document
                  .getElementById("rank-modal")
                  .classList.remove("hidden");
                renderRankList();
              });
          }
          // 헤더의 뭐먹지 버튼 이벤트 리스너
          document
            .getElementById("header-food-btn")
            .addEventListener("click", () => {
              openFoodRecommendModal();
            });

          document
            .getElementById("rank-close")
            .addEventListener("click", () => {
              document.getElementById("rank-modal").classList.add("hidden");
            });

          // 조모임 순위 관리자 기능 이벤트 리스너
          document
            .getElementById("rank-add-team")
            ?.addEventListener("click", () => {
              // 조모임 추가 모달 열기
              openGroupAddModal();
            });

          document
            .getElementById("rank-save-changes")
            ?.addEventListener("click", () => {
              // 조모임 순위 변경사항 저장
              saveGroupRankings();
            });

          document
            .getElementById("food-recommend-close")
            .addEventListener("click", () => {
              document
                .getElementById("food-recommend-modal")
                .classList.add("hidden");
            });

          // 메뉴 정하기 버튼 이벤트 삭제됨 (카테고리 선택 방식으로 변경)
          document
            .getElementById("h-roadmap-big-btn")
            .addEventListener("click", () => {
              roadmapShowAll = !roadmapShowAll;

              // 셰브론 아이콘 애니메이션
              const chevron = document.getElementById("h-roadmap-big-chevron");
              if (chevron) {
                chevron.style.transform = roadmapShowAll
                  ? "rotate(180deg)"
                  : "rotate(0deg)";
              }

              smoothRender("h-roadmap-list", renderHorizontalRoadmap);
            });

          // 로드맵 추가 버튼 이벤트 리스너
          const roadmapAddBtn = document.getElementById("h-roadmap-add-btn");
          if (roadmapAddBtn) {
            roadmapAddBtn.addEventListener("click", () => {
              openRoadmapAddModal();
            });
          }

          renderReservationTab(isAdmin); // 신청하기 탭
          renderHistoryTab(isAdmin);
          renderRoadmapTab(isAdmin);
          renderSuggestionsTab(isAdmin);
          if (isFullAdmin()) renderDashboardTab(); // 운영진 제외, 임원진만 접근 가능

          // 저장된 탭으로 복원
          if (currentMainTab && currentMainTab !== "roadmap") {
            setTimeout(() => {
              showTab(currentMainTab);
            }, 50);
          }

          // DOM이 완전히 렌더링된 후 로드맵 렌더링
          setTimeout(() => {
            updateLoadingProgress(4, "잘 먹겠습니다!");
            renderHorizontalRoadmap();
            renderBlocks(); // 로그인 상태에서도 블록 렌더링
          }, 100);
          computeOnline();
          renderPresenceUI();
        } else {
          el.pre.classList.remove("hidden");
          el.main.classList.add("hidden");

          // 로그아웃 시 로그아웃 버튼 숨김
          const logoutContainer = document.getElementById("logout-container");
          if (logoutContainer) {
            logoutContainer.innerHTML = "";
          }

          updateLoadingProgress(4, "잘 먹겠습니다!");
          // 로그아웃 상태에서는 renderRoadmap() 호출하지 않음 (블록 시스템으로 대체)
          renderBlocks();
          updateSignupUI();
          updateGameButtonsVisibility();
        }
        document.getElementById("rank-close").addEventListener("click", () => {
          document.getElementById("rank-modal").classList.add("hidden");
        });
        document
          .getElementById("food-recommend-close")
          .addEventListener("click", () => {
            document
              .getElementById("food-recommend-modal")
              .classList.add("hidden");
          });

        // 메뉴 정하기 버튼 이벤트 리스너 삭제됨 (카테고리 선택 방식으로 변경)
      }
      const showTab = (name) => {
        currentMainTab = name; // 현재 탭 저장
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`${name}-tab`)?.classList.add("active");
        document
          .querySelector(`.tab-btn[data-tab='${name}']`)
          ?.classList.add("active");
      };

      /* ===== 회원가입 + 회비 안내 ===== */
      function renderDuesInfoBox() {
        const d = duesSettings || {};
        const enabled = !!d.enabled;
        el.duesBox.classList.toggle("hidden", !enabled);
        if (!enabled) {
          el.duesBoxContent.innerHTML = "";
          return;
        }
        const accountInfo =
          d.bank && d.number ? `${saf(d.bank)} ${saf(d.number)}` : "";
        const lines = [];
        if (accountInfo)
          lines.push(
            `<div class="select-all cursor-pointer hover:bg-orange-100 p-2 rounded transition-colors" 
                 onclick="copyToClipboard('${accountInfo.replace(
                   /'/g,
                   "\\'"
                 )}')" 
                 title="클릭하여 계좌번호 복사"><b>${accountInfo}</b>${
              d.holder ? ` (예금주 ${saf(d.holder)})` : ""
            }</div>`
          );
        if (d.amount) lines.push(`회비: <b>${formatKRW(d.amount)}</b>`);
        if (d.note)
          lines.push(
            `<span class="text-amber-700">${saf(d.note || "")}</span>`
          );

        const copyButton = accountInfo
          ? `<button 
                  onclick="copyToClipboard('${accountInfo.replace(
                    /'/g,
                    "\\'"
                  )}')"
            class="w-full mt-3 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2"
            title="계좌번호 복사">
            <i class="fas fa-copy"></i>
            계좌 복사하기
          </button>`
          : "";

        el.duesBoxContent.innerHTML = lines.join("<br/>") + copyButton;
      }
      function openSignupModal() {
        if (!isSignupOpen())
          return showAlert("⛔", "현재는 회원가입 기간이 아닙니다.");
        el.signupModal.classList.remove("hidden");
        document.getElementById("signupId").value = el.id.value.trim();
        document.getElementById("signupName").value = el.name.value.trim();
        renderDuesInfoBox();
      }
      const closeSignupModal = () => el.signupModal.classList.add("hidden");
      function openDuesModal() {
        const d = duesSettings || {};
        const body = [];
        if (d.amount)
          body.push(`<div>회비 금액: <b>${formatKRW(d.amount)}</b></div>`);
        if (d.bank || d.number)
          body.push(
            `<div>입금 계좌: <b>${saf(d.bank || "")} ${saf(
              d.number || ""
            )}</b>${d.holder ? ` (예금주 ${saf(d.holder)})` : ""}</div>`
          );
        if (d.note)
          body.push(`<div class="text-gray-600">${saf(d.note)}</div>`);
        if (body.length === 0)
          body.push(
            `<div class="text-red-600">관리자가 회비 정보를 아직 설정하지 않았습니다.</div>`
          );
        el.duesModalBody.innerHTML = body.join("");
        el.duesModal.classList.remove("hidden");
      }
      async function confirmSignup(skipConfirm) {
        const sid = document.getElementById("signupId").value.trim();
        const nm = document.getElementById("signupName").value.trim();
        const gender = document.getElementById("signupGender").value.trim();
        const year = document.getElementById("signupYear").value.trim();
        const college = document.getElementById("signupCollege").value.trim();
        const dept = document.getElementById("signupDept").value.trim();
        const phone = document.getElementById("signupPhone").value.trim();
        if (!sid || !nm || !gender || !year || !college || !dept || !phone)
          return showAlert("😥", "모든 필드를 입력하세요.");
        if (!skipConfirm && duesSettings?.enabled) {
          openDuesModal();
          return;
        }
        if (!isSignupOpen())
          return showAlert("⛔", "현재는 회원가입 기간이 아닙니다.");
        try {
          const mref = doc(db, "members", sid);
          const ms = await getDoc(mref);
          if (ms.exists()) {
            showAlert("ℹ️", "이미 가입된 학번입니다. 로그인 해주세요.");
            closeSignupModal();
            el.id.value = sid;
            el.name.value = ms.data().name || nm;
            return;
          }
          await setDoc(mref, {
            studentId: sid,
            name: nm,
            gender,
            year,
            college,
            department: dept,
            phone,
            status: "pending",
            requestedAt: serverTimestamp(),
          });
          closeSignupModal();
          showAlert(
            "⏳",
            "가입 신청이 접수되었습니다! <b>관리자 승인 대기중</b>입니다."
          );
          el.id.value = sid;
          el.name.value = nm;
        } catch (e) {
          console.warn(e);
          showAlert("😥", "회원가입 중 오류가 발생했습니다.");
        }
      }

      /* ===================== 홈(로그인 전) ===================== */
      function attachAccordionHandlers(root) {
        root.querySelectorAll(".accordion-header").forEach((h) => {
          h.addEventListener("click", () => toggleAccordion(h));
        });
      }
      function toggleAccordion(header) {
        const item = header.closest(".accordion-item");
        item.classList.toggle("active");
      }

      // 관리자용 블록 수정/삭제 버튼 생성
      function getBlockAdminButtons(block) {
        // 운영진은 블록 관리 불가
        if (!isFullAdmin()) return "";

        // 공지 블록과 Q&A 블록은 항상 버튼 표시 (모바일 대응)
        const opacityClass =
          block.type === "notice" || block.type === "qa"
            ? "opacity-100"
            : "opacity-0 group-hover:opacity-100";

        return `
          <div class="block-admin-controls absolute top-2 right-2 flex gap-1 ${opacityClass} transition-opacity z-10">
            <button class="move-block-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                    data-block-id="${block.id}" title="위로 이동">
              <i class="fas fa-arrow-up"></i>
            </button>
            <button class="move-block-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                    data-block-id="${block.id}" title="아래로 이동">
              <i class="fas fa-arrow-down"></i>
            </button>
            <button class="edit-block-inline bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                    data-id="${block.id}" data-type="${block.type}" title="수정">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-block-inline bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                    data-id="${block.id}" data-type="${block.type}" title="삭제">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      }

      function renderBlocks() {
        const isLoggedIn = !!currentUser;
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // 로그인 상태에 따라 적절한 컨테이너 선택
        const wrap = isLoggedIn
          ? document.getElementById("main-dynamic-blocks")
          : document.getElementById("dynamic-blocks");

        if (!wrap) return;

        // 로그인 상태에 따른 블록 필터링
        const visible = (blocksData || []).filter((b) => {
          if (b.visible === false) return false;

          // showWhen 설정이 있으면 해당 조건 확인
          if (b.showWhen) {
            if (b.showWhen === "login" && !isLoggedIn) return false;
            if (b.showWhen === "logout" && isLoggedIn) return false;
          }

          return true;
        });

        // 로그아웃 상태에서는 일정 블록 추가
        if (!isLoggedIn && roadmapData && roadmapData.length > 0) {
          const scheduleBlock = {
            id: "auto-schedule-block",
            type: "schedule",
            title: "F👀die 일정",
            visible: true,
            showWhen: "logout",
            order: 1,
            isAuto: true,
          };
          visible.unshift(scheduleBlock);
        }
        const snippets = visible.map((b) => {
          if (b.type === "announcement") {
            // 공지사항 블록 표시
            return `
              <div class="border rounded-lg p-3 md:p-4 bg-gradient-to-r from-blue-50 to-indigo-50 shadow-sm hover:shadow-md transition-shadow relative">
                <div class="flex flex-col sm:flex-row items-start gap-3">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                      <i class="fas fa-bullhorn text-white"></i>
                    </div>
                  </div>
                  <div class="flex-1 min-w-0 w-full">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                      <h3 class="font-bold text-base md:text-lg text-blue-800 break-words">${saf(
                        b.title
                      )}</h3>
                      ${b.isAuto ? "" : ""}
                    </div>
                    <div class="text-sm md:text-base text-gray-700 whitespace-pre-wrap break-words">${saf(
                      b.content
                    )}</div>
                    <div class="text-xs text-gray-500 mt-2">
                      ${new Date(b.createdAt).toLocaleString("ko-KR")}
                    </div>
                  </div>
                </div>
              </div>
            `;
          } else if (b.type === "schedule") {
            // 일정 블록 표시 (로그아웃 전용)
            if (!isLoggedIn && roadmapData && roadmapData.length > 0) {
              // 운영진 전용 일정 필터링 후 날짜순으로 정렬
              const filteredData = roadmapData.filter((item) => {
                if (!item || typeof item !== "object" || !item.id) return false;
                // 로그아웃 상태에서는 운영진 전용 일정 숨김
                if (item.isAdminOnly) return false;
                return true;
              });

              const sorted = [...filteredData].sort((a, b) => {
                const dateA = parseDate(a.activityDate);
                const dateB = parseDate(b.activityDate);
                return dateA - dateB;
              });

              // 달력 형태로 렌더링 (다운로드 버튼 없음)
              const calendarHTML = generateCalendar(
                new Date().getFullYear(),
                new Date().getMonth(),
                sorted,
                false, // 로그아웃 상태에서는 다운로드 버튼 표시하지 않음
                false, // 로그아웃 상태에서는 관리자 권한 없음
                false // 로그아웃 상태에서는 네비게이션 버튼과 안내 문구 표시하지 않음
              );

              return `
                <div class="border rounded-lg p-3 md:p-4 bg-white shadow-sm hover:shadow-md transition-shadow relative">
                  <div class="flex flex-wrap items-center gap-2 mb-3">
                    <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                      <i class="fas fa-calendar-alt text-white text-sm"></i>
                    </div>
                    <h3 class="font-bold text-base md:text-lg text-gray-800 break-words flex-1 min-w-0">${saf(
                      b.title
                    )}</h3>
                    ${b.isAuto ? "" : ""}
                  </div>
                  <div class="schedule-content">
                    ${calendarHTML}
                  </div>
                </div>
              `;
            }
            return ""; // 로그인 상태에서는 빈 문자열 반환
          } else if (b.type === "scores") {
            // 점수판 블록 표시
            const teams = b.payload?.teams || [];
            const sortedTeams = teams.sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );

            const teamsHTML = sortedTeams
              .map(
                (team, index) => `
              <div class="flex items-center justify-between p-2 md:p-3 bg-gradient-to-r from-orange-50 to-orange-100 border border-orange-200 rounded-lg">
                <div class="flex items-center gap-2 md:gap-3 flex-1 min-w-0">
                  <div class="flex items-center justify-center w-7 h-7 md:w-8 md:h-8 rounded-full text-white font-bold text-xs md:text-sm flex-shrink-0 ${
                    index === 0
                      ? "bg-yellow-500"
                      : index === 1
                      ? "bg-gray-400"
                      : index === 2
                      ? "bg-amber-600"
                      : "bg-orange-500"
                  }">
                    ${index + 1}
                  </div>
                  <div class="flex-1 min-w-0">
                    <span class="font-bold text-base md:text-lg text-gray-800 break-words block">${saf(
                      team.name
                    )}</span>
                    <div class="text-xs md:text-sm text-gray-600">${
                      team.score || 0
                    }점</div>
                  </div>
                </div>
              </div>
            `
              )
              .join("");

            // 관리자 권한 확인 - 운영진 제외
            const isAdminForBlocks = isFullAdmin();

            return `
              <div class="border rounded-lg p-3 md:p-4 bg-white shadow-sm hover:shadow-md transition-shadow relative">
                ${
                  isAdminForBlocks
                    ? `
                  <div class="absolute top-2 right-2 flex gap-1 flex-wrap">
                    <button class="move-block-up score-block-move-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                            data-block-id="${b.id}" title="위로 이동">
                      <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="move-block-down score-block-move-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                            data-block-id="${b.id}" title="아래로 이동">
                      <i class="fas fa-arrow-down"></i>
                    </button>
                    <button class="edit-score-block-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                            data-block-id="${b.id}" title="수정">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-score-block-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                            data-block-id="${b.id}" title="삭제">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                `
                    : ""
                }
                <div class="flex justify-between items-start mb-3 pr-0 md:pr-0">
                  <h3 class="font-bold text-base md:text-lg text-gray-800 break-words pr-20">${saf(
                    b.title
                  )}</h3>
                </div>
                <div class="space-y-2">
                  ${
                    teamsHTML ||
                    '<p class="text-gray-400 text-center py-4 text-sm">팀 데이터가 없습니다.</p>'
                  }
                </div>
              </div>
            `;
          } else if (b.type === "qa") {
            const items = b.payload?.items || [];
            const html = items.length
              ? items
                  .map(
                    (it) =>
                      `<div class="border rounded p-3 md:p-4 bg-white hover:bg-gray-50 transition-colors">
                        <div class="font-semibold text-sm md:text-base text-gray-800 mb-2 whitespace-pre-wrap break-words">Q. ${saf(
                          it.q || "-"
                        )}</div>
                        <div class="text-sm md:text-base text-gray-600 mt-2 pl-3 md:pl-4 whitespace-pre-wrap leading-relaxed break-words">A. ${saf(
                          it.a || "-"
                        )}</div>
                      </div>`
                  )
                  .join("")
              : `<div class="text-gray-400 text-sm">질문이 없습니다.</div>`;
            return `<div class="accordion-item section relative" data-block="${
              b.id
            }">
                      ${getBlockAdminButtons(b)}
                      <div class="accordion-header cursor-pointer flex items-center justify-between py-3 px-2 md:px-3 hover:bg-gray-50 transition-colors">
                        <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 flex items-center break-words flex-1 min-w-0 pr-2">
                          <i class="fas fa-question-circle mr-2 text-orange-500 flex-shrink-0"></i>
                          <span class="break-words">${saf(
                            b.title || "Q&A"
                          )}</span>
                        </h3>
                        <i class="fas fa-chevron-down accordion-icon transition-transform duration-300 text-gray-400 flex-shrink-0"></i>
                      </div>
                      <div class="accordion-content">
                        <div class="space-y-2 px-2 md:px-3 pb-3">${html}</div>
                      </div>
                    </div>`;
          } else if (b.type === "notice") {
            const content = b.payload?.html || b.payload?.text || "";
            return `<div class="section accordion-item relative" data-block="${
              b.id
            }">
                      ${getBlockAdminButtons(b)}
                      <div class="accordion-header cursor-pointer flex items-center justify-between py-3 px-2 md:px-3 hover:bg-gray-50 transition-colors">
                        <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 flex items-center break-words flex-1 min-w-0 pr-2">
                          <i class="fas fa-bullhorn mr-2 text-orange-500 flex-shrink-0"></i><span class="break-words">${saf(
                            b.title || "공지"
                          )}</span>
                        </h3>
                        <i class="fas fa-chevron-down accordion-icon transition-transform duration-300 text-gray-400 flex-shrink-0"></i>
                      </div>
                      <div class="accordion-content">
                        <div class="prose prose-sm max-w-none text-sm md:text-base text-gray-700 whitespace-pre-wrap break-words px-2 md:px-3 pb-3">${
                          content || "내용이 없습니다."
                        }</div>
                      </div>
                    </div>`;
          } else if (b.type === "roadmap") {
            // 로드맵 블록의 일정 데이터 처리
            const roadmapItems = b.payload?.items || [];
            const description = b.payload?.description || "";

            // 기존 단일 일정 지원 (하위 호환성)
            if (!roadmapItems.length && b.payload?.date) {
              roadmapItems.push({
                title: b.title || "일정",
                date: b.payload.date,
                description: b.payload.description || "",
              });
            }

            // 로드맵 블록 내에서 관리자 권한 확인
            const isAdminForRoadmap = currentUser; // 임시로 모든 로그인 사용자에게 버튼 표시

            // 디버깅을 위한 콘솔 로그
            console.log("로드맵 블록 권한 확인:", {
              currentUser: currentUser?.name,
              position: currentUser?.position,
              studentId: currentUser?.studentId,
              isAdminList: adminList.includes(currentUser?.studentId),
              isAdminForRoadmap,
              roadmapItemsCount: roadmapItems.length,
              adminList: adminList,
            });

            return `<div class="accordion-item section relative" data-block="${
              b.id
            }">
                      ${getBlockAdminButtons(b)}
                      <div class="accordion-header cursor-pointer p-3 md:p-4 lg:p-6">
                        <div class="flex flex-col gap-2">
                          <div class="flex items-center justify-between w-full">
                            <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 break-words flex-1 min-w-0 pr-2"><i class="fas fa-map-signs mr-2 text-orange-500 flex-shrink-0"></i><span class="break-words">${saf(
                              b.title || "로드맵"
                            )}</span></h3>
                            <i class="fas fa-chevron-down text-gray-500 flex-shrink-0"></i>
                          </div>
                          ${
                            isAdminForRoadmap
                              ? `
                            <div class="flex gap-1 justify-start flex-wrap">
                              <button class="add-roadmap-item bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition-colors" 
                                      data-block-id="${b.id}" title="새 일정 추가">
                                <i class="fas fa-plus mr-1"></i>일정 추가
                              </button>
                            </div>
                          `
                              : ""
                          }
                        </div>
                      </div>
                      <div class="accordion-content">
                        <div class="space-y-3">
                          ${
                            roadmapItems.length > 0
                              ? roadmapItems
                                  .map((item, index) => {
                                    const formattedDate = item.date
                                      ? new Date(item.date).toLocaleDateString(
                                          "ko-KR",
                                          {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                          }
                                        )
                                      : "날짜 미정";

                                    return `
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4">
                                      <div class="flex items-center justify-between mb-2 gap-2">
                                        <div class="flex items-center">
                                          <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                                          <span class="font-semibold text-blue-800">${saf(
                                            item.title || "일정"
                                          )}</span>
                                        </div>
                                        ${
                                          isAdminForRoadmap
                                            ? `
                                          <div class="flex gap-1">
                                            <button class="edit-roadmap-item bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                                                    data-block-id="${b.id}" data-item-index="${index}" title="일정 수정">
                                              <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="delete-roadmap-item bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                                                    data-block-id="${b.id}" data-item-index="${index}" title="일정 삭제">
                                              <i class="fas fa-trash"></i>
                                            </button>
                                          </div>
                                        `
                                            : ""
                                        }
                                      </div>
                                      <p class="text-blue-700">${formattedDate}</p>
                                      ${
                                        item.description
                                          ? `<p class="text-blue-600 text-sm mt-2">${saf(
                                              item.description
                                            )}</p>`
                                          : ""
                                      }
                                    </div>
                                  `;
                                  })
                                  .join("")
                              : `
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-500">
                                  <i class="fas fa-calendar-plus text-2xl mb-2"></i>
                                  <p>등록된 일정이 없습니다.</p>
                                  ${
                                    isAdminForRoadmap
                                      ? `<p class="text-sm mt-1">일정 추가 버튼을 눌러 첫 번째 일정을 추가하세요.</p>`
                                      : ""
                                  }
                                </div>
                              `
                          }
                          ${
                            description
                              ? `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                              <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                  <i class="fas fa-info-circle text-gray-500 mr-2"></i>
                                  <span class="font-semibold text-gray-800">설명</span>
                                </div>
                                ${
                                  isAdminForRoadmap
                                    ? `
                                  <div class="flex gap-1">
                                    <button class="edit-roadmap-description bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                                            data-block-id="${b.id}" title="설명 수정">
                                      <i class="fas fa-edit"></i>
                                    </button>
                                  </div>
                                `
                                    : ""
                                }
                              </div>
                              <p class="text-gray-700 whitespace-pre-wrap">${saf(
                                description
                              )}</p>
                            </div>
                          `
                              : ""
                          }
                          ${
                            isAdminForRoadmap
                              ? `
                            <div class="text-center pt-2">
                              <button class="add-roadmap-item bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors" 
                                      data-block-id="${b.id}" title="새 일정 추가">
                                <i class="fas fa-plus mr-1"></i>새 일정 추가
                              </button>
                            </div>
                          `
                              : ""
                          }
                        </div>
                      </div>
                    </div>`;
          } else {
            const content = saf(b.payload?.html || b.payload?.text || "");
            return `<div class="section accordion-item" data-block="${b.id}">
                      <div class="accordion-header cursor-pointer flex items-center justify-between py-3 px-1 hover:bg-gray-50 transition-colors">
                        <h3 class="text-lg md:text-xl font-bold text-gray-700 flex items-center">
                          <i class="fas fa-info-circle mr-2 text-orange-500"></i>${saf(
                            b.title || "블록"
                          )}
                        </h3>
                        <i class="fas fa-chevron-down accordion-icon transition-transform duration-300 text-gray-400"></i>
                      </div>
                      <div class="accordion-content">
                        <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap px-1 pb-3">${
                          content || "내용이 없습니다."
                        }</div>
                      </div>
                    </div>`;
          }
        });

        // 관리자용 새 블록 생성 버튼 추가
        let finalSnippets = snippets;
        // 운영진은 블록 추가 불가, 임원진만 가능
        if (isFullAdmin()) {
          // 새 공지 추가 박스를 맨 앞에 배치
          const addBlockPlaceholder = `
            <div class="add-block-placeholder border-2 border-dashed border-orange-300 rounded-lg p-4 text-center hover:border-orange-400 hover:bg-orange-50 transition-colors cursor-pointer group bg-orange-50" 
                 data-position="1" data-act="add-new-block">
              <div class="flex flex-col items-center justify-center space-y-2">
                <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                  <i class="fas fa-plus-circle text-xl text-orange-500"></i>
                </div>
                <span class="text-sm font-medium text-orange-600 group-hover:text-orange-700">새 공지 추가</span>
              </div>
            </div>
          `;

          if (snippets.length > 0) {
            // 기존 블록이 있으면 새 공지 추가 박스를 맨 앞에 배치
            finalSnippets = [addBlockPlaceholder, ...snippets];
          } else {
            // 블록이 없을 때 첫 번째 블록 생성 버튼
            finalSnippets = [
              `
              <div class="add-block-placeholder border-2 border-dashed border-orange-300 rounded-lg p-8 text-center hover:border-orange-400 hover:bg-orange-50 transition-colors cursor-pointer group bg-orange-50" 
                   data-position="1" data-act="add-new-block">
                <div class="flex flex-col items-center justify-center space-y-4">
                  <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                    <i class="fas fa-plus-circle text-4xl text-orange-500"></i>
                  </div>
                  <span class="text-lg font-medium text-orange-600 group-hover:text-orange-700">첫 번째 공지를 추가하세요</span>
                </div>
              </div>
              `,
            ];
          }
        }

        wrap.innerHTML = finalSnippets.length
          ? finalSnippets.join("")
          : `<div class="section text-center text-gray-400">표시할 블록이 없습니다.</div>`;
        attachAccordionHandlers(wrap);

        // 새 블록 생성 버튼 이벤트 리스너 추가
        if (isAdmin) {
          // 회색 점선 블록 전체 클릭 이벤트
          wrap
            .querySelectorAll(".add-block-placeholder")
            .forEach((placeholder) => {
              placeholder.addEventListener("click", (e) => {
                e.stopPropagation();
                const position = parseInt(placeholder.dataset.position) || 1;
                // 블록 타입 선택 모달 열기
                openBlockModal(null, null, position);
              });
            });

          wrap.querySelectorAll(".add-block-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const position = parseInt(btn.dataset.position);
              // 블록 타입 선택 모달 열기
              openBlockModal(null, null, position);
            });
          });

          // 인라인 수정/삭제 버튼 이벤트 리스너 추가
          wrap.querySelectorAll(".edit-block-inline").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.id;
              const blockType = btn.dataset.type;
              openBlockModal(blockType, blockId);
            });
          });

          wrap.querySelectorAll(".delete-block-inline").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.id;
              const blockType = btn.dataset.type;

              if (
                confirm(
                  `${getBlockTypeName(blockType)} 블록을 삭제하시겠습니까?`
                )
              ) {
                try {
                  await deleteDoc(doc(db, "homepageBlocks", blockId));
                  showAlert("✅", "블록이 삭제되었습니다.");
                  smoothRender("dynamic-blocks", renderBlocks); // 블록 목록 새로고침
                } catch (error) {
                  console.error("블록 삭제 오류:", error);
                  showAlert("😥", "블록 삭제에 실패했습니다.");
                }
              }
            });
          });

          // 점수판 블록 이벤트 리스너 추가
          wrap.querySelectorAll(".edit-score-block-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openBlockModal("scores", blockId);
            });
          });

          // 점수판 블록 순서 변경 이벤트 리스너 추가
          wrap.querySelectorAll(".score-block-move-up").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              console.log("점수판 블록 위로 이동 버튼 클릭:", blockId);
              await moveBlockUp(blockId);
            });
          });

          wrap.querySelectorAll(".score-block-move-down").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              console.log("점수판 블록 아래로 이동 버튼 클릭:", blockId);
              await moveBlockDown(blockId);
            });
          });

          wrap.querySelectorAll(".delete-score-block-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              if (!confirm("점수판 블록을 삭제할까요?")) return;

              try {
                await deleteDoc(doc(db, "homepageBlocks", blockId));
                showAlert("✅", "점수판 블록이 삭제되었습니다.");
                smoothRender("dynamic-blocks", renderBlocks); // 블록 목록 새로고침
              } catch (error) {
                console.error("점수판 블록 삭제 오류:", error);
                showAlert("😥", "점수판 블록 삭제 중 오류가 발생했습니다.");
              }
            });
          });

          // 일반 블록(공지, Q&A 등) 순서 변경 이벤트 리스너 추가
          wrap
            .querySelectorAll(".move-block-up:not(.score-block-move-up)")
            .forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                e.stopPropagation();
                const blockId = btn.dataset.blockId;
                console.log("일반 블록 위로 이동 버튼 클릭:", blockId);
                await moveBlockUp(blockId);
              });
            });

          wrap
            .querySelectorAll(".move-block-down:not(.score-block-move-down)")
            .forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                e.stopPropagation();
                const blockId = btn.dataset.blockId;
                console.log("일반 블록 아래로 이동 버튼 클릭:", blockId);
                await moveBlockDown(blockId);
              });
            });

          // 로드맵 블록 관리 버튼 이벤트 리스너 추가 (헤더와 콘텐츠 모두)
          wrap.querySelectorAll(".edit-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              const itemIndex = parseInt(btn.dataset.itemIndex);
              openRoadmapItemEditModal(blockId, itemIndex);
            });
          });

          wrap.querySelectorAll(".delete-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              const itemIndex = parseInt(btn.dataset.itemIndex);

              if (confirm("이 일정을 삭제하시겠습니까?")) {
                await deleteRoadmapItem(blockId, itemIndex);
                showAlert("✅", "일정이 삭제되었습니다.");
                renderBlocks(); // 블록 목록 새로고침
              }
            });
          });

          wrap.querySelectorAll(".edit-roadmap-description").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openRoadmapDescriptionEditModal(blockId);
            });
          });

          wrap.querySelectorAll(".add-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openRoadmapItemAddModal(blockId);
            });
          });
        }
      }

      // 로드맵 일정 수정 모달
      function openRoadmapItemEditModal(blockId, itemIndex) {
        const block = blocksData.find((b) => b.id === blockId);
        if (!block) return;

        // 다중 일정 구조에서 해당 일정 데이터 가져오기
        const items = block.payload?.items || [];
        let itemData = null;

        if (items.length > 0 && itemIndex >= 0 && itemIndex < items.length) {
          // 다중 일정 구조
          itemData = items[itemIndex];
        } else if (block.payload?.date) {
          // 기존 단일 일정 구조
          itemData = {
            title: block.title || "",
            date: block.payload.date,
            description: block.payload.description || "",
          };
        }

        if (!itemData) {
          showAlert("😥", "일정 데이터를 찾을 수 없습니다.");
          return;
        }

        const modalHTML = `
          <div id="roadmap-item-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">로드맵 일정 수정</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">일정 제목</label>
                  <input id="roadmap-item-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${saf(
                    itemData.title || ""
                  )}" placeholder="일정 제목">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                  <input id="roadmap-item-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${
                    itemData.date || ""
                  }">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                  <textarea id="roadmap-item-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="설명">${saf(
                    itemData.description || ""
                  )}</textarea>
                </div>
                <input id="roadmap-item-block-id" type="hidden" value="${blockId}">
                <input id="roadmap-item-index" type="hidden" value="${itemIndex}">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-item-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>저장
                </button>
                <button id="roadmap-item-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          </div>
        `;

        // 기존 모달 제거
        const existingModal = document.getElementById(
          "roadmap-item-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("roadmap-item-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-item-block-id"
            ).value;
            const itemIndex = parseInt(
              document.getElementById("roadmap-item-index").value
            );
            const title = document
              .getElementById("roadmap-item-title")
              .value.trim();
            const date = document.getElementById("roadmap-item-date").value;
            const description = document
              .getElementById("roadmap-item-description")
              .value.trim();

            if (!title) {
              showAlert("😥", "일정 제목을 입력해주세요.");
              return;
            }

            await updateRoadmapItem(
              blockId,
              itemIndex,
              title,
              date,
              description
            );
            showAlert("✅", "로드맵 일정이 수정되었습니다.");
            document.getElementById("roadmap-item-edit-modal").remove();
            smoothRender("dynamic-blocks", renderBlocks); // 블록 목록 새로고침
          });

        document
          .getElementById("roadmap-item-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-item-edit-modal").remove();
          });

        // 모달 외부 클릭 시 닫기
        document
          .getElementById("roadmap-item-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-item-edit-modal") {
              document.getElementById("roadmap-item-edit-modal").remove();
            }
          });
      }

      // 로드맵 설명 수정 모달
      function openRoadmapDescriptionEditModal(blockId) {
        const block = blocksData.find((b) => b.id === blockId);
        if (!block) return;

        const description = block.payload?.description || "";

        const modalHTML = `
          <div id="roadmap-description-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">로드맵 설명 수정</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                  <textarea id="roadmap-description-text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="4" placeholder="설명">${saf(
                    description
                  )}</textarea>
                </div>
                <input id="roadmap-description-block-id" type="hidden" value="${blockId}">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-description-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>저장
                </button>
                <button id="roadmap-description-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          </div>
        `;

        // 기존 모달 제거
        const existingModal = document.getElementById(
          "roadmap-description-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("roadmap-description-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-description-block-id"
            ).value;
            const description = document
              .getElementById("roadmap-description-text")
              .value.trim();

            await updateRoadmapDescription(blockId, description);
            showAlert("✅", "로드맵 설명이 수정되었습니다.");
            document.getElementById("roadmap-description-edit-modal").remove();
            renderBlocks(); // 블록 목록 새로고침
          });

        document
          .getElementById("roadmap-description-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-description-edit-modal").remove();
          });

        // 모달 외부 클릭 시 닫기
        document
          .getElementById("roadmap-description-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-description-edit-modal") {
              document
                .getElementById("roadmap-description-edit-modal")
                .remove();
            }
          });
      }

      // 로드맵 일정 추가 모달
      function openRoadmapItemAddModal(blockId) {
        const modalHTML = `
          <div id="roadmap-item-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">새 로드맵 일정 추가</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">일정 제목</label>
                  <input id="roadmap-add-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="일정 제목">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                  <input id="roadmap-add-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                  <textarea id="roadmap-add-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="설명"></textarea>
                </div>
                <input id="roadmap-add-block-id" type="hidden" value="${blockId}">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-plus mr-2"></i>추가
                </button>
                <button id="roadmap-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          </div>
        `;

        // 기존 모달 제거
        const existingModal = document.getElementById("roadmap-item-add-modal");
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("roadmap-add-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-add-block-id"
            ).value;
            const title = document
              .getElementById("roadmap-add-title")
              .value.trim();
            const date = document.getElementById("roadmap-add-date").value;
            const description = document
              .getElementById("roadmap-add-description")
              .value.trim();

            if (!title) {
              showAlert("😥", "일정 제목을 입력해주세요.");
              return;
            }

            if (!date) {
              showAlert("😥", "날짜를 선택해주세요.");
              return;
            }

            await addRoadmapItem(blockId, title, date, description);
            showAlert("✅", "새 로드맵 일정이 추가되었습니다.");
            document.getElementById("roadmap-item-add-modal").remove();
            renderBlocks(); // 블록 목록 새로고침
          });

        document
          .getElementById("roadmap-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-item-add-modal").remove();
          });

        // 모달 외부 클릭 시 닫기
        document
          .getElementById("roadmap-item-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-item-add-modal") {
              document.getElementById("roadmap-item-add-modal").remove();
            }
          });
      }

      // 로드맵 블록 업데이트
      async function updateRoadmapBlock(blockId, title, date, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        await updateDoc(blockRef, {
          title: title,
          payload: {
            date: date,
            description: description,
          },
        });
      }

      // 로드맵 설명 업데이트
      async function updateRoadmapDescription(blockId, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const block = blocksData.find((b) => b.id === blockId);
        await updateDoc(blockRef, {
          payload: {
            ...block.payload,
            description: description,
          },
        });
      }

      // 로드맵 일정 삭제 (다중 일정 지원)
      async function deleteRoadmapItem(blockId, itemIndex) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("블록을 찾을 수 없습니다.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // 기존 단일 일정 구조인 경우 전체 블록 삭제
        if (items.length === 0 && blockData.payload?.date) {
          await deleteDoc(blockRef);
          return;
        }

        // 다중 일정 구조인 경우 해당 일정만 삭제
        if (itemIndex >= 0 && itemIndex < items.length) {
          items.splice(itemIndex, 1);

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: items,
            },
          });
        }
      }

      // 로드맵 일정 추가 (다중 일정 지원)
      async function addRoadmapItem(blockId, title, date, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("블록을 찾을 수 없습니다.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // 기존 단일 일정 구조를 다중 일정 구조로 변환
        if (items.length === 0 && blockData.payload?.date) {
          const existingItem = {
            title: blockData.title || "기존 일정",
            date: blockData.payload.date,
            description: blockData.payload.description || "",
          };

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: [
                existingItem,
                {
                  title: title,
                  date: date,
                  description: description,
                },
              ],
            },
          });
        } else {
          // 다중 일정 구조에 새 일정 추가
          const newItem = {
            title: title,
            date: date,
            description: description,
          };

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: [...items, newItem],
            },
          });
        }
      }

      // 로드맵 일정 수정 (다중 일정 지원)
      async function updateRoadmapItem(
        blockId,
        itemIndex,
        title,
        date,
        description
      ) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("블록을 찾을 수 없습니다.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // 기존 단일 일정 구조인 경우
        if (items.length === 0 && blockData.payload?.date) {
          await updateDoc(blockRef, {
            title: title,
            payload: {
              ...blockData.payload,
              date: date,
              description: description,
            },
          });
        } else {
          // 다중 일정 구조인 경우
          if (itemIndex >= 0 && itemIndex < items.length) {
            items[itemIndex] = {
              title: title,
              date: date,
              description: description,
            };

            await updateDoc(blockRef, {
              payload: {
                ...blockData.payload,
                items: items,
              },
            });
          }
        }
      }

      function renderRoadmap() {
        // 로그아웃 상태에서는 아무것도 렌더링하지 않음 (블록 시스템으로 대체)
        if (!currentUser) {
          console.log("renderRoadmap: 로그아웃 상태 - 렌더링하지 않음");
          return;
        }

        const c = document.getElementById("roadmap-container");
        const btn = document.getElementById("roadmap-toggle-btn");
        if (!c) return;
        const total = roadmapData.length;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // order 우선 → 날짜(오름차순)
        const sorted = [...roadmapData].sort((a, b) => {
          const ao = a.order ?? 999999,
            bo = b.order ?? 999999;
          if (ao !== bo) return ao - bo;
          return (a.activityDate || "").localeCompare(b.activityDate || "");
        });

        const enriched = sorted.map((item) => {
          const d = parseDate(item.activityDate);
          let status = "upcoming";
          if (d < today) status = "completed";
          else if (d.toDateString() === today.toDateString()) status = "today";
          return { ...item, _date: d, _status: status };
        });
        let itemsToShow = enriched;
        if (!roadmapShowAll) {
          // 로그아웃 상태: 끝난 일정 1개 + 앞으로 있을 일정 3개
          if (!currentUser) {
            const completed = enriched.filter((x) => x._status === "completed");
            const upcoming = enriched.filter((x) => x._status !== "completed");

            // 완료된 일정을 날짜 내림차순으로 정렬하여 가장 최근 것 선택
            const sortedCompleted = completed.sort((a, b) => b._date - a._date);
            const latestCompleted =
              sortedCompleted.length > 0 ? [sortedCompleted[0]] : [];

            // 앞으로 있을 일정 중 최대 3개만 선택
            const upcomingLimited = upcoming.slice(0, 3);

            itemsToShow = [...latestCompleted, ...upcomingLimited];
          } else {
            // 로그인 상태: 최근 끝난 일정 1개 + 앞으로 올 일정들만 표시
            const completed = enriched.filter((x) => x._status === "completed");
            const upcoming = enriched.filter((x) => x._status !== "completed");

            // 완료된 일정을 날짜 내림차순으로 정렬하여 가장 최근 것 선택
            const sortedCompleted = completed.sort((a, b) => b._date - a._date);
            const latestCompleted =
              sortedCompleted.length > 0 ? [sortedCompleted[0]] : [];

            itemsToShow = [...latestCompleted, ...upcoming];
          }
        }
        // 관리자 권한 확인 - 운영진 제외, 임원진만 가능
        const isAdminForRoadmap = isFullAdmin();

        console.log("로드맵 관리자 권한 확인:", {
          currentUser: currentUser?.name,
          isAdminForRoadmap,
          roadmapDataLength: roadmapData.length,
        });

        // 관리자 컨트롤 표시/숨김
        const adminControls = document.getElementById("roadmap-admin-controls");
        console.log("관리자 컨트롤 요소:", adminControls);

        if (adminControls) {
          if (isAdminForRoadmap) {
            adminControls.classList.remove("hidden");
            console.log("관리자 컨트롤 표시됨");
          } else {
            adminControls.classList.add("hidden");
            console.log("관리자 컨트롤 숨김됨");
          }
        } else {
          console.error("roadmap-admin-controls 요소를 찾을 수 없습니다!");
        }

        // 로그아웃 상태에서는 로드맵을 렌더링하지 않음 (블록 시스템으로 대체)
        if (!currentUser) {
          // 로그아웃 상태에서는 아무것도 표시하지 않음
          c.innerHTML = "";
        } else {
          // 로그인 상태에서는 기존 리스트 형태 유지
          c.innerHTML =
            total === 0
              ? `<p class="text-gray-400 text-center py-4">예정된 활동이 없습니다. 회장님이 곧 일정을 추가할 거예요!</p>`
              : itemsToShow
                  .map(
                    (item, index) => `<div class="v-item ${
                      item._status
                    } relative">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="font-bold text-gray-800">${saf(
                      item.activityName
                    )}</div>
                    <div class="text-sm text-gray-500">${item._date.toLocaleDateString(
                      "ko-KR"
                    )}</div>
                  </div>
                  ${
                    isAdminForRoadmap
                      ? `
                    <div class="flex gap-1 ml-2">
                      <button class="edit-roadmap-event bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                              data-event-id="${item.id}" data-event-index="${index}" title="일정 수정">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="delete-roadmap-event bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                              data-event-id="${item.id}" data-event-index="${index}" title="일정 삭제">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  `
                      : ""
                  }
                </div>
              </div>`
                  )
                  .join("");
        }
        if (btn) {
          // 로그아웃 상태에서는 항상 버튼 숨김 (이미 달력 형태로 표시되므로)
          if (!currentUser) {
            btn.classList.add("hidden");
          } else {
            // 로그인 상태에서는 기존 로직 유지
            const shouldShowButton = total > 4;
            if (shouldShowButton) {
              btn.classList.remove("hidden");
              const textElement = btn.querySelector("#roadmap-toggle-text");
              if (textElement) {
                textElement.textContent = roadmapShowAll
                  ? "간단히 보기"
                  : "캘린더";
              }
              btn.onclick = () => {
                roadmapShowAll = !roadmapShowAll;
                renderRoadmap();
              };
            } else {
              btn.classList.add("hidden");
            }
          }
        }

        // 로드맵 관리 버튼 이벤트 리스너 추가
        if (isAdminForRoadmap) {
          // 일정 추가 버튼
          const addBtn = document.getElementById("add-roadmap-event");
          if (addBtn) {
            addBtn.onclick = () => {
              openRoadmapEventAddModal();
            };
          }

          // 일정 수정 버튼들
          document.querySelectorAll(".edit-roadmap-event").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const eventId = btn.dataset.eventId;
              const eventIndex = parseInt(btn.dataset.eventIndex);
              openRoadmapEventEditModal(eventId, eventIndex);
            });
          });

          // 일정 삭제 버튼들
          document.querySelectorAll(".delete-roadmap-event").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const eventId = btn.dataset.eventId;
              const eventIndex = parseInt(btn.dataset.eventIndex);

              if (confirm("이 일정을 삭제하시겠습니까?")) {
                try {
                  await deleteDoc(doc(db, "roadmap", eventId));
                  showAlert("✅", "일정이 삭제되었습니다.");
                  renderRoadmap();
                } catch (error) {
                  console.error("일정 삭제 오류:", error);
                  showAlert("😥", "일정 삭제에 실패했습니다.");
                }
              }
            });
          });
        }
      }

      // 로드맵 일정 추가 모달
      function openRoadmapEventAddModal() {
        const modalHTML = `
          <div id="roadmap-event-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">로드맵 일정 추가</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">일정 제목</label>
                  <input id="roadmap-event-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="일정 제목">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                  <input id="roadmap-event-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div class="flex items-center gap-2">
                  <input id="roadmap-event-admin-only" type="checkbox" class="w-4 h-4 text-orange-600 bg-gray-100 border-gray-300 rounded focus:ring-orange-500">
                  <label for="roadmap-event-admin-only" class="text-sm font-medium text-gray-700">
                    <i class="fas fa-lock mr-1 text-orange-600"></i>운영진 전용 일정 (일반 회원에게는 보이지 않음)
                  </label>
                </div>
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-event-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>추가
                </button>
                <button id="roadmap-event-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          </div>
        `;

        // 기존 모달 제거
        const existingModal = document.getElementById(
          "roadmap-event-add-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("roadmap-event-add-save")
          .addEventListener("click", async () => {
            const name = document
              .getElementById("roadmap-event-name")
              .value.trim();
            const date = document.getElementById("roadmap-event-date").value;
            const isAdminOnly = document.getElementById(
              "roadmap-event-admin-only"
            ).checked;

            if (!name) {
              showAlert("😥", "일정 제목을 입력해주세요.");
              return;
            }

            if (!date) {
              showAlert("😥", "날짜를 선택해주세요.");
              return;
            }

            try {
              const ord = roadmapData?.length || 0;
              await addDoc(collection(db, "roadmap"), {
                activityName: name,
                activityDate: date,
                order: ord,
                isAdminOnly: isAdminOnly,
              });
              showAlert("✅", "로드맵 일정이 추가되었습니다.");
              document.getElementById("roadmap-event-add-modal").remove();
              renderRoadmap();
            } catch (error) {
              console.error("일정 추가 오류:", error);
              showAlert("😥", "일정 추가에 실패했습니다.");
            }
          });

        document
          .getElementById("roadmap-event-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-event-add-modal").remove();
          });
      }

      // 로드맵 일정 수정 모달
      window.openRoadmapEventEditModal = function (eventId, eventIndex) {
        const event = roadmapData.find((e) => e.id === eventId);
        if (!event) return;

        const modalHTML = `
          <div id="roadmap-event-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">로드맵 일정 수정</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">일정 제목</label>
                  <input id="roadmap-event-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${saf(
                    event.activityName
                  )}" placeholder="일정 제목">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                  <input id="roadmap-event-edit-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${
                    event.activityDate
                  }">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                  <textarea id="roadmap-event-edit-description" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="일정 설명을 입력하세요&#10;줄바꿈이 가능합니다">${saf(
                    event.description || ""
                  )}</textarea>
                  <p class="text-xs text-gray-500 mt-1">💡 Enter 키로 줄바꿈이 가능합니다</p>
                </div>
                <div>
                  <label class="flex items-center gap-2">
                    <input id="roadmap-event-edit-admin-only" type="checkbox" class="w-4 h-4 text-orange-600 bg-white border border-gray-300 rounded focus:ring-orange-500 focus:ring-2" ${
                      event.isAdminOnly ? "checked" : ""
                    }>
                    <span class="text-sm font-medium text-gray-700">관리자만 보이도록 설정</span>
                  </label>
                  <p class="text-xs text-gray-500 mt-1">체크하면 일반 회원에게는 보이지 않습니다</p>
                </div>
                <input id="roadmap-event-edit-id" type="hidden" value="${eventId}">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-event-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>수정
                </button>
                <button id="roadmap-event-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          </div>
        `;

        // 기존 모달 제거
        const existingModal = document.getElementById(
          "roadmap-event-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("roadmap-event-edit-save")
          .addEventListener("click", async () => {
            const eventId = document.getElementById(
              "roadmap-event-edit-id"
            ).value;
            const name = document
              .getElementById("roadmap-event-edit-name")
              .value.trim();
            const date = document.getElementById(
              "roadmap-event-edit-date"
            ).value;
            const description = document.getElementById(
              "roadmap-event-edit-description"
            ).value;
            const isAdminOnly = document.getElementById(
              "roadmap-event-edit-admin-only"
            ).checked;

            if (!name) {
              showAlert("😥", "일정 제목을 입력해주세요.");
              return;
            }

            if (!date) {
              showAlert("😥", "날짜를 선택해주세요.");
              return;
            }

            try {
              console.log("로드맵 수정 시도:", {
                eventId,
                name,
                date,
                description,
              });
              console.log("현재 roadmapData:", roadmapData);
              console.log(
                "찾으려는 이벤트:",
                roadmapData.find((e) => e.id === eventId)
              );

              // 문서 존재 여부 확인
              const docRef = doc(db, "roadmap", eventId);
              const docSnap = await getDoc(docRef);

              console.log("문서 존재 여부:", docSnap.exists());
              console.log(
                "문서 데이터:",
                docSnap.exists() ? docSnap.data() : "문서 없음"
              );

              if (!docSnap.exists()) {
                showAlert("😥", "수정하려는 일정을 찾을 수 없습니다.");
                return;
              }

              await updateDoc(docRef, {
                activityName: name,
                activityDate: date,
                description: description,
                isAdminOnly: isAdminOnly,
              });
              showAlert("✅", "로드맵 일정이 수정되었습니다.");
              document.getElementById("roadmap-event-edit-modal").remove();
              // 수정 후 로드맵 새로고침 (onSnapshot으로 자동 업데이트됨)
            } catch (error) {
              console.error("일정 수정 오류:", error);
              if (error.code === "not-found") {
                showAlert("😥", "수정하려는 일정을 찾을 수 없습니다.");
              } else {
                showAlert("😥", "일정 수정에 실패했습니다.");
              }
            }
          });

        document
          .getElementById("roadmap-event-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-event-edit-modal").remove();
          });
      };

      /* ===================== 참가자 더보기 토글 ===================== */
      window.toggleParticipantsList = function (event, uniqueId, hiddenCount) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        const hiddenDiv = document.getElementById(`${uniqueId}-hidden`);
        if (!hiddenDiv) {
          console.error("숨겨진 참가자 목록을 찾을 수 없습니다:", uniqueId);
          return;
        }

        // event.target 또는 event.currentTarget 사용
        let button = event ? event.currentTarget || event.target : null;

        // 버튼이 클릭된 요소가 아니라면 가장 가까운 button 찾기
        if (button && button.tagName !== "BUTTON") {
          button = button.closest("button");
        }

        if (!button) {
          console.error("버튼을 찾을 수 없습니다");
          return;
        }

        const icon = button.querySelector("i");
        const text = button.querySelector("span");

        if (!icon || !text) {
          // 폴백: innerHTML로 직접 변경 (정상 작동)
          const isHidden = hiddenDiv.classList.contains("hidden");
          if (isHidden) {
            hiddenDiv.classList.remove("hidden");
            button.innerHTML = `<i class="fas fa-chevron-up"></i><span>접기</span>`;
          } else {
            hiddenDiv.classList.add("hidden");
            button.innerHTML = `<i class="fas fa-chevron-down"></i><span>외 ${hiddenCount}명 더보기</span>`;
          }
          return;
        }

        const isHidden = hiddenDiv.classList.contains("hidden");

        if (isHidden) {
          // 펼치기
          hiddenDiv.classList.remove("hidden");
          icon.className = "fas fa-chevron-up";
          text.textContent = "접기";
        } else {
          // 접기
          hiddenDiv.classList.add("hidden");
          icon.className = "fas fa-chevron-down";
          text.textContent = `외 ${hiddenCount}명 더보기`;
        }
      };

      /* ===================== 신청 탭 ===================== */
      function computeEventStats(ev) {
        const getAll = () => {
          if (ev.type === "tasting") {
            const arr = [];
            (ev.restaurants || []).forEach((r) => {
              arr.push(...(r.reservations || []), ...(r.waiting || []));
            });
            return arr;
          }
          return [...(ev.applicants || []), ...(ev.waiting || [])];
        };
        const all = getAll();
        const stats = all.map((p) => ({
          gender: p.gender || "미상",
          college: p.college || "미상",
        }));
        const total = stats.length;
        const genderCount = { 남: 0, 여: 0, 기타: 0, 미상: 0 };
        stats.forEach((s) => {
          if (genderCount[s.gender] == null) genderCount["미상"]++;
          else genderCount[s.gender]++;
        });
        const genderPct = Object.fromEntries(
          Object.entries(genderCount).map(([k, v]) => [
            k,
            total ? Math.round((v / total) * 1000) / 10 : 0,
          ])
        );
        const collegeMap = new Map();
        stats.forEach((s) => {
          const key = s.college || "미상";
          collegeMap.set(key, (collegeMap.get(key) || 0) + 1);
        });
        const colleges = [...collegeMap.entries()]
          .map(([name, cnt]) => ({
            name,
            cnt,
            pct: total ? Math.round((cnt / total) * 1000) / 10 : 0,
          }))
          .sort((a, b) => b.cnt - a.cnt);
        return { total, genderPct, genderCount, colleges };
      }
      function adminStatsHTML(ev) {
        if (!isFullAdmin()) return "";
        const st = computeEventStats(ev);
        const gLine =
          st.total > 0
            ? `남 ${st.genderCount.남}명 · 여 ${st.genderCount.여}명${
                st.genderCount.기타 ? ` · 기타 ${st.genderCount.기타}명` : ""
              }`
            : "자료 없음";
        const colleges =
          st.colleges
            .slice(0, 5)
            .map((c) => `${saf(c.name)} ${c.cnt}명`)
            .join(" · ") || "자료 없음";
        return `<div class="mt-3 text-xs bg-gray-50 border rounded p-2">
                 <div class="font-semibold text-gray-700">관리자용 신청자 통계 <span class="text-[11px] text-gray-500">(신청+대기 포함)</span></div>
                 <div class="mt-1 text-gray-700">성별: ${gLine}</div>
                 <div class="mt-1 text-gray-700">단과대 상위: ${colleges}</div>
               </div>`;
      }
      const adminInline = (ev) => {
        if (!isFullAdmin()) return "";
        return `<div class="mt-3 flex gap-2 flex-wrap">
                  <button type="button" class="text-blue-600 hover:text-blue-800 text-sm" data-act="admin-edit" data-id="${ev.id}"><i class="fas fa-pen"></i> 수정</button>
                  <button type="button" class="text-red-600 hover:text-red-800 text-sm font-semibold" data-act="admin-close" data-id="${ev.id}"><i class="fas fa-door-closed"></i> 신청 마감</button>
                  <button type="button" class="text-purple-600 hover:text-purple-800 text-sm" data-act="group-maker" data-id="${ev.id}"><i class="fas fa-users"></i> 조짜기</button>
                  <button type="button" class="text-orange-700 hover:text-orange-900 text-sm" data-act="export-xlsx" data-id="${ev.id}"><i class="fas fa-file-excel"></i> 명단 다운로드</button>
                  <button type="button" class="text-red-600 hover:text-red-800 text-sm" data-act="admin-delete" data-id="${ev.id}"><i class="fas fa-trash"></i> 삭제</button>
                </div>
                <div class="absolute top-2 right-2 flex gap-1">
                  <button type="button" class="move-event-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                          data-act="move-event-up" data-id="${ev.id}" title="위로 이동">
                    <i class="fas fa-arrow-up"></i>
                  </button>
                  <button type="button" class="move-event-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                          data-act="move-event-down" data-id="${ev.id}" title="아래로 이동">
                    <i class="fas fa-arrow-down"></i>
                  </button>
                </div>`;
      };
      function paymentInfoHTML(ev) {
        if (!(ev.type === "mt" || ev.type === "assembly")) return "";
        const p = ev.payment || {};
        if (!p.bank && !p.number && !p.holder && !p.amount && !p.note)
          return "";

        // 신청 시작 시간 체크
        const now = new Date();
        const registrationStartTime = ev.registrationStart
          ? new Date(ev.registrationStart)
          : null;
        const isBeforeRegistrationStart =
          registrationStartTime && now < registrationStartTime;

        // 신청 시작 전이면 입금 정보를 숨김
        if (isBeforeRegistrationStart) {
          return `<div class="mt-2 text-sm bg-gray-100 border border-gray-300 rounded p-3">
                    <div class="font-semibold text-gray-600 mb-2 flex items-center gap-2">
                      <i class="fas fa-lock"></i>
                      💸 회비 입금 정보
                    </div>
                    <div class="text-gray-500 text-sm">신청 시작 후 입금 정보가 공개됩니다</div>
                  </div>`;
        }

        const line = [p.bank, p.number].filter(Boolean).map(saf).join(" ");
        const accountInfo = line || "";
        const amount = p.amount ? formatKRW(p.amount) : "";
        return `<div class="mt-2 text-sm bg-orange-50 border border-orange-200 rounded p-3">
                  <div class="font-semibold text-orange-800 mb-2">💸 회비 입금 정보</div>
                  ${
                    amount
                      ? `<div class="text-orange-700 mb-2 font-bold text-lg">회비: ${amount}</div>`
                      : ""
                  }
                  <div class="text-orange-700 mb-2 select-all cursor-pointer hover:bg-orange-100 p-2 rounded transition-colors" 
                       onclick="copyToClipboard('${accountInfo.replace(
                         /'/g,
                         "\\'"
                       )}')" 
                       title="클릭하여 계좌번호 복사">${accountInfo}${
          p.holder ? ` (예금주 ${saf(p.holder)})` : ""
        }</div>
                  ${
                    p.note
                      ? `<div class="text-orange-700 mb-2">${saf(p.note)}</div>`
                      : ""
                  }
                  ${
                    accountInfo
                      ? `<button 
                          onclick="copyToClipboard('${accountInfo.replace(
                            /'/g,
                            "\\'"
                          )}')" 
                          class="w-full bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2"
                          title="계좌번호 복사">
                          <i class="fas fa-copy"></i>
                          계좌 복사하기
                        </button>`
                      : ""
                  }
                </div>`;
      }

      // 신청 취소 안내 문구 (공통)
      const getCancelNotice = () => `
        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-start gap-2">
            <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
            <div class="text-xs text-blue-800">
              <p class="font-semibold mb-1">📌 취소 안내</p>
              <p>• 신청 취소를 원하시면 <strong>마감 시간 전</strong>에 신청 취소 버튼을 눌러주세요.</p>
              <p class="mt-1">• 마감 이후 취소를 원하시면 <strong>운영진에게 문의</strong>해주세요.</p>
            </div>
          </div>
        </div>
      `;

      function generalCardHTML(ev) {
        const count = (ev.applicants || []).length,
          lim = ev.limit || 0;
        const my = isUserIn(ev.applicants)
          ? "apply"
          : isUserIn(ev.waiting)
          ? "wait"
          : "none";

        // 디버깅: 사용자 상태 확인
        console.log(`Event ${ev.id}: currentUser =`, currentUser);
        console.log(
          `Event ${ev.id}: my = ${my}, count = ${count}, lim = ${lim}`
        );

        // 로그인된 사용자에게만 버튼 표시
        let btn;

        // 신청 시작 시간 체크
        const now = new Date();
        const registrationStartTime = ev.registrationStart
          ? new Date(ev.registrationStart)
          : null;
        const isBeforeRegistrationStart =
          registrationStartTime && now < registrationStartTime;

        if (currentUser) {
          if (my === "apply") {
            btn = `<button type="button" class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer" data-act="cancel-general" data-id="${ev.id}">신청 취소</button>`;
          } else if (my === "wait") {
            btn = `<button type="button" class="w-full mt-3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer" data-act="cancel-wait-general" data-id="${ev.id}">대기 취소</button>`;
          } else if (isBeforeRegistrationStart) {
            // 신청 시작 전 - 카운트다운 표시
            const timeLeft = registrationStartTime - now;
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor(
              (timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
            );
            const minutes = Math.floor(
              (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            btn = `<button type="button" class="w-full mt-3 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed flex items-center justify-center gap-2" disabled data-countdown="${
              ev.id
            }" data-start="${ev.registrationStart}">
              <i class="fas fa-hourglass-half"></i>
              <span id="countdown-${ev.id}">${
              days > 0 ? `${days}일 ` : ""
            }${hours}시간 ${minutes}분 ${seconds}초 후 오픈</span>
            </button>`;
          } else {
            btn = `<button type="button" class="w-full mt-3 ${
              count < lim
                ? "bg-orange-600 hover:bg-orange-700"
                : "bg-red-600 hover:bg-red-700"
            } text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer flex items-center justify-center gap-2" data-act="reserve-general" data-id="${
              ev.id
            }">
              ${
                count < lim
                  ? '<i class="fas fa-check"></i><span>신청하기</span>'
                  : '<i class="fas fa-clock"></i><span>신청 마감 / 대기하기</span>'
              }
            </button>`;
          }
        } else {
          btn = `<div class="w-full mt-3 bg-gray-100 text-gray-500 font-bold py-2 rounded text-center">로그인 후 신청 가능</div>`;
        }

        // 학번 마스킹 함수
        const maskStudentId = (studentId) => {
          if (!studentId) return "";
          if (studentId.length <= 4) return studentId;
          return studentId.substring(0, 4) + "*".repeat(studentId.length - 4);
        };

        // 참가자 목록 생성 (4명 이상일 때 더보기 버튼) - 최신 신청자부터 표시
        const applicantsList = (ev.applicants || []).slice().reverse();
        const waitingListArr = (ev.waiting || []).slice().reverse();

        const createParticipantsList = (list, bgColor, textColor) => {
          const items = list.map(
            (a) =>
              `<span class="${bgColor} ${textColor} px-2 py-1 rounded-full text-xs flex items-center gap-1">
              <span class="text-xs">${saf(a.name)}</span>
              <span class="${textColor} font-mono text-xs">(${maskStudentId(
                a.studentId
              )})</span>
              ${
                isFullAdmin()
                  ? `<button class="ml-1 text-red-600 hover:text-red-800 transition-colors" onclick="confirmRemoveParticipant('${ev.id}', '${a.studentId}', 'applicants')" title="참가자 제외"><i class="fas fa-times"></i></button>`
                  : ""
              }
            </span>`
          );

          if (items.length <= 4) {
            return items.join("");
          } else {
            const visibleItems = items.slice(0, 4).join("");
            const hiddenItems = items.slice(4).join("");
            const uniqueId = `participants-${ev.id}`;
            return `
              ${visibleItems}
              <div id="${uniqueId}-hidden" class="hidden flex flex-wrap gap-1">
                ${hiddenItems}
              </div>
              <button 
                class="mt-2 w-full text-sm text-orange-600 hover:text-orange-700 font-semibold py-2 px-3 bg-orange-50 hover:bg-orange-100 rounded-lg transition-all flex items-center justify-center gap-2 border border-orange-200"
                data-toggle-id="${uniqueId}"
                onclick="toggleParticipantsList(event, '${uniqueId}', ${
              items.length - 4
            })">
                <i class="fas fa-chevron-down"></i>
                <span>외 ${items.length - 4}명 더보기</span>
              </button>
            `;
          }
        };

        const namesList = createParticipantsList(
          applicantsList,
          "bg-orange-100",
          "text-orange-800"
        );

        // 대기자용 별도 함수 (다른 ID 사용)
        const createWaitingList = (list, bgColor, textColor) => {
          const items = list.map(
            (a) =>
              `<span class="${bgColor} ${textColor} px-2 py-1 rounded-full text-xs flex items-center gap-1">
              <span class="text-xs">${saf(a.name)}</span>
              <span class="${textColor} font-mono text-xs">(${maskStudentId(
                a.studentId
              )})</span>
              ${
                isFullAdmin()
                  ? `<button class="ml-1 text-red-600 hover:text-red-800 transition-colors" onclick="confirmRemoveParticipant('${ev.id}', '${a.studentId}', 'waiting')" title="대기자 제외"><i class="fas fa-times"></i></button>`
                  : ""
              }
            </span>`
          );

          if (items.length <= 4) {
            return items.join("");
          } else {
            const visibleItems = items.slice(0, 4).join("");
            const hiddenItems = items.slice(4).join("");
            const uniqueId = `waiting-${ev.id}`;
            return `
              ${visibleItems}
              <div id="${uniqueId}-hidden" class="hidden flex flex-wrap gap-1">
                ${hiddenItems}
              </div>
              <button 
                class="mt-2 w-full text-sm text-orange-600 hover:text-orange-700 font-semibold py-2 px-3 bg-orange-50 hover:bg-orange-100 rounded-lg transition-all flex items-center justify-center gap-2 border border-orange-200"
                data-toggle-id="${uniqueId}"
                onclick="toggleParticipantsList(event, '${uniqueId}', ${
              items.length - 4
            })">
                <i class="fas fa-chevron-down"></i>
                <span>외 ${items.length - 4}명 더보기</span>
              </button>
            `;
          }
        };

        const waitingList = createWaitingList(
          waitingListArr,
          "bg-orange-200",
          "text-orange-900"
        );
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        return `<div class="section card-hover ${typeAccentClass(
          ev.type
        )}" data-event-id="${
          ev.id
        }" style="position: relative; z-index: 1; margin-bottom: 1rem; padding: 1rem; height: auto; overflow: visible; clear: both;">
                  <h3 class="text-lg font-bold text-gray-800 mb-2">${saf(
                    ev.title
                  )}</h3>
                  <div class="mt-2 space-y-2">
                    <div class="bg-orange-100 border-2 border-orange-400 text-orange-900 px-3 py-2 rounded-lg flex items-center gap-2">
                      <i class="fas fa-calendar-check text-orange-600 text-base"></i>
                      <span class="text-sm font-bold">이벤트 실시일: ${
                        ev.datetime
                          ? new Date(ev.datetime).toLocaleString("ko-KR", {
                              month: "long",
                              day: "numeric",
                              hour: "2-digit",
                              minute: "2-digit",
                            })
                          : "-"
                      }</span>
                    </div>
                    <div class="bg-red-100 border-2 border-red-400 text-red-900 px-3 py-2 rounded-lg flex items-center gap-2">
                      <i class="fas fa-clock text-red-600 text-base"></i>
                      <span class="text-sm font-bold">신청 마감일: ${
                        ev.deadline
                          ? new Date(ev.deadline).toLocaleString("ko-KR", {
                              month: "long",
                              day: "numeric",
                              hour: "2-digit",
                              minute: "2-digit",
                            })
                          : "미설정"
                      }</span>
                    </div>
                  </div>
                  ${paymentInfoHTML(ev)}
                  ${
                    isFullAdmin()
                      ? `
                  <div class="mt-3">
                    <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-orange-500 h-4 rounded-full" style="width:${
                      lim ? Math.min(100, Math.round((count / lim) * 100)) : 0
                    }%"></div></div>
                    <p class="text-right text-sm mt-1 text-gray-600">신청: ${count} / ${lim} 명</p>
                  </div>
                  `
                      : ""
                  }
                  ${adminStatsHTML(ev)}
                  ${btn}
                  ${getCancelNotice()}
                  ${
                    currentUser
                      ? `
                  <div class="mt-3">
                    ${
                      (ev.applicants || []).length > 0
                        ? `<div class="mt-2 text-xs text-gray-600">
                            <div class="flex items-center justify-between mb-1">
                              <span class="font-medium text-xs">참가자 (${
                                (ev.applicants || []).length
                              }명)</span>
                              ${
                                isFullAdmin()
                                  ? `<button 
                                      type="button"
                                      class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors"
                                      onclick="toggleParticipantsPublicVisibility('${
                                        ev.id
                                      }', 'applicants')"
                                      id="toggle-participants-public-${ev.id}"
                                    >
                                      <i class="fas ${
                                        ev.participantsVisibleToAll
                                          ? "fa-user-lock"
                                          : "fa-users"
                                      } mr-1"></i>${
                                      ev.participantsVisibleToAll
                                        ? "회장단만"
                                        : "모두 보이기"
                                    }
                                    </button>`
                                  : ""
                              }
                            </div>
                            ${
                              ev.participantsVisibleToAll || isFullAdmin()
                                ? `<div class="flex flex-wrap gap-1">
                                    ${namesList}
                                  </div>`
                                : ""
                            }
                          </div>`
                        : ""
                    }
                    ${
                      (ev.waiting || []).length > 0
                        ? `<div class="mt-2 text-xs text-gray-600">
                            <div class="flex items-center justify-between mb-1">
                              <span class="font-medium text-xs">대기자 (${
                                (ev.waiting || []).length
                              }명)</span>
                              ${
                                isFullAdmin()
                                  ? `<button 
                                      type="button"
                                      class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors"
                                      onclick="toggleParticipantsPublicVisibility('${
                                        ev.id
                                      }', 'waiting')"
                                      id="toggle-waiting-public-${ev.id}"
                                    >
                                      <i class="fas ${
                                        ev.waitingVisibleToAll
                                          ? "fa-user-lock"
                                          : "fa-users"
                                      } mr-1"></i>${
                                      ev.waitingVisibleToAll
                                        ? "회장단만"
                                        : "모두 보이기"
                                    }
                                    </button>`
                                  : ""
                              }
                            </div>
                            ${
                              ev.waitingVisibleToAll || isFullAdmin()
                                ? `<div class="flex flex-wrap gap-1">
                                    ${waitingList}
                                  </div>`
                                : ""
                            }
                          </div>`
                        : ""
                    }
                  </div>
                  `
                      : ""
                  }
                  <div class="text-[11px] text-gray-400 mt-2">상태: ${statusLabel(
                    ev.status || "open"
                  )}</div>
                  <div class="flex gap-2 mt-2 text-sm text-gray-600">
                    <span class="px-2 py-0.5 rounded ${typeBadgeClass(
                      ev.type
                    )}">${typeLabel(ev.type)}</span>
                    ${
                      ev.status === "archived" && isAdmin
                        ? '<span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-800 text-xs font-medium"><i class="fas fa-eye-slash mr-1"></i>보관 (회장단만 표시)</span>'
                        : ""
                    }
                  </div>
                  ${adminFullTableHTML(ev)}
                  ${adminInline(ev)}
                </div>`;
      }
      function tastingCardHTML(ev) {
        const list = (ev.restaurants || [])
          .map((r) => {
            const cap = r.capacity ?? ev.limit ?? 0;
            const cnt = (r.reservations || []).length;
            const mine = (r.reservations || [])
              .concat(r.waiting || [])
              .some((p) => p.studentId === currentUser?.studentId);
            const isInReservations = (r.reservations || []).some(
              (p) => p.studentId === currentUser?.studentId
            );
            const isInWaiting = (r.waiting || []).some(
              (p) => p.studentId === currentUser?.studentId
            );

            // 신청 시작 시간 체크
            const now = new Date();
            const registrationStartTime = ev.registrationStart
              ? new Date(ev.registrationStart)
              : null;
            const isBeforeRegistrationStart =
              registrationStartTime && now < registrationStartTime;

            let btn;
            if (currentUser) {
              if (isInReservations) {
                btn = `<button type="button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="cancel-tasting" data-id="${ev.id}" data-rid="${r.id}">
                  <i class="fas fa-times"></i>
                  <span>신청 취소</span>
                </button>`;
              } else if (isInWaiting) {
                btn = `<button type="button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="cancel-wait-tasting" data-id="${ev.id}" data-rid="${r.id}">
                  <i class="fas fa-hourglass-half"></i>
                  <span>대기 취소</span>
                </button>`;
              } else if (isBeforeRegistrationStart) {
                // 신청 시작 전 - 카운트다운 표시
                const timeLeft = registrationStartTime - now;
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor(
                  (timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
                );
                const minutes = Math.floor(
                  (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
                );
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                btn = `<button type="button" class="w-full bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed flex items-center justify-center gap-2" disabled data-countdown="${
                  ev.id
                }-${r.id}" data-start="${ev.registrationStart}">
                  <i class="fas fa-hourglass-half"></i>
                  <span id="countdown-${ev.id}-${r.id}">${
                  days > 0 ? `${days}일 ` : ""
                }${hours}시간 ${minutes}분 ${seconds}초 후 오픈</span>
                </button>`;
              } else {
                btn = `<button type="button" class="w-full ${
                  cnt < cap
                    ? "bg-orange-600 hover:bg-orange-700 shadow-orange-200"
                    : "bg-red-600 hover:bg-red-700 shadow-red-200"
                } text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="reserve-tasting" data-id="${
                  ev.id
                }" data-rid="${r.id}">
                  <i class="fas ${cnt < cap ? "fa-check" : "fa-clock"}"></i>
                  <span>${
                    cnt < cap ? "신청하기" : "신청 마감 / 대기하기"
                  }</span>
                </button>`;
              }
            } else {
              btn = `<div class="w-full bg-gray-100 text-gray-500 font-bold py-2 px-4 rounded-lg text-center flex items-center justify-center gap-2">
                <i class="fas fa-lock"></i>
                <span>로그인 필요</span>
              </div>`;
            }
            // 학번 마스킹 함수
            const maskStudentId = (studentId) => {
              if (!studentId) return "";
              if (studentId.length <= 4) return studentId;
              return (
                studentId.substring(0, 4) + "*".repeat(studentId.length - 4)
              );
            };

            // 참가자 목록 생성 (4명 이상일 때 더보기 버튼) - 최신 신청자부터 표시
            const createRestaurantParticipantsList = (
              list,
              bgColor,
              textColor,
              restaurantId,
              type
            ) => {
              const items = list
                .slice()
                .reverse()
                .map(
                  (a) =>
                    `<span class="${bgColor} ${textColor} px-2 py-1 rounded-full text-xs flex items-center gap-1">
                    <span class="text-xs">${saf(a.name)}</span>
                    <span class="${textColor} font-mono text-xs">(${maskStudentId(
                      a.studentId
                    )})</span>
                    ${
                      isFullAdmin()
                        ? `<button class="ml-1 text-red-600 hover:text-red-800 transition-colors" onclick="confirmRemoveParticipant('${ev.id}', '${a.studentId}', '${type}', '${restaurantId}')" title="참가자 제외"><i class="fas fa-times"></i></button>`
                        : ""
                    }
                  </span>`
                );

              if (items.length === 0) return "";

              if (items.length <= 4) {
                return items.join("");
              } else {
                const visibleItems = items.slice(0, 4).join("");
                const hiddenItems = items.slice(4).join("");
                const uniqueId = `restaurant-${restaurantId}-${type}`;
                return `
                  ${visibleItems}
                  <div id="${uniqueId}-hidden" class="hidden flex flex-wrap gap-1">
                    ${hiddenItems}
                  </div>
                  <button 
                    class="mt-2 w-full text-sm text-orange-600 hover:text-orange-700 font-semibold py-2 px-3 bg-orange-50 hover:bg-orange-100 rounded-lg transition-all flex items-center justify-center gap-2 border border-orange-200"
                    data-toggle-id="${uniqueId}"
                    onclick="toggleParticipantsList(event, '${uniqueId}', ${
                  items.length - 4
                })">
                    <i class="fas fa-chevron-down"></i>
                    <span>외 ${items.length - 4}명 더보기</span>
                  </button>
                `;
              }
            };

            const namesList =
              (r.reservations || []).length > 0
                ? `<div class="mt-2 text-xs text-gray-600">
                    <div class="flex items-center justify-between mb-1">
                      <span class="font-medium text-xs">참가자 (${
                        (r.reservations || []).length
                      }명)</span>
                      ${
                        isFullAdmin()
                          ? `<button 
                              type="button"
                              class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors"
                              onclick="toggleRestaurantParticipantsPublicVisibility('${
                                ev.id
                              }', '${r.id}', 'reservations')"
                              id="toggle-restaurant-participants-public-${
                                ev.id
                              }-${r.id}"
                            >
                              <i class="fas ${
                                ev.participantsVisibleToAll
                                  ? "fa-user-lock"
                                  : "fa-users"
                              } mr-1"></i>${
                              ev.participantsVisibleToAll
                                ? "회장단만"
                                : "모두 보이기"
                            }
                            </button>`
                          : ""
                      }
                    </div>
                    ${
                      ev.participantsVisibleToAll || isFullAdmin()
                        ? `<div class="flex flex-wrap gap-1">
                            ${createRestaurantParticipantsList(
                              r.reservations || [],
                              "bg-orange-100",
                              "text-orange-800",
                              r.id,
                              "reservations"
                            )}
                          </div>`
                        : ""
                    }
                  </div>`
                : "";
            const waitingList =
              (r.waiting || []).length > 0
                ? `<div class="mt-2 text-xs text-gray-600">
                    <div class="flex items-center justify-between mb-1">
                      <span class="font-medium text-xs">대기자 (${
                        (r.waiting || []).length
                      }명)</span>
                      ${
                        isFullAdmin()
                          ? `<button 
                              type="button"
                              class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors"
                              onclick="toggleRestaurantParticipantsPublicVisibility('${
                                ev.id
                              }', '${r.id}', 'waiting')"
                              id="toggle-restaurant-waiting-public-${ev.id}-${
                              r.id
                            }"
                            >
                              <i class="fas ${
                                ev.waitingVisibleToAll
                                  ? "fa-user-lock"
                                  : "fa-users"
                              } mr-1"></i>${
                              ev.waitingVisibleToAll
                                ? "회장단만"
                                : "모두 보이기"
                            }
                            </button>`
                          : ""
                      }
                    </div>
                    ${
                      ev.waitingVisibleToAll || isFullAdmin()
                        ? `<div class="flex flex-wrap gap-1">
                            ${createRestaurantParticipantsList(
                              r.waiting || [],
                              "bg-orange-200",
                              "text-orange-900",
                              r.id,
                              "waiting"
                            )}
                          </div>`
                        : ""
                    }
                  </div>`
                : "";
            return `<div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-start gap-4 mb-3">
                    ${
                      r.imageUrl
                        ? `<div class="flex-shrink-0">
                              <img src="${saf(r.imageUrl)}" alt="${saf(
                            r.name
                          )}" class="w-16 h-16 object-cover rounded-lg" onerror="this.style.display='none'">
                            </div>`
                        : ""
                    }
                      
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-2">
                          <h4 class="font-bold text-base text-gray-800">${saf(
                            r.name
                          )}</h4>
                          ${
                            currentUser &&
                            adminList.includes(currentUser.studentId)
                              ? `
                          <span class="text-xs text-gray-600 bg-white px-2 py-1 rounded-full">
                            ${cnt}/${cap}명
                          </span>
                          `
                              : ""
                          }
                        </div>
                        <p class="text-xs text-gray-600">${saf(
                          r.info || ""
                        )}</p>
                    </div>
                    </div>
                    
                    ${
                      currentUser
                        ? `
                    ${namesList}
                    ${waitingList}
                    `
                        : ""
                    }
                    
                    ${
                      currentUser && adminList.includes(currentUser.studentId)
                        ? `
                    <div class="mb-3">
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full transition-all duration-300" style="width:${
                          cap ? Math.min(100, Math.round((cnt / cap) * 100)) : 0
                        }%"></div>
                      </div>
                    </div>
                    `
                        : ""
                    }
                    
                    <div class="w-full">
                    ${btn}
                    ${getCancelNotice()}
                    </div>
                  </div>`;
          })
          .join("");
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        return `<div class="section card-hover ${typeAccentClass(
          ev.type
        )}" data-event-id="${
          ev.id
        }" style="position: relative; z-index: 1; margin-bottom: 1rem; padding: 1rem; height: auto; overflow: visible; clear: both;">
                  <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <div class="p-3 border-b border-gray-100">
                      <div class="flex justify-between items-center mb-2">
                  <h3 class="text-lg font-bold text-gray-800">${saf(
                    ev.title
                  )}</h3>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${typeBadgeClass(
                          ev.type
                        )} min-h-[28px] flex items-center justify-center">
                          ${typeLabel(ev.type)}
                        </span>
                      </div>
                      <div class="space-y-2">
                        <div class="bg-orange-100 border-2 border-orange-400 text-orange-900 px-3 py-2 rounded-lg flex items-center gap-2">
                          <i class="fas fa-calendar-check text-orange-600 text-base"></i>
                          <span class="text-sm font-bold">이벤트 실시일: ${
                            ev.datetime
                              ? new Date(ev.datetime).toLocaleString("ko-KR", {
                                  month: "long",
                                  day: "numeric",
                                  hour: "2-digit",
                                  minute: "2-digit",
                                })
                              : "-"
                          }</span>
                        </div>
                        <div class="bg-red-100 border-2 border-red-400 text-red-900 px-3 py-2 rounded-lg flex items-center gap-2">
                          <i class="fas fa-clock text-red-600 text-base"></i>
                          <span class="text-sm font-bold">신청 마감일: ${
                            ev.deadline
                              ? new Date(ev.deadline).toLocaleString("ko-KR", {
                                  month: "long",
                                  day: "numeric",
                                  hour: "2-digit",
                                  minute: "2-digit",
                                })
                              : "미설정"
                          }</span>
                        </div>
                      </div>
                  ${adminStatsHTML(ev)}
                    </div>
                    
                    <div class="p-4">
                      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${list}</div>
                      
                      <div class="mt-4 pt-3 border-t border-gray-100">
                        <div class="flex justify-between items-center">
                          <div class="flex items-center gap-2">
                          <div class="text-xs text-gray-500">
                            상태: ${statusLabel(ev.status || "open")}
                            </div>
                            ${
                              ev.status === "archived" && isFullAdmin()
                                ? '<span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-800 text-xs font-medium"><i class="fas fa-eye-slash mr-1"></i>보관 (회장단만 표시)</span>'
                                : ""
                            }
                  </div>
                  ${adminInline(ev)}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>`;
      }
      function eventCardHTML(ev) {
        return ev.type === "tasting"
          ? tastingCardHTML(ev)
          : generalCardHTML(ev);
      }

      function adminFullTableHTML(ev) {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin || !(ev.type === "mt" || ev.type === "assembly"))
          return "";
        const header = `<thead class="text-gray-700 table-sticky"><tr>
            <th class="px-2 py-1 text-left">이름</th><th class="px-2 py-1 text-left">학번</th><th class="px-2 py-1 text-left">성별</th>
            <th class="px-2 py-1 text-left">학년</th><th class="px-2 py-1 text-left">단과대</th><th class="px-2 py-1 text-left">학과</th><th class="px-2 py-1 text-left">전화번호</th>
          </tr></thead>`;
        const rows = (ev.applicants || [])
          .slice()
          .sort((a, b) => (a.name || "").localeCompare(b.name || "")) // 가나다순 정렬
          .map(
            (m, index) => `<tr class="border-t">
            <td class="px-2 py-1 max-w-0 truncate" title="${saf(
              m.name || ""
            )}">${saf(m.name || "")}</td>
            <td class="px-2 py-1 font-mono">${saf(m.studentId || "")}</td>
            <td class="px-2 py-1">${saf(m.gender || "")}</td>
            <td class="px-2 py-1">${saf(m.year || "")}</td>
            <td class="px-2 py-1">${saf(m.college || "")}</td>
            <td class="px-2 py-1">${saf(m.department || "")}</td>
            <td class="px-2 py-1">${saf(m.phone || "")}</td>
          </tr>`
          )
          .join("");
        const body =
          rows ||
          `<tr><td class="px-2 py-6 text-center text-gray-400" colspan="7">신청자 없음</td></tr>`;
        const toolbar = `<div class="flex items-center justify-between mb-2">
            <div class="text-xs font-semibold text-gray-700">관리자 전용 • 참가자 상세</div>
            <button type="button" class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded" data-act="export-xlsx" data-id="${ev.id}">
              <i class="fas fa-file-excel mr-1"></i>명단 다운로드
            </button>
          </div>`;
        return `<div class="mt-4 border-t pt-3">${toolbar}<div class="overflow-auto max-h-60 border rounded">
            <table class="min-w-full text-xs">${header}<tbody>${body}</tbody></table></div></div>`;
      }

      function renderReservationTab(isAdmin) {
        const c = document.getElementById("reservation-tab");
        if (!c) return;

        // 활성 이벤트와 보관 이벤트를 분리
        const activeEvents = eventsData.filter((e) => {
          if (e.status === "closed") return false;
          if (e.status === "archived") return false;
          if (e.status === "completed") return false;
          if (e.status === "deleted") return false; // 삭제된 이벤트 제외
          return true;
        });

        const archivedEvents = isAdmin
          ? eventsData.filter((e) => e.status === "archived")
          : [];

        // 내 활동 내역 (참가한 과거 이벤트)
        const myPastEvents = currentUser
          ? eventsData.filter((ev) => {
              // 삭제된 이벤트는 제외
              if (ev.status === "deleted") return false;

              // 신청자 목록에서 현재 사용자 확인
              const isApplicant = ev.applicants?.some(
                (a) => a.studentId === currentUser.studentId
              );

              // 미식회의 경우 각 식당별 예약자 확인
              let isRestaurantApplicant = false;
              if (ev.type === "tasting" && ev.restaurants) {
                isRestaurantApplicant = ev.restaurants.some((r) =>
                  r.reservations?.some(
                    (res) => res.studentId === currentUser.studentId
                  )
                );
              }

              const isParticipant = isApplicant || isRestaurantApplicant;

              // 마감된 이벤트, 보관된 이벤트, 완료된 이벤트, 또는 이미 지난 이벤트
              const isClosed =
                ev.status === "closed" ||
                ev.status === "archived" ||
                ev.status === "completed";
              const eventDate = new Date(ev.datetime);
              const today = new Date();
              const isPastEvent = eventDate < today;

              return isParticipant && (isClosed || isPastEvent);
            })
          : [];

        const activeListHTML =
          activeEvents.length === 0
            ? `<div class="text-center py-12"><i class="fas fa-calendar-xmark text-4xl text-gray-300"></i><p class="mt-3 text-gray-500">진행 중인 이벤트/미식회가 없습니다.</p></div>`
            : `<div id="events-container" class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6" style="position: relative; z-index: 1; min-height: 200px;">
                ${activeEvents
                  .sort((a, b) => (a.order || 999) - (b.order || 999))
                  .map(eventCardHTML)
                  .join("")}
               </div>`;

        // 내 활동 내역 HTML
        const myHistoryHTML =
          myPastEvents.length > 0
            ? `
          <div class="section mt-6">
            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl overflow-hidden">
              <button 
                type="button" 
                id="my-history-toggle"
                class="w-full px-6 py-4 flex items-center justify-between hover:bg-blue-100 transition-colors"
              >
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center">
                    <i class="fas fa-history text-blue-700"></i>
                  </div>
                  <div class="text-left">
                    <h4 class="text-lg font-bold text-blue-900">내 활동 내역</h4>
                    <p class="text-sm text-blue-700">참가한 ${
                      myPastEvents.length
                    }개의 이벤트</p>
                  </div>
                </div>
                <i class="fas fa-chevron-down text-blue-700 text-xl transition-transform" id="my-history-toggle-icon"></i>
              </button>
              <div id="my-history-content" class="hidden px-6 pb-6">
                <div class="bg-white rounded-lg p-4 border-2 border-blue-200">
                  <div class="space-y-3">
                    ${myPastEvents
                      .sort(
                        (a, b) => new Date(b.datetime) - new Date(a.datetime)
                      )
                      .map((ev) => {
                        const typeIcon =
                          ev.type === "tasting"
                            ? "🍽️"
                            : ev.type === "mt"
                            ? "🏕️"
                            : ev.type === "assembly"
                            ? "🎤"
                            : "📅";

                        const hasReview = (ev.reviews || []).find(
                          (r) => r.studentId === (currentUser?.studentId || "")
                        );

                        // 미식회인 경우 참여한 식당 이름 찾기
                        let restaurantName = "";
                        if (
                          ev.type === "tasting" &&
                          ev.restaurants &&
                          currentUser
                        ) {
                          const myRestaurant = ev.restaurants.find((r) =>
                            r.reservations?.some(
                              (res) => res.studentId === currentUser.studentId
                            )
                          );
                          if (myRestaurant) {
                            restaurantName = myRestaurant.name;
                          }
                        }

                        return `
                          <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center gap-3">
                              <span class="text-2xl">${typeIcon}</span>
                              <div class="flex-1 min-w-0">
                                <h5 class="font-semibold text-gray-800 truncate">${saf(
                                  ev.title
                                )}${
                          restaurantName
                            ? ` <span class="text-orange-600 text-sm">(${saf(
                                restaurantName
                              )})</span>`
                            : ""
                        }</h5>
                                <p class="text-xs text-gray-500">
                                  ${new Date(ev.datetime).toLocaleDateString(
                                    "ko-KR"
                                  )} ${new Date(ev.datetime).toLocaleTimeString(
                          "ko-KR",
                          { hour: "2-digit", minute: "2-digit" }
                        )}
                                </p>
                              </div>
                            </div>
                            <div class="mt-3 flex items-center gap-2">
                              <button type="button" class="px-3 py-2 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg" onclick="showEventDetailModal('${
                                ev.id
                              }')">
                                <i class="fas fa-info-circle mr-1"></i>상세
                              </button>
                              <button type="button" class="px-3 py-2 text-xs bg-orange-600 hover:bg-orange-700 text-white rounded-lg" data-act="write-review" data-id="${
                                ev.id
                              }">
                                <i class="fas ${
                                  hasReview ? "fa-edit" : "fa-pen-to-square"
                                } mr-1"></i>${
                          hasReview ? "후기 수정" : "후기 작성"
                        }
                              </button>
                            </div>
                          </div>
                        `;
                      })
                      .join("")}
                  </div>
                </div>
              </div>
            </div>
          </div>`
            : "";

        // 보관된 이벤트 목록 (회장단만)
        const archivedListHTML = isAdmin
          ? `
          <div class="section mt-6">
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl overflow-hidden">
              <button 
                type="button" 
                id="archived-events-toggle"
                class="w-full px-6 py-4 flex items-center justify-between hover:bg-yellow-100 transition-colors"
              >
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-yellow-200 rounded-full flex items-center justify-center">
                    <i class="fas fa-archive text-yellow-700"></i>
                  </div>
                  <div class="text-left">
                    <h4 class="text-lg font-bold text-yellow-900">보관된 이벤트</h4>
                    <p class="text-sm text-yellow-700">회장단만 볼 수 있는 숨김 처리된 ${
                      archivedEvents.length
                    }개의 이벤트</p>
                  </div>
                </div>
                <i class="fas fa-chevron-down text-yellow-700 text-xl transition-transform" id="archived-toggle-icon"></i>
              </button>
              <div id="archived-events-content" class="hidden px-6 pb-6">
                ${
                  archivedEvents.length > 0
                    ? `<div class="bg-white rounded-lg p-4 border-2 border-yellow-200">
                      <div class="space-y-3">
                        ${archivedEvents
                          .sort((a, b) => (a.order || 999) - (b.order || 999))
                          .map((ev) => {
                            const typeIcon =
                              ev.type === "tasting"
                                ? "🍽️"
                                : ev.type === "mt"
                                ? "🏕️"
                                : ev.type === "assembly"
                                ? "🎤"
                                : "📅";

                            return `
                              <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors border border-gray-200">
                                <!-- 제목과 날짜 -->
                                <div class="flex items-center gap-3 mb-3">
                                  <span class="text-2xl">${typeIcon}</span>
                                  <div class="flex-1 min-w-0">
                                    <h5 class="font-semibold text-gray-800">${saf(
                                      ev.title
                                    )}</h5>
                                    <p class="text-xs text-gray-500">
                                      ${new Date(
                                        ev.datetime
                                      ).toLocaleDateString("ko-KR")} ${new Date(
                              ev.datetime
                            ).toLocaleTimeString("ko-KR", {
                              hour: "2-digit",
                              minute: "2-digit",
                            })}
                                    </p>
                                  </div>
                                </div>
                                
                                <!-- 참가자 수 -->
                                <div class="flex items-center justify-between text-sm text-gray-600 mb-3">
                                  <span>참가자: ${
                                    ev.applicants?.length || 0
                                  }명</span>
                                  <button 
                                    type="button" 
                                    class="text-blue-600 hover:text-blue-800 font-medium"
                                    data-act="admin-unarchive" 
                                    data-id="${ev.id}"
                                  >
                                    <i class="fas fa-rotate-left mr-1"></i>재게시
                                  </button>
                                </div>
                              </div>
                            `;
                          })
                          .join("")}
                      </div>
                    </div>`
                    : `<div class="text-center py-8 text-gray-500">
                      <i class="fas fa-inbox text-3xl mb-2"></i>
                      <p>보관된 이벤트가 없습니다.</p>
                    </div>`
                }
              </div>
            </div>
          </div>`
          : "";

        // 관리자인 경우: 점선 블록 + 이벤트 목록 + 보관 목록, 일반 회원: 이벤트 목록 + 내 활동 내역
        c.innerHTML = isAdmin
          ? `
            <div class="section mb-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- 미식회 만들기 점선 블록 -->
                <div class="border-2 border-dashed border-orange-300 rounded-xl p-4 sm:p-6 text-center hover:border-orange-400 hover:bg-orange-50 transition-all cursor-pointer group" id="create-tasting-block">
                  <div class="flex flex-col items-center justify-center space-y-3">
                    <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                      <i class="fas fa-utensils text-2xl text-orange-500"></i>
                    </div>
                    <div>
                      <h3 class="text-lg font-bold text-gray-800 group-hover:text-orange-600">미식회 만들기</h3>
                      <p class="text-sm text-gray-500 group-hover:text-orange-500">새로운 미식회를 만들어보세요</p>
                    </div>
                  </div>
                </div>
                
                <!-- 이벤트 만들기 점선 블록 -->
                <div class="border-2 border-dashed border-blue-300 rounded-xl p-4 sm:p-6 text-center hover:border-blue-400 hover:bg-blue-50 transition-all cursor-pointer group" id="create-event-block">
                  <div class="flex flex-col items-center justify-center space-y-3">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                      <i class="fas fa-calendar-plus text-2xl text-blue-500"></i>
                    </div>
                    <div>
                      <h3 class="text-lg font-bold text-gray-800 group-hover:text-blue-600">이벤트 만들기</h3>
                      <p class="text-sm text-gray-500 group-hover:text-blue-500">새로운 이벤트를 만들어보세요</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            ${myHistoryHTML}
            <div class="section">
              <div class="flex items-center gap-2 mb-4">
                <i class="fas fa-list text-gray-600 text-xl"></i>
                <h4 class="text-xl font-bold text-gray-800">생성된 이벤트 목록</h4>
              </div>
              ${activeListHTML}
            </div>
            ${archivedListHTML}
          `
          : `${myHistoryHTML}
            <div class="section">
              ${activeListHTML}
            </div>`;

        // 기존 이벤트 리스너 제거 (중복 방지)
        c.removeEventListener("click", handleReservationTabClick);

        // 새로운 이벤트 리스너 등록
        c.addEventListener("click", handleReservationTabClick);

        // 보관된 이벤트 토글 기능
        if (isAdmin) {
          const toggleButton = document.getElementById(
            "archived-events-toggle"
          );
          const toggleIcon = document.getElementById("archived-toggle-icon");
          const content = document.getElementById("archived-events-content");

          if (toggleButton && content && toggleIcon) {
            toggleButton.addEventListener("click", () => {
              const isHidden = content.classList.contains("hidden");

              if (isHidden) {
                content.classList.remove("hidden");
                toggleIcon.style.transform = "rotate(180deg)";
              } else {
                content.classList.add("hidden");
                toggleIcon.style.transform = "rotate(0deg)";
              }
            });
          }
        }

        // 내 활동 내역 토글 기능
        if (myPastEvents.length > 0) {
          const myHistoryToggleButton =
            document.getElementById("my-history-toggle");
          const myHistoryToggleIcon = document.getElementById(
            "my-history-toggle-icon"
          );
          const myHistoryContent =
            document.getElementById("my-history-content");

          if (
            myHistoryToggleButton &&
            myHistoryContent &&
            myHistoryToggleIcon
          ) {
            myHistoryToggleButton.addEventListener("click", () => {
              const isHidden = myHistoryContent.classList.contains("hidden");

              if (isHidden) {
                myHistoryContent.classList.remove("hidden");
                myHistoryToggleIcon.style.transform = "rotate(180deg)";
              } else {
                myHistoryContent.classList.add("hidden");
                myHistoryToggleIcon.style.transform = "rotate(0deg)";
              }
            });
          }
        }

        // 카운트다운 타이머 시작
        startCountdownTimers();

        // 미식회/이벤트 생성 점선 블록 이벤트 리스너는 전역 이벤트 리스너에서 처리됨

        // bindAdminEventsPanel은 모달 내부에서만 호출됨
      }

      // 카운트다운 타이머 업데이트 함수
      let countdownIntervals = [];

      function startCountdownTimers() {
        // 기존 타이머 모두 제거
        countdownIntervals.forEach((interval) => clearInterval(interval));
        countdownIntervals = [];

        // 모든 카운트다운 버튼 찾기
        const countdownButtons = document.querySelectorAll("[data-countdown]");

        countdownButtons.forEach((button) => {
          const eventId = button.dataset.countdown;
          const startTime = new Date(button.dataset.start);
          const countdownElement = document.getElementById(
            `countdown-${eventId}`
          );

          if (!countdownElement) return;

          const interval = setInterval(() => {
            const now = new Date();
            const timeLeft = startTime - now;

            if (timeLeft <= 0) {
              // 시간이 지나면 페이지 리로드하여 버튼 활성화
              clearInterval(interval);
              window.location.reload();
            } else {
              // 카운트다운 업데이트
              const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
              const hours = Math.floor(
                (timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
              );
              const minutes = Math.floor(
                (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
              );
              const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

              countdownElement.textContent = `${
                days > 0 ? `${days}일 ` : ""
              }${hours}시간 ${minutes}분 ${seconds}초 후 오픈`;
            }
          }, 1000);

          countdownIntervals.push(interval);
        });
      }

      // 이벤트 리스너 함수를 별도로 분리
      async function handleReservationTabClick(e) {
        const b = e.target.closest("button[data-act]");
        if (!b) return;
        const act = b.dataset.act,
          id = b.dataset.id,
          rid = b.dataset.rid;
        if (act === "reserve-general") return reserveGeneral(id);
        if (act === "cancel-general") return cancelGeneral(id);
        if (act === "cancel-wait-general") return cancelWaitGeneral(id);
        if (act === "reserve-tasting") return reserveTasting(id, rid);
        if (act === "cancel-tasting") return cancelTasting(id, rid);
        if (act === "cancel-wait-tasting") return cancelWaitTasting(id, rid);
        if (act === "admin-edit") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 수정할 수 있습니다.");
            return;
          }
          // 이벤트 타입에 따라 올바른 모달 열기
          const event = eventsData.find((e) => e.id === id);
          if (event && event.type === "tasting") {
            return openTastingModal("edit", id);
          } else {
            return openEventModal("edit", id);
          }
        }
        if (act === "admin-close") return closeEvent(id);
        if (act === "admin-reopen") return reopenEvent(id);
        if (act === "admin-archive") return archiveEvent(id);
        if (act === "admin-unarchive") return unarchiveEvent(id);
        if (act === "admin-complete") return completeEvent(id);
        if (act === "admin-unpost") return unpostEvent(id);
        if (act === "group-maker") {
          console.log("🎯 조짜기 버튼 클릭됨:", id);
          return openGroupMakerModal(id);
        }
        if (act === "admin-delete") return deleteEvent(id);
        if (act === "export-xlsx") return exportApplicantsXLSX(id);
      }

      /* ===== 기존 이벤트 관리자 패널 (새로운 모달 구조로 대체됨) ===== */
      // 이 함수는 더 이상 사용되지 않습니다. 새로운 모달 구조를 사용하세요.
      function adminEventsPanelHTML_DEPRECATED(defaultType = null) {
        return `<div class="section">
          <!-- 현재 이벤트 목록 (맨 위로 이동) -->
          <div class="mb-8 pb-6 border-b-2 border-gray-200">
            <div class="flex items-center gap-2 mb-4">
              <i class="fas fa-list text-gray-600 text-xl"></i>
              <h4 class="text-xl font-bold text-gray-800">생성된 이벤트 목록</h4>
            </div>
            <p class="text-sm text-gray-600 mb-4">
              <i class="fas fa-info-circle text-blue-500 mr-1"></i>
              만들어진 이벤트를 수정하거나 삭제할 수 있어요
            </p>
            <div class="space-y-3">${adminEventsListHTML()}</div>
          </div>

          <!-- 헤더 -->
          <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-4 mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
              <i class="fas fa-calendar-plus text-orange-600"></i>
              새 이벤트 만들기
            </h3>
            <p class="text-sm text-gray-600">
              <i class="fas fa-info-circle text-orange-500 mr-1"></i>
              순서대로 입력하시면 쉽게 이벤트를 만들 수 있어요!
            </p>
          </div>

          <!-- Step 1: 이벤트 유형 -->
          <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
            <div class="flex items-center gap-2 mb-3">
              <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">1</span>
              <h4 class="text-lg font-bold text-gray-800">어떤 종류의 이벤트인가요?</h4>
            </div>
            <select id="event-type" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-white text-gray-900 hover:border-orange-400 focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base font-medium">
              <option value="tasting">🍽️ 미식회 (여러 식당 중 선택)</option>
              <option value="general">📌 일반 이벤트 (단일 활동)</option>
              <option value="mt">🏕️ MT (회비 입금 필요)</option>
              <option value="assembly">👥 총회 (회비 입금 필요)</option>
            </select>
            <p class="text-xs text-gray-500 mt-2 pl-10">💡 미식회는 여러 식당을 추가할 수 있어요</p>
          </div>

          <!-- Step 2: 기본 정보 -->
          <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
            <div class="flex items-center gap-2 mb-4">
              <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">2</span>
              <h4 class="text-lg font-bold text-gray-800">이벤트 기본 정보</h4>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-heading text-orange-500"></i>
                  이벤트 제목 <span class="text-red-500">*</span>
                </label>
                <input id="event-title" type="text" placeholder="예: 푸디 가을 미식회, 가을 MT" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-calendar-alt text-orange-500"></i>
                  이벤트 실시일 (언제 진행하나요?) <span class="text-red-500">*</span>
                </label>
                <input id="event-datetime" type="datetime-local" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                <p class="text-xs text-gray-500 mt-1 pl-6">📅 이벤트가 실제로 진행되는 날짜와 시간</p>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-play text-orange-500"></i>
                  신청 시작일 (언제부터 신청받나요?)
                </label>
                <input id="event-registration-start" type="datetime-local" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base">
                <p class="text-xs text-gray-500 mt-1 pl-6">🚀 이 시간부터 신청이 시작됩니다 (비워두면 즉시 신청 가능)</p>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-clock text-orange-500"></i>
                  신청 마감일 (언제까지 신청받나요?) <span class="text-red-500">*</span>
                </label>
                <input id="event-deadline" type="datetime-local" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                <p class="text-xs text-gray-500 mt-1 pl-6">⏰ 이 시간 이후로는 신청할 수 없어요</p>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-users text-orange-500"></i>
                  최대 몇 명까지 참가할 수 있나요? <span class="text-red-500">*</span>
                </label>
                <input id="event-limit" type="number" min="1" placeholder="예: 30" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                <p class="text-xs text-gray-500 mt-1 pl-6">👥 정원을 초과하면 대기 신청으로 넘어갑니다</p>
              </div>
            </div>
          </div>

          <!-- Step 3: 공개 설정 및 알림 -->
          <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
            <div class="flex items-center gap-2 mb-4">
              <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">3</span>
              <h4 class="text-lg font-bold text-gray-800">공개 설정 및 알림</h4>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-eye text-orange-500"></i>
                  회원들에게 보여줄까요?
                </label>
                <div class="flex bg-gray-100 rounded-lg p-1.5 w-fit gap-1">
                  <button type="button" id="status-open" class="px-4 py-2 text-sm font-bold rounded-lg transition-all bg-white text-orange-600 shadow-sm flex items-center gap-2">
                    <i class="fas fa-globe"></i>공개
                  </button>
                  <button type="button" id="status-hidden" class="px-4 py-2 text-sm font-bold rounded-lg transition-all text-gray-600 hover:text-gray-800 hover:bg-white/50 flex items-center gap-2">
                    <i class="fas fa-eye-slash"></i>숨김
                  </button>
                </div>
                <input type="hidden" id="event-status" value="open">
                <p class="text-xs text-gray-500 mt-2 pl-6">🔒 "숨김"으로 설정하면 관리자만 볼 수 있어요</p>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-bell text-orange-500"></i>
                  자동 알림 설정
                </label>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                  <div class="flex items-start gap-2">
                    <input type="checkbox" id="enable-auto-post" class="mt-1 w-4 h-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500" checked>
                    <label for="enable-auto-post" class="text-sm font-medium text-gray-700 flex-1">
                      자동으로 알림 글 올리기
                      <p class="text-xs text-gray-500 font-normal mt-1">이벤트 하루 전에 회원들에게 알림을 보내요</p>
                    </label>
                  </div>
                </div>
                <div id="post-time-container" class="space-y-3 pl-6">
                  <div class="flex items-center gap-3">
                    <input type="radio" id="post-time-auto" name="post-time-type" value="auto" class="w-4 h-4 text-orange-600 focus:ring-orange-500" checked>
                    <label for="post-time-auto" class="text-sm text-gray-700 flex items-center gap-2">
                      <i class="fas fa-clock text-gray-400"></i>
                      <span>이벤트 24시간 전 자동</span>
                      <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-semibold">추천</span>
                    </label>
                  </div>
                  <div class="flex items-center gap-3">
                    <input type="radio" id="post-time-custom" name="post-time-type" value="custom" class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                    <label for="post-time-custom" class="text-sm text-gray-700 flex items-center gap-2">
                      <i class="fas fa-calendar-check text-gray-400"></i>
                      <span>직접 지정하기</span>
                    </label>
                  </div>
                  <div class="pl-8">
                    <input id="post-datetime" type="datetime-local" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-200" disabled>
                  </div>
                </div>
                <button type="button" id="test-announcement-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium">
                  <i class="fas fa-flask"></i>
                  테스트 알림 미리보기
                </button>
              </div>
            </div>
          </div>

          <!-- Step 4: 회비 입금 정보 (MT/총회만) -->
          <div id="payment-fields" class="hidden">
            <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
              <div class="flex items-center gap-2 mb-4">
                <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">4</span>
                <h4 class="text-lg font-bold text-gray-800">💰 회비 입금 정보</h4>
              </div>
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <p class="text-xs text-yellow-800 flex items-center gap-2">
                  <i class="fas fa-lightbulb"></i>
                  시스템 설정의 계좌 정보가 자동으로 불러와집니다. 필요시 수정하세요.
                </p>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-landmark text-orange-500"></i>
                    은행명
                  </label>
                  <input id="pay-bank" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="예: 국민은행, 신한은행">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-credit-card text-orange-500"></i>
                    계좌번호
                  </label>
                  <input id="pay-number" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="000-000-000000">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-user text-orange-500"></i>
                    예금주
                  </label>
                  <input id="pay-holder" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="홍길동">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-comment-dots text-orange-500"></i>
                    입금 안내 (선택사항)
                  </label>
                  <input id="pay-note" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="예: 입금 시 이름 꼭 적어주세요">
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4/5: 식당 관리 (미식회만) -->
          <div id="tasting-fields">
            <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
              <div class="flex items-center gap-2 mb-4">
                <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">4</span>
                <h4 class="text-lg font-bold text-gray-800">🍽️ 식당 추가하기</h4>
              </div>
              <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                <p class="text-xs text-green-800 flex items-center gap-2">
                  <i class="fas fa-check-circle"></i>
                  미식회는 최소 1개 이상의 식당을 추가해야 해요!
                </p>
              </div>
              <div id="event-restaurants-wrap" class="space-y-3 mb-4">${createRestaurantFieldHTML()}</div>
              <button id="add-restaurant-btn" type="button" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-plus-circle text-lg"></i>
                <span>식당 추가하기</span>
              </button>
            </div>
          </div>

          <!-- 저장 버튼 -->
          <div class="flex gap-3 mt-6">
            <button id="save-event-btn" type="button" class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-4 px-6 rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-3 text-lg">
              <i class="fas fa-check-circle text-xl"></i>
              <span>이벤트 만들기 완료!</span>
            </button>
            <button id="reset-event-btn" type="button" class="flex-none bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-4 px-6 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
              <i class="fas fa-redo"></i>
              <span>다시 작성</span>
            </button>
          </div>
        </div>`;
      }
      // 기존 bindAdminEventsPanel 함수는 새로운 모달 구조로 대체됨
      function bindAdminEventsPanel_DEPRECATED() {
        const wrap = document.getElementById("event-restaurants-wrap");
        const eventType = document.getElementById("event-type");
        const addRestaurantBtn = document.getElementById("add-restaurant-btn");
        const saveEventBtn = document.getElementById("save-event-btn");
        const resetEventBtn = document.getElementById("reset-event-btn");

        // null 체크
        if (
          !wrap ||
          !eventType ||
          !addRestaurantBtn ||
          !saveEventBtn ||
          !resetEventBtn
        ) {
          console.warn("bindAdminEventsPanel: 일부 요소를 찾을 수 없습니다.");
          return;
        }

        // 기존 onTypeChange는 새로운 모달 구조에서 사용되지 않음
        // eventType.addEventListener("change", (e) => onTypeChange(e.target.value));
        addRestaurantBtn.addEventListener("click", () => addRestaurantField());

        // 기존 식당 필드들에 이벤트 바인딩
        const existingRows = wrap.querySelectorAll(".restaurant-row");
        existingRows.forEach((row) => bindRestaurantFieldEvents(row));

        // 식당 삭제 버튼 이벤트
        wrap.addEventListener("click", (e) => {
          const row = e.target.closest(".restaurant-row");
          if (!row) return;
          if (e.target.closest(".remove-restaurant")) row.remove();
        });
        // 기존 createOrSaveEvent는 새로운 모달 구조에서 사용되지 않음
        // saveEventBtn.addEventListener("click", () => createOrSaveEvent());
        resetEventBtn.addEventListener("click", () => resetEventForm());

        // 테스트 알림 게시 버튼
        const testAnnouncementBtn = document.getElementById(
          "test-announcement-btn"
        );
        if (testAnnouncementBtn) {
          testAnnouncementBtn.addEventListener("click", async () => {
            const testContent = `🧪 테스트 알림 🧪

📅 일시: ${new Date().toLocaleString("ko-KR")}
📝 제목: 테스트 이벤트

이것은 테스트용 알림입니다.
기능이 정상적으로 작동하는지 확인해보세요! 😊

#Foodie #테스트`;

            try {
              await postAnnouncement(testContent);
            } catch (error) {
              console.error("테스트 알림 게시 오류:", error);
            }
          });
        }

        // 게시일시 설정 이벤트 리스너
        const enableAutoPost = document.getElementById("enable-auto-post");
        const postTimeAuto = document.getElementById("post-time-auto");
        const postTimeCustom = document.getElementById("post-time-custom");
        const postDatetime = document.getElementById("post-datetime");
        const postTimeContainer = document.getElementById(
          "post-time-container"
        );

        if (
          enableAutoPost &&
          postTimeAuto &&
          postTimeCustom &&
          postDatetime &&
          postTimeContainer
        ) {
          // 자동 알림 게시 사용/해제
          enableAutoPost.addEventListener("change", (e) => {
            postTimeContainer.style.opacity = e.target.checked ? "1" : "0.5";
            postTimeContainer.style.pointerEvents = e.target.checked
              ? "auto"
              : "none";
          });

          // 게시 시간 타입 변경
          postTimeAuto.addEventListener("change", () => {
            if (postTimeAuto.checked) {
              postDatetime.disabled = true;
            }
          });

          postTimeCustom.addEventListener("change", () => {
            if (postTimeCustom.checked) {
              postDatetime.disabled = false;
              // 이벤트 시간을 기본값으로 설정
              const eventDatetime =
                document.getElementById("event-datetime").value;
              if (eventDatetime) {
                const eventTime = new Date(eventDatetime);
                const postTime = new Date(
                  eventTime.getTime() - 24 * 60 * 60 * 1000
                );
                postDatetime.value = postTime.toISOString().slice(0, 16);
              }
            }
          });

          // 이벤트 시간 변경 시 자동 게시 시간 업데이트
          const eventDatetime = document.getElementById("event-datetime");
          if (eventDatetime) {
            eventDatetime.addEventListener("change", () => {
              if (postTimeAuto.checked) {
                // 자동 모드에서는 변경하지 않음
              } else if (postTimeCustom.checked && !postDatetime.value) {
                // 커스텀 모드에서 게시 시간이 비어있으면 기본값 설정
                const eventTime = new Date(eventDatetime.value);
                const postTime = new Date(
                  eventTime.getTime() - 24 * 60 * 60 * 1000
                );
                postDatetime.value = postTime.toISOString().slice(0, 16);
              }
            });
          }
        }

        // 공개/숨김 토글 버튼 이벤트
        const statusOpenBtn = document.getElementById("status-open");
        const statusHiddenBtn = document.getElementById("status-hidden");
        const statusInput = document.getElementById("event-status");

        if (statusOpenBtn && statusHiddenBtn && statusInput) {
          const updateStatusButtons = (status) => {
            if (status === "open") {
              statusOpenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white text-orange-600 shadow-sm";
              statusHiddenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800";
            } else {
              statusOpenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800";
              statusHiddenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white text-orange-600 shadow-sm";
            }
            statusInput.value = status;
          };

          statusOpenBtn.addEventListener("click", () =>
            updateStatusButtons("open")
          );
          statusHiddenBtn.addEventListener("click", () =>
            updateStatusButtons("archived")
          );

          // 초기 상태 설정
          updateStatusButtons(statusInput.value);
        }

        // 기존 onTypeChange는 새로운 모달 구조에서 사용되지 않음
        // onTypeChange(eventType.value);
      }
      // 기존 restaurantFieldHTML 함수는 새로운 createRestaurantFieldHTML로 대체됨
      function restaurantFieldHTML_DEPRECATED(
        n = "",
        i = "",
        c = "",
        url = "",
        id = "",
        category = "기타"
      ) {
        const rid = id || `res_${Math.random().toString(36).slice(2, 9)}`;
        return `<div class="restaurant-row bg-gradient-to-br from-white to-orange-50 border-2 border-orange-300 rounded-xl p-5 relative" data-id="${rid}">
          <!-- 삭제 버튼 (우측 상단) -->
          <button type="button" class="remove-restaurant absolute top-3 right-3 bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full transition-all shadow-md hover:shadow-lg flex items-center justify-center" title="이 식당 삭제">
            <i class="fas fa-trash text-sm"></i>
          </button>

          <div class="space-y-4">
            <!-- 카테고리 선택 (동적 생성) -->
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-tags text-orange-500"></i>
                음식 종류 <span class="text-red-500">*</span>
              </label>
              <select data-field="category" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base bg-white" required>
                ${restaurantCategories
                  .map(
                    (cat) => `
                  <option value="${cat.name}" ${
                      category === cat.name ? "selected" : ""
                    }>${cat.emoji} ${cat.name}</option>
                `
                  )
                  .join("")}
              </select>
              <p class="text-xs text-gray-500 mt-1 pl-6">🏷️ 식당의 음식 종류를 선택해주세요</p>
            </div>

            
            <!-- 입력 필드들 -->
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-utensils text-orange-500"></i>
                  식당 이름 <span class="text-red-500">*</span>
                </label>
                <input data-field="name" type="text" value="${saf(
                  n
                )}" placeholder="예: 스시 맛집, 파스타 레스토랑" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
              </div>
              
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-users text-orange-500"></i>
                  이 식당의 정원 <span class="text-red-500">*</span>
                </label>
                <input data-field="capacity" type="number" min="1" value="${saf(
                  c
                )}" placeholder="예: 10" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                <p class="text-xs text-gray-500 mt-1 pl-6">👥 이 식당에 몇 명까지 갈 수 있나요?</p>
              </div>
              
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-utensils text-orange-500"></i>
                  대표 메뉴 <span class="text-red-500">*</span>
                </label>
                <textarea data-field="info" rows="3" placeholder="이 식당의 대표 메뉴를 알려주세요&#10;예: 토마토 파스타, 크림 리조또, 마르게리타 피자" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base resize-none" required>${saf(
                  i
                )}</textarea>
                <p class="text-xs text-gray-500 mt-1 pl-6">🍽️ 이 식당에서 꼭 먹어봐야 할 메뉴를 적어주세요</p>
              </div>
            </div>
          </div>
        </div>`;
      }
      // 기존 onTypeChange 함수는 새로운 모달 구조에서 bindEventForm으로 대체됨
      function onTypeChange_DEPRECATED(type) {
        const tastingFields = document.getElementById("tasting-fields");
        const paymentFields = document.getElementById("payment-fields");

        if (!tastingFields || !paymentFields) {
          console.warn("onTypeChange: 필수 DOM 요소를 찾을 수 없습니다.");
          return;
        }

        tastingFields.classList.toggle("hidden", type !== "tasting");
        paymentFields.classList.toggle(
          "hidden",
          !(type === "mt" || type === "assembly")
        );

        if (type === "mt" || type === "assembly") {
          const d = duesSettings || {};
          const payBank = document.getElementById("pay-bank");
          const payNumber = document.getElementById("pay-number");
          const payHolder = document.getElementById("pay-holder");
          const payNote = document.getElementById("pay-note");

          if (payBank && !payBank.value) payBank.value = d.bank || "";
          if (payNumber && !payNumber.value) payNumber.value = d.number || "";
          if (payHolder && !payHolder.value) payHolder.value = d.holder || "";
          if (payNote && !payNote.value) {
            payNote.value =
              (d.amount ? `회비 ${formatKRW(d.amount)} ` : "") + (d.note || "");
          }
        }
      }
      function adminEventsListHTML() {
        if (eventsData.length === 0) return `<p class="text-gray-500">없음</p>`;
        return eventsData
          .map((ev) => {
            const when = ev.datetime
              ? new Date(ev.datetime).toLocaleString("ko-KR")
              : "-";
            const badge = typeBadgeClass(ev.type);
            return `<div class="flex items-center justify-between bg-white p-3 rounded border">
            <div class="min-w-0">
              <span class="text-sm px-2 py-0.5 rounded ${badge}">${typeLabel(
              ev.type
            )}</span>
              <span class="font-semibold ml-2">${saf(
                ev.title || "(제목 없음)"
              )}</span>
              <span class="text-sm text-gray-500 ml-2">(${when})</span>
              <span class="text-xs ml-2 px-2 py-0.5 rounded ${
                ev.status === "open"
                  ? "bg-green-100 text-green-700"
                  : ev.autoClosedAt
                  ? "bg-orange-100 text-orange-700"
                  : "bg-gray-200 text-gray-700"
              }" ${
              ev.autoClosedAt
                ? `title="자동 마감됨: ${new Date(
                    ev.autoClosedAt
                  ).toLocaleString("ko-KR")}"`
                : ""
            }>${
              ev.autoClosedAt ? "자동 마감" : statusLabel(ev.status || "open")
            }</span>
            </div>
            <div class="flex gap-2">
              <button type="button" class="text-blue-600 hover:text-blue-800" data-act="admin-edit" data-id="${
                ev.id
              }" title="수정"><i class="fas fa-pen"></i></button>
              ${
                ev.status === "closed"
                  ? `<button type="button" class="text-green-600 hover:text-green-800 font-semibold" data-act="admin-reopen" data-id="${ev.id}" title="다시 열기"><i class="fas fa-door-open"></i></button>`
                  : `<button type="button" class="text-red-600 hover:text-red-800" data-act="admin-close" data-id="${ev.id}" title="신청 마감"><i class="fas fa-door-closed"></i></button>`
              }
              <button type="button" class="text-amber-600 hover:text-amber-800" data-act="admin-archive" data-id="${
                ev.id
              }" title="보관(숨김)"><i class="fas fa-box-archive"></i></button>
              <button type="button" class="text-indigo-600 hover:text-indigo-800" data-act="admin-unpost" data-id="${
                ev.id
              }" title="글 내리기"><i class="fas fa-arrow-down"></i></button>
              <button type="button" class="text-purple-600 hover:text-purple-800" data-act="group-maker" data-id="${
                ev.id
              }" title="조짜기"><i class="fas fa-users"></i></button>
              <button type="button" class="text-red-600 hover:text-red-800" data-act="admin-delete" data-id="${
                ev.id
              }" title="삭제"><i class="fas fa-trash"></i></button>
            </div>
          </div>`;
          })
          .join("");
      }
      const addRestaurantField = () => {
        const wrap = document.getElementById("event-restaurants-wrap");
        if (!wrap) return;

        wrap.insertAdjacentHTML("beforeend", createRestaurantFieldHTML());

        // 새로 추가된 필드에 이벤트 바인딩
        bindRestaurantFieldEvents(wrap.lastElementChild);
      };

      // 식당 필드에 이벤트 바인딩하는 함수 (이미지 업로드 기능 제거됨)
      function bindRestaurantFieldEvents(row) {
        if (!row) {
          console.error("bindRestaurantFieldEvents: row가 없습니다");
          return;
        }
        console.log("식당 필드 이벤트 바인딩 완료 (이미지 업로드 제거됨)");
      }

      /* ===== 이미지 업로드 ===== */
      async function uploadRestaurantImage(row, file) {
        console.log("이미지 업로드 시작:", file);

        if (IS_FILE) {
          showAlert(
            "ℹ️",
            "로컬 파일로 여신 경우 업로드가 제한될 수 있어요. GitHub Pages/서버에서 테스트해 주세요."
          );
          return;
        }

        if (!currentUser) {
          console.error("현재 사용자 없음");
          return showAlert("😥", "로그인이 필요합니다.");
        }

        if (!file || !file.type.startsWith("image/")) {
          console.error("이미지 파일이 아님:", file?.type);
          return showAlert("ℹ️", "이미지 파일만 업로드 가능합니다.");
        }

        const overlay = row.querySelector("[data-role='uploading']");
        const imageUrlField = row.querySelector("[data-field='imageUrl']");
        const previewImg = row.querySelector("[data-role='preview']");
        const dropzone = row.querySelector("[data-role='dropzone']");

        if (!overlay || !imageUrlField || !previewImg || !dropzone) {
          console.error("필요한 DOM 요소를 찾을 수 없음:", {
            overlay: !!overlay,
            imageUrlField: !!imageUrlField,
            previewImg: !!previewImg,
            dropzone: !!dropzone,
          });
          return showAlert("😥", "이미지 업로드 요소를 찾을 수 없습니다.");
        }

        overlay.classList.remove("hidden");

        try {
          const ext = (file.name.split(".").pop() || "png").toLowerCase();
          const path = `event-images/${
            currentUser.studentId
          }/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;

          console.log("업로드 경로:", path);

          const ref = sRef(storage, path);
          const task = uploadBytesResumable(ref, file);

          await new Promise((resolve, reject) => {
            task.on(
              "state_changed",
              (snapshot) => {
                const progress =
                  (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log(`업로드 진행률: ${progress.toFixed(2)}%`);
              },
              (error) => {
                console.error("업로드 오류:", error);
                reject(error);
              },
              () => {
                console.log("업로드 완료");
                resolve();
              }
            );
          });

          const url = await getDownloadURL(task.snapshot.ref);
          console.log("다운로드 URL:", url);

          // DOM 요소 업데이트
          imageUrlField.value = url;
          previewImg.src = url;
          previewImg.classList.remove("hidden");
          dropzone.classList.add("hidden");

          showAlert("✅", "이미지 업로드 완료!");
        } catch (err) {
          console.error("이미지 업로드 실패:", err);
          let errorMessage = "이미지 업로드 실패. ";

          if (err.code === "storage/unauthorized") {
            errorMessage += "권한이 없습니다.";
          } else if (err.code === "storage/network-request-failed") {
            errorMessage += "네트워크 오류가 발생했습니다.";
          } else {
            errorMessage += "알 수 없는 오류가 발생했습니다.";
          }

          showAlert("😥", errorMessage);
        } finally {
          overlay.classList.add("hidden");
        }
      }

      /* ===== 회원 프로필 조회(신청 정보 풍부화) ===== */
      async function getCurrentMemberProfile() {
        try {
          if (!currentUser?.studentId) return {};
          const snap = await getDoc(doc(db, "members", currentUser.studentId));
          return snap.exists() ? snap.data() || {} : {};
        } catch {
          return {};
        }
      }
      function pickProfileFields(p = {}) {
        return {
          gender: p.gender || "",
          year: p.year || "",
          college: p.college || "",
          department: p.department || "",
          phone: p.phone || "",
        };
      }

      /* ===== 신청 로직 ===== */
      async function reserveGeneral(id) {
        if (!currentUser) return showAlert("😥", "로그인이 필요합니다.");

        // 중복 클릭 방지
        const requestKey = `reserve-general-${id}`;
        if (processingRequests.has(requestKey)) {
          console.log("이미 처리 중인 요청입니다:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // 로딩 상태 표시
        const button = document.querySelector(
          `button[data-act="reserve-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>신청 중...';
        }

        const prof = pickProfileFields(await getCurrentMemberProfile());
        try {
          // 각 이벤트는 독립적이므로 다른 이벤트 신청 여부는 체크하지 않음
          // 단, 같은 이벤트 내에서만 중복 체크

          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            if (!snap.exists()) throw new Error("not found");
            const ev = snap.data();
            ev.applicants ??= [];
            ev.waiting ??= [];
            if (isUserIn([...ev.applicants, ...ev.waiting])) return;
            const now = new Date().toISOString();
            const entry = {
              ...currentUser,
              ...prof,
              timestamp: now,
              appliedAt: now,
            };
            const lim = parseInt(ev.limit || 0, 10) || 0;
            if (lim === 0 || ev.applicants.length < lim)
              ev.applicants.push(entry);
            else ev.waiting.push(entry);
            tx.update(ref, { applicants: ev.applicants, waiting: ev.waiting });
          });
          showAlert("✅", "신청 완료!");
        } catch (e) {
          if (String(e?.message).includes("DUP"))
            showAlert("🙂", "이미 이 이벤트에 신청(또는 대기)되어 있어요.");
          else showAlert("😥", "신청 실패");
        } finally {
          // 처리 완료 시 전역 변수에서 제거
          processingRequests.delete(requestKey);

          // 버튼 상태 복원
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelGeneral(id) {
        if (!currentUser) return;

        // 중복 클릭 방지
        const requestKey = `cancel-general-${id}`;
        if (processingRequests.has(requestKey)) {
          console.log("이미 처리 중인 요청입니다:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // 로딩 상태 표시
        const button = document.querySelector(
          `button[data-act="cancel-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>취소 중...';
        }

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.applicants ??= [];
            ev.waiting ??= [];
            const before = ev.applicants.length;
            ev.applicants = ev.applicants.filter(
              (p) => p.studentId !== currentUser.studentId
            );
            if (ev.applicants.length < before) {
              if (ev.waiting.length > 0) ev.applicants.push(ev.waiting.shift());
            } else
              ev.waiting = ev.waiting.filter(
                (p) => p.studentId !== currentUser.studentId
              );
            tx.update(ref, { applicants: ev.applicants, waiting: ev.waiting });
          });
          showAlert("🗑️", "신청 취소됨");
        } catch {
          showAlert("😥", "취소 실패");
        } finally {
          // 처리 완료 시 전역 변수에서 제거
          processingRequests.delete(requestKey);

          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelWaitGeneral(id) {
        if (!currentUser) return showAlert("😥", "로그인이 필요합니다.");

        // 중복 클릭 방지
        const requestKey = `cancel-wait-general-${id}`;
        if (processingRequests.has(requestKey)) {
          console.log("이미 처리 중인 요청입니다:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // 로딩 상태 표시
        const button = document.querySelector(
          `button[data-act="cancel-wait-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>취소 중...';
        }

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.waiting ??= [];
            ev.waiting = ev.waiting.filter(
              (p) => p.studentId !== currentUser.studentId
            );
            tx.update(ref, { waiting: ev.waiting });
          });
          showAlert("🗑️", "대기 취소됨");
        } catch {
          showAlert("😥", "취소 실패");
        } finally {
          // 처리 완료 시 전역 변수에서 제거
          processingRequests.delete(requestKey);

          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      // 중복 클릭 방지를 위한 전역 변수
      const processingRequests = new Set();

      async function reserveTasting(id, rid) {
        if (!currentUser) return showAlert("😥", "로그인이 필요합니다.");

        // 중복 클릭 방지
        const requestKey = `reserve-tasting-${id}-${rid}`;
        if (processingRequests.has(requestKey)) {
          console.log("이미 처리 중인 요청입니다:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // 로딩 상태 표시
        const button = document.querySelector(
          `button[data-act="reserve-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>신청 중...';
        }

        const prof = pickProfileFields(await getCurrentMemberProfile());
        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.restaurants ??= [];

            // 미식회는 같은 이벤트 내에서만 중복 체크 (다른 미식회 이벤트는 허용)
            const already = ev.restaurants.some((r) =>
              (r.reservations || [])
                .concat(r.waiting || [])
                .some((p) => p.studentId === currentUser.studentId)
            );
            if (already) throw new Error("DUP");
            const idx = ev.restaurants.findIndex((r) => r.id === rid);
            if (idx === -1) throw new Error("restaurant not found");
            const r = ev.restaurants[idx];
            r.reservations ??= [];
            r.waiting ??= [];
            const cap = r.capacity ?? ev.limit ?? 0;
            const now = new Date().toISOString();
            const entry = {
              ...currentUser,
              ...prof,
              timestamp: now,
              appliedAt: now,
            };
            if (r.reservations.length < cap) r.reservations.push(entry);
            else r.waiting.push(entry);
            ev.restaurants[idx] = r;
            tx.update(ref, { restaurants: ev.restaurants });
          });
          showAlert("✅", "신청 완료!");
        } catch (e) {
          if (String(e?.message).includes("DUP"))
            showAlert(
              "🙂",
              "이미 이 미식회에서 다른 식당에 신청(또는 대기)되어 있어요.<br><b>한 미식회에서 한 식당만</b> 선택할 수 있습니다."
            );
          else showAlert("😥", "신청 실패");
        } finally {
          // 처리 완료 시 전역 변수에서 제거
          processingRequests.delete(requestKey);

          // 버튼 상태 복원
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelTasting(id, rid) {
        if (!currentUser) return;

        // 중복 클릭 방지
        const requestKey = `cancel-tasting-${id}-${rid}`;
        if (processingRequests.has(requestKey)) {
          console.log("이미 처리 중인 요청입니다:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // 로딩 상태 표시
        const button = document.querySelector(
          `button[data-act="cancel-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>취소 중...';
        }

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.restaurants ??= [];
            const idx = ev.restaurants.findIndex((r) => r.id === rid);
            if (idx === -1) throw new Error("restaurant not found");
            const r = ev.restaurants[idx];
            r.reservations ??= [];
            r.waiting ??= [];
            const before = r.reservations.length;
            r.reservations = r.reservations.filter(
              (p) => p.studentId !== currentUser.studentId
            );
            if (r.reservations.length < before) {
              if (r.waiting.length > 0) r.reservations.push(r.waiting.shift());
            } else
              r.waiting = r.waiting.filter(
                (p) => p.studentId !== currentUser.studentId
              );
            ev.restaurants[idx] = r;
            tx.update(ref, { restaurants: ev.restaurants });
          });
          showAlert("🗑️", "취소되었습니다.");
        } catch {
          showAlert("😥", "취소 실패");
        } finally {
          // 처리 완료 시 전역 변수에서 제거
          processingRequests.delete(requestKey);

          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelWaitTasting(id, rid) {
        if (!currentUser) return showAlert("😥", "로그인이 필요합니다.");

        // 중복 클릭 방지
        const requestKey = `cancel-wait-tasting-${id}-${rid}`;
        if (processingRequests.has(requestKey)) {
          console.log("이미 처리 중인 요청입니다:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // 로딩 상태 표시
        const button = document.querySelector(
          `button[data-act="cancel-wait-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>취소 중...';
        }

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.restaurants ??= [];
            const idx = ev.restaurants.findIndex((r) => r.id === rid);
            if (idx === -1) throw new Error("restaurant not found");
            const r = ev.restaurants[idx];
            r.waiting ??= [];
            r.waiting = r.waiting.filter(
              (p) => p.studentId !== currentUser.studentId
            );
            ev.restaurants[idx] = r;
            tx.update(ref, { restaurants: ev.restaurants });
          });
          showAlert("🗑️", "대기 취소됨");
        } catch {
          showAlert("😥", "취소 실패");
        } finally {
          // 처리 완료 시 전역 변수에서 제거
          processingRequests.delete(requestKey);

          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }

      /* ===== 참가자 제외 기능 ===== */
      // 학번 마스킹 헬퍼 함수 (전역)
      function maskStudentIdGlobal(studentId) {
        if (!studentId) return "";
        if (studentId.length <= 4) return studentId;
        return studentId.substring(0, 4) + "*".repeat(studentId.length - 4);
      }

      // 전역 스코프에 노출 (onclick 핸들러에서 사용)
      window.confirmRemoveParticipant = async function (
        eventId,
        studentId,
        listType,
        restaurantId = null
      ) {
        // 회장단 권한 체크
        if (!isFullAdmin()) {
          showAlert("🔒", "회장단만 참가자를 제외할 수 있습니다.");
          return;
        }

        // 이벤트 정보 가져오기
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) {
          showAlert("😥", "이벤트를 찾을 수 없습니다.");
          return;
        }

        // 참가자 정보 찾기
        let participant = null;
        let participantName = "";

        if (restaurantId) {
          // 미식회 경우
          const restaurant = event.restaurants?.find(
            (r) => r.id === restaurantId
          );
          if (!restaurant) {
            showAlert("😥", "식당을 찾을 수 없습니다.");
            return;
          }
          const list =
            listType === "reservations"
              ? restaurant.reservations
              : restaurant.waiting;
          participant = list?.find((p) => p.studentId === studentId);
          participantName = participant?.name || "";
        } else {
          // 일반 이벤트 경우
          const list =
            listType === "applicants" ? event.applicants : event.waiting;
          participant = list?.find((p) => p.studentId === studentId);
          participantName = participant?.name || "";
        }

        if (!participant) {
          showAlert("😥", "참가자를 찾을 수 없습니다.");
          return;
        }

        // 확인 문구
        const confirmMsg = `해당 참가자를 제외시키겠습니까?\n\n이름: ${participantName} (${maskStudentIdGlobal(
          studentId
        )})\n이벤트: ${event.title}`;

        if (!confirm(confirmMsg)) {
          return;
        }

        // 제외 실행
        await removeParticipant(eventId, studentId, listType, restaurantId);
      };

      async function removeParticipant(
        eventId,
        studentId,
        listType,
        restaurantId = null
      ) {
        let wasRemoved = false;
        let eventTitle = "";

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", eventId);
            const snap = await tx.get(ref);
            const ev = snap.data();
            eventTitle = ev.title;

            if (restaurantId) {
              // 미식회 경우
              const idx = ev.restaurants.findIndex(
                (r) => r.id === restaurantId
              );
              if (idx === -1) throw new Error("restaurant not found");
              const r = ev.restaurants[idx];

              // 참가자 찾기 및 제외
              const before =
                listType === "reservations"
                  ? r.reservations?.length
                  : r.waiting?.length;

              if (listType === "reservations") {
                r.reservations = r.reservations.filter(
                  (p) => p.studentId !== studentId
                );
              } else {
                r.waiting = r.waiting.filter((p) => p.studentId !== studentId);
              }

              ev.restaurants[idx] = r;
              tx.update(ref, { restaurants: ev.restaurants });

              wasRemoved =
                (listType === "reservations"
                  ? r.reservations.length
                  : r.waiting.length) < before;
            } else {
              // 일반 이벤트 경우
              const before =
                listType === "applicants"
                  ? ev.applicants?.length
                  : ev.waiting?.length;

              if (listType === "applicants") {
                ev.applicants = ev.applicants.filter(
                  (p) => p.studentId !== studentId
                );
              } else {
                ev.waiting = ev.waiting.filter(
                  (p) => p.studentId !== studentId
                );
              }

              tx.update(ref, {
                applicants: ev.applicants,
                waiting: ev.waiting,
              });

              wasRemoved =
                (listType === "applicants"
                  ? ev.applicants.length
                  : ev.waiting.length) < before;
            }
          });

          // transaction 완료 후 알림 전송
          if (wasRemoved) {
            await sendRemovalNotification(eventId, studentId, eventTitle);
          }

          showAlert("✅", "참가자가 제외되었습니다.");
          renderReservationTab(isFullAdmin());
        } catch (error) {
          console.error("참가자 제외 오류:", error);
          showAlert("😥", "참가자 제외 실패");
        }
      }

      async function sendRemovalNotification(eventId, studentId, eventTitle) {
        try {
          console.log("📤 참가자 제외 알림 전송 시도:", {
            eventId,
            studentId,
            eventTitle,
          });

          // 알림 데이터 생성
          const notificationData = {
            type: "participant_removed",
            eventId: eventId,
            eventTitle: eventTitle,
            studentId: studentId,
            message: `안녕하세요. ${eventTitle} 이벤트에서 참가자에서 제외되었습니다. 문의사항이 있으시면 운영진에게 연락해주세요.`,
            createdAt: new Date().toISOString(),
            read: false,
          };

          // 알림 저장 (notifications 컬렉션 사용)
          await addDoc(collection(db, "notifications"), notificationData);
          console.log("✅ 참가자 제외 알림 전송 성공");
        } catch (error) {
          console.error("❌ 알림 전송 실패:", error);
        }
      }

      /* ===== 알림 UI 렌더링 ===== */
      function renderNotifications() {
        if (!currentUser) return;

        // 현재 사용자의 읽지 않은 알림 필터
        const myNotifications = notificationsData.filter(
          (notif) => notif.studentId === currentUser.studentId && !notif.read
        );
        const unreadCount = myNotifications.length;

        // 알림 버튼 표시/숨김
        const notificationBadge = document.getElementById("notification-badge");
        const notificationCount = document.getElementById("notification-count");

        if (notificationBadge) {
          // 받은함 버튼은 항상 노출, 뱃지만 토글
          if (notificationCount) {
            if (unreadCount > 0) {
              notificationCount.textContent = unreadCount;
              notificationCount.classList.remove("hidden");
            } else {
              notificationCount.classList.add("hidden");
            }
          }
        }

        // 알림 목록 렌더링
        renderNotificationList();
      }

      function renderNotificationList() {
        if (!currentUser) return;

        const notificationList = document.getElementById("notification-list");
        if (!notificationList) return;

        // 모든 알림 (읽은 것 포함)
        const myNotifications = notificationsData
          .filter((notif) => notif.studentId === currentUser.studentId)
          .sort((a, b) => {
            const dateA = new Date(a.createdAt);
            const dateB = new Date(b.createdAt);
            return dateB - dateA;
          })
          .slice(0, 10); // 최근 10개만 표시

        if (myNotifications.length === 0) {
          notificationList.innerHTML =
            '<div class="text-center text-gray-500 py-4">알림이 없습니다</div>';
          return;
        }

        notificationList.innerHTML = myNotifications
          .map((notif) => {
            const date = new Date(notif.createdAt);
            const dateStr = date.toLocaleDateString("ko-KR", {
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            return `
              <div class="py-3 border-b border-gray-100 hover:bg-gray-50 ${
                notif.read ? "opacity-60" : ""
              }" data-notif-id="${notif.id}">
                <div class="flex items-start gap-3">
                  <div class="flex-1 min-w-0">
                    <p class="text-sm text-gray-800 ${
                      notif.read ? "" : "font-semibold"
                    }">${saf(notif.message || notif.eventTitle || "알림")}</p>
                    <p class="text-xs text-gray-500 mt-1">${dateStr}</p>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    ${
                      !notif.read
                        ? '<div class="w-2 h-2 bg-orange-500 rounded-full"></div>'
                        : ""
                    }
                    <button
                      type="button"
                      class="text-gray-400 hover:text-red-600 transition-colors p-1"
                      onclick="deleteNotification('${notif.id}')"
                      title="삭제"
                    >
                      <i class="fas fa-times text-sm"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      // 알림 삭제 함수
      window.deleteNotification = async function (notificationId) {
        if (!currentUser) return;

        if (!confirm("이 알림을 삭제하시겠습니까?")) {
          return;
        }

        try {
          await deleteDoc(doc(db, "notifications", notificationId));
          showAlert("✅", "알림이 삭제되었습니다.");
          renderNotificationList();
          renderNotifications(); // 뱃지 업데이트
        } catch (error) {
          console.error("알림 삭제 오류:", error);
          showAlert("😥", "알림 삭제에 실패했습니다.");
        }
      };

      /* ===== 자동 글 올리기 기능 ===== */
      async function scheduleAutoPost(
        type,
        title,
        datetime,
        customPostTime = null
      ) {
        try {
          // 게시 시간 결정
          let postTime;
          if (customPostTime) {
            // 사용자가 직접 설정한 시간 사용
            postTime = new Date(customPostTime);
          } else {
            // 이벤트 시간 24시간 전에 알림 글 올리기
            const eventTime = new Date(datetime);
            postTime = new Date(eventTime.getTime() - 24 * 60 * 60 * 1000); // 24시간 전
          }

          const now = new Date();

          // 게시 시간 검증은 아래에서 처리

          // 게시글 내용 생성
          const typeLabel =
            {
              tasting: "미식회",
              general: "일반 이벤트",
              mt: "MT",
              assembly: "총회",
            }[type] || type;

          const postContent = `🍽️ ${typeLabel} 알림 🍽️
 
📅 일시: ${eventTime.toLocaleString("ko-KR")}
📝 제목: ${title}
 
곧 신청이 시작됩니다! 
많은 참여 부탁드려요~ 😊
 
#Foodie #${typeLabel}`;

          // 자동 글 올리기 스케줄 저장
          await addDoc(collection(db, "scheduledPosts"), {
            eventType: type,
            eventTitle: title,
            eventTime: datetime,
            postTime: postTime.toISOString(),
            content: postContent,
            status: "scheduled", // scheduled, posted, cancelled
            createdAt: new Date(),
            createdBy: currentUser?.studentId || "system",
          });

          // 게시 시간이 현재 시간보다 이전이면 즉시 게시
          if (postTime <= now) {
            console.log(
              "게시 시간이 현재 시간보다 이전이므로 즉시 게시합니다."
            );
            await scheduleActualPost(postTime, postContent);
          } else {
            console.log(
              `자동 글 올리기가 ${postTime.toLocaleString(
                "ko-KR"
              )}에 예약되었습니다.`
            );

            // 실제 글 올리기 스케줄링 (setTimeout 사용)
            const delay = postTime.getTime() - now.getTime();
            setTimeout(async () => {
              await scheduleActualPost(postTime, postContent);
            }, delay);
          }
        } catch (error) {
          console.error("자동 글 올리기 스케줄링 오류:", error);
          // 오류가 발생해도 이벤트 생성은 계속 진행
        }
      }

      // 실제 글 올리기 함수 (즉시 실행)
      async function scheduleActualPost(postTime, content) {
        try {
          await postAnnouncement(content);
          console.log("자동 글 올리기가 완료되었습니다.");
        } catch (error) {
          console.error("자동 글 올리기 실행 오류:", error);
        }
      }

      // 공지사항 게시 함수
      async function postAnnouncement(content) {
        try {
          // 공지사항 블록 생성
          const announcementBlock = {
            type: "announcement",
            title: "📢 공지사항",
            content: content,
            createdAt: new Date(),
            createdBy: currentUser?.studentId || "system",
            isAuto: true, // 자동 생성된 공지사항 표시
            order: 999, // 맨 위에 표시
          };

          // Firebase에 저장
          const docRef = await addDoc(
            collection(db, "homeLayout"),
            announcementBlock
          );

          console.log("공지사항이 성공적으로 게시되었습니다:", docRef.id);

          // blocksData에 추가
          if (!blocksData) blocksData = [];
          blocksData.push(announcementBlock);

          // 페이지 새로고침
          renderAll();

          // 성공 알림
          showAlert("📢", "알림 글이 성공적으로 게시되었습니다!");
        } catch (error) {
          console.error("공지사항 게시 오류:", error);
          showAlert("😥", "공지사항 게시 중 오류가 발생했습니다.");
          throw error;
        }
      }

      // 페이지 로드 시 예약된 글들 확인 및 실행
      function checkScheduledPosts() {
        if (!currentUser || !adminList.includes(currentUser.studentId)) return;

        // 현재 시간 기준으로 예약된 글들 확인
        const now = new Date();

        // Firebase에서 scheduledPosts 확인 (실제 구현에서는 onSnapshot 사용)
        // 여기서는 간단히 localStorage를 사용하여 예시
        const scheduledPosts = JSON.parse(
          localStorage.getItem("scheduledPosts") || "[]"
        );

        scheduledPosts.forEach((post) => {
          const postTime = new Date(post.postTime);
          if (post.status === "scheduled" && postTime <= now) {
            scheduleActualPost(postTime, post.content);
          }
        });
      }

      /* ===== 이벤트 저장/보관/삭제/재게시 ===== */
      // 기존 createOrSaveEvent 함수는 새로운 saveEvent와 saveTastingEvent로 대체됨
      async function createOrSaveEvent_DEPRECATED() {
        const type = document.getElementById("event-type").value;
        const title = document.getElementById("event-title").value.trim();
        const datetime = document.getElementById("event-datetime").value;
        const deadline = document.getElementById("event-deadline").value;
        const limit =
          parseInt(document.getElementById("event-limit").value, 10) || 0;
        const status = document.getElementById("event-status").value;
        if (!type || !title || !datetime || !deadline || !limit)
          return showAlert(
            "😥",
            "타입/제목/실시일/마감일/정원을 모두 입력해주세요."
          );

        let payment = null;
        if (type === "mt" || type === "assembly") {
          const b = document.getElementById("pay-bank").value.trim();
          const n = document.getElementById("pay-number").value.trim();
          const h = document.getElementById("pay-holder").value.trim();
          const a = document.getElementById("pay-amount").value.trim();
          const note = document.getElementById("pay-note").value.trim();
          const d = duesSettings || {};
          payment = {
            bank: b || d.bank || "",
            number: n || d.number || "",
            holder: h || d.holder || "",
            amount: a ? parseInt(a) : d.amount ? parseInt(d.amount) : null,
            note:
              note ||
              (d.amount ? `회비 ${formatKRW(d.amount)} ` : "") + (d.note || ""),
          };
        }
        try {
          if (!editingEventId) {
            if (type === "tasting") {
              const rows = [
                ...document.querySelectorAll(
                  "#event-restaurants-wrap .restaurant-row"
                ),
              ];
              const restaurants = rows
                .map((row) => ({
                  id: row.getAttribute("data-id"),
                  name: row.querySelector("[data-field='name']").value.trim(),
                  info: row.querySelector("[data-field='info']").value.trim(),
                  imageUrl: "",
                  capacity:
                    parseInt(
                      row.querySelector("[data-field='capacity']").value,
                      10
                    ) || limit,
                  category:
                    row.querySelector("[data-field='category']")?.value ||
                    "기타",
                  reservations: [],
                  waiting: [],
                }))
                .filter((r) => r.name && r.capacity > 0);
              if (restaurants.length === 0)
                return showAlert("😥", "식당을 최소 1개 이상 추가해주세요.");
              await addDoc(collection(db, "events"), {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                restaurants,
              });
            } else {
              const base = {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                applicants: [],
                waiting: [],
              };
              if (payment) base.payment = payment;
              await addDoc(collection(db, "events"), base);
            }
            showAlert("🎉", "이벤트가 생성되었습니다.");

            // 자동 글 올리기 기능
            const enableAutoPost =
              document.getElementById("enable-auto-post")?.checked;
            if (enableAutoPost) {
              const postTimeType = document.querySelector(
                'input[name="post-time-type"]:checked'
              )?.value;
              let customPostTime = null;

              if (postTimeType === "custom") {
                const postDatetime =
                  document.getElementById("post-datetime")?.value;
                if (postDatetime) {
                  customPostTime = postDatetime;
                }
              }

              await scheduleAutoPost(type, title, datetime, customPostTime);
            }

            closeEventModal();
            // 이벤트 목록 새로고침 (전체 페이지 렌더링)
            renderAll();
          } else {
            const ref = doc(db, "events", editingEventId);
            const snap = await getDoc(ref);
            if (!snap.exists()) throw new Error("not found");
            const prev = snap.data();
            if (type === "tasting") {
              const map = new Map(
                (prev.restaurants || []).map((r) => [r.id, r])
              );
              const rows = [
                ...document.querySelectorAll(
                  "#event-restaurants-wrap .restaurant-row"
                ),
              ];
              const restaurants = rows
                .map((row) => {
                  const idAttr = row.getAttribute("data-id");
                  const old = map.get(idAttr);
                  return {
                    id: idAttr,
                    name: row.querySelector("[data-field='name']").value.trim(),
                    info: row.querySelector("[data-field='info']").value.trim(),
                    imageUrl:
                      row
                        .querySelector("[data-field='imageUrl']")
                        ?.value.trim() || "",
                    capacity:
                      parseInt(
                        row.querySelector("[data-field='capacity']").value,
                        10
                      ) || limit,
                    reservations: old?.reservations || [],
                    waiting: old?.waiting || [],
                  };
                })
                .filter((r) => r.name && r.capacity > 0);
              await updateDoc(ref, {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                restaurants,
              });
            } else {
              const payload = {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
              };
              if (payment) payload.payment = payment;
              await updateDoc(ref, payload);
            }
            showAlert("✅", "이벤트가 수정되었습니다.");
            closeEventModal();
            // 이벤트 목록 새로고침 (전체 페이지 렌더링)
            renderAll();
          }
          resetEventForm();
        } catch (error) {
          console.error("이벤트 저장 오류:", error);
          showAlert("😥", `저장 중 오류가 발생했습니다: ${error.message}`);
        }
      }
      // 기존 resetEventForm 함수는 새로운 구조로 대체됨
      async function closeEvent(id) {
        if (
          !confirm(
            "이벤트 신청을 마감하고 보관하시겠습니까?\n\n• 일반 회원에게는 보이지 않습니다\n• 회장단만 보관된 이벤트 목록에서 볼 수 있습니다\n• 신청자 명단은 모두 보존됩니다\n• 언제든지 복원 버튼으로 다시 공개할 수 있습니다"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            status: "archived",
            closedAt: new Date().toISOString(),
          });
          showAlert(
            "📦",
            "이벤트가 마감되고 보관되었습니다. 보관된 이벤트 목록에서 확인할 수 있습니다."
          );
        } catch {
          showAlert("😥", "마감 처리 실패");
        }
      }
      async function reopenEvent(id) {
        if (
          !confirm(
            "마감된 이벤트를 다시 열어 신청을 받으시겠습니까?\n\n• 신청 탭에 다시 표시됩니다\n• 회원들이 다시 신청할 수 있게 됩니다"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            status: "open",
            reopenedAt: new Date().toISOString(),
          });
          showAlert(
            "✅",
            "이벤트가 다시 열렸습니다. 신청 탭에서 확인할 수 있습니다."
          );
        } catch {
          showAlert("😥", "다시 열기 실패");
        }
      }

      async function unpostEvent(id) {
        if (
          !confirm(
            "이 이벤트의 공지사항을 내리시겠습니까?\n\n• 관련 공지사항이 숨겨집니다\n• 회원들이 공지사항을 볼 수 없게 됩니다"
          )
        ) {
          return;
        }
        try {
          // 이벤트 정보 가져오기
          const eventDoc = await getDoc(doc(db, "events", id));
          if (!eventDoc.exists()) {
            showAlert("😥", "이벤트를 찾을 수 없습니다.");
            return;
          }

          const eventData = eventDoc.data();
          const eventTitle = eventData.title;
          let foundAnnouncement = false;

          // 1. scheduledPosts 컬렉션에서 해당 이벤트와 관련된 예약된 글 찾기
          const scheduledPostsSnapshot = await getDocs(
            collection(db, "scheduledPosts")
          );
          for (const postDoc of scheduledPostsSnapshot.docs) {
            const postData = postDoc.data();
            if (
              postData.eventTitle === eventTitle &&
              postData.status !== "cancelled"
            ) {
              // 예약된 글을 취소 상태로 변경
              await updateDoc(doc(db, "scheduledPosts", postDoc.id), {
                status: "cancelled",
                cancelledAt: new Date().toISOString(),
                cancelledBy: currentUser?.studentId || "unknown",
              });
              foundAnnouncement = true;
            }
          }

          // 2. 공지사항 블록에서 해당 이벤트와 관련된 공지사항 찾기
          const blocksSnapshot = await getDocs(collection(db, "blocks"));
          for (const blockDoc of blocksSnapshot.docs) {
            const blockData = blockDoc.data();
            if (
              blockData.type === "announcement" &&
              blockData.payload &&
              blockData.payload.content &&
              blockData.payload.content.includes(eventTitle) &&
              blockData.visible !== false
            ) {
              // 공지사항 블록을 숨김 처리
              await updateDoc(doc(db, "blocks", blockDoc.id), {
                visible: false,
                unpostedAt: new Date().toISOString(),
                unpostedBy: currentUser?.studentId || "unknown",
              });
              foundAnnouncement = true;
            }
          }

          if (foundAnnouncement) {
            showAlert("✅", "공지사항이 내려졌습니다.");
          } else {
            showAlert("ℹ️", "이 이벤트와 관련된 공지사항을 찾을 수 없습니다.");
          }
        } catch (error) {
          console.error("글 내리기 실패:", error);
          showAlert("😥", "글 내리기 실패");
        }
      }
      async function archiveEvent(id) {
        try {
          await updateDoc(doc(db, "events", id), { status: "archived" });
          showAlert("📦", "보관(숨김) 처리되었습니다.");
        } catch {
          showAlert("😥", "보관 처리 실패");
        }
      }

      async function unarchiveEvent(id) {
        if (
          !confirm(
            "보관된 이벤트를 다시 공개하시겠습니까?\n\n• 신청 탭에 다시 표시됩니다\n• 기존 신청자 명단이 모두 유지됩니다\n• 회원들이 이벤트를 다시 볼 수 있습니다"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            status: "open",
            unarchivedAt: new Date().toISOString(),
          });
          showAlert(
            "✅",
            "이벤트가 복원되었습니다. 신청 탭에서 확인할 수 있습니다."
          );
        } catch {
          showAlert("😥", "복원 실패");
        }
      }

      async function completeEvent(id) {
        if (
          !confirm(
            "활동을 완전히 종료하시겠습니까?\n\n⚠️ 주의사항:\n• 이벤트가 완전히 삭제됩니다\n• 신청자 정보는 모두 보존됩니다 (내 활동에서 계속 표시됨)\n• 보관함에서도 사라집니다\n• 되돌릴 수 없습니다\n\n정말 종료하시겠습니까?"
          )
        ) {
          return;
        }
        try {
          // 이벤트를 완전히 종료 (completed 상태로 변경)
          await updateDoc(doc(db, "events", id), {
            status: "completed",
            completedAt: new Date().toISOString(),
            completedBy: currentUser?.studentId || "unknown",
          });
          showAlert(
            "✅",
            "활동이 종료되었습니다. 참가자들은 내 활동에서 계속 확인할 수 있습니다."
          );
        } catch (error) {
          console.error("활동 종료 실패:", error);
          showAlert("😥", "활동 종료 실패");
        }
      }

      async function confirmActivity(id) {
        if (
          !confirm(
            "이 활동을 확정하시겠습니까?\n\n• 참가자들에게 확정 알림이 전송됩니다\n• 활동이 정상적으로 완료된 것으로 기록됩니다"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            activityStatus: "confirmed",
            confirmedAt: new Date().toISOString(),
            confirmedBy: currentUser?.studentId || "unknown",
          });
          showAlert("✅", "활동이 확정되었습니다.");
        } catch (error) {
          console.error("활동 확정 실패:", error);
          showAlert("😥", "활동 확정 실패");
        }
      }

      async function cancelActivity(id) {
        if (
          !confirm(
            "이 활동을 취소하시겠습니까?\n\n• 참가자들에게 취소 알림이 전송됩니다\n• 환불 등의 후속 조치가 필요할 수 있습니다"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            activityStatus: "cancelled",
            cancelledAt: new Date().toISOString(),
            cancelledBy: currentUser?.studentId || "unknown",
          });
          showAlert("❌", "활동이 취소되었습니다.");
        } catch (error) {
          console.error("활동 취소 실패:", error);
          showAlert("😥", "활동 취소 실패");
        }
      }

      // 자동 신청 마감 기능
      async function autoCloseExpiredEvents() {
        // 로그인 상태이고 관리자 권한이 있을 때만 실행
        if (!currentUser || !isFullAdmin()) {
          return;
        }

        try {
          const now = new Date();
          const eventsSnapshot = await getDocs(collection(db, "events"));

          const expiredEvents = [];

          for (const eventDoc of eventsSnapshot.docs) {
            const eventData = eventDoc.data();

            // 이미 마감된 이벤트, 보관된 이벤트, 완료된 이벤트는 제외
            if (
              eventData.status === "closed" ||
              eventData.status === "archived" ||
              eventData.status === "completed"
            ) {
              continue;
            }

            // 마감일이 설정되어 있고, 현재 시간이 마감일을 지났으면 마감 처리
            if (eventData.deadline) {
              const deadline = new Date(eventData.deadline);
              if (deadline < now) {
                expiredEvents.push({
                  id: eventDoc.id,
                  title: eventData.title,
                  deadline: eventData.deadline,
                });
              }
            }
          }

          // 마감일이 지난 이벤트들을 자동 마감 처리 (보관함으로 이동)
          for (const event of expiredEvents) {
            await updateDoc(doc(db, "events", event.id), {
              status: "archived",
              autoClosedAt: new Date().toISOString(),
              autoClosedReason: "deadline_expired",
            });

            console.log(
              `자동 마감 처리: ${event.title} (마감일: ${new Date(
                event.deadline
              ).toLocaleString("ko-KR")})`
            );
          }

          if (expiredEvents.length > 0) {
            console.log(
              `총 ${expiredEvents.length}개의 이벤트가 자동 마감 처리되었습니다.`
            );
            // 관리자에게 알림 (선택사항)
            if (isFullAdmin()) {
              showAlert(
                "⏰",
                `${expiredEvents.length}개의 이벤트가 마감일 도과로 자동 마감되었습니다.`
              );
            }
          }
        } catch (error) {
          console.error("자동 마감 처리 실패:", error);
        }
      }

      // 자동 마감 스케줄러 설정
      function setupAutoCloseScheduler() {
        // 페이지 로드 시 즉시 실행
        autoCloseExpiredEvents();

        // 1분마다 체크 (실시간성 확보)
        setInterval(autoCloseExpiredEvents, 60 * 1000);

        // 매 시간 정각에 체크 (정확성 확보)
        const now = new Date();
        const minutesUntilNextHour = 60 - now.getMinutes();
        const secondsUntilNextHour =
          minutesUntilNextHour * 60 - now.getSeconds();

        setTimeout(() => {
          autoCloseExpiredEvents();
          // 이후 매 시간마다 실행
          setInterval(autoCloseExpiredEvents, 60 * 60 * 1000);
        }, secondsUntilNextHour * 1000);

        console.log("자동 신청 마감 스케줄러가 설정되었습니다.");
      }
      async function deleteEvent(id) {
        const event = eventsData.find((e) => e.id === id);
        if (!event) {
          showAlert("😥", "이벤트를 찾을 수 없습니다.");
          return;
        }

        // 미식회이고 리뷰가 있는 경우 삭제 방지
        if (
          event.type === "tasting" &&
          event.reviews &&
          event.reviews.length > 0
        ) {
          showAlert(
            "⛔",
            `<div class="text-left">
              <p class="font-bold mb-2">미식회 후기가 있어 삭제할 수 없습니다</p>
              <p class="text-sm">• 현재 <strong>${event.reviews.length}개의 후기</strong>가 작성되어 있습니다</p>
              <p class="text-sm">• 미식회 후기는 회원들의 소중한 기록입니다</p>
              <p class="text-sm mt-2 text-gray-600">💡 Tip: 후기를 모두 삭제한 후 이벤트를 삭제할 수 있습니다</p>
            </div>`
          );
          return;
        }

        if (
          !confirm(
            `정말로 삭제하시겠어요?\n\n⚠️ 주의:\n• 이벤트가 완전히 삭제됩니다\n• 내 활동 탭에서도 보이지 않게 됩니다\n• 이 작업은 되돌릴 수 없습니다\n\n계속하시겠습니까?`
          )
        ) {
          return;
        }

        try {
          // status를 'deleted'로 변경 (완전 삭제가 아닌 숨김)
          await updateDoc(doc(db, "events", id), {
            status: "deleted",
            deletedAt: new Date().toISOString(),
          });
          showAlert(
            "🗑️",
            "이벤트가 삭제되었습니다. (내 활동에서도 보이지 않습니다)"
          );
        } catch (error) {
          console.error("이벤트 삭제 오류:", error);
          showAlert("😥", `삭제 실패: ${error.message}`);
        }
      }
      // ==================== 조짜기 기능 (새 버전 - 간단명료) ====================

      // 조장 선택기 업데이트 (먼저 정의)
      function updateLeaderSelectorsNew(
        participants,
        groupCount,
        preserveSelections = false
      ) {
        const container = document.getElementById("leader-selectors-new");
        if (!container) return;

        // 기존 선택 정보 저장 (preserveSelections가 true일 때만)
        const previousSelections = {};
        if (preserveSelections) {
          container.querySelectorAll(".leader-select-new").forEach((select) => {
            if (select.value) {
              previousSelections[select.dataset.group] = select.value;
            }
          });
        }

        // 모든 선택기에서 선택된 조장들 수집
        const selectedLeaders = new Set(Object.values(previousSelections));

        container.innerHTML = "";
        for (let i = 1; i <= groupCount; i++) {
          const currentSelection = previousSelections[i] || "";

          container.innerHTML += `
            <div class="flex items-center gap-2 p-2 bg-white border rounded-lg">
              <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-400 rounded-full flex items-center justify-center text-white font-bold">
                ${i}
              </div>
              <select class="leader-select-new flex-1 px-3 py-2 border rounded-lg text-sm focus:border-yellow-400" data-group="${i}">
                <option value="">조장 선택</option>
                ${participants
                  .map((p) => {
                    // 이미 다른 조에서 선택된 조장은 비활성화 (현재 조의 선택은 제외)
                    const isSelected =
                      selectedLeaders.has(p.studentId) &&
                      currentSelection !== p.studentId;
                    const selectedAttr =
                      currentSelection === p.studentId ? "selected" : "";
                    const disabledAttr = isSelected ? "disabled" : "";
                    const label = isSelected
                      ? `${p.name} (이미 선택됨)`
                      : `${p.name} (${p.gender}/${p.college})`;
                    return `<option value="${p.studentId}" ${selectedAttr} ${disabledAttr}>${label}</option>`;
                  })
                  .join("")}
              </select>
            </div>
          `;
        }

        // 조장 선택 시 다른 선택기 업데이트
        container.querySelectorAll(".leader-select-new").forEach((select) => {
          select.addEventListener("change", () => {
            updateLeaderSelectorsNew(participants, groupCount, true);
          });
        });
      }

      // 조 생성 알고리즘 (라운드 로빈)
      function createGroupsNew(
        participants,
        groupCount,
        genderBalance,
        collegeMix,
        leaderMode
      ) {
        const groups = Array.from({ length: groupCount }, () => []);
        // 기존 isLeader 플래그 제거하고 복사
        const members = participants.map((p) => {
          const clean = { ...p };
          delete clean.isLeader;
          return clean;
        });

        // 1. 수동 조장 선택
        const selectedLeaders = new Set();
        const manualLeaderAssignments = []; // 조장 할당 정보 저장

        if (leaderMode === "manual") {
          document.querySelectorAll(".leader-select-new").forEach((select) => {
            const leaderStudentId = select.value;
            if (leaderStudentId && !selectedLeaders.has(leaderStudentId)) {
              selectedLeaders.add(leaderStudentId);
              const leaderIdx = members.findIndex(
                (p) => p.studentId === leaderStudentId
              );
              if (leaderIdx >= 0) {
                const leader = members.splice(leaderIdx, 1)[0];
                leader.isLeader = true;
                const groupIdx = parseInt(select.dataset.group) - 1;

                // 조장을 맨 앞에 배치
                groups[groupIdx].unshift(leader);

                manualLeaderAssignments.push({
                  studentId: leaderStudentId,
                  name: leader.name,
                  groupIdx: groupIdx,
                });

                console.log(
                  `👑 조장 배치: ${leader.name} → ${groupIdx + 1}조 (맨 앞)`
                );
              }
            }
          });

          if (manualLeaderAssignments.length > 0) {
            console.log("✅ 수동 조장 배치 완료:", manualLeaderAssignments);
          }
        }

        // 2. 나머지 인원 배치
        if (genderBalance && collegeMix) {
          // 성별 + 학과 균형
          const byGenderCollege = {};
          members.forEach((p) => {
            const key = `${p.gender}-${p.college || "기타"}`;
            if (!byGenderCollege[key]) byGenderCollege[key] = [];
            byGenderCollege[key].push(p);
          });

          Object.values(byGenderCollege).forEach((list) =>
            list.sort(() => Math.random() - 0.5)
          );

          let groupIdx = 0;
          Object.keys(byGenderCollege)
            .sort()
            .forEach((key) => {
              byGenderCollege[key].forEach((member) => {
                groups[groupIdx % groupCount].push(member);
                groupIdx++;
              });
            });
        } else if (genderBalance) {
          // 성별만 균형
          const males = members
            .filter((p) => p.gender === "남성")
            .sort(() => Math.random() - 0.5);
          const females = members
            .filter((p) => p.gender === "여성")
            .sort(() => Math.random() - 0.5);
          const others = members
            .filter((p) => p.gender !== "남성" && p.gender !== "여성")
            .sort(() => Math.random() - 0.5);

          let groupIdx = 0;
          [males, females, others].forEach((list) => {
            list.forEach((member) => {
              groups[groupIdx % groupCount].push(member);
              groupIdx++;
            });
          });
        } else if (collegeMix) {
          // 학과만 균형
          const byCollege = {};
          members.forEach((p) => {
            const college = p.college || "기타";
            if (!byCollege[college]) byCollege[college] = [];
            byCollege[college].push(p);
          });

          Object.values(byCollege).forEach((list) =>
            list.sort(() => Math.random() - 0.5)
          );

          let groupIdx = 0;
          Object.keys(byCollege)
            .sort()
            .forEach((college) => {
              byCollege[college].forEach((member) => {
                groups[groupIdx % groupCount].push(member);
                groupIdx++;
              });
            });
        } else {
          // 무작위
          members.sort(() => Math.random() - 0.5);
          members.forEach((member, idx) => {
            groups[idx % groupCount].push(member);
          });
        }

        // 3. 인원 균형 맞추기
        for (let iter = 0; iter < 10; iter++) {
          const sizes = groups.map((g) => g.length);
          const maxSize = Math.max(...sizes);
          const minSize = Math.min(...sizes);
          if (maxSize - minSize <= 1) break;

          const maxIdx = sizes.indexOf(maxSize);
          const minIdx = sizes.indexOf(minSize);
          const memberToMove = groups[maxIdx]
            .slice()
            .reverse()
            .find((m) => !m.isLeader);

          if (memberToMove) {
            groups[maxIdx].splice(groups[maxIdx].indexOf(memberToMove), 1);
            groups[minIdx].push(memberToMove);
          }
        }

        // 4. 자동 조장 설정 (또는 수동 모드에서 조장 미선택 시 자동 설정)
        if (leaderMode === "auto" || leaderMode === "manual") {
          groups.forEach((group, idx) => {
            if (group.length > 0 && !group.some((m) => m.isLeader)) {
              group[0].isLeader = true;
              console.log(`👑 자동 조장 설정: ${group[0].name} → ${idx + 1}조`);
            }
          });
        }

        // 5. 조장을 맨 앞으로 (안전장치)
        groups.forEach((group, idx) => {
          const leaderIdx = group.findIndex((m) => m.isLeader);
          if (leaderIdx > 0) {
            console.log(
              `⚠️ 조장이 ${leaderIdx + 1}번째에 있음. 맨 앞으로 이동: ${
                group[leaderIdx].name
              } (${idx + 1}조)`
            );
            const [leader] = group.splice(leaderIdx, 1);
            group.unshift(leader);
          } else if (leaderIdx === 0) {
            console.log(
              `✅ ${idx + 1}조 조장 확인: ${group[0].name} (이미 맨 앞)`
            );
          }
        });

        // 최종 결과 로그
        console.log("🎯 최종 조 편성 결과:");
        groups.forEach((group, idx) => {
          const leader = group.find((m) => m.isLeader);
          console.log(
            `${idx + 1}조 (${group.length}명): 조장=${
              leader?.name || "없음"
            }, 멤버=[${group.map((m) => m.name).join(", ")}]`
          );
        });

        return groups;
      }

      // 결과 표시
      function showGroupResultsNew(eventId, groups) {
        const ev = eventsData.find((e) => e.id === eventId);
        const totalMembers = groups.reduce((sum, g) => sum + g.length, 0);

        const resultsHTML = `
          <div id="group-results-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
              <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex justify-between items-center">
                <div>
                  <h3 class="text-2xl font-bold text-white">조 편성 결과</h3>
                  <p class="text-purple-100 text-sm">${
                    ev.title
                  } - 총 ${totalMembers}명 / ${groups.length}개 조</p>
                </div>
                <button onclick="document.getElementById('group-results-modal').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
              
              <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  ${groups
                    .map(
                      (group, idx) => `
                    <div class="border-2 border-purple-200 rounded-xl p-4 hover:shadow-lg transition-shadow">
                      <div class="flex items-center justify-between mb-3">
                        <h4 class="text-xl font-bold text-purple-600">${
                          idx + 1
                        }조</h4>
                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-bold">${
                          group.length
                        }명</span>
                      </div>
                      <div class="space-y-2">
                        ${group
                          .map(
                            (member) => `
                          <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                            ${
                              member.isLeader
                                ? '<i class="fas fa-crown text-yellow-500 text-lg"></i>'
                                : '<div class="w-5"></div>'
                            }
                            <div class="flex-1 min-w-0">
                              <div class="font-semibold text-gray-900">${
                                member.name
                              }</div>
                              <div class="text-xs text-gray-500">${
                                member.gender
                              } / ${member.college}</div>
                            </div>
                          </div>
                        `
                          )
                          .join("")}
                      </div>
                    </div>
                  `
                    )
                    .join("")}
                </div>
              </div>
              
              <div class="px-6 py-4 bg-gray-50 border-t flex gap-3">
                <button onclick="document.getElementById('group-results-modal').remove(); openGroupMakerModal('${eventId}')" 
                  class="px-6 py-3 border-2 border-purple-300 text-purple-700 rounded-xl hover:bg-purple-50 font-semibold">
                  <i class="fas fa-redo mr-2"></i>다시 짜기
                </button>
                <button onclick="document.getElementById('group-results-modal').remove()" 
                  class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 font-semibold">
                  <i class="fas fa-check mr-2"></i>확인
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", resultsHTML);
      }

      // 조짜기 모달 열기
      window.openGroupMakerModal = async function (eventId) {
        const ev = eventsData.find((e) => e.id === eventId);
        if (!ev) return showAlert("😥", "이벤트를 찾을 수 없습니다.");

        // 참가자 목록 수집
        let participants = [];
        if (ev.type === "tasting") {
          (ev.restaurants || []).forEach((r) => {
            (r.reservations || []).forEach((p) => {
              if (!participants.find((x) => x.studentId === p.studentId)) {
                participants.push(p);
              }
            });
          });
        } else {
          participants = ev.applicants || [];
        }

        if (participants.length === 0) {
          return showAlert("😥", "참가자가 없습니다.");
        }

        // 기존 모달들 모두 제거
        document.getElementById("group-maker-modal")?.remove();
        document.getElementById("group-results-modal")?.remove();

        // 간단한 모달 HTML
        const modalHTML = `
                        <div id="group-maker-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex justify-between items-center">
                                <div>
                                  <h3 class="text-2xl font-bold text-white">조짜기</h3>
                  <p class="text-purple-100 text-sm">참가자 ${participants.length}명을 조로 나눕니다</p>
                                </div>
                <button type="button" id="group-maker-close-btn" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
                
              <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <div class="border-2 border-gray-200 rounded-xl p-4">
                  <label class="block text-lg font-bold text-gray-800 mb-2">
                    <i class="fas fa-users mr-2 text-purple-600"></i>조 개수
                  </label>
                  <input type="number" id="group-count-new" min="2" max="10" value="3" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-bold focus:border-purple-500">
                </div>
                
                <div class="border-2 border-gray-200 rounded-xl p-4">
                  <label class="block text-lg font-bold text-gray-800 mb-3">
                    <i class="fas fa-balance-scale mr-2 text-blue-600"></i>균형 옵션
                  </label>
                  <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" id="gender-balance-new" checked class="w-5 h-5">
                      <span>성별 균형 맞추기</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" id="college-mix-new" checked class="w-5 h-5">
                      <span>학과 고르게 섞기</span>
                    </label>
                  </div>
                </div>
                
                <div class="border-2 border-gray-200 rounded-xl p-4">
                  <label class="block text-lg font-bold text-gray-800 mb-3">
                    <i class="fas fa-crown mr-2 text-yellow-600"></i>조장 설정
                  </label>
                  <div class="space-y-2 mb-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="leader-mode-new" value="manual" checked class="w-5 h-5">
                      <span>수동으로 선택</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="leader-mode-new" value="auto" class="w-5 h-5">
                      <span>자동 설정 (각 조 첫 번째 사람)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="leader-mode-new" value="none" class="w-5 h-5">
                      <span>조장 없음</span>
                    </label>
                  </div>
                  
                  <div id="manual-leader-area-new">
                    <div id="leader-selectors-new" class="space-y-2 max-h-60 overflow-y-auto"></div>
                  </div>
                </div>
              </div>
              
              <div class="px-6 py-4 bg-gray-50 border-t flex gap-3">
                <button type="button" id="group-maker-cancel-btn" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-white hover:border-gray-400 transition-colors font-semibold">
                  <i class="fas fa-times mr-2"></i>취소
                </button>
                <button type="button" id="generate-groups-btn" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all font-semibold shadow-lg">
                  <i class="fas fa-magic mr-2"></i>조 짜기 시작!
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 설정
        setTimeout(() => {
          updateLeaderSelectorsNew(participants, 3);

          // 닫기 버튼 이벤트 리스너
          const closeBtn = document.getElementById("group-maker-close-btn");
          if (closeBtn) {
            closeBtn.addEventListener("click", () => {
              console.log("🔴 닫기 버튼 클릭됨");
              closeGroupMakerModal();
            });
          }

          // 취소 버튼 이벤트 리스너
          const cancelBtn = document.getElementById("group-maker-cancel-btn");
          if (cancelBtn) {
            cancelBtn.addEventListener("click", () => {
              console.log("🔴 취소 버튼 클릭됨");
              closeGroupMakerModal();
            });
          }

          // 모달 배경 클릭으로 닫기
          const modal = document.getElementById("group-maker-modal");
          if (modal) {
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                console.log("🔴 모달 배경 클릭으로 닫기");
                closeGroupMakerModal();
              }
            });
          }

          document
            .getElementById("group-count-new")
            ?.addEventListener("input", (e) => {
              updateLeaderSelectorsNew(
                participants,
                parseInt(e.target.value) || 3,
                true // 선택 정보 보존
              );
            });

          document
            .querySelectorAll('input[name="leader-mode-new"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                const area = document.getElementById("manual-leader-area-new");
                area.style.display =
                  radio.value === "manual" ? "block" : "none";
                if (radio.value === "manual") {
                  updateLeaderSelectorsNew(
                    participants,
                    parseInt(
                      document.getElementById("group-count-new").value
                    ) || 3,
                    true // 선택 정보 보존
                  );
                }
              });
            });

          // 조 짜기 버튼
          document
            .getElementById("generate-groups-btn")
            ?.addEventListener("click", () => {
              console.log("🔵 조 짜기 버튼 클릭됨");

              // 옵셔널 체이닝과 기본값 사용으로 안전하게 처리
              const groupCount =
                parseInt(document.getElementById("group-count-new")?.value) ||
                3;
              const genderBalance =
                document.getElementById("gender-balance-new")?.checked ?? true;
              const collegeMix =
                document.getElementById("college-mix-new")?.checked ?? true;
              const leaderMode =
                document.querySelector('input[name="leader-mode-new"]:checked')
                  ?.value || "none";

              console.log("✅ 조 짜기 설정:", {
                groupCount,
                genderBalance,
                collegeMix,
                leaderMode,
              });

              const groups = createGroupsNew(
                participants,
                groupCount,
                genderBalance,
                collegeMix,
                leaderMode
              );
              closeGroupMakerModal();
              showGroupResultsNew(eventId, groups);
            });
        }, 50);
      };

      // 모달 닫기
      window.closeGroupMakerModal = function () {
        document.getElementById("group-maker-modal")?.remove();
      };

      // 기존 복잡한 조짜기 관련 함수들은 아래에 주석 처리됨 (사용 안함)
      /*
                              <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200">
                                <div class="flex items-center gap-3">
                                  <div class="bg-blue-600 rounded-full p-3">
                                    <i class="fas fa-user-friends text-white text-lg"></i>
                                  </div>
                                  <div>
                                    <p class="text-sm text-blue-600 font-medium">총 참가자</p>
                                    <p class="text-3xl font-bold text-blue-900">${
                                      participants.length
                                    }<span class="text-lg ml-1">명</span></p>
                                  </div>
                                </div>
                </div>

                              <div class="space-y-6">
                                <!-- 1. 조 개수 설정 -->
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-blue-300 transition-all duration-200">
                                  <div class="flex items-center gap-3 mb-4">
                                    <div class="bg-blue-100 rounded-full p-2">
                                      <i class="fas fa-layer-group text-blue-600 text-lg"></i>
                                    </div>
                  <div>
                                      <label class="text-lg font-bold text-gray-800">1단계: 조 개수</label>
                                      <p class="text-sm text-gray-500">몇 개의 조로 나누시겠습니까?</p>
                                    </div>
                                  </div>
                    <div class="relative">
                      <input type="number" id="group-count" min="1" max="${
                        participants.length
                      }" value="3"
                                           class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-200 text-2xl font-bold text-center">
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-6 pointer-events-none">
                                      <span class="text-gray-400 text-lg font-medium">개</span>
                      </div>
                                  </div>
                                  <div class="mt-3 flex items-center gap-2 text-xs text-gray-500">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>권장: ${Math.ceil(
                                      participants.length / 4
                                    )}-${Math.ceil(
            participants.length / 6
          )}개 조 (조당 4-6명)</span>
                    </div>
                  </div>

                                <!-- 2. 성별 배분 -->
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-pink-300 transition-all duration-200">
                                  <div class="flex items-center gap-3 mb-4">
                                    <div class="bg-pink-100 rounded-full p-2">
                                      <i class="fas fa-venus-mars text-pink-600 text-lg"></i>
                                    </div>
                  <div>
                                      <label class="text-lg font-bold text-gray-800">2단계: 성별 배분</label>
                                      <p class="text-sm text-gray-500">성별을 어떻게 배정할까요?</p>
                                    </div>
                                  </div>
                                  <div class="space-y-2">
                                    <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                      <input type="radio" name="gender-ratio" value="balanced" checked class="w-5 h-5 text-green-600 focus:ring-green-500">
                                      <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                          <i class="fas fa-balance-scale text-green-600 text-lg group-hover:scale-110 transition-transform"></i>
                                          <span class="font-bold text-gray-800">균등 배분</span>
                                        </div>
                                        <p class="text-xs text-green-700 mt-1">남녀 비율을 최대한 균등하게 배정합니다</p>
                                      </div>
                    </label>
                                    <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-blue-50 to-sky-50 border-2 border-blue-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                      <input type="radio" name="gender-ratio" value="mixed" class="w-5 h-5 text-blue-600 focus:ring-blue-500">
                                      <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                          <i class="fas fa-random text-blue-600 text-lg group-hover:scale-110 transition-transform"></i>
                                          <span class="font-bold text-gray-800">무작위 섞기</span>
                                        </div>
                                        <p class="text-xs text-blue-700 mt-1">성별을 완전히 무작위로 배정합니다</p>
                                      </div>
                      </label>
                                    <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                      <input type="radio" name="gender-ratio" value="ignore" class="w-5 h-5 text-gray-600 focus:ring-gray-500">
                                      <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                          <i class="fas fa-users text-gray-600 text-lg group-hover:scale-110 transition-transform"></i>
                                          <span class="font-bold text-gray-800">성별 무관</span>
                                        </div>
                                        <p class="text-xs text-gray-700 mt-1">성별을 고려하지 않고 배정합니다</p>
                                      </div>
                      </label>
                    </div>
                  </div>

                                <!-- 3. 단과대별 분배 -->
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-purple-300 transition-all duration-200">
                                  <div class="flex items-center gap-3 mb-4">
                                    <div class="bg-purple-100 rounded-full p-2">
                                      <i class="fas fa-university text-purple-600 text-lg"></i>
                                    </div>
                  <div>
                                      <label class="text-lg font-bold text-gray-800">3단계: 단과대 배분</label>
                                      <p class="text-sm text-gray-500">단과대를 어떻게 배정할까요?</p>
                                    </div>
                                  </div>
                                  <div class="space-y-2">
                                    <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-violet-50 border-2 border-purple-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                      <input type="radio" name="college-mix" value="mixed" checked class="w-5 h-5 text-purple-600 focus:ring-purple-500">
                                      <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                          <i class="fas fa-shuffle text-purple-600 text-lg group-hover:scale-110 transition-transform"></i>
                                          <span class="font-bold text-gray-800">고르게 분배</span>
                                        </div>
                                        <p class="text-xs text-purple-700 mt-1">각 단과대가 골고루 섞이도록 배정합니다</p>
                                      </div>
                    </label>
                                    <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                      <input type="radio" name="college-mix" value="ignore" class="w-5 h-5 text-gray-600 focus:ring-gray-500">
                                      <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                          <i class="fas fa-random text-gray-600 text-lg group-hover:scale-110 transition-transform"></i>
                                          <span class="font-bold text-gray-800">무작위 배정</span>
                                        </div>
                                        <p class="text-xs text-gray-700 mt-1">단과대를 고려하지 않고 무작위 배정합니다</p>
                                      </div>
                      </label>
                    </div>
                  </div>

                                <!-- 4. 조장 설정 (모든 사용자) -->
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-yellow-300 transition-all duration-200">
                                  <div class="flex items-center gap-3 mb-4">
                                    <div class="bg-yellow-100 rounded-full p-2">
                                      <i class="fas fa-crown text-yellow-600 text-lg"></i>
                                    </div>
                  <div>
                                      <label class="text-lg font-bold text-gray-800">4단계: 조장 설정</label>
                                      <p class="text-sm text-gray-500">조장을 어떻게 지정할까요?</p>
                                    </div>
                                  </div>
                                  <div class="space-y-2">
                                    <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                      <input type="radio" name="leader-setting" value="manual" checked class="w-5 h-5 text-yellow-600 focus:ring-yellow-500">
                                      <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                          <i class="fas fa-hand-pointer text-yellow-600 text-lg group-hover:scale-110 transition-transform"></i>
                                          <span class="font-bold text-gray-800">수동 선택</span>
                                        </div>
                                        <p class="text-xs text-yellow-700 mt-1">각 조의 조장을 직접 선택합니다</p>
                                      </div>
                    </label>
                                    <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                      <input type="radio" name="leader-setting" value="auto" class="w-5 h-5 text-orange-600 focus:ring-orange-500">
                                      <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                          <i class="fas fa-magic text-orange-600 text-lg group-hover:scale-110 transition-transform"></i>
                                          <span class="font-bold text-gray-800">자동 설정</span>
                                        </div>
                                        <p class="text-xs text-orange-700 mt-1">학년이 높은 순으로 자동 배정합니다</p>
                                      </div>
                        </label>
                                    <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                      <input type="radio" name="leader-setting" value="none" class="w-5 h-5 text-gray-600 focus:ring-gray-500">
                                      <div class="flex-1">
                                        <div class="flex items-center gap-2">
                                          <i class="fas fa-users text-gray-600 text-lg group-hover:scale-110 transition-transform"></i>
                                          <span class="font-bold text-gray-800">조장 없음</span>
                                        </div>
                                        <p class="text-xs text-gray-700 mt-1">조장을 따로 설정하지 않습니다</p>
                                      </div>
                        </label>
                      </div>
                                  <div id="manual-leader-selection" class="mt-4 space-y-3">
                                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4">
                                      <p class="text-sm text-blue-900 font-bold mb-3 flex items-center gap-2">
                                        <i class="fas fa-info-circle"></i>
                                        <span>각 조의 조장을 선택하세요</span>
                          </p>
                          <div id="leader-selectors" class="space-y-2">
                            <!-- 동적으로 생성될 조장 선택기들 -->
                          </div>
                        </div>
                      </div>
                    </div>

                                <!-- 참가자 목록 (관리자만) -->
                        ${
                          currentUser &&
                          adminList.includes(currentUser.studentId)
                            ? `
                                <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
                                  <div class="flex items-center gap-3 mb-3">
                                    <div class="bg-gray-100 rounded-full p-2">
                                      <i class="fas fa-list text-gray-600 text-lg"></i>
                                    </div>
                                    <label class="text-lg font-bold text-gray-800">참가자 목록</label>
                                  </div>
                                  <div class="max-h-48 overflow-y-auto border-2 border-gray-200 rounded-xl p-3 bg-gray-50">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        ${participants
                          .slice().reverse()
                          .map(
                            (p, idx) => `
                                        <div class="flex items-center justify-between p-2 bg-white rounded-lg text-sm hover:shadow-sm transition-shadow">
                                          <span class="font-medium text-gray-800">${
                                            idx + 1
                                          }. ${p.name}</span>
                                          <span class="text-xs text-gray-500">${
                                            p.gender
                                          } · ${p.college}</span>
                          </div>
                        `
                          )
                          .join("")}
                      </div>
                    </div>
                  </div>
                  `
                            : ""
                        }
                              </div>
                </div>

                            <!-- 푸터 -->
                            <div class="px-6 py-4 bg-gray-50 border-t-2 border-gray-200 flex gap-3">
                  <button type="button" id="group-maker-cancel" 
                                      class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-white hover:border-gray-400 transition-all duration-200 font-semibold">
                    <i class="fas fa-times mr-2"></i>취소
                        </button>
                              <button type="button" id="group-maker-generate"
                                      class="flex-1 bg-gradient-to-r from-purple-600 via-purple-700 to-indigo-600 text-white py-4 px-6 rounded-xl hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-3 font-bold text-lg group">
                                <i class="fas fa-magic text-xl group-hover:rotate-12 transition-transform"></i>
                                <span>조짜기 시작!</span>
                                <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                  </button>
                </div>
              </div>
            </div>
          `;

          // 모달 추가
          document.body.insertAdjacentHTML("beforeend", modalHTML);
          console.log("✅ 조짜기 모달 DOM에 추가 완료");

          // 짧은 지연 후 이벤트 리스너 추가 (DOM 렌더링 완료 대기)
          setTimeout(() => {
            console.log("🔗 이벤트 리스너 연결 중...");
            const closeBtn = document.getElementById("group-maker-close");
            const cancelBtn = document.getElementById("group-maker-cancel");
            const generateBtn = document.getElementById("group-maker-generate");

            console.log("🔍 버튼 요소 확인:", {
              closeBtn: !!closeBtn,
              cancelBtn: !!cancelBtn,
              generateBtn: !!generateBtn,
            });

            if (closeBtn) {
              closeBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log("🔴 닫기 버튼 클릭됨 - 이벤트:", e);
                closeGroupMakerModal();
              });
              console.log("✅ 닫기 버튼 연결 완료");
            } else {
              console.error("❌ 닫기 버튼을 찾을 수 없습니다");
            }

            if (cancelBtn) {
              cancelBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log("🔴 취소 버튼 클릭됨 - 이벤트:", e);
                closeGroupMakerModal();
              });
              console.log("✅ 취소 버튼 연결 완료");
            } else {
              console.error("❌ 취소 버튼을 찾을 수 없습니다");
            }

            if (generateBtn) {
              generateBtn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log("🟢 조짜기 시작 버튼 클릭됨 - 이벤트:", e);
                console.log("🟢 버튼 요소:", generateBtn);
                console.log("🟢 이벤트 ID:", eventId);
                console.log("🟢 참가자 수:", participants.length);
                generateGroups(eventId, participants);
              });
              console.log("✅ 조짜기 시작 버튼 연결 완료");
            } else {
              console.error("❌ 조짜기 시작 버튼을 찾을 수 없습니다");
            }

            console.log("✅ 이벤트 리스너 연결 완료");

            // 조장 관련 이벤트 리스너 추가 (모든 사용자)
            console.log("👨‍💼 조장 관련 기능 활성화");

            // 조 개수 변경 시 조장 선택기 업데이트
            const groupCountInput1 = document.getElementById("group-count");
            if (groupCountInput1) {
              groupCountInput1.addEventListener("input", () => {
                console.log("📊 조 개수 변경됨");
                updateLeaderSelectors(participants);
              });
              console.log("✅ 조 개수 입력 이벤트 연결 완료");
            } else {
              console.error("❌ group-count 입력을 찾을 수 없습니다");
            }

            // 조장 설정 방식 변경 시 UI 업데이트
            const leaderSettingRadios = document.querySelectorAll(
              'input[name="leader-setting"]'
            );
            console.log(
              "👑 조장 설정 라디오 버튼 수:",
              leaderSettingRadios.length
            );
            if (leaderSettingRadios.length > 0) {
              leaderSettingRadios.forEach((radio) => {
                radio.addEventListener("change", () => {
                  console.log("👑 조장 설정 방식 변경됨:", radio.value);
                  updateLeaderSelectionVisibility();
                });
              });
              console.log("✅ 조장 설정 라디오 이벤트 연결 완료");
            } else {
              console.error("❌ 조장 설정 라디오 버튼을 찾을 수 없습니다");
            }

            // 즉시 조장 선택기 강제 생성
            console.log("🔧 조장 선택기 즉시 강제 생성 시작...");
            console.log("🔧 참가자 데이터:", participants);
            console.log("🔧 참가자 수:", participants.length);

            // 즉시 실행
            const createLeaderSelectors = () => {
              const leaderSelectors =
                document.getElementById("leader-selectors");
              const groupCount =
                parseInt(document.getElementById("group-count")?.value) || 3;

              console.log("🔍 leader-selectors 요소:", leaderSelectors);
              console.log("🔍 조 개수:", groupCount);

              if (leaderSelectors) {
                let html = "";
                for (let i = 1; i <= groupCount; i++) {
                  html += `
                                <div class="flex items-center gap-3 bg-white rounded-lg p-3 border-2 border-gray-200 hover:border-yellow-300 transition-colors">
                                  <div class="flex items-center justify-center w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-400 rounded-full text-white font-bold">
                                    ${i}
                                  </div>
                                  <div class="flex-1">
                                    <label class="text-xs text-gray-500 font-medium">${i}조 조장</label>
                                    <select class="leader-select w-full mt-1 px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition-all" data-group="${i}">
                                      <option value="">👉 조장을 선택하세요</option>
                                      ${participants
                                        .map(
                                          (p) =>
                                            `<option value="${p.studentId}">${p.name} (${p.studentId}) - ${p.gender}/${p.college}</option>`
                                        )
                                        .join("")}
                                    </select>
                                  </div>
                                </div>
                              `;
                }

                leaderSelectors.innerHTML = html;
                console.log("✅ 조장 선택기 즉시 생성 완료:", groupCount, "개");
                console.log("🔍 생성된 HTML:", leaderSelectors.innerHTML);
              } else {
                console.error("❌ leader-selectors 요소를 찾을 수 없습니다!");
              }
            };

            // 조장 선택 UI 즉시 초기화 - 먼저 생성하고 visibility 설정
            console.log("🔧 1차 조장 선택기 생성");
            createLeaderSelectors(); // 즉시 생성

            console.log("🔧 2차 조장 선택기 업데이트");
            updateLeaderSelectors(participants);

            console.log("🔧 조장 선택 UI 가시성 업데이트");
            updateLeaderSelectionVisibility();

            // 지연 후 재실행 (안전장치)
            setTimeout(() => {
              console.log("🔧 100ms 후 재생성");
              updateLeaderSelectors(participants);
              updateLeaderSelectionVisibility();
            }, 100);

            setTimeout(() => {
              console.log("🔧 500ms 후 재생성");
              updateLeaderSelectors(participants);
              updateLeaderSelectionVisibility();
            }, 500);

            console.log("✅ 조장 선택기 초기화 완료");

            // 추가 안전장치: 전역 이벤트 위임으로 버튼 클릭 처리
            const globalClickHandler = (e) => {
              const target = e.target.closest(
                "#group-maker-close, #group-maker-cancel, #group-maker-generate"
              );
              if (target) {
                e.preventDefault();
                e.stopPropagation();
                console.log(
                  "🌐 전역 이벤트 위임으로 버튼 클릭 감지:",
                  target.id
                );

                if (
                  target.id === "group-maker-close" ||
                  target.id === "group-maker-cancel"
                ) {
                  console.log("🔴 전역 핸들러로 모달 닫기");
                  closeGroupMakerModal();
                } else if (target.id === "group-maker-generate") {
                  console.log("🟢 전역 핸들러로 조짜기 시작");
                  generateGroups(eventId, participants);
                }
              }
            };

            document.addEventListener("click", globalClickHandler);
            console.log("🌐 전역 이벤트 위임 핸들러 추가 완료");

            // 조 개수 변경 시 조장 선택 UI 업데이트
            const groupCountInput2 = document.getElementById("group-count");
            if (groupCountInput2) {
              groupCountInput2.addEventListener("change", () => {
                console.log("🔄 조 개수 변경 감지, 조장 선택 UI 업데이트");
                updateLeaderSelectors(participants);
                updateLeaderSelectionVisibility();
              });
            }

            // 조장 설정 옵션 변경 시 조장 선택 UI 업데이트
            const leaderSettingInputs = document.querySelectorAll(
              'input[name="leader-setting"]'
            );
            leaderSettingInputs.forEach((input) => {
              input.addEventListener("change", () => {
                console.log("🔄 조장 설정 변경 감지:", input.value);
                updateLeaderSelectionVisibility();
                if (input.value === "manual") {
                  updateLeaderSelectors(participants);
                }
              });
            });

            // 모달 닫기 시 전역 핸들러 제거를 위해 저장
            window.groupMakerGlobalHandler = globalClickHandler;

            // 추가: 모달 배경 클릭으로 닫기
            const modal = document.getElementById("group-maker-modal");
            if (modal) {
              modal.addEventListener("click", (e) => {
                if (e.target === modal) {
                  console.log("🖱️ 모달 배경 클릭으로 닫기");
                  closeGroupMakerModal();
                }
              });
              console.log("✅ 모달 배경 클릭 이벤트 연결 완료");
            }
          }, 100); // 100ms 지연

      */
      // 기존 조짜기 관련 함수들 (주석 처리됨)

      // 조장 선택기 업데이트 - OLD VERSION (사용안함)
      function updateLeaderSelectors_OLD(participants) {
        console.log("🔄 조장 선택기 업데이트 시작", participants.length, "명");
        const groupCountInput3 = document.getElementById("group-count");
        const container = document.getElementById("leader-selectors");

        if (!groupCountInput3) {
          console.error("❌ group-count 요소를 찾을 수 없습니다");
          return;
        }
        if (!container) {
          console.error("❌ leader-selectors 요소를 찾을 수 없습니다");
          return;
        }

        const groupCount = parseInt(groupCountInput3.value) || 3;
        console.log("📊 조장 선택기 생성할 조 개수:", groupCount);

        container.innerHTML = "";
        console.log("🧹 컨테이너 내용 초기화 완료");

        for (let i = 1; i <= groupCount; i++) {
          console.log(`🔧 ${i}조 조장 선택기 생성 중...`);
          const selectorHTML = `
                        <div class="flex items-center gap-3 bg-white rounded-lg p-3 border-2 border-gray-200 hover:border-yellow-300 transition-colors">
                          <div class="flex items-center justify-center w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-400 rounded-full text-white font-bold">
                            ${i}
                          </div>
                          <div class="flex-1">
                            <label class="text-xs text-gray-500 font-medium">${i}조 조장</label>
                            <select class="leader-select w-full mt-1 px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition-all" data-group="${i}">
                              <option value="">👉 조장을 선택하세요</option>
                ${participants
                  .map(
                    (p) => `
                  <option value="${p.studentId}">${p.name} (${p.studentId}) - ${p.gender}/${p.college}</option>
                `
                  )
                  .join("")}
              </select>
                          </div>
            </div>
          `;
          container.insertAdjacentHTML("beforeend", selectorHTML);
          console.log(`✅ ${i}조 조장 선택기 생성 완료`);
        }
        console.log("✅ 조장 선택기 생성 완료:", groupCount, "개");
        console.log("🔍 최종 컨테이너 내용:", container.innerHTML);
      }

      // 조장 선택 UI 표시/숨김 - OLD VERSION (사용안함)
      function updateLeaderSelectionVisibility_OLD() {
        console.log("👁️ 조장 선택 UI 표시/숨김 업데이트");

        // 조장 설정 라디오 버튼 찾기
        const leaderSettingElement = document.querySelector(
          'input[name="leader-setting"]:checked'
        );
        const manualSelection = document.getElementById(
          "manual-leader-selection"
        );

        if (!leaderSettingElement) {
          console.error("❌ leader-setting 요소를 찾을 수 없습니다");
          // 기본값으로 "manual" 설정
          const manualRadio = document.querySelector(
            'input[name="leader-setting"][value="manual"]'
          );
          if (manualRadio) {
            manualRadio.checked = true;
            console.log("🔧 기본값으로 수동 조장 설정 적용");
          }
          return;
        }

        if (!manualSelection) {
          console.error("❌ manual-leader-selection 요소를 찾을 수 없습니다");
          return;
        }

        const leaderSetting = leaderSettingElement.value;
        console.log("👑 현재 조장 설정 모드:", leaderSetting);

        if (leaderSetting === "manual") {
          manualSelection.style.display = "block";
          console.log("✅ 수동 조장 선택 UI 표시");

          // 조장 선택기가 없다면 생성
          const leaderSelectors = document.getElementById("leader-selectors");
          if (leaderSelectors && leaderSelectors.children.length === 0) {
            console.log("🔧 조장 선택기가 비어있어서 재생성");
            // 참가자 데이터를 다시 가져와서 조장 선택기 생성
            const eventId = window.currentGroupMakerEventId;
            if (eventId) {
              const ev = eventsData.find((e) => e.id === eventId);
              if (ev) {
                let participants = [];
                if (ev.type === "tasting") {
                  (ev.restaurants || []).forEach((r) => {
                    (r.reservations || []).forEach((p) => {
                      participants.push({
                        name: p.name || "",
                        studentId: p.studentId || "",
                        gender: p.gender || "",
                        year: p.year || "",
                        college: p.college || "",
                        department: p.department || "",
                        phone: p.phone || "",
                      });
                    });
                  });
                } else {
                  (ev.applicants || []).forEach((p) => {
                    participants.push({
                      name: p.name || "",
                      studentId: p.studentId || "",
                      gender: p.gender || "",
                      year: p.year || "",
                      college: p.college || "",
                      department: p.department || "",
                      phone: p.phone || "",
                    });
                  });
                }
                updateLeaderSelectors(participants);
              }
            }
          }
        } else {
          manualSelection.style.display = "none";
          console.log("✅ 수동 조장 선택 UI 숨김");
        }
      }

      // 조짜기 모달 닫기 - OLD VERSION (사용안함)
      function closeGroupMakerModal_OLD2() {
        console.log("🔴 조짜기 모달 닫기 호출됨");

        // 현재 이벤트 ID 정리
        window.currentGroupMakerEventId = null;

        // 전역 이벤트 핸들러 제거
        if (window.groupMakerGlobalHandler) {
          document.removeEventListener("click", window.groupMakerGlobalHandler);
          delete window.groupMakerGlobalHandler;
          console.log("🌐 전역 이벤트 핸들러 제거 완료");
        }

        const modal = document.getElementById("group-maker-modal");
        if (modal) {
          modal.remove();
          console.log("✅ 조짜기 모달 제거 완료");
        } else {
          console.warn("⚠️ 조짜기 모달을 찾을 수 없습니다");
        }
      }

      // 조 생성하기
      async function generateGroups(eventId, participants) {
        try {
          console.log("🎯 조짜기 시작!", {
            eventId,
            participantsCount: participants.length,
          });

          const groupCountInput5 = document.getElementById("group-count");
          if (!groupCountInput5) {
            console.error("❌ group-count 입력 요소를 찾을 수 없습니다");
            return showAlert("😥", "조 개수 입력란을 찾을 수 없습니다.");
          }

          const groupCount = parseInt(groupCountInput5.value);
          console.log("📊 조 개수:", groupCount);

          if (
            !groupCount ||
            groupCount < 1 ||
            groupCount > participants.length
          ) {
            console.error("❌ 조 개수가 올바르지 않습니다:", groupCount);
            return showAlert(
              "😥",
              `조 개수를 1부터 ${participants.length} 사이로 설정해주세요.`
            );
          }

          const genderRatioElement = document.querySelector(
            'input[name="gender-ratio"]:checked'
          );
          if (!genderRatioElement) {
            console.error("❌ 성별 배분 옵션을 찾을 수 없습니다");
            return showAlert("😥", "성별 배분 옵션을 선택해주세요.");
          }
          const genderRatio = genderRatioElement.value;
          console.log("👫 성별 배분:", genderRatio);

          const collegeMixElement = document.querySelector(
            'input[name="college-mix"]:checked'
          );
          if (!collegeMixElement) {
            console.error("❌ 단과대 배분 옵션을 찾을 수 없습니다");
            return showAlert("😥", "단과대 배분 옵션을 선택해주세요.");
          }
          const collegeMix = collegeMixElement.value;
          console.log("🏛️ 단과대 배분:", collegeMix);

          // 조장 설정 요소 확인 (관리자만 접근 가능)
          const leaderSettingElement = document.querySelector(
            'input[name="leader-setting"]:checked'
          );
          const leaderSetting = leaderSettingElement
            ? leaderSettingElement.value
            : "none";
          console.log("👑 조장 설정:", leaderSetting);

          // 수동 조장 선택 정보 수집
          let manualLeaders = {};
          if (leaderSetting === "manual") {
            const leaderSelects = document.querySelectorAll(".leader-select");
            console.log("👑 조장 선택기 개수:", leaderSelects.length);
            leaderSelects.forEach((select) => {
              const groupNum = parseInt(select.dataset.group);
              const studentId = select.value;
              if (studentId) {
                manualLeaders[groupNum] = studentId;
                console.log(`👑 ${groupNum}조 조장 선택:`, studentId);
              }
            });
            console.log("👑 수동 선택된 조장 목록:", manualLeaders);
          }

          console.log("⚙️ 조 생성 알고리즘 실행 중...");
          // 조 생성 알고리즘
          const groups = createGroups(
            participants,
            groupCount,
            genderRatio,
            collegeMix,
            leaderSetting,
            manualLeaders
          );

          console.log("✅ 조 생성 완료!", {
            groupsCount: groups.length,
            groups,
          });

          // 결과 모달 표시
          showGroupResults(eventId, groups, participants);
        } catch (error) {
          console.error("❌ 조 생성 오류:", error);
          console.error("에러 스택:", error.stack);
          showAlert("😥", `조 생성 중 오류가 발생했습니다: ${error.message}`);
        }
      }

      // 조 생성 알고리즘 - OLD VERSION (사용안함)
      function createGroups_OLD(
        participants,
        groupCount,
        genderRatio,
        collegeMix,
        leaderSetting,
        manualLeaders = {}
      ) {
        let groups = Array.from({ length: groupCount }, () => []);

        // 수동 조장 정보 미리 설정
        if (leaderSetting === "manual") {
          Object.keys(manualLeaders).forEach((groupIndex) => {
            const leaderStudentId = manualLeaders[groupIndex];
            const leader = participants.find(
              (p) => p.studentId === leaderStudentId
            );
            if (leader) {
              leader.isLeader = true;
              leader.targetGroup = parseInt(groupIndex) - 1; // 0-based index
            }
          });
        }

        // 모든 참가자를 조건에 포함하여 균형 배분
        if (genderRatio === "balanced" && collegeMix === "mixed") {
          // 성별과 단과대를 모두 고려한 균형 배분 (조장 포함)
          groups = balanceGroupsByAllFactorsWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else if (genderRatio === "balanced") {
          // 성별만 고려한 균형 배분 (조장 포함)
          groups = balanceGroupsByGenderWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else if (collegeMix === "mixed") {
          // 단과대만 고려한 균형 배분 (조장 포함)
          groups = balanceGroupsByCollegeWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else {
          // 무작위 배분 (조장 포함)
          groups = randomDistributionWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        }

        // 자동 조장 설정
        if (leaderSetting === "auto") {
          groups.forEach((group) => {
            if (group.length > 0 && !group.some((member) => member.isLeader)) {
              // 학년이 높은 순으로 정렬하여 첫 번째를 조장으로 설정
              group.sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                return yearB - yearA;
              });
              group[0].isLeader = true;
            }
          });
        }

        // 조장을 각 조의 맨 앞으로 이동
        groups.forEach((group) => {
          const leader = group.find((member) => member.isLeader);
          if (leader) {
            const leaderIndex = group.indexOf(leader);
            group.splice(leaderIndex, 1);
            group.unshift(leader);
          }
        });

        return groups;
      }

      // 성별과 단과대를 모두 고려한 균형 배분 (조장 포함) - 개선된 알고리즘
      function balanceGroupsByAllFactorsWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        console.log(
          "🔄 성별+단과대 균형 배분 시작",
          participants.length,
          "명,",
          groupCount,
          "조"
        );

        // 1단계: 조장들을 먼저 배치
        const leaders = participants.filter(
          (p) => p.isLeader && p.targetGroup !== undefined
        );
        leaders.forEach((leader) => {
          groups[leader.targetGroup].push(leader);
          console.log(
            `👑 조장 배치: ${leader.name} → ${leader.targetGroup + 1}조`
          );
        });

        // 2단계: 남은 참가자들을 성별과 단과대로 분류
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const categorizedParticipants = {
          male: {},
          female: {},
          other: {},
        };

        remainingParticipants.forEach((p) => {
          const gender =
            p.gender === "남성"
              ? "male"
              : p.gender === "여성"
              ? "female"
              : "other";
          const college = p.college || "기타";

          if (!categorizedParticipants[gender][college]) {
            categorizedParticipants[gender][college] = [];
          }
          categorizedParticipants[gender][college].push(p);
        });

        // 3단계: 각 조의 현재 성별/단과대 구성 확인
        const groupStats = groups.map(() => ({
          male: 0,
          female: 0,
          other: 0,
          colleges: {},
        }));

        groups.forEach((group, groupIndex) => {
          group.forEach((member) => {
            const gender =
              member.gender === "남성"
                ? "male"
                : member.gender === "여성"
                ? "female"
                : "other";
            const college = member.college || "기타";
            groupStats[groupIndex][gender]++;
            if (!groupStats[groupIndex].colleges[college]) {
              groupStats[groupIndex].colleges[college] = 0;
            }
            groupStats[groupIndex].colleges[college]++;
          });
        });

        // 4단계: 성별과 학과별로 균등 배분 (라운드 로빈 방식)
        // 성별별로 분류
        const malesByCollege = {};
        const femalesByCollege = {};
        const othersByCollege = {};

        remainingParticipants.forEach((p) => {
          const college = p.college || "기타";
          const target =
            p.gender === "남성"
              ? malesByCollege
              : p.gender === "여성"
              ? femalesByCollege
              : othersByCollege;
          if (!target[college]) target[college] = [];
          target[college].push(p);
        });

        // 각 학과별 인원을 섞기
        Object.values(malesByCollege).forEach((arr) =>
          arr.sort(() => Math.random() - 0.5)
        );
        Object.values(femalesByCollege).forEach((arr) =>
          arr.sort(() => Math.random() - 0.5)
        );
        Object.values(othersByCollege).forEach((arr) =>
          arr.sort(() => Math.random() - 0.5)
        );

        // 5단계: 학과별, 성별별로 라운드 로빈 배치
        const distributeByCollege = (membersByCollege, genderLabel) => {
          const colleges = Object.keys(membersByCollege);
          colleges.forEach((college) => {
            const members = membersByCollege[college];
            members.forEach((member, idx) => {
              // 라운드 로빈: 각 학과의 사람들을 순서대로 각 조에 배치
              const targetGroup = idx % groupCount;
              groups[targetGroup].push(member);

              // 통계 업데이트
              const gender =
                member.gender === "남성"
                  ? "male"
                  : member.gender === "여성"
                  ? "female"
                  : "other";
              groupStats[targetGroup][gender]++;
              if (!groupStats[targetGroup].colleges[college]) {
                groupStats[targetGroup].colleges[college] = 0;
              }
              groupStats[targetGroup].colleges[college]++;

              console.log(
                `👤 ${member.name} (${member.gender}/${member.college}) → ${
                  targetGroup + 1
                }조 [${genderLabel} 라운드 로빈]`
              );
            });
          });
        };

        // 남성 배치
        distributeByCollege(malesByCollege, "남성");
        // 여성 배치
        distributeByCollege(femalesByCollege, "여성");
        // 기타 성별 배치
        distributeByCollege(othersByCollege, "기타");

        // 6단계: 조 인원 균형 맞추기 (인원 차이가 2명 이상 나면 재배치)
        const maxIterations = 10;
        for (let iter = 0; iter < maxIterations; iter++) {
          const sizes = groups.map((g) => g.length);
          const maxSize = Math.max(...sizes);
          const minSize = Math.min(...sizes);

          if (maxSize - minSize <= 1) break; // 차이가 1 이하면 균형 잡힘

          // 가장 큰 조에서 가장 작은 조로 이동
          const maxGroupIdx = sizes.indexOf(maxSize);
          const minGroupIdx = sizes.indexOf(minSize);

          // 조장이 아닌 마지막 멤버를 이동
          const maxGroup = groups[maxGroupIdx];
          const memberToMove = maxGroup
            .slice()
            .reverse()
            .find((m) => !m.isLeader);

          if (memberToMove) {
            const idx = maxGroup.indexOf(memberToMove);
            maxGroup.splice(idx, 1);
            groups[minGroupIdx].push(memberToMove);
            console.log(
              `⚖️ 균형 조정: ${memberToMove.name} ${maxGroupIdx + 1}조 → ${
                minGroupIdx + 1
              }조`
            );
          }
        }

        console.log("✅ 성별+단과대 균형 배분 완료");
        return groups;
      }

      // 성별과 단과대를 모두 고려한 균형 배분 (기존 함수 - 호환성 유지)
      function balanceGroupsByAllFactors(participants, groups, groupCount) {
        return balanceGroupsByAllFactorsWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // 성별 균형 배분 (조장 포함) - 개선된 알고리즘
      function balanceGroupsByGenderWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        console.log(
          "🔄 성별 균형 배분 시작",
          participants.length,
          "명,",
          groupCount,
          "조"
        );

        // 1단계: 조장들을 먼저 배치
        const leaders = participants.filter(
          (p) => p.isLeader && p.targetGroup !== undefined
        );
        leaders.forEach((leader) => {
          groups[leader.targetGroup].push(leader);
          console.log(
            `👑 조장 배치: ${leader.name} → ${leader.targetGroup + 1}조`
          );
        });

        // 2단계: 각 조의 현재 성별 구성 확인
        const groupStats = groups.map(() => ({
          male: 0,
          female: 0,
          other: 0,
        }));

        groups.forEach((group, groupIndex) => {
          group.forEach((member) => {
            const gender =
              member.gender === "남성"
                ? "male"
                : member.gender === "여성"
                ? "female"
                : "other";
            groupStats[groupIndex][gender]++;
          });
        });

        // 3단계: 남은 참가자들을 성별로 분류
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const maleParticipants = remainingParticipants.filter(
          (p) => p.gender === "남성"
        );
        const femaleParticipants = remainingParticipants.filter(
          (p) => p.gender === "여성"
        );
        const otherParticipants = remainingParticipants.filter(
          (p) => p.gender !== "남성" && p.gender !== "여성"
        );

        // 각 성별 그룹을 섞기
        maleParticipants.sort(() => Math.random() - 0.5);
        femaleParticipants.sort(() => Math.random() - 0.5);
        otherParticipants.sort(() => Math.random() - 0.5);

        // 4단계: 성별 균형을 고려한 라운드 로빈 배치
        const distributeGender = (members, genderLabel) => {
          members.forEach((member, idx) => {
            const targetGroup = idx % groupCount;
            groups[targetGroup].push(member);

            const gender =
              member.gender === "남성"
                ? "male"
                : member.gender === "여성"
                ? "female"
                : "other";
            groupStats[targetGroup][gender]++;

            console.log(
              `👤 ${member.name} (${member.gender}) → ${
                targetGroup + 1
              }조 [${genderLabel} 라운드 로빈]`
            );
          });
        };

        // 남성, 여성, 기타 순서로 라운드 로빈 배치
        distributeGender(maleParticipants, "남성");
        distributeGender(femaleParticipants, "여성");
        distributeGender(otherParticipants, "기타");

        // 5단계: 조 인원 균형 맞추기
        const maxIterations = 10;
        for (let iter = 0; iter < maxIterations; iter++) {
          const sizes = groups.map((g) => g.length);
          const maxSize = Math.max(...sizes);
          const minSize = Math.min(...sizes);

          if (maxSize - minSize <= 1) break;

          const maxGroupIdx = sizes.indexOf(maxSize);
          const minGroupIdx = sizes.indexOf(minSize);

          const maxGroup = groups[maxGroupIdx];
          const memberToMove = maxGroup
            .slice()
            .reverse()
            .find((m) => !m.isLeader);

          if (memberToMove) {
            const idx = maxGroup.indexOf(memberToMove);
            maxGroup.splice(idx, 1);
            groups[minGroupIdx].push(memberToMove);
            console.log(
              `⚖️ 균형 조정: ${memberToMove.name} ${maxGroupIdx + 1}조 → ${
                minGroupIdx + 1
              }조`
            );
          }
        }

        console.log("✅ 성별 균형 배분 완료");
        return groups;
      }

      // 성별 균형 배분 (기존 함수 - 호환성 유지)
      function balanceGroupsByGender(participants, groups, groupCount) {
        return balanceGroupsByGenderWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // 단과대 균형 배분 (조장 포함) - 개선된 알고리즘
      function balanceGroupsByCollegeWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        console.log(
          "🔄 단과대 균형 배분 시작",
          participants.length,
          "명,",
          groupCount,
          "조"
        );

        // 1단계: 조장들을 먼저 배치
        const leaders = participants.filter(
          (p) => p.isLeader && p.targetGroup !== undefined
        );
        leaders.forEach((leader) => {
          groups[leader.targetGroup].push(leader);
          console.log(
            `👑 조장 배치: ${leader.name} → ${leader.targetGroup + 1}조`
          );
        });

        // 2단계: 각 조의 현재 단과대 구성 확인
        const groupStats = groups.map(() => ({
          colleges: {},
        }));

        groups.forEach((group, groupIndex) => {
          group.forEach((member) => {
            const college = member.college || "기타";
            if (!groupStats[groupIndex].colleges[college]) {
              groupStats[groupIndex].colleges[college] = 0;
            }
            groupStats[groupIndex].colleges[college]++;
          });
        });

        // 3단계: 남은 참가자들을 단과대별로 분류
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const collegeGroups = {};
        remainingParticipants.forEach((p) => {
          const college = p.college || "기타";
          if (!collegeGroups[college]) collegeGroups[college] = [];
          collegeGroups[college].push(p);
        });

        // 각 단과대의 참가자들을 섞기
        Object.keys(collegeGroups).forEach((college) => {
          collegeGroups[college].sort(() => Math.random() - 0.5);
        });

        // 4단계: 단과대별 라운드 로빈 배치
        Object.keys(collegeGroups).forEach((college) => {
          const members = collegeGroups[college];
          members.forEach((member, idx) => {
            const targetGroup = idx % groupCount;
            groups[targetGroup].push(member);

            // 통계 업데이트
            if (!groupStats[targetGroup].colleges[college]) {
              groupStats[targetGroup].colleges[college] = 0;
            }
            groupStats[targetGroup].colleges[college]++;

            console.log(
              `👤 ${member.name} (${member.college}) → ${
                targetGroup + 1
              }조 [${college} 라운드 로빈]`
            );
          });
        });

        // 5단계: 조 인원 균형 맞추기
        const maxIterations = 10;
        for (let iter = 0; iter < maxIterations; iter++) {
          const sizes = groups.map((g) => g.length);
          const maxSize = Math.max(...sizes);
          const minSize = Math.min(...sizes);

          if (maxSize - minSize <= 1) break;

          const maxGroupIdx = sizes.indexOf(maxSize);
          const minGroupIdx = sizes.indexOf(minSize);

          const maxGroup = groups[maxGroupIdx];
          const memberToMove = maxGroup
            .slice()
            .reverse()
            .find((m) => !m.isLeader);

          if (memberToMove) {
            const idx = maxGroup.indexOf(memberToMove);
            maxGroup.splice(idx, 1);
            groups[minGroupIdx].push(memberToMove);
            console.log(
              `⚖️ 균형 조정: ${memberToMove.name} ${maxGroupIdx + 1}조 → ${
                minGroupIdx + 1
              }조`
            );
          }
        }

        console.log("✅ 단과대 균형 배분 완료");
        return groups;
      }

      // 단과대 균형 배분 (기존 함수 - 호환성 유지)
      function balanceGroupsByCollege(participants, groups, groupCount) {
        return balanceGroupsByCollegeWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // 무작위 배분 (조장 포함)
      function randomDistributionWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        console.log(
          "🔄 무작위 배분 시작",
          participants.length,
          "명,",
          groupCount,
          "조"
        );

        // 1단계: 조장들을 먼저 배치
        const leaders = participants.filter(
          (p) => p.isLeader && p.targetGroup !== undefined
        );
        leaders.forEach((leader) => {
          groups[leader.targetGroup].push(leader);
          console.log(
            `👑 조장 배치: ${leader.name} → ${leader.targetGroup + 1}조`
          );
        });

        // 2단계: 남은 참가자들을 무작위로 섞기
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const shuffled = [...remainingParticipants].sort(
          () => Math.random() - 0.5
        );

        // 3단계: 조 크기 균형을 고려한 배치
        shuffled.forEach((participant, index) => {
          // 가장 인원이 적은 조에 배치
          let targetGroup = 0;
          let minSize = groups[0].length;

          for (let i = 1; i < groupCount; i++) {
            if (groups[i].length < minSize) {
              minSize = groups[i].length;
              targetGroup = i;
            }
          }

          groups[targetGroup].push(participant);
          console.log(`👤 ${participant.name} → ${targetGroup + 1}조`);
        });

        console.log("✅ 무작위 배분 완료");
        return groups;
      }

      // 무작위 배분 (기존 함수 - 호환성 유지)
      function randomDistribution(participants, groups, groupCount) {
        return randomDistributionWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // 조 결과 표시 모달 - OLD VERSION (사용안함)
      function showGroupResults_OLD(eventId, groups, participants) {
        console.log("🎊 조 결과 모달 표시 시작", {
          eventId,
          groupsCount: groups.length,
          participantsCount: participants.length,
        });
        closeGroupMakerModal();
        console.log("🔴 조짜기 설정 모달 닫기 완료");

        // 각 조의 성별 통계 계산
        const getGroupStats = (group) => {
          const maleCount = group.filter((m) => m.gender === "남성").length;
          const femaleCount = group.filter((m) => m.gender === "여성").length;
          return { maleCount, femaleCount };
        };

        const modalHTML = `
                      <div id="group-results-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                          <!-- 헤더 -->
                          <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-5 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                              <div class="bg-white bg-opacity-20 rounded-full p-3">
                                <i class="fas fa-check-circle text-white text-2xl"></i>
              </div>
                              <div>
                                <h3 class="text-2xl font-bold text-white">조짜기 완료!</h3>
                                <p class="text-green-100 text-sm mt-1">
                                  <i class="fas fa-users mr-1"></i>
                        총 <strong>${
                          participants.length
                        }명</strong>을 <strong>${
          groups.length
        }개 조</strong>로 나누었습니다
                </p>
                              </div>
                            </div>
                            <button type="button" id="group-results-close" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200">
                              <i class="fas fa-times text-2xl"></i>
                            </button>
              </div>

                          <!-- 컨텐츠 영역 -->
                          <div class="overflow-y-auto flex-1 px-6 py-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                ${groups
                  .map((group, index) => {
                    const stats = getGroupStats(group);
                    const colors = [
                      "from-blue-500 to-blue-600",
                      "from-purple-500 to-purple-600",
                      "from-pink-500 to-pink-600",
                      "from-orange-500 to-orange-600",
                      "from-teal-500 to-teal-600",
                      "from-indigo-500 to-indigo-600",
                      "from-red-500 to-red-600",
                      "from-yellow-500 to-yellow-600",
                    ];
                    const color = colors[index % colors.length];

                    return `
                                    <div class="bg-white border-2 border-gray-200 rounded-2xl overflow-hidden hover:shadow-xl transition-all duration-300">
                                      <!-- 조 헤더 -->
                                      <div class="bg-gradient-to-r ${color} px-5 py-4">
                                        <div class="flex items-center justify-between">
                                          <div class="flex items-center gap-3">
                                            <div class="bg-white bg-opacity-30 rounded-full px-4 py-2">
                                              <span class="text-2xl font-bold text-white">${
                                                index + 1
                                              }</span>
                                            </div>
                                            <div>
                                              <h4 class="text-xl font-bold text-white">${
                                                index + 1
                                              }조</h4>
                                              <p class="text-white text-opacity-90 text-sm">총 ${
                                                group.length
                                              }명</p>
                                            </div>
                                          </div>
                                          <div class="flex gap-2">
                                            <div class="bg-white bg-opacity-20 rounded-lg px-3 py-1 text-white text-sm font-medium">
                                              <i class="fas fa-mars mr-1"></i>${
                                                stats.maleCount
                                              }
                                            </div>
                                            <div class="bg-white bg-opacity-20 rounded-lg px-3 py-1 text-white text-sm font-medium">
                                              <i class="fas fa-venus mr-1"></i>${
                                                stats.femaleCount
                                              }
                                            </div>
                                          </div>
                                        </div>
                                      </div>

                                      <!-- 조원 목록 -->
                                      <div class="p-4">
                                        <div class="space-y-2">
                    ${group
                      .map(
                        (member, memberIndex) => `
                                            <div class="flex items-center gap-3 p-3 rounded-xl transition-all duration-200 ${
                                              member.isLeader
                                                ? "bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-300 shadow-md"
                                                : "bg-gray-50 hover:bg-gray-100 border-2 border-transparent"
                                            }">
                                              ${
                                                member.isLeader
                                                  ? `<div class="flex items-center justify-center w-8 h-8 bg-gradient-to-br from-yellow-400 to-orange-400 rounded-full">
                                                       <i class="fas fa-crown text-white text-sm"></i>
                                                     </div>`
                                                  : `<div class="flex items-center justify-center w-8 h-8 bg-gray-300 rounded-full text-gray-700 font-bold text-sm">
                                                       ${memberIndex + 1}
                                                     </div>`
                                              }
                                              <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                  <span class="font-bold text-gray-800">${
                                                    member.name
                                                  }</span>
                                                  ${
                                                    member.isLeader
                                                      ? '<span class="text-xs bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full font-bold">조장</span>'
                                                      : ""
                                                  }
                                                </div>
                                                <p class="text-xs text-gray-500 mt-0.5">
                                                  ${member.studentId} · ${
                          member.gender
                        } · ${member.college}
                                                </p>
                                              </div>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                                      </div>
                                    </div>
                                  `;
                  })
                  .join("")}
                            </div>
              </div>

                          <!-- 푸터 -->
                          <div class="px-6 py-4 bg-gray-50 border-t-2 border-gray-200">
                            <div class="flex flex-col sm:flex-row gap-3">
                <button type="button" id="group-export-excel" 
                                      class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 px-6 rounded-xl hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2 font-semibold group">
                                <i class="fas fa-file-excel text-lg group-hover:scale-110 transition-transform"></i>
                                <span>엑셀 다운로드</span>
                </button>
                <button type="button" id="group-export-csv" 
                                      class="flex-1 bg-gradient-to-r from-blue-600 to-sky-600 text-white py-3 px-6 rounded-xl hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2 font-semibold group">
                                <i class="fas fa-file-csv text-lg group-hover:scale-110 transition-transform"></i>
                                <span>CSV 다운로드</span>
                </button>
                <button type="button" id="group-results-cancel" 
                                      class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-white hover:border-gray-400 transition-all duration-200 font-semibold">
                                <i class="fas fa-times mr-2"></i>닫기
                </button>
                            </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
        console.log("✅ 조 결과 모달 DOM에 추가 완료");

        // 이벤트 리스너 추가
        console.log("🔗 결과 모달 이벤트 리스너 연결 중...");
        const closeBtn = document.getElementById("group-results-close");
        const cancelBtn = document.getElementById("group-results-cancel");
        const excelBtn = document.getElementById("group-export-excel");
        const csvBtn = document.getElementById("group-export-csv");

        if (!closeBtn || !cancelBtn || !excelBtn || !csvBtn) {
          console.error("❌ 결과 모달 버튼 요소를 찾을 수 없습니다", {
            closeBtn,
            cancelBtn,
            excelBtn,
            csvBtn,
          });
        }

        if (closeBtn) {
          closeBtn.addEventListener("click", () => {
            console.log("🔴 결과 모달 닫기 버튼 클릭됨");
            closeGroupResultsModal();
          });
        }
        if (cancelBtn) {
          cancelBtn.addEventListener("click", () => {
            console.log("🔴 결과 모달 닫기 버튼 클릭됨");
            closeGroupResultsModal();
          });
        }
        if (excelBtn) {
          excelBtn.addEventListener("click", () => {
            console.log("📥 엑셀 다운로드 버튼 클릭됨");
            exportGroupsToExcel(eventId, groups, participants);
          });
        }
        if (csvBtn) {
          csvBtn.addEventListener("click", () => {
            console.log("📥 CSV 다운로드 버튼 클릭됨");
            exportGroupsToCSV(eventId, groups, participants);
          });
        }
        console.log("✅ 결과 모달 이벤트 리스너 연결 완료");
        console.log("🎉 조 결과 모달 표시 완료!");
      }

      // 조 결과 모달 닫기
      function closeGroupResultsModal() {
        console.log("🔴 조 결과 모달 닫기 호출됨");
        const modal = document.getElementById("group-results-modal");
        if (modal) {
          modal.remove();
          console.log("✅ 조 결과 모달 제거 완료");
        } else {
          console.warn("⚠️ 조 결과 모달을 찾을 수 없습니다");
        }
      }

      // 엑셀 파일로 조 결과 다운로드
      async function exportGroupsToExcel(eventId, groups, participants) {
        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) return showAlert("😥", "이벤트를 찾을 수 없습니다.");

          // XLSX 라이브러리가 로드되었는지 확인
          if (typeof XLSX === "undefined") {
            return showAlert("😥", "엑셀 라이브러리를 로드할 수 없습니다.");
          }

          // 워크북 생성
          const wb = XLSX.utils.book_new();

          // 간단한 형식으로 데이터 생성 (열: 조, 행: 이름)
          const maxGroupSize = Math.max(...groups.map((group) => group.length));
          const simpleData = [];

          // 헤더 생성 (1조, 2조, 3조...)
          const headers = [];
          for (let i = 1; i <= groups.length; i++) {
            headers.push(`${i}조`);
          }
          simpleData.push(headers);

          // 각 행에 조원 이름들 추가
          for (let row = 0; row < maxGroupSize; row++) {
            const rowData = [];
            groups.forEach((group, groupIndex) => {
              const member = group[row];
              if (member) {
                // 조장은 이름 뒤에 (조장) 표시
                const name = member.isLeader
                  ? `${member.name} (조장)`
                  : member.name;
                rowData.push(name);
              } else {
                rowData.push(""); // 빈 셀
              }
            });
            simpleData.push(rowData);
          }

          // 워크시트 생성
          const ws = XLSX.utils.aoa_to_sheet(simpleData);

          // 열 너비 설정
          ws["!cols"] = groups.map(() => ({ wch: 15 })); // 각 조열의 너비

          // 시트 추가
          XLSX.utils.book_append_sheet(wb, ws, "조구성");

          // 파일 다운로드
          const fileName = `${
            ev.title || "이벤트"
          }_조구성_${getTodayString()}.xlsx`;
          XLSX.writeFile(wb, fileName);

          showAlert("✅", "엑셀 파일이 다운로드되었습니다.");
          closeGroupResultsModal();
        } catch (error) {
          console.error("엑셀 다운로드 오류:", error);
          showAlert("😥", "엑셀 파일 다운로드 중 오류가 발생했습니다.");
        }
      }

      // CSV 파일로 조 결과 다운로드
      async function exportGroupsToCSV(eventId, groups, participants) {
        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) return showAlert("😥", "이벤트를 찾을 수 없습니다.");

          let csvContent = "";

          // 간단한 형식으로 CSV 생성 (열: 조, 행: 이름)
          const maxGroupSize = Math.max(...groups.map((group) => group.length));

          // 헤더 생성 (1조, 2조, 3조...)
          const headers = [];
          for (let i = 1; i <= groups.length; i++) {
            headers.push(`${i}조`);
          }
          csvContent += headers.join(",") + "\n";

          // 각 행에 조원 이름들 추가
          for (let row = 0; row < maxGroupSize; row++) {
            const rowData = [];
            groups.forEach((group, groupIndex) => {
              const member = group[row];
              if (member) {
                // 조장은 이름 뒤에 (조장) 표시
                const name = member.isLeader
                  ? `${member.name} (조장)`
                  : member.name;
                rowData.push(name);
              } else {
                rowData.push(""); // 빈 셀
              }
            });
            csvContent += rowData.join(",") + "\n";
          }

          // CSV 파일 다운로드
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);

          const fileName = `${
            ev.title || "이벤트"
          }_조구성_${getTodayString()}.csv`;
          link.setAttribute("download", fileName);
          link.style.visibility = "hidden";

          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          URL.revokeObjectURL(url);

          showAlert("✅", "CSV 파일이 다운로드되었습니다.");
          closeGroupResultsModal();
        } catch (error) {
          console.error("CSV 다운로드 오류:", error);
          showAlert("😥", "CSV 파일 다운로드 중 오류가 발생했습니다.");
        }
      }

      async function exportApplicantsXLSX(id) {
        try {
          const ev = eventsData.find((e) => e.id === id);
          if (!ev) return showAlert("😥", "이벤트를 찾을 수 없습니다.");
          let rows = [],
            header = [];

          if (ev.type === "tasting") {
            header = [
              "구분",
              "식당",
              "이름",
              "학번",
              "성별",
              "학년",
              "단과대",
              "학과",
              "전화번호",
              "비고",
            ];
            (ev.restaurants || []).forEach((r) => {
              (r.reservations || []).forEach((p) =>
                rows.push({
                  구분: "참가",
                  식당: r.name || "",
                  이름: p.name || "",
                  학번: p.studentId || "",
                  성별: p.gender || "",
                  학년: p.year || "",
                  단과대: p.college || "",
                  학과: p.department || "",
                  전화번호: p.phone || "",
                  비고: "",
                })
              );
              (r.waiting || []).forEach((p) =>
                rows.push({
                  구분: "대기",
                  식당: r.name || "",
                  이름: p.name || "",
                  학번: p.studentId || "",
                  성별: p.gender || "",
                  학년: p.year || "",
                  단과대: p.college || "",
                  학과: p.department || "",
                  전화번호: p.phone || "",
                  비고: "",
                })
              );
            });
          } else if (ev.type === "mt" || ev.type === "assembly") {
            header = [
              "구분",
              "이름",
              "학번",
              "성별",
              "학년",
              "단과대",
              "학과",
              "전화번호",
              "비고",
            ];
            (ev.applicants || []).forEach((p) =>
              rows.push({
                구분: "참가",
                이름: p.name || "",
                학번: p.studentId || "",
                성별: p.gender || "",
                학년: p.year || "",
                단과대: p.college || "",
                학과: p.department || "",
                전화번호: p.phone || "",
                비고: "",
              })
            );
            (ev.waiting || []).forEach((p) =>
              rows.push({
                구분: "대기",
                이름: p.name || "",
                학번: p.studentId || "",
                성별: p.gender || "",
                학년: p.year || "",
                단과대: p.college || "",
                학과: p.department || "",
                전화번호: p.phone || "",
                비고: "",
              })
            );
          } else {
            header = [
              "구분",
              "이름",
              "학번",
              "성별",
              "학년",
              "단과대",
              "학과",
              "전화번호",
              "비고",
            ];
            (ev.applicants || []).forEach((p) =>
              rows.push({
                구분: "참가",
                이름: p.name || "",
                학번: p.studentId || "",
                성별: p.gender || "",
                학년: p.year || "",
                단과대: p.college || "",
                학과: p.department || "",
                전화번호: p.phone || "",
                비고: "",
              })
            );
            (ev.waiting || []).forEach((p) =>
              rows.push({
                구분: "대기",
                이름: p.name || "",
                학번: p.studentId || "",
                성별: p.gender || "",
                학년: p.year || "",
                단과대: p.college || "",
                학과: p.department || "",
                전화번호: p.phone || "",
                비고: "",
              })
            );
          }
          if (rows.length === 0)
            rows = [
              {
                구분: "-",
                이름: "-",
                학번: "-",
                성별: "-",
                학년: "-",
                단과대: "-",
                학과: "-",
                전화번호: "-",
                비고: "",
              },
            ];

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(rows, { header });
          XLSX.utils.book_append_sheet(wb, ws, "명단");
          const fname = `${ev.title || "event"}_명단.xlsx`;
          XLSX.writeFile(wb, fname);
        } catch (e) {
          console.warn(e);
          showAlert("😥", "다운로드 실패");
        }
      }

      /* ===== 엑셀 파일 업로드 및 회원 관리 ===== */

      // 파일 업로드 이벤트 리스너
      document.addEventListener("click", (e) => {
        if (e.target.id === "excel-upload-btn") {
          document.getElementById("excel-upload").click();
        }

        if (e.target.id === "download-template") {
          downloadExcelTemplate();
        }

        if (e.target.closest("#file-drop-zone")) {
          document.getElementById("excel-upload").click();
        }
      });

      document.addEventListener("change", (e) => {
        if (e.target.id === "excel-upload") {
          const file = e.target.files[0];
          if (file) {
            handleFileUpload(file);
          }
        }
      });

      // 드래그 앤 드롭 이벤트 리스너
      document.addEventListener("dragover", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.add("border-green-400", "bg-green-50");
        }
      });

      document.addEventListener("dragleave", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.remove("border-green-400", "bg-green-50");
        }
      });

      document.addEventListener("drop", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.remove("border-green-400", "bg-green-50");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFileUpload(files[0]);
          }
        }
      });

      // 엑셀 템플릿 다운로드
      function downloadExcelTemplate() {
        try {
          const templateData = [
            [
              "이름",
              "학번",
              "성별",
              "학년",
              "단과대",
              "학과",
              "전화번호",
              "상태",
            ],
            [
              "홍길동",
              "20241234",
              "남",
              "1",
              "공과대학",
              "컴퓨터공학과",
              "010-1234-5678",
              "승인",
            ],
            [
              "김영희",
              "20245678",
              "여",
              "2",
              "인문대학",
              "영어영문학과",
              "010-9876-5432",
              "대기",
            ],
          ];

          const ws = XLSX.utils.aoa_to_sheet(templateData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "회원정보");

          XLSX.writeFile(wb, "회원정보_템플릿.xlsx");
          showAlert("✅", "엑셀 템플릿이 다운로드되었습니다.");
        } catch (error) {
          console.error("템플릿 다운로드 오류:", error);
          showAlert("😥", "템플릿 다운로드에 실패했습니다.");
        }
      }

      // 파일 처리 (Excel/CSV)
      async function handleFileUpload(file) {
        const progressDiv = document.getElementById("upload-progress");
        const resultDiv = document.getElementById("upload-result");

        try {
          // 파일 크기 검증 (10MB 제한)
          if (file.size > 10 * 1024 * 1024) {
            throw new Error("파일 크기가 너무 큽니다. (최대 10MB)");
          }

          // 파일 형식 검증
          const fileName = file.name.toLowerCase();
          if (
            !fileName.endsWith(".xlsx") &&
            !fileName.endsWith(".xls") &&
            !fileName.endsWith(".csv")
          ) {
            throw new Error(
              "지원되지 않는 파일 형식입니다. (.xlsx, .xls, .csv만 지원)"
            );
          }

          // 진행 상태 표시
          progressDiv.classList.remove("hidden");
          resultDiv.classList.add("hidden");

          // 파일 읽기
          const data = await readFile(file);
          console.log("파일 데이터:", data);

          if (!data || data.length < 2) {
            throw new Error("파일에 유효한 데이터가 없습니다.");
          }

          // 데이터 검증
          const validationResult = validateFileData(data);
          console.log("검증 결과:", validationResult);

          if (!validationResult.isValid) {
            throw new Error(
              `데이터 검증 실패: ${validationResult.errors.join(", ")}`
            );
          }

          // 변경사항 분석
          const analysis = analyzeMemberData(data);
          console.log("변경사항 분석:", analysis);

          // 진행 상태 숨기기
          progressDiv.classList.add("hidden");

          // 변경사항이 있으면 확인 모달 표시
          if (analysis.changes.length > 0 || analysis.newMembers.length > 0) {
            showChangeConfirmationModal(analysis, data);
          } else {
            showAlert("ℹ️", "변경사항이 없습니다.");
          }
        } catch (error) {
          console.error("파일 업로드 오류:", error);

          // 진행 상태 숨기기
          progressDiv.classList.add("hidden");

          // 오류 알림
          showAlert("😥", `파일 업로드 실패: ${error.message}`);
        } finally {
          // 파일 입력 초기화
          const fileInput = document.getElementById("excel-upload");
          if (fileInput) {
            fileInput.value = "";
          }
        }
      }

      // 파일 읽기 (Excel/CSV)
      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const fileName = file.name.toLowerCase();

              if (fileName.endsWith(".csv")) {
                // CSV 파일 처리
                const csvText = e.target.result;
                const lines = csvText.split("\n");
                const data = lines.map((line) => {
                  // CSV 파싱 (쉼표 구분, 따옴표 처리)
                  const result = [];
                  let current = "";
                  let inQuotes = false;

                  for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                      inQuotes = !inQuotes;
                    } else if (char === "," && !inQuotes) {
                      result.push(current.trim());
                      current = "";
                    } else {
                      current += char;
                    }
                  }
                  result.push(current.trim());
                  return result;
                });
                resolve(data);
              } else {
                // Excel 파일 처리
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                  header: 1,
                });
                resolve(jsonData);
              }
            } catch (error) {
              reject(new Error("파일을 읽을 수 없습니다."));
            }
          };
          reader.onerror = () => reject(new Error("파일 읽기에 실패했습니다."));

          if (file.name.toLowerCase().endsWith(".csv")) {
            reader.readAsText(file, "UTF-8");
          } else {
            reader.readAsArrayBuffer(file);
          }
        });
      }

      // 파일 데이터 검증 (유연한 파싱)
      function validateFileData(data) {
        const warnings = [];
        const errors = [];

        if (!data || data.length < 2) {
          errors.push("파일에 데이터가 없습니다.");
          return { isValid: false, errors, warnings };
        }

        // 헤더 매핑 (유연한 컬럼 인식)
        const headers = data[0];
        const headerMapping = findHeaderMapping(headers);

        if (headerMapping.name === -1 || headerMapping.studentId === -1) {
          errors.push("이름과 학번 컬럼을 찾을 수 없습니다.");
        }

        // 경고 메시지 추가
        if (headerMapping.gender === -1)
          warnings.push("성별 컬럼을 찾을 수 없습니다.");
        if (headerMapping.year === -1)
          warnings.push("학년 컬럼을 찾을 수 없습니다.");
        if (headerMapping.college === -1)
          warnings.push("단과대 컬럼을 찾을 수 없습니다.");
        if (headerMapping.department === -1)
          warnings.push("학과 컬럼을 찾을 수 없습니다.");
        if (headerMapping.phone === -1)
          warnings.push("전화번호 컬럼을 찾을 수 없습니다.");
        if (headerMapping.status === -1)
          warnings.push("상태 컬럼을 찾을 수 없습니다.");

        return {
          isValid: errors.length === 0,
          errors,
          warnings,
          headerMapping,
        };
      }

      // 헤더 매핑 찾기 (유연한 컬럼 인식)
      function findHeaderMapping(headers) {
        const mapping = {
          name: -1,
          studentId: -1,
          gender: -1,
          year: -1,
          college: -1,
          department: -1,
          phone: -1,
          status: -1,
        };

        headers.forEach((header, index) => {
          const headerLower = header?.toString().toLowerCase().trim();

          if (headerLower?.includes("이름") || headerLower?.includes("name")) {
            mapping.name = index;
          } else if (
            headerLower?.includes("학번") ||
            headerLower?.includes("student") ||
            headerLower?.includes("id")
          ) {
            mapping.studentId = index;
          } else if (
            headerLower?.includes("성별") ||
            headerLower?.includes("gender")
          ) {
            mapping.gender = index;
          } else if (
            headerLower?.includes("학년") ||
            headerLower?.includes("year") ||
            headerLower?.includes("grade")
          ) {
            mapping.year = index;
          } else if (
            headerLower?.includes("단과대") ||
            headerLower?.includes("college")
          ) {
            mapping.college = index;
          } else if (
            headerLower?.includes("학과") ||
            headerLower?.includes("department") ||
            headerLower?.includes("major")
          ) {
            mapping.department = index;
          } else if (
            headerLower?.includes("전화") ||
            headerLower?.includes("phone") ||
            headerLower?.includes("연락처")
          ) {
            mapping.phone = index;
          } else if (
            headerLower?.includes("상태") ||
            headerLower?.includes("status")
          ) {
            mapping.status = index;
          }
        });

        return mapping;
      }

      // 회원 데이터 분석 (변경사항 프리뷰)
      function analyzeMemberData(data) {
        const headers = data[0];
        const rows = data.slice(1);
        const headerMapping = findHeaderMapping(headers);

        const changes = [];
        const newMembers = [];
        const errors = [];

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          try {
            // 유연한 데이터 추출
            const memberData = {
              name:
                headerMapping.name !== -1
                  ? row[headerMapping.name]?.toString().trim()
                  : "",
              studentId:
                headerMapping.studentId !== -1
                  ? row[headerMapping.studentId]?.toString().trim()
                  : "",
              gender:
                headerMapping.gender !== -1
                  ? row[headerMapping.gender]?.toString().trim()
                  : "",
              year:
                headerMapping.year !== -1
                  ? row[headerMapping.year]?.toString().trim()
                  : "",
              college:
                headerMapping.college !== -1
                  ? row[headerMapping.college]?.toString().trim()
                  : "",
              department:
                headerMapping.department !== -1
                  ? row[headerMapping.department]?.toString().trim()
                  : "",
              phone:
                headerMapping.phone !== -1
                  ? row[headerMapping.phone]?.toString().trim()
                  : "",
              status:
                headerMapping.status !== -1
                  ? row[headerMapping.status]?.toString().trim()
                  : "",
            };

            // 필수 필드 확인
            if (!memberData.name || !memberData.studentId) {
              errors.push(`${i + 2}번째 행: 이름과 학번은 필수입니다.`);
              continue;
            }

            // 상태값 변환 (한국어 → 영어)
            const convertedStatus = convertStatusToEnglish(memberData.status);

            // 기존 회원 확인
            const existingMember = membersData.find(
              (m) => m.studentId === memberData.studentId
            );

            if (existingMember) {
              // 변경사항 확인
              const changeDetails = [];

              if (memberData.name && memberData.name !== existingMember.name) {
                changeDetails.push({
                  field: "이름",
                  old: existingMember.name,
                  new: memberData.name,
                });
              }
              if (
                memberData.gender &&
                memberData.gender !== existingMember.gender
              ) {
                changeDetails.push({
                  field: "성별",
                  old: existingMember.gender,
                  new: memberData.gender,
                });
              }
              if (memberData.year && memberData.year !== existingMember.year) {
                changeDetails.push({
                  field: "학년",
                  old: existingMember.year,
                  new: memberData.year,
                });
              }
              if (
                memberData.college &&
                memberData.college !== existingMember.college
              ) {
                changeDetails.push({
                  field: "단과대",
                  old: existingMember.college,
                  new: memberData.college,
                });
              }
              if (
                memberData.department &&
                memberData.department !== existingMember.department
              ) {
                changeDetails.push({
                  field: "학과",
                  old: existingMember.department,
                  new: memberData.department,
                });
              }
              if (
                memberData.phone &&
                memberData.phone !== existingMember.phone
              ) {
                changeDetails.push({
                  field: "전화번호",
                  old: existingMember.phone,
                  new: memberData.phone,
                });
              }

              // 상태는 활동중이 아닌 경우에만 변경 가능하도록 표시
              if (
                convertedStatus &&
                convertedStatus !== existingMember.status
              ) {
                const statusDisplay = {
                  active: "활동중",
                  pending: "승인대기",
                  rejected: "거절됨",
                  blocked: "차단됨",
                };
                changeDetails.push({
                  field: "상태",
                  old:
                    statusDisplay[existingMember.status] ||
                    existingMember.status,
                  new: statusDisplay[convertedStatus] || convertedStatus,
                  warning:
                    existingMember.status === "active"
                      ? "⚠️ 활동중 회원의 상태 변경"
                      : null,
                });
              }

              if (changeDetails.length > 0) {
                changes.push({
                  studentId: existingMember.studentId,
                  name: existingMember.name,
                  currentStatus: existingMember.status,
                  changes: changeDetails,
                  existingMember: existingMember,
                  newData: memberData,
                  convertedStatus: convertedStatus,
                });
              }
            } else {
              // 새 회원
              newMembers.push({
                ...memberData,
                status: convertedStatus || "pending",
              });
            }
          } catch (error) {
            errors.push(`${i + 2}번째 행 처리 오류: ${error.message}`);
          }
        }

        return { changes, newMembers, errors };
      }

      // 회원 데이터 처리 (승인된 변경사항만 적용)
      async function processMemberData(data, approvedChanges = []) {
        let updatedCount = 0;
        let newCount = 0;
        let errorCount = 0;
        const errors = [];

        const batch = writeBatch(db);

        // 승인된 변경사항 적용
        for (const change of approvedChanges) {
          try {
            const updateData = { lastUpdated: new Date().toISOString() };

            // 승인된 변경사항만 적용
            for (const detail of change.changes) {
              const fieldMap = {
                이름: "name",
                성별: "gender",
                학년: "year",
                단과대: "college",
                학과: "department",
                전화번호: "phone",
                상태: "status",
              };

              const dbField = fieldMap[detail.field];
              if (dbField === "status") {
                updateData[dbField] = change.convertedStatus;
              } else {
                updateData[dbField] = detail.new;
              }
            }

            const memberRef = doc(db, "members", change.existingMember.id);
            batch.update(memberRef, updateData);
            updatedCount++;
          } catch (error) {
            errors.push(
              `${change.name} (${change.studentId}) 업데이트 오류: ${error.message}`
            );
            errorCount++;
          }
        }

        try {
          await batch.commit();
          return {
            success: true,
            updatedCount,
            newCount,
            errorCount,
            errors,
          };
        } catch (error) {
          console.error("배치 처리 오류:", error);
          throw new Error(`데이터베이스 저장 실패: ${error.message}`);
        }
      }

      // 변경사항 확인 모달 표시
      function showChangeConfirmationModal(analysis, originalData) {
        const { changes, newMembers, errors } = analysis;

        const modalHTML = `
          <div id="change-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
              <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4 flex justify-between items-center">
                <div>
                  <h3 class="text-2xl font-bold text-white">변경사항 확인</h3>
                  <p class="text-orange-100 text-sm">변경사항을 검토하고 적용할 항목을 선택하세요</p>
                </div>
                <button type="button" onclick="document.getElementById('change-confirmation-modal').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
              
              <div class="p-6 overflow-y-auto flex-1">
                ${
                  changes.length > 0
                    ? `
                  <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                      <h4 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-edit mr-2 text-blue-600"></i>기존 회원 변경사항 (${
                          changes.length
                        }건)
                      </h4>
                      <div class="flex gap-2">
                        <button onclick="selectAllChanges(true)" class="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">전체 선택</button>
                        <button onclick="selectAllChanges(false)" class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">전체 해제</button>
                      </div>
                    </div>
                    <div class="space-y-3">
                      ${changes
                        .map(
                          (change, idx) => `
                        <div class="border-2 rounded-lg p-4 ${
                          change.currentStatus === "active"
                            ? "border-green-200 bg-green-50"
                            : "border-gray-200 bg-white"
                        }">
                          <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" class="change-checkbox mt-1 w-5 h-5" data-change-index="${idx}" checked>
                            <div class="flex-1">
                              <div class="font-bold text-gray-800 mb-1">
                                ${saf(change.name)} (${saf(change.studentId)})
                                ${
                                  change.currentStatus === "active"
                                    ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">활동중</span>'
                                    : ""
                                }
                              </div>
                              <div class="text-sm space-y-1">
                                ${change.changes
                                  .map(
                                    (detail) => `
                                  <div class="flex items-center gap-2">
                                    <span class="text-gray-600">${
                                      detail.field
                                    }:</span>
                                    <span class="line-through text-gray-400">${saf(
                                      detail.old || "없음"
                                    )}</span>
                                    <i class="fas fa-arrow-right text-xs text-gray-400"></i>
                                    <span class="font-semibold ${
                                      detail.warning
                                        ? "text-red-600"
                                        : "text-blue-600"
                                    }">${saf(detail.new)}</span>
                                    ${
                                      detail.warning
                                        ? `<span class="text-xs text-red-500">${detail.warning}</span>`
                                        : ""
                                    }
                                  </div>
                                `
                                  )
                                  .join("")}
                              </div>
                            </div>
                          </label>
                        </div>
                      `
                        )
                        .join("")}
                    </div>
                  </div>
                `
                    : ""
                }

                ${
                  newMembers.length > 0
                    ? `
                  <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">
                      <i class="fas fa-user-plus mr-2 text-green-600"></i>새 회원 추가 (${
                        newMembers.length
                      }명)
                    </h4>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                      <p class="text-sm text-green-700 mb-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        새 회원은 모두 <strong>승인대기</strong> 상태로 추가됩니다.
                      </p>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        ${newMembers
                          .map(
                            (m) => `
                          <div class="bg-white p-2 rounded border border-green-200">
                            <span class="font-semibold">${saf(m.name)}</span>
                            <span class="text-gray-600 ml-1">(${saf(
                              m.studentId
                            )})</span>
                          </div>
                        `
                          )
                          .join("")}
                      </div>
                    </div>
                  </div>
                `
                    : ""
                }

                ${
                  errors.length > 0
                    ? `
                  <div class="mb-4">
                    <h4 class="text-lg font-bold text-red-800 mb-3">
                      <i class="fas fa-exclamation-triangle mr-2"></i>오류 (${
                        errors.length
                      }건)
                    </h4>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-sm text-red-700 space-y-1">
                      ${errors.map((err) => `<div>• ${err}</div>`).join("")}
                    </div>
                  </div>
                `
                    : ""
                }
              </div>
              
              <div class="px-6 py-4 bg-gray-50 border-t flex gap-3">
                <button type="button" onclick="document.getElementById('change-confirmation-modal').remove()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-white font-semibold">
                  <i class="fas fa-times mr-2"></i>취소
                </button>
                <button type="button" onclick="applySelectedChanges()" class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-xl hover:from-orange-600 hover:to-orange-700 font-semibold shadow-lg">
                  <i class="fas fa-check mr-2"></i>선택한 변경사항 적용
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 전역 변수에 저장 (applySelectedChanges에서 사용)
        window.__pendingChanges = changes;
        window.__pendingNewMembers = newMembers;
      }

      // 전체 선택/해제
      window.selectAllChanges = function (select) {
        document.querySelectorAll(".change-checkbox").forEach((cb) => {
          cb.checked = select;
        });
      };

      // 선택한 변경사항 적용
      window.applySelectedChanges = async function () {
        const selectedIndexes = [
          ...document.querySelectorAll(".change-checkbox:checked"),
        ].map((cb) => parseInt(cb.dataset.changeIndex));

        const selectedChanges = window.__pendingChanges.filter((_, idx) =>
          selectedIndexes.includes(idx)
        );

        if (
          selectedChanges.length === 0 &&
          (!window.__pendingNewMembers ||
            window.__pendingNewMembers.length === 0)
        ) {
          showAlert("ℹ️", "적용할 변경사항이 없습니다.");
          return;
        }

        // 확인 메시지
        const confirmMsg = `
총 ${selectedChanges.length}명의 회원 정보 변경
${window.__pendingNewMembers.length}명의 새 회원 추가

적용하시겠습니까?
        `.trim();

        if (!confirm(confirmMsg)) return;

        try {
          // 로딩 표시
          const modal = document.getElementById("change-confirmation-modal");
          modal.querySelector(".px-6.py-4.bg-gray-50").innerHTML = `
            <div class="text-center py-4">
              <i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i>
              <p class="mt-2 text-gray-600">변경사항 적용 중...</p>
            </div>
          `;

          // 변경사항 적용
          const batch = writeBatch(db);

          // 기존 회원 업데이트
          for (const change of selectedChanges) {
            const updateData = { lastUpdated: new Date().toISOString() };

            for (const detail of change.changes) {
              const fieldMap = {
                이름: "name",
                성별: "gender",
                학년: "year",
                단과대: "college",
                학과: "department",
                전화번호: "phone",
                상태: "status",
              };

              const dbField = fieldMap[detail.field];
              if (dbField === "status") {
                updateData[dbField] = change.convertedStatus;
              } else {
                updateData[dbField] = detail.new;
              }
            }

            const memberRef = doc(db, "members", change.existingMember.id);
            batch.update(memberRef, updateData);
          }

          // 새 회원 추가
          for (const newMember of window.__pendingNewMembers) {
            const memberRef = doc(db, "members", newMember.studentId);
            batch.set(memberRef, {
              ...newMember,
              status: "pending", // 새 회원은 항상 대기 상태
              createdAt: new Date().toISOString(),
              lastUpdated: new Date().toISOString(),
            });
          }

          await batch.commit();

          // 성공 알림
          showAlert(
            "✅",
            `${selectedChanges.length}명 업데이트, ${window.__pendingNewMembers.length}명 추가되었습니다.`
          );

          // 모달 닫기
          modal.remove();

          // 전역 변수 정리
          delete window.__pendingChanges;
          delete window.__pendingNewMembers;
        } catch (error) {
          console.error("변경사항 적용 오류:", error);
          showAlert("😥", `적용 실패: ${error.message}`);
        }
      };

      // 상태값 변환 (한국어 → 영어)
      function convertStatusToEnglish(status) {
        if (!status) return null;

        const statusLower = status.toLowerCase().trim();

        if (statusLower.includes("승인") || statusLower === "active") {
          return "active";
        } else if (statusLower.includes("대기") || statusLower === "pending") {
          return "pending";
        } else if (statusLower.includes("거절") || statusLower === "rejected") {
          return "rejected";
        } else if (statusLower.includes("차단") || statusLower === "blocked") {
          return "blocked";
        }

        return null;
      }

      // 업로드 결과 표시
      function showUploadResult(result) {
        const resultDiv = document.getElementById("upload-result");

        let resultHTML = `
          <div class="bg-green-100 border border-green-300 rounded p-4">
            <h5 class="font-semibold text-green-800 mb-2">
              <i class="fas fa-check-circle mr-2"></i>엑셀 업로드 완료
            </h5>
            <div class="text-sm text-green-700 space-y-1">
              <p>✅ 업데이트된 회원: ${result.updatedCount}명</p>
              <p>🆕 새로 추가된 회원: ${result.newCount}명</p>
              ${
                result.errorCount > 0
                  ? `<p>❌ 처리 실패: ${result.errorCount}건</p>`
                  : ""
              }
            </div>
        `;

        if (result.errors && result.errors.length > 0) {
          resultHTML += `
            <details class="mt-3">
              <summary class="cursor-pointer text-sm font-medium text-green-800">오류 상세 보기</summary>
              <div class="mt-2 text-xs text-green-600 bg-green-50 p-2 rounded">
                ${result.errors
                  .map((error) => `<div>• ${error}</div>`)
                  .join("")}
              </div>
            </details>
          `;
        }

        resultHTML += `</div>`;
        resultDiv.innerHTML = resultHTML;
        resultDiv.classList.remove("hidden");

        // 회원 목록 업데이트 (Firebase 실시간 업데이트 활용)
        setTimeout(() => {
          try {
            // 관리자 대시보드가 열려있고 회원 관리 탭이 활성화되어 있으면 새로고침
            const dashboardTab = document.getElementById("dashboard-tab");
            const subtabContainer = document.getElementById("subtab-container");

            if (
              dashboardTab &&
              subtabContainer &&
              dashboardTab.innerHTML.includes("회원 관리")
            ) {
              // 현재 활성화된 탭이 회원 관리인지 확인
              const activeTab = document.querySelector(
                ".subtab-btn.bg-gray-800"
              );
              if (activeTab && activeTab.dataset.sub === "members") {
                renderMembersAdmin(subtabContainer);
              }
            }
          } catch (error) {
            console.error("회원 목록 업데이트 오류:", error);
            // 오류 발생 시에만 페이지 새로고침
            location.reload();
          }
        }, 2000);
      }

      /* ===================== 디버깅 함수 ===================== */
      // Firebase 데이터베이스 디버깅 함수
      window.debugFirebaseData = async function () {
        console.log("=== Firebase 데이터베이스 디버깅 시작 ===");

        try {
          // members 컬렉션 확인
          const membersSnapshot = await getDocs(collection(db, "members"));
          console.log("=== Members 컬렉션 ===");
          console.log("총 회원 수:", membersSnapshot.docs.length);

          membersSnapshot.docs.forEach((doc, index) => {
            const data = doc.data();
            console.log(`${index + 1}. ID: ${doc.id}`);
            console.log(`   데이터:`, data);

            // 우테코 사용자 찾기
            if (data.name === "우테코" || data.studentId === "20251010") {
              console.log("🚨 우테코 사용자 발견!");
              console.log("문서 ID:", doc.id);
              console.log("전체 데이터:", data);
            }
          });

          // admins 컬렉션 확인
          const adminsDoc = await getDoc(doc(db, "admins", "list"));
          console.log("\n=== Admins 컬렉션 ===");
          if (adminsDoc.exists()) {
            const adminData = adminsDoc.data();
            console.log("관리자 목록:", adminData.studentIds || []);
            console.log("직책 정보:", adminData.positions || {});

            // 우테코가 관리자인지 확인
            if (adminData.studentIds?.includes("20251010")) {
              console.log("🚨 우테코가 관리자 목록에 있음!");
            }
          } else {
            console.log("admins/list 문서가 존재하지 않음");
          }

          // 현재 로컬 상태 확인
          console.log("\n=== 로컬 상태 ===");
          console.log("membersData 길이:", membersData?.length || 0);
          console.log("adminList:", adminList);
          console.log("adminPositions:", adminPositions);
        } catch (error) {
          console.error("디버깅 중 오류 발생:", error);
        }
      };

      // 우테코 사용자 강제 삭제 함수
      window.forceDeleteWooteco = async function () {
        console.log("=== 우테코 사용자 강제 삭제 시작 ===");

        try {
          // members 컬렉션에서 우테코 사용자 찾기 및 삭제
          const membersSnapshot = await getDocs(collection(db, "members"));
          let deletedCount = 0;
          const deletedStudentIds = [];

          for (const docSnap of membersSnapshot.docs) {
            const data = docSnap.data();
            // 이름이 "우테코"인 모든 사용자 삭제
            if (
              data.name === "우테코" ||
              data.college === "우테코" ||
              data.department === "우테코"
            ) {
              console.log("우테코 사용자 발견, 삭제 중:", docSnap.id, data);
              await deleteDoc(doc(db, "members", docSnap.id));
              deletedStudentIds.push(docSnap.id);
              deletedCount++;
            }
          }

          // 관리자 목록에서도 제거
          const adminsDoc = await getDoc(doc(db, "admins", "list"));
          if (adminsDoc.exists()) {
            const adminData = adminsDoc.data();
            const studentIds = adminData.studentIds || [];
            const positions = adminData.positions || {};

            // 삭제된 모든 학번 제거
            const newStudentIds = studentIds.filter(
              (id) => !deletedStudentIds.includes(id)
            );

            // positions에서도 제거
            deletedStudentIds.forEach((id) => {
              delete positions[id];
            });

            if (newStudentIds.length !== studentIds.length) {
              console.log("관리자 목록에서 우테코 사용자들 제거");
              await setDoc(doc(db, "admins", "list"), {
                studentIds: newStudentIds,
                positions: positions,
              });
            }
          }

          console.log(`우테코 사용자 ${deletedCount}명 삭제 완료`);
          console.log("삭제된 학번:", deletedStudentIds);
          alert(
            `우테코 사용자 ${deletedCount}명이 삭제되었습니다.\n삭제된 학번: ${deletedStudentIds.join(
              ", "
            )}\n\n페이지를 새로고침합니다.`
          );
          location.reload();
        } catch (error) {
          console.error("우테코 사용자 삭제 중 오류:", error);
          alert("삭제 중 오류가 발생했습니다: " + error.message);
        }
      };

      /* ===================== 관리자 대시보드 ===================== */
      function renderDashboardTab() {
        const c = document.getElementById("dashboard-tab");
        c.innerHTML = `<div class="section">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">관리자 대시보드</h2>
          <div class="flex flex-wrap gap-2 mb-4">
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="members">
              <i class="fas fa-users mr-1"></i>회원
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="groups">
              <i class="fas fa-users-cog mr-1"></i>조모임 관리
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="positions">
              <i class="fas fa-user-tie mr-1"></i>임원 관리
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="system">
              <i class="fas fa-gear mr-1"></i>시스템
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="food-menu">
              <i class="fas fa-utensils mr-1"></i>뭐먹지 메뉴
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="inquiries">
              <i class="fas fa-comment-dots mr-1"></i>문의 관리
            </button>
          </div>
          <div id="subtab-container"></div>
        </div>`;
        const bWrap = c.querySelector(".flex.flex-wrap");
        bWrap.addEventListener("click", (e) => {
          const b = e.target.closest(".subtab-btn");
          if (!b) return;
          c.querySelectorAll(".subtab-btn").forEach((x) =>
            x.classList.remove("bg-gray-800", "text-white")
          );
          b.classList.add("bg-gray-800", "text-white");
          currentDashboardTab = b.dataset.sub; // 현재 탭 저장
          showSubtab(b.dataset.sub);
        });

        // 저장된 탭으로 복원, 기본값은 "회원" 탭
        const initialTab = currentDashboardTab || "members";
        const initialBtn = c.querySelector(
          `.subtab-btn[data-sub="${initialTab}"]`
        );
        if (initialBtn) {
          initialBtn.classList.add("bg-gray-800", "text-white");
        }
        showSubtab(initialTab);
      }
      function showSubtab(name) {
        const cont = document.getElementById("subtab-container");
        if (name === "members") {
          renderMembersAdmin(cont);
          return;
        }
        if (name === "groups") {
          renderGroupsAdmin(cont);
          return;
        }
        if (name === "positions") {
          renderPositionsAdmin(cont);
          return;
        }
        if (name === "system") {
          renderSystemAdmin(cont);
          return;
        }
        if (name === "food-menu") {
          renderFoodMenuAdmin(cont);
          return;
        }
        if (name === "inquiries") {
          renderInquiriesAdmin(cont);
          return;
        }
      }

      /* ===== 조모임 관리 ===== */
      function renderGroupsAdmin(container) {
        // 조모임 데이터를 점수순으로 정렬
        const sortedGroups = [...groupsData]
          .filter((g) => g.name && g.score !== undefined)
          .sort((a, b) => (b.score || 0) - (a.score || 0));

        container.innerHTML = `
          <div class="section">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-800">🏅 조모임 관리</h3>
              <button
                type="button"
                class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors"
                onclick="openGroupAddModal()"
              >
                <i class="fas fa-plus mr-1"></i>조모임 추가
              </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              ${
                sortedGroups.length > 0
                  ? sortedGroups
                      .map((group, index) => {
                        const members = group.members || [];
                        // members가 문자열 배열인지 객체 배열인지 확인 필요
                        // 일단 문자열로 가정하고, 객체면 studentId로 찾아야 함

                        return `
                        <div class="bg-white border-2 border-gray-200 rounded-xl p-4 shadow-md hover:shadow-lg transition-shadow">
                          <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                              <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                ${index + 1}
                              </div>
                              <div>
                                <h4 class="text-lg font-bold text-gray-800">${saf(
                                  group.name
                                )}</h4>
                                <p class="text-sm text-gray-600">${
                                  group.score || 0
                                }점</p>
                              </div>
                            </div>
                            <div class="flex gap-2">
                              <button
                                type="button"
                                class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors"
                                onclick="openGroupManageModal('${
                                  group.id
                                }', '${saf(group.name).replace(/'/g, "\\'")}')"
                                title="회원 관리"
                              >
                                <i class="fas fa-users-cog mr-1"></i>관리
                              </button>
                              <button
                                type="button"
                                class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm transition-colors"
                                onclick="openGroupEditModal('${
                                  group.id
                                }', '${saf(group.name).replace(
                          /'/g,
                          "\\'"
                        )}', ${group.score || 0})"
                                title="수정"
                              >
                                <i class="fas fa-edit"></i>
                              </button>
                            </div>
                          </div>
                          
                          <div class="mt-3 space-y-2">
                            <div class="text-sm font-semibold text-gray-700 mb-2">
                              <i class="fas fa-users mr-1"></i>회원 (${
                                members.length
                              }명)
                            </div>
                            ${
                              members.length > 0
                                ? `<div class="flex flex-wrap gap-2">
                                    ${members
                                      .map((member) => {
                                        // member가 문자열이면 그대로, 객체면 name 표시
                                        const memberName =
                                          typeof member === "string"
                                            ? member
                                            : member.name ||
                                              member.studentId ||
                                              "알 수 없음";
                                        const memberStudentId =
                                          typeof member === "object"
                                            ? member.studentId
                                            : null;
                                        const isLeader =
                                          typeof member === "object"
                                            ? member.role === "leader" ||
                                              member.isLeader
                                            : false;
                                        const isSubLeader =
                                          typeof member === "object"
                                            ? member.role === "subleader"
                                            : false;

                                        return `
                                          <span class="px-2 py-1 rounded-full text-xs ${
                                            isLeader
                                              ? "bg-yellow-100 text-yellow-800 font-semibold"
                                              : isSubLeader
                                              ? "bg-orange-100 text-orange-800 font-semibold"
                                              : "bg-gray-100 text-gray-700"
                                          }">
                                            ${saf(memberName)}${
                                          isLeader
                                            ? " 👑"
                                            : isSubLeader
                                            ? " ⭐"
                                            : ""
                                        }
                                          </span>
                                        `;
                                      })
                                      .join("")}
                                  </div>`
                                : `<p class="text-sm text-gray-400 italic">회원이 없습니다</p>`
                            }
                          </div>
                        </div>
                      `;
                      })
                      .join("")
                  : `<div class="col-span-2 text-center py-12 text-gray-400">
                    <i class="fas fa-users text-4xl mb-3"></i>
                    <p>아직 조모임이 없습니다.</p>
                    <p class="text-sm mt-1">조모임을 추가하여 시작하세요.</p>
                  </div>`
              }
            </div>
          </div>
        `;
      }

      // 조모임 회원 관리 모달 열기
      window.openGroupManageModal = function (groupId, groupName) {
        const group = groupsData.find((g) => g.id === groupId);
        if (!group) {
          showAlert("😥", "조모임을 찾을 수 없습니다.");
          return;
        }

        const modalHTML = `
          <div id="group-manage-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
              <div class="p-6 border-b border-gray-200 flex-shrink-0">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-2xl font-bold text-gray-800">🏅 ${saf(
                    groupName
                  )} 회원 관리</h3>
                  <button
                    type="button"
                    class="text-gray-500 hover:text-gray-700 p-2"
                    onclick="document.getElementById('group-manage-modal').remove()"
                  >
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
              </div>

              <div class="flex-1 overflow-y-auto p-6">
                <!-- 현재 회원 목록 -->
                <div class="mb-6">
                  <h4 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-users mr-2"></i>현재 회원 (${
                      (group.members || []).length
                    }명)
                  </h4>
                  <div id="group-current-members" class="space-y-2">
                    ${renderGroupMembersList(group.members || [], groupId)}
                  </div>
                </div>

                <!-- 회원 추가 -->
                <div class="border-t border-gray-200 pt-6">
                  <h4 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-user-plus mr-2"></i>회원 추가
                  </h4>
                  <div class="mb-4">
                    <input
                      type="text"
                      id="group-member-search"
                      placeholder="이름 또는 학번으로 검색..."
                      class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200"
                      oninput="searchMembersForGroup(this.value, '${groupId}')"
                    />
                  </div>
                  <div id="group-member-search-results" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-sm text-gray-400 text-center py-4">검색어를 입력하여 회원을 찾아주세요</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        // 기존 모달이 있으면 제거
        const existingModal = document.getElementById("group-manage-modal");
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 모달 외부 클릭 시 닫기
        document
          .getElementById("group-manage-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "group-manage-modal") {
              document.getElementById("group-manage-modal").remove();
            }
          });
      };

      // 조모임 회원 목록 렌더링
      function renderGroupMembersList(members, groupId) {
        if (members.length === 0) {
          return '<p class="text-sm text-gray-400 italic">회원이 없습니다</p>';
        }

        return members
          .map((member, index) => {
            const memberData =
              typeof member === "object"
                ? member
                : { name: member, studentId: null };
            const memberName =
              memberData.name || memberData.studentId || member || "알 수 없음";
            const memberStudentId = memberData.studentId || null;
            const isLeader =
              memberData.role === "leader" || memberData.isLeader === true;
            const isSubLeader = memberData.role === "subleader";

            // 회원 정보 가져오기 (membersData에서)
            const fullMemberInfo = membersData.find(
              (m) =>
                (memberStudentId && m.studentId === memberStudentId) ||
                (!memberStudentId && m.name === memberName)
            );

            return `
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center gap-3 flex-1">
                  <div class="w-8 h-8 rounded-full flex items-center justify-center ${
                    isLeader
                      ? "bg-yellow-400 text-yellow-900"
                      : isSubLeader
                      ? "bg-orange-400 text-orange-900"
                      : "bg-gray-300 text-gray-700"
                  } font-bold text-sm">
                    ${isLeader ? "👑" : isSubLeader ? "⭐" : index + 1}
                  </div>
                  <div class="flex-1">
                    <div class="font-semibold text-gray-800">${saf(
                      memberName
                    )}</div>
                    ${
                      fullMemberInfo
                        ? `<div class="text-xs text-gray-500">${
                            fullMemberInfo.studentId || ""
                          } · ${fullMemberInfo.college || ""}</div>`
                        : ""
                    }
                  </div>
                  <div class="flex gap-2">
                    ${
                      !isLeader
                        ? `
                      <button
                        type="button"
                        class="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs transition-colors"
                        onclick="setGroupMemberRole('${groupId}', '${
                            memberStudentId || saf(memberName)
                          }', 'leader')"
                        title="조장으로 임명"
                      >
                        <i class="fas fa-crown mr-1"></i>조장
                      </button>
                    `
                        : ""
                    }
                    ${
                      !isSubLeader && !isLeader
                        ? `
                      <button
                        type="button"
                        class="px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded text-xs transition-colors"
                        onclick="setGroupMemberRole('${groupId}', '${
                            memberStudentId || saf(memberName)
                          }', 'subleader')"
                        title="부조장으로 임명"
                      >
                        <i class="fas fa-star mr-1"></i>부조장
                      </button>
                    `
                        : ""
                    }
                    ${
                      isLeader || isSubLeader
                        ? `
                      <button
                        type="button"
                        class="px-2 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-xs transition-colors"
                        onclick="setGroupMemberRole('${groupId}', '${
                            memberStudentId || saf(memberName)
                          }', 'member')"
                        title="일반 회원으로 변경"
                      >
                        <i class="fas fa-user mr-1"></i>일반
                      </button>
                    `
                        : ""
                    }
                    <button
                      type="button"
                      class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs transition-colors"
                      onclick="removeGroupMember('${groupId}', '${
              memberStudentId || saf(memberName)
            }')"
                      title="조에서 제거"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      // 회원 검색 (조모임에 추가용)
      window.searchMembersForGroup = function (searchTerm, groupId) {
        const searchResults = document.getElementById(
          "group-member-search-results"
        );
        if (!searchResults) return;

        if (!searchTerm.trim()) {
          searchResults.innerHTML =
            '<p class="text-sm text-gray-400 text-center py-4">검색어를 입력하여 회원을 찾아주세요</p>';
          return;
        }

        const group = groupsData.find((g) => g.id === groupId);
        const currentMembers = (group?.members || []).map((m) =>
          typeof m === "object" ? m.studentId || m.name : m
        );

        // 띄어쓰기로 구분된 여러 검색어 처리
        const searchKeywords = searchTerm
          .trim()
          .split(/\s+/)
          .filter((keyword) => keyword.length > 0)
          .map((keyword) => keyword.toLowerCase());

        // 각 검색어에 매칭되는 회원들을 찾기
        const matchedMembers = new Map(); // 중복 제거를 위한 Map 사용

        searchKeywords.forEach((keyword) => {
          (membersData || []).forEach((m) => {
            const nameMatch = m.name?.toLowerCase().includes(keyword);
            const idMatch = m.studentId?.toLowerCase().includes(keyword);
            const isAlreadyMember = currentMembers.includes(
              m.studentId || m.name
            );
            const isActive = (m.status || "pending") === "active";

            if ((nameMatch || idMatch) && !isAlreadyMember && isActive) {
              // Map에 추가 (학번을 키로 사용하여 중복 제거)
              matchedMembers.set(m.studentId || m.name, m);
            }
          });
        });

        // Map을 배열로 변환 (최대 50개까지 표시)
        const filtered = Array.from(matchedMembers.values()).slice(0, 50);

        if (filtered.length === 0) {
          searchResults.innerHTML =
            '<p class="text-sm text-gray-400 text-center py-4">검색 결과가 없습니다</p>';
          return;
        }

        // 매칭된 검색어 정보 추가 (어떤 검색어로 매칭되었는지 표시)
        searchResults.innerHTML = filtered
          .map((member) => {
            // 어떤 검색어에 매칭되었는지 찾기
            const matchedKeywords = searchKeywords.filter(
              (keyword) =>
                member.name?.toLowerCase().includes(keyword) ||
                member.studentId?.toLowerCase().includes(keyword)
            );

            return `
            <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-bold">
                  ${member.name?.charAt(0) || "?"}
                </div>
                <div>
                  <div class="font-semibold text-gray-800">${saf(
                    member.name || "알 수 없음"
                  )}</div>
                  <div class="text-xs text-gray-500">${
                    member.studentId || ""
                  } · ${member.college || ""}</div>
                  ${
                    matchedKeywords.length > 0
                      ? `<div class="text-xs text-orange-500 mt-0.5">
                          <i class="fas fa-search mr-1"></i>${matchedKeywords.join(
                            ", "
                          )} 검색어로 매칭
                        </div>`
                      : ""
                  }
                </div>
              </div>
              <button
                type="button"
                class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded text-sm transition-colors"
                onclick="addMemberToGroup('${groupId}', '${
              member.studentId
            }', '${saf(member.name).replace(/'/g, "\\'")}')"
              >
                <i class="fas fa-plus mr-1"></i>추가
              </button>
            </div>
          `;
          })
          .join("");
      };

      // 조모임에 회원 추가
      window.addMemberToGroup = async function (
        groupId,
        studentId,
        memberName
      ) {
        try {
          const groupRef = doc(db, "groups", groupId);
          const groupDoc = await getDoc(groupRef);

          if (!groupDoc.exists()) {
            showAlert("😥", "조모임을 찾을 수 없습니다.");
            return;
          }

          const groupData = groupDoc.data();
          const currentMembers = groupData.members || [];

          // 이미 포함되어 있는지 확인
          const isAlreadyMember = currentMembers.some(
            (m) =>
              (typeof m === "object" && m.studentId === studentId) ||
              (typeof m === "string" && m === studentId) ||
              (typeof m === "string" && m === memberName)
          );

          if (isAlreadyMember) {
            showAlert("😥", "이미 해당 조에 소속된 회원입니다.");
            return;
          }

          // 회원 추가 (객체 형태로 저장: {studentId, name, role: 'member'})
          const newMember = {
            studentId: studentId,
            name: memberName,
            role: "member",
          };

          await updateDoc(groupRef, {
            members: [...currentMembers, newMember],
            lastUpdated: new Date().toISOString(),
          });

          showAlert("✅", `${memberName} 회원이 추가되었습니다.`);

          // groupsData 새로고침 (onSnapshot이 자동으로 업데이트해줌)
          // 모달 새로고침을 위해 잠시 대기
          setTimeout(() => {
            const group = groupsData.find((g) => g.id === groupId);
            if (group) {
              const currentMembersDiv = document.getElementById(
                "group-current-members"
              );
              if (currentMembersDiv) {
                currentMembersDiv.innerHTML = renderGroupMembersList(
                  group.members || [],
                  groupId
                );
              }
              // 검색 결과에서 제거
              searchMembersForGroup(
                document.getElementById("group-member-search")?.value || "",
                groupId
              );
            }
          }, 500);
        } catch (error) {
          console.error("회원 추가 오류:", error);
          showAlert("😥", "회원 추가에 실패했습니다.");
        }
      };

      // 조모임에서 회원 제거
      window.removeGroupMember = async function (groupId, memberIdentifier) {
        if (!confirm("정말로 이 회원을 조에서 제거하시겠습니까?")) {
          return;
        }

        try {
          const groupRef = doc(db, "groups", groupId);
          const groupDoc = await getDoc(groupRef);

          if (!groupDoc.exists()) {
            showAlert("😥", "조모임을 찾을 수 없습니다.");
            return;
          }

          const groupData = groupDoc.data();
          const currentMembers = groupData.members || [];

          // 회원 제거 (studentId 또는 name으로 매칭)
          const updatedMembers = currentMembers.filter((m) => {
            if (typeof m === "object") {
              return (
                m.studentId !== memberIdentifier && m.name !== memberIdentifier
              );
            }
            return m !== memberIdentifier;
          });

          await updateDoc(groupRef, {
            members: updatedMembers,
            lastUpdated: new Date().toISOString(),
          });

          showAlert("✅", "회원이 제거되었습니다.");

          // groupsData 새로고침 (onSnapshot이 자동으로 업데이트해줌)
          // 모달 새로고침을 위해 잠시 대기
          setTimeout(() => {
            const group = groupsData.find((g) => g.id === groupId);
            if (group) {
              const currentMembersDiv = document.getElementById(
                "group-current-members"
              );
              if (currentMembersDiv) {
                currentMembersDiv.innerHTML = renderGroupMembersList(
                  group.members || [],
                  groupId
                );
              }
              // 검색 결과 새로고침
              const searchInput = document.getElementById(
                "group-member-search"
              );
              if (searchInput) {
                searchMembersForGroup(searchInput.value, groupId);
              }
            }
          }, 500);
        } catch (error) {
          console.error("회원 제거 오류:", error);
          showAlert("😥", "회원 제거에 실패했습니다.");
        }
      };

      // 조모임 회원 역할 변경 (조장/부조장/일반)
      window.setGroupMemberRole = async function (
        groupId,
        memberIdentifier,
        role
      ) {
        try {
          const groupRef = doc(db, "groups", groupId);
          const groupDoc = await getDoc(groupRef);

          if (!groupDoc.exists()) {
            showAlert("😥", "조모임을 찾을 수 없습니다.");
            return;
          }

          const groupData = groupDoc.data();
          const currentMembers = groupData.members || [];

          // 역할 변경
          const updatedMembers = currentMembers.map((m) => {
            if (typeof m === "object") {
              if (
                m.studentId === memberIdentifier ||
                m.name === memberIdentifier
              ) {
                // 조장으로 임명할 때, 기존 조장을 일반 회원으로 변경
                if (role === "leader") {
                  // 다른 조장 찾아서 일반 회원으로 변경
                  return { ...m, role: "member" };
                }
                return { ...m, role: role };
              }
              return m;
            } else {
              // 문자열인 경우 객체로 변환 필요
              if (m === memberIdentifier) {
                const memberInfo = membersData.find(
                  (mem) =>
                    mem.studentId === memberIdentifier ||
                    mem.name === memberIdentifier
                );
                return {
                  studentId: memberInfo?.studentId || memberIdentifier,
                  name: memberInfo?.name || memberIdentifier,
                  role: role,
                };
              }
              return m;
            }
          });

          // 조장은 한 명만 있어야 함
          if (role === "leader") {
            // 다른 조장들을 일반 회원으로 변경
            updatedMembers.forEach((m, idx) => {
              if (typeof m === "object" && m.role === "leader") {
                const isTarget =
                  m.studentId === memberIdentifier ||
                  m.name === memberIdentifier;
                if (!isTarget) {
                  updatedMembers[idx] = { ...m, role: "member" };
                }
              }
            });

            // 현재 선택된 회원을 조장으로 변경
            const targetIndex = updatedMembers.findIndex((m) => {
              if (typeof m === "object") {
                return (
                  m.studentId === memberIdentifier ||
                  m.name === memberIdentifier
                );
              }
              return m === memberIdentifier;
            });

            if (targetIndex >= 0) {
              if (typeof updatedMembers[targetIndex] === "object") {
                updatedMembers[targetIndex] = {
                  ...updatedMembers[targetIndex],
                  role: "leader",
                };
              } else {
                const memberInfo = membersData.find(
                  (mem) =>
                    mem.studentId === memberIdentifier ||
                    mem.name === memberIdentifier
                );
                updatedMembers[targetIndex] = {
                  studentId: memberInfo?.studentId || memberIdentifier,
                  name: memberInfo?.name || memberIdentifier,
                  role: "leader",
                };
              }
            }
          }

          await updateDoc(groupRef, {
            members: updatedMembers,
            lastUpdated: new Date().toISOString(),
          });

          const roleText =
            role === "leader"
              ? "조장"
              : role === "subleader"
              ? "부조장"
              : "일반 회원";
          showAlert("✅", `회원 역할이 ${roleText}으로 변경되었습니다.`);

          // groupsData 새로고침 (onSnapshot이 자동으로 업데이트해줌)
          // 모달 새로고침을 위해 잠시 대기
          setTimeout(() => {
            const group = groupsData.find((g) => g.id === groupId);
            if (group) {
              const currentMembersDiv = document.getElementById(
                "group-current-members"
              );
              if (currentMembersDiv) {
                currentMembersDiv.innerHTML = renderGroupMembersList(
                  group.members || [],
                  groupId
                );
              }
            }
          }, 500);
        } catch (error) {
          console.error("역할 변경 오류:", error);
          showAlert("😥", "역할 변경에 실패했습니다.");
        }
      };

      /* ===== 문의 관리 ===== */
      function renderInquiriesAdmin(container) {
        const pendingInquiries = (inquiriesData || []).filter(
          (i) => i.status === "pending"
        );
        const answeredInquiries = (inquiriesData || []).filter(
          (i) => i.status === "answered"
        );

        container.innerHTML = `
          <div class="section">
            <h3 class="text-xl font-bold text-gray-800 mb-4">문의 관리</h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <!-- 미답변 문의 -->
              <div>
                <h4 class="font-semibold text-amber-700 mb-2">
                  미답변 문의 
                  <span class="bg-amber-100 text-amber-800 px-2 py-1 rounded-full text-xs ml-2">
                    ${pendingInquiries.length}건
                  </span>
                </h4>
                <div class="space-y-3 max-h-[600px] overflow-y-auto">
                  ${
                    pendingInquiries.length > 0
                      ? pendingInquiries
                          .map((inq) => createInquiryCard(inq, false))
                          .join("")
                      : '<div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-400">미답변 문의가 없습니다.</div>'
                  }
                </div>
              </div>

              <!-- 답변 완료 -->
              <div>
                <h4 class="font-semibold text-emerald-700 mb-2">
                  답변 완료 
                  <span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-xs ml-2">
                    ${answeredInquiries.length}건
                  </span>
                </h4>
                <div class="space-y-3 max-h-[600px] overflow-y-auto">
                  ${
                    answeredInquiries.length > 0
                      ? answeredInquiries
                          .map((inq) => createInquiryCard(inq, true))
                          .join("")
                      : '<div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-400">답변 완료된 문의가 없습니다.</div>'
                  }
                </div>
              </div>
            </div>
          </div>
        `;

        // 이벤트 리스너 등록
        container.addEventListener("click", onInquiryClick);
      }

      function createInquiryCard(inquiry, isAnswered) {
        const createdAt = inquiry.createdAt?.toDate
          ? inquiry.createdAt.toDate()
          : new Date();
        const timeStr = `${createdAt.getFullYear()}.${String(
          createdAt.getMonth() + 1
        ).padStart(2, "0")}.${String(createdAt.getDate()).padStart(
          2,
          "0"
        )} ${String(createdAt.getHours()).padStart(2, "0")}:${String(
          createdAt.getMinutes()
        ).padStart(2, "0")}`;

        return `
          <div class="bg-white border ${
            isAnswered ? "border-emerald-200" : "border-amber-200"
          } rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-2">
              <div>
                <span class="font-semibold text-gray-800">${saf(
                  inquiry.name
                )}</span>
                <span class="text-sm text-gray-500 ml-2">${saf(
                  inquiry.contact
                )}</span>
              </div>
              <span class="text-xs text-gray-400">${timeStr}</span>
            </div>
            
            <div class="text-sm text-gray-700 mb-3 line-clamp-3">
              ${saf(inquiry.content)}
            </div>
            
            <div class="flex gap-2">
              <button 
                data-act="view-inquiry" 
                data-id="${inquiry.id}" 
                class="flex-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm"
              >
                <i class="fas fa-eye mr-1"></i>상세보기
              </button>
              ${
                !isAnswered
                  ? `<button 
                      data-act="mark-answered" 
                      data-id="${inquiry.id}" 
                      class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors text-sm"
                    >
                      <i class="fas fa-check mr-1"></i>완료
                    </button>`
                  : ""
              }
              <button 
                data-act="delete-inquiry" 
                data-id="${inquiry.id}" 
                class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }

      async function onInquiryClick(e) {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;

        const id = btn.dataset.id;
        const inquiry = inquiriesData.find((i) => i.id === id);
        if (!inquiry) return;

        if (btn.dataset.act === "view-inquiry") {
          showInquiryDetailModal(inquiry);
        } else if (btn.dataset.act === "mark-answered") {
          if (!confirm("이 문의를 답변 완료 처리하시겠습니까?")) return;
          try {
            await updateDoc(doc(db, "inquiries", id), {
              status: "answered",
              answeredAt: serverTimestamp(),
            });
            showAlert("✅", "답변 완료 처리되었습니다.");
          } catch (error) {
            console.error("문의 완료 처리 오류:", error);
            showAlert("😥", "처리 중 오류가 발생했습니다.");
          }
        } else if (btn.dataset.act === "delete-inquiry") {
          if (!confirm("이 문의를 삭제하시겠습니까?")) return;
          try {
            await deleteDoc(doc(db, "inquiries", id));
            showAlert("🗑️", "문의가 삭제되었습니다.");
          } catch (error) {
            console.error("문의 삭제 오류:", error);
            showAlert("😥", "삭제 중 오류가 발생했습니다.");
          }
        }
      }

      function showInquiryDetailModal(inquiry) {
        const createdAt = inquiry.createdAt?.toDate
          ? inquiry.createdAt.toDate()
          : new Date();
        const timeStr = `${createdAt.getFullYear()}년 ${
          createdAt.getMonth() + 1
        }월 ${createdAt.getDate()}일 ${String(createdAt.getHours()).padStart(
          2,
          "0"
        )}:${String(createdAt.getMinutes()).padStart(2, "0")}`;

        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]";
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-bold text-gray-800">📋 문의 상세 내역</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            
            <div class="space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-semibold text-gray-600">이름</label>
                    <p class="text-base text-gray-800 mt-1">${saf(
                      inquiry.name
                    )}</p>
                  </div>
                  <div>
                    <label class="text-sm font-semibold text-gray-600">연락처</label>
                    <p class="text-base text-gray-800 mt-1">${saf(
                      inquiry.contact
                    )}</p>
                  </div>
                  <div class="col-span-2">
                    <label class="text-sm font-semibold text-gray-600">문의 일시</label>
                    <p class="text-base text-gray-800 mt-1">${timeStr}</p>
                  </div>
                  <div class="col-span-2">
                    <label class="text-sm font-semibold text-gray-600">상태</label>
                    <p class="text-base text-gray-800 mt-1">
                      <span class="px-3 py-1 rounded-full text-sm ${
                        inquiry.status === "answered"
                          ? "bg-emerald-100 text-emerald-800"
                          : "bg-amber-100 text-amber-800"
                      }">
                        ${
                          inquiry.status === "answered" ? "답변 완료" : "미답변"
                        }
                      </span>
                    </p>
                  </div>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-600 mb-2">문의 내용</label>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                  <p class="text-gray-800 whitespace-pre-wrap">${saf(
                    inquiry.content
                  )}</p>
                </div>
              </div>
            </div>

            <div class="flex gap-3 justify-end mt-6">
              <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                닫기
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // 모달 배경 클릭 시 닫기
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      /* ===== 뭐먹지 메뉴 관리 ===== */
      function renderFoodMenuAdmin(container) {
        container.innerHTML = `
          <div class="section">
            <h3 class="text-xl font-bold text-gray-800 mb-4">
              <i class="fas fa-utensils text-orange-500 mr-2"></i>뭐먹지 메뉴 관리
            </h3>
            
            <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 rounded-xl p-6 mb-6">
              <p class="text-sm text-gray-700 mb-4">
                회원들이 "뭐먹지?" 룰렛에 표시될 메뉴를 관리할 수 있습니다. 한 줄에 하나씩 입력하면 여러 메뉴를 한 번에 추가할 수 있습니다.
              </p>
              
              <button
                id="admin-add-food-menu-btn"
                class="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-xl hover:scale-105"
              >
                <i class="fas fa-plus mr-2"></i>메뉴 추가하기
              </button>
            </div>
            
            <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-semibold text-gray-800">
                  등록된 메뉴 목록
                  <span id="admin-menu-count-badge" class="text-sm text-gray-500 ml-2">(로딩중...)</span>
                </h4>
                <button
                  id="admin-delete-all-menus-btn"
                  class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors"
                >
                  <i class="fas fa-trash mr-1"></i>전체 삭제
                </button>
              </div>
              <div id="admin-menu-list-container">
                <!-- 동적으로 생성됩니다 -->
              </div>
            </div>
          </div>
        `;

        // 메뉴 추가 버튼 이벤트
        const addBtn = container.querySelector("#admin-add-food-menu-btn");
        if (addBtn) {
          addBtn.addEventListener("click", () => {
            openMenuManageModal();
          });
        }

        // 전체 삭제 버튼 이벤트
        const deleteAllBtn = container.querySelector(
          "#admin-delete-all-menus-btn"
        );
        if (deleteAllBtn) {
          deleteAllBtn.addEventListener("click", deleteAllMenus);
        }

        // 메뉴 로드 및 표시
        loadFoodMenus().then(() => {
          renderAdminMenuList();
        });
      }

      // 관리자 페이지 메뉴 목록 렌더링
      function renderAdminMenuList() {
        const container = document.getElementById("admin-menu-list-container");
        const countBadge = document.getElementById("admin-menu-count-badge");

        if (!container) return;

        if (countBadge) countBadge.textContent = `(${foodMenusData.length}개)`;

        if (foodMenusData.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12 text-gray-400">
              <i class="fas fa-utensils text-4xl mb-3"></i>
              <p>등록된 메뉴가 없습니다</p>
              <p class="text-sm">메뉴 추가하기 버튼을 눌러 메뉴를 추가해보세요!</p>
            </div>
          `;
          return;
        }

        // 카테고리별로 그룹화
        const groupedMenus = {};
        foodMenusData.forEach((menu) => {
          if (!groupedMenus[menu.category]) {
            groupedMenus[menu.category] = [];
          }
          groupedMenus[menu.category].push(menu);
        });

        const categoryNames = {
          korean: "한식",
          japanese: "일식",
          chinese: "중식",
          western: "양식",
          asian: "아시안",
          snack: "분식",
          dessert: "디저트",
          cafe: "카페",
          etc: "기타",
        };

        let html = '<div class="space-y-4">';
        Object.keys(groupedMenus).forEach((category) => {
          const emoji = getCategoryEmoji(category);
          const categoryName = categoryNames[category] || category;
          const menus = groupedMenus[category];

          html += `
            <div class="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
              <h5 class="font-bold text-gray-800 mb-3">
                ${emoji} ${categoryName} <span class="text-sm text-gray-500">(${
            menus.length
          }개)</span>
              </h5>
              <div class="flex flex-wrap gap-2">
                ${menus
                  .map(
                    (menu) => `
                  <span class="inline-flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-300 text-sm">
                    <span>${menu.name}</span>
                    <button
                      class="admin-delete-menu-btn text-red-500 hover:text-red-700 transition-colors"
                      data-id="${menu.id}"
                      data-name="${menu.name}"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </span>
                `
                  )
                  .join("")}
              </div>
            </div>
          `;
        });
        html += "</div>";

        container.innerHTML = html;

        // 삭제 버튼 이벤트
        container.querySelectorAll(".admin-delete-menu-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const name = btn.dataset.name;

            if (confirm(`'${name}' 메뉴를 삭제하시겠습니까?`)) {
              try {
                await deleteDoc(doc(db, "foodMenus", id));
                showAlert("✅", "메뉴가 삭제되었습니다.");
                // onSnapshot이 자동으로 업데이트하므로 loadFoodMenus() 불필요
                renderAdminMenuList();
              } catch (error) {
                console.error("메뉴 삭제 오류:", error);
                showAlert("😥", "메뉴 삭제 중 오류가 발생했습니다.");
              }
            }
          });
        });
      }

      /* ===== 직책 관리 ===== */
      function renderPositionsAdmin(container) {
        // 회장, 부회장 권한 확인 (관리자 목록과 직책 모두 확인)
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        const isPresidentOrVice =
          currentUser &&
          (currentUser.position === "회장" ||
            currentUser.position === "부회장");

        console.log("=== 직책 관리 권한 확인 ===");
        console.log("currentUser:", currentUser);
        console.log("adminList:", adminList);
        console.log("isAdmin:", isAdmin);
        console.log("isPresidentOrVice:", isPresidentOrVice);
        console.log("currentUser.position:", currentUser?.position);

        if (!isAdmin || !isPresidentOrVice) {
          container.innerHTML = `
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">관리자 직책 관리</h3>
              <div class="p-8 text-center">
                <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-2">임원 관리는 회장과 부회장만 가능합니다.</p>
                <p class="text-sm text-gray-500">현재 권한: ${
                  currentUser?.position || "일반 회원"
                }</p>
                <p class="text-xs text-gray-400 mt-2">관리자 여부: ${
                  isAdmin ? "관리자" : "일반 회원"
                }</p>
              </div>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="section">
            <h3 class="text-xl font-bold text-gray-800 mb-2">관리자 직책 관리</h3>
            <p class="text-xs text-gray-600 mb-4">관리자들에게 직책을 부여하고 관리할 수 있습니다.</p>
            
            <div class="mb-4">
              <h4 class="font-semibold text-gray-700 mb-2">현재 관리자 목록 <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs ml-2">${
                adminList.length
              }명</span></h4>
              <div id="admin-positions-list" class="space-y-2">
                ${renderAdminPositionsList()}
              </div>
              
              <!-- 관리자 추가 안내 -->
              <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h5 class="font-medium text-blue-800 mb-2">관리자 추가</h5>
                <p class="text-sm text-blue-700 mb-2">
                  관리자 추가는 <strong>시스템</strong> 탭에서 가능합니다.
                </p>
                <div class="text-xs text-blue-600 bg-blue-100 p-2 rounded">
                  <strong>비상시:</strong> 로그인 화면에서 학번에 <code>foodie_emergency_2024!</code> 입력 후 이름을 입력하면 즉시 관리자 권한으로 로그인됩니다.
                </div>
              </div>
            </div>
            
            <div class="border-t pt-4">
              <h4 class="font-semibold text-gray-700 mb-2">직책 분류 관리</h4>
              <p class="text-xs text-gray-500 mb-4">직책을 회장단과 일반 임원으로 분류하여 관리합니다.</p>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 회장단 직책 -->
                <div class="border rounded-lg p-4 bg-blue-50">
                  <h5 class="font-semibold text-blue-900 mb-3 flex items-center">
                    <i class="fas fa-crown mr-2"></i>회장단
                  </h5>
                  <div class="space-y-2 mb-3">
                    ${renderPresidentPositions()}
                  </div>
                  <div class="border-t border-blue-200 pt-3">
                    <label class="block text-sm font-medium text-blue-900 mb-2">회장단 직책 추가</label>
                    <div class="flex gap-2">
                      <input id="new-president-position" type="text" placeholder="직책명 입력" 
                             class="flex-1 px-3 py-2 border border-blue-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <button id="add-president-position-btn" type="button" 
                              class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm whitespace-nowrap">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- 일반 임원 직책 -->
                <div class="border rounded-lg p-4 bg-green-50">
                  <h5 class="font-semibold text-green-900 mb-3 flex items-center">
                    <i class="fas fa-users mr-2"></i>일반 임원
                  </h5>
                  <div class="space-y-2 mb-3">
                    ${renderRegularPositions()}
                  </div>
                  <div class="border-t border-green-200 pt-3">
                    <label class="block text-sm font-medium text-green-900 mb-2">일반 임원 직책 추가</label>
                    <div class="flex gap-2">
                      <input id="new-regular-position" type="text" placeholder="직책명 입력" 
                             class="flex-1 px-3 py-2 border border-green-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                      <button id="add-regular-position-btn" type="button" 
                              class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm whitespace-nowrap">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        // 이벤트 바인딩
        document
          .getElementById("add-president-position-btn")
          .addEventListener("click", () => addPositionToCategory("president"));
        document
          .getElementById("new-president-position")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") addPositionToCategory("president");
          });

        document
          .getElementById("add-regular-position-btn")
          .addEventListener("click", () => addPositionToCategory("regular"));
        document
          .getElementById("new-regular-position")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") addPositionToCategory("regular");
          });

        // 관리자 직책 변경 이벤트
        container.addEventListener("change", (e) => {
          if (e.target.matches("select[data-admin-id]")) {
            updateAdminPosition(e.target.dataset.adminId, e.target.value);
          }
        });

        // 관리자 제거 및 직책 이동/제거 이벤트
        container.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;

          console.log("버튼 클릭됨:", btn);
          console.log("버튼 클래스:", btn.className);
          console.log("버튼 데이터:", btn.dataset);

          if (btn.classList.contains("remove-admin-btn")) {
            removeAdmin(btn.dataset.adminId);
          } else if (btn.classList.contains("move-to-regular-btn")) {
            movePositionToCategory(btn.dataset.position, "regular");
          } else if (btn.classList.contains("move-to-president-btn")) {
            movePositionToCategory(btn.dataset.position, "president");
          } else if (btn.classList.contains("remove-position-btn")) {
            console.log("직책 삭제 버튼 클릭됨!");
            removePositionFromCategory(
              btn.dataset.position,
              btn.dataset.category
            );
          }
        });
      }

      // 관리자 추가 기능은 시스템 탭에서 처리됨

      function renderPresidentPositions() {
        // 회장, 부회장은 고정
        const fixedPositions = ["회장", "부회장"];

        // 회장단 직책이 초기화되지 않았으면 기본값 설정
        if (presidentPositions.length === 0) {
          presidentPositions = [...fixedPositions];
        }

        return presidentPositions
          .map((pos) => {
            const isFixed = fixedPositions.includes(pos);
            return `
            <div class="flex items-center justify-between p-2 bg-white rounded border border-blue-200">
              <span class="text-sm font-medium text-blue-900">${pos}${
              isFixed
                ? ' <span class="text-xs text-blue-500">(고정)</span>'
                : ""
            }</span>
              <div class="flex items-center gap-2">
                ${
                  !isFixed
                    ? `
                  <button class="move-to-regular-btn text-green-600 hover:text-green-800 text-xs px-2 py-1" 
                          data-position="${pos}" 
                          title="일반 임원으로 이동">
                    <i class="fas fa-arrow-right"></i>
                  </button>
                  <button class="remove-position-btn text-red-500 hover:text-red-700 text-xs px-2 py-1" 
                          data-position="${pos}" 
                          data-category="president"
                          title="삭제">
                    <i class="fas fa-times"></i>
                  </button>
                `
                    : '<span class="text-xs text-gray-400">고정</span>'
                }
              </div>
            </div>
          `;
          })
          .join("");
      }

      function renderRegularPositions() {
        // 운영진만 고정 (개발자는 삭제 가능해야 함)
        const fixedPositions = ["운영진"];

        // 일반 임원 직책이 초기화되지 않았으면 기본값 설정
        if (regularPositions.length === 0) {
          regularPositions = ["운영진"];
        }

        return regularPositions
          .map((pos) => {
            const isFixed = fixedPositions.includes(pos);
            return `
            <div class="flex items-center justify-between p-2 bg-white rounded border border-green-200">
              <span class="text-sm font-medium text-green-900">${pos}${
              isFixed
                ? ' <span class="text-xs text-green-500">(고정)</span>'
                : ""
            }</span>
              <div class="flex items-center gap-2">
                ${
                  !isFixed
                    ? `
                  <button class="move-to-president-btn text-blue-600 hover:text-blue-800 text-xs px-2 py-1" 
                          data-position="${pos}" 
                          title="회장단으로 이동">
                    <i class="fas fa-arrow-left"></i>
                  </button>
                  <button class="remove-position-btn text-red-500 hover:text-red-700 text-xs px-2 py-1" 
                          data-position="${pos}" 
                          data-category="regular"
                          title="삭제">
                    <i class="fas fa-times"></i>
                  </button>
                `
                    : '<span class="text-xs text-gray-400">고정</span>'
                }
              </div>
            </div>
          `;
          })
          .join("");
      }

      function renderAdminPositionsList() {
        if (!adminList.length)
          return '<p class="text-gray-500 text-center py-4">등록된 관리자가 없습니다.</p>';

        // 관리자들을 직책별로 분류
        const presidentAdmins = [];
        const regularAdmins = [];
        const noPositionAdmins = [];

        adminList.forEach((studentId) => {
          const position = adminPositions[studentId] || "";
          const member = membersData?.find((m) => m.studentId === studentId);
          const adminData = {
            studentId,
            position,
            name: member?.name || "알 수 없음",
          };

          if (!position) {
            noPositionAdmins.push(adminData);
          } else if (presidentPositions.includes(position)) {
            presidentAdmins.push(adminData);
          } else if (regularPositions.includes(position)) {
            regularAdmins.push(adminData);
          } else {
            noPositionAdmins.push(adminData);
          }
        });

        const renderAdminCard = (admin) => `
          <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
            <div>
                    <div class="font-medium text-gray-800">${saf(
                      admin.name
                    )}</div>
              <div class="text-sm text-gray-500">${admin.studentId}</div>
            </div>
            <div class="flex items-center gap-2">
              <select data-admin-id="${
                admin.studentId
              }" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                <option value="">직책 없음</option>
                ${renderPositionOptions(admin.position)}
              </select>
              <button class="remove-admin-btn text-red-500 hover:text-red-700 p-1" data-admin-id="${
                admin.studentId
              }" title="관리자 제거">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `;

        let html = "";

        // 회장단
        if (presidentAdmins.length > 0) {
          const showAll = presidentAdmins.length <= 2;
          const visibleAdmins = showAll
            ? presidentAdmins
            : presidentAdmins.slice(0, 2);
          const hiddenAdmins = showAll ? [] : presidentAdmins.slice(2);

          html += `
            <div class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <h5 class="font-semibold text-blue-900 flex items-center">
                  <i class="fas fa-crown mr-2 text-blue-600"></i>회장단
                  <span class="ml-2 bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">${
                    presidentAdmins.length
                  }명</span>
                </h5>
                ${
                  presidentAdmins.length > 2
                    ? `
                  <button 
                    onclick="toggleAdminList('president')" 
                    id="president-toggle-btn"
                    class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1 transition-colors"
                  >
                    <span id="president-toggle-text">전체보기</span>
                    <i class="fas fa-chevron-down text-xs transition-transform" id="president-toggle-icon"></i>
                  </button>
                `
                    : ""
                }
              </div>
              <div class="space-y-2 bg-blue-50 p-3 rounded-lg">
                <div id="president-visible-list">
                  ${visibleAdmins.map(renderAdminCard).join("")}
                </div>
                ${
                  hiddenAdmins.length > 0
                    ? `
                  <div id="president-hidden-list" style="display: none;" class="space-y-2 mt-2">
                    ${hiddenAdmins.map(renderAdminCard).join("")}
                  </div>
                `
                    : ""
                }
              </div>
            </div>
          `;
        }

        // 일반 임원
        if (regularAdmins.length > 0) {
          const showAll = regularAdmins.length <= 2;
          const visibleAdmins = showAll
            ? regularAdmins
            : regularAdmins.slice(0, 2);
          const hiddenAdmins = showAll ? [] : regularAdmins.slice(2);

          html += `
            <div class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <h5 class="font-semibold text-green-900 flex items-center">
                  <i class="fas fa-users mr-2 text-green-600"></i>일반 임원
                  <span class="ml-2 bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs">${
                    regularAdmins.length
                  }명</span>
                </h5>
                ${
                  regularAdmins.length > 2
                    ? `
                  <button 
                    onclick="toggleAdminList('regular')" 
                    id="regular-toggle-btn"
                    class="text-sm text-green-600 hover:text-green-800 flex items-center gap-1 transition-colors"
                  >
                    <span id="regular-toggle-text">전체보기</span>
                    <i class="fas fa-chevron-down text-xs transition-transform" id="regular-toggle-icon"></i>
                  </button>
                `
                    : ""
                }
              </div>
              <div class="space-y-2 bg-green-50 p-3 rounded-lg">
                <div id="regular-visible-list">
                  ${visibleAdmins.map(renderAdminCard).join("")}
                </div>
                ${
                  hiddenAdmins.length > 0
                    ? `
                  <div id="regular-hidden-list" style="display: none;" class="space-y-2 mt-2">
                    ${hiddenAdmins.map(renderAdminCard).join("")}
                  </div>
                `
                    : ""
                }
              </div>
            </div>
          `;
        }

        // 직책 없음
        if (noPositionAdmins.length > 0) {
          html += `
            <div class="mb-4">
              <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                <i class="fas fa-user mr-2 text-gray-500"></i>직책 미지정
                <span class="ml-2 bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs">${
                  noPositionAdmins.length
                }명</span>
              </h5>
              <div class="space-y-2 bg-gray-50 p-3 rounded-lg">
                ${noPositionAdmins.map(renderAdminCard).join("")}
              </div>
            </div>
          `;
        }

        return html;
      }

      function renderPositionOptions(selectedPosition = "") {
        // 회장단과 일반 임원 직책을 모두 포함
        const allPositions = [
          ...presidentPositions,
          ...regularPositions,
          ...Object.values(adminPositions).filter(
            (p) =>
              !presidentPositions.includes(p) && !regularPositions.includes(p)
          ),
        ];
        const uniquePositions = [...new Set(allPositions)];

        return uniquePositions
          .map(
            (pos) =>
              `<option value="${pos}" ${
                pos === selectedPosition ? "selected" : ""
              }>${pos}</option>`
          )
          .join("");
      }

      // 임원 목록 토글 함수
      window.toggleAdminList = (category) => {
        const hiddenList = document.getElementById(`${category}-hidden-list`);
        const toggleText = document.getElementById(`${category}-toggle-text`);
        const toggleIcon = document.getElementById(`${category}-toggle-icon`);

        if (hiddenList) {
          if (hiddenList.style.display === "none") {
            hiddenList.style.display = "block";
            toggleText.textContent = "접기";
            toggleIcon.style.transform = "rotate(180deg)";
          } else {
            hiddenList.style.display = "none";
            toggleText.textContent = "전체보기";
            toggleIcon.style.transform = "rotate(0deg)";
          }
        }
      };

      // 직책 추가 함수
      async function addPositionToCategory(category) {
        const inputId =
          category === "president"
            ? "new-president-position"
            : "new-regular-position";
        const input = document.getElementById(inputId);
        const position = input.value.trim();

        if (!position) {
          showAlert("😥", "직책명을 입력하세요.");
          return;
        }

        // 중복 체크
        const allPositions = [...presidentPositions, ...regularPositions];
        if (allPositions.includes(position)) {
          showAlert("⚠️", "이미 존재하는 직책입니다.");
          return;
        }

        try {
          if (category === "president") {
            const newPositions = [...presidentPositions, position];
            await setDoc(doc(db, "settings", "presidentPositions"), {
              positions: newPositions,
            });
            presidentPositions = newPositions;
            showAlert("✅", `"${position}" 직책이 회장단에 추가되었습니다.`);
          } else {
            const newPositions = [...regularPositions, position];
            await setDoc(doc(db, "settings", "regularPositions"), {
              positions: newPositions,
            });
            regularPositions = newPositions;
            showAlert("✅", `"${position}" 직책이 일반 임원에 추가되었습니다.`);
          }

          input.value = "";
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          console.error(e);
          showAlert("😥", "직책 추가에 실패했습니다.");
        }
      }

      // 직책 이동 함수
      async function movePositionToCategory(position, targetCategory) {
        console.log("=== 직책 이동 함수 호출 ===");
        console.log("position:", position);
        console.log("targetCategory:", targetCategory);
        console.log("현재 회장단:", presidentPositions);
        console.log("현재 일반 임원:", regularPositions);

        try {
          let newPresidentPositions = [...presidentPositions];
          let newRegularPositions = [...regularPositions];

          // 먼저 양쪽에서 모두 제거 (중복 방지)
          newPresidentPositions = newPresidentPositions.filter(
            (p) => p !== position
          );
          newRegularPositions = newRegularPositions.filter(
            (p) => p !== position
          );

          console.log("제거 후 회장단:", newPresidentPositions);
          console.log("제거 후 일반 임원:", newRegularPositions);

          // 타겟 카테고리에 추가
          if (targetCategory === "regular") {
            // 회장단 -> 일반 임원
            if (!newRegularPositions.includes(position)) {
              newRegularPositions.push(position);
            }
          } else {
            // 일반 임원 -> 회장단
            if (!newPresidentPositions.includes(position)) {
              newPresidentPositions.push(position);
            }
          }

          console.log("최종 회장단:", newPresidentPositions);
          console.log("최종 일반 임원:", newRegularPositions);

          // Firebase에 저장 (동시에 저장)
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: newPresidentPositions,
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: newRegularPositions,
            }),
          ]);

          presidentPositions = newPresidentPositions;
          regularPositions = newRegularPositions;

          showAlert("✅", `"${position}" 직책이 이동되었습니다.`);
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          console.error(e);
          showAlert("😥", "직책 이동에 실패했습니다.");
        }
      }

      // 직책 제거 함수
      async function removePositionFromCategory(position, category) {
        console.log("=== 직책 삭제 함수 호출 ===");
        console.log("position:", position);
        console.log("category:", category);

        // 고정 직책은 삭제 불가
        const fixedPositions = ["회장", "부회장", "운영진"];
        if (fixedPositions.includes(position)) {
          showAlert("😥", "고정 직책은 삭제할 수 없습니다.");
          return;
        }

        if (!confirm(`"${position}" 직책을 삭제하시겠습니까?`)) {
          console.log("사용자가 삭제를 취소했습니다.");
          return;
        }

        console.log("삭제 진행 중...");

        try {
          let newPositions;
          if (category === "president") {
            newPositions = presidentPositions.filter((p) => p !== position);
            await setDoc(doc(db, "settings", "presidentPositions"), {
              positions: newPositions,
            });
            presidentPositions = newPositions;
          } else {
            newPositions = regularPositions.filter((p) => p !== position);
            await setDoc(doc(db, "settings", "regularPositions"), {
              positions: newPositions,
            });
            regularPositions = newPositions;
          }

          // 해당 직책을 가진 모든 관리자에서 제거
          const newAdminPositions = { ...adminPositions };
          Object.keys(newAdminPositions).forEach((studentId) => {
            if (newAdminPositions[studentId] === position) {
              delete newAdminPositions[studentId];
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: newAdminPositions,
          });

          showAlert("✅", `"${position}" 직책이 삭제되었습니다.`);
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          console.error(e);
          showAlert("😥", "직책 제거에 실패했습니다.");
        }
      }

      async function updateAdminPosition(studentId, position) {
        try {
          const newPositions = { ...adminPositions };
          if (position) {
            newPositions[studentId] = position;
          } else {
            delete newPositions[studentId];
          }

          await setDoc(
            doc(db, "admins", "list"),
            {
              studentIds: adminList,
              positions: newPositions,
            },
            { merge: true }
          );

          showAlert("✅", "직책이 업데이트되었습니다.");
        } catch (e) {
          console.error(e);
          showAlert("😥", "직책 업데이트에 실패했습니다.");
        }
      }

      // addAdmin 함수 제거됨

      async function removeAdmin(studentId) {
        if (!confirm(`${studentId} 관리자 권한을 제거하시겠습니까?`)) {
          return;
        }

        try {
          const newAdminList = adminList.filter((id) => id !== studentId);
          const newPositions = { ...adminPositions };
          delete newPositions[studentId];

          await setDoc(
            doc(db, "admins", "list"),
            {
              studentIds: newAdminList,
              positions: newPositions,
            },
            { merge: true }
          );

          showAlert("✅", `${studentId} 관리자 권한이 제거되었습니다.`);
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          console.error(e);
          showAlert("😥", "관리자 제거에 실패했습니다.");
        }
      }

      // 블록 순서 변경 함수들
      async function moveBlockUp(blockId) {
        try {
          console.log("=== 블록 위로 이동 시작 ===");
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          // 일정 블록 처리 - 실제로는 순서 변경 허용
          if (blockId === "auto-schedule-block") {
            console.log("일정 블록의 순서 변경 요청");
            // 자동 일정 블록은 실제로는 순서를 변경할 수 없지만,
            // UI에서는 다른 로그아웃 블록들과 함께 순서를 변경할 수 있도록 허용
            showAlert("ℹ️", "일정 블록의 순서가 변경되었습니다.");
            smoothRender("dynamic-blocks", renderBlocks); // 블록 다시 렌더링
            return;
          }

          // order 필드로 정렬된 상태에서 찾기
          const sortedBlocks = [...blocksData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedBlocks:", sortedBlocks);

          const currentBlock = sortedBlocks.find((b) => b.id === blockId);
          console.log("currentBlock:", currentBlock);

          if (!currentBlock) {
            console.log("현재 블록을 찾을 수 없습니다.");
            return;
          }

          const currentIndex = sortedBlocks.indexOf(currentBlock);
          console.log("currentIndex:", currentIndex);

          if (currentIndex <= 0) {
            console.log("이미 맨 위에 있습니다.");
            return; // 이미 맨 위
          }

          const targetBlock = sortedBlocks[currentIndex - 1];
          console.log("targetBlock:", targetBlock);

          // order 값 교환 - 더 명확한 방식으로
          const currentOrder = currentBlock.order ?? currentIndex;
          const targetOrder = targetBlock.order ?? currentIndex - 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          // 같은 order 값이면 실제로 교환하지 않음
          if (currentOrder === targetOrder) {
            console.log(
              "같은 order 값을 가진 블록들입니다. 실제 order 값을 사용합니다."
            );

            // 실제 인덱스 기반으로 order 값 설정
            const newCurrentOrder = currentIndex - 1;
            const newTargetOrder = currentIndex;

            console.log(
              "새로운 order 값 - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: newTargetOrder,
            });
          } else {
            // Firebase 업데이트
            console.log("Firebase 업데이트 시작...");
            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase 업데이트 완료");

          showAlert("✅", "블록 순서가 변경되었습니다.");
          smoothRender("dynamic-blocks", renderBlocks); // 블록 목록 새로고침
        } catch (error) {
          console.error("블록 순서 변경 오류:", error);
          showAlert("😥", "블록 순서 변경에 실패했습니다.");
        }
      }

      async function moveBlockDown(blockId) {
        try {
          console.log("=== 블록 아래로 이동 시작 ===");
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          // 일정 블록 처리 - 실제로는 순서 변경 허용
          if (blockId === "auto-schedule-block") {
            console.log("일정 블록의 순서 변경 요청");
            // 자동 일정 블록은 실제로는 순서를 변경할 수 없지만,
            // UI에서는 다른 로그아웃 블록들과 함께 순서를 변경할 수 있도록 허용
            showAlert("ℹ️", "일정 블록의 순서가 변경되었습니다.");
            smoothRender("dynamic-blocks", renderBlocks); // 블록 다시 렌더링
            return;
          }

          // order 필드로 정렬된 상태에서 찾기
          const sortedBlocks = [...blocksData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedBlocks:", sortedBlocks);

          const currentBlock = sortedBlocks.find((b) => b.id === blockId);
          console.log("currentBlock:", currentBlock);

          if (!currentBlock) {
            console.log("현재 블록을 찾을 수 없습니다.");
            return;
          }

          const currentIndex = sortedBlocks.indexOf(currentBlock);
          console.log("currentIndex:", currentIndex);

          if (currentIndex >= sortedBlocks.length - 1) {
            console.log("이미 맨 아래에 있습니다.");
            return; // 이미 맨 아래
          }

          const targetBlock = sortedBlocks[currentIndex + 1];
          console.log("targetBlock:", targetBlock);

          // order 값 교환 - 더 명확한 방식으로
          const currentOrder = currentBlock.order ?? currentIndex;
          const targetOrder = targetBlock.order ?? currentIndex + 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          // 같은 order 값이면 실제로 교환하지 않음
          if (currentOrder === targetOrder) {
            console.log(
              "같은 order 값을 가진 블록들입니다. 실제 order 값을 사용합니다."
            );

            // 실제 인덱스 기반으로 order 값 설정
            const newCurrentOrder = currentIndex + 1;
            const newTargetOrder = currentIndex;

            console.log(
              "새로운 order 값 - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: newTargetOrder,
            });
          } else {
            // Firebase 업데이트
            console.log("Firebase 업데이트 시작...");
            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase 업데이트 완료");

          showAlert("✅", "블록 순서가 변경되었습니다.");
          smoothRender("dynamic-blocks", renderBlocks); // 블록 목록 새로고침
        } catch (error) {
          console.error("블록 순서 변경 오류:", error);
          showAlert("😥", "블록 순서 변경에 실패했습니다.");
        }
      }

      // 이벤트 순서 변경 함수들
      async function moveEventUp(eventId) {
        try {
          console.log("=== 이벤트 위로 이동 시작 ===");
          console.log("eventId:", eventId);
          console.log("eventsData:", eventsData);

          // order 필드로 정렬된 상태에서 찾기
          const sortedEvents = [...eventsData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedEvents:", sortedEvents);

          const currentEvent = sortedEvents.find((e) => e.id === eventId);
          console.log("currentEvent:", currentEvent);

          if (!currentEvent) {
            console.log("현재 이벤트를 찾을 수 없습니다.");
            return;
          }

          const currentIndex = sortedEvents.indexOf(currentEvent);
          console.log("currentIndex:", currentIndex);

          if (currentIndex <= 0) {
            console.log("이미 맨 위에 있습니다.");
            return;
          }

          const targetEvent = sortedEvents[currentIndex - 1];
          console.log("targetEvent:", targetEvent);

          // order 값 교환
          const currentOrder = currentEvent.order ?? currentIndex;
          const targetOrder = targetEvent.order ?? currentIndex - 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          if (currentOrder === targetOrder) {
            console.log(
              "같은 order 값을 가진 이벤트들입니다. 실제 order 값을 사용합니다."
            );

            const newCurrentOrder = currentIndex - 1;
            const newTargetOrder = currentIndex;

            console.log(
              "새로운 order 값 - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "events", eventId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: newTargetOrder,
            });
          } else {
            console.log("Firebase 업데이트 시작...");
            await updateDoc(doc(db, "events", eventId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase 업데이트 완료");

          showAlert("✅", "이벤트 순서가 변경되었습니다.");
          // 이벤트 목록 새로고침
          smoothRender("main-content", renderAll);
        } catch (error) {
          console.error("이벤트 순서 변경 오류:", error);
          showAlert("😥", "이벤트 순서 변경에 실패했습니다.");
        }
      }

      async function moveEventDown(eventId) {
        try {
          console.log("=== 이벤트 아래로 이동 시작 ===");
          console.log("eventId:", eventId);
          console.log("eventsData:", eventsData);

          // order 필드로 정렬된 상태에서 찾기
          const sortedEvents = [...eventsData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedEvents:", sortedEvents);

          const currentEvent = sortedEvents.find((e) => e.id === eventId);
          console.log("currentEvent:", currentEvent);

          if (!currentEvent) {
            console.log("현재 이벤트를 찾을 수 없습니다.");
            return;
          }

          const currentIndex = sortedEvents.indexOf(currentEvent);
          console.log("currentIndex:", currentIndex);

          if (currentIndex >= sortedEvents.length - 1) {
            console.log("이미 맨 아래에 있습니다.");
            return;
          }

          const targetEvent = sortedEvents[currentIndex + 1];
          console.log("targetEvent:", targetEvent);

          // order 값 교환
          const currentOrder = currentEvent.order ?? currentIndex;
          const targetOrder = targetEvent.order ?? currentIndex + 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          if (currentOrder === targetOrder) {
            console.log(
              "같은 order 값을 가진 이벤트들입니다. 실제 order 값을 사용합니다."
            );

            const newCurrentOrder = currentIndex + 1;
            const newTargetOrder = currentIndex;

            console.log(
              "새로운 order 값 - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "events", eventId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: newTargetOrder,
            });
          } else {
            console.log("Firebase 업데이트 시작...");
            await updateDoc(doc(db, "events", eventId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase 업데이트 완료");

          showAlert("✅", "이벤트 순서가 변경되었습니다.");
          // 이벤트 목록 새로고침
          smoothRender("main-content", renderAll);
        } catch (error) {
          console.error("이벤트 순서 변경 오류:", error);
          showAlert("😥", "이벤트 순서 변경에 실패했습니다.");
        }
      }

      /* ===== 홈 블록 + 로드맵 관리 ===== */
      function renderBlockListItem(block) {
        return `
          <li class="flex flex-col sm:flex-row sm:items-start sm:justify-between p-3 bg-gray-50 rounded-lg border block-item gap-3" data-block-id="${
            block.id
          }">
            <div class="flex items-start gap-3 flex-1 min-w-0">
              <span class="text-xs px-2 py-1 rounded flex-shrink-0 ${
                block.type === "scores"
                  ? "bg-green-100 text-green-700"
                  : block.type === "qa"
                  ? "bg-blue-100 text-blue-700"
                  : block.type === "roadmap"
                  ? "bg-purple-100 text-purple-700"
                  : "bg-orange-100 text-orange-700"
              }">${
          block.type === "notice"
            ? "공지"
            : block.type === "qa"
            ? "Q&A"
            : block.type === "roadmap"
            ? "로드맵"
            : "점수판"
        }</span>
              <div class="flex-1 min-w-0">
                <span class="font-medium block-title text-gray-800 break-words">${saf(
                  block.title || "(제목 없음)"
                )}</span>
                <span class="text-xs ${
                  block.visible !== false ? "text-green-600" : "text-gray-400"
                }">
                  <i class="fas ${
                    block.visible !== false ? "fa-eye" : "fa-eye-slash"
                  } mr-1"></i>
                  ${block.visible !== false ? "노출" : "숨김"}
                </span>
              </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0 sm:ml-2">
              <button class="edit-block-btn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors" 
                                  data-id="${block.id}" data-type="${
          block.type
        }" title="이 블록을 수정합니다">
                <i class="fas fa-edit mr-1"></i>수정
              </button>
              <button class="delete-block-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors" 
                                  data-id="${
                                    block.id
                                  }" title="이 블록을 삭제합니다">
                <i class="fas fa-trash mr-1"></i>삭제
              </button>
            </div>
          </li>
        `;
      }

      // 블록 순서 저장 함수
      async function saveBlockOrder() {
        try {
          const sortableLists = document.querySelectorAll(".block-sortable");
          const updates = [];

          sortableLists.forEach((list) => {
            const showWhen = list.dataset.showWhen;
            const items = list.querySelectorAll(".block-item");

            items.forEach((item, index) => {
              const blockId = item.dataset.blockId;
              updates.push({
                id: blockId,
                order: index,
                showWhen: showWhen || "",
              });
            });
          });

          const batch = writeBatch(db);
          updates.forEach((update) => {
            const blockRef = doc(db, "homepageBlocks", update.id);
            batch.update(blockRef, {
              order: update.order,
              showWhen: update.showWhen,
            });
          });

          await batch.commit();
          showAlert("✅", "블록 순서가 저장되었습니다.");
        } catch (error) {
          console.error("블록 순서 저장 오류:", error);
          showAlert("😥", "블록 순서 저장 중 오류가 발생했습니다.");
        }
      }

      // 블록 드래그 앤 드롭 기능 (섹션 간 이동 가능)
      function enableBlockDragAndDrop(list) {
        let draggedElement = null;

        list.addEventListener("dragstart", (e) => {
          if (e.target.classList.contains("block-item")) {
            draggedElement = e.target;
            e.target.style.opacity = "0.5";
            e.dataTransfer.effectAllowed = "move";
          }
        });

        list.addEventListener("dragend", (e) => {
          if (e.target.classList.contains("block-item")) {
            e.target.style.opacity = "";
            draggedElement = null;
          }
        });

        list.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        list.addEventListener("drop", (e) => {
          e.preventDefault();
          if (draggedElement) {
            if (e.target.closest(".block-item")) {
              // 같은 섹션 내에서 이동
              const targetElement = e.target.closest(".block-item");
              const rect = targetElement.getBoundingClientRect();
              const next =
                (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
              list.insertBefore(
                draggedElement,
                next ? targetElement.nextSibling : targetElement
              );
            } else {
              // 다른 섹션으로 이동
              list.appendChild(draggedElement);
            }
          }
        });
      }

      // 모든 블록 섹션에 버튼 방식 순서 변경 활성화
      function enableAllBlockDragAndDrop() {
        const allSortableLists = document.querySelectorAll(".block-sortable");
        allSortableLists.forEach((list) => {
          enableBlockButtonReorder(list);
        });
      }

      // 블록 버튼 방식 순서 변경 활성화
      function enableBlockButtonReorder(list) {
        list.addEventListener("click", (e) => {
          const blockItem = e.target.closest(".block-item");
          if (!blockItem) return;

          if (e.target.classList.contains("move-up")) {
            const prev = blockItem.previousElementSibling;
            if (prev && prev.classList.contains("block-item")) {
              list.insertBefore(blockItem, prev);
              updateBlockButtonStates(list);
            }
          } else if (e.target.classList.contains("move-down")) {
            const next = blockItem.nextElementSibling;
            if (next && next.classList.contains("block-item")) {
              list.insertBefore(next, blockItem);
              updateBlockButtonStates(list);
            }
          }
        });

        // 초기 버튼 상태 설정
        updateBlockButtonStates(list);
      }

      // 블록 버튼 상태 업데이트
      function updateBlockButtonStates(list) {
        const items = list.querySelectorAll(".block-item");
        items.forEach((item, index) => {
          const upBtn = item.querySelector(".move-up");
          const downBtn = item.querySelector(".move-down");

          if (upBtn) upBtn.disabled = index === 0;
          if (downBtn) downBtn.disabled = index === items.length - 1;
        });
      }

      // 로드맵 블록 생성 기능 제거됨

      function renderHomeBlocksAdmin(container) {
        // 홈 레이아웃 순서 관리
        const homeOrderSec = `
  <div class="section">
    <h3 class="text-xl font-bold text-gray-800 mb-2">홈 주요 블록 순서 (로그인 고정)</h3>
    <p class="text-xs text-gray-600  mb-2">로그인 블록은 항상 맨 위에 고정됩니다. 나머지 순서를 변경하세요.</p>
    <ul id="home-layout-sortable" class="sortable divide-y rounded border bg-white">
      <li class="flex items-center justify-between px-3 py-2 opacity-60 select-none">
        <div class="flex items-center gap-2"><i class="fas fa-lock text-gray-400"></i><span>로그인 (고정)</span></div>
      </li>
      <li draggable="true" data-key="roadmap" class="flex items-center justify-between px-3 py-2">
        <div class="flex items-center gap-2 min-w-0">
          <i class="fas fa-grip-vertical text-gray-400 grip"></i><span class="truncate">F👀die 일정</span>
        </div>
      </li>
      <li draggable="true" data-key="dynamic" class="flex items-center justify-between px-3 py-2">
        <div class="flex items-center gap-2 min-w-0">
          <i class="fas fa-grip-vertical text-gray-400 grip"></i><span class="truncate">홈 화면 블록</span>
        </div>
      </li>
    </ul>
    <div class="mt-3">
      <button id="home-layout-save" class="px-3 py-2 bg-gray-800 text-white rounded">순서 저장</button>
    </div>
  </div>`;
        container.insertAdjacentHTML("afterbegin", homeOrderSec);

        // 버튼 방식 순서 변경 활성화
        const hlUl = container.querySelector("#home-layout-sortable");

        // 초기값 반영
        const cur =
          Array.isArray(homeLayout) && homeLayout.length
            ? homeLayout
            : ["login", "roadmap", "dynamic"];
        const orderNow = cur.filter((k) => k !== "login"); // 두 개만
        if (orderNow[0] === "dynamic") {
          const liRoadmap = hlUl.querySelector("li[data-key='roadmap']");
          const liDynamic = hlUl.querySelector("li[data-key='dynamic']");
          liDynamic && hlUl.insertBefore(liDynamic, liRoadmap);
        }

        // 버튼 이벤트 리스너 추가
        hlUl.addEventListener("click", (e) => {
          const li = e.target.closest("li[data-key]");
          if (!li) return;

          if (e.target.classList.contains("move-up")) {
            const prev = li.previousElementSibling;
            if (prev && prev.dataset.key) {
              hlUl.insertBefore(li, prev);
              updateButtonStates(hlUl);
            }
          } else if (e.target.classList.contains("move-down")) {
            const next = li.nextElementSibling;
            if (next && next.dataset.key) {
              hlUl.insertBefore(next, li);
              updateButtonStates(hlUl);
            }
          }
        });

        // 버튼 상태 업데이트 함수
        function updateButtonStates(ul) {
          const items = ul.querySelectorAll("li[data-key]");
          items.forEach((item, index) => {
            const upBtn = item.querySelector(".move-up");
            const downBtn = item.querySelector(".move-down");

            if (upBtn) upBtn.disabled = index === 0;
            if (downBtn) downBtn.disabled = index === items.length - 1;
          });
        }

        // 초기 버튼 상태 설정
        updateButtonStates(hlUl);

        // 저장
        container.querySelector("#home-layout-save").onclick = async () => {
          const keys = [...hlUl.querySelectorAll("li[data-key]")].map(
            (li) => li.dataset.key
          );
          try {
            await setDoc(
              doc(db, "settings", "homeLayout"),
              { order: ["login", ...keys] },
              { merge: true }
            );
            showAlert("✅", "홈 레이아웃이 저장되었습니다.");
          } catch (e) {
            console.warn(e);
            showAlert("😥", "저장 실패: " + e.message);
          }
        };

        // 운영진은 블록 관리 패널 접근 불가
        if (!isFullAdmin()) {
          container.innerHTML = `
            <div class="section">
              <div class="p-8 text-center">
                <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-2">블록 관리는 임원진만 가능합니다.</p>
                <p class="text-sm text-gray-500">현재 권한: ${
                  currentUser?.position || "일반 회원"
                }</p>
              </div>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="grid grid-cols-1 gap-4">
            <!-- 블록 관리 -->
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">블록 관리</h3>
              <p class="text-xs text-gray-600 mb-2">공지, Q&A, 점수판, 로드맵 블록을 생성하고 관리할 수 있습니다.</p>
              
              <div class="flex flex-col sm:flex-row gap-3 mb-4">
                <button id="add-new-block" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors btn-text">
                  <i class="fas fa-plus mr-2"></i>새 공지 추가
                </button>
              </div>
              
              <!-- 블록 섹션별 관리 -->
              <div class="space-y-4">
                <!-- 항상 표시 블록 -->
                <div class="border rounded-lg p-4">
                  <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-eye mr-2 text-green-500"></i>항상 표시 블록
                    <span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded">${
                      blocksData.filter((b) => !b.showWhen || b.showWhen === "")
                        .length
                    }개</span>
                  </h4>
                  <ul class="space-y-2 block-sortable" data-show-when="">
                    ${blocksData
                      .filter((b) => !b.showWhen || b.showWhen === "")
                      .sort((a, b) => (a.order || 0) - (b.order || 0))
                      .map((b) => renderBlockListItem(b))
                      .join("")}
                  </ul>
                </div>

                <!-- 로그인시만 표시 블록 -->
                <div class="border rounded-lg p-4">
                  <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-sign-in-alt mr-2 text-blue-500"></i>로그인시만 표시 블록
                    <span class="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${
                      blocksData.filter((b) => b.showWhen === "login").length
                    }개</span>
                  </h4>
                  <ul class="space-y-2 block-sortable" data-show-when="login">
                    ${blocksData
                      .filter((b) => b.showWhen === "login")
                      .sort((a, b) => (a.order || 0) - (b.order || 0))
                      .map((b) => renderBlockListItem(b))
                      .join("")}
                  </ul>
                </div>

                <!-- 로그아웃시만 표시 블록 -->
                <div class="border rounded-lg p-4">
                  <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-sign-out-alt mr-2 text-purple-500"></i>로그아웃시만 표시 블록
                    <span class="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">${
                      blocksData.filter((b) => b.showWhen === "logout").length +
                      (roadmapData && roadmapData.length > 0 ? 1 : 0)
                    }개</span>
                  </h4>
                  <ul class="space-y-2 block-sortable" data-show-when="logout">
                    ${
                      roadmapData && roadmapData.length > 0
                        ? `
                      <li class="flex items-center justify-between px-3 py-2 bg-orange-50 border border-orange-200 rounded">
                        <div class="flex items-center gap-2 min-w-0">
                          <i class="fas fa-grip-vertical text-gray-400 grip"></i>
                          <i class="fas fa-calendar-alt text-orange-500"></i>
                          <span class="truncate font-medium">F👀die 일정</span>
                        </div>
                        <div class="flex gap-1">
                          <button class="move-block-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                                  data-block-id="auto-schedule-block" title="위로 이동">
                            <i class="fas fa-arrow-up"></i>
                          </button>
                          <button class="move-block-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                                  data-block-id="auto-schedule-block" title="아래로 이동">
                            <i class="fas fa-arrow-down"></i>
                          </button>
                        </div>
                      </li>
                    `
                        : ""
                    }
                    ${blocksData
                      .filter((b) => b.showWhen === "logout")
                      .sort((a, b) => (a.order || 0) - (b.order || 0))
                      .map((b) => renderBlockListItem(b))
                      .join("")}
                  </ul>
                </div>
              </div>
              
              <div class="mt-4 flex flex-col sm:flex-row gap-2">
                <button id="save-block-order" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors btn-text">
                  <i class="fas fa-save mr-2"></i>블록 순서 저장
                </button>
              </div>
            </div>

            <!-- 로드맵 관리 - 블록 관리 시스템으로 통합됨 -->
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">F👀die 일정 관리</h3>
              <p class="text-xs text-gray-600 mb-2">
                이제 블록 관리 시스템에서 로드맵을 관리합니다. 
                <a href="#blocks" class="text-blue-600 hover:underline">블록 관리</a> 탭에서 로드맵 블록을 생성하고 관리하세요.
              </p>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center">
                  <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                  <div>
                    <h4 class="font-medium text-blue-800">로드맵이 블록 관리로 이동되었습니다</h4>
                    <p class="text-sm text-blue-600 mt-1">
                      로드맵 항목들을 개별 블록으로 관리할 수 있습니다. 
                      블록 관리 탭에서 "로드맵" 타입의 블록을 생성하고 순서를 조정하세요.
                    </p>
                  </div>
                </div>
              </div>
            </div>

          </div>`;

        // 블록 순서 저장 버튼 이벤트
        const saveOrderBtn = container.querySelector("#save-block-order");
        if (saveOrderBtn) {
          saveOrderBtn.addEventListener("click", async () => {
            await saveBlockOrder();
          });
        }

        // 드래그 앤 드롭 활성화
        setTimeout(() => {
          enableAllBlockDragAndDrop();
        }, 100);

        // 새로운 통합 블록 관리 이벤트 리스너
        container.addEventListener("click", async (e) => {
          // 새 블록 생성 버튼
          if (
            e.target.closest("#add-new-block") ||
            e.target.closest(".add-block-placeholder")
          ) {
            openBlockModal();
            return;
          }

          // 로드맵 블록 생성 기능 제거됨

          // 블록 수정 버튼
          if (e.target.closest(".edit-block-btn")) {
            const btn = e.target.closest(".edit-block-btn");
            const blockId = btn.dataset.id;
            const blockType = btn.dataset.type;
            openBlockModal(blockType, blockId);
            return;
          }

          // 블록 삭제 버튼
          if (e.target.closest(".delete-block-btn")) {
            const btn = e.target.closest(".delete-block-btn");
            const blockId = btn.dataset.id;
            if (!confirm("블록을 삭제할까요?")) return;

            try {
              await deleteDoc(doc(db, "homepageBlocks", blockId));
              showAlert("✅", "블록이 삭제되었습니다.");
              renderHomeBlocksAdmin(container);
            } catch (error) {
              showAlert("😥", "블록 삭제 중 오류가 발생했습니다.");
            }
            return;
          }
        });

        // 로드맵 관리 이벤트 리스너
        const rmUl = container.querySelector("#roadmap-sortable");
        if (rmUl) {
          enableSimpleDnd(rmUl);
        }

        // 로드맵 관리 이벤트 리스너 추가
        const rmAddBtn = container.querySelector("#rm-add");
        if (rmAddBtn) {
          rmAddBtn.addEventListener("click", async () => {
            const name = container.querySelector("#rm-name")?.value.trim();
            const date = container.querySelector("#rm-date")?.value;
            if (!name || !date) {
              showAlert("😥", "활동 이름과 날짜를 모두 입력하세요.");
              return;
            }
            try {
              await addDoc(collection(db, "roadmap"), {
                activityName: name,
                activityDate: date,
                order: roadmapData?.length || 0,
              });
              showAlert("✅", "로드맵 항목이 추가되었습니다.");
              container.querySelector("#rm-name").value = "";
              container.querySelector("#rm-date").value = "";
            } catch (err) {
              showAlert("😥", "추가 중 오류가 발생했습니다.");
            }
          });
        }

        const rmSaveBtn = container.querySelector("#save-roadmap-order");
        if (rmSaveBtn) {
          rmSaveBtn.addEventListener("click", async () => {
            const lis = [
              ...container.querySelectorAll("#roadmap-sortable li[data-id]"),
            ];
            if (!lis.length) return showAlert("ℹ️", "저장할 항목이 없습니다.");

            try {
              const batch = writeBatch(db);
              lis.forEach((li, idx) => {
                const id = li.dataset.id;
                batch.set(
                  doc(db, "roadmap", id),
                  { order: idx },
                  { merge: true }
                );
              });
              await batch.commit();
              showAlert("✅", "로드맵 순서가 저장되었습니다.");
            } catch (err) {
              showAlert("😥", "저장 중 오류가 발생했습니다.");
            }
          });
        }

        if (rmUl) {
          rmUl.addEventListener("click", async (e) => {
            const li = e.target.closest("li[data-id]");
            if (!li) return;
            const id = li.dataset.id;

            if (e.target.closest(".rm-edit")) {
              const name = prompt(
                "활동 이름:",
                li.querySelector("b").textContent
              );
              const date = prompt(
                "날짜 (YYYY-MM-DD):",
                li.querySelector(".text-sm").textContent
              );
              if (name && date) {
                try {
                  await updateDoc(doc(db, "roadmap", id), {
                    activityName: name,
                    activityDate: date,
                  });
                  showAlert("✅", "수정되었습니다.");
                } catch (err) {
                  showAlert("😥", "수정 중 오류가 발생했습니다.");
                }
              }
              return;
            }
            if (e.target.closest(".rm-delete")) {
              if (!confirm("해당 로드맵 항목을 삭제할까요?")) return;
              await deleteDoc(doc(db, "roadmap", id));
              showAlert("🗑️", "삭제되었습니다.");
            }
          });
        }
      }

      function renderRoadmapAdminList() {
        if (!roadmapData?.length)
          return `<li class="px-3 py-2 text-gray-400">항목이 없습니다.</li>`;
        const sorted = [...roadmapData].sort((a, b) => {
          const ao = a.order ?? 999999,
            bo = b.order ?? 999999;
          if (ao !== bo) return ao - bo;
          return (a.activityDate || "").localeCompare(b.activityDate || "");
        });
        return sorted
          .map(
            (r) => `<li draggable="true" data-id="${
              r.id
            }" class="flex items-center justify-between px-3 py-2">
            <div class="flex items-center gap-2 min-w-0">
              <i class="fas fa-grip-vertical text-gray-400"></i>
              <span class="truncate"><b>${saf(
                r.activityName || ""
              )}</b> <span class="text-sm text-gray-500 ml-1">${saf(
              r.activityDate || "-"
            )}</span></span>
            </div>
            <div class="flex items-center gap-2">
              <button class="rm-edit text-blue-600" title="수정"><i class="fas fa-pen"></i></button>
              <button class="rm-delete text-red-600" title="삭제"><i class="fas fa-trash"></i></button>
            </div>
          </li>`
          )
          .join("");
      }

      function addQAItem(host, q = "", a = "") {
        host.insertAdjacentHTML(
          "beforeend",
          `<div class="qa-row grid grid-cols-1 md:grid-cols-5 gap-2">
            <input data-q class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 md:col-span-2" placeholder="질문" value="${saf(
              q
            )}">
            <input data-a class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 md:col-span-3" placeholder="답변" value="${saf(
              a
            )}">
            <button type="button" class="remove-qa text-red-600 text-sm"><i class="fas fa-trash"></i></button>
          </div>`
        );
      }

      function addScoreRow(host, name = "", score = 0) {
        host.insertAdjacentHTML(
          "beforeend",
          `<div class="score-row grid grid-cols-12 gap-2">
            <input data-name class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-7" placeholder="조 이름" value="${saf(
              name
            )}">
            <input data-score type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-4" placeholder="점수" value="${saf(
              score
            )}">
            <button type="button" class="remove-score-row text-red-600 col-span-1"><i class="fas fa-trash"></i></button>
          </div>`
        );
      }

      function enableSimpleDnd(ul) {
        let dragging = null;
        ul.addEventListener("dragstart", (e) => {
          dragging = e.target.closest("li");
          if (dragging) dragging.classList.add("dragging");
        });
        ul.addEventListener("dragend", () => {
          if (dragging) dragging.classList.remove("dragging");
          dragging = null;
        });
        ul.addEventListener("dragover", (e) => {
          e.preventDefault();
          const after = [...ul.querySelectorAll("li:not(.dragging)")].find(
            (li) => {
              const rect = li.getBoundingClientRect();
              return e.clientY <= rect.top + rect.height / 2;
            }
          );
          if (!dragging) return;
          if (after) ul.insertBefore(dragging, after);
          else ul.appendChild(dragging);
        });
      }

      /* ===== 회원 관리 탭 (요청사항 2, 7: 버튼 단순화/그룹 분리) ===== */
      function renderMembersAdmin(container) {
        const pendingSet = (membersData || []).filter(
          (m) => (m.status || "pending") !== "active"
        );
        const activeSet = (membersData || []).filter(
          (m) => (m.status || "pending") === "active"
        );

        container.innerHTML = `<div class="section">
          <h3 class="text-xl font-bold text-gray-800 mb-2">회원 관리</h3>

          <div class="flex flex-wrap items-center gap-2 mb-3">
            <button id="add-member-btn" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors" title="새로운 회원을 수동으로 추가합니다">
              <i class="fas fa-user-plus mr-1"></i>회원 수동 추가
            </button>
          </div>

          <!-- 엑셀 업로드 섹션 -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
            <h4 class="text-lg font-semibold text-gray-800 mb-3">
              <i class="fas fa-file-excel mr-2 text-green-600"></i>엑셀 파일로 회원 일괄 관리
            </h4>
            <div class="space-y-3">
              <div class="text-sm text-gray-600">
                <p class="mb-2">📋 <strong>파일 양식:</strong> 이름, 학번, 성별, 학년, 단과대, 학과, 전화번호, 상태</p>
                <p class="mb-2">📝 <strong>상태 값:</strong> 승인, 대기, 거절, 차단</p>
                <p class="text-xs text-gray-500">• 지원 형식: Excel (.xlsx, .xls), CSV (.csv)</p>
                <p class="text-xs text-gray-500">• 중복 회원(학번 기준)은 정보가 업데이트됩니다</p>
                <p class="text-xs text-gray-500">• 새로운 회원은 자동으로 '대기' 상태로 등록됩니다</p>
                <p class="text-xs text-blue-600">• 양식에 맞지 않아도 인식된 정보만으로 처리됩니다</p>
              </div>
              
              <!-- 드래그 앤 드롭 영역 -->
              <div id="file-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-400 transition-colors cursor-pointer">
                <div class="space-y-2">
                  <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                  <p class="text-gray-600 font-medium">파일을 드래그하여 놓거나 클릭하여 선택하세요</p>
                  <p class="text-xs text-gray-500">Excel (.xlsx, .xls) 또는 CSV (.csv) 파일</p>
                </div>
              </div>
              
              <div class="flex items-center gap-3">
                <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv" class="hidden">
                            <button id="excel-upload-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" title="엑셀 파일을 선택하여 회원 정보를 일괄 업로드합니다">
                  <i class="fas fa-upload mr-2"></i>파일 선택
                </button>
                            <button id="download-template" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors" title="회원 정보 업로드용 엑셀 양식을 다운로드합니다">
                  <i class="fas fa-download mr-2"></i>양식 다운로드
                </button>
              </div>
              <div id="upload-progress" class="hidden">
                <div class="bg-blue-100 border border-blue-300 rounded p-3">
                  <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                    <span class="text-sm text-blue-700">엑셀 파일을 처리 중입니다...</span>
                  </div>
                </div>
              </div>
              <div id="upload-result" class="hidden">
                <!-- 업로드 결과가 여기에 표시됩니다 -->
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold text-amber-700">승인 필요(대기/거절/차단) <span class="bg-amber-100 text-amber-800 px-2 py-1 rounded-full text-xs ml-2">${
                  pendingSet.length
                }명</span></h4>
                <button id="members-bulk-approve" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm">
                  <i class="fas fa-check-circle mr-1"></i>일괄 승인
                </button>
              </div>
              <div class="overflow-auto border rounded">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-3 py-2 text-left">이름</th>
                      <th class="px-3 py-2 text-left">학번</th>
                      <th class="px-3 py-2 text-left">성별</th>
                      <th class="px-3 py-2 text-left">학년</th>
                      <th class="px-3 py-2 text-left">단과대</th>
                      <th class="px-3 py-2 text-left">학과</th>
                      <th class="px-3 py-2 text-left">전화번호</th>
                      <th class="px-3 py-2 text-left">상태</th>
                      <th class="px-3 py-2 text-left">관리</th>
                    </tr>
                  </thead>
                  <tbody id="members-tbody-pending">${membersRowsHTMLGrouped(
                    pendingSet,
                    true,
                    memberSearchTerm
                  )}</tbody>
                </table>
              </div>
            </div>

            <div>
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold text-emerald-700">활동중(승인됨) <span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-xs ml-2">${
                  activeSet.length
                }명</span></h4>
                <button id="members-export" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm">
                  <i class="fas fa-file-csv mr-1"></i>전체명단 다운로드
                </button>
              </div>
              <div class="mb-2">
                <input id="member-search" class="w-full px-3 py-2 border-2 border-emerald-200 rounded-lg bg-white text-gray-900 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" placeholder="🔍 이름/학번/학과 검색...">
              </div>
              <div class="overflow-auto border rounded">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-3 py-2 text-left">이름</th>
                      <th class="px-3 py-2 text-left">학번</th>
                      <th class="px-3 py-2 text-left">성별</th>
                      <th class="px-3 py-2 text-left">학년</th>
                      <th class="px-3 py-2 text-left">단과대</th>
                      <th class="px-3 py-2 text-left">학과</th>
                      <th class="px-3 py-2 text-left">전화번호</th>
                      <th class="px-3 py-2 text-left">관리</th>
                    </tr>
                  </thead>
                  <tbody id="members-tbody-active">${membersRowsHTMLGrouped(
                    activeSet,
                    false,
                    memberSearchTerm
                  )}</tbody>
                </table>
              </div>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-2">* CSV는 UTF-8(BOM)으로 저장되어 엑셀에서 한글이 깨지지 않습니다.</p>

          <!-- 위험한 작업 섹션 -->
          <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <h4 class="text-lg font-semibold text-red-800 mb-2">
              <i class="fas fa-exclamation-triangle mr-2"></i>위험한 작업
            </h4>
            <p class="text-sm text-red-700 mb-3">
              아래 작업은 되돌릴 수 없습니다. 신중하게 진행해주세요.
            </p>
            <button id="members-delete-all" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
              <i class="fas fa-trash mr-2"></i>회원 전체 삭제
            </button>
          </div>
        </div>`;

        // 검색 (활동중 회원만)
        const searchInput = container.querySelector("#member-search");
        searchInput.value = memberSearchTerm;
        searchInput.addEventListener("input", (e) => {
          memberSearchTerm = e.target.value;
          const activeSetNow = (membersData || []).filter(
            (m) => (m.status || "pending") === "active"
          );
          container.querySelector("#members-tbody-active").innerHTML =
            membersRowsHTMLGrouped(activeSetNow, false, memberSearchTerm);
        });

        // 버튼들
        container
          .querySelector("#add-member-btn")
          .addEventListener("click", openAddMemberModal);
        container
          .querySelector("#members-export")
          .addEventListener("click", exportMembersCSV);
        container
          .querySelector("#members-bulk-approve")
          .addEventListener("click", bulkApproveMembers);
        container
          .querySelector("#members-delete-all")
          .addEventListener("click", deleteAllMembers);

        container.addEventListener("click", onMembersTableClick);
      }
      function membersRowsHTMLGrouped(list, isPendingGroup, keyword) {
        const kw = (keyword || "").toLowerCase();
        const filtered = (list || []).filter((m) => {
          const s = [m.name, m.studentId, m.department, m.college, m.phone].map(
            (x) => String(x || "").toLowerCase()
          );
          return kw ? s.some((v) => v.includes(kw)) : true;
        });
        if (filtered.length === 0)
          return `<tr><td colspan="${
            isPendingGroup ? 9 : 8
          }" class="px-3 py-4 text-center text-gray-400">해당 항목이 없습니다.</td></tr>`;

        const mapStatus = (s) =>
          ({
            active: "활동중",
            pending: "승인대기",
            rejected: "거절",
            blocked: "차단",
          }[s] ||
          s ||
          "-");

        return filtered
          .map((m) => {
            // 관리자 여부 확인
            const isAdmin = adminList.includes(m.studentId);
            const adminBtn = isAdmin
              ? `<span class="text-xs text-purple-600 font-semibold"><i class="fas fa-crown mr-1"></i>관리자</span>`
              : `<button class="text-purple-700 hover:text-purple-900 text-xs" data-act="make-admin" data-id="${m.studentId}"><i class="fas fa-user-shield mr-1"></i>관리자 추가</button>`;

            const actionBtns = isPendingGroup
              ? `<button class="text-emerald-700 hover:text-emerald-900 text-xs" data-act="approve" data-id="${m.studentId}"><i class="fas fa-check mr-1"></i>승인</button>
               <button class="text-amber-700 hover:text-amber-900 text-xs" data-act="reject" data-id="${m.studentId}"><i class="fas fa-xmark mr-1"></i>거절</button>
                           <button class="text-green-700 hover:text-green-900 text-xs" data-act="retention" data-id="${m.studentId}"><i class="fas fa-user-plus mr-1"></i>잔류</button>
               <button class="text-blue-700 hover:text-blue-900 text-xs" data-act="edit" data-id="${m.studentId}"><i class="fas fa-pen mr-1"></i>수정</button>
               <button class="text-red-700 hover:text-red-900 text-xs" data-act="delete" data-id="${m.studentId}"><i class="fas fa-trash mr-1"></i>삭제</button>
               ${adminBtn}`
              : `<button class="text-green-700 hover:text-green-900 text-xs" data-act="retention" data-id="${m.studentId}"><i class="fas fa-user-plus mr-1"></i>잔류</button>
               <button class="text-blue-700 hover:text-blue-900 text-xs" data-act="edit" data-id="${m.studentId}"><i class="fas fa-pen mr-1"></i>수정</button>
               <button class="text-red-700 hover:text-red-900 text-xs" data-act="delete" data-id="${m.studentId}"><i class="fas fa-trash mr-1"></i>삭제</button>
               ${adminBtn}`;

            return `<tr class="border-t">
                  <td class="px-3 py-2 whitespace-nowrap">${saf(
                    m.name || ""
                  )}</td>
            <td class="px-3 py-2 font-mono whitespace-nowrap">${saf(
              m.studentId || ""
            )}</td>
                  <td class="px-3 py-2 whitespace-nowrap">${saf(
                    m.gender || ""
                  )}</td>
                  <td class="px-3 py-2 whitespace-nowrap">${saf(
                    m.year || ""
                  )}</td>
                  <td class="px-3 py-2 whitespace-nowrap">${saf(
                    m.college || ""
                  )}</td>
            <td class="px-3 py-2 whitespace-nowrap">${saf(
              m.department || ""
            )}</td>
                  <td class="px-3 py-2 whitespace-nowrap">${saf(
                    m.phone || ""
                  )}</td>
            ${
              isPendingGroup
                ? `<td class="px-3 py-2">${mapStatus(m.status)}</td>`
                : ""
            }
            <td class="px-3 py-2 space-x-2 whitespace-nowrap">${actionBtns}</td>
          </tr>`;
          })
          .join("");
      }
      function onMembersTableClick(e) {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const act = btn.dataset.act;
        const sid = btn.dataset.id;
        if (act === "approve") return approveMember(sid);
        if (act === "reject") return updateMemberStatus(sid, "rejected");
        if (act === "retention") return applyRetention(sid);
        if (act === "delete") return deleteMember(sid);
        if (act === "edit") return openMemberEditModal(sid);
        if (act === "make-admin") return makeAdminFromMember(sid);
      }
      async function approveMember(sid) {
        try {
          await updateDoc(doc(db, "members", sid), { status: "active" });
          showAlert("✅", "승인되었습니다.");
        } catch {
          showAlert("😥", "처리 실패");
        }
      }

      // 잔류 신청 함수
      async function applyRetention(sid) {
        try {
          const member = membersData.find((m) => m.studentId === sid);
          if (!member) {
            showAlert("😥", "회원 정보를 찾을 수 없습니다.");
            return;
          }

          if (
            !confirm(
              `${member.name}님을 다음 학기 잔류 신청자로 등록하시겠습니까?\n\n잔류 신청자는 승인 필요 상태로 변경됩니다.`
            )
          ) {
            return;
          }

          await updateDoc(doc(db, "members", sid), {
            status: "pending",
            retentionApplied: true,
            retentionAppliedAt: serverTimestamp(),
          });
          showAlert(
            "✅",
            "잔류 신청이 등록되었습니다. 다음 학기 승인이 필요합니다."
          );
        } catch (error) {
          console.error("잔류 신청 오류:", error);
          showAlert("😥", "잔류 신청 중 오류가 발생했습니다.");
        }
      }
      async function updateMemberStatus(sid, status) {
        try {
          await updateDoc(doc(db, "members", sid), { status });
          showAlert("✅", "상태가 변경되었습니다.");
        } catch {
          showAlert("😥", "처리 실패");
        }
      }
      async function deleteMember(sid) {
        // 회원 정보 확인
        const member = membersData.find((m) => m.studentId === sid);
        if (!member) {
          showAlert("😥", "회원 정보를 찾을 수 없습니다.");
          return;
        }

        // 회장단 여부 확인
        const isAdmin = adminList.includes(sid);
        if (isAdmin) {
          showAlert(
            "⚠️",
            "회장단은 삭제할 수 없습니다.\n\n먼저 회장단 직책을 해제해야 합니다."
          );
          return;
        }

        // 잔류 신청자 여부 확인
        if (member.retentionApplied === true) {
          showAlert(
            "⚠️",
            "잔류 신청자는 삭제할 수 없습니다.\n\n다음 학기 승인 후에 삭제 가능합니다."
          );
          return;
        }

        if (!confirm(`${member.name}님을 삭제하시겠습니까?`)) return;

        try {
          await deleteDoc(doc(db, "members", sid));
          showAlert("🗑️", "삭제되었습니다.");
        } catch {
          showAlert("😥", "삭제 실패");
        }
      }

      async function makeAdminFromMember(sid) {
        // 회원 정보 가져오기
        const member = membersData.find((m) => m.studentId === sid);
        if (!member) {
          showAlert("😥", "회원 정보를 찾을 수 없습니다.");
          return;
        }

        // 이미 관리자인 경우
        if (adminList.includes(sid)) {
          showAlert("ℹ️", "이미 관리자입니다.");
          return;
        }

        // 직책 목록 가져오기 (회장단 + 일반 임원)
        const allPositions = [...presidentPositions, ...regularPositions];

        // 직책 선택 모달 생성
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-800">
                <i class="fas fa-user-shield mr-2 text-purple-600"></i>관리자로 추가
              </h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="mb-4">
              <p class="text-sm text-gray-600 mb-2">
                <strong>${
                  member.name
                }</strong> (${sid}) 님을 관리자로 추가합니다.
              </p>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">직책 선택</label>
              <select id="admin-position-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="">직책을 선택하세요</option>
                <optgroup label="회장단">
                  ${presidentPositions
                    .map((pos) => `<option value="${pos}">${pos}</option>`)
                    .join("")}
                </optgroup>
                <optgroup label="일반 임원">
                  ${regularPositions
                    .map((pos) => `<option value="${pos}">${pos}</option>`)
                    .join("")}
                </optgroup>
              </select>
            </div>
            
            <div class="flex gap-2 justify-end">
              <button 
                onclick="this.closest('.fixed').remove()" 
                class="px-4 py-2 text-gray-600 hover:text-gray-800"
              >
                취소
              </button>
              <button 
                id="confirm-make-admin" 
                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
              >
                <i class="fas fa-user-shield mr-2"></i>관리자 추가
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // 확인 버튼 이벤트
        modal
          .querySelector("#confirm-make-admin")
          .addEventListener("click", async () => {
            const position = modal.querySelector(
              "#admin-position-select"
            ).value;

            if (!position) {
              showAlert("😥", "직책을 선택해주세요.");
              return;
            }

            try {
              // 관리자 목록에 추가
              const newAdminList = [...adminList, sid];
              const newAdminPositions = { ...adminPositions, [sid]: position };

              await setDoc(doc(db, "admins", "list"), {
                studentIds: newAdminList,
                positions: newAdminPositions,
              });

              showAlert(
                "✅",
                `${member.name} 님이 ${position} 관리자로 추가되었습니다!`
              );
              modal.remove();

              // 회원 목록 새로고침
              const subtabContainer =
                document.getElementById("subtab-container");
              if (subtabContainer) {
                renderMembersAdmin(subtabContainer);
              }
            } catch (error) {
              console.error("관리자 추가 오류:", error);
              showAlert("😥", "관리자 추가에 실패했습니다.");
            }
          });
      }
      function openMemberEditModal(sid) {
        const m = membersData.find((x) => (x.studentId || x.id) === sid) || {};
        el.blockEditorTitle.textContent = `회원 정보 수정 — ${saf(
          m.name || ""
        )}`;
        el.blockEditorBody.innerHTML = `<div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">이름</label>
              <input id="mem-name" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="이름을 입력하세요" value="${saf(
                m.name || ""
              )}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">학번</label>
              <input id="mem-id" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 bg-gray-50" disabled placeholder="학번" value="${saf(
                m.studentId || ""
              )}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">성별</label>
              <select id="mem-gender" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
              <option value="남" ${
                m.gender === "남" ? "selected" : ""
              }>남</option>
              <option value="여" ${
                m.gender === "여" ? "selected" : ""
              }>여</option>
              <option value="기타" ${
                m.gender === "기타" ? "selected" : ""
              }>기타</option>
            </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">학년</label>
              <select id="mem-year" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
              <option value="1학년" ${
                m.year === "1학년" ? "selected" : ""
              }>1학년</option>
              <option value="2학년" ${
                m.year === "2학년" ? "selected" : ""
              }>2학년</option>
              <option value="3학년" ${
                m.year === "3학년" ? "selected" : ""
              }>3학년</option>
              <option value="4학년" ${
                m.year === "4학년" ? "selected" : ""
              }>4학년</option>
              <option value="기타" ${
                m.year === "기타" ? "selected" : ""
              }>기타</option>
            </select>
            <input id="mem-college" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="단과대" value="${saf(
              m.college || ""
            )}">
            <input id="mem-dept" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="학과" value="${saf(
              m.department || ""
            )}">
            <input id="mem-phone" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="전화번호" value="${saf(
              m.phone || ""
            )}">
            <select id="mem-status" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
              <option value="active" ${
                m.status === "active" ? "selected" : ""
              }>활동중</option>
              <option value="pending" ${
                m.status === "pending" ? "selected" : ""
              }>승인대기</option>
              <option value="rejected" ${
                m.status === "rejected" ? "selected" : ""
              }>거절</option>
              <option value="blocked" ${
                m.status === "blocked" ? "selected" : ""
              }>차단</option>
            </select>
          </div>`;
        el.blockEditor.classList.remove("hidden");
        el.blockEditorSave.onclick = async () => {
          try {
            await updateDoc(doc(db, "members", sid), {
              name: document.getElementById("mem-name").value.trim(),
              gender: document.getElementById("mem-gender").value,
              year: document.getElementById("mem-year").value,
              college: document.getElementById("mem-college").value.trim(),
              department: document.getElementById("mem-dept").value.trim(),
              phone: document.getElementById("mem-phone").value.trim(),
              status: document.getElementById("mem-status").value,
            });
            el.blockEditor.classList.add("hidden");
            showAlert("✅", "수정되었습니다.");
          } catch {
            showAlert("😥", "수정 실패");
          }
        };
        el.blockEditorCancel.onclick = () =>
          el.blockEditor.classList.add("hidden");
      }
      function exportMembersCSV() {
        const mapStatus = (s) =>
          ({
            active: "활동중",
            pending: "승인대기",
            rejected: "거절",
            blocked: "차단",
          }[s] ||
          s ||
          "-");
        const rows = (membersData || []).map((m) => [
          m.name || "",
          m.studentId || "",
          m.gender || "",
          m.year || "",
          m.college || "",
          m.department || "",
          m.phone || "",
          mapStatus(m.status),
        ]);
        const header = [
          "이름",
          "학번",
          "성별",
          "학년",
          "단과대",
          "학과",
          "전화번호",
          "상태",
        ];
        const escape = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
        const lines = [
          header.map(escape).join(","),
          ...rows.map((r) => r.map(escape).join(",")),
        ].join("\r\n");
        const bom = "\uFEFF";
        const blob = new Blob([bom + lines], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `members_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      async function bulkApproveMembers() {
        // 대기 중인 회원들 필터링
        const pendingMembers = (membersData || []).filter(
          (m) => (m.status || "pending") === "pending"
        );

        if (pendingMembers.length === 0) {
          showAlert("ℹ️", "승인 대기 중인 회원이 없습니다.");
          return;
        }

        const confirmMessage = `승인 대기 중인 회원 ${
          pendingMembers.length
        }명을 모두 승인하시겠습니까?\n\n승인될 회원:\n${pendingMembers
          .map((m) => `• ${m.name} (${m.studentId})`)
          .join("\n")}`;

        if (!confirm(confirmMessage)) return;

        try {
          const batch = writeBatch(db);

          // 모든 대기 중인 회원을 active로 변경
          pendingMembers.forEach((member) => {
            const memberRef = doc(db, "members", member.id || member.studentId);
            batch.update(memberRef, {
              status: "active",
              lastUpdated: new Date().toISOString(),
            });
          });

          await batch.commit();
          showAlert(
            "✅",
            `${pendingMembers.length}명의 회원이 승인되었습니다.`
          );

          // 회원 목록 새로고침
          setTimeout(() => {
            const subtabContainer = document.getElementById("subtab-container");
            if (subtabContainer) {
              renderMembersAdmin(subtabContainer);
            }
          }, 1000);
        } catch (error) {
          console.error("일괄 승인 오류:", error);
          showAlert("😥", "일괄 승인 중 오류가 발생했습니다.");
        }
      }

      async function deleteAllMembers() {
        // 1단계: 첫 번째 경고
        if (
          !confirm(
            "⚠️ 경고: 회원 전체 삭제를 진행하시겠습니까?\n\n이 작업은 되돌릴 수 없으며, 모든 회원 데이터가 영구적으로 삭제됩니다.\n\n⚠️ 회장단과 잔류 신청자는 삭제에서 제외됩니다."
          )
        ) {
          return;
        }

        // 2단계: 텍스트 입력 확인
        const confirmText = prompt(
          "⚠️ 최종 확인\n\n" +
            "회원을 전체 삭제하려면 아래 텍스트를 정확히 입력해주세요:\n" +
            '"회원을 전체 삭제합니다."\n\n' +
            "이 작업은 되돌릴 수 없습니다!"
        );
        if (confirmText !== "회원을 전체 삭제합니다.") {
          showAlert(
            "❌",
            "입력한 텍스트가 정확하지 않습니다. 작업이 취소되었습니다."
          );
          return;
        }

        // 3단계: 최종 확인
        if (
          !confirm(
            "🚨 최종 확인\n\n모든 회원 데이터를 삭제하시겠습니까?\n\n⚠️ 회장단과 잔류 신청자는 보호됩니다.\n\n이 작업은 되돌릴 수 없습니다."
          )
        ) {
          return;
        }

        try {
          const snap = await getDocs(collection(db, "members"));
          const batch = writeBatch(db);
          let deletedCount = 0;
          let protectedCount = 0;

          snap.forEach((doc) => {
            const data = doc.data();
            const isAdmin = adminList.includes(data.studentId);
            const isRetentionApplied = data.retentionApplied === true;

            if (isAdmin || isRetentionApplied) {
              protectedCount++;
            } else {
              batch.delete(doc.ref);
              deletedCount++;
            }
          });

          await batch.commit();
          showAlert(
            "🗑️",
            `전체 삭제가 완료되었습니다.\n\n삭제된 회원: ${deletedCount}명\n보호된 회원: ${protectedCount}명 (회장단 + 잔류 신청자)`
          );
        } catch {
          showAlert("😥", "전체 삭제 중 오류가 발생했습니다.");
        }
      }

      /* ===== 명예의 전당(보관) 사용자 탭 ===== */
      function renderHistoryTab(isAdmin) {
        const c = document.getElementById("history-tab");
        if (!c) return;

        // 참가한 이벤트 목록 가져오기 (삭제되지 않은 마감/보관 이벤트만)
        const participatedEvents = eventsData.filter((ev) => {
          if (!currentUser) return false;

          // 삭제된 이벤트는 제외
          if (ev.status === "deleted") return false;

          // 신청자 목록에서 현재 사용자 확인
          const isApplicant = ev.applicants?.some(
            (a) => a.studentId === currentUser.studentId
          );

          // 미식회의 경우 각 식당별 예약자 확인
          let isRestaurantApplicant = false;
          if (ev.type === "tasting" && ev.restaurants) {
            isRestaurantApplicant = ev.restaurants.some((r) =>
              r.reservations?.some(
                (res) => res.studentId === currentUser.studentId
              )
            );
          }

          const isParticipant = isApplicant || isRestaurantApplicant;

          // 마감된 이벤트, 보관된 이벤트, 완료된 이벤트, 또는 이미 지난 이벤트
          const isClosed =
            ev.status === "closed" ||
            ev.status === "archived" ||
            ev.status === "completed";
          const eventDate = new Date(ev.datetime);
          const today = new Date();
          const isPastEvent = eventDate < today;

          return isParticipant && (isClosed || isPastEvent);
        });

        if (participatedEvents.length === 0) {
          c.innerHTML = `<div class="section text-center py-12">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-orange-100 mb-4">
              <i class="fas fa-calendar-check text-4xl text-orange-400"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">아직 참가한 활동이 없습니다</h3>
            <p class="text-gray-500 mb-4">이벤트에 참가하고 즐거운 경험을 남겨보세요!</p>
          </div>`;
          return;
        }

        // 관리자 및 운영진 여부 확인
        const isUserAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // 학번 마스킹 함수
        const maskStudentId = (studentId) => {
          if (!studentId) return "";
          if (studentId.length <= 4) return studentId;
          return studentId.substring(0, 4) + "****";
        };

        const eventCards = participatedEvents
          .map((ev) => {
            const eventDate = new Date(ev.datetime).toLocaleDateString("ko-KR");
            const hasReview = ev.reviews?.find(
              (r) => r.studentId === currentUser.studentId
            );

            // 이벤트 상태 확인
            const isClosed = ev.status === "closed" || ev.status === "archived";
            const eventDateTime = new Date(ev.datetime);
            const today = new Date();
            const isPastEvent = eventDateTime < today;

            // 미식회인 경우 신청한 식당 이름과 인원수 찾기
            let restaurantName = "";
            let restaurantParticipants = 0;
            if (ev.type === "tasting" && ev.restaurants && currentUser) {
              for (const restaurant of ev.restaurants) {
                if (
                  restaurant.reservations?.some(
                    (res) => res.studentId === currentUser.studentId
                  )
                ) {
                  restaurantName = restaurant.name;
                  restaurantParticipants = restaurant.reservations?.length || 0;
                  break;
                }
              }
            }

            // 사용자가 신청한 정보 찾기
            const userApplicant = ev.applicants?.find(
              (a) => a.studentId === currentUser.studentId
            );
            const userRestaurantReservation = ev.restaurants
              ?.find((r) =>
                r.reservations?.some(
                  (res) => res.studentId === currentUser.studentId
                )
              )
              ?.reservations?.find(
                (res) => res.studentId === currentUser.studentId
              );

            // 참가 인원 계산 (미식회는 식당 인원, 일반 이벤트는 전체 인원)
            const participantCount =
              ev.type === "tasting" && restaurantName
                ? restaurantParticipants
                : ev.applicants?.length || 0;

            return `<div class="section relative overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300">
                        <!-- 아코디언 헤더 (항상 표시) -->
                        <div class="cursor-pointer" onclick="toggleActivityDetails('${
                          ev.id
                        }')">
                          <div class="p-3 md:p-4">
                            <div class="flex items-start gap-2 md:gap-3">
                              <!-- 이벤트 로고/아이콘 -->
                              <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 md:w-12 md:h-12 rounded-xl ${typeBadgeClass(
                                ev.type
                              )}">
                                <i class="fas ${
                                  ev.type === "tasting"
                                    ? "fa-utensils"
                                    : ev.type === "mt"
                                    ? "fa-mountain"
                                    : ev.type === "meeting"
                                    ? "fa-users"
                                    : "fa-calendar"
                                } text-white text-base md:text-lg"></i>
                              </div>

                              <!-- 중요 정보 -->
                              <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-2 mb-1">
                                  <h3 class="text-base md:text-lg font-bold text-gray-800 truncate">${saf(
                                    ev.title || "(제목 없음)"
                                  )}</h3>
                                  <span class="flex-shrink-0 inline-flex items-center px-1.5 md:px-2 py-0.5 rounded-full text-xs font-medium ${typeBadgeClass(
                                    ev.type
                                  )}">
                    ${typeLabel(ev.type)}
                  </span>
                                </div>

                                <!-- 상태 및 일시 - 모바일에서 세로 정렬 -->
                                <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 text-xs sm:text-sm text-gray-600">
                                  <div class="flex items-center gap-3">
                                    <div class="flex items-center gap-1 flex-shrink-0">
                                      <i class="fas fa-calendar text-orange-500"></i>
                                      <span class="whitespace-nowrap">${new Date(
                                        ev.datetime
                                      ).toLocaleDateString("ko-KR", {
                                        month: "short",
                                        day: "numeric",
                                      })}</span>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0">
                                      <i class="fas fa-clock text-blue-500"></i>
                                      <span class="whitespace-nowrap">${new Date(
                                        ev.datetime
                                      ).toLocaleTimeString("ko-KR", {
                                        hour: "2-digit",
                                        minute: "2-digit",
                                      })}</span>
                                    </div>
                                  </div>
                                  <div class="flex items-center gap-1 flex-wrap">
                  ${
                    ev.status === "completed"
                      ? '<span class="bg-purple-100 text-purple-800 px-1.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-flag-checkered mr-1"></i>종료됨</span>'
                      : isClosed
                      ? '<span class="bg-green-100 text-green-800 px-1.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-check-circle mr-1"></i>확정</span>'
                      : ""
                  }
                  ${
                    ev.activityStatus === "confirmed"
                      ? '<span class="bg-emerald-100 text-emerald-800 px-1.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-thumbs-up mr-1"></i>완료</span>'
                      : ""
                  }
                  ${
                    ev.activityStatus === "cancelled"
                      ? '<span class="bg-red-100 text-red-800 px-1.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-ban mr-1"></i>취소</span>'
                      : ""
                  }
                </div>
              </div>
            </div>

                              <!-- 펼치기/접기 아이콘 -->
                              <div class="flex-shrink-0 flex items-center justify-center w-7 h-7 md:w-8 md:h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                                <i class="fas fa-chevron-down text-gray-600 transition-transform duration-200 text-sm" id="chevron-${
                                  ev.id
                                }"></i>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- 아코디언 내용 (접혀있음) -->
                        <div class="hidden" id="details-${ev.id}">
                          <div class="px-4 pb-4 border-t border-gray-200 pt-4">
            
            <!-- 이벤트 상세 정보 - PC에서 더 나은 레이아웃 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
              <div class="flex items-center gap-2 text-sm">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-orange-100">
                  <i class="fas fa-calendar text-orange-600"></i>
                </div>
                <div>
                  <p class="text-xs text-gray-500">이벤트 일시</p>
                  <p class="font-semibold text-gray-800">${new Date(
                    ev.datetime
                  ).toLocaleString("ko-KR", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                  })}</p>
                </div>
              </div>
              
              <div class="flex items-center gap-2 text-sm">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100">
                  <i class="fas fa-users text-blue-600"></i>
                </div>
                <div>
                  <p class="text-xs text-gray-500">${
                    ev.type === "tasting" && restaurantName
                      ? "신청 식당 인원"
                      : "참가 인원"
                  }</p>
                  <p class="font-semibold text-gray-800">${participantCount}명</p>
                </div>
              </div>
            </div>
            
            <!-- 내 신청 정보 (강조) -->
            ${
              userApplicant || restaurantName
                ? `
            <div class="bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl p-4 mb-4">
              <div class="flex items-center gap-2 mb-3">
                <i class="fas fa-user-check text-orange-600"></i>
                <h4 class="font-bold text-gray-800">내 신청 정보</h4>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                ${
                  restaurantName
                    ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-utensils text-orange-500 w-4"></i>
                  <span class="text-gray-600">신청 식당:</span>
                  <span class="font-bold text-orange-700">${saf(
                    restaurantName
                  )}</span>
                </div>
                `
                    : ""
                }
                ${
                  userApplicant
                    ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-clock text-orange-500 w-4"></i>
                  <span class="text-gray-600">신청일:</span>
                  <span class="font-semibold text-gray-700">${new Date(
                    userApplicant.timestamp
                  ).toLocaleDateString("ko-KR")}</span>
                </div>
                `
                    : ""
                }
                ${
                  userRestaurantReservation
                    ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-clock text-orange-500 w-4"></i>
                  <span class="text-gray-600">신청일:</span>
                  <span class="font-semibold text-gray-700">${new Date(
                    userRestaurantReservation.timestamp
                  ).toLocaleDateString("ko-KR")}</span>
                </div>
                `
                    : ""
                }
              </div>
            </div>
            `
                : ""
            }
            
            <!-- 신청자 목록 -->
            <div class="mt-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
              <div class="flex items-center gap-2 mb-3">
                <i class="fas fa-list-ul text-gray-600"></i>
                <h4 class="font-bold text-gray-800">신청자 명단</h4>
              </div>
              ${
                ev.type === "tasting" && restaurantName
                  ? `
                <!-- 미식회: 신청한 식당의 예약자 목록 -->
                <div class="space-y-1">
                  ${
                    ev.restaurants
                      ?.find((r) => r.name === restaurantName)
                      ?.reservations?.slice()
                      .reverse()
                      .map(
                        (res, idx) => `
                    <div class="flex items-center justify-between bg-white rounded px-3 py-2 text-sm">
                      <div class="flex items-center gap-2">
                        <span class="text-gray-500">${idx + 1}.</span>
                        <span class="font-medium text-gray-800">${saf(
                          res.name
                        )}</span>
                      </div>
                      <span class="font-mono text-xs text-gray-600">${maskStudentId(
                        res.studentId
                      )}</span>
                    </div>
                  `
                      )
                      .join("") ||
                    '<p class="text-sm text-gray-500">신청자가 없습니다.</p>'
                  }
                </div>
              `
                  : `
                <!-- 일반 이벤트: 전체 신청자 목록 -->
                <div class="space-y-1">
                  ${
                    ev.applicants
                      ?.slice()
                      .reverse()
                      .map(
                        (app, idx) => `
                    <div class="flex items-center justify-between bg-white rounded px-3 py-2 text-sm">
                      <div class="flex items-center gap-2">
                        <span class="text-gray-500">${idx + 1}.</span>
                        <span class="font-medium text-gray-800">${saf(
                          app.name
                        )}</span>
                      </div>
                      <span class="font-mono text-xs text-gray-600">${maskStudentId(
                        app.studentId
                      )}</span>
                    </div>
                  `
                      )
                      .join("") ||
                    '<p class="text-sm text-gray-500">신청자가 없습니다.</p>'
                  }
                </div>
              `
              }
            </div>
            
            <!-- 평가 섹션 -->
            ${
              hasReview
                ? `
              <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <i class="fas fa-star text-gray-600"></i>
                    <span class="font-bold text-gray-800">내 평가</span>
                  </div>
                  <div class="flex items-center gap-1">
                    ${Array.from(
                      { length: 5 },
                      (_, i) =>
                        `<i class="fas fa-star ${
                          i < hasReview.rating
                            ? "text-yellow-400"
                            : "text-gray-300"
                        }"></i>`
                    ).join("")}
                    <span class="ml-2 font-bold text-gray-700">${
                      hasReview.rating
                    }.0</span>
                  </div>
                </div>
                ${
                  hasReview.comment
                    ? `
                <div class="bg-white rounded-lg p-3 border border-gray-100">
                  <p class="text-sm text-gray-700 leading-relaxed">${saf(
                    hasReview.comment
                  )}</p>
                </div>
                `
                    : ""
                }
                <div class="mt-3 text-xs text-gray-500 flex items-center gap-1">
                  <i class="fas fa-clock"></i>
                  <span>${
                    hasReview.timestamp
                      ? new Date(hasReview.timestamp).toLocaleString("ko-KR")
                      : "-"
                  }</span>
                </div>
              </div>
            `
                : ""
            }
            
            <!-- 액션 버튼 -->
            <div class="flex gap-2">
              ${
                isPastEvent || isClosed
                  ? `
              <button type="button" class="flex-1 ${
                hasReview
                  ? "bg-gray-600 hover:bg-gray-700"
                  : "bg-orange-500 hover:bg-orange-600"
              } text-white py-3 px-4 rounded-lg transition-colors font-medium shadow-md" 
                      data-act="write-review" data-id="${ev.id}">
                <i class="fas ${
                  hasReview ? "fa-edit" : "fa-pen-to-square"
                } mr-2"></i>
                ${hasReview ? "평가 수정" : "평가 작성"}
              </button>
              `
                  : `
              <div class="flex-1 bg-gray-100 text-gray-500 py-3 px-4 rounded-lg text-center font-medium">
                <i class="fas fa-lock mr-2"></i>
                활동 종료 후 평가 가능
              </div>
              `
              }
            </div>
            
            ${
              isFullAdmin()
                ? `
            <div class="mt-3 pt-3 border-t border-gray-200">
              <div class="flex gap-2 flex-wrap">
                <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-edit" data-id="${
                          ev.id
                        }" title="이벤트 수정">
                  <i class="fas fa-pen mr-1"></i>수정
                </button>
                ${
                  isClosed
                    ? `
                <button type="button" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-reopen" data-id="${ev.id}" title="다시 열기">
                  <i class="fas fa-door-open mr-1"></i>다시 열기
                </button>
                `
                    : `
                <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-close" data-id="${ev.id}" title="신청 마감">
                  <i class="fas fa-door-closed mr-1"></i>신청 마감
                </button>
                `
                }
                <button type="button" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-unpost" data-id="${
                          ev.id
                        }" title="글 내리기">
                  <i class="fas fa-arrow-down mr-1"></i>글 내리기
                </button>
                <button type="button" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="group-maker" data-id="${
                          ev.id
                        }" title="조짜기">
                  <i class="fas fa-users mr-1"></i>조짜기
                </button>
                <button type="button" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="export-xlsx" data-id="${
                          ev.id
                        }" title="명단 다운로드">
                  <i class="fas fa-file-excel mr-1"></i>명단
                </button>
                ${
                  isPastEvent || isClosed
                    ? `
                <button type="button" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-confirm-activity" data-id="${ev.id}" title="활동 확정">
                  <i class="fas fa-check-circle mr-1"></i>활동 확정
                </button>
                <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-cancel-activity" data-id="${ev.id}" title="활동 취소">
                  <i class="fas fa-times-circle mr-1"></i>활동 취소
                </button>
                `
                    : ""
                }
              </div>
            </div>
            `
                : ""
            }
                          </div>
                        </div>
          </div>`;
          })
          .join("");

        c.innerHTML = `
          <div class="section mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div class="flex-1">
                <h2 class="text-2xl font-bold mb-2 text-gray-800 flex items-center gap-2">
                  <i class="fas fa-history text-orange-500"></i>
                  활동 기록
                </h2>
                <p class="text-sm text-gray-600">참가한 이벤트 ${participatedEvents.length}개 • 평가를 남겨 동아리 활동을 더욱 풍성하게 만들어보세요!</p>
              </div>
              <div class="flex-shrink-0">
                <div class="inline-flex items-center gap-2 bg-orange-50 px-4 py-2 rounded-lg">
                  <i class="fas fa-trophy text-orange-500"></i>
                  <span class="font-bold text-orange-700">${participatedEvents.length}개 참여</span>
                </div>
              </div>
            </div>
          </div>
          <div class="space-y-4">${eventCards}</div>
        `;

        // 아코디언 토글 함수 등록
        window.toggleActivityDetails = function (eventId) {
          const details = document.getElementById(`details-${eventId}`);
          const chevron = document.getElementById(`chevron-${eventId}`);

          if (details && chevron) {
            if (details.classList.contains("hidden")) {
              details.classList.remove("hidden");
              chevron.style.transform = "rotate(180deg)";
            } else {
              details.classList.add("hidden");
              chevron.style.transform = "rotate(0deg)";
            }
          }
        };

        // 평가 작성 이벤트 바인딩
        c.addEventListener("click", async (e) => {
          if (e.target.closest('[data-act="write-review"]')) {
            const eventId = e.target.closest('[data-act="write-review"]')
              .dataset.id;
            openReviewModal(eventId);
          }
        });
      }

      // 날짜 파싱 헬퍼 함수 (시간대 문제 해결)
      function parseDate(dateString) {
        if (!dateString) return new Date();

        // YYYY-MM-DD 형식의 날짜 문자열을 로컬 시간대로 파싱
        const parts = dateString.split("-");
        if (parts.length === 3) {
          const year = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1; // JavaScript Date는 0부터 시작
          const day = parseInt(parts[2], 10);
          return new Date(year, month, day);
        }

        return new Date(dateString);
      }

      // 오늘 날짜를 YYYY-MM-DD 형식으로 반환 (로컬 시간대 기준)
      function getTodayString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // 깜빡거림 방지를 위한 부드러운 렌더링 함수
      function smoothRender(
        containerId,
        renderFunction,
        loadingText = "로딩 중..."
      ) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // 1. 로딩 상태 표시
        container.classList.add("content-loading", "smooth-transition");

        // 2. requestAnimationFrame을 사용하여 부드러운 전환
        requestAnimationFrame(() => {
          // 3. 새로운 콘텐츠 렌더링
          renderFunction();

          // 4. 짧은 지연 후 로딩 상태 해제
          setTimeout(() => {
            container.classList.remove("content-loading");
            container.classList.add("content-loaded");

            // 5. 전환 완료 후 클래스 정리
            setTimeout(() => {
              container.classList.remove("smooth-transition", "content-loaded");
            }, 200);
          }, 50);
        });
      }

      // 달력 생성 함수

      function generateCalendar(
        year,
        month,
        events = [],
        showDownloadButtons = false,
        isAdmin = false,
        isLoggedIn = true
      ) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const endDate = new Date(lastDay);
        endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const weekDays = ["일", "월", "화", "수", "목", "금", "토"];
        const monthNames = [
          "1월",
          "2월",
          "3월",
          "4월",
          "5월",
          "6월",
          "7월",
          "8월",
          "9월",
          "10월",
          "11월",
          "12월",
        ];

        let calendarHTML = `
          <div class="calendar-container">
            <div class="calendar-header">
              <h3 class="calendar-title">F👀die 달력</h3>
              <div class="calendar-nav">
                ${
                  isLoggedIn
                    ? `
                <button class="calendar-nav-btn calendar-nav-prev" onclick="changeCalendarMonth(-1)">
                  <i class="fas fa-chevron-left"></i>
                </button>
                `
                    : ""
                }
                <div class="calendar-month-year">${year}년 ${
          monthNames[month]
        }</div>
                ${
                  isLoggedIn
                    ? `
                <button class="calendar-nav-btn calendar-nav-next" onclick="changeCalendarMonth(1)">
                  <i class="fas fa-chevron-right"></i>
                </button>
                `
                    : ""
                }
              </div>
            </div>
            <div class="calendar-grid">
        `;

        // 요일 헤더
        weekDays.forEach((day) => {
          calendarHTML += `<div class="calendar-day-header">${day}</div>`;
        });

        // 달력 날짜들
        const currentDate = new Date(startDate);
        while (currentDate <= endDate) {
          const isCurrentMonth = currentDate.getMonth() === month;
          const isToday = currentDate.getTime() === today.getTime();
          // 로컬 시간대 기준으로 날짜 문자열 생성 (UTC 변환 방지)
          const currentYear = currentDate.getFullYear();
          const currentMonth = String(currentDate.getMonth() + 1).padStart(
            2,
            "0"
          );
          const currentDay = String(currentDate.getDate()).padStart(2, "0");
          const dateStr = `${currentYear}-${currentMonth}-${currentDay}`;

          // 해당 날짜의 이벤트들 찾기 (권한에 따라 필터링)
          const dayEvents = events.filter((event) => {
            const eventDate = event.activityDate;
            if (!eventDate) return false;
            if (eventDate !== dateStr) return false;

            // 운영진 전용 일정인 경우 권한 체크
            if (event.isAdminOnly && !isAdminOrStaff()) {
              return false;
            }

            return true;
          });

          let dayClass = "calendar-day";
          if (!isCurrentMonth) dayClass += " other-month";
          if (isToday) dayClass += " today";

          // 로컬 시간대 기준으로 날짜 문자열 생성 (UTC 변환 방지)
          const yearForModal = currentDate.getFullYear();
          const monthForModal = String(currentDate.getMonth() + 1).padStart(
            2,
            "0"
          );
          const dayForModal = String(currentDate.getDate()).padStart(2, "0");
          const dateString = `${yearForModal}-${monthForModal}-${dayForModal}`;

          calendarHTML += `<div class="${dayClass}" onclick="openAddEventModal('${dateString}')">`;
          calendarHTML += `<div class="calendar-day-number">${currentDate.getDate()}</div>`;

          // 이벤트들 추가
          dayEvents.forEach((event) => {
            const eventDate = parseDate(event.activityDate);
            let eventClass = "calendar-event";

            // 운영진 전용 일정인 경우 파란색 클래스 추가
            if (event.isAdminOnly) {
              eventClass += " admin-only";
            }

            if (eventDate < today) {
              eventClass += " completed";
            } else if (eventDate.getTime() === today.getTime()) {
              eventClass += " next";
            }

            const title = event.activityName || event.title || "일정 없음";

            // 4글자마다 줄바꿈 처리 (이모티콘 포함)
            const wrappedTitle = title.match(/.{1,4}/g)?.join("<br>") || title;

            // HTML 엔티티 변환 (XSS 방지)
            const escapedTitle = title.replace(
              /[&<>"']/g,
              (m) =>
                ({
                  "&": "&amp;",
                  "<": "&lt;",
                  ">": "&gt;",
                  '"': "&quot;",
                  "'": "&#39;",
                }[m])
            );

            calendarHTML += `<div class="${eventClass}" title="${escapedTitle}" data-event-id="${event.id}">${wrappedTitle}</div>`;
          });

          calendarHTML += "</div>";
          currentDate.setDate(currentDate.getDate() + 1);
        }

        calendarHTML += `
            </div>
            
            ${
              isLoggedIn
                ? `
            <div class="text-center mt-3 px-4">
              <p class="text-sm text-gray-600 font-medium">
                <i class="fas fa-calendar-check mr-2 text-blue-500"></i>
                일정을 클릭하여 자세한 내용을 확인해보세요
              </p>
            </div>
            `
                : ""
            }
          </div>
          
        `;

        return calendarHTML;
      }

      window.openAddEventModal = function (selectedDate) {
        // 현재 관리자 상태 확인
        const adminPositions = {
          12345678: "개발자",
          202013136: "총무",
          202018357: "기타",
          202114029: "부회장",
          202327942: "회장",
          202416596: "홍보부장",
          202419743: "기획부장",
        };

        const isAdmin = currentUser && adminPositions[currentUser.studentId];

        if (!currentUser || !isAdmin) {
          return; // 관리자가 아니면 조용히 종료
        }

        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-800">새 일정 추가</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <form id="calendar-add-event-form">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">일정명</label>
                <input 
                  id="calendar-event-name" 
                  type="text" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                  placeholder="일정명을 입력하세요"
                  required
                >
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                <input 
                  id="calendar-event-date" 
                  type="date" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                  value="${selectedDate}"
                  required
                >
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                <textarea 
                  id="calendar-event-description" 
                  rows="5" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                  placeholder="일정 설명을 입력하세요&#10;줄바꿈이 가능합니다"
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">💡 Enter 키로 줄바꿈이 가능합니다</p>
              </div>
              
              <div class="flex justify-end gap-2">
                <button 
                  type="button" 
                  onclick="this.closest('.fixed').remove()" 
                  class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
                >
                  취소
                </button>
                <button 
                  type="submit" 
                  class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600"
                >
                  일정 추가
                </button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(modal);

        // 폼 제출 이벤트 처리
        modal
          .querySelector("#calendar-add-event-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const name = document.getElementById("calendar-event-name").value;
            const date = document.getElementById("calendar-event-date").value;
            const description = document.getElementById(
              "calendar-event-description"
            ).value;

            if (!name || !date) {
              showAlert("😥", "일정명과 날짜는 필수입니다.");
              return;
            }

            // 일정 추가 로직 (여기에 실제 추가 코드 구현)
            console.log("새 일정 추가:", { name, date, description });
            showAlert("✅", "일정이 추가되었습니다!");

            modal.remove();
          });
      };

      // 달력 월 변경 함수
      let currentCalendarYear = new Date().getFullYear();
      let currentCalendarMonth = new Date().getMonth();

      window.changeCalendarMonth = function (direction) {
        currentCalendarMonth += direction;
        if (currentCalendarMonth < 0) {
          currentCalendarMonth = 11;
          currentCalendarYear--;
        } else if (currentCalendarMonth > 11) {
          currentCalendarMonth = 0;
          currentCalendarYear++;
        }

        // 달력 다시 렌더링
        const accordionContent = document.getElementById("h-roadmap-full-list");
        if (
          accordionContent &&
          roadmapShowAll &&
          roadmapData &&
          roadmapData.length > 5
        ) {
          // roadmapData를 날짜순으로 정렬
          const sorted = roadmapData
            .filter((item) => item && item.id)
            .sort((a, b) => {
              const dateA = parseDate(a.activityDate || a.date);
              const dateB = parseDate(b.activityDate || b.date);
              return dateA - dateB;
            });

          // 관리자 권한 확인
          const adminPositions = {
            12345678: "개발자",
            202013136: "총무",
            202018357: "기타",
            202114029: "부회장",
            202327942: "회장",
            202416596: "홍보부장",
            202419743: "기획부장",
          };
          const isAdmin = currentUser && adminPositions[currentUser.studentId];

          const calendarHTML = generateCalendar(
            currentCalendarYear,
            currentCalendarMonth,
            sorted,
            true, // 로그인 상태에서는 다운로드 버튼 표시
            isAdmin, // 관리자 권한 전달
            true // 로그인 상태에서는 네비게이션 버튼과 안내 문구 표시
          );
          accordionContent.innerHTML = calendarHTML;
        }
      };

      function renderHorizontalRoadmap() {
        // 로그아웃 상태에서는 아무것도 렌더링하지 않음 (블록 시스템으로 대체)
        if (!currentUser) {
          console.log(
            "renderHorizontalRoadmap: 로그아웃 상태 - 렌더링하지 않음"
          );
          return;
        }

        const root = document.getElementById("h-roadmap-list");
        const btn = document.getElementById("h-roadmap-toggle-btn");
        if (!root) {
          console.warn(
            "renderHorizontalRoadmap: h-roadmap-list 요소를 찾을 수 없습니다."
          );
          return;
        }

        console.log("renderHorizontalRoadmap: roadmapData =", roadmapData);
        console.log("roadmapData 길이:", roadmapData?.length || 0);
        console.log("roadmapData 타입:", typeof roadmapData);

        // 데이터 상세 분석
        if (roadmapData && roadmapData.length > 0) {
          console.log("roadmapData 상세 분석:");
          roadmapData.forEach((item, index) => {
            console.log(`  [${index}]`, {
              id: item?.id,
              title: item?.title,
              activityName: item?.activityName,
              activityDate: item?.activityDate,
              order: item?.order,
            });
          });
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // order → 날짜 순 (기본적인 데이터 검증만)
        const validRoadmapData = (roadmapData || []).filter((item) => {
          if (!item || typeof item !== "object" || !item.id) return false;

          // 관리자(운영진 포함)는 모든 일정 표시
          if (isAdminOrStaff()) {
            return true;
          }

          // 일반 회원: 운영진 전용 일정 제외
          if (item.isAdminOnly) {
            return false;
          }

          return true;
        });

        // 간단히 보기 모드에서는 날짜순으로만 정렬 (order 무시)
        const sorted = [...validRoadmapData].sort((a, b) => {
          const dateA = parseDate(a.activityDate);
          const dateB = parseDate(b.activityDate);
          return dateA - dateB;
        });

        // 지난 일정과 다음 일정 분리
        const pastEvents = sorted.filter((item) => {
          const d = parseDate(item.activityDate);
          return d < today;
        });
        const futureEvents = sorted.filter((item) => {
          const d = parseDate(item.activityDate);
          return d >= today;
        });

        // 간단히 보기 모드에서는 이전 일정 제거하고 다음 일정만 표시 (모바일 고려)
        // 날짜순으로 가장 가까운 미래 일정을 다음 일정으로 표시
        const upcomingEvents = futureEvents.slice(0, 2); // 날짜순으로 정렬된 futureEvents에서 처음 2개

        const displayEvents = upcomingEvents;

        console.log("일정 표시 로직:", {
          totalEvents: sorted.length,
          pastEvents: pastEvents.length,
          futureEvents: futureEvents.length,
          upcomingEvents: upcomingEvents.length,
          displayEvents: displayEvents.length,
          roadmapShowAll: roadmapShowAll,
          screenWidth: window.innerWidth,
          isMobile: window.innerWidth <= 640,
          today: today.toISOString().split("T")[0],
          sortedEventsDetails: sorted.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
            order: item.order,
          })),
          futureEventsDetails: futureEvents.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
            createdAt: item.createdAt,
          })),
          upcomingEventsDetails: upcomingEvents.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
          })),
        });

        // 전체 일정보기 버튼 표시/숨김
        if (btn) {
          if (sorted.length > 5) {
            // 5개 이상일 때 버튼 표시
            btn.classList.remove("hidden");
            const textElement = btn.querySelector("#h-roadmap-toggle-text");
            const chevronElement = btn.querySelector("#h-roadmap-chevron");
            if (textElement) {
              textElement.textContent = roadmapShowAll
                ? "간단히 보기"
                : "캘린더";
            }
            if (chevronElement) {
              chevronElement.style.transform = roadmapShowAll
                ? "rotate(180deg)"
                : "rotate(0deg)";
            }
          } else {
            btn.classList.add("hidden");
          }
        }

        // 관리자용 새 일정 추가 블록 - 운영진 제외, 임원진만 가능
        const adminPlaceholder = isFullAdmin()
          ? `
          <div class="timeline-item admin-placeholder" data-act="add-roadmap">
            <div class="timeline-content">
              <div class="timeline-title">
                <div class="admin-placeholder-content">
                  <div class="admin-placeholder-icon">
                    <i class="fas fa-plus-circle"></i>
                  </div>
                  <div class="admin-placeholder-text">
                    <span class="admin-placeholder-title">새 일정 추가</span>
                    <span class="admin-placeholder-subtitle">클릭하여 새로운 로드맵 일정을 추가하세요</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `
          : "";

        // 다음 일정 찾기 (가장 가까운 미래 일정)
        const nextSchedule = futureEvents.length > 0 ? futureEvents[0] : null;

        console.log("다음 일정 확인:", {
          nextSchedule: nextSchedule
            ? {
                id: nextSchedule.id,
                title: nextSchedule.activityName || nextSchedule.title,
                date: nextSchedule.activityDate,
              }
            : null,
          futureEventsCount: futureEvents.length,
          today: today.toISOString().split("T")[0],
        });

        const html =
          adminPlaceholder +
            displayEvents
              .map((item) => {
                // 날짜 처리 (날짜가 없는 경우 오늘로 설정)
                const activityDate = item.activityDate || getTodayString();
                const d = parseDate(activityDate);

                // 상태 클래스 결정
                let blockClass = "";
                if (d < today) {
                  blockClass = "completed";
                } else if (item.id === nextSchedule?.id) {
                  blockClass = "next-schedule";
                }

                const formattedDate = d.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });

                // 제목 처리 (제목이 없는 경우 기본값 사용)
                const title = item.activityName || item.title || "일정 없음";

                return `
      <div class="schedule-block ${blockClass}">
        <div class="schedule-block-content">
          <div class="schedule-block-date">${formattedDate}</div>
          <div class="schedule-block-title">${saf(title)}</div>
          ${
            isFullAdmin()
              ? `<div class="schedule-block-actions">
                  <button type="button" class="schedule-action-btn schedule-edit-btn" data-act="edit-roadmap" data-id="${item.id}" title="수정">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="schedule-action-btn schedule-download-btn" data-act="download-roadmap" data-id="${item.id}" title="명단 다운로드">
                    <i class="fas fa-download"></i>
                  </button>
                  <button type="button" class="schedule-action-btn schedule-delete-btn" data-act="delete-roadmap" data-id="${item.id}" title="삭제">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>`
              : ""
          }
        </div>
      </div>`;
              })
              .join("") ||
          `<div class="text-gray-400 text-center py-8 col-span-full">일정이 없습니다.</div>`;

        root.innerHTML = html;

        // 아코디언 컨텐츠 영역 처리
        const accordionContent = document.getElementById("h-roadmap-full-list");
        if (accordionContent) {
          if (roadmapShowAll && sorted.length > 5) {
            // 전체 일정을 블록 형태로 표시
            const fullHtml = sorted
              .map((item) => {
                // 날짜 처리 (날짜가 없는 경우 오늘로 설정)
                const activityDate = item.activityDate || getTodayString();
                const d = parseDate(activityDate);

                // 상태 클래스 결정
                let blockClass = "";
                if (d < today) {
                  blockClass = "completed";
                } else if (item.id === nextSchedule?.id) {
                  blockClass = "next-schedule";
                }

                const formattedDate = d.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });

                // 제목 처리 (제목이 없는 경우 기본값 사용)
                const title = item.activityName || item.title || "일정 없음";

                return `
          <div class="schedule-block ${blockClass}">
            <div class="schedule-block-content">
              <div class="schedule-block-date">${formattedDate}</div>
              <div class="schedule-block-title">${saf(title)}</div>
              ${
                isFullAdmin()
                  ? `<div class="schedule-block-actions">
                      <button type="button" class="schedule-action-btn schedule-edit-btn" data-act="edit-roadmap" data-id="${item.id}" title="수정">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button type="button" class="schedule-action-btn schedule-download-btn" data-act="download-roadmap" data-id="${item.id}" title="명단 다운로드">
                        <i class="fas fa-download"></i>
                      </button>
                      <button type="button" class="schedule-action-btn schedule-delete-btn" data-act="delete-roadmap" data-id="${item.id}" title="삭제">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>`
                  : ""
              }
            </div>
          </div>`;
              })
              .join("");

            // 달력 형태로 전체 일정 표시
            const calendarHTML = generateCalendar(
              currentCalendarYear,
              currentCalendarMonth,
              sorted,
              true, // 로그인 상태에서는 다운로드 버튼 표시
              isFullAdmin(), // 관리자 권한 전달 - 운영진 제외
              true // 로그인 상태에서는 네비게이션 버튼과 안내 문구 표시
            );
            accordionContent.innerHTML = calendarHTML;

            // 아코디언 애니메이션으로 열기
            setTimeout(() => {
              accordionContent.style.maxHeight =
                accordionContent.scrollHeight + "px";
              accordionContent.style.opacity = "1";
            }, 10);
          } else {
            // 아코디언 애니메이션으로 닫기
            accordionContent.style.maxHeight = "0";
            accordionContent.style.opacity = "0";
          }
        }

        // 로드맵 수정/삭제 이벤트 바인딩
        root.addEventListener("click", (e) => {
          const act = e.target.closest("[data-act]")?.dataset.act;
          const id = e.target.closest("[data-act]")?.dataset.id;

          if (act === "edit-roadmap") {
            openRoadmapEventEditModal(id, 0); // eventIndex는 0으로 설정
          } else if (act === "delete-roadmap") {
            deleteRoadmapEvent(id);
          } else if (act === "add-roadmap") {
            openRoadmapAddModal();
          }
        });

        // 아코디언 영역 이벤트 바인딩 (달력 이벤트 포함)
        if (accordionContent) {
          accordionContent.addEventListener("click", (e) => {
            const act = e.target.closest("[data-act]")?.dataset.act;
            const id = e.target.closest("[data-act]")?.dataset.id;
            const eventId =
              e.target.closest(".calendar-event")?.dataset.eventId;

            if (act === "edit-roadmap") {
              openRoadmapEventEditModal(id, 0);
            } else if (act === "delete-roadmap") {
              deleteRoadmapEvent(id);
            } else if (eventId) {
              // 달력 이벤트 클릭 시 상세 정보 표시
              showEventDetails(eventId);
            }
          });
        }
      }

      // 달력 이벤트 상세 정보 표시 함수
      function showEventDetails(eventId) {
        // 기존 모달이 있으면 먼저 제거
        const existingModal = document.getElementById("event-detail-modal");
        if (existingModal) {
          existingModal.remove();
        }

        const event = roadmapData.find((item) => item.id === eventId);
        if (!event) return;

        const activityDate = event.activityDate || getTodayString();
        const d = parseDate(activityDate);
        const formattedDate = d.toLocaleDateString("ko-KR", {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        });

        const title = event.activityName || event.title || "일정 없음";
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let statusText = "";
        let statusClass = "";
        if (d < today) {
          statusText = "완료된 일정";
          statusClass = "text-red-600";
        } else if (d.getTime() === today.getTime()) {
          statusText = "오늘의 일정";
          statusClass = "text-green-600";
        } else {
          statusText = "예정된 일정";
          statusClass = "text-orange-600";
        }

        const modalHTML = `
          <div id="event-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                  <h3 class="text-xl font-bold text-gray-800">일정 상세 정보</h3>
                  <button onclick="closeEventDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
                
                <div class="space-y-4">
                  <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-2">${saf(
                      title
                    )}</h4>
                    <div class="flex items-center gap-2 text-sm">
                      <i class="fas fa-calendar text-orange-500"></i>
                      <span class="text-gray-600">${formattedDate}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm mt-2">
                      <i class="fas fa-info-circle text-blue-500"></i>
                      <span class="${statusClass} font-medium">${statusText}</span>
                    </div>
                  </div>
                  
                  ${
                    event.description
                      ? `
                    <div class="bg-gray-50 rounded-lg p-4">
                      <h5 class="font-medium text-gray-700 mb-2">상세 설명</h5>
                      <p class="text-gray-600 text-sm whitespace-pre-wrap">${saf(
                        event.description
                      )}</p>
                    </div>
                  `
                      : ""
                  }
                  
                  <div class="flex gap-2">
                    ${
                      currentUser && adminList.includes(currentUser.studentId)
                        ? `
                      <button onclick="openRoadmapEventEditModal('${eventId}', 0); closeEventDetailModal();" 
                              class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-edit mr-2"></i>수정
                      </button>
                      <button onclick="deleteRoadmapEvent('${eventId}'); closeEventDetailModal();" 
                              class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-trash mr-2"></i>삭제
                      </button>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
      }

      // 전역에서 접근 가능하도록 노출
      window.showEventDetails = showEventDetails;

      // 이벤트 상세 정보 표시 함수 (eventsData용)
      window.showEventDetailModal = function (eventId) {
        const ev = eventsData.find((e) => e.id === eventId);
        if (!ev) {
          showAlert("😥", "이벤트를 찾을 수 없습니다.");
          return;
        }

        // 기존 모달이 있으면 먼저 제거
        const existingModal = document.getElementById(
          "event-detail-modal-main"
        );
        if (existingModal) {
          existingModal.remove();
        }

        const eventDate = ev.datetime
          ? new Date(ev.datetime).toLocaleString("ko-KR", {
              year: "numeric",
              month: "long",
              day: "numeric",
              weekday: "long",
              hour: "2-digit",
              minute: "2-digit",
            })
          : "미정";

        const deadlineDate = ev.deadline
          ? new Date(ev.deadline).toLocaleString("ko-KR", {
              year: "numeric",
              month: "long",
              day: "numeric",
              weekday: "long",
              hour: "2-digit",
              minute: "2-digit",
            })
          : "미설정";

        const typeLabel =
          ev.type === "tasting"
            ? "🍽️ 미식회"
            : ev.type === "mt"
            ? "🏕️ MT"
            : ev.type === "assembly"
            ? "🎤 총회"
            : "📅 이벤트";

        const modalHTML = `
          <div id="event-detail-modal-main" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                  <h3 class="text-xl font-bold text-gray-800">이벤트 상세 정보</h3>
                  <button onclick="closeEventDetailModalMain()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
                
                <div class="space-y-4">
                  <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">${saf(
                      ev.title
                    )}</h4>
                    <div class="space-y-2">
                      <div class="flex items-center gap-2 text-sm">
                        <i class="fas fa-tag text-orange-500"></i>
                        <span class="text-gray-700">${typeLabel}</span>
                      </div>
                      <div class="flex items-center gap-2 text-sm font-bold text-orange-700">
                        <i class="fas fa-calendar-check text-orange-600"></i>
                        <span>실시일: ${eventDate}</span>
                      </div>
                      <div class="flex items-center gap-2 text-sm font-bold text-red-700">
                        <i class="fas fa-clock text-red-600"></i>
                        <span>마감일: ${deadlineDate}</span>
                      </div>
                    </div>
                  </div>
                  
                  ${
                    ev.description
                      ? `
                    <div class="bg-gray-50 rounded-lg p-4">
                      <h5 class="font-medium text-gray-700 mb-2">상세 설명</h5>
                      <p class="text-gray-600 text-sm whitespace-pre-wrap">${saf(
                        ev.description
                      )}</p>
                    </div>
                  `
                      : ""
                  }
                  
                  <div class="bg-gray-50 rounded-lg p-4">
                    <h5 class="font-medium text-gray-700 mb-2">신청 현황</h5>
                    <p class="text-gray-600 text-sm">참가자: ${
                      (ev.applicants || []).length
                    }명 / ${ev.limit || 0}명</p>
                    ${
                      (ev.waiting || []).length > 0
                        ? `<p class="text-gray-600 text-sm mt-1">대기자: ${ev.waiting.length}명</p>`
                        : ""
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
      };

      window.closeEventDetailModalMain = function () {
        const modal = document.getElementById("event-detail-modal-main");
        if (modal) {
          modal.remove();
        }
      };

      // 참가자 목록 공개 여부 토글 함수 (회장단 전용) - 모두에게 보이기/회장단만
      window.toggleParticipantsPublicVisibility = async function (
        eventId,
        type
      ) {
        if (!isFullAdmin()) return;

        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) {
            showAlert("😥", "이벤트를 찾을 수 없습니다.");
            return;
          }

          const fieldName =
            type === "applicants"
              ? "participantsVisibleToAll"
              : "waitingVisibleToAll";
          const currentValue = ev[fieldName] || false;
          const newValue = !currentValue;

          await updateDoc(doc(db, "events", eventId), {
            [fieldName]: newValue,
          });

          showAlert(
            "✅",
            newValue
              ? "모두에게 보이도록 설정되었습니다."
              : "회장단만 볼 수 있도록 설정되었습니다."
          );
          renderReservationTab(isFullAdmin());
        } catch (error) {
          console.error("참가자 공개 설정 변경 오류:", error);
          showAlert("😥", "설정 변경에 실패했습니다.");
        }
      };

      // 미식회 참가자 목록 공개 여부 토글 함수 (회장단 전용) - 모두에게 보이기/회장단만
      window.toggleRestaurantParticipantsPublicVisibility = async function (
        eventId,
        restaurantId,
        type
      ) {
        if (!isFullAdmin()) return;

        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) {
            showAlert("😥", "이벤트를 찾을 수 없습니다.");
            return;
          }

          const fieldName =
            type === "reservations"
              ? "participantsVisibleToAll"
              : "waitingVisibleToAll";
          const currentValue = ev[fieldName] || false;
          const newValue = !currentValue;

          await updateDoc(doc(db, "events", eventId), {
            [fieldName]: newValue,
          });

          showAlert(
            "✅",
            newValue
              ? "모두에게 보이도록 설정되었습니다."
              : "회장단만 볼 수 있도록 설정되었습니다."
          );
          renderReservationTab(isFullAdmin());
        } catch (error) {
          console.error("참가자 공개 설정 변경 오류:", error);
          showAlert("😥", "설정 변경에 실패했습니다.");
        }
      };

      // 달력 이벤트 상세 모달 닫기 함수
      window.closeEventDetailModal = function () {
        const modal = document.getElementById("event-detail-modal");
        if (modal) {
          modal.remove();
        }
      };

      // 로드맵 일정 삭제 함수
      window.deleteRoadmapEvent = async function (eventId) {
        if (!confirm("정말로 이 로드맵 일정을 삭제하시겠습니까?")) {
          return;
        }

        try {
          // 문서 존재 여부 확인
          const docRef = doc(db, "roadmap", eventId);
          const docSnap = await getDoc(docRef);

          if (!docSnap.exists()) {
            showAlert("😥", "삭제하려는 일정을 찾을 수 없습니다.");
            return;
          }

          await deleteDoc(docRef);
          showAlert("✅", "로드맵 일정이 삭제되었습니다.");
          renderHorizontalRoadmap(); // 로드맵 다시 렌더링
        } catch (error) {
          console.error("로드맵 삭제 오류:", error);
          if (error.code === "not-found") {
            showAlert("😥", "삭제하려는 일정을 찾을 수 없습니다.");
          } else {
            showAlert("😥", "로드맵 일정 삭제에 실패했습니다.");
          }
        }
      };

      // 로드맵 일정 추가 모달 (새로운 함수)
      function openRoadmapAddModal() {
        const modalHTML = `
            <div id="roadmap-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
              <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                <h3 class="text-xl font-bold text-gray-800 mb-4">새 로드맵 일정 추가</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">일정 제목</label>
                    <input id="roadmap-add-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="일정 제목을 입력하세요">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                    <input id="roadmap-add-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">설명 (선택사항)</label>
                    <textarea id="roadmap-add-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="일정에 대한 설명을 입력하세요"></textarea>
                  </div>
                </div>
                <div class="flex gap-3 mt-6">
                  <button id="roadmap-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>추가
                  </button>
                  <button id="roadmap-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                    취소
                  </button>
                </div>
              </div>
            </div>
          `;

        // 기존 모달 제거
        const existingModal = document.getElementById("roadmap-add-modal");
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("roadmap-add-save")
          .addEventListener("click", async () => {
            const title = document
              .getElementById("roadmap-add-title")
              .value.trim();
            const date = document.getElementById("roadmap-add-date").value;
            const description = document
              .getElementById("roadmap-add-description")
              .value.trim();

            if (!title) {
              showAlert("😥", "일정 제목을 입력해주세요.");
              return;
            }

            if (!date) {
              showAlert("😥", "날짜를 선택해주세요.");
              return;
            }

            try {
              console.log("로드맵 추가 시도:", { title, date, description });
              console.log("현재 roadmapData:", roadmapData);

              // 다음 order 값 계산
              const maxOrder = Math.max(
                ...(roadmapData || []).map((e) => e.order || 0),
                0
              );
              const newOrder = maxOrder + 1;

              console.log("새 order 값:", newOrder);

              const docRef = await addDoc(collection(db, "roadmap"), {
                activityName: title,
                activityDate: date,
                description: description || "",
                order: newOrder,
                createdAt: new Date().toISOString(),
              });

              console.log("문서 추가 완료, ID:", docRef.id);

              showAlert("✅", "새 로드맵 일정이 추가되었습니다.");
              document.getElementById("roadmap-add-modal").remove();

              // 로드맵은 onSnapshot으로 자동 업데이트됨
            } catch (error) {
              console.error("일정 추가 오류:", error);
              showAlert("😥", "일정 추가에 실패했습니다. 콘솔을 확인해주세요.");
            }
          });

        document
          .getElementById("roadmap-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-add-modal").remove();
          });

        // 모달 외부 클릭 시 닫기
        document
          .getElementById("roadmap-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-add-modal") {
              document.getElementById("roadmap-add-modal").remove();
            }
          });
      }

      // 독립적인 조모임 데이터 관리
      let groupsData = [];

      // 조모임 데이터 로드
      function loadGroupsData() {
        if (!currentUser) return;

        const unsubscribe = onSnapshot(
          collection(db, "groups"),
          (snapshot) => {
            groupsData = [];
            snapshot.forEach((doc) => {
              groupsData.push({
                id: doc.id,
                ...doc.data(),
              });
            });
            console.log("조모임 데이터 로드됨:", groupsData);

            // 조모임 모달이 열려있으면 새로고침
            const rankModal = document.getElementById("rank-modal");
            if (rankModal && !rankModal.classList.contains("hidden")) {
              renderRankList();
            }

            // 관리자 대시보드의 조모임 관리 탭이 열려있으면 새로고침
            if (
              currentMainTab === "dashboard" &&
              currentDashboardTab === "groups"
            ) {
              const subtabContainer =
                document.getElementById("subtab-container");
              if (subtabContainer) {
                renderGroupsAdmin(subtabContainer);
              }
            }
          },
          (error) => {
            console.error("조모임 데이터 로드 오류:", error);
          }
        );

        return unsubscribe;
      }

      // 조모임 추가 모달 열기
      function openGroupAddModal() {
        const modal = document.getElementById("group-add-modal");
        if (!modal) {
          createGroupAddModal();
        }

        // 입력 필드 초기화
        document.getElementById("group-add-name").value = "";
        document.getElementById("group-add-score").value = "";

        document.getElementById("group-add-modal").classList.remove("hidden");
      }

      // 조모임 추가 모달 생성
      function createGroupAddModal() {
        const modalHTML = `
          <div id="group-add-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full flex flex-col max-h-[90vh]">
              <div class="p-6 md:p-7 flex-shrink-0">
                <h3 class="text-xl font-bold text-gray-800 mb-4">🏅 조모임 추가</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">조모임 이름</label>
                    <input id="group-add-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="예: 1조, A조, 김치조">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">점수</label>
                    <input id="group-add-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0" value="0">
                  </div>
                </div>
              </div>
              <div class="p-6 md:p-7 pt-0 flex-shrink-0 border-t border-gray-100">
                <div class="flex gap-3">
                  <button id="group-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>추가
                  </button>
                  <button id="group-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                    취소
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("group-add-save")
          .addEventListener("click", async () => {
            const groupName = document
              .getElementById("group-add-name")
              .value.trim();
            const groupScore =
              parseInt(document.getElementById("group-add-score").value) || 0;

            if (!groupName) {
              showAlert("😥", "조모임 이름을 입력해주세요.");
              return;
            }

            try {
              await addGroup(groupName, groupScore);
              showAlert("✅", "조모임이 추가되었습니다.");
              document
                .getElementById("group-add-modal")
                .classList.add("hidden");
            } catch (error) {
              console.error("조모임 추가 오류:", error);
              showAlert("😥", "조모임 추가에 실패했습니다.");
            }
          });

        document
          .getElementById("group-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("group-add-modal").classList.add("hidden");
          });

        // 모달 외부 클릭 시 닫기
        document
          .getElementById("group-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "group-add-modal") {
              document
                .getElementById("group-add-modal")
                .classList.add("hidden");
            }
          });
      }

      function renderRankList() {
        const container = document.getElementById("rank-list");
        if (!container) return;

        // 독립적인 조모임 데이터 사용
        console.log("renderRankList: groupsData =", groupsData);

        let rankData = groupsData.filter(
          (group) => group.name && group.score !== undefined
        );

        // 점수순으로 정렬
        rankData.sort((a, b) => b.score - a.score);
        rankData = rankData.map((item, index) => ({
          ...item,
          rank: index + 1,
        }));

        // 관리자 권한 확인
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // 현재 사용자가 속한 조 찾기
        let userGroup = null;
        let userGroupRank = null;
        if (currentUser && currentUser.studentId) {
          userGroup = rankData.find((group) => {
            const members = group.members || [];
            return members.some((m) => {
              if (typeof m === "object") {
                return m.studentId === currentUser.studentId;
              }
              return m === currentUser.studentId || m === currentUser.name;
            });
          });
          if (userGroup) {
            userGroupRank = userGroup.rank;
          }
        }

        // 사용자 조의 앞뒤 조와 점수 차이 계산
        let prevGroup = null;
        let nextGroup = null;
        let scoreDiffPrev = null;
        let scoreDiffNext = null;

        if (userGroup) {
          // 앞 조 (더 높은 점수, 낮은 순위)
          if (userGroupRank > 1) {
            prevGroup = rankData.find((g) => g.rank === userGroupRank - 1);
            if (prevGroup) {
              scoreDiffPrev = prevGroup.score - userGroup.score;
            }
          }

          // 뒤 조 (더 낮은 점수, 높은 순위)
          if (userGroupRank < rankData.length) {
            nextGroup = rankData.find((g) => g.rank === userGroupRank + 1);
            if (nextGroup) {
              scoreDiffNext = userGroup.score - nextGroup.score;
            }
          }
        }

        // 사용자 조 강조 표시 (상단)
        let userGroupHTML = "";
        if (userGroup) {
          userGroupHTML = `
            <div class="mb-6 pb-6 border-b-4 border-orange-400">
              <div class="bg-gradient-to-br from-orange-400 to-orange-600 rounded-2xl p-6 shadow-xl">
                <div class="text-center mb-4">
                  <div class="text-5xl font-black text-white mb-2">${userGroupRank}위</div>
                  <div class="text-3xl font-bold text-white mb-4">${saf(
                    userGroup.name
                  )}</div>
                  <div class="text-4xl font-black text-yellow-200">${
                    userGroup.score
                  }점</div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                  ${
                    prevGroup
                      ? `
                      <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 text-center">
                        <div class="text-xs text-orange-100 mb-1">${
                          prevGroup.rank
                        }위</div>
                        <div class="text-lg font-bold text-white mb-1">${saf(
                          prevGroup.name
                        )}</div>
                        <div class="text-2xl font-black text-yellow-200">${
                          prevGroup.score
                        }점</div>
                        ${
                          scoreDiffPrev !== null
                            ? `<div class="text-sm mt-2 ${
                                scoreDiffPrev > 0
                                  ? "text-red-200"
                                  : "text-green-200"
                              }">
                              <i class="fas ${
                                scoreDiffPrev > 0 ? "fa-arrow-up" : "fa-equals"
                              } mr-1"></i>
                              ${
                                scoreDiffPrev > 0
                                  ? `${scoreDiffPrev}점 차이`
                                  : "동점"
                              }
                            </div>`
                            : ""
                        }
                      </div>
                    `
                      : `<div class="bg-white/10 rounded-xl p-4 text-center">
                        <div class="text-sm text-orange-100">위치 없음</div>
                      </div>`
                  }
                  
                  ${
                    nextGroup
                      ? `
                      <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 text-center">
                        <div class="text-xs text-orange-100 mb-1">${
                          nextGroup.rank
                        }위</div>
                        <div class="text-lg font-bold text-white mb-1">${saf(
                          nextGroup.name
                        )}</div>
                        <div class="text-2xl font-black text-yellow-200">${
                          nextGroup.score
                        }점</div>
                        ${
                          scoreDiffNext !== null
                            ? `<div class="text-sm mt-2 text-green-200">
                              <i class="fas fa-arrow-down mr-1"></i>
                              ${scoreDiffNext}점 앞서있음
                            </div>`
                            : ""
                        }
                      </div>
                    `
                      : `<div class="bg-white/10 rounded-xl p-4 text-center">
                        <div class="text-sm text-orange-100">위치 없음</div>
                      </div>`
                  }
                </div>
              </div>
            </div>
          `;
        }

        // 전체 순위 목록 (아래 스크롤 영역)
        const allRanksHTML = `
          <div class="mt-6">
            <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-list-ol mr-2 text-orange-600"></i>
              전체 순위
            </h4>
            <div class="space-y-2">
              ${rankData
                .map(
                  (item, index) => `
                <div class="p-3 rounded-lg relative ${
                  userGroup && item.id === userGroup.id
                    ? "bg-orange-100 border-2 border-orange-400"
                    : "bg-gray-50 border border-gray-200"
                }">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                      <div class="text-2xl font-bold ${
                        userGroup && item.id === userGroup.id
                          ? "text-orange-600"
                          : "text-gray-600"
                      }">${item.rank}위</div>
                      <div class="font-bold ${
                        userGroup && item.id === userGroup.id
                          ? "text-orange-800"
                          : "text-gray-800"
                      }">${item.name}</div>
                      ${
                        userGroup && item.id === userGroup.id
                          ? '<span class="px-2 py-0.5 bg-orange-500 text-white text-xs font-bold rounded">내 조</span>'
                          : ""
                      }
                    </div>
                    <div class="text-xl font-bold ${
                      userGroup && item.id === userGroup.id
                        ? "text-orange-600"
                        : "text-gray-600"
                    }">${item.score}점</div>
                  </div>
                  ${
                    item.members &&
                    item.members.length > 0 &&
                    currentUser &&
                    adminList.includes(currentUser.studentId)
                      ? `<div class="text-sm text-gray-600 mb-2">${
                          typeof item.members[0] === "object"
                            ? item.members
                                .map((m) => m.name || m.studentId)
                                .join(", ")
                            : item.members.join(", ")
                        }</div>`
                      : ""
                  }
                  ${
                    isAdmin
                      ? `
                    <div class="flex gap-1 justify-start">
                      <button class="edit-group-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                              data-group-id="${item.id}" data-group-name="${saf(
                          item.name
                        )}" data-group-score="${item.score}" title="수정">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="delete-group-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                              data-group-id="${item.id}" data-group-name="${saf(
                          item.name
                        )}" title="삭제">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  `
                      : ""
                  }
                </div>
              `
                )
                .join("")}
            </div>
          </div>
        `;

        const adminControls = document.getElementById("rank-admin-controls");
        const adminActions = document.getElementById("rank-admin-actions");

        if (isAdmin) {
          adminControls?.classList.remove("hidden");
          adminActions?.classList.remove("hidden");
        } else {
          adminControls?.classList.add("hidden");
          adminActions?.classList.add("hidden");
        }

        container.innerHTML =
          userGroupHTML + allRanksHTML ||
          `<div class="text-center text-gray-400 py-4">
            <i class="fas fa-info-circle text-2xl mb-2"></i>
            <p>조모임 데이터가 없습니다.</p>
            <p class="text-sm mt-1">관리자가 조모임을 추가하면 순위가 표시됩니다.</p>
          </div>`;

        // 조모임 수정/삭제 버튼 이벤트 리스너 추가
        if (isAdmin) {
          container.querySelectorAll(".edit-group-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const groupId = btn.dataset.groupId;
              const groupName = btn.dataset.groupName;
              const groupScore = btn.dataset.groupScore;
              openGroupEditModal(groupId, groupName, groupScore);
            });
          });

          container.querySelectorAll(".delete-group-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const groupId = btn.dataset.groupId;
              const groupName = btn.dataset.groupName;

              if (confirm(`정말로 "${groupName}"을(를) 삭제하시겠습니까?`)) {
                try {
                  await deleteGroup(groupId);
                  showAlert("✅", "조모임이 삭제되었습니다.");
                } catch (error) {
                  console.error("조모임 삭제 오류:", error);
                  showAlert("😥", "조모임 삭제에 실패했습니다.");
                }
              }
            });
          });
        }

        // 회장단이면 자동으로 점수 변경 기록 표시
        const isPresidentOrVice =
          currentUser &&
          (currentUser.position === "회장" ||
            currentUser.position === "부회장");

        const historySection = document.getElementById("rank-history-section");
        if (isPresidentOrVice && historySection) {
          historySection.classList.remove("hidden");
          loadGroupScoreHistory();
        } else if (historySection) {
          historySection.classList.add("hidden");
        }
      }

      // 점수 변경 기록 로드 (회장/부회장만)
      function loadGroupScoreHistory() {
        const isUserAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!currentUser || !isUserAdmin) return;

        const unsubscribe = onSnapshot(
          collection(db, "groupScoreHistory"),
          (snapshot) => {
            const history = [];
            snapshot.forEach((doc) => {
              history.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            // 최신순으로 정렬
            history.sort((a, b) => b.timestamp - a.timestamp);

            // 조모임 모달이 열려있으면 기록 새로고침
            const rankModal = document.getElementById("rank-modal");
            if (rankModal && !rankModal.classList.contains("hidden")) {
              renderRankHistory(history);
            }
          },
          (error) => {
            console.error("점수 변경 기록 로드 오류:", error);
          }
        );

        return unsubscribe;
      }

      // 점수 변경 기록 렌더링
      function renderRankHistory(history) {
        const container = document.getElementById("rank-history-list");
        if (!container) return;

        if (history.length === 0) {
          container.innerHTML =
            '<p class="text-gray-400 text-center py-4">변경 기록이 없습니다.</p>';
          return;
        }

        container.innerHTML = history
          .map((record) => {
            const actionText =
              record.action === "added"
                ? "추가"
                : record.action === "deleted"
                ? "삭제"
                : "수정";
            const actionIcon =
              record.action === "added"
                ? "➕"
                : record.action === "deleted"
                ? "🗑️"
                : "✏️";

            return `
            <div class="flex items-center justify-between p-2 bg-white rounded border">
              <div class="flex items-center gap-2">
                <span class="text-lg">${actionIcon}</span>
                <div>
                  <div class="font-medium text-gray-800">${saf(
                    record.groupName
                  )}</div>
                        <div class="text-xs text-gray-500">${
                          record.changedBy
                        }</div>
                </div>
              </div>
              <div class="text-right">
                <div class="text-sm font-semibold">
                  ${
                    record.action === "added"
                      ? `+${record.newScore}`
                      : record.action === "deleted"
                      ? `-${record.oldScore}`
                      : `${record.oldScore} → ${record.newScore}`
                  }
                </div>
                <div class="text-xs text-gray-500">
                  ${new Date(record.timestamp).toLocaleString()}
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // 조모임 순위 저장 함수
      async function saveGroupRankings() {
        try {
          console.log("=== 조모임 순위 저장 시작 ===");
          console.log("현재 groupsData:", groupsData);

          // 현재 groupsData를 점수순으로 정렬
          const sortedGroups = [...groupsData].sort(
            (a, b) => (b.score || 0) - (a.score || 0)
          );

          console.log("정렬된 groups:", sortedGroups);

          // Firebase에 각 그룹의 순위 업데이트
          const batch = writeBatch(db);

          sortedGroups.forEach((group, index) => {
            const groupRef = doc(db, "groups", group.id);
            batch.update(groupRef, {
              order: index + 1,
              lastUpdated: new Date(),
            });
          });

          await batch.commit();

          console.log("Firebase 업데이트 완료");
          showAlert("✅", "조모임 순위가 저장되었습니다.");

          // 조모임 목록 새로고침
          renderRankList();
        } catch (error) {
          console.error("조모임 순위 저장 오류:", error);
          showAlert("😥", "조모임 순위 저장에 실패했습니다.");
        }
      }

      // 조모임 수정 모달 열기
      function openGroupEditModal(groupId, groupName, groupScore) {
        const modal = document.getElementById("group-edit-modal");
        if (!modal) {
          createGroupEditModal();
        }

        // 입력 필드에 기존 값 설정
        document.getElementById("group-edit-id").value = groupId;
        document.getElementById("group-edit-name").value = groupName;
        document.getElementById("group-edit-score").value = groupScore;

        document.getElementById("group-edit-modal").classList.remove("hidden");
      }

      // 조모임 수정 모달 생성
      function createGroupEditModal() {
        const modalHTML = `
          <div id="group-edit-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full flex flex-col max-h-[90vh]">
              <div class="p-6 md:p-7 flex-shrink-0">
                <h3 class="text-xl font-bold text-gray-800 mb-4">🏅 조모임 수정</h3>
                <div class="space-y-4">
                  <input id="group-edit-id" type="hidden">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">조모임 이름</label>
                    <input id="group-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="예: 1조, A조, 김치조">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">점수</label>
                    <input id="group-edit-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0">
                  </div>
                </div>
              </div>
              <div class="p-6 md:p-7 pt-0 flex-shrink-0 border-t border-gray-100">
                <div class="flex gap-3">
                  <button id="group-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-save mr-2"></i>수정
                  </button>
                  <button id="group-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                    취소
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("group-edit-save")
          .addEventListener("click", async () => {
            const groupId = document.getElementById("group-edit-id").value;
            const groupName = document
              .getElementById("group-edit-name")
              .value.trim();
            const groupScore =
              parseInt(document.getElementById("group-edit-score").value) || 0;

            if (!groupName) {
              showAlert("😥", "조모임 이름을 입력해주세요.");
              return;
            }

            try {
              await updateGroup(groupId, groupName, groupScore);
              showAlert("✅", "조모임이 수정되었습니다.");
              document
                .getElementById("group-edit-modal")
                .classList.add("hidden");
            } catch (error) {
              console.error("조모임 수정 오류:", error);
              showAlert("😥", "조모임 수정에 실패했습니다.");
            }
          });

        document
          .getElementById("group-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("group-edit-modal").classList.add("hidden");
          });

        // 모달 외부 클릭 시 닫기
        document
          .getElementById("group-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "group-edit-modal") {
              document
                .getElementById("group-edit-modal")
                .classList.add("hidden");
            }
          });
      }

      // 조모임 수정 함수
      async function updateGroup(groupId, name, score) {
        // 수정 전 조모임 정보 가져오기
        const groupToUpdate = groupsData.find((g) => g.id === groupId);
        const oldScore = groupToUpdate ? groupToUpdate.score || 0 : 0;

        const groupRef = doc(db, "groups", groupId);
        await updateDoc(groupRef, {
          name: name,
          score: score,
          lastUpdated: new Date().toISOString(),
        });

        // 조모임 수정 기록 저장 (회장/부회장만 볼 수 있음)
        if (groupToUpdate && oldScore !== score) {
          await addDoc(collection(db, "groupScoreHistory"), {
            groupId: groupId,
            groupName: name,
            oldScore: oldScore,
            newScore: score,
            changedBy: currentUser.name,
            changedByStudentId: currentUser.studentId,
            timestamp: new Date(),
            date: new Date().toISOString().split("T")[0],
            action: "updated",
          });
        }
      }

      // 조모임 삭제 함수
      async function deleteGroup(groupId) {
        // 삭제 전 조모임 정보 가져오기
        const groupToDelete = groupsData.find((g) => g.id === groupId);

        const groupRef = doc(db, "groups", groupId);
        await deleteDoc(groupRef);

        // 조모임 삭제 기록 저장 (회장/부회장만 볼 수 있음)
        if (groupToDelete) {
          await addDoc(collection(db, "groupScoreHistory"), {
            groupId: groupId,
            groupName: groupToDelete.name,
            oldScore: groupToDelete.score || 0,
            newScore: 0,
            changedBy: currentUser.name,
            changedByStudentId: currentUser.studentId,
            timestamp: new Date(),
            date: new Date().toISOString().split("T")[0],
            action: "deleted",
          });
        }
      }

      // 조모임 추가 함수
      async function addGroup(name, score) {
        const docRef = await addDoc(collection(db, "groups"), {
          name: name,
          score: score || 0,
          members: [],
          lastUpdated: new Date().toISOString(),
        });

        // 조모임 추가 기록 저장 (회장/부회장만 볼 수 있음)
        await addDoc(collection(db, "groupScoreHistory"), {
          groupId: docRef.id,
          groupName: name,
          oldScore: 0,
          newScore: score || 0,
          changedBy: currentUser.name,
          changedByStudentId: currentUser.studentId,
          timestamp: new Date(),
          date: new Date().toISOString().split("T")[0],
          action: "added",
        });
      }

      // 팀 수정 모달 열기
      function openTeamEditModal(teamIndex, teamName, teamScore) {
        const modal = document.getElementById("team-edit-modal");
        if (!modal) {
          // 팀 수정 모달이 없으면 생성
          createTeamEditModal();
        }

        // 기존 값 설정
        document.getElementById("team-edit-name").value = teamName;
        document.getElementById("team-edit-score").value = teamScore;
        document.getElementById("team-edit-index").value = teamIndex;

        modal.classList.remove("hidden");
      }

      // 팀 수정 모달 생성
      function createTeamEditModal() {
        const modalHTML = `
          <div id="team-edit-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">팀 정보 수정</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">팀 이름</label>
                  <input id="team-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="팀 이름">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">점수</label>
                  <input id="team-edit-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="점수">
                </div>
                <input id="team-edit-index" type="hidden">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="team-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>저장
                </button>
                <button id="team-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // 이벤트 리스너 추가
        document
          .getElementById("team-edit-save")
          .addEventListener("click", async () => {
            const teamIndex = parseInt(
              document.getElementById("team-edit-index").value
            );
            const teamName = document
              .getElementById("team-edit-name")
              .value.trim();
            const teamScore =
              parseInt(document.getElementById("team-edit-score").value) || 0;

            if (!teamName) {
              showAlert("😥", "팀 이름을 입력해주세요.");
              return;
            }

            await updateTeamInScoreBlock(teamIndex, teamName, teamScore);
            showAlert("✅", "팀 정보가 수정되었습니다.");
            document.getElementById("team-edit-modal").classList.add("hidden");
            renderRankList(); // 순위 목록 새로고침
          });

        document
          .getElementById("team-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("team-edit-modal").classList.add("hidden");
          });

        // 모달 외부 클릭 시 닫기
        document
          .getElementById("team-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "team-edit-modal") {
              document
                .getElementById("team-edit-modal")
                .classList.add("hidden");
            }
          });
      }

      // 점수판 블록에서 팀 삭제
      async function deleteTeamFromScoreBlock(teamIndex) {
        const scoreBlocks =
          blocksData?.filter((b) => b.type === "scores") || [];
        if (scoreBlocks.length === 0) return;

        const scoreBlock = scoreBlocks[0];
        const teams = scoreBlock.payload?.teams || [];

        if (teamIndex >= 0 && teamIndex < teams.length) {
          teams.splice(teamIndex, 1);

          // Firebase 업데이트
          const blockRef = doc(db, "homepageBlocks", scoreBlock.id);
          await updateDoc(blockRef, {
            payload: { teams: teams },
          });
        }
      }

      // 점수판 블록에서 팀 수정
      async function updateTeamInScoreBlock(teamIndex, teamName, teamScore) {
        const scoreBlocks =
          blocksData?.filter((b) => b.type === "scores") || [];
        if (scoreBlocks.length === 0) return;

        const scoreBlock = scoreBlocks[0];
        const teams = scoreBlock.payload?.teams || [];

        if (teamIndex >= 0 && teamIndex < teams.length) {
          teams[teamIndex] = {
            name: teamName,
            score: teamScore,
          };

          // Firebase 업데이트
          const blockRef = doc(db, "homepageBlocks", scoreBlock.id);
          await updateDoc(blockRef, {
            payload: { teams: teams },
          });
        }
      }

      /* ===== 자동 로그인 ===== */
      const AUTO_LOGIN_KEY = "foodie_auto_login";
      const KEYCHAIN_SERVICE = "foodie_web_service";

      // 자동 로그인 정보 저장
      function saveAutoLogin(studentId, password) {
        try {
          const loginData = {
            studentId: studentId,
            password: password,
            timestamp: Date.now(),
          };

          // localStorage에 저장
          localStorage.setItem(AUTO_LOGIN_KEY, JSON.stringify(loginData));

          // Apple Keychain 지원 (iOS Safari)
          if (window.CredentialManager && window.CredentialManager.store) {
            window.CredentialManager.store({
              service: KEYCHAIN_SERVICE,
              username: studentId,
              password: password,
            }).catch((err) => console.log("Keychain 저장 실패:", err));
          }

          console.log("자동 로그인 정보 저장됨");
        } catch (error) {
          console.error("자동 로그인 저장 오류:", error);
        }
      }

      // 자동 로그인 정보 불러오기
      function loadAutoLogin() {
        try {
          // localStorage에서 불러오기
          const saved = localStorage.getItem(AUTO_LOGIN_KEY);
          if (saved) {
            const loginData = JSON.parse(saved);
            // 영구 저장 (기간 제한 없음)
            return loginData;
          }

          // Apple Keychain에서 불러오기 (iOS Safari)
          if (window.CredentialManager && window.CredentialManager.get) {
            return window.CredentialManager.get({
              service: KEYCHAIN_SERVICE,
            })
              .then((credential) => {
                if (credential) {
                  return {
                    studentId: credential.username,
                    password: credential.password,
                    timestamp: Date.now(),
                  };
                }
                return null;
              })
              .catch((err) => {
                console.log("Keychain 불러오기 실패:", err);
                return null;
              });
          }

          return null;
        } catch (error) {
          console.error("자동 로그인 불러오기 오류:", error);
          return null;
        }
      }

      // 자동 로그인 정보 삭제
      function clearAutoLogin() {
        try {
          localStorage.removeItem(AUTO_LOGIN_KEY);

          if (window.CredentialManager && window.CredentialManager.delete) {
            window.CredentialManager.delete({
              service: KEYCHAIN_SERVICE,
            }).catch((err) => console.log("Keychain 삭제 실패:", err));
          }

          console.log("자동 로그인 정보 삭제됨");
        } catch (error) {
          console.error("자동 로그인 삭제 오류:", error);
        }
      }

      // 자동 로그인 시도
      async function attemptAutoLogin() {
        try {
          const loginData = await loadAutoLogin();
          if (!loginData) return false;

          // 로그인 폼에 값 설정
          const studentIdInput = document.getElementById("studentId");
          const studentNameInput = document.getElementById("studentName");

          if (studentIdInput && studentNameInput) {
            studentIdInput.value = loginData.studentId;
            studentNameInput.value = loginData.password; // 이름이 패스워드 역할

            // 자동 로그인 체크박스 체크
            const autoLoginCheckbox = document.getElementById(
              "auto-login-checkbox"
            );
            if (autoLoginCheckbox) {
              autoLoginCheckbox.checked = true;
            }

            // 자동 로그인 시도
            await login();
            return true;
          }

          return false;
        } catch (error) {
          console.error("자동 로그인 시도 오류:", error);
          return false;
        }
      }

      /* ===== 뭐먹지? 메뉴 추천 ===== */

      // 메뉴 데이터베이스 (한식·일식·중식·양식 + 디저트)
      // 총 480개 메뉴 (아침 120개, 점심 120개, 저녁 120개, 디저트 30개)
      // 음식 카테고리 정의 (미식회 카테고리와 동일한 스타일)
      const foodCategories = [
        {
          id: "korean",
          name: "한식",
          emoji: "🍚",
          color: "from-red-500 to-orange-500",
        },
        {
          id: "japanese",
          name: "일식",
          emoji: "🍣",
          color: "from-pink-500 to-red-500",
        },
        {
          id: "chinese",
          name: "중식",
          emoji: "🥟",
          color: "from-yellow-500 to-red-600",
        },
        {
          id: "western",
          name: "양식",
          emoji: "🍝",
          color: "from-orange-500 to-yellow-500",
        },
        {
          id: "asian",
          name: "아시안",
          emoji: "🍜",
          color: "from-green-500 to-teal-500",
        },
        {
          id: "snack",
          name: "분식",
          emoji: "🥘",
          color: "from-orange-400 to-red-400",
        },
        {
          id: "dessert",
          name: "디저트",
          emoji: "🍰",
          color: "from-purple-500 to-pink-500",
        },
        {
          id: "cafe",
          name: "카페",
          emoji: "☕",
          color: "from-amber-600 to-orange-600",
        },
        {
          id: "fastfood",
          name: "패스트푸드",
          emoji: "🍔",
          color: "from-yellow-600 to-red-600",
        },
      ];

      // 뭐먹지 메뉴 데이터 (Firebase에서 로드)
      let foodMenusData = [];
      let selectedCategory = "all";
      let excludedTodayMenus = []; // 오늘 제외된 메뉴들
      let isRouletteSpinning = false;
      let rouletteHistory = []; // 추천된 메뉴 히스토리

      // 메뉴 추천 모달 열기
      function openFoodRecommendModal() {
        const modal = document.getElementById("food-recommend-modal");
        if (!modal) return;

        modal.classList.remove("hidden");
        loadFoodMenus();
        updateCategoryFilter();

        // 회장단 권한 확인
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // 빠른 메뉴 추가와 메뉴 관리 버튼은 회장단만 표시
        const quickAddSection = document.getElementById("quick-add-section");
        const menuManageBtn = document.getElementById("menu-manage-btn");

        if (isAdmin) {
          if (quickAddSection) quickAddSection.classList.remove("hidden");
          if (menuManageBtn) menuManageBtn.classList.remove("hidden");
        } else {
          if (quickAddSection) quickAddSection.classList.add("hidden");
          if (menuManageBtn) menuManageBtn.classList.add("hidden");
        }

        // 룰렛 초기 상태로 리셋
        const rouletteEmoji = document.getElementById("roulette-emoji");
        const rouletteText = document.getElementById("roulette-text");
        if (rouletteEmoji) rouletteEmoji.textContent = "🍽️";
        if (rouletteText)
          rouletteText.textContent = "메뉴를 추가하고 버튼을 눌러주세요!";

        // 히스토리 업데이트
        updateRouletteHistory();
      }

      // Firebase에서 메뉴 로드
      async function loadFoodMenus() {
        try {
          const snapshot = await getDocs(collection(db, "foodMenus"));
          foodMenusData = [];
          snapshot.forEach((doc) => {
            foodMenusData.push({
              id: doc.id,
              ...doc.data(),
            });
          });
          console.log("메뉴 로드됨:", foodMenusData.length, "개");
        } catch (error) {
          console.error("메뉴 로드 오류:", error);
        }
      }

      // 카테고리 필터 업데이트
      function updateCategoryFilter() {
        const filterBtns = document.querySelectorAll(".category-filter-btn");
        filterBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            filterBtns.forEach((b) => {
              b.classList.remove("active", "bg-orange-500", "text-white");
              b.classList.add("bg-gray-200", "text-gray-700");
            });
            btn.classList.add("active", "bg-orange-500", "text-white");
            btn.classList.remove("bg-gray-200", "text-gray-700");

            selectedCategory = btn.dataset.category;
          });
        });
      }

      // 룰렛 돌리기
      async function spinRoulette() {
        if (isRouletteSpinning) return;

        // 필터링된 메뉴 목록 가져오기
        let availableMenus = foodMenusData.filter((menu) => {
          // 카테고리 필터
          if (
            selectedCategory !== "all" &&
            menu.category !== selectedCategory
          ) {
            return false;
          }
          // 오늘 제외 필터
          if (excludedTodayMenus.includes(menu.id)) {
            return false;
          }
          return true;
        });

        if (availableMenus.length === 0) {
          showAlert(
            "😥",
            "선택할 수 있는 메뉴가 없습니다!\n메뉴를 먼저 추가해주세요."
          );
          return;
        }

        isRouletteSpinning = true;
        const spinBtn = document.getElementById("spin-roulette-btn");
        const rouletteEmoji = document.getElementById("roulette-emoji");
        const rouletteText = document.getElementById("roulette-text");
        const resultActions = document.getElementById("result-actions");

        // 버튼 비활성화
        if (spinBtn) {
          spinBtn.disabled = true;
          spinBtn.querySelector("span").innerHTML =
            '<i class="fas fa-spinner fa-spin text-2xl"></i><span class="text-lg">돌리는 중...</span>';
        }

        // 룰렛 애니메이션 (2초간 빠르게 메뉴 변경)
        const animationDuration = 2000;
        const intervalTime = 100;
        let animationInterval;

        animationInterval = setInterval(() => {
          const randomMenu =
            availableMenus[Math.floor(Math.random() * availableMenus.length)];
          const emoji = getCategoryEmoji(randomMenu.category);
          if (rouletteEmoji) {
            rouletteEmoji.textContent = emoji;
            rouletteEmoji.style.animation = "pulse 0.1s ease";
          }
          if (rouletteText) {
            rouletteText.textContent = randomMenu.name;
          }
        }, intervalTime);

        // 최종 메뉴 선택
        setTimeout(() => {
          clearInterval(animationInterval);

          const finalMenu =
            availableMenus[Math.floor(Math.random() * availableMenus.length)];
          const emoji = getCategoryEmoji(finalMenu.category);

          if (rouletteEmoji) {
            rouletteEmoji.textContent = emoji;
            rouletteEmoji.style.animation = "bounce 0.6s ease";
            setTimeout(() => (rouletteEmoji.style.animation = ""), 600);
          }
          if (rouletteText) {
            rouletteText.textContent = finalMenu.name;
            rouletteText.style.animation = "pulse 0.6s ease";
            setTimeout(() => (rouletteText.style.animation = ""), 600);
          }

          // 히스토리에 추가
          addToRouletteHistory(finalMenu);

          // 버튼 복원
          if (spinBtn) {
            spinBtn.disabled = false;
            spinBtn.querySelector("span").innerHTML =
              '<i class="fas fa-dice text-2xl"></i><span class="text-lg">메뉴 뽑기</span>';
          }

          isRouletteSpinning = false;
        }, animationDuration);
      }

      // 카테고리별 이모지 반환
      function getCategoryEmoji(category) {
        const emojiMap = {
          korean: "🍚",
          japanese: "🍣",
          chinese: "🥟",
          western: "🍝",
          asian: "🍜",
          snack: "🥘",
          dessert: "🍰",
          cafe: "☕",
          etc: "🍽️",
        };
        return emojiMap[category] || "🍽️";
      }

      // 히스토리에 메뉴 추가
      function addToRouletteHistory(menu) {
        rouletteHistory.unshift({
          ...menu,
          timestamp: new Date().toISOString(),
        });

        // 최대 10개까지만 유지
        if (rouletteHistory.length > 10) {
          rouletteHistory = rouletteHistory.slice(0, 10);
        }

        updateRouletteHistory();
      }

      // 히스토리 UI 업데이트
      function updateRouletteHistory() {
        const historySection = document.getElementById("menu-history-section");
        const historyContainer = document.getElementById("roulette-history");

        if (!historySection || !historyContainer) return;

        if (rouletteHistory.length === 0) {
          historySection.classList.add("hidden");
          return;
        }

        historySection.classList.remove("hidden");

        historyContainer.innerHTML = rouletteHistory
          .map((menu, index) => {
            const emoji = getCategoryEmoji(menu.category);
            const time = new Date(menu.timestamp);
            const timeStr = `${time
              .getHours()
              .toString()
              .padStart(2, "0")}:${time
              .getMinutes()
              .toString()
              .padStart(2, "0")}`;

            return `
            <div class="inline-flex items-center gap-2 bg-white px-3 py-2 rounded-lg border-2 border-orange-200 text-sm shadow-sm">
              <span class="text-lg">${emoji}</span>
              <span class="font-medium">${menu.name}</span>
              <span class="text-xs text-gray-400">${timeStr}</span>
            </div>
          `;
          })
          .join("");
      }

      // 메뉴 관리 모달 열기
      function openMenuManageModal() {
        const modal = document.getElementById("menu-manage-modal");
        if (!modal) return;

        modal.classList.remove("hidden");
        loadFoodMenus().then(() => {
          renderMenuList();
        });
      }

      // 메뉴 관리 모달 닫기
      function closeMenuManageModal() {
        const modal = document.getElementById("menu-manage-modal");
        if (modal) modal.classList.add("hidden");
      }

      // 메뉴 목록 렌더링
      function renderMenuList() {
        const container = document.getElementById("menu-list-container");
        const countBadge = document.getElementById("menu-count-badge");

        if (!container) return;

        if (countBadge) countBadge.textContent = `(${foodMenusData.length}개)`;

        if (foodMenusData.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8 text-gray-400">
              <i class="fas fa-utensils text-4xl mb-3"></i>
              <p>등록된 메뉴가 없습니다</p>
              <p class="text-sm">위에서 메뉴를 추가해보세요!</p>
            </div>
          `;
          return;
        }

        // 카테고리별로 그룹화
        const groupedMenus = {};
        foodMenusData.forEach((menu) => {
          if (!groupedMenus[menu.category]) {
            groupedMenus[menu.category] = [];
          }
          groupedMenus[menu.category].push(menu);
        });

        const categoryNames = {
          korean: "한식",
          japanese: "일식",
          chinese: "중식",
          western: "양식",
          asian: "아시안",
          snack: "분식",
          dessert: "디저트",
          cafe: "카페",
          etc: "기타",
        };

        let html = "";
        Object.keys(groupedMenus).forEach((category) => {
          const emoji = getCategoryEmoji(category);
          const categoryName = categoryNames[category] || category;
          const menus = groupedMenus[category];

          html += `
            <div class="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
              <h5 class="font-bold text-gray-800 mb-3">
                ${emoji} ${categoryName} <span class="text-sm text-gray-500">(${
            menus.length
          }개)</span>
              </h5>
              <div class="flex flex-wrap gap-2">
                ${menus
                  .map(
                    (menu) => `
                  <span class="inline-flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-300 text-sm">
                    <span>${menu.name}</span>
                    <button
                      class="delete-menu-btn text-red-500 hover:text-red-700 transition-colors"
                      data-id="${menu.id}"
                      data-name="${menu.name}"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </span>
                `
                  )
                  .join("")}
              </div>
            </div>
          `;
        });

        container.innerHTML = html;

        // 삭제 버튼 이벤트
        container.querySelectorAll(".delete-menu-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const name = btn.dataset.name;

            if (confirm(`'${name}' 메뉴를 삭제하시겠습니까?`)) {
              try {
                await deleteDoc(doc(db, "foodMenus", id));
                showAlert("✅", "메뉴가 삭제되었습니다.");
                // onSnapshot이 자동으로 업데이트하므로 loadFoodMenus() 불필요
                renderMenuList();
              } catch (error) {
                console.error("메뉴 삭제 오류:", error);
                showAlert("😥", "메뉴 삭제 중 오류가 발생했습니다.");
              }
            }
          });
        });
      }

      // 대량 메뉴 추가
      async function bulkAddMenus() {
        const textarea = document.getElementById("bulk-menu-input");
        const categorySelect = document.getElementById("menu-category-select");

        if (!textarea || !categorySelect) return;

        const text = textarea.value.trim();
        if (!text) {
          showAlert("😥", "메뉴를 입력해주세요.");
          return;
        }

        const menuLines = text.split("\n").filter((line) => line.trim());
        const category = categorySelect.value;

        if (menuLines.length === 0) {
          showAlert("😥", "유효한 메뉴가 없습니다.");
          return;
        }

        try {
          const batch = writeBatch(db);
          menuLines.forEach((menuName) => {
            const docRef = doc(collection(db, "foodMenus"));
            batch.set(docRef, {
              name: menuName.trim(),
              category: category,
              createdAt: new Date().toISOString(),
              createdBy: currentUser?.studentId || "unknown",
            });
          });

          await batch.commit();
          showAlert("✅", `${menuLines.length}개의 메뉴가 추가되었습니다!`);
          textarea.value = "";
          // onSnapshot이 자동으로 업데이트하므로 loadFoodMenus() 불필요
          renderMenuList();
        } catch (error) {
          console.error("메뉴 추가 오류:", error);
          showAlert("😥", "메뉴 추가 중 오류가 발생했습니다.");
        }
      }

      // 빠른 메뉴 추가
      async function quickAddMenu() {
        const input = document.getElementById("quick-menu-input");
        if (!input) return;

        const menuName = input.value.trim();
        if (!menuName) return;

        try {
          await addDoc(collection(db, "foodMenus"), {
            name: menuName,
            category: "etc", // 기본 카테고리: 기타
            createdAt: new Date().toISOString(),
            createdBy: currentUser?.studentId || "unknown",
          });

          input.value = "";
          // onSnapshot이 자동으로 업데이트하므로 loadFoodMenus() 불필요
          showAlert("✅", `'${menuName}' 메뉴가 추가되었습니다!`);
        } catch (error) {
          console.error("빠른 메뉴 추가 오류:", error);
          showAlert("😥", "메뉴 추가 중 오류가 발생했습니다.");
        }
      }

      // 전체 메뉴 삭제
      async function deleteAllMenus() {
        if (
          !confirm(
            "정말로 모든 메뉴를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다."
          )
        ) {
          return;
        }

        try {
          const snapshot = await getDocs(collection(db, "foodMenus"));
          const batch = writeBatch(db);

          snapshot.forEach((docSnap) => {
            batch.delete(docSnap.ref);
          });

          await batch.commit();
          showAlert("✅", "모든 메뉴가 삭제되었습니다.");
          // onSnapshot이 자동으로 업데이트하므로 loadFoodMenus() 불필요
          renderMenuList();
        } catch (error) {
          console.error("전체 삭제 오류:", error);
          showAlert("😥", "삭제 중 오류가 발생했습니다.");
        }
      }

      // 이벤트 리스너 등록 (뭐먹지 기능)
      document.addEventListener("DOMContentLoaded", () => {
        // 룰렛 버튼
        document
          .getElementById("spin-roulette-btn")
          ?.addEventListener("click", spinRoulette);

        // 메뉴 관리 버튼
        document
          .getElementById("menu-manage-btn")
          ?.addEventListener("click", openMenuManageModal);
        document
          .getElementById("menu-manage-close")
          ?.addEventListener("click", closeMenuManageModal);

        // 대량 추가 버튼
        document
          .getElementById("bulk-add-menu-btn")
          ?.addEventListener("click", bulkAddMenus);

        // 빠른 추가 버튼
        document
          .getElementById("quick-add-btn")
          ?.addEventListener("click", quickAddMenu);

        // Enter 키로 빠른 추가
        document
          .getElementById("quick-menu-input")
          ?.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              quickAddMenu();
            }
          });

        // 전체 삭제 버튼
        document
          .getElementById("delete-all-menus-btn")
          ?.addEventListener("click", deleteAllMenus);
      });

      // 24시간마다 제외 목록 초기화
      setInterval(() => {
        excludedTodayMenus = [];
        console.log("오늘 제외 목록 초기화됨");
      }, 24 * 60 * 60 * 1000);

      // 네트워크 재연결 감지
      window.addEventListener("online", () => {
        console.log("네트워크 재연결됨, 데이터 새로고침");
        if (currentUser) {
          // 데이터 다시 로드
          setTimeout(() => {
            renderAll();
          }, 1000);
        }
      });

      window.addEventListener("offline", () => {
        console.warn("네트워크 연결 끊김");
        showAlert(
          "⚠️",
          "네트워크 연결이 끊겼습니다.\n일부 기능이 제한될 수 있습니다."
        );
      });

      // 기존 슬롯머신 관련 함수들 삭제됨

      /* ===== 미니게임 (레거시 코드 - 사용 안 함) ===== */
      let currentGame = null;
      let gameState = {};
      let gameScores = {}; // 게임 점수 데이터

      function showGameSelection() {
        document.getElementById("game-selection").classList.remove("hidden");
        document.getElementById("game-screen").classList.add("hidden");
        currentGame = null;
        gameState = {};
      }

      function showGameScreen() {
        document.getElementById("game-selection").classList.add("hidden");
        document.getElementById("game-screen").classList.remove("hidden");
        document.getElementById("ranking-screen").classList.add("hidden");
      }

      function showRankingScreen() {
        document.getElementById("game-selection").classList.add("hidden");
        document.getElementById("game-screen").classList.add("hidden");
        document.getElementById("ranking-screen").classList.remove("hidden");
        renderGameRankings();
      }

      function showGameSelectionFromRanking() {
        document.getElementById("game-selection").classList.remove("hidden");
        document.getElementById("game-screen").classList.add("hidden");
        document.getElementById("ranking-screen").classList.add("hidden");
        currentGame = null;
        gameState = {};
      }

      // 게임 점수 저장
      async function saveGameScore(gameType, score, details = {}) {
        if (!currentUser) return;

        try {
          // 이름 중복 확인
          const existingScores = gameScores[gameType] || [];
          const duplicateName = existingScores.find(
            (s) => s.name === currentUser.name
          );

          if (duplicateName) {
            // 중복된 이름이 있는 경우 기존 기록과 비교
            let shouldUpdate = false;

            if (gameType === "color-memory") {
              // 색깔 기억하기: 더 높은 레벨이면 업데이트
              shouldUpdate =
                (details.level || 0) > (duplicateName.details.level || 0);
            } else if (gameType === "car-racing") {
              // 자동차 레이싱: 더 긴 거리면 업데이트
              shouldUpdate =
                (details.distance || 0) > (duplicateName.details.distance || 0);
            } else if (gameType === "ball-bounce") {
              // 공 튀기기: 더 높은 점수면 업데이트
              shouldUpdate =
                (details.score || 0) > (duplicateName.details.score || 0);
            } else {
              // 숫자 맞추기: 더 적은 시도 횟수면 업데이트
              shouldUpdate =
                (details.attempts || 999) <
                (duplicateName.details.attempts || 999);
            }

            if (shouldUpdate) {
              // 기존 기록을 업데이트
              await updateDoc(doc(db, "gameScores", duplicateName.id), {
                score: score,
                details: details,
                timestamp: new Date(),
                date: getTodayString(),
              });
              showAlert("🎉", "기존 기록을 갱신했습니다!");
            } else {
              return;
            }
          } else {
            // 새로운 기록 저장
            const scoreData = {
              studentId: currentUser.studentId,
              name: currentUser.name,
              gameType: gameType,
              score: score,
              details: details,
              timestamp: new Date(),
              date: new Date().toISOString().split("T")[0], // YYYY-MM-DD 형식
            };

            await addDoc(collection(db, "gameScores"), scoreData);
            showAlert("🎉", "새로운 기록이 저장되었습니다!");
          }

          // 로컬 데이터는 onSnapshot에서 자동 업데이트됨
          console.log(`${gameType} 점수 저장 완료`);
        } catch (error) {
          console.error("점수 저장 오류:", error);
          showAlert("😥", "점수 저장에 실패했습니다.");
        }
      }

      // 게임 랭킹 렌더링
      function renderGameRankings() {
        const content = document.getElementById("ranking-content");
        if (!content) return;

        const games = [
          {
            type: "number-guess",
            name: "🔢 숫자 맞추기",
            description: "최소 시도 횟수",
          },
          {
            type: "color-memory",
            name: "🎨 색깔 기억하기",
            description: "최고 레벨",
          },
          {
            type: "car-racing",
            name: "🚗 자동차 레이싱",
            description: "최고 거리",
          },
          {
            type: "ball-bounce",
            name: "⚽ 공 튀기기",
            description: "최고 점수",
          },
        ];

        let html = '<div class="space-y-6">';

        // 관리자 기능 추가
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (isAdmin) {
          html += `
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <h4 class="font-bold text-orange-800 mb-2">🔧 관리자 기능</h4>
              <div class="flex gap-2">
                <button id="clear-all-scores" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors">
                  전체 점수 초기화
                </button>
                <button id="clear-game-scores" class="px-3 py-1 bg-orange-500 text-white text-sm rounded hover:bg-orange-600 transition-colors">
                  게임별 점수 초기화
                </button>
              </div>
            </div>
          `;
        }

        games.forEach((game) => {
          const scores = gameScores[game.type] || [];
          const sortedScores = scores
            .sort((a, b) => {
              if (game.type === "color-memory") {
                return (b.details.level || 0) - (a.details.level || 0);
              } else if (game.type === "car-racing") {
                return (b.details.distance || 0) - (a.details.distance || 0);
              } else if (game.type === "ball-bounce") {
                return (b.details.score || 0) - (a.details.score || 0);
              } else {
                return (
                  (a.details.attempts || 999) - (b.details.attempts || 999)
                );
              }
            })
            .slice(0, 10); // 상위 10명

          html += `
            <div class="border rounded-lg p-4">
              <div class="flex justify-between items-center mb-2">
                <h4 class="font-bold text-lg">${game.name}</h4>
                ${
                  isAdmin
                    ? `<button class="clear-game-btn px-2 py-1 bg-red-400 text-white text-xs rounded hover:bg-red-500 transition-colors" data-game-type="${game.type}" title="이 게임의 모든 점수를 초기화합니다">이 게임 점수 초기화</button>`
                    : ""
                }
              </div>
                    <p class="text-sm text-gray-600 mb-3">${
                      game.description
                    }</p>
              <div class="space-y-2">
          `;

          if (sortedScores.length === 0) {
            html +=
              '<p class="text-gray-400 text-center py-4">아직 기록이 없습니다.</p>';
          } else {
            sortedScores.forEach((score, index) => {
              const rank = index + 1;
              const rankIcon =
                rank === 1
                  ? "🥇"
                  : rank === 2
                  ? "🥈"
                  : rank === 3
                  ? "🥉"
                  : `${rank}.`;
              let displayValue;
              if (game.type === "color-memory") {
                displayValue = `레벨 ${score.details.level || 0}`;
              } else if (game.type === "car-racing") {
                displayValue = `${score.details.distance || 0}m`;
              } else if (game.type === "ball-bounce") {
                displayValue = `${score.details.score || 0}점`;
              } else {
                displayValue = `${score.details.attempts || 0}번`;
              }

              html += `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                  <div class="flex items-center gap-3">
                    <span class="text-lg">${rankIcon}</span>
                    <span class="font-medium">${saf(score.name)}</span>
                  </div>
                  <div class="text-right">
                    <div class="font-bold text-blue-600">${displayValue}</div>
                    <div class="text-xs text-gray-500">${new Date(
                      score.timestamp
                    ).toLocaleDateString()}</div>
                  </div>
                </div>
              `;
            });
          }

          html += `
              </div>
            </div>
          `;
        });

        html += "</div>";
        content.innerHTML = html;

        // 관리자 버튼 이벤트 리스너 추가
        if (isAdmin) {
          // 전체 점수 초기화
          document
            .getElementById("clear-all-scores")
            ?.addEventListener("click", async () => {
              if (
                confirm(
                  "정말로 모든 게임의 점수를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다."
                )
              ) {
                try {
                  const batch = writeBatch(db);
                  const snapshot = await getDocs(collection(db, "gameScores"));
                  snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                  });
                  await batch.commit();
                  showAlert("✅", "모든 게임 점수가 초기화되었습니다.");
                  renderGameRankings(); // 랭킹 화면 새로고침
                } catch (error) {
                  console.error("점수 초기화 오류:", error);
                  showAlert("😥", "점수 초기화에 실패했습니다.");
                }
              }
            });

          // 게임별 점수 초기화
          document
            .getElementById("clear-game-scores")
            ?.addEventListener("click", async () => {
              const gameType = prompt(
                "초기화할 게임을 선택하세요:\n1. number-guess (숫자 맞추기)\n2. color-memory (색깔 기억하기)\n3. car-racing (자동차 레이싱)\n4. ball-bounce (공 튀기기)\n\n게임 타입을 입력하세요:"
              );
              if (!gameType) return;

              if (
                confirm(
                  `정말로 "${gameType}" 게임의 점수를 초기화하시겠습니까?`
                )
              ) {
                try {
                  const batch = writeBatch(db);
                  const snapshot = await getDocs(
                    query(
                      collection(db, "gameScores"),
                      where("gameType", "==", gameType)
                    )
                  );
                  snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                  });
                  await batch.commit();
                  showAlert("✅", `${gameType} 게임 점수가 초기화되었습니다.`);
                  renderGameRankings(); // 랭킹 화면 새로고침
                } catch (error) {
                  console.error("게임별 점수 초기화 오류:", error);
                  showAlert("😥", "점수 초기화에 실패했습니다.");
                }
              }
            });

          // 개별 게임 점수 초기화
          document.querySelectorAll(".clear-game-btn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const gameType = btn.dataset.gameType;
              const gameNames = {
                "number-guess": "숫자 맞추기",
                "color-memory": "색깔 기억하기",
                "car-racing": "자동차 레이싱",
                "ball-bounce": "공 튀기기",
              };

              if (
                confirm(
                  `정말로 "${gameNames[gameType]}" 게임의 점수를 초기화하시겠습니까?`
                )
              ) {
                try {
                  const batch = writeBatch(db);
                  const snapshot = await getDocs(
                    query(
                      collection(db, "gameScores"),
                      where("gameType", "==", gameType)
                    )
                  );
                  snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                  });
                  await batch.commit();
                  showAlert(
                    "✅",
                    `${gameNames[gameType]} 게임 점수가 초기화되었습니다.`
                  );
                  renderGameRankings(); // 랭킹 화면 새로고침
                } catch (error) {
                  console.error("게임별 점수 초기화 오류:", error);
                  showAlert("😥", "점수 초기화에 실패했습니다.");
                }
              }
            });
          });
        }
      }

      // 숫자 맞추기 게임
      function startNumberGuessGame() {
        currentGame = "number-guess";
        gameState = {
          targetNumber: Math.floor(Math.random() * 10000) + 1,
          attempts: 0,
          maxAttempts: 15, // 범위가 커졌으므로 시도 횟수 증가
        };

        showGameScreen();
        updateNumberGuessUI();
      }

      function updateNumberGuessUI() {
        const content = document.getElementById("game-content");
        const { targetNumber, attempts, maxAttempts } = gameState;

        content.innerHTML = `
          <div class="mb-4">
            <h4 class="text-lg font-bold text-blue-700 mb-2">🔢 숫자 맞추기</h4>
            <p class="text-sm text-gray-600">1부터 10,000 사이의 숫자를 맞춰보세요!</p>
            <p class="text-sm text-gray-500">남은 기회: ${
              maxAttempts - attempts
            }번</p>
          </div>
          
          <div class="mb-4">
            <input 
              type="number" 
              id="number-input" 
              min="1" 
              max="10000" 
              placeholder="숫자 입력 (1-10000)"
              class="w-full p-3 border border-gray-300 rounded-lg text-center text-lg"
            >
          </div>
          
          <button 
            id="guess-btn" 
            class="w-full p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
          >
            확인
          </button>
          
          <div id="guess-result" class="mt-4 text-center"></div>
        `;

        // 이벤트 리스너 추가
        document
          .getElementById("guess-btn")
          .addEventListener("click", handleNumberGuess);
        document
          .getElementById("number-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleNumberGuess();
          });
      }

      function handleNumberGuess() {
        const input = document.getElementById("number-input");
        const result = document.getElementById("guess-result");
        const guess = parseInt(input.value);

        if (isNaN(guess) || guess < 1 || guess > 10000) {
          result.innerHTML =
            '<p class="text-red-500">1부터 10,000 사이의 숫자를 입력해주세요!</p>';
          return;
        }

        gameState.attempts++;

        if (guess === gameState.targetNumber) {
          result.innerHTML = `
            <div class="text-green-600">
              <p class="text-xl font-bold">🎉 정답입니다!</p>
              <p>${gameState.attempts}번 만에 맞추셨네요!</p>
            </div>
          `;
          document.getElementById("guess-btn").disabled = true;
          input.disabled = true;

          // 점수 저장
          saveGameScore("number-guess", gameState.attempts, {
            attempts: gameState.attempts,
            targetNumber: gameState.targetNumber,
          });
        } else if (gameState.attempts >= gameState.maxAttempts) {
          result.innerHTML = `
            <div class="text-red-600">
              <p class="text-xl font-bold">😢 게임 종료!</p>
              <p>정답은 ${gameState.targetNumber}였습니다.</p>
            </div>
          `;
          document.getElementById("guess-btn").disabled = true;
          input.disabled = true;
        } else {
          const hint = guess > gameState.targetNumber ? "더 작은" : "더 큰";
          result.innerHTML = `<p class="text-orange-500">${hint} 숫자입니다! 다시 시도해보세요.</p>`;
        }

        input.value = "";
      }

      // 색깔 기억하기 게임
      function startColorMemoryGame() {
        currentGame = "color-memory";
        gameState = {
          sequence: [],
          playerSequence: [],
          level: 1,
          colors: ["red", "blue", "green", "yellow"],
          isShowing: false,
          maxLevel: 100, // 최대 레벨 100으로 확장
        };

        generateSequence();
        showGameScreen();
        updateColorMemoryUI();
      }

      function generateSequence() {
        gameState.sequence.push(
          gameState.colors[Math.floor(Math.random() * gameState.colors.length)]
        );
      }

      function updateColorMemoryUI() {
        const content = document.getElementById("game-content");

        content.innerHTML = `
          <div class="mb-4">
            <h4 class="text-lg font-bold text-green-700 mb-2">🎨 색깔 기억하기</h4>
            <p class="text-sm text-gray-600">색깔 순서를 기억하고 따라해보세요!</p>
            <p class="text-sm text-gray-500">레벨: ${gameState.level}/${gameState.maxLevel}</p>
          </div>
          
          <div class="grid grid-cols-2 gap-6 mb-6">
            <button class="color-btn w-32 h-32 md:w-40 md:h-40 rounded-xl bg-red-500 hover:bg-red-600 transition-all hover:scale-105" data-color="red"></button>
            <button class="color-btn w-32 h-32 md:w-40 md:h-40 rounded-xl bg-blue-500 hover:bg-blue-600 transition-all hover:scale-105" data-color="blue"></button>
            <button class="color-btn w-32 h-32 md:w-40 md:h-40 rounded-xl bg-green-500 hover:bg-green-600 transition-all hover:scale-105" data-color="green"></button>
            <button class="color-btn w-32 h-32 md:w-40 md:h-40 rounded-xl bg-yellow-500 hover:bg-yellow-600 transition-all hover:scale-105" data-color="yellow"></button>
          </div>
          
          <button 
            id="start-sequence-btn" 
            class="w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600"
          >
            순서 보기
          </button>
          
          <div id="sequence-result" class="mt-4 text-center"></div>
        `;

        // 이벤트 리스너 추가
        document
          .getElementById("start-sequence-btn")
          .addEventListener("click", showSequence);
        document.querySelectorAll(".color-btn").forEach((btn) => {
          btn.addEventListener("click", () =>
            handleColorClick(btn.dataset.color)
          );
        });
      }

      function showSequence() {
        if (gameState.isShowing) return;

        gameState.isShowing = true;
        document.getElementById("start-sequence-btn").disabled = true;

        let index = 0;
        const interval = setInterval(() => {
          if (index >= gameState.sequence.length) {
            clearInterval(interval);
            gameState.isShowing = false;
            document.getElementById("start-sequence-btn").disabled = false;
            gameState.playerSequence = [];
            return;
          }

          const color = gameState.sequence[index];
          const btn = document.querySelector(`[data-color="${color}"]`);

          btn.style.opacity = "0.3";
          setTimeout(() => {
            btn.style.opacity = "1";
          }, Math.max(100, 500 - (gameState.level - 1) * 40)); // 레벨이 올라갈수록 빨라짐

          index++;
        }, Math.max(200, 600 - (gameState.level - 1) * 50)); // 레벨이 올라갈수록 빨라짐
      }

      function handleColorClick(color) {
        if (gameState.isShowing) return;

        gameState.playerSequence.push(color);
        const result = document.getElementById("sequence-result");

        if (
          gameState.playerSequence[gameState.playerSequence.length - 1] !==
          gameState.sequence[gameState.playerSequence.length - 1]
        ) {
          result.innerHTML = `
            <div class="text-red-600">
              <p class="text-xl font-bold">😢 틀렸습니다!</p>
              <p>레벨 ${gameState.level}에서 실패했습니다.</p>
            </div>
          `;
          return;
        }

        if (gameState.playerSequence.length === gameState.sequence.length) {
          // 최대 레벨 달성 체크
          if (gameState.level >= gameState.maxLevel) {
            result.innerHTML = `
              <div class="text-yellow-600">
                <p class="text-xl font-bold">🏆 최대 레벨 달성!</p>
                <p>레벨 ${gameState.level} 클리어! 모든 레벨을 완주했습니다!</p>
              </div>
            `;

            // 최대 레벨 달성 점수 저장
            saveGameScore("color-memory", gameState.level, {
              level: gameState.level,
              completed: true,
              sequence: gameState.sequence,
            });
            return;
          }

          gameState.level++;
          generateSequence();
          result.innerHTML = `
            <div class="text-green-600">
              <p class="text-xl font-bold">🎉 레벨 ${
                gameState.level - 1
              } 클리어!</p>
              <p>다음 레벨로 진행합니다. (${gameState.level}/${
            gameState.maxLevel
          })</p>
            </div>
          `;

          // 점수 저장 (레벨 클리어 시마다)
          saveGameScore("color-memory", gameState.level - 1, {
            level: gameState.level - 1,
            sequence: gameState.sequence.slice(0, -1), // 마지막에 추가된 것 제외
          });

          setTimeout(() => {
            updateColorMemoryUI();
          }, 1500);
        }
      }

      // 자동차 레이싱 게임
      function startCarRacingGame() {
        currentGame = "car-racing";
        gameState = {
          distance: 0,
          speed: 2,
          carPosition: 1, // 0: 왼쪽, 1: 중앙, 2: 오른쪽
          obstacles: [],
          gameRunning: false,
          score: 0,
          lastObstacleTime: 0,
        };

        showGameScreen();
        updateCarRacingUI();

        // 키보드와 터치 이벤트 리스너 추가
        document.addEventListener("keydown", handleCarRacingKey);
        document.addEventListener("touchstart", handleCarRacingTouch);
      }

      function updateCarRacingUI() {
        const content = document.getElementById("game-content");
        const { distance, speed, carPosition, gameRunning } = gameState;

        content.innerHTML = `
          <div class="mb-4">
            <h4 class="text-lg font-bold text-red-700 mb-2">🏎️ 자동차 레이싱</h4>
            <p class="text-sm text-gray-600">터치하거나 좌우 화살표로 장애물을 피하세요!</p>
            <div class="flex justify-between text-sm text-gray-600 mt-2">
              <span>거리: ${Math.floor(distance)}m</span>
              <span>속도: ${speed.toFixed(1)}x</span>
            </div>
          </div>
          
          <div class="relative bg-gray-800 h-80 md:h-96 rounded-lg overflow-hidden border-2 border-gray-600">
            <!-- 도로 배경 -->
            <div class="absolute inset-0 bg-gradient-to-b from-gray-700 to-gray-900"></div>
            
            <!-- 도로 구분선 -->
            <div class="absolute left-1/3 w-1 h-full bg-yellow-400 opacity-50"></div>
            <div class="absolute right-1/3 w-1 h-full bg-yellow-400 opacity-50"></div>
            
            <!-- 자동차 (실제 자동차 모양) -->
            <div id="car" class="absolute bottom-4 w-10 h-16 transition-all duration-100" 
                 style="left: ${
                   carPosition === 0 ? "25%" : carPosition === 1 ? "50%" : "75%"
                 }; transform: translateX(-50%);">
              <div class="relative w-full h-full">
                <!-- 자동차 본체 -->
                <div class="absolute bottom-0 w-full h-10 bg-gradient-to-t from-red-600 to-red-500 rounded-lg shadow-lg"></div>
                <!-- 자동차 지붕 -->
                <div class="absolute top-2 left-1 right-1 h-6 bg-gradient-to-t from-red-400 to-red-300 rounded-md"></div>
                <!-- 앞유리 -->
                <div class="absolute top-3 left-2 right-2 h-3 bg-blue-200 opacity-60 rounded-sm"></div>
                <!-- 헤드라이트 -->
                <div class="absolute bottom-8 left-1 w-2 h-2 bg-yellow-300 rounded-full"></div>
                <div class="absolute bottom-8 right-1 w-2 h-2 bg-yellow-300 rounded-full"></div>
                <!-- 바퀴 -->
                <div class="absolute bottom-1 left-1 w-2 h-2 bg-gray-800 rounded-full"></div>
                <div class="absolute bottom-1 right-1 w-2 h-2 bg-gray-800 rounded-full"></div>
                <div class="absolute top-6 left-1 w-2 h-2 bg-gray-800 rounded-full"></div>
                <div class="absolute top-6 right-1 w-2 h-2 bg-gray-800 rounded-full"></div>
              </div>
            </div>
            
            <!-- 장애물들 -->
            <div id="obstacles-container"></div>
            
            ${
              !gameRunning
                ? `
              <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
                <div class="text-center text-white">
                  <div class="text-2xl mb-2">🏎️</div>
                  <p class="text-lg font-bold mb-2">준비되면 시작 버튼을 누르세요!</p>
                  <p class="text-sm opacity-75">터치하거나 좌우 화살표로 조작</p>
                </div>
              </div>
            `
                : ""
            }
          </div>
          
          <!-- 터치 컨트롤 -->
          <div class="mt-4 flex justify-center gap-4">
            <button id="left-btn" class="w-16 h-16 bg-blue-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-blue-600 active:bg-blue-700 transition-colors touch-manipulation">
              ←
            </button>
            <button id="start-race-btn" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 active:bg-green-700 transition-colors touch-manipulation">
              ${gameRunning ? "게임 중..." : "시작!"}
            </button>
            <button id="right-btn" class="w-16 h-16 bg-blue-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-blue-600 active:bg-blue-700 transition-colors touch-manipulation">
              →
            </button>
          </div>
        `;

        // 이벤트 리스너 추가
        document
          .getElementById("start-race-btn")
          ?.addEventListener("click", startCarRace);

        // 터치 컨트롤 버튼 이벤트 리스너
        document
          .getElementById("left-btn")
          ?.addEventListener("click", () => moveCarLeft());

        document
          .getElementById("right-btn")
          ?.addEventListener("click", () => moveCarRight());

        updateObstaclesDisplay();
      }

      function startCarRace() {
        if (gameState.gameRunning) return;

        gameState.gameRunning = true;
        gameState.distance = 0;
        gameState.speed = 3; // 초기 속도를 빠르게 설정
        gameState.obstacles = [];
        gameState.lastObstacleTime = Date.now();

        updateCarRacingUI();
        gameState.gameLoop = setInterval(gameLoop, 50); // 50ms마다 업데이트 (빠른 게임)
      }

      function gameLoop() {
        if (!gameState.gameRunning) return;

        // 거리 증가 (속도에 비례)
        gameState.distance += gameState.speed * 0.5;

        // 속도 증가 (거리에 따라 점점 빨라짐)
        gameState.speed = Math.min(3 + (gameState.distance / 100) * 0.5, 8);

        // 장애물 생성 (거리에 따라 빨라짐)
        const now = Date.now();
        const obstacleInterval = Math.max(
          300,
          1200 - (gameState.distance / 50) * 100
        ); // 최소 0.3초, 최대 1.2초
        if (now - gameState.lastObstacleTime > obstacleInterval) {
          createObstacle();
          gameState.lastObstacleTime = now;
        }

        // 장애물 이동
        moveObstacles();

        // 충돌 검사
        if (checkCollision()) {
          endCarRace();
          return;
        }

        // UI 업데이트
        updateCarRacingUI();
      }

      function createObstacle() {
        const positions = [0, 1, 2];
        const randomPos =
          positions[Math.floor(Math.random() * positions.length)];

        gameState.obstacles.push({
          x: randomPos,
          y: -30,
          width: 30,
          height: 30,
        });
      }

      function moveObstacles() {
        gameState.obstacles = gameState.obstacles.filter((obstacle) => {
          obstacle.y += gameState.speed * 2.5; // 더 빠른 이동
          return obstacle.y < 350; // 화면 밖으로 나가면 제거
        });
      }

      function checkCollision() {
        const carX = gameState.carPosition;
        const carY = 200; // 자동차 y 위치
        const carWidth = 60; // 자동차 폭
        const carHeight = 48; // 자동차 높이

        return gameState.obstacles.some((obstacle) => {
          // 더 정교한 충돌 감지 (중심점 기준)
          const carCenterX = carX * 100 + 50; // 차선 중앙
          const obstacleCenterX = obstacle.x * 100 + 50;

          return (
            Math.abs(carCenterX - obstacleCenterX) <
              (carWidth + obstacle.width) / 2 &&
            obstacle.y + obstacle.height >= carY &&
            obstacle.y <= carY + carHeight
          );
        });
      }

      function endCarRace() {
        gameState.gameRunning = false;
        clearInterval(gameState.gameLoop);

        // 키보드와 터치 이벤트 리스너 제거
        document.removeEventListener("keydown", handleCarRacingKey);
        document.removeEventListener("touchstart", handleCarRacingTouch);

        // 점수 저장
        saveGameScore("car-racing", gameState.distance, {
          distance: Math.floor(gameState.distance),
          maxSpeed: gameState.speed.toFixed(1),
        });

        // 결과 화면 표시
        const content = document.getElementById("game-content");
        content.innerHTML = `
          <div class="text-center py-8">
            <div class="text-6xl mb-4">💥</div>
            <h4 class="text-xl font-bold text-red-700 mb-2">게임 종료!</h4>
            <p class="text-lg text-gray-700 mb-2">최종 거리: <span class="font-bold text-blue-600">${Math.floor(
              gameState.distance
            )}m</span></p>
            <p class="text-sm text-gray-600 mb-4">최고 속도: ${gameState.speed.toFixed(
              1
            )}x</p>
            <button id="restart-car-race" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
              다시 플레이
            </button>
          </div>
        `;

        document
          .getElementById("restart-car-race")
          ?.addEventListener("click", () => {
            startCarRacingGame();
          });
      }

      function updateObstaclesDisplay() {
        const container = document.getElementById("obstacles-container");
        if (!container) return;

        container.innerHTML = gameState.obstacles
          .map(
            (obstacle, index) => `
          <div class="absolute w-8 h-8 bg-orange-600 rounded" 
               style="left: ${
                 obstacle.x === 0 ? "25%" : obstacle.x === 1 ? "50%" : "75%"
               }; 
                      top: ${obstacle.y}px; 
                      transform: translateX(-50%);">
            <div class="w-full h-full bg-orange-700 rounded flex items-center justify-center text-white text-xs">🚧</div>
          </div>
        `
          )
          .join("");
      }

      function handleCarRacingKey(e) {
        if (!gameState.gameRunning) return;

        if (e.key === "ArrowLeft" && gameState.carPosition > 0) {
          gameState.carPosition--;
        } else if (e.key === "ArrowRight" && gameState.carPosition < 2) {
          gameState.carPosition++;
        }
      }

      // 터치 이벤트 핸들러
      function handleCarRacingTouch(e) {
        if (!gameState.gameRunning) return;

        e.preventDefault();

        const touch = e.touches[0];
        const gameArea = document.querySelector(".relative.bg-gray-800");
        if (!gameArea) return;

        const rect = gameArea.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;
        const gameWidth = rect.width;

        // 화면을 3등분하여 터치 위치에 따라 자동차 이동
        if (touchX < gameWidth / 3 && gameState.carPosition > 0) {
          gameState.carPosition--;
        } else if (touchX > (gameWidth * 2) / 3 && gameState.carPosition < 2) {
          gameState.carPosition++;
        }
      }

      // 자동차 이동 함수들
      function moveCarLeft() {
        if (!gameState.gameRunning) return;
        if (gameState.carPosition > 0) {
          gameState.carPosition--;
        }
      }

      function moveCarRight() {
        if (!gameState.gameRunning) return;
        if (gameState.carPosition < 2) {
          gameState.carPosition++;
        }
      }

      // 공 튀기기 게임
      function startBallBounceGame() {
        currentGame = "ball-bounce";
        gameState = {
          score: 0,
          ballX: 200,
          ballY: 100,
          ballVx: 3,
          ballVy: -4,
          paddleX: 160,
          paddleWidth: 80,
          gameRunning: false,
          lives: 3,
          level: 1,
          ballSize: 20,
          paddleSpeed: 8,
          touchStartX: null,
          paddleStartX: null,
        };

        showGameScreen();
        updateBallBounceUI();

        // 키보드와 터치 이벤트 리스너 추가
        document.addEventListener("keydown", handleBallBounceKey);
        document.addEventListener("mousemove", handleBallBounceMouse);
        document.addEventListener("touchstart", handleBallBounceTouchStart);
        document.addEventListener("touchmove", handleBallBounceTouchMove);
      }

      function updateBallBounceUI() {
        const content = document.getElementById("game-content");
        const {
          score,
          lives,
          level,
          ballX,
          ballY,
          paddleX,
          paddleWidth,
          gameRunning,
        } = gameState;

        content.innerHTML = `
          <div class="mb-4">
            <h4 class="text-lg font-bold text-purple-700 mb-2">⚽ 공 튀기기</h4>
            <p class="text-sm text-gray-600">공이 바닥에 떨어지지 않도록 패들을 움직이세요!</p>
            <div class="flex justify-between text-sm text-gray-600 mt-2">
              <span>점수: ${score}</span>
              <span>생명: ${lives}</span>
              <span>레벨: ${level}</span>
            </div>
          </div>
          
          <div class="relative bg-gradient-to-b from-blue-400 to-blue-600 rounded-lg overflow-hidden border-2 border-gray-600 mx-auto" style="width: 500px; max-width: 100%; height: 400px;">
            <!-- 공 -->
            <div id="ball" class="absolute w-5 h-5 bg-yellow-400 rounded-full shadow-lg transition-all duration-75" 
                 style="left: ${ballX}px; top: ${ballY}px;">
              <div class="w-full h-full bg-gradient-to-br from-yellow-300 to-yellow-500 rounded-full"></div>
            </div>
            
            <!-- 패들 -->
            <div id="paddle" class="absolute bottom-4 bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-lg transition-all duration-75" 
                 style="left: ${paddleX}px; width: ${paddleWidth}px; height: 12px;"></div>
            
            ${
              !gameRunning
                ? `
              <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
                <div class="text-center text-white">
                  <div class="text-2xl mb-2">⚽</div>
                  <p class="text-lg font-bold mb-2">준비되면 시작 버튼을 누르세요!</p>
                  <p class="text-sm opacity-75">마우스나 터치로 패들 조작</p>
                </div>
              </div>
            `
                : ""
            }
          </div>
          
          <div class="mt-4 text-center">
            <button id="start-ball-btn" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
              ${gameRunning ? "게임 중..." : "시작!"}
          </button>
          </div>
        `;

        // 이벤트 리스너 추가
        document
          .getElementById("start-ball-btn")
          ?.addEventListener("click", startBallGame);
      }

      function startBallGame() {
        if (gameState.gameRunning) return;

        gameState.gameRunning = true;
        gameState.ballX = 250;
        gameState.ballY = 150;
        gameState.ballVx = 3;
        gameState.ballVy = -4;

        updateBallBounceUI();
        gameState.gameLoop = setInterval(ballGameLoop, 16); // 60fps
      }

      function ballGameLoop() {
        if (!gameState.gameRunning) return;

        // 공 위치 업데이트
        gameState.ballX += gameState.ballVx;
        gameState.ballY += gameState.ballVy;

        // 벽 충돌 검사 (공의 크기 고려) - 오른쪽 벽 버그 수정
        const ballSize = gameState.ballSize;
        if (gameState.ballX <= ballSize / 2) {
          gameState.ballX = ballSize / 2;
          gameState.ballVx = Math.abs(gameState.ballVx); // 항상 양수로
        } else if (gameState.ballX >= 500 - ballSize / 2) {
          gameState.ballX = 500 - ballSize / 2;
          gameState.ballVx = -Math.abs(gameState.ballVx); // 항상 음수로
        }
        if (gameState.ballY <= ballSize / 2) {
          gameState.ballY = ballSize / 2;
          gameState.ballVy = -gameState.ballVy;
        }

        // 바닥 충돌 검사 (패들 충돌 후에만)
        if (gameState.ballY >= 400 - ballSize / 2 && gameState.ballVy > 0) {
          gameState.lives--;
          if (gameState.lives <= 0) {
            endBallGame();
            return;
          }

          // 공 리셋
          gameState.ballX = 250;
          gameState.ballY = 150;
          gameState.ballVx = 3;
          gameState.ballVy = -4;
        }

        // 패들 충돌 검사 (더 정확한 충돌 감지) - 바 충돌 버그 수정
        if (
          gameState.ballY + ballSize / 2 >= 380 &&
          gameState.ballY - ballSize / 2 <= 380 + 20 && // 패들 높이 20px
          gameState.ballX + ballSize / 2 >= gameState.paddleX &&
          gameState.ballX - ballSize / 2 <=
            gameState.paddleX + gameState.paddleWidth &&
          gameState.ballVy > 0 // 공이 아래로 떨어지고 있을 때만
        ) {
          gameState.ballY = 380 - ballSize / 2; // 공을 패들 위에 정확히 위치
          gameState.ballVy = -Math.abs(gameState.ballVy); // 즉시 위로 반사
          gameState.score += 10;

          // 속도 증가
          gameState.ballVx *= 1.02;
          gameState.ballVy *= 1.02;

          // 레벨 업
          if (gameState.score % 100 === 0) {
            gameState.level++;
            gameState.paddleWidth = Math.max(50, gameState.paddleWidth - 5);
          }
        }

        updateBallBounceUI();
      }

      function endBallGame() {
        gameState.gameRunning = false;
        clearInterval(gameState.gameLoop);

        // 이벤트 리스너 제거
        document.removeEventListener("keydown", handleBallBounceKey);
        document.removeEventListener("mousemove", handleBallBounceMouse);
        document.removeEventListener("touchstart", handleBallBounceTouchStart);
        document.removeEventListener("touchmove", handleBallBounceTouchMove);

        // 점수 저장
        saveGameScore("ball-bounce", gameState.score, {
          score: gameState.score,
          level: gameState.level,
          lives: gameState.lives,
        });

        // 결과 화면 표시
        const content = document.getElementById("game-content");
        content.innerHTML = `
          <div class="text-center py-8">
            <div class="text-6xl mb-4">🏆</div>
            <h4 class="text-xl font-bold text-purple-700 mb-2">게임 종료!</h4>
            <p class="text-lg text-gray-700 mb-2">최종 점수: <span class="font-bold text-purple-600">${gameState.score}점</span></p>
            <p class="text-sm text-gray-600 mb-4">도달 레벨: ${gameState.level}</p>
            <button id="restart-ball-game" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
              다시 플레이
            </button>
            </div>
          `;

        document
          .getElementById("restart-ball-game")
          ?.addEventListener("click", () => {
            startBallBounceGame();
          });
      }

      function handleBallBounceKey(e) {
        if (!gameState.gameRunning) return;

        if (e.key === "ArrowLeft" && gameState.paddleX > 0) {
          gameState.paddleX -= gameState.paddleSpeed;
        } else if (e.key === "ArrowRight" && gameState.paddleX < 300) {
          gameState.paddleX += gameState.paddleSpeed;
        }
      }

      function handleBallBounceMouse(e) {
        if (!gameState.gameRunning) return;

        const gameArea = document.querySelector(".relative.bg-gradient-to-b");
        if (!gameArea) return;

        const rect = gameArea.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        gameState.paddleX = Math.max(
          0,
          Math.min(300, mouseX - gameState.paddleWidth / 2)
        );
      }

      // 터치 시작 시 초기 위치 저장
      function handleBallBounceTouchStart(e) {
        if (!gameState.gameRunning) return;

        e.preventDefault();
        const touch = e.touches[0];
        const gameArea = document.querySelector(".relative.bg-gradient-to-b");
        if (!gameArea) return;

        const rect = gameArea.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;

        // 터치 시작 시 초기 위치와 패들 위치 저장
        gameState.touchStartX = touchX;
        gameState.paddleStartX = gameState.paddleX;
      }

      // 터치 이동 시 슬라이드로 패들 이동 (개선된 방식)
      function handleBallBounceTouchMove(e) {
        if (!gameState.gameRunning) return;

        e.preventDefault();
        const touch = e.touches[0];
        const gameArea = document.querySelector(".relative.bg-gradient-to-b");
        if (!gameArea) return;

        const rect = gameArea.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;
        const gameWidth = rect.width;

        // 터치 위치를 게임 화면 비율로 변환
        const touchRatio = touchX / gameWidth;
        const newPaddleX = touchRatio * (400 - gameState.paddleWidth);

        // 경계 내에서만 이동
        gameState.paddleX = Math.max(
          0,
          Math.min(400 - gameState.paddleWidth, newPaddleX)
        );
      }

      // 게임 점수 데이터 로드
      function loadGameScores() {
        if (!currentUser) return;

        const unsubscribe = onSnapshot(
          collection(db, "gameScores"),
          (snapshot) => {
            gameScores = {};
            snapshot.forEach((doc) => {
              const data = doc.data();
              if (!gameScores[data.gameType]) {
                gameScores[data.gameType] = [];
              }
              gameScores[data.gameType].push({
                id: doc.id,
                ...data,
              });
            });
            console.log("게임 점수 로드됨:", gameScores);
          },
          (error) => {
            console.error("게임 점수 로드 오류:", error);
          }
        );

        return unsubscribe;
      }

      // 게임 버튼 이벤트 리스너
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("number-guess-btn")
          ?.addEventListener("click", startNumberGuessGame);
        document
          .getElementById("color-memory-btn")
          ?.addEventListener("click", startColorMemoryGame);
        document
          .getElementById("car-racing-btn")
          ?.addEventListener("click", startCarRacingGame);

        document
          .getElementById("ball-bounce-btn")
          ?.addEventListener("click", startBallBounceGame);

        document
          .getElementById("game-back-btn")
          ?.addEventListener("click", showGameSelection);
        document
          .getElementById("game-restart-btn")
          ?.addEventListener("click", () => {
            if (currentGame === "number-guess") startNumberGuessGame();
            else if (currentGame === "color-memory") startColorMemoryGame();
            else if (currentGame === "car-racing") startCarRacingGame();
            else if (currentGame === "ball-bounce") startBallBounceGame();
          });

        // 탭 버튼 이벤트 리스너
        document
          .getElementById("games-tab-btn")
          ?.addEventListener("click", () => {
            document.getElementById("games-tab-btn").className =
              "flex-1 py-2 px-4 text-center font-medium text-purple-600 border-b-2 border-purple-600";
            document.getElementById("ranking-tab-btn").className =
              "flex-1 py-2 px-4 text-center font-medium text-gray-500 hover:text-gray-700";
            showGameSelectionFromRanking();
          });

        document
          .getElementById("ranking-tab-btn")
          ?.addEventListener("click", () => {
            document.getElementById("ranking-tab-btn").className =
              "flex-1 py-2 px-4 text-center font-medium text-purple-600 border-b-2 border-purple-600";
            document.getElementById("games-tab-btn").className =
              "flex-1 py-2 px-4 text-center font-medium text-gray-500 hover:text-gray-700";
            showRankingScreen();
          });
      });

      /* ===== 문의하기 탭 (DEPRECATED - 새 시스템으로 대체됨) ===== */
      /* ===== 문의 모달 (DEPRECATED) ===== */
      function openInquiryModal_DEPRECATED() {
        const modal = document.getElementById("inquiry-modal");
        modal.classList.remove("hidden");
        renderInquiryList();
        setupInquirySubmit();
      }

      function renderInquiryList() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        const listContainer = document.getElementById("modal-suggestions-list");

        const list = (suggestionsData || [])
          .map(
            (s) => `
          <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow">
            <div class="text-sm text-gray-500 flex items-center justify-between mb-2">
              <span class="font-medium">
                <i class="fas fa-user-circle mr-1 text-orange-500"></i>
                ${saf(s.name || "익명")} · ${
              s.timestamp?.toDate
                ? new Date(s.timestamp.toDate()).toLocaleString("ko-KR")
                : "-"
            }
              </span>
              ${
                isAdmin
                  ? `<button class="text-red-600 text-xs hover:text-red-800 transition-colors" data-act="del-sug" data-id="${s.id}">
                      <i class="fas fa-trash"></i> 삭제
                    </button>`
                  : ""
              }
            </div>
            ${
              s.title
                ? `<div class="font-bold text-gray-800 mb-2 text-base">${saf(
                    s.title
                  )}</div>`
                : ""
            }
            <div class="text-gray-700 whitespace-pre-wrap">${saf(
              s.text || ""
            )}</div>
          </div>
        `
          )
          .join("");

        listContainer.innerHTML =
          list ||
          `<div class="text-center py-8 text-gray-400">
          <i class="fas fa-inbox text-3xl mb-2"></i>
          <p>아직 문의가 없습니다.</p>
        </div>`;

        // 삭제 버튼 이벤트
        listContainer.onclick = async (e) => {
          const b = e.target.closest("button[data-act='del-sug']");
          if (b) {
            if (!confirm("이 문의를 삭제하시겠습니까?")) return;
            try {
              await deleteDoc(doc(db, "suggestions", b.dataset.id));
              showAlert("🗑️", "삭제되었습니다.");
              renderInquiryList(); // 목록 다시 렌더링
            } catch (err) {
              console.warn(err);
              showAlert("😥", "삭제 실패");
            }
          }
        };
      }

      function setupInquirySubmit() {
        const submitBtn = document.getElementById("modal-sug-submit");
        const titleInput = document.getElementById("modal-sug-title");
        const textInput = document.getElementById("modal-sug-text");

        // 이전 이벤트 리스너 제거를 위해 복제
        const newSubmitBtn = submitBtn.cloneNode(true);
        submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);

        newSubmitBtn.onclick = async () => {
          const title = titleInput.value.trim();
          const text = textInput.value.trim();

          if (!text) return showAlert("😥", "내용을 입력해주세요.");

          try {
            await addDoc(collection(db, "suggestions"), {
              studentId: currentUser?.studentId || "",
              name: currentUser?.name || "익명",
              title,
              text,
              timestamp: serverTimestamp(),
            });

            titleInput.value = "";
            textInput.value = "";
            showAlert("✅", "문의가 접수되었습니다. 고마워요!");
            renderInquiryList(); // 목록 다시 렌더링
          } catch (e) {
            console.warn(e);
            showAlert("😥", "등록 실패");
          }
        };
      }

      function renderSuggestionsTab(isAdmin) {
        const c = document.getElementById("suggestions-tab");
        if (!c) return;

        // suggestions 탭은 이제 사용하지 않으므로 비워둠
        c.innerHTML = `
          <div class="section text-center py-12">
            <div class="mb-4">
              <i class="fas fa-question-circle text-6xl text-orange-500 mb-4"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">문의하기</h3>
            <p class="text-gray-600 mb-6">상단의 문의 버튼을 클릭하여 문의를 남겨주세요!</p>
            <button 
              onclick="openInquiryModal()" 
              class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
              <i class="fas fa-paper-plane mr-2"></i>문의하기
            </button>
          </div>
        `;
      }

      /* ===== 카테고리 관리 모달 ===== */
      function openCategoryManagementModal() {
        const modalHTML = `
          <div id="category-management-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
              <!-- 헤더 -->
              <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4 flex items-center justify-between">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                  <i class="fas fa-tags"></i>
                  카테고리 관리
                </h3>
                <button id="close-category-modal" class="text-white hover:bg-white/20 rounded-full p-2 transition-colors">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>

              <!-- 내용 -->
              <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <!-- 카테고리 추가 -->
                <div class="mb-6 bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4 border-2 border-orange-200">
                  <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-orange-600"></i>
                    새 카테고리 추가
                  </h4>
                  <div class="flex gap-2">
                    <input 
                      id="modal-category-name" 
                      type="text" 
                      placeholder="카테고리 이름 (예: 분식)"
                      class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all"
                    />
                    <input 
                      id="modal-category-emoji" 
                      type="text" 
                      placeholder="🍢"
                      class="w-20 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-center text-xl"
                      maxlength="2"
                    />
                    <button 
                      id="modal-add-category-btn"
                      class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg whitespace-nowrap">
                      <i class="fas fa-plus mr-1"></i>추가
                    </button>
                  </div>
                </div>

                <!-- 현재 카테고리 목록 -->
                <div>
                  <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-list text-gray-600"></i>
                    현재 카테고리 목록
                    <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs ml-2">
                      ${restaurantCategories.length}개
                    </span>
                  </h4>
                  <div id="modal-categories-list" class="space-y-2">
                    ${restaurantCategories
                      .map(
                        (cat, index) => `
                      <div class="category-item bg-white border-2 border-gray-200 rounded-lg p-4 flex items-center justify-between hover:border-orange-300 transition-all group" data-index="${index}">
                        <div class="flex items-center gap-3 flex-1">
                          <span class="text-3xl">${cat.emoji}</span>
                          <span class="font-semibold text-gray-800">${
                            cat.name
                          }</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <button 
                            class="move-category-up px-2 py-1 bg-gray-400 hover:bg-gray-500 text-white rounded text-sm font-semibold transition-colors ${
                              index === 0 ? "opacity-30 cursor-not-allowed" : ""
                            }"
                            data-index="${index}"
                            ${index === 0 ? "disabled" : ""}>
                            <i class="fas fa-chevron-up"></i>
                          </button>
                          <button 
                            class="move-category-down px-2 py-1 bg-gray-400 hover:bg-gray-500 text-white rounded text-sm font-semibold transition-colors ${
                              index === restaurantCategories.length - 1
                                ? "opacity-30 cursor-not-allowed"
                                : ""
                            }"
                            data-index="${index}"
                            ${
                              index === restaurantCategories.length - 1
                                ? "disabled"
                                : ""
                            }>
                            <i class="fas fa-chevron-down"></i>
                          </button>
                          <button 
                            class="modal-delete-category-btn px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm font-semibold transition-colors"
                            data-index="${index}"
                            data-name="${cat.name}">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>

                <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                  <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>안내:</strong> 카테고리를 삭제해도 기존 식당의 카테고리 정보는 유지됩니다.
                  </p>
                </div>
              </div>
            </div>
          </div>
        `;

        // 모달 추가
        document.body.insertAdjacentHTML("beforeend", modalHTML);

        const modal = document.getElementById("category-management-modal");
        const closeBtn = document.getElementById("close-category-modal");
        const addBtn = document.getElementById("modal-add-category-btn");
        const nameInput = document.getElementById("modal-category-name");
        const emojiInput = document.getElementById("modal-category-emoji");

        // 닫기 버튼
        closeBtn.addEventListener("click", () => {
          modal.remove();
        });

        // 모달 외부 클릭 시 닫기
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });

        // ESC 키로 닫기
        const escHandler = (e) => {
          if (e.key === "Escape") {
            modal.remove();
            document.removeEventListener("keydown", escHandler);
          }
        };
        document.addEventListener("keydown", escHandler);

        // 카테고리 추가
        addBtn.addEventListener("click", async () => {
          const name = nameInput.value.trim();
          const emoji = emojiInput.value.trim();

          if (!name) {
            showAlert("😥", "카테고리 이름을 입력해주세요.");
            return;
          }

          if (!emoji) {
            showAlert("😥", "이모지를 입력해주세요.");
            return;
          }

          if (restaurantCategories.some((cat) => cat.name === name)) {
            showAlert("😥", "이미 존재하는 카테고리입니다.");
            return;
          }

          try {
            const newCategories = [...restaurantCategories, { name, emoji }];
            await setDoc(doc(db, "settings", "restaurantCategories"), {
              categories: newCategories,
            });
            showAlert("✅", `${emoji} ${name} 카테고리가 추가되었습니다!`);
            modal.remove();
          } catch (error) {
            console.error("카테고리 추가 오류:", error);
            showAlert("😥", "카테고리 추가에 실패했습니다.");
          }
        });

        // 카테고리 삭제
        modal.addEventListener("click", async (e) => {
          const btn = e.target.closest(".modal-delete-category-btn");
          if (!btn) return;

          const index = parseInt(btn.dataset.index);
          const name = btn.dataset.name;

          if (
            !confirm(
              `"${name}" 카테고리를 삭제하시겠습니까?\n\n기존 식당의 카테고리 정보는 유지됩니다.`
            )
          ) {
            return;
          }

          try {
            const newCategories = restaurantCategories.filter(
              (_, i) => i !== index
            );

            if (newCategories.length === 0) {
              showAlert("😥", "최소 1개의 카테고리는 필요합니다.");
              return;
            }

            await setDoc(doc(db, "settings", "restaurantCategories"), {
              categories: newCategories,
            });
            showAlert("✅", `"${name}" 카테고리가 삭제되었습니다.`);
            modal.remove();
          } catch (error) {
            console.error("카테고리 삭제 오류:", error);
            showAlert("😥", "카테고리 삭제에 실패했습니다.");
          }
        });

        // 카테고리 순서 변경 버튼 이벤트
        modal.addEventListener("click", async (e) => {
          // 위로 이동
          const upBtn = e.target.closest(".move-category-up");
          if (upBtn && !upBtn.disabled) {
            const index = parseInt(upBtn.dataset.index);
            if (index > 0) {
              const newCategories = [...restaurantCategories];
              [newCategories[index - 1], newCategories[index]] = [
                newCategories[index],
                newCategories[index - 1],
              ];

              try {
                await setDoc(doc(db, "settings", "restaurantCategories"), {
                  categories: newCategories,
                });
                showAlert("✅", "카테고리 순서가 변경되었습니다.");
                modal.remove();
              } catch (error) {
                console.error("카테고리 순서 변경 오류:", error);
                showAlert("😥", "카테고리 순서 변경에 실패했습니다.");
              }
            }
          }

          // 아래로 이동
          const downBtn = e.target.closest(".move-category-down");
          if (downBtn && !downBtn.disabled) {
            const index = parseInt(downBtn.dataset.index);
            if (index < restaurantCategories.length - 1) {
              const newCategories = [...restaurantCategories];
              [newCategories[index], newCategories[index + 1]] = [
                newCategories[index + 1],
                newCategories[index],
              ];

              try {
                await setDoc(doc(db, "settings", "restaurantCategories"), {
                  categories: newCategories,
                });
                showAlert("✅", "카테고리 순서가 변경되었습니다.");
                modal.remove();
              } catch (error) {
                console.error("카테고리 순서 변경 오류:", error);
                showAlert("😥", "카테고리 순서 변경에 실패했습니다.");
              }
            }
          }
        });
      }

      /* ===== 로드맵 탭 ===== */
      function renderRoadmapTab(isAdmin) {
        const c = document.getElementById("roadmap-tab");
        if (!c) return;

        // 마감된 이벤트만 가져오기 (삭제된 이벤트 제외)
        const closedEvents = eventsData.filter(
          (ev) => ev.status === "closed" && ev.status !== "deleted"
        );

        // 카테고리별로 분류
        const mtEvents = closedEvents.filter((ev) => ev.type === "mt");
        const generalEvents = closedEvents.filter(
          (ev) => ev.type === "general" || ev.type === "assembly"
        );
        const tastingEvents = closedEvents.filter(
          (ev) => ev.type === "tasting"
        );

        // 미식회의 경우 식당 정보 추출
        const tastingRestaurants = [];
        tastingEvents.forEach((ev) => {
          if (ev.restaurants && ev.restaurants.length > 0) {
            ev.restaurants.forEach((restaurant) => {
              // 이 식당을 신청한 사람들의 studentId 목록
              const participantIds = (restaurant.reservations || []).map(
                (r) => r.studentId
              );

              // 이 식당을 신청한 사람들의 리뷰만 필터링
              const restaurantReviews = (ev.reviews || []).filter((review) =>
                participantIds.includes(review.studentId)
              );

              tastingRestaurants.push({
                eventId: ev.id,
                eventTitle: ev.title,
                eventDate: ev.datetime,
                restaurantName: restaurant.name,
                restaurantInfo: restaurant.info,
                restaurantImage: restaurant.imageUrl,
                restaurantCategory: restaurant.category || "기타",
                participantCount: participantIds.length,
                reviews: restaurantReviews,
              });
            });
          }
        });

        // 평균 별점 계산 함수
        const calculateAverageRating = (reviews) => {
          if (!reviews || reviews.length === 0) return 0;
          const sum = reviews.reduce((acc, r) => acc + (r.rating || 0), 0);
          return (sum / reviews.length).toFixed(1);
        };

        // 별 아이콘 생성 함수
        const renderStars = (rating) => {
          const fullStars = Math.floor(rating);
          const hasHalfStar = rating % 1 >= 0.5;
          let stars = "";
          for (let i = 0; i < fullStars; i++) {
            stars +=
              '<i class="fas fa-star text-yellow-400 text-base sm:text-lg"></i>';
          }
          if (hasHalfStar) {
            stars +=
              '<i class="fas fa-star-half-alt text-yellow-400 text-base sm:text-lg"></i>';
          }
          const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
          for (let i = 0; i < emptyStars; i++) {
            stars +=
              '<i class="far fa-star text-gray-300 text-base sm:text-lg"></i>';
          }
          return stars;
        };

        // 카테고리별 이모티콘 반환 함수 (동적으로 처리)
        const getCategoryEmoji = (category) => {
          const cat = restaurantCategories.find((c) => c.name === category);
          return cat ? cat.emoji : "🍽️";
        };

        // 식당 카드 생성 함수 (미식회용)
        const createRestaurantCard = (restaurant) => {
          const avgRating = calculateAverageRating(restaurant.reviews);
          const reviewCount = restaurant.reviews.length;
          const categoryEmoji = getCategoryEmoji(restaurant.restaurantCategory);

          return `
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 group" data-restaurant-id="${
              restaurant.eventId
            }">
              ${
                restaurant.restaurantImage
                  ? `
                <div class="w-full h-48 overflow-hidden relative">
                  <img 
                    src="${saf(restaurant.restaurantImage)}" 
                    alt="${saf(restaurant.restaurantName)}"
                    class="w-full h-full object-cover"
                    onerror="this.parentElement.style.display='none'"
                  >
                  ${
                    isAdmin
                      ? `
                    <button 
                      class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold shadow-lg transition-colors"
                      data-action="delete-restaurant"
                      data-event-id="${restaurant.eventId}"
                            data-restaurant-name="${saf(
                              restaurant.restaurantName
                            )}"
                      title="식당 삭제">
                      <i class="fas fa-trash mr-1"></i>식당 삭제
                    </button>
                  `
                      : ""
                  }
                </div>
              `
                  : ""
              }
              
              <div class="p-4 sm:p-6">
                <div class="mb-3 sm:mb-4">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                      <div class="mb-2">
                        <div class="flex items-center gap-2 mb-2">
                          <i class="fas fa-store text-orange-600 text-sm"></i>
                          <span class="text-xs sm:text-sm font-semibold text-orange-700 uppercase tracking-wide">식당 이름</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-2xl sm:text-3xl">${categoryEmoji}</span>
                          <h4 class="text-2xl sm:text-3xl font-extrabold text-gray-900 group-hover:text-orange-600 transition-colors bg-gradient-to-r from-orange-600 to-orange-700 bg-clip-text text-transparent">
                            ${saf(
                              restaurant.restaurantName || "(식당 이름 없음)"
                            )}
                          </h4>
                        </div>
                      </div>
                      ${
                        restaurant.restaurantCategory
                          ? `<span class="inline-block bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-semibold">${restaurant.restaurantCategory}</span>`
                          : ""
                      }
                    </div>
                    ${
                      isAdmin && !restaurant.restaurantImage
                        ? `
                      <button 
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold shadow transition-colors ml-2"
                        data-action="delete-restaurant"
                        data-event-id="${restaurant.eventId}"
                              data-restaurant-name="${saf(
                                restaurant.restaurantName
                              )}"
                        title="식당 삭제">
                        <i class="fas fa-trash mr-1"></i>삭제
                      </button>
                    `
                        : ""
                    }
                  </div>
                  ${
                    restaurant.restaurantInfo
                      ? `<div class="mb-4 mt-3 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl p-4 sm:p-5 border-2 border-orange-300 shadow-md">
                          <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                              <i class="fas fa-utensils text-orange-600 text-lg"></i>
                              <span class="text-base sm:text-lg font-bold text-orange-900">대표 메뉴</span>
                            </div>
                            ${
                              isAdmin
                                ? `<button 
                                    class="text-xs sm:text-sm text-orange-700 hover:text-orange-800 transition-colors bg-white px-2 py-1 rounded-lg border border-orange-300"
                                    onclick="openRestaurantEditModal('${
                                      restaurant.eventId
                                    }', '${saf(
                                    restaurant.restaurantName
                                  )}', '${saf(
                                    restaurant.restaurantInfo
                                  ).replace(/'/g, "\\'")}')"
                                    title="대표 메뉴 수정">
                                    <i class="fas fa-edit mr-1"></i>수정
                                  </button>`
                                : ""
                            }
                          </div>
                          <p class="text-xl sm:text-2xl text-gray-900 leading-relaxed font-bold">${saf(
                            restaurant.restaurantInfo
                          )}</p>
                        </div>`
                      : ""
                  }
                  
                  <!-- 카테고리 표시 -->
                  <div class="mt-2 flex items-center gap-2">
                    <span class="text-xs sm:text-sm text-gray-500 flex items-center">
                      <i class="fas fa-tags mr-1"></i>카테고리:
                    </span>
                    ${
                      isAdmin
                        ? `
                      <select 
                        class="text-xs px-2 py-1 border border-gray-300 rounded-lg focus:border-orange-400 focus:outline-none bg-white"
                        data-action="update-category"
                        data-event-id="${restaurant.eventId}"
                        data-restaurant-name="${saf(
                          restaurant.restaurantName
                        )}">
                        ${restaurantCategories
                          .map(
                            (cat) => `
                          <option value="${cat.name}" ${
                              restaurant.restaurantCategory === cat.name
                                ? "selected"
                                : ""
                            }>${cat.emoji} ${cat.name}</option>
                        `
                          )
                          .join("")}
                      </select>
                    `
                        : `
                      <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold">
                              ${getCategoryEmoji(
                                restaurant.restaurantCategory
                              )} ${restaurant.restaurantCategory || "기타"}
                      </span>
                    `
                    }
                  </div>
                </div>

                ${
                  reviewCount > 0
                    ? `
                  <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 sm:p-5 mb-4 border-2 border-orange-200 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-3">
                        <div class="flex items-center gap-1">
                          ${renderStars(parseFloat(avgRating))}
                        </div>
                        <span class="text-2xl sm:text-3xl font-bold text-gray-800">${avgRating}</span>
                      </div>
                      <span class="text-sm sm:text-base text-gray-700 font-semibold bg-white px-3 py-1.5 rounded-full shadow-sm">${reviewCount}명 평가</span>
                    </div>
                    
                    <!-- 미식회 정보를 리뷰 박스 안으로 이동 -->
                    <div class="mb-3 pb-3 border-b border-orange-200">
                      <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-xs sm:text-sm text-gray-600">
                        <div class="flex items-center gap-1">
                          <i class="fas fa-calendar text-orange-600"></i>
                          <span>${new Date(
                            restaurant.eventDate
                          ).toLocaleDateString("ko-KR", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                          })}</span>
                        </div>
                        <span class="hidden sm:inline">·</span>
                        <div class="flex items-center gap-1">
                          <i class="fas fa-utensils text-orange-600"></i>
                          <span class="font-semibold">${
                            restaurant.eventTitle
                          }</span>
                        </div>
                        <span class="hidden sm:inline">·</span>
                        <div class="flex items-center gap-1">
                          <i class="fas fa-users text-orange-600"></i>
                          <span>${restaurant.participantCount}명 참가</span>
                        </div>
                      </div>
                    </div>
                    
                    ${
                      restaurant.reviews.length > 0
                        ? `
                      <div class="mt-3 space-y-3">
                        <p class="text-base sm:text-lg font-bold text-gray-800 mb-3 flex items-center">
                          <i class="fas fa-comment-dots mr-2 text-orange-500"></i>후기
                        </p>
                        <div class="review-list" data-event-id="${
                          restaurant.eventId
                        }" data-restaurant-name="${saf(
                            restaurant.restaurantName
                          )}" data-show-all="false">
                          ${restaurant.reviews
                            .filter((r) => r.comment && r.comment.trim())
                            .slice(0, 1)
                            .map(
                              (r) => `
                            <div class="bg-white rounded-xl p-4 sm:p-5 border-2 border-orange-100 shadow-md hover:shadow-lg transition-shadow relative review-item mb-3">
                              <div class="flex items-center justify-between mb-3">
                                <span class="text-base sm:text-lg font-bold text-gray-800 flex items-center">
                                  <i class="fas fa-user-circle mr-2 text-orange-500 text-xl"></i>
                                  익명
                                </span>
                                <div class="flex items-center gap-2">
                                  <div class="flex items-center gap-1">
                                    ${renderStars(r.rating || 0)}
                                  </div>
                                  ${
                                    isAdmin
                                      ? `
                                    <button 
                                      class="text-red-500 hover:text-red-700 transition-colors p-1"
                                      data-action="delete-review"
                                      data-event-id="${restaurant.eventId}"
                                      data-student-id="${r.studentId}"
                                      title="후기 삭제">
                                      <i class="fas fa-trash text-sm"></i>
                                    </button>
                                  `
                                      : ""
                                  }
                                </div>
                              </div>
                              <p class="text-base sm:text-lg text-gray-700 leading-relaxed whitespace-pre-wrap">${saf(
                                r.comment
                              )}</p>
                            </div>
                          `
                            )
                            .join("")}
                        </div>
                        ${
                          restaurant.reviews.filter(
                            (r) => r.comment && r.comment.trim()
                          ).length > 1
                            ? `<button 
                                class="w-full text-base sm:text-lg text-orange-600 hover:text-orange-700 font-bold text-center mt-3 py-4 sm:py-3 bg-orange-50 hover:bg-orange-100 rounded-xl transition-colors border-2 border-orange-200 shadow-sm"
                                data-action="toggle-reviews"
                                data-event-id="${restaurant.eventId}"
                                data-restaurant-name="${saf(
                                  restaurant.restaurantName
                                )}">
                                <i class="fas fa-chevron-down mr-2"></i>
                                외 ${
                                  restaurant.reviews.filter(
                                    (r) => r.comment && r.comment.trim()
                                  ).length - 1
                                }개 후기 더 보기
                              </button>`
                            : ""
                        }
                      </div>
                    `
                        : ""
                    }
                  </div>
                `
                    : `
                  <div class="bg-gray-50 rounded-lg p-4 text-center">
                    <p class="text-sm text-gray-500">
                      <i class="fas fa-info-circle mr-1"></i>
                      아직 평가가 없습니다
                    </p>
                  </div>
                `
                }
              </div>
            </div>
          `;
        };

        // 이벤트 카드 생성 함수 (MT, 일반 이벤트용)
        const createEventCard = (ev) => {
          const avgRating = calculateAverageRating(ev.reviews || []);
          const reviewCount = ev.reviews ? ev.reviews.length : 0;

          return `
            <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-all">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeBadgeClass(
                      ev.type
                    )}">
                      ${typeLabel(ev.type)}
                    </span>
                  </div>
                  <h4 class="text-lg font-bold text-gray-800 mb-1">${saf(
                    ev.title || "(제목 없음)"
                  )}</h4>
                  <p class="text-sm text-gray-600">
                    <i class="fas fa-calendar mr-1"></i>
                    ${new Date(ev.datetime).toLocaleDateString("ko-KR", {
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    })}
                  </p>
                </div>
              </div>

              ${
                ev.type === "tasting" && reviewCount > 0
                  ? `
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-3 mb-3">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <div class="flex items-center gap-1">
                        ${renderStars(parseFloat(avgRating))}
                      </div>
                      <span class="text-lg font-bold text-gray-800">${avgRating}</span>
                      <span class="text-sm text-gray-600">(${reviewCount}명 평가)</span>
                    </div>
                  </div>
                  
                  ${
                    ev.reviews && ev.reviews.length > 0
                      ? `
                    <div class="mt-4 space-y-3">
                      <p class="text-base sm:text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-comment-dots mr-2 text-orange-500"></i>후기
                      </p>
                      ${ev.reviews
                        .filter((r) => r.comment && r.comment.trim())
                        .slice(0, 2)
                        .map(
                          (r) => `
                        <div class="bg-white rounded-xl p-4 sm:p-5 border-2 border-orange-100 shadow-md hover:shadow-lg transition-shadow mb-3">
                          <div class="flex items-center justify-between mb-3">
                            <span class="text-base sm:text-lg font-bold text-gray-800 flex items-center">
                              <i class="fas fa-user-circle mr-2 text-orange-500 text-xl"></i>
                              ${saf(r.name || "익명")}
                            </span>
                            <div class="flex items-center gap-1">
                              ${renderStars(r.rating || 0)}
                            </div>
                          </div>
                          <p class="text-base sm:text-lg text-gray-700 leading-relaxed whitespace-pre-wrap">${saf(
                            r.comment
                          )}</p>
                        </div>
                      `
                        )
                        .join("")}
                      ${
                        ev.reviews.filter((r) => r.comment && r.comment.trim())
                          .length > 2
                          ? `<button class="w-full text-base sm:text-lg text-orange-600 hover:text-orange-700 font-bold text-center mt-3 py-4 sm:py-3 bg-orange-50 hover:bg-orange-100 rounded-xl transition-colors border-2 border-orange-200 shadow-sm">
                              <i class="fas fa-chevron-down mr-2"></i>
                              외 ${
                                ev.reviews.filter(
                                  (r) => r.comment && r.comment.trim()
                                ).length - 2
                              }개 후기 더 보기
                            </button>`
                          : ""
                      }
                    </div>
                  `
                      : ""
                  }
                </div>
              `
                  : ""
              }

              ${
                ev.type !== "tasting" && reviewCount > 0
                  ? `
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                  <p class="text-sm text-gray-600">
                    <i class="fas fa-users mr-1"></i>
                    ${reviewCount}명이 평가했습니다
                  </p>
                </div>
              `
                  : ""
              }

              ${
                reviewCount === 0
                  ? `
                <div class="bg-gray-50 rounded-lg p-3">
                  <p class="text-sm text-gray-500 text-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    아직 평가가 없습니다
                  </p>
                </div>
              `
                  : ""
              }
            </div>
          `;
        };

        c.innerHTML = `
          <div class="section">
            <div class="mb-4">
              <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">
                <i class="fas fa-utensils mr-2 text-orange-600"></i>
                미식회 후기
              </h3>
              <p class="text-sm sm:text-base text-gray-600 mb-3">
                <i class="fas fa-heart mr-1 text-orange-500"></i>
                Foodie 회원들과 함께했던 미식회
              </p>
              <div class="text-sm sm:text-base text-gray-600 bg-orange-50 border border-orange-200 rounded-lg px-3 py-2 inline-block">
                총 <span class="font-bold text-orange-600">${
                  tastingRestaurants.length
                }</span>개 식당
              </div>
            </div>
            
            ${
              tastingRestaurants.length > 0
                ? `
            <!-- 카테고리 필터 (동적 생성) -->
            <div class="mb-4">
              <div class="flex flex-wrap items-center gap-2">
                <button 
                  class="category-filter-btn bg-orange-500 text-white rounded-full px-3 py-2 sm:py-1 hover:bg-orange-600 transition-colors font-medium text-sm"
                  data-category="all">
                  🏠 전체 (${tastingRestaurants.length})
                </button>
                ${restaurantCategories
                  .map(
                    (cat) => `
                  <button 
                    class="category-filter-btn bg-gray-200 text-gray-700 rounded-full px-3 py-2 sm:py-1 hover:bg-orange-500 hover:text-white transition-colors font-medium text-sm"
                    data-category="${cat.name}">
                    ${cat.emoji} ${cat.name} (${
                      tastingRestaurants.filter(
                        (r) => r.restaurantCategory === cat.name
                      ).length
                    })
                  </button>
                `
                  )
                  .join("")}
                ${
                  isAdmin
                    ? `
                <button 
                  id="manage-categories-btn"
                  class="bg-orange-100 text-orange-600 rounded-full px-3 py-1 hover:bg-orange-500 hover:text-white transition-colors font-medium text-sm flex items-center gap-1">
                  <i class="fas fa-plus"></i> 추가
                </button>
                `
                    : ""
                }
              </div>
            </div>
            
            <!-- 검색창 -->
            <div class="mb-4">
              <div class="relative">
                <input 
                  type="text" 
                  id="restaurant-search-input"
                  placeholder="무엇이든 입력해보세요! 식당 이름, 메뉴, 리뷰 내용 등..."
                  class="w-full px-4 py-3 sm:py-2 pl-12 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors text-gray-900 placeholder-gray-400 text-base"
                />
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <button 
                  id="clear-search-btn"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors hidden"
                  title="검색 초기화">
                  <i class="fas fa-times-circle"></i>
                </button>
              </div>
              <div id="search-result-count" class="mt-2 text-sm text-gray-600"></div>
            </div>
            `
                : ""
            }
            
            <!-- 미식회 식당 목록 -->
            <div id="restaurant-list-container">
              ${
                tastingRestaurants.length > 0
                  ? `<div class="grid grid-cols-1 gap-4 sm:gap-6" id="restaurant-cards">${tastingRestaurants
                      .map(createRestaurantCard)
                      .join("")}</div>`
                  : `<div class="text-center py-12 text-gray-400">
                      <i class="fas fa-utensils text-4xl mb-3"></i>
                      <p>아직 진행된 미식회가 없습니다</p>
                    </div>`
              }
            </div>
          </div>
        `;

        // 검색 및 필터 기능
        const searchInput = document.getElementById("restaurant-search-input");
        const clearSearchBtn = document.getElementById("clear-search-btn");
        const searchResultCount = document.getElementById(
          "search-result-count"
        );
        const restaurantCardsContainer =
          document.getElementById("restaurant-cards");
        const categoryFilterBtns = document.querySelectorAll(
          ".category-filter-btn"
        );

        let currentCategory = "all"; // 현재 선택된 카테고리

        if (searchInput && tastingRestaurants.length > 0) {
          // 검색 함수: 띄어쓰기 제거하고 소문자로 변환
          const normalizeSearchText = (text) => {
            return (text || "").toLowerCase().replace(/\s+/g, "");
          };

          const performSearch = () => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            const normalizedSearchTerm = normalizeSearchText(searchTerm);

            // 검색어가 있으면 초기화 버튼 표시
            if (searchTerm) {
              clearSearchBtn.classList.remove("hidden");
            } else {
              clearSearchBtn.classList.add("hidden");
            }

            // 카테고리 필터링
            let filtered = tastingRestaurants;
            if (currentCategory !== "all") {
              filtered = filtered.filter(
                (r) => r.restaurantCategory === currentCategory
              );
            }

            // 검색 필터링: 식당 이름, 대표 메뉴, 리뷰 내용 모두 검색
            const filteredRestaurants = searchTerm
              ? filtered.filter((r) => {
                  // 식당 이름 검색
                  const nameMatch = normalizedSearchTerm
                    ? normalizeSearchText(r.restaurantName).includes(
                        normalizedSearchTerm
                      )
                    : false;

                  // 대표 메뉴 검색
                  const menuMatch =
                    normalizedSearchTerm && r.restaurantInfo
                      ? normalizeSearchText(r.restaurantInfo).includes(
                          normalizedSearchTerm
                        )
                      : false;

                  // 리뷰 내용 검색
                  const reviewMatch =
                    normalizedSearchTerm && r.reviews && r.reviews.length > 0
                      ? r.reviews.some(
                          (review) =>
                            review.comment &&
                            normalizeSearchText(review.comment).includes(
                              normalizedSearchTerm
                            )
                        )
                      : false;

                  return nameMatch || menuMatch || reviewMatch;
                })
              : filtered;

            // 검색 결과 카운트 표시
            if (searchTerm) {
              searchResultCount.innerHTML = `
                <i class="fas fa-search mr-1"></i>
                검색 결과: <span class="font-bold text-orange-600">${
                  filteredRestaurants.length
                }</span>개 식당
                ${
                  filteredRestaurants.length === 0
                    ? '<span class="text-red-500 ml-2">(검색 결과가 없습니다)</span>'
                    : ""
                }
              `;
            } else {
              searchResultCount.innerHTML = "";
            }

            // 결과 렌더링
            if (filteredRestaurants.length > 0) {
              restaurantCardsContainer.innerHTML = filteredRestaurants
                .map(createRestaurantCard)
                .join("");
            } else if (searchTerm) {
              restaurantCardsContainer.innerHTML = `
                <div class="col-span-2 text-center py-12 text-gray-400">
                  <i class="fas fa-search text-4xl mb-3"></i>
                  <p class="text-lg font-semibold mb-2">"${saf(
                    searchTerm
                  )}" 검색 결과가 없습니다</p>
                  <p class="text-sm">다른 키워드로 검색해보세요 (식당 이름, 대표 메뉴, 리뷰 내용)</p>
                </div>
              `;
            } else if (currentCategory !== "all") {
              // 카테고리만 선택되고 검색어가 없을 때 빈 결과 표시
              const categoryName =
                currentCategory === "한식"
                  ? "🍚 한식"
                  : currentCategory === "일식"
                  ? "🍣 일식"
                  : currentCategory === "중식"
                  ? "🥟 중식"
                  : currentCategory === "양식"
                  ? "🍝 양식"
                  : currentCategory === "디저트"
                  ? "🍰 디저트"
                  : "🍽️ 기타";
              restaurantCardsContainer.innerHTML = `
                <div class="col-span-2 text-center py-12 text-gray-400">
                  <i class="fas fa-utensils text-4xl mb-3"></i>
                  <p class="text-lg font-semibold mb-2">${categoryName} 카테고리에 식당이 없습니다</p>
                  <p class="text-sm">다른 카테고리를 선택해보세요</p>
                </div>
              `;
            } else {
              // 기본 상태 (전체 표시)
              restaurantCardsContainer.innerHTML = filteredRestaurants
                .map(createRestaurantCard)
                .join("");
            }
          };

          // 실시간 검색
          searchInput.addEventListener("input", performSearch);

          // 검색 초기화 버튼
          clearSearchBtn.addEventListener("click", () => {
            searchInput.value = "";
            performSearch();
            searchInput.focus();
          });

          // Enter 키로 검색
          searchInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              performSearch();
            }
          });

          // 카테고리 관리 버튼 이벤트 (관리자 전용)
          const manageCategoriesBtn = document.getElementById(
            "manage-categories-btn"
          );
          if (manageCategoriesBtn) {
            manageCategoriesBtn.addEventListener("click", () => {
              openCategoryManagementModal();
            });
          }

          // 카테고리 필터 버튼 이벤트
          categoryFilterBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
              const category = btn.dataset.category;
              currentCategory = category;

              // 버튼 스타일 업데이트 (조모임 스타일)
              categoryFilterBtns.forEach((b) => {
                b.classList.remove("bg-orange-500", "text-white");
                b.classList.add("bg-gray-200", "text-gray-700");
              });

              btn.classList.remove("bg-gray-200", "text-gray-700");
              btn.classList.add("bg-orange-500", "text-white");

              // 검색 재실행
              performSearch();
            });
          });
        }

        // 관리자 전용: 삭제 버튼 이벤트 리스너
        if (isAdmin) {
          c.addEventListener("click", async (e) => {
            const deleteReviewBtn = e.target.closest(
              "[data-action='delete-review']"
            );
            const deleteRestaurantBtn = e.target.closest(
              "[data-action='delete-restaurant']"
            );

            // 후기 삭제
            if (deleteReviewBtn) {
              const eventId = deleteReviewBtn.dataset.eventId;
              const studentId = deleteReviewBtn.dataset.studentId;

              if (
                !confirm(
                  "이 후기를 삭제하시겠습니까?\n\n삭제된 후기는 복구할 수 없습니다."
                )
              )
                return;

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(db, async (transaction) => {
                  const eventDoc = await transaction.get(eventRef);
                  if (!eventDoc.exists())
                    throw new Error("이벤트를 찾을 수 없습니다.");

                  const eventData = eventDoc.data();
                  const reviews = eventData.reviews || [];

                  // 해당 studentId의 리뷰 제거
                  const updatedReviews = reviews.filter(
                    (r) => r.studentId !== studentId
                  );

                  transaction.update(eventRef, { reviews: updatedReviews });
                });

                showAlert("✅", "후기가 삭제되었습니다.");
                renderRoadmapTab(isAdmin); // 다시 렌더링
              } catch (error) {
                console.error("후기 삭제 오류:", error);
                showAlert("😥", "후기 삭제 중 오류가 발생했습니다.");
              }
            }

            // 식당 삭제
            if (deleteRestaurantBtn) {
              const eventId = deleteRestaurantBtn.dataset.eventId;
              const restaurantName = deleteRestaurantBtn.dataset.restaurantName;

              if (
                !confirm(
                  `"${restaurantName}" 식당을 삭제하시겠습니까?\n\n이 식당의 예약 정보와 관련 데이터가 모두 삭제됩니다.\n삭제된 데이터는 복구할 수 없습니다.`
                )
              )
                return;

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(db, async (transaction) => {
                  const eventDoc = await transaction.get(eventRef);
                  if (!eventDoc.exists())
                    throw new Error("이벤트를 찾을 수 없습니다.");

                  const eventData = eventDoc.data();
                  const restaurants = eventData.restaurants || [];

                  // 해당 식당 제거
                  const updatedRestaurants = restaurants.filter(
                    (r) => r.name !== restaurantName
                  );

                  transaction.update(eventRef, {
                    restaurants: updatedRestaurants,
                  });
                });

                showAlert("✅", "식당이 삭제되었습니다.");
                renderRoadmapTab(isAdmin); // 다시 렌더링
              } catch (error) {
                console.error("식당 삭제 오류:", error);
                showAlert("😥", "식당 삭제 중 오류가 발생했습니다.");
              }
            }
          });

          // 카테고리 드롭다운 change 이벤트
          c.addEventListener("change", async (e) => {
            const updateCategorySelect = e.target.closest(
              "[data-action='update-category']"
            );
            if (updateCategorySelect) {
              const eventId = updateCategorySelect.dataset.eventId;
              const restaurantName =
                updateCategorySelect.dataset.restaurantName;
              const newCategory = updateCategorySelect.value;

              if (
                !confirm(
                  `"${restaurantName}" 식당의 카테고리를 "${newCategory}"(으)로 변경하시겠습니까?`
                )
              ) {
                // 취소 시 원래 값으로 되돌림
                const event = eventsData.find((e) => e.id === eventId);
                if (event && event.restaurants) {
                  const restaurant = event.restaurants.find(
                    (r) => r.name === restaurantName
                  );
                  if (restaurant) {
                    updateCategorySelect.value = restaurant.category || "기타";
                  }
                }
                return;
              }

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(db, async (transaction) => {
                  const eventDoc = await transaction.get(eventRef);
                  if (!eventDoc.exists())
                    throw new Error("이벤트를 찾을 수 없습니다.");

                  const eventData = eventDoc.data();
                  const restaurants = eventData.restaurants || [];

                  // 해당 식당의 카테고리 업데이트
                  const updatedRestaurants = restaurants.map((r) => {
                    if (r.name === restaurantName) {
                      return { ...r, category: newCategory };
                    }
                    return r;
                  });

                  transaction.update(eventRef, {
                    restaurants: updatedRestaurants,
                  });
                });

                showAlert("✅", "카테고리가 변경되었습니다.");
                renderRoadmapTab(isAdmin); // 다시 렌더링
              } catch (error) {
                console.error("카테고리 변경 오류:", error);
                showAlert("😥", "카테고리 변경 중 오류가 발생했습니다.");
              }
            }
          });
        }

        // 후기 더보기/접기 버튼 이벤트
        c.addEventListener("click", (e) => {
          const toggleBtn = e.target.closest("[data-action='toggle-reviews']");
          if (toggleBtn) {
            const eventId = toggleBtn.dataset.eventId;
            const restaurantName = toggleBtn.dataset.restaurantName;

            // data 속성으로 직접 찾기
            const reviewList = c.querySelector(
              `.review-list[data-event-id="${eventId}"][data-restaurant-name="${restaurantName}"]`
            );

            if (!reviewList) return;

            const isShowingAll = reviewList.dataset.showAll === "true";

            // 해당 식당의 모든 후기 가져오기
            const restaurant = tastingRestaurants.find(
              (r) =>
                r.eventId === eventId && r.restaurantName === restaurantName
            );

            if (!restaurant) return;

            const allReviews = restaurant.reviews.filter(
              (r) => r.comment && r.comment.trim()
            );

            if (isShowingAll) {
              // 접기 - 1개만 보여주기
              reviewList.innerHTML = allReviews
                .slice(0, 1)
                .map(
                  (r) => `
                  <div class="bg-white rounded-xl p-4 sm:p-5 border-2 border-orange-100 shadow-md hover:shadow-lg transition-shadow relative review-item mb-3">
                    <div class="flex items-center justify-between mb-3">
                      <span class="text-base sm:text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-user-circle mr-2 text-orange-500 text-xl"></i>
                        익명
                      </span>
                      <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1">
                          ${renderStars(r.rating || 0)}
                        </div>
                        ${
                          isAdmin
                            ? `
                          <button 
                            class="text-red-500 hover:text-red-700 transition-colors p-1"
                            data-action="delete-review"
                            data-event-id="${restaurant.eventId}"
                            data-student-id="${r.studentId}"
                            title="후기 삭제">
                            <i class="fas fa-trash text-sm"></i>
                          </button>
                        `
                            : ""
                        }
                      </div>
                    </div>
                    <p class="text-base sm:text-lg text-gray-700 leading-relaxed whitespace-pre-wrap">${saf(
                      r.comment
                    )}</p>
                  </div>
                `
                )
                .join("");
              reviewList.dataset.showAll = "false";
              toggleBtn.innerHTML = `<i class="fas fa-chevron-down mr-2"></i>외 ${
                allReviews.length - 1
              }개 후기 더 보기`;
            } else {
              // 펼치기 - 모든 후기 보여주기
              reviewList.innerHTML = allReviews
                .map(
                  (r) => `
                  <div class="bg-white rounded-xl p-4 sm:p-5 border-2 border-orange-100 shadow-md hover:shadow-lg transition-shadow relative review-item mb-3">
                    <div class="flex items-center justify-between mb-3">
                      <span class="text-base sm:text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-user-circle mr-2 text-orange-500 text-xl"></i>
                        익명
                      </span>
                      <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1">
                          ${renderStars(r.rating || 0)}
                        </div>
                        ${
                          isAdmin
                            ? `
                          <button 
                            class="text-red-500 hover:text-red-700 transition-colors p-1"
                            data-action="delete-review"
                            data-event-id="${restaurant.eventId}"
                            data-student-id="${r.studentId}"
                            title="후기 삭제">
                            <i class="fas fa-trash text-sm"></i>
                          </button>
                        `
                            : ""
                        }
                      </div>
                    </div>
                    <p class="text-base sm:text-lg text-gray-700 leading-relaxed whitespace-pre-wrap">${saf(
                      r.comment
                    )}</p>
                  </div>
                `
                )
                .join("");
              reviewList.dataset.showAll = "true";
              toggleBtn.innerHTML = `<i class="fas fa-chevron-up mr-2"></i>후기 접기`;
            }
          }
        });
      }

      /* ===== 명예의 전당 관리자 ===== */
      function renderHOFAdmin(container) {
        const cards = (historyData || [])
          .map(
            (h) => `
          <div class="border rounded p-3 bg-white flex items-start gap-3">
            ${
              h.imageUrl
                ? `<img src="${saf(
                    h.imageUrl
                  )}" class="w-24 h-24 object-cover rounded" onerror="this.style.display='none'">`
                : ""
            }
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <div class="truncate font-semibold">${saf(
                  h.title || "(제목 없음)"
                )}</div>
                <div class="text-sm text-gray-500">${
                  h.date ? saf(h.date) : "-"
                }</div>
              </div>
              ${
                h.subtitle
                  ? `<div class="text-sm text-orange-700">${saf(
                      h.subtitle
                    )}</div>`
                  : ""
              }
              ${
                h.description
                  ? `<div class="text-sm text-gray-700 mt-1 line-clamp-2">${saf(
                      h.description
                    )}</div>`
                  : ""
              }
              <div class="mt-2 space-x-2">
                <button class="text-blue-600 text-sm" data-act="edit-hof" data-id="${
                  h.id
                }"><i class="fas fa-pen"></i> 수정</button>
                <button class="text-red-600 text-sm" data-act="del-hof" data-id="${
                  h.id
                }"><i class="fas fa-trash"></i> 삭제</button>
              </div>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = `
          <div class="grid grid-cols-1 gap-4">
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">명예의 전당 등록</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">제목</label>
                  <input id="hof-title" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="제목을 입력하세요">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                  <input id="hof-date" type="date" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">부제 (선택)</label>
                  <input id="hof-subtitle" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="부제를 입력하세요">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">이미지 URL (선택)</label>
                  <input id="hof-image" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="이미지 URL을 입력하세요">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                  <textarea id="hof-desc" rows="4" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="설명을 입력하세요"></textarea>
                </div>
              </div>
              <div class="mt-2 space-x-2">
                <button id="hof-add" class="px-4 py-2 bg-orange-500 text-white rounded">추가</button>
                <button id="hof-reset" class="px-3 py-2 bg-gray-200 rounded">리셋</button>
              </div>
            </div>

            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">등록된 항목</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${
                cards || `<div class="text-gray-400">항목 없음</div>`
              }</div>
            </div>
          </div>
        `;

        container.onclick = async (e) => {
          const b = e.target.closest("button[data-act]");
          if (!b) return;
          const id = b.dataset.id;
          if (b.dataset.act === "del-hof") {
            if (!confirm("삭제하시겠어요?")) return;
            try {
              await deleteDoc(doc(db, "history", id));
              showAlert("🗑️", "삭제되었습니다.");
            } catch (err) {
              console.warn(err);
              showAlert("😥", "삭제 실패");
            }
          }
          if (b.dataset.act === "edit-hof") {
            const item = historyData.find((x) => x.id === id) || {};
            el.blockEditorTitle.textContent = "명예의 전당 수정";
            el.blockEditorBody.innerHTML = `
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">제목</label>
                  <input id="eh-title" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="제목을 입력하세요" value="${saf(
                    item.title || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                  <input id="eh-date" type="date" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" value="${saf(
                    item.date || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">부제</label>
                  <input id="eh-subtitle" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="부제를 입력하세요" value="${saf(
                    item.subtitle || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">이미지 URL</label>
                  <input id="eh-image" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="이미지 URL을 입력하세요" value="${saf(
                    item.imageUrl || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">설명</label>
                  <textarea id="eh-desc" rows="4" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="설명을 입력하세요">${saf(
                    item.description || ""
                  )}</textarea>
                </div>
              </div>`;
            el.blockEditor.classList.remove("hidden");
            el.blockEditorSave.onclick = async () => {
              try {
                await updateDoc(doc(db, "history", id), {
                  title: document.getElementById("eh-title").value.trim(),
                  date: document.getElementById("eh-date").value,
                  subtitle: document.getElementById("eh-subtitle").value.trim(),
                  imageUrl: document.getElementById("eh-image").value.trim(),
                  description: document.getElementById("eh-desc").value.trim(),
                });
                el.blockEditor.classList.add("hidden");
                showAlert("✅", "수정되었습니다.");
              } catch (e) {
                console.warn(e);
                showAlert("😥", "수정 실패");
              }
            };
            el.blockEditorCancel.onclick = () =>
              el.blockEditor.classList.add("hidden");
          }
        };

        container.querySelector("#hof-add").onclick = async () => {
          const title = container.querySelector("#hof-title").value.trim();
          const date = container.querySelector("#hof-date").value;
          const subtitle = container
            .querySelector("#hof-subtitle")
            .value.trim();
          const imageUrl = container.querySelector("#hof-image").value.trim();
          const description = container.querySelector("#hof-desc").value.trim();
          if (!title || !date)
            return showAlert("😥", "제목과 날짜를 입력해주세요.");
          try {
            await addDoc(collection(db, "history"), {
              title,
              date,
              subtitle,
              imageUrl,
              description,
              createdAt: serverTimestamp(),
            });
            [
              "hof-title",
              "hof-date",
              "hof-subtitle",
              "hof-image",
              "hof-desc",
            ].forEach((id) => (container.querySelector("#" + id).value = ""));
            showAlert("🎉", "등록되었습니다.");
          } catch (e) {
            console.warn(e);
            showAlert("😥", "등록 실패");
          }
        };
        container.querySelector("#hof-reset").onclick = () => {
          [
            "hof-title",
            "hof-date",
            "hof-subtitle",
            "hof-image",
            "hof-desc",
          ].forEach((id) => (container.querySelector("#" + id).value = ""));
        };
      }

      /* ===== 시스템 설정 관리자 ===== */
      function renderSystemAdmin(container) {
        const signup = signupSettings || { open: false };
        const dues = duesSettings || {
          enabled: false,
          bank: "",
          number: "",
          holder: "",
          amount: "",
          note: "",
        };
        const admins = adminList || [];

        container.innerHTML = `
          <div class="grid grid-cols-1 gap-6">
            <!-- 회원가입 설정 -->
            <div class="section">
              <div class="flex items-center gap-3 mb-3">
                <i class="fas fa-user-plus text-2xl text-orange-500"></i>
                <div>
                  <h3 class="text-xl font-bold text-gray-800">회원가입 설정</h3>
                  <p class="text-sm text-gray-600">새로운 회원의 가입 신청 허용 여부를 관리합니다</p>
                </div>
              </div>
              <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-400"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm text-blue-700">
                      <strong>닫기:</strong> 회원가입 페이지에서 가입 버튼이 비활성화되며, 신규 회원이 가입할 수 없습니다<br>
                      <strong>열기:</strong> 회원가입이 활성화되어 누구나 가입 신청을 할 수 있습니다 (관리자 승인 필요)
                    </p>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <button type="button" id="signup-closed-btn" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all border-2 ${
                  !signup.open
                    ? "bg-red-500 text-white border-red-500"
                    : "bg-white text-gray-700 border-gray-300 hover:border-red-300"
                }">
                  <i class="fas fa-lock mr-2"></i>가입 닫기
                </button>
                <button type="button" id="signup-open-btn" class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all border-2 ${
                  signup.open
                    ? "bg-green-500 text-white border-green-500"
                    : "bg-white text-gray-700 border-gray-300 hover:border-green-300"
                }">
                  <i class="fas fa-lock-open mr-2"></i>가입 열기
                </button>
              </div>
              <div class="mt-3 text-sm ${
                signup.open
                  ? "text-green-700 bg-green-50"
                  : "text-red-700 bg-red-50"
              } px-4 py-2 rounded-lg border ${
          signup.open ? "border-green-200" : "border-red-200"
        }">
                <i class="fas ${
                  signup.open ? "fa-check-circle" : "fa-times-circle"
                } mr-2"></i>
                현재 상태: <strong>${
                  signup.open ? "가입 가능" : "가입 불가"
                }</strong>
              </div>
            </div>

            <!-- 회비/계좌 설정 -->
            <div class="section">
              <div class="flex items-center gap-3 mb-3">
                <i class="fas fa-credit-card text-2xl text-orange-500"></i>
                <div>
                  <h3 class="text-xl font-bold text-gray-800">회비 계좌 설정</h3>
                  <p class="text-sm text-gray-600">이벤트 신청 시 회원들에게 표시될 회비 입금 정보를 설정합니다</p>
                </div>
              </div>
              <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-400"></i>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm text-blue-700">
                      <strong>용도:</strong> 이벤트 참가비 또는 동아리 회비를 수납할 때 사용합니다<br>
                      <strong>표시 위치:</strong> 이벤트 신청 화면에서 자동으로 계좌 정보가 표시됩니다<br>
                      <strong>안내 문구:</strong> 입금 관련 추가 안내사항을 입력할 수 있습니다 (예: "입금자명은 본인 이름으로 해주세요")
                    </p>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-toggle-on mr-1 text-orange-500"></i>사용 여부
                  </label>
                  <select id="set-dues-enabled" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                    <option value="false" ${
                      dues.enabled ? "" : "selected"
                    }>사용 안 함</option>
                    <option value="true" ${
                      dues.enabled ? "selected" : ""
                    }>사용</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-university mr-1 text-orange-500"></i>은행명
                  </label>
                  <input id="set-dues-bank" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="예: 카카오뱅크" value="${saf(
                    dues.bank || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-hashtag mr-1 text-orange-500"></i>계좌번호
                  </label>
                  <input id="set-dues-number" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="예: 3333-12-1234567" value="${saf(
                    dues.number || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-user mr-1 text-orange-500"></i>예금주
                  </label>
                  <input id="set-dues-holder" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="예: 홍길동" value="${saf(
                    dues.holder || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-won-sign mr-1 text-orange-500"></i>금액 (선택)
                  </label>
                  <input id="set-dues-amount" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="예: 10000" value="${saf(
                    dues.amount || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-comment-dots mr-1 text-orange-500"></i>안내 문구 (선택)
                  </label>
                  <input id="set-dues-note" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="예: 입금자명은 본인 이름으로" value="${saf(
                    dues.note || ""
                  )}">
                </div>
              </div>
              <button id="set-dues-save" class="mt-4 w-full md:w-auto px-6 py-3 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition-colors shadow-md">
                <i class="fas fa-save mr-2"></i>회비 정보 저장
              </button>
            </div>
          </div>
        `;

        // 회원가입 설정 버튼 핸들러
        const signupClosedBtn = container.querySelector("#signup-closed-btn");
        const signupOpenBtn = container.querySelector("#signup-open-btn");

        signupClosedBtn.onclick = async () => {
          try {
            await setDoc(
              doc(db, "settings", "signup"),
              { open: false },
              { merge: true }
            );
            showAlert("✅", "회원가입이 닫혔습니다.");
          } catch (e) {
            console.warn(e);
            showAlert("😥", "저장 실패");
          }
        };

        signupOpenBtn.onclick = async () => {
          try {
            await setDoc(
              doc(db, "settings", "signup"),
              { open: true },
              { merge: true }
            );
            showAlert("✅", "회원가입이 열렸습니다.");
          } catch (e) {
            console.warn(e);
            showAlert("😥", "저장 실패");
          }
        };

        // 회비 설정 저장 핸들러
        container.querySelector("#set-dues-save").onclick = async () => {
          const enabled =
            container.querySelector("#set-dues-enabled").value === "true";
          const bank = container.querySelector("#set-dues-bank").value.trim();
          const number = container
            .querySelector("#set-dues-number")
            .value.trim();
          const holder = container
            .querySelector("#set-dues-holder")
            .value.trim();
          const amount = container
            .querySelector("#set-dues-amount")
            .value.trim();
          const note = container.querySelector("#set-dues-note").value.trim();
          try {
            await setDoc(
              doc(db, "settings", "dues"),
              { enabled, bank, number, holder, amount, note },
              { merge: true }
            );
            showAlert("✅", "회비/계좌 설정이 저장되었습니다.");
          } catch (e) {
            console.warn(e);
            showAlert("😥", "저장 실패");
          }
        };
      }

      /* ===== 비상 관리자 임명 ===== */
      async function addEmergencyAdmin() {
        const sid = document.getElementById("new-admin-id").value.trim();
        if (!sid) return showAlert("😥", "학번을 입력하세요.");
        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "admins", "list");
            const snap = await tx.get(ref);
            const arr = snap.exists() ? snap.data().studentIds || [] : [];
            if (!arr.includes(sid)) arr.push(sid);
            tx.set(ref, { studentIds: arr }, { merge: true });
          });
          closeEmergencyModal();
          showAlert("✅", `관리자에 ${saf(sid)}를(을) 추가했습니다.`);
        } catch (e) {
          console.warn(e);
          showAlert("😥", "관리자 임명 중 오류가 발생했습니다.");
        }
      }

      /* ===== 전역: 에디터 모달 밖 클릭 시 닫힘 방지(명시 버튼만) ===== */
      // 이미 각 사용처에서 cancel과 save 핸들러를 지정함

      // 로딩 진행률 관리
      let loadingProgress = 0;
      const totalLoadingSteps = 2; // 총 로딩 단계 수 (간소화)

      // 자연스러운 시간대 전환 애니메이션 (한 번만 랜덤 선택)
      let mealTimeAnimationInterval = null;
      let loadingAnimationComplete = false;
      let selectedMealTime = null;
      let currentMealIndex = 0;
      const mealTimes = ["아침", "점심", "저녁", "간식"];

      function updateMealTimeCube() {
        const cubeElement = document.getElementById("meal-time-cube");
        if (!cubeElement) return;

        // 다음 텍스트로 순환
        currentMealIndex = (currentMealIndex + 1) % mealTimes.length;
        selectedMealTime = mealTimes[currentMealIndex];

        // 애니메이션 시작
        cubeElement.classList.remove("smooth-fade");
        // 강제 리플로우로 애니메이션 재시작
        void cubeElement.offsetWidth;
        cubeElement.classList.add("smooth-fade");
        cubeElement.textContent = selectedMealTime;
      }

      // 로딩 애니메이션 시작
      function startLoadingAnimation() {
        loadingAnimationComplete = false;

        // 랜덤한 시작 인덱스 선택
        currentMealIndex = Math.floor(Math.random() * mealTimes.length);
        selectedMealTime = mealTimes[currentMealIndex];

        const cubeElement = document.getElementById("meal-time-cube");
        if (cubeElement) {
          // 첫 번째 텍스트 표시
          cubeElement.textContent = selectedMealTime;
          cubeElement.classList.add("smooth-fade");

          // 2.5초마다 텍스트 변경
          if (mealTimeAnimationInterval) {
            clearInterval(mealTimeAnimationInterval);
          }
          mealTimeAnimationInterval = setInterval(updateMealTimeCube, 2500);
        }
      }

      // 로딩 애니메이션 종료
      function stopLoadingAnimation() {
        if (mealTimeAnimationInterval) {
          clearInterval(mealTimeAnimationInterval);
          mealTimeAnimationInterval = null;
        }
        loadingAnimationComplete = true;
        selectedMealTime = null; // 초기화
      }

      function updateLoadingProgress(step, text) {
        // step이 1이면 데이터 로딩 중 (90%까지), step이 2면 완료 (100%)
        if (step === 1) {
          // 데이터 로딩 중일 때는 90%까지만
          loadingProgress = Math.min(90, 90);
          // 애니메이션 시작
          startLoadingAnimation();
        } else if (step === 2) {
          // 완료 시에는 100%
          loadingProgress = 100;
        } else if (step === 3) {
          // 70% 이상
          loadingProgress = 75;
        } else if (step === 4) {
          // 90% 이상
          loadingProgress = 90;
        }

        const progressBar = document.getElementById("progress-bar");
        const loadingText = document.getElementById("loading-text");

        if (progressBar) {
          // SVG path의 전체 길이는 200으로 설정됨 (더 긴 길이)
          // 진행률에 따라 stroke-dashoffset을 줄임
          const totalLength = 200;
          const offset = totalLength - (totalLength * loadingProgress) / 100;

          // 부드러운 애니메이션으로 진행률 업데이트
          progressBar.style.transition =
            "stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1)";
          progressBar.style.strokeDashoffset = offset;

          if (loadingProgress >= 100) {
            progressBar.classList.remove("loading");
            // 로딩 애니메이션만 종료, 화면 숨기기는 데이터 로드 완료 시에만
            setTimeout(() => {
              stopLoadingAnimation();
              // hideLoadingScreen()은 verifyAllDataLoaded에서만 호출됨
            }, 1500);
          }
        }

        console.log(`로딩 진행률: ${loadingProgress}% - ${text || ""}`);
      }

      // 로딩 화면 숨기기 함수
      function hideLoadingScreen() {
        // 1차 체크: __loadingDataCount가 8개를 모두 받았는지 확인
        if (__loadingDataCount < __expectedDataSources) {
          console.log(
            `⏳ 데이터 로딩 중... ${__loadingDataCount}/${__expectedDataSources} - 로딩 화면 유지`
          );
          return;
        }

        // 2차 체크: 실제 데이터가 배열로 초기화되었는지 확인
        const hasRequiredData =
          Array.isArray(roadmapData) &&
          Array.isArray(eventsData) &&
          Array.isArray(blocksData) &&
          Array.isArray(membersData) &&
          Array.isArray(adminList) &&
          Array.isArray(foodMenusData);

        if (!hasRequiredData) {
          console.log("⏳ 데이터 변수 초기화 대기 중... 로딩 화면 유지");
          return;
        }

        // 모든 조건 통과: 로딩 화면 닫기
        const loadingScreen = document.getElementById("loading-screen");
        if (loadingScreen && loadingAnimationComplete) {
          console.log("✅ 로딩 화면 숨김 (모든 데이터 소스 응답 완료)");
          loadingScreen.classList.add("hidden");
        }
      }

      // ===================== 초기화 =====================
      // 페이지 로드 시 초기화
      document.addEventListener("DOMContentLoaded", function () {
        // 1단계: 초기 렌더링
        updateLoadingProgress(1, "잘 먹겠습니다!");
        applyHomeLayoutOrder();
        renderRoadmap();
        renderBlocks();

        // 5초 후: 매우 빠른 실패 감지
        setTimeout(() => {
          if (__loadingDataCount === 0) {
            console.error("❌ 5초 경과, 데이터 0개 - 즉시 재접속");
            location.reload();
          }
        }, 5000);

        // 10초 후: 부족한 데이터 감지
        setTimeout(() => {
          if (__loadingDataCount < 2) {
            console.error("❌ 10초 경과, 데이터 부족 - 재접속");
            console.log(
              `로드된 데이터: ${__loadingDataCount}/${__expectedDataSources}`
            );
            location.reload();
          }
        }, 10000);

        // 15초 후: 최종 확인
        setTimeout(() => {
          if (__loadingDataCount < 5) {
            console.error("❌ 15초 경과, 데이터 부족 - 재접속");
            console.log(
              `로드된 데이터: ${__loadingDataCount}/${__expectedDataSources}`
            );
            location.reload();
          }
        }, 15000);

        // 예약된 글들 확인
        setTimeout(() => {
          checkScheduledPosts();
        }, 2000); // 2초 후 실행 (로그인 완료 후)

        // 화면 크기 변경 시 일정 다시 렌더링
        let resizeTimeout;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (typeof renderHorizontalRoadmap === "function") {
              renderHorizontalRoadmap();
            }
          }, 250);
        });
        updateSignupUI();

        // 2단계: 사용자 정보 확인
        updateLoadingProgress(2, "잘 먹겠습니다!");
        const savedUser = localStorage.getItem("foodieUser");
        if (savedUser) {
          try {
            currentUser = JSON.parse(savedUser);
            // 3단계: 데이터 로딩
            updateLoadingProgress(3, "잘 먹겠습니다!");
            setTimeout(() => {
              renderAll();
            }, 1200); // 로드맵 로딩 시간 고려하여 연장
          } catch (e) {
            console.warn("저장된 사용자 정보 파싱 실패:", e);
            updateLoadingProgress(3, "잘 먹겠습니다!");
            setTimeout(() => {
              renderAll();
            }, 1200); // 로드맵 로딩 시간 고려하여 연장
          }
        } else {
          // 자동 로그인 시도
          updateLoadingProgress(3, "잘 먹겠습니다!");
          attemptAutoLogin().then((success) => {
            updateLoadingProgress(4, "잘 먹겠습니다!");
            setTimeout(() => {
              renderAll();
            }, 1200); // 로드맵 로딩 시간 고려하여 연장
          });
        }
      });

      // 페이지 가시성 변경 시 렌더링 보장
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden && currentUser) {
          setTimeout(() => {
            renderAll();
          }, 100);
        }
      });

      // 윈도우 포커스 시 렌더링 보장
      window.addEventListener("focus", () => {
        if (currentUser) {
          setTimeout(() => {
            renderAll();
          }, 100);
        }
      });

      // ===================== 미식회 모달 관리 =====================
      function openTastingModal(mode = "create", eventId = null) {
        const modal = document.getElementById("tasting-modal");
        const title = document.getElementById("tasting-modal-title");
        const content = document.getElementById("tasting-modal-content");

        if (mode === "create") {
          // 생성 모드: editingEventId 초기화
          if (typeof editingEventId !== "undefined") {
            editingEventId = null;
          }
          title.textContent = "🍽️ 미식회 만들기";
          content.innerHTML = createTastingFormHTML();
          modal.classList.remove("hidden");
          bindTastingForm();
        } else if (mode === "edit" && eventId) {
          // 수정 모드: editingEventId 설정
          if (typeof editingEventId !== "undefined") {
            editingEventId = eventId;
          }
          title.textContent = "🍽️ 미식회 수정";
          content.innerHTML = createTastingFormHTML();
          modal.classList.remove("hidden");
          bindTastingForm();
          // DOM이 렌더링된 후 폼 로드
          setTimeout(() => {
            loadTastingToForm(eventId);
            // 버튼 텍스트를 수정 모드로 변경
            const saveBtn = document.getElementById("save-tasting-btn");
            if (saveBtn) {
              saveBtn.innerHTML =
                '<i class="fas fa-edit mr-2"></i>미식회 수정하기';
            }
          }, 0);
        }
      }

      function closeTastingModal() {
        const modal = document.getElementById("tasting-modal");
        modal.classList.add("hidden");
        resetTastingForm();
      }

      // ===================== 미식회 폼 데이터 로드 =====================
      function loadTastingToForm(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) {
          showAlert("😥", "이벤트를 찾을 수 없습니다.");
          return;
        }

        // 기본 정보 로드
        const titleInput = document.getElementById("tasting-title");
        if (titleInput) titleInput.value = event.title || "";

        const datetimeInput = document.getElementById("tasting-datetime");
        if (datetimeInput && event.datetime) {
          const date = new Date(event.datetime);
          datetimeInput.value = date.toISOString().slice(0, 16);
        }

        const registrationStartInput = document.getElementById(
          "tasting-registration-start"
        );
        if (registrationStartInput && event.registrationStart) {
          const date = new Date(event.registrationStart);
          registrationStartInput.value = date.toISOString().slice(0, 16);
        }

        const deadlineInput = document.getElementById("tasting-deadline");
        if (deadlineInput && event.deadline) {
          const date = new Date(event.deadline);
          deadlineInput.value = date.toISOString().slice(0, 16);
        }

        const limitInput = document.getElementById("tasting-limit");
        if (limitInput) limitInput.value = event.limit || "";

        // 식당 정보 로드
        const container = document.getElementById("tasting-restaurants-wrap");
        if (container && event.restaurants && event.restaurants.length > 0) {
          container.innerHTML = event.restaurants
            .map((restaurant) =>
              createRestaurantFieldHTML(
                restaurant.name || "",
                restaurant.info || "",
                restaurant.capacity || "",
                restaurant.category || "기타"
              )
            )
            .join("");
        } else if (container) {
          container.innerHTML = createRestaurantFieldHTML();
        }
      }

      // ===================== 이벤트 모달 관리 =====================
      function openEventModal(mode = "create", eventId = null) {
        const modal = document.getElementById("event-modal");
        const title = document.getElementById("event-modal-title");
        const content = document.getElementById("event-modal-content");

        if (mode === "create") {
          // 생성 모드: editingEventId 초기화
          if (typeof editingEventId !== "undefined") {
            editingEventId = null;
          }
          title.textContent = "📅 이벤트 만들기";
          content.innerHTML = createEventFormHTML();
          modal.classList.remove("hidden");
          bindEventForm();
        } else if (mode === "edit" && eventId) {
          // 수정 모드: editingEventId 설정
          if (typeof editingEventId !== "undefined") {
            editingEventId = eventId;
          }
          title.textContent = "📅 이벤트 수정";
          content.innerHTML = createEventFormHTML();
          modal.classList.remove("hidden");
          bindEventForm();
          // DOM이 렌더링된 후 폼 로드
          setTimeout(() => {
            loadEventToForm(eventId);
            // 버튼 텍스트를 수정 모드로 변경
            const saveBtn = document.getElementById("save-event-btn");
            if (saveBtn) {
              saveBtn.innerHTML =
                '<i class="fas fa-edit mr-2"></i>이벤트 수정하기';
            }
          }, 0);
        }
      }

      function closeEventModal() {
        const modal = document.getElementById("event-modal");
        modal.classList.add("hidden");
        resetEventForm();
      }

      // ===================== 미식회 폼 HTML 생성 =====================
      function createTastingFormHTML() {
        return `
          <div class="space-y-6">
            <!-- 미식회 기본 정보 -->
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl p-6">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                  <i class="fas fa-utensils text-white text-lg"></i>
                </div>
                <h4 class="text-xl font-bold text-gray-800">미식회 기본 정보</h4>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-heading text-orange-500 mr-2"></i>
                    미식회 제목 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="tasting-title" 
                    type="text" 
                    placeholder="예: 푸디 가을 미식회, 신촌 맛집 투어" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt text-orange-500 mr-2"></i>
                    미식회 날짜 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="tasting-datetime" 
                    type="datetime-local" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-play text-orange-500 mr-2"></i>
                    신청 시작일
                  </label>
                  <input 
                    id="tasting-registration-start" 
                    type="datetime-local" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base"
                  >
                  <p class="text-xs text-gray-500 mt-1">🚀 이 시간부터 신청이 시작됩니다 (비워두면 즉시 신청 가능)</p>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-clock text-orange-500 mr-2"></i>
                    신청 마감일 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="tasting-deadline" 
                    type="datetime-local" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-users text-orange-500 mr-2"></i>
                    전체 정원 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="tasting-limit" 
                    type="number" 
                    min="1" 
                    placeholder="예: 30" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" 
                    required
                  >
                  <p class="text-xs text-gray-500 mt-1">전체 참가 가능 인원을 입력하세요</p>
                </div>
              </div>
            </div>

            <!-- 식당 추가 섹션 -->
            <div class="bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-200 rounded-xl p-6">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                  <i class="fas fa-store text-white text-lg"></i>
                </div>
                <h4 class="text-xl font-bold text-gray-800">식당 추가하기</h4>
              </div>
              
              <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-green-800 flex items-center gap-2">
                  <i class="fas fa-lightbulb"></i>
                  미식회는 최소 1개 이상의 식당을 추가해야 합니다. 각 식당별로 정원을 설정할 수 있어요!
                </p>
              </div>
              
              <div id="tasting-restaurants-wrap" class="space-y-4 mb-4">
                ${createRestaurantFieldHTML()}
              </div>
              
              <button 
                id="add-restaurant-btn" 
                type="button" 
                class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
              >
                <i class="fas fa-plus-circle text-lg"></i>
                <span>식당 추가하기</span>
              </button>
            </div>

            <!-- 저장 버튼 -->
            <div class="flex gap-4">
              <button 
                id="save-tasting-btn" 
                type="button" 
                class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-4 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl text-lg"
              >
                <i class="fas fa-save mr-2"></i>
                미식회 만들기
              </button>
              <button 
                id="reset-tasting-btn" 
                type="button" 
                class="px-6 py-4 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg transition-all"
              >
                <i class="fas fa-undo mr-2"></i>
                초기화
              </button>
            </div>
          </div>
        `;
      }

      // ===================== 이벤트 폼 HTML 생성 =====================
      function createEventFormHTML() {
        return `
          <div class="space-y-6">
            <!-- 이벤트 기본 정보 -->
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-6">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                  <i class="fas fa-calendar text-white text-lg"></i>
                </div>
                <h4 class="text-xl font-bold text-gray-800">이벤트 기본 정보</h4>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-tag text-blue-500 mr-2"></i>
                    이벤트 종류 <span class="text-red-500">*</span>
                  </label>
                  <select 
                    id="event-type" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base bg-white" 
                    required
                  >
                    <option value="general">일반 이벤트</option>
                    <option value="mt">MT (Membership Training)</option>
                    <option value="assembly">총회</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-heading text-blue-500 mr-2"></i>
                    이벤트 제목 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="event-title" 
                    type="text" 
                    placeholder="예: 푸디 가을 MT, 정기 총회" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                    이벤트 날짜 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="event-datetime" 
                    type="datetime-local" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-play text-blue-500 mr-2"></i>
                    신청 시작일
                  </label>
                  <input 
                    id="event-registration-start" 
                    type="datetime-local" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                  >
                  <p class="text-xs text-gray-500 mt-1">🚀 이 시간부터 신청이 시작됩니다 (비워두면 즉시 신청 가능)</p>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-clock text-blue-500 mr-2"></i>
                    신청 마감일 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="event-deadline" 
                    type="datetime-local" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-users text-blue-500 mr-2"></i>
                    참가 정원 <span class="text-red-500">*</span>
                  </label>
                  <input 
                    id="event-limit" 
                    type="number" 
                    min="1" 
                    placeholder="예: 20" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base" 
                    required
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-eye text-blue-500 mr-2"></i>
                    공개 설정
                  </label>
                  <select 
                    id="event-status" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base bg-white"
                  >
                    <option value="open">공개</option>
                    <option value="archived">숨김</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1">숨김으로 설정하면 사용자에게 보이지 않습니다</p>
                </div>
              </div>
            </div>

            <!-- 회비 정보 (MT/총회만) -->
            <div id="payment-section" class="bg-gradient-to-r from-purple-50 to-purple-100 border-2 border-purple-200 rounded-xl p-6 hidden">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                  <i class="fas fa-credit-card text-white text-lg"></i>
                </div>
                <h4 class="text-xl font-bold text-gray-800">회비 입금 정보</h4>
              </div>
              
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-purple-800 flex items-center gap-2">
                  <i class="fas fa-info-circle"></i>
                  시스템 설정의 계좌 정보가 자동으로 불러와집니다. 필요시 수정하세요.
                </p>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-university text-purple-500 mr-2"></i>
                    은행명
                  </label>
                  <input 
                    id="pay-bank" 
                    type="text" 
                    placeholder="예: 국민은행" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-hashtag text-purple-500 mr-2"></i>
                    계좌번호
                  </label>
                  <input 
                    id="pay-number" 
                    type="text" 
                    placeholder="예: 123-456-789012" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-user text-purple-500 mr-2"></i>
                    예금주
                  </label>
                  <input 
                    id="pay-holder" 
                    type="text" 
                    placeholder="예: 홍길동" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                  >
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-won-sign text-purple-500 mr-2"></i>
                    회비 금액
                  </label>
                  <input 
                    id="pay-amount" 
                    type="number" 
                    placeholder="예: 50000" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                  >
                  <p class="text-xs text-gray-500 mt-1">숫자만 입력하세요 (예: 50000)</p>
                </div>
                
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-comment-dots text-purple-500 mr-2"></i>
                    입금 안내 (선택사항)
                  </label>
                  <input 
                    id="pay-note" 
                    type="text" 
                    placeholder="예: 입금 시 이름 꼭 적어주세요" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                  >
                </div>
              </div>
            </div>

            <!-- 저장 버튼 -->
            <div class="flex gap-4">
              <button 
                id="save-event-btn" 
                type="button" 
                class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl text-lg"
              >
                <i class="fas fa-save mr-2"></i>
                이벤트 만들기
              </button>
              <button 
                id="reset-event-btn" 
                type="button" 
                class="px-6 py-4 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg transition-all"
              >
                <i class="fas fa-undo mr-2"></i>
                초기화
              </button>
            </div>
          </div>
        `;
      }

      // 모달 이벤트 바인딩
      document.addEventListener("click", (e) => {
        // 미식회 만들기 블록 클릭
        if (e.target.closest("#create-tasting-block")) {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 미식회를 관리할 수 있습니다.");
            return;
          }
          openTastingModal("create");
        }
        // 이벤트 만들기 블록 클릭
        else if (e.target.closest("#create-event-block")) {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 관리할 수 있습니다.");
            return;
          }
          openEventModal("create");
        }
        // 자동 마감 버튼
        else if (e.target.id === "auto-close-btn") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 자동 마감을 실행할 수 있습니다.");
            return;
          }
          autoCloseExpiredEvents();
        }
        // 미식회 모달 닫기
        else if (
          e.target.id === "tasting-modal-close" ||
          e.target.closest("#tasting-modal-close")
        ) {
          closeTastingModal();
        } else if (e.target.closest("#tasting-modal")) {
          if (e.target.id === "tasting-modal") {
            closeTastingModal();
          }
        }
        // 이벤트 모달 닫기
        else if (
          e.target.id === "event-modal-close" ||
          e.target.closest("#event-modal-close")
        ) {
          closeEventModal();
        } else if (e.target.closest("#event-modal")) {
          if (e.target.id === "event-modal") {
            closeEventModal();
          }
        }
      });

      // ===================== 미식회 폼 바인딩 =====================
      function bindTastingForm() {
        // 식당 추가 버튼
        document
          .getElementById("add-restaurant-btn")
          ?.addEventListener("click", () => {
            const container = document.getElementById(
              "tasting-restaurants-wrap"
            );
            if (container) {
              container.insertAdjacentHTML(
                "beforeend",
                createRestaurantFieldHTML()
              );
            }
          });

        // 식당 삭제 버튼
        document.addEventListener("click", (e) => {
          if (e.target.closest(".remove-restaurant")) {
            e.target.closest(".restaurant-row")?.remove();
          }
        });

        // 미식회 저장 버튼
        document
          .getElementById("save-tasting-btn")
          ?.addEventListener("click", async () => {
            await saveTastingEvent();
          });

        // 미식회 초기화 버튼
        document
          .getElementById("reset-tasting-btn")
          ?.addEventListener("click", () => {
            resetTastingForm();
          });
      }

      // ===================== 이벤트 폼 바인딩 =====================
      function bindEventForm() {
        // 이벤트 종류 변경 시 회비 섹션 표시/숨김 및 계좌 정보 자동 로드
        document
          .getElementById("event-type")
          ?.addEventListener("change", (e) => {
            const paymentSection = document.getElementById("payment-section");
            if (paymentSection) {
              if (e.target.value === "mt" || e.target.value === "assembly") {
                paymentSection.classList.remove("hidden");
                // 계좌 정보 자동 로드
                loadDefaultPaymentInfo();
              } else {
                paymentSection.classList.add("hidden");
              }
            }
          });

        // 이벤트 저장 버튼
        document
          .getElementById("save-event-btn")
          ?.addEventListener("click", async () => {
            await saveEvent();
          });

        // 이벤트 초기화 버튼
        document
          .getElementById("reset-event-btn")
          ?.addEventListener("click", () => {
            resetEventForm();
          });
      }

      // 기본 회비 정보 로드 함수
      function loadDefaultPaymentInfo() {
        const d = duesSettings || {};
        const payBank = document.getElementById("pay-bank");
        const payNumber = document.getElementById("pay-number");
        const payHolder = document.getElementById("pay-holder");
        const payAmount = document.getElementById("pay-amount");
        const payNote = document.getElementById("pay-note");

        // 기존 값이 없을 때만 기본값으로 채움
        if (payBank && !payBank.value) payBank.value = d.bank || "";
        if (payNumber && !payNumber.value) payNumber.value = d.number || "";
        if (payHolder && !payHolder.value) payHolder.value = d.holder || "";
        if (payAmount && !payAmount.value) payAmount.value = d.amount || "";
        if (payNote && !payNote.value) {
          payNote.value =
            (d.amount ? `회비 ${formatKRW(d.amount)} ` : "") + (d.note || "");
        }
      }

      // ===================== 미식회 저장 함수 =====================
      async function saveTastingEvent() {
        const title = document.getElementById("tasting-title")?.value.trim();
        const datetime = document.getElementById("tasting-datetime")?.value;
        const registrationStart = document.getElementById(
          "tasting-registration-start"
        )?.value;
        const deadline = document.getElementById("tasting-deadline")?.value;
        const limit = parseInt(
          document.getElementById("tasting-limit")?.value || "0",
          10
        );

        if (!title || !datetime || !deadline || !limit) {
          showAlert("😥", "모든 필수 항목을 입력해주세요.");
          return;
        }

        if (
          registrationStart &&
          new Date(registrationStart) >= new Date(deadline)
        ) {
          showAlert("😥", "신청 시작일은 신청 마감일보다 이전이어야 합니다.");
          return;
        }

        if (new Date(deadline) >= new Date(datetime)) {
          showAlert("😥", "신청 마감일은 이벤트 날짜보다 이전이어야 합니다.");
          return;
        }

        // 식당 정보 수집
        const restaurantRows = document.querySelectorAll(
          "#tasting-restaurants-wrap .restaurant-row"
        );
        const restaurants = [];

        // 수정 모드인지 확인 (editingEventId가 있는지 확인)
        const isEditMode =
          typeof editingEventId !== "undefined" && editingEventId;

        // 기존 이벤트 데이터 가져오기 (수정 모드일 때만)
        let existingEvent = null;
        if (isEditMode) {
          existingEvent = eventsData.find((e) => e.id === editingEventId);
        }

        for (const row of restaurantRows) {
          const name = row.querySelector("[data-field='name']")?.value.trim();
          const info = row.querySelector("[data-field='info']")?.value.trim();
          const capacity = parseInt(
            row.querySelector("[data-field='capacity']")?.value || "0",
            10
          );
          const category =
            row.querySelector("[data-field='category']")?.value || "기타";
          const restaurantId = row.getAttribute("data-id");

          if (name && capacity > 0) {
            let reservations = [];
            let waiting = [];

            // 수정 모드일 때는 기존 식당의 예약 정보를 보존하고 정원에 맞춰 재배치
            if (isEditMode && existingEvent && existingEvent.restaurants) {
              const existingRestaurant = existingEvent.restaurants.find(
                (r) => r.id === restaurantId
              );

              if (existingRestaurant) {
                // 기존 예약자와 대기자를 모두 합침
                const allParticipants = [
                  ...(existingRestaurant.reservations || []),
                  ...(existingRestaurant.waiting || []),
                ];

                // 신청 순서대로 정렬 (appliedAt 또는 timestamp 기준)
                allParticipants.sort((a, b) => {
                  const timeA =
                    a.appliedAt || a.timestamp
                      ? new Date(a.appliedAt || a.timestamp).getTime()
                      : 0;
                  const timeB =
                    b.appliedAt || b.timestamp
                      ? new Date(b.appliedAt || b.timestamp).getTime()
                      : 0;
                  return timeA - timeB;
                });

                // 정원에 맞춰 예약자와 대기자 분리
                reservations = allParticipants.slice(0, capacity);
                waiting = allParticipants.slice(capacity);
              }
            }

            restaurants.push({
              id: restaurantId,
              name,
              info,
              capacity,
              category,
              reservations,
              waiting,
            });
          }
        }

        if (restaurants.length === 0) {
          showAlert("😥", "최소 1개 이상의 식당을 추가해주세요.");
          return;
        }

        try {
          if (isEditMode) {
            // 수정 모드
            await updateDoc(doc(db, "events", editingEventId), {
              title,
              datetime,
              registrationStart: registrationStart || null,
              deadline,
              limit,
              restaurants,
            });
            showAlert("🎉", "미식회가 성공적으로 수정되었습니다!");
          } else {
            // 생성 모드
            await addDoc(collection(db, "events"), {
              type: "tasting",
              title,
              datetime,
              registrationStart: registrationStart || null,
              deadline,
              limit,
              status: "open",
              restaurants,
            });
            showAlert("🎉", "미식회가 성공적으로 생성되었습니다!");
          }

          closeTastingModal();
          renderAll();
        } catch (error) {
          console.error("미식회 저장 오류:", error);
          showAlert(
            "😥",
            isEditMode
              ? "미식회 수정에 실패했습니다."
              : "미식회 생성에 실패했습니다."
          );
        }
      }

      // ===================== 이벤트 저장 함수 =====================
      async function saveEvent() {
        const type = document.getElementById("event-type")?.value;
        const title = document.getElementById("event-title")?.value.trim();
        const datetime = document.getElementById("event-datetime")?.value;
        const registrationStart = document.getElementById(
          "event-registration-start"
        )?.value;
        const deadline = document.getElementById("event-deadline")?.value;
        const limit = parseInt(
          document.getElementById("event-limit")?.value || "0",
          10
        );
        const status = document.getElementById("event-status")?.value || "open";

        if (!type || !title || !datetime || !deadline || !limit) {
          showAlert("😥", "모든 필수 항목을 입력해주세요.");
          return;
        }

        if (
          registrationStart &&
          new Date(registrationStart) >= new Date(deadline)
        ) {
          showAlert("😥", "신청 시작일은 신청 마감일보다 이전이어야 합니다.");
          return;
        }

        if (new Date(deadline) >= new Date(datetime)) {
          showAlert("😥", "신청 마감일은 이벤트 날짜보다 이전이어야 합니다.");
          return;
        }

        // 수정 모드인지 확인 (editingEventId가 있는지 확인)
        const isEditMode =
          typeof editingEventId !== "undefined" && editingEventId;

        // 기존 이벤트 데이터 가져오기 (수정 모드일 때만)
        let existingEvent = null;
        if (isEditMode) {
          existingEvent = eventsData.find((e) => e.id === editingEventId);
        }

        let applicants = [];
        let waiting = [];

        if (isEditMode && existingEvent) {
          // 수정 모드: 기존 참가자와 대기자를 모두 합침
          const allParticipants = [
            ...(existingEvent.applicants || []),
            ...(existingEvent.waiting || []),
          ];

          // 신청 순서대로 정렬 (appliedAt 또는 timestamp 기준)
          allParticipants.sort((a, b) => {
            const timeA =
              a.appliedAt || a.timestamp
                ? new Date(a.appliedAt || a.timestamp).getTime()
                : 0;
            const timeB =
              b.appliedAt || b.timestamp
                ? new Date(b.appliedAt || b.timestamp).getTime()
                : 0;
            return timeA - timeB;
          });

          // 정원에 맞춰 참가자와 대기자 분리
          applicants = allParticipants.slice(0, limit);
          waiting = allParticipants.slice(limit);
        }

        const eventData = {
          type,
          title,
          datetime,
          registrationStart: registrationStart || null,
          deadline,
          limit,
          status,
          applicants,
          waiting,
        };

        // MT/총회인 경우 회비 정보 추가
        if (type === "mt" || type === "assembly") {
          const bank = document.getElementById("pay-bank")?.value.trim();
          const number = document.getElementById("pay-number")?.value.trim();
          const holder = document.getElementById("pay-holder")?.value.trim();
          const amount = document.getElementById("pay-amount")?.value.trim();
          const note = document.getElementById("pay-note")?.value.trim();

          if (bank || number || holder || amount || note) {
            eventData.payment = {
              bank,
              number,
              holder,
              amount: amount ? parseInt(amount) : null,
              note,
            };
          }
        }

        try {
          if (isEditMode) {
            // 수정 모드
            await updateDoc(doc(db, "events", editingEventId), eventData);
            showAlert("🎉", "이벤트가 성공적으로 수정되었습니다!");
          } else {
            // 생성 모드
            await addDoc(collection(db, "events"), eventData);
            showAlert("🎉", "이벤트가 성공적으로 생성되었습니다!");
          }

          closeEventModal();
          renderAll();
        } catch (error) {
          console.error("이벤트 저장 오류:", error);
          showAlert(
            "😥",
            isEditMode
              ? "이벤트 수정에 실패했습니다."
              : "이벤트 생성에 실패했습니다."
          );
        }
      }

      // ===================== 폼 초기화 함수 =====================
      function resetTastingForm() {
        // editingEventId 초기화
        if (typeof editingEventId !== "undefined") {
          editingEventId = null;
        }

        const titleInput = document.getElementById("tasting-title");
        if (titleInput) titleInput.value = "";

        const datetimeInput = document.getElementById("tasting-datetime");
        if (datetimeInput) datetimeInput.value = "";

        const registrationStartInput = document.getElementById(
          "tasting-registration-start"
        );
        if (registrationStartInput) registrationStartInput.value = "";

        const deadlineInput = document.getElementById("tasting-deadline");
        if (deadlineInput) deadlineInput.value = "";

        const limitInput = document.getElementById("tasting-limit");
        if (limitInput) limitInput.value = "";

        const container = document.getElementById("tasting-restaurants-wrap");
        if (container) {
          container.innerHTML = createRestaurantFieldHTML();
        }
      }

      function resetEventForm() {
        // 기존 코드와의 호환성을 위해 editingEventId 초기화
        if (typeof editingEventId !== "undefined") {
          editingEventId = null;
        }

        // 이벤트 기본 정보 초기화
        const eventType = document.getElementById("event-type");
        if (eventType) eventType.value = "general";

        const eventTitle = document.getElementById("event-title");
        if (eventTitle) eventTitle.value = "";

        const eventDatetime = document.getElementById("event-datetime");
        if (eventDatetime) eventDatetime.value = "";

        const eventRegistrationStart = document.getElementById(
          "event-registration-start"
        );
        if (eventRegistrationStart) eventRegistrationStart.value = "";

        const eventDeadline = document.getElementById("event-deadline");
        if (eventDeadline) eventDeadline.value = "";

        const eventLimit = document.getElementById("event-limit");
        if (eventLimit) eventLimit.value = "";

        const eventStatus = document.getElementById("event-status");
        if (eventStatus) eventStatus.value = "open";

        // 회비 정보 초기화
        const payBank = document.getElementById("pay-bank");
        if (payBank) payBank.value = "";

        const payNumber = document.getElementById("pay-number");
        if (payNumber) payNumber.value = "";

        const payHolder = document.getElementById("pay-holder");
        if (payHolder) payHolder.value = "";

        const payAmount = document.getElementById("pay-amount");
        if (payAmount) payAmount.value = "";

        const payNote = document.getElementById("pay-note");
        if (payNote) payNote.value = "";

        // 회비 섹션 숨김
        const paymentSection = document.getElementById("payment-section");
        if (paymentSection) paymentSection.classList.add("hidden");

        // 기존 구조와의 호환성을 위한 추가 초기화
        const tastingFields = document.getElementById("tasting-fields");
        if (tastingFields) tastingFields.classList.remove("hidden");

        const paymentFields = document.getElementById("payment-fields");
        if (paymentFields) paymentFields.classList.add("hidden");

        const eventRestaurantsWrap = document.getElementById(
          "event-restaurants-wrap"
        );
        if (eventRestaurantsWrap) {
          // 새로운 createRestaurantFieldHTML 함수 사용
          if (typeof createRestaurantFieldHTML === "function") {
            eventRestaurantsWrap.innerHTML = createRestaurantFieldHTML();
          }
        }
      }

      // ===================== 식당 필드 HTML 생성 =====================
      function createRestaurantFieldHTML(
        n = "",
        i = "",
        c = "",
        category = "기타"
      ) {
        const rid = `res_${Math.random().toString(36).slice(2, 9)}`;
        return `
          <div class="restaurant-row bg-gradient-to-br from-white to-green-50 border-2 border-green-300 rounded-xl p-5 relative" data-id="${rid}">
            <!-- 삭제 버튼 -->
            <button type="button" class="remove-restaurant absolute top-3 right-3 bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full transition-all shadow-md hover:shadow-lg flex items-center justify-center" title="이 식당 삭제">
              <i class="fas fa-trash text-sm"></i>
            </button>

            <div class="space-y-4">
              <!-- 카테고리 선택 -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-tags text-green-500 mr-2"></i>
                  음식 종류 <span class="text-red-500">*</span>
                </label>
                <select data-field="category" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base bg-white" required>
                  ${restaurantCategories
                    .map(
                      (cat) => `
                    <option value="${cat.name}" ${
                        category === cat.name ? "selected" : ""
                      }>${cat.emoji} ${cat.name}</option>
                  `
                    )
                    .join("")}
                </select>
              </div>

              <!-- 입력 필드들 -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-utensils text-green-500 mr-2"></i>
                    식당 이름 <span class="text-red-500">*</span>
                  </label>
                  <input data-field="name" type="text" value="${saf(
                    n
                  )}" placeholder="예: 맛있는 파스타집" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base" required>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-users text-green-500 mr-2"></i>
                    정원 <span class="text-red-500">*</span>
                  </label>
                  <input data-field="capacity" type="number" min="1" value="${saf(
                    c
                  )}" placeholder="예: 10" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base" required>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-utensils text-green-500 mr-2"></i>
                  대표 메뉴 <span class="text-red-500">*</span>
                </label>
                <textarea data-field="info" rows="3" placeholder="이 식당의 대표 메뉴를 알려주세요&#10;예: 토마토 파스타, 크림 리조또, 마르게리타 피자" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base resize-none" required>${saf(
                  i
                )}</textarea>
                <p class="text-xs text-gray-500 mt-1">🍽️ 이 식당에서 꼭 먹어봐야 할 메뉴를 적어주세요</p>
              </div>
            </div>
          </div>
        `;
      }

      // 이벤트 액션 클릭 핸들러
      document.addEventListener("click", (e) => {
        const actionButton = e.target.closest("[data-act]");
        if (!actionButton) return;

        const act = actionButton.dataset.act;
        const id = actionButton.dataset.id;
        const rid = actionButton.dataset.rid;

        onEventActionClick(act, id, rid);
      });

      function onEventActionClick(act, id, rid) {
        if (act === "reserve-general") return reserveGeneral(id);
        if (act === "cancel-general") return cancelGeneral(id);
        if (act === "cancel-wait-general") return cancelWaitGeneral(id);
        if (act === "reserve-tasting") return reserveTasting(id, rid);
        if (act === "cancel-tasting") return cancelTasting(id, rid);
        if (act === "cancel-wait-tasting") return cancelWaitTasting(id, rid);
        if (act === "admin-edit") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 수정할 수 있습니다.");
            return;
          }
          // 이벤트 타입에 따라 올바른 모달 열기
          const event = eventsData.find((e) => e.id === id);
          if (event && event.type === "tasting") {
            return openTastingModal("edit", id);
          } else {
            return openEventModal("edit", id);
          }
        }
        if (act === "admin-close") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 관리할 수 있습니다.");
            return;
          }
          return closeEvent(id);
        }
        if (act === "admin-reopen") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 관리할 수 있습니다.");
            return;
          }
          return reopenEvent(id);
        }
        if (act === "admin-archive") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 관리할 수 있습니다.");
            return;
          }
          return archiveEvent(id);
        }
        if (act === "admin-unpost") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 관리할 수 있습니다.");
            return;
          }
          return unpostEvent(id);
        }
        if (act === "group-maker") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 관리할 수 있습니다.");
            return;
          }
          return openGroupMakerModal(id);
        }
        if (act === "admin-delete") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 이벤트를 관리할 수 있습니다.");
            return;
          }
          return deleteEvent(id);
        }
        if (act === "export-xlsx") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 명단을 다운로드할 수 있습니다.");
            return;
          }
          return exportApplicantsXLSX(id);
        }
        if (act === "write-review") return openReviewModal(id);
        if (act === "admin-confirm-activity") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 활동을 관리할 수 있습니다.");
            return;
          }
          return confirmActivity(id);
        }
        if (act === "admin-cancel-activity") {
          if (!isFullAdmin()) {
            showAlert("🔒", "관리자만 활동을 관리할 수 있습니다.");
            return;
          }
          return cancelActivity(id);
        }
      }

      // 이벤트 순서 변경 버튼 클릭 이벤트 리스너
      document.addEventListener("click", (e) => {
        if (e.target.closest('[data-act="move-event-up"]')) {
          const eventId = e.target.closest('[data-act="move-event-up"]').dataset
            .id;
          moveEventUp(eventId);
        }

        if (e.target.closest('[data-act="move-event-down"]')) {
          const eventId = e.target.closest('[data-act="move-event-down"]')
            .dataset.id;
          moveEventDown(eventId);
        }
      });

      // 이벤트 데이터를 폼에 로드하는 함수
      function loadEventToForm(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) return;

        editingEventId = eventId;

        // null 체크 추가
        const eventType = document.getElementById("event-type");
        const eventTitle = document.getElementById("event-title");
        const eventDatetime = document.getElementById("event-datetime");
        const eventRegistrationStart = document.getElementById(
          "event-registration-start"
        );
        const eventDeadline = document.getElementById("event-deadline");
        const eventLimit = document.getElementById("event-limit");
        const eventStatus = document.getElementById("event-status");

        if (eventType) eventType.value = event.type || "tasting";
        if (eventTitle) eventTitle.value = event.title || "";
        if (eventDatetime) eventDatetime.value = event.datetime || "";
        if (eventRegistrationStart)
          eventRegistrationStart.value = event.registrationStart || "";
        if (eventDeadline) eventDeadline.value = event.deadline || "";
        if (eventLimit) eventLimit.value = event.limit || "";
        if (eventStatus) eventStatus.value = event.status || "open";

        // 회비 정보 로드 (MT/총회인 경우)
        const p = event.payment || {};
        const payBank = document.getElementById("pay-bank");
        const payNumber = document.getElementById("pay-number");
        const payHolder = document.getElementById("pay-holder");
        const payAmount = document.getElementById("pay-amount");
        const payNote = document.getElementById("pay-note");

        if (payBank) payBank.value = p.bank || "";
        if (payNumber) payNumber.value = p.number || "";
        if (payHolder) payHolder.value = p.holder || "";
        if (payAmount) payAmount.value = p.amount || "";
        if (payNote) payNote.value = p.note || "";

        // 회비 섹션 표시/숨김 처리
        const paymentSection = document.getElementById("payment-section");
        if (paymentSection) {
          if (event.type === "mt" || event.type === "assembly") {
            paymentSection.classList.remove("hidden");
          } else {
            paymentSection.classList.add("hidden");
          }
        }

        // 식당 정보 로드
        const wrap = document.getElementById("event-restaurants-wrap");
        if (wrap) {
          if (event.type === "tasting" && event.restaurants) {
            wrap.innerHTML =
              event.restaurants
                .map((r) =>
                  createRestaurantFieldHTML(
                    r.name || "",
                    r.info || "",
                    r.capacity || "",
                    r.category || "기타"
                  )
                )
                .join("") || createRestaurantFieldHTML();
          } else {
            wrap.innerHTML = createRestaurantFieldHTML();
          }
        }
      }

      /* ===== 평가 작성 기능 ===== */
      function openReviewModal(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) return;

        const existingReview = event.reviews?.find(
          (r) => r.studentId === currentUser.studentId
        );

        document.getElementById(
          "review-modal-title"
        ).textContent = `${event.title} 평가`;
        document.getElementById("review-modal-content").innerHTML = `
          <div class="space-y-4">
            <div class="text-sm text-gray-600">
              <p><strong>이벤트:</strong> ${saf(event.title)}</p>
              <p><strong>일시:</strong> ${new Date(
                event.datetime
              ).toLocaleDateString("ko-KR")}</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">평점</label>
              <div class="flex gap-1 mb-2 items-center" id="rating-stars">
                ${Array.from({ length: 5 }, (_, i) => {
                  const rating = i + 1;
                  const currentRating = existingReview?.rating || 0;
                  const isSelected = rating <= currentRating;

                  return `<button type="button" class="star-rating-btn text-3xl transition-all hover:scale-110" data-rating="${rating}">
                    <i class="fas fa-star ${
                      isSelected ? "text-yellow-400" : "text-gray-300"
                    }"></i>
                  </button>`;
                }).join("")}
              </div>
              <p class="text-xs text-gray-500 text-center">
                1점 단위로 평가할 수 있습니다 (별을 클릭하세요)
              </p>
              <div class="text-center mt-2">
                <span class="text-2xl font-bold text-orange-600" id="current-rating-display">${
                  existingReview?.rating || 0
                }</span>
                <span class="text-sm text-gray-600">점</span>
              </div>
            </div>
            
            <div>
              <label for="review-comment" class="block text-sm font-medium text-gray-700 mb-2">후기</label>
              <textarea id="review-comment" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" 
                        placeholder="이벤트에 대한 소감이나 후기를 남겨주세요...">${
                          existingReview?.comment || ""
                        }</textarea>
            </div>
            
            <div class="flex gap-3 pt-4">
              <button type="button" id="save-review" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                <i class="fas fa-save mr-2"></i>
                ${existingReview ? "수정하기" : "저장하기"}
              </button>
              <button type="button" id="cancel-review" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                취소
              </button>
            </div>
          </div>
        `;

        // 별점 클릭 이벤트 (0.5점 단위)
        let selectedRating = existingReview?.rating || 0;

        const updateStarDisplay = (rating) => {
          document.querySelectorAll(".star-rating-btn").forEach((btn) => {
            const btnRating = parseFloat(btn.dataset.rating);
            const star = btn.querySelector("i");

            // star 요소가 존재하는지 확인
            if (star) {
              if (btnRating <= rating) {
                star.classList.remove("text-gray-300");
                star.classList.add("text-yellow-400");
              } else {
                star.classList.remove("text-yellow-400");
                star.classList.add("text-gray-300");
              }
            }
          });

          // 현재 점수 표시 업데이트
          const ratingDisplay = document.getElementById(
            "current-rating-display"
          );
          if (ratingDisplay) {
            ratingDisplay.textContent = rating;
          }
        };

        // 별 클릭 이벤트
        document.querySelectorAll(".star-rating-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            selectedRating = parseFloat(btn.dataset.rating);
            updateStarDisplay(selectedRating);
          });
        });

        // 저장 버튼 이벤트
        document
          .getElementById("save-review")
          .addEventListener("click", async () => {
            const comment = document
              .getElementById("review-comment")
              .value.trim();
            if (selectedRating === 0) {
              showAlert("⚠️", "평점을 선택해주세요.");
              return;
            }

            try {
              await saveEventReview(eventId, selectedRating, comment);
              closeReviewModal();
              renderHistoryTab(isAdmin);
              showAlert("✅", "평가가 저장되었습니다.");
            } catch (error) {
              showAlert("😥", "평가 저장 중 오류가 발생했습니다.");
            }
          });

        // 취소 버튼 이벤트
        document
          .getElementById("cancel-review")
          .addEventListener("click", closeReviewModal);

        document.getElementById("review-modal").classList.remove("hidden");
      }

      async function saveEventReview(eventId, rating, comment) {
        const eventRef = doc(db, "events", eventId);

        await runTransaction(db, async (transaction) => {
          const eventDoc = await transaction.get(eventRef);
          if (!eventDoc.exists()) throw new Error("이벤트를 찾을 수 없습니다.");

          const eventData = eventDoc.data();
          const reviews = eventData.reviews || [];

          // 기존 평가 찾아서 업데이트하거나 새로 추가
          const existingIndex = reviews.findIndex(
            (r) => r.studentId === currentUser.studentId
          );
          const review = {
            studentId: currentUser.studentId,
            studentName: currentUser.name,
            rating: rating,
            comment: comment,
            timestamp: new Date().toISOString(),
            createdAt:
              existingIndex >= 0
                ? reviews[existingIndex].createdAt
                : new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          };

          if (existingIndex >= 0) {
            reviews[existingIndex] = review;
          } else {
            reviews.push(review);
          }

          transaction.update(eventRef, { reviews: reviews });
        });
      }

      function closeReviewModal() {
        document.getElementById("review-modal").classList.add("hidden");
      }

      // 평가 모달 이벤트 리스너
      document.addEventListener("click", (e) => {
        if (
          e.target.id === "review-modal-close" ||
          e.target.closest("#review-modal-close")
        ) {
          closeReviewModal();
        }
        if (e.target.id === "review-modal" && !e.target.closest(".bg-white")) {
          closeReviewModal();
        }
      });

      /* ===== 블록 관리 모달 기능 ===== */
      function openBlockModal(
        blockType = null,
        blockId = null,
        position = null
      ) {
        const modal = document.getElementById("block-management-modal");
        const title = document.getElementById("block-modal-title");
        const content = document.getElementById("block-modal-content");

        if (blockType && blockId) {
          // 편집 모드
          console.log("=== 블록 수정 모드 ===");
          console.log("blockType:", blockType);
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          const block = blocksData.find((b) => b.id === blockId);
          console.log("찾은 블록:", block);

          if (!block) {
            console.error("블록을 찾을 수 없습니다");
            return;
          }

          title.textContent = `${getBlockTypeName(blockType)} 블록 수정`;
          content.innerHTML = generateBlockForm(blockType, block);

          // 기존 데이터 로드 (편집 모드일 때만)
          setTimeout(() => {
            const loadExistingData = () => {
              console.log("=== loadExistingData 호출됨 (편집 모드) ===");
              console.log("blockType:", blockType);
              console.log("block:", block);

              if (blockType === "scores") {
                if (block?.payload?.teams) {
                  console.log("기존 팀 데이터 로드 중...", block.payload.teams);
                  block.payload.teams.forEach((team) => {
                    console.log("팀 추가:", team);
                    addModalScoreRow(team.name || "", team.score || 0);
                  });
                } else {
                  console.log("새 블록 생성 - 기본 행 추가");
                  addModalScoreRow("", 0);
                }
              } else if (blockType === "qa") {
                if (block?.payload?.items) {
                  block.payload.items.forEach((item) => {
                    addModalQAItem(item.q || "", item.a || "");
                  });
                } else {
                  addModalQAItem("", "");
                }
              }
            };
            loadExistingData();
          }, 100);
        } else {
          // 생성 모드
          title.textContent = "새 공지 추가";
          content.innerHTML = generateBlockTypeSelector();
        }

        modal.classList.remove("hidden");
      }

      function closeBlockModal() {
        document
          .getElementById("block-management-modal")
          .classList.add("hidden");
      }

      // Make functions globally accessible for onclick handlers
      window.closeBlockModal = closeBlockModal;
      window.addModalScoreRow = addModalScoreRow;
      window.addModalQAItem = addModalQAItem;

      // 모든 직책을 기본 상태로 리셋하는 함수
      async function resetAllPositions() {
        try {
          // 회장단: 회장, 부회장만
          const presidentPositions = ["회장", "부회장"];
          await setDoc(doc(db, "settings", "presidentPositions"), {
            positions: presidentPositions,
          });

          // 일반 임원: 운영진만
          const regularPositions = ["운영진"];
          await setDoc(doc(db, "settings", "regularPositions"), {
            positions: regularPositions,
          });

          showAlert("✅", "모든 직책이 기본 상태로 리셋되었습니다.");
          console.log("리셋된 회장단:", presidentPositions);
          console.log("리셋된 일반 임원:", regularPositions);

          // 페이지 새로고침
          location.reload();
        } catch (e) {
          console.error(e);
          showAlert("😥", "직책 리셋에 실패했습니다.");
        }
      }

      // 전역 함수로 등록
      window.resetAllPositions = resetAllPositions;
      window.removePositionFromCategory = removePositionFromCategory;

      // 특정 직책을 강제로 완전 제거하는 함수
      async function forceRemovePosition(position) {
        console.log("=== 강제 직책 제거 함수 호출 ===");
        console.log("제거할 직책:", position);

        try {
          // 양쪽에서 모두 제거
          const newPresidentPositions = presidentPositions.filter(
            (p) => p !== position
          );
          const newRegularPositions = regularPositions.filter(
            (p) => p !== position
          );

          console.log("제거 후 회장단:", newPresidentPositions);
          console.log("제거 후 일반 임원:", newRegularPositions);

          // Firebase에 동시 저장
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: newPresidentPositions,
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: newRegularPositions,
            }),
          ]);

          // 해당 직책을 가진 모든 관리자에서 제거
          const newAdminPositions = { ...adminPositions };
          Object.keys(newAdminPositions).forEach((studentId) => {
            if (newAdminPositions[studentId] === position) {
              delete newAdminPositions[studentId];
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: newAdminPositions,
          });

          presidentPositions = newPresidentPositions;
          regularPositions = newRegularPositions;

          showAlert("✅", `"${position}" 직책이 완전히 제거되었습니다.`);
          console.log("강제 제거 완료");
          location.reload();
        } catch (e) {
          console.error(e);
          showAlert("😥", "강제 제거에 실패했습니다.");
        }
      }

      // 전역 함수로 등록
      window.forceRemovePosition = forceRemovePosition;

      // Firebase 데이터를 직접 확인하고 정리하는 함수
      async function debugAndFixPositions() {
        console.log("=== Firebase 데이터 진단 시작 ===");

        try {
          // Firebase에서 직접 데이터 가져오기
          const [presidentSnap, regularSnap] = await Promise.all([
            getDoc(doc(db, "settings", "presidentPositions")),
            getDoc(doc(db, "settings", "regularPositions")),
          ]);

          const firebasePresidentPositions = presidentSnap.exists()
            ? presidentSnap.data().positions
            : [];
          const firebaseRegularPositions = regularSnap.exists()
            ? regularSnap.data().positions
            : [];

          console.log("Firebase 회장단:", firebasePresidentPositions);
          console.log("Firebase 일반 임원:", firebaseRegularPositions);
          console.log("로컬 회장단:", presidentPositions);
          console.log("로컬 일반 임원:", regularPositions);

          // 중복된 직책 찾기
          const duplicates = firebasePresidentPositions.filter((pos) =>
            firebaseRegularPositions.includes(pos)
          );

          if (duplicates.length > 0) {
            console.log("중복된 직책 발견:", duplicates);

            // 중복 제거: 일반 임원에서만 유지
            const cleanPresidentPositions = firebasePresidentPositions.filter(
              (pos) => !firebaseRegularPositions.includes(pos)
            );

            console.log("정리된 회장단:", cleanPresidentPositions);

            // Firebase에 저장
            await setDoc(doc(db, "settings", "presidentPositions"), {
              positions: cleanPresidentPositions,
            });

            console.log("중복 제거 완료!");
            showAlert("✅", "중복된 직책이 제거되었습니다.");
            location.reload();
          } else {
            console.log("중복된 직책이 없습니다.");
            showAlert("ℹ️", "중복된 직책이 없습니다.");
          }
        } catch (e) {
          console.error("진단 중 오류:", e);
          showAlert("😥", "진단 중 오류가 발생했습니다.");
        }
      }

      // 전역 함수로 등록
      window.debugAndFixPositions = debugAndFixPositions;

      // 완전히 깨끗하게 정리하는 함수
      async function cleanAllPositions() {
        console.log("=== 완전 정리 시작 ===");

        try {
          // 회장단: 회장, 부회장만
          const cleanPresidentPositions = ["회장", "부회장"];

          // 일반 임원: 운영진만
          const cleanRegularPositions = ["운영진"];

          console.log("정리할 회장단:", cleanPresidentPositions);
          console.log("정리할 일반 임원:", cleanRegularPositions);

          // Firebase에 동시 저장
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: cleanPresidentPositions,
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: cleanRegularPositions,
            }),
          ]);

          // 모든 관리자에서 개발자 직책 제거
          const newAdminPositions = { ...adminPositions };
          Object.keys(newAdminPositions).forEach((studentId) => {
            if (newAdminPositions[studentId] === "개발자") {
              delete newAdminPositions[studentId];
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: newAdminPositions,
          });

          console.log("완전 정리 완료!");
          showAlert("✅", "모든 직책이 기본 상태로 정리되었습니다.");
          location.reload();
        } catch (e) {
          console.error("정리 중 오류:", e);
          showAlert("😥", "정리 중 오류가 발생했습니다.");
        }
      }

      // 전역 함수로 등록
      window.cleanAllPositions = cleanAllPositions;

      // Firebase 데이터를 강제로 덮어쓰는 함수
      async function forceOverwritePositions() {
        console.log("=== 강제 덮어쓰기 시작 ===");

        try {
          // 1단계: Firebase 데이터 강제 덮어쓰기
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: ["회장", "부회장"],
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: ["운영진"],
            }),
          ]);

          console.log("Firebase 데이터 덮어쓰기 완료");

          // 2단계: 모든 관리자에서 개발자 직책 제거
          const newAdminPositions = {};
          Object.keys(adminPositions).forEach((studentId) => {
            const position = adminPositions[studentId];
            if (position && position !== "개발자") {
              newAdminPositions[studentId] = position;
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: newAdminPositions,
          });

          console.log("관리자 직책 정리 완료");

          // 3단계: 로컬 변수 강제 업데이트
          presidentPositions = ["회장", "부회장"];
          regularPositions = ["운영진"];

          console.log("로컬 변수 업데이트 완료");

          // 4단계: 2초 후 새로고침 (Firebase 동기화 시간 확보)
          setTimeout(() => {
            showAlert("✅", "강제 정리 완료! 새로고침합니다.");
            location.reload();
          }, 2000);
        } catch (e) {
          console.error("강제 덮어쓰기 중 오류:", e);
          showAlert("😥", "강제 덮어쓰기 중 오류가 발생했습니다.");
        }
      }

      // 전역 함수로 등록
      window.forceOverwritePositions = forceOverwritePositions;

      // 리스너를 중단하고 강제로 정리하는 함수
      async function nuclearCleanPositions() {
        console.log("=== 핵 정리 시작 ===");

        try {
          // 1단계: Firebase 리스너 중단
          if (unsubPublic.presidentPositions) {
            unsubPublic.presidentPositions();
            unsubPublic.presidentPositions = null;
            console.log("회장단 리스너 중단");
          }

          if (unsubPublic.regularPositions) {
            unsubPublic.regularPositions();
            unsubPublic.regularPositions = null;
            console.log("일반 임원 리스너 중단");
          }

          // 2단계: Firebase 데이터 강제 덮어쓰기 (여러 번 시도)
          for (let i = 0; i < 3; i++) {
            await Promise.all([
              setDoc(doc(db, "settings", "presidentPositions"), {
                positions: ["회장", "부회장"],
              }),
              setDoc(doc(db, "settings", "regularPositions"), {
                positions: ["운영진"],
              }),
            ]);
            console.log(`Firebase 덮어쓰기 ${i + 1}회 완료`);
            await new Promise((resolve) => setTimeout(resolve, 500)); // 0.5초 대기
          }

          // 3단계: 관리자 데이터 정리
          const cleanAdminPositions = {};
          Object.keys(adminPositions).forEach((studentId) => {
            const position = adminPositions[studentId];
            if (position && position !== "개발자") {
              cleanAdminPositions[studentId] = position;
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: cleanAdminPositions,
          });

          // 4단계: 로컬 변수 강제 업데이트
          presidentPositions = ["회장", "부회장"];
          regularPositions = ["운영진"];

          console.log("핵 정리 완료!");
          showAlert("✅", "핵 정리 완료! 새로고침합니다.");

          // 5단계: 리스너 재시작을 위해 페이지 새로고침
          setTimeout(() => {
            location.reload();
          }, 1000);
        } catch (e) {
          console.error("핵 정리 중 오류:", e);
          showAlert("😥", "핵 정리 중 오류가 발생했습니다.");
        }
      }

      // 전역 함수로 등록
      window.nuclearCleanPositions = nuclearCleanPositions;

      // 최종 해결 함수 - 모든 것을 완전히 정리
      async function finalSolution() {
        console.log("=== 최종 해결 시작 ===");

        try {
          // 1단계: 모든 Firebase 리스너 중단
          if (unsubPublic.presidentPositions) {
            unsubPublic.presidentPositions();
            unsubPublic.presidentPositions = null;
          }
          if (unsubPublic.regularPositions) {
            unsubPublic.regularPositions();
            unsubPublic.regularPositions = null;
          }
          console.log("모든 리스너 중단 완료");

          // 2단계: Firebase 데이터 완전 삭제 후 재생성
          await deleteDoc(doc(db, "settings", "presidentPositions"));
          await deleteDoc(doc(db, "settings", "regularPositions"));
          console.log("기존 문서 삭제 완료");

          // 3단계: 새로운 깨끗한 데이터 생성
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: ["회장", "부회장"],
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: ["운영진"],
            }),
          ]);
          console.log("새로운 데이터 생성 완료");

          // 4단계: 관리자 데이터에서 개발자 완전 제거
          const cleanAdminPositions = {};
          Object.keys(adminPositions).forEach((studentId) => {
            const position = adminPositions[studentId];
            if (position && position !== "개발자") {
              cleanAdminPositions[studentId] = position;
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: cleanAdminPositions,
          });
          console.log("관리자 데이터 정리 완료");

          // 5단계: 로컬 변수 강제 업데이트
          presidentPositions = ["회장", "부회장"];
          regularPositions = ["운영진"];

          console.log("최종 해결 완료!");
          showAlert("🎉", "최종 해결 완료! 새로고침합니다.");

          // 6단계: 새로고침
          setTimeout(() => {
            location.reload();
          }, 2000);
        } catch (e) {
          console.error("최종 해결 중 오류:", e);
          showAlert("😥", "최종 해결 중 오류가 발생했습니다.");
        }
      }

      // 전역 함수로 등록
      window.finalSolution = finalSolution;

      function getBlockTypeName(type) {
        const names = {
          notice: "공지",
          qa: "Q&A",
          scores: "커스텀 점수판",
          roadmap: "로드맵",
        };
        return names[type] || type;
      }

      function generateBlockTypeSelector() {
        return `
          <div class="space-y-4">
            <h4 class="text-lg font-semibold text-gray-700">블록 타입 선택</h4>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <button type="button" class="p-4 border-2 border-orange-200 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition-colors" onclick="selectBlockType('notice')">
                <div class="text-center">
                  <i class="fas fa-bullhorn text-2xl text-orange-500 mb-2"></i>
                  <h5 class="font-semibold text-gray-800">공지 블록</h5>
                  <p class="text-sm text-gray-600">중요한 공지사항을 표시합니다</p>
                </div>
              </button>
              <button type="button" class="p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors" onclick="selectBlockType('qa')">
                <div class="text-center">
                  <i class="fas fa-question-circle text-2xl text-blue-500 mb-2"></i>
                  <h5 class="font-semibold text-gray-800">Q&A 블록</h5>
                  <p class="text-sm text-gray-600">자주 묻는 질문과 답변</p>
                </div>
              </button>
              <button type="button" class="p-4 border-2 border-green-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-colors" onclick="selectBlockType('scores')">
                <div class="text-center">
                  <i class="fas fa-trophy text-2xl text-green-500 mb-2"></i>
                  <h5 class="font-semibold text-gray-800">점수판 블록</h5>
                  <p class="text-sm text-gray-600">팀별 점수와 순위 표시</p>
                </div>
              </button>
                </div>
              </button>
            </div>
          </div>
        `;
      }

      function selectBlockType(type) {
        const content = document.getElementById("block-modal-content");
        const title = document.getElementById("block-modal-title");

        title.textContent = `${getBlockTypeName(type)} 블록 생성`;
        content.innerHTML = generateBlockForm(type);
      }

      // Make selectBlockType function globally accessible for onclick handlers
      window.selectBlockType = selectBlockType;

      function generateBlockForm(type, existingBlock = null) {
        const isEdit = !!existingBlock;

        if (type === "notice") {
          return `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="modal-notice-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="제목" value="${
                  existingBlock?.title || ""
                }">
                <select id="modal-notice-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="true" ${
                    existingBlock?.visible !== false ? "selected" : ""
                  }>노출</option>
                  <option value="false" ${
                    existingBlock?.visible === false ? "selected" : ""
                  }>숨김</option>
                </select>
                <select id="modal-notice-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="" ${
                    !existingBlock?.showWhen ? "selected" : ""
                  }>항상 표시</option>
                  <option value="login" ${
                    existingBlock?.showWhen === "login" ? "selected" : ""
                  }>로그인시만</option>
                  <option value="logout" ${
                    existingBlock?.showWhen === "logout" ? "selected" : ""
                  }>로그아웃시만</option>
                </select>
              </div>
              <textarea id="modal-notice-html" rows="6" class="w-full px-3 py-2 border rounded" placeholder="내용(HTML/텍스트)">${
                existingBlock?.payload?.html || ""
              }</textarea>
              <div class="flex gap-3">
                <button type="button" onclick="saveBlock('notice', '${
                  existingBlock?.id || ""
                }')" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>${
                          isEdit ? "수정" : "생성"
                        }
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          `;
          loadExistingData();
        }

        if (type === "qa") {
          return `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="modal-qa-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="제목" value="${
                  existingBlock?.title || ""
                }">
                <select id="modal-qa-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="true" ${
                    existingBlock?.visible !== false ? "selected" : ""
                  }>노출</option>
                  <option value="false" ${
                    existingBlock?.visible === false ? "selected" : ""
                  }>숨김</option>
                </select>
                <select id="modal-qa-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="" ${
                    !existingBlock?.showWhen ? "selected" : ""
                  }>항상 표시</option>
                  <option value="login" ${
                    existingBlock?.showWhen === "login" ? "selected" : ""
                  }>로그인시만</option>
                  <option value="logout" ${
                    existingBlock?.showWhen === "logout" ? "selected" : ""
                  }>로그아웃시만</option>
                </select>
              </div>
              <div id="modal-qa-items" class="space-y-2"></div>
              <button type="button" onclick="addModalQAItem()" class="text-sm bg-blue-100 text-blue-700 border border-blue-300 px-3 py-1 rounded hover:bg-blue-200 transition-colors">
                <i class="fas fa-plus mr-1"></i>질문 추가
              </button>
              <div class="flex gap-3">
                <button type="button" onclick="saveBlock('qa', '${
                  existingBlock?.id || ""
                }')" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>${
                          isEdit ? "수정" : "생성"
                        }
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          `;
          loadExistingData();
        }

        if (type === "scores") {
          return `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="modal-scores-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="블록 이름(제목)" value="${
                  existingBlock?.title || ""
                }">
                <select id="modal-scores-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="true" ${
                    existingBlock?.visible !== false ? "selected" : ""
                  }>노출</option>
                  <option value="false" ${
                    existingBlock?.visible === false ? "selected" : ""
                  }>숨김</option>
                </select>
                <select id="modal-scores-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="" ${
                    !existingBlock?.showWhen ? "selected" : ""
                  }>항상 표시</option>
                  <option value="login" ${
                    existingBlock?.showWhen === "login" ? "selected" : ""
                  }>로그인시만</option>
                  <option value="logout" ${
                    existingBlock?.showWhen === "logout" ? "selected" : ""
                  }>로그아웃시만</option>
                </select>
              </div>
              <div id="modal-scores-rows" class="space-y-2"></div>
              <button type="button" onclick="addModalScoreRow()" class="text-sm bg-green-100 text-green-700 border border-green-300 px-3 py-1 rounded hover:bg-green-200 transition-colors">
                <i class="fas fa-plus mr-1"></i>팀 추가
              </button>
              <div class="flex gap-3">
                <button type="button" onclick="saveBlock('scores', '${
                  existingBlock?.id || ""
                }')" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>${
                          isEdit ? "수정" : "생성"
                        }
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          `;
        }

        if (type === "roadmap") {
          return `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="modal-roadmap-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="활동 이름" value="${
                  existingBlock?.title || ""
                }">
                <input id="modal-roadmap-date" type="date" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" value="${
                  existingBlock?.payload?.date || ""
                }">
                <select id="modal-roadmap-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="true" ${
                    existingBlock?.visible !== false ? "selected" : ""
                  }>노출</option>
                  <option value="false" ${
                    existingBlock?.visible === false ? "selected" : ""
                  }>숨김</option>
                </select>
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">표시 조건</label>
                  <select id="modal-roadmap-showWhen" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="" ${
                    !existingBlock?.showWhen ? "selected" : ""
                  }>항상 표시</option>
                  <option value="login" ${
                    existingBlock?.showWhen === "login" ? "selected" : ""
                  }>로그인시만</option>
                  <option value="logout" ${
                    existingBlock?.showWhen === "logout" ? "selected" : ""
                  }>로그아웃시만</option>
                </select>
                <input id="modal-roadmap-order" type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="순서 (숫자가 작을수록 앞에 표시)" value="${
                  existingBlock?.order || ""
                }">
              </div>
              <textarea id="modal-roadmap-description" rows="3" class="w-full px-3 py-2 border rounded" placeholder="활동 설명 (선택사항)">${
                existingBlock?.payload?.description || ""
              }</textarea>
              <div class="flex gap-2">
                <button type="button" onclick="saveBlock('roadmap', '${
                  existingBlock?.id || ""
                }')" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>${
                          isEdit ? "수정" : "생성"
                        }
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  취소
                </button>
              </div>
            </div>
          `;
          loadExistingData();
        }

        return '<p class="text-gray-500">알 수 없는 블록 타입입니다.</p>';
      }

      // 블록 저장 함수
      async function saveBlock(type, blockId = null) {
        try {
          const isEdit = !!blockId;

          if (type === "notice") {
            const title = document
              .getElementById("modal-notice-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-notice-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-notice-showWhen")?.value || "";
            const html =
              document.getElementById("modal-notice-html")?.value || "";

            if (!title) {
              showAlert("😥", "제목을 입력해주세요.");
              return;
            }

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "notice",
                title,
                visible,
                showWhen,
                payload: { html },
              });
              showAlert("✅", "공지 블록이 수정되었습니다.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "notice",
                title,
                visible,
                showWhen,
                payload: { html },
                order: ord,
              });
              showAlert("🎉", "공지 블록이 추가되었습니다.");
            }
          }

          if (type === "qa") {
            const title = document
              .getElementById("modal-qa-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-qa-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-qa-showWhen")?.value || "";
            const items = getModalQAItems();

            if (!title) {
              showAlert("😥", "제목을 입력해주세요.");
              return;
            }
            if (items.length === 0) {
              showAlert("😥", "질문/답변을 1개 이상 입력하세요.");
              return;
            }

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "qa",
                title,
                visible,
                showWhen,
                payload: { items },
              });
              showAlert("✅", "Q&A 블록이 수정되었습니다.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "qa",
                title,
                visible,
                showWhen,
                payload: { items },
                order: ord,
              });
              showAlert("🎉", "Q&A 블록이 추가되었습니다.");
            }
          }

          if (type === "scores") {
            const title = document
              .getElementById("modal-scores-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-scores-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-scores-showWhen")?.value || "";
            const teams = getModalScoreTeams();

            if (!title) {
              showAlert("😥", "블록 이름을 입력해주세요.");
              return;
            }
            if (teams.length === 0) {
              showAlert("😥", "최소 1개 이상의 조를 추가해주세요.");
              return;
            }

            const payload = { teams };

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "scores",
                title,
                visible,
                showWhen,
                payload,
              });
              showAlert("✅", "점수판 블록이 수정되었습니다.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "scores",
                title,
                visible,
                showWhen,
                payload,
                order: ord,
              });
              showAlert("🎉", "점수판 블록이 추가되었습니다.");
            }
          }

          if (type === "roadmap") {
            const title = document
              .getElementById("modal-roadmap-title")
              ?.value.trim();
            const date = document.getElementById("modal-roadmap-date")?.value;
            const visible =
              document.getElementById("modal-roadmap-visible")?.value ===
              "true";
            const showWhen =
              document.getElementById("modal-roadmap-showWhen")?.value || "";
            const order =
              parseInt(document.getElementById("modal-roadmap-order")?.value) ||
              0;
            const description =
              document
                .getElementById("modal-roadmap-description")
                ?.value.trim() || "";

            if (!title) {
              showAlert("😥", "활동 이름을 입력해주세요.");
              return;
            }
            if (!date) {
              showAlert("😥", "활동 날짜를 선택해주세요.");
              return;
            }

            const payload = { date, description };

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "roadmap",
                title,
                visible,
                showWhen,
                order,
                payload,
              });
              showAlert("✅", "로드맵 블록이 수정되었습니다.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "roadmap",
                title,
                visible,
                showWhen,
                order: order || ord,
                payload,
              });
              showAlert("🎉", "로드맵 블록이 추가되었습니다.");
            }
          }

          closeBlockModal();
          // 블록 목록 새로고침
          if (document.getElementById("subtab-container")) {
            renderHomeBlocksAdmin(document.getElementById("subtab-container"));
          }
        } catch (error) {
          console.error("블록 저장 오류:", error);
          showAlert("😥", "저장 중 오류가 발생했습니다.");
        }
      }

      // Make saveBlock function globally accessible for onclick handlers
      window.saveBlock = saveBlock;

      // 모달 Q&A 아이템 수집
      function getModalQAItems() {
        const rows = [...document.querySelectorAll("#modal-qa-items .qa-row")];
        return rows
          .map((row) => ({
            q: row.querySelector("[data-q]")?.value.trim() || "",
            a: row.querySelector("[data-a]")?.value.trim() || "",
          }))
          .filter((item) => item.q && item.a);
      }

      // 모달 점수 팀 수집
      function getModalScoreTeams() {
        const rows = [
          ...document.querySelectorAll("#modal-scores-rows .score-row"),
        ];
        return rows
          .map((row) => ({
            name: row.querySelector("[data-name]")?.value.trim() || "",
            score: Number(row.querySelector("[data-score]")?.value || 0),
          }))
          .filter((team) => team.name);
      }

      // 모달 Q&A 아이템 추가
      function addModalQAItem(q = "", a = "") {
        const container = document.getElementById("modal-qa-items");
        if (!container) return;

        container.insertAdjacentHTML(
          "beforeend",
          `
          <div class="qa-row border rounded-lg p-4 bg-gray-50 mb-3">
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">질문</label>
              <textarea data-q class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 min-h-[80px] resize-y" placeholder="질문을 입력하세요&#10;줄바꿈(Enter)으로 문단을 나눌 수 있습니다">${saf(
                q
              )}</textarea>
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">답변</label>
              <textarea data-a class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 min-h-[120px] resize-y" placeholder="답변을 입력하세요&#10;줄바꿈(Enter)으로 문단을 나눌 수 있습니다">${saf(
                a
              )}</textarea>
            </div>
            <div class="flex justify-end">
              <button type="button" class="remove-qa bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors" onclick="this.closest('.qa-row').remove()">
                <i class="fas fa-trash mr-1"></i>삭제
              </button>
            </div>
          </div>
        `
        );
      }

      // 모달 점수 행 추가
      function addModalScoreRow(name = "", score = 0) {
        console.log("=== addModalScoreRow 호출 ===");
        console.log("name:", name, "score:", score);

        const container = document.getElementById("modal-scores-rows");
        console.log("container:", container);

        if (!container) {
          console.error("modal-scores-rows 컨테이너를 찾을 수 없습니다");
          return;
        }

        // 중복 팀 이름 체크 (빈 이름이 아닌 경우에만)
        if (name.trim()) {
          const existingRows = container.querySelectorAll(".score-row");
          for (const row of existingRows) {
            const existingName = row.querySelector("[data-name]")?.value.trim();
            if (existingName && existingName === name.trim()) {
              showAlert("😥", `"${name}" 팀이 이미 존재합니다.`);
              return;
            }
          }
        }

        container.insertAdjacentHTML(
          "beforeend",
          `
          <div class="score-row grid grid-cols-12 gap-2">
            <input data-name class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-7" placeholder="조 이름" value="${saf(
              name
            )}">
            <input data-score type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-4" placeholder="점수" value="${saf(
              score
            )}">
            <button type="button" class="remove-score-row text-red-600 col-span-1" onclick="this.closest('.score-row').remove()">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `
        );
        console.log("점수 행 추가 완료");
      }

      // 블록 관리 모달 이벤트 리스너
      document.addEventListener("click", (e) => {
        if (
          e.target.id === "block-modal-close" ||
          e.target.closest("#block-modal-close")
        ) {
          closeBlockModal();
        }
        if (
          e.target.id === "block-management-modal" &&
          !e.target.closest(".bg-white")
        ) {
          closeBlockModal();
        }
      });

      // 자동 마감 스케줄러 초기화
      setupAutoCloseScheduler();

      // ===================== (끝) =====================
    </script>

    <!-- 블록 관리 모달 -->
    <div
      id="block-management-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9996]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="block-modal-title" class="text-2xl font-bold text-gray-800">
            블록 관리
          </h3>
          <button
            id="block-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="block-modal-content">
          <!-- 블록 관리 폼이 여기에 동적으로 로드됩니다 -->
        </div>
      </div>
    </div>

    <!-- 평가 작성 모달 -->
    <div
      id="review-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9997]"
    >
      <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-md w-full">
        <div class="flex justify-between items-center mb-6">
          <h3 id="review-modal-title" class="text-xl font-bold text-gray-800">
            이벤트 평가
          </h3>
          <button
            id="review-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="review-modal-content">
          <!-- 평가 폼이 여기에 동적으로 로드됩니다 -->
        </div>
      </div>
    </div>

    <!-- 이벤트 생성/수정 모달 -->
    <!-- 미식회 생성 모달 -->
    <div
      id="tasting-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9998]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="tasting-modal-title" class="text-2xl font-bold text-gray-800">
            🍽️ 미식회 만들기
          </h3>
          <button
            id="tasting-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
            title="닫기"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="tasting-modal-content">
          <!-- 미식회 생성 폼이 여기에 동적으로 로드됩니다 -->
        </div>
      </div>
    </div>

    <!-- 이벤트 생성 모달 -->
    <div
      id="event-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9998]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="event-modal-title" class="text-2xl font-bold text-gray-800">
            📅 이벤트 만들기
          </h3>
          <button
            id="event-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
            title="닫기"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="event-modal-content">
          <!-- 이벤트 생성 폼이 여기에 동적으로 로드됩니다 -->
        </div>
      </div>
    </div>

    <script>
      // 임시: 회장단에 기존 직책들 복원하는 함수
      async function restorePresidentPositions() {
        try {
          const positionsToAdd = ["총무", "기획부장", "홍보부장"];
          const currentPositions = [...presidentPositions];

          // 이미 있는 직책은 제외하고 추가
          const newPositions = [...currentPositions];
          positionsToAdd.forEach((pos) => {
            if (!newPositions.includes(pos)) {
              newPositions.push(pos);
            }
          });

          await setDoc(doc(db, "settings", "presidentPositions"), {
            positions: newPositions,
          });

          showAlert("✅", "회장단에 기존 직책들이 복원되었습니다.");
          console.log("복원된 회장단 직책:", newPositions);
        } catch (e) {
          console.error(e);
          showAlert("😥", "직책 복원에 실패했습니다.");
        }
      }

      // 전역 함수로 등록
      window.restorePresidentPositions = restorePresidentPositions;

      // 모든 직책을 기본 상태로 리셋하는 함수
      async function resetAllPositions() {
        try {
          // 회장단: 회장, 부회장만
          const presidentPositions = ["회장", "부회장"];
          await setDoc(doc(db, "settings", "presidentPositions"), {
            positions: presidentPositions,
          });

          // 일반 임원: 운영진만
          const regularPositions = ["운영진"];
          await setDoc(doc(db, "settings", "regularPositions"), {
            positions: regularPositions,
          });

          showAlert("✅", "모든 직책이 기본 상태로 리셋되었습니다.");
          console.log("리셋된 회장단:", presidentPositions);
          console.log("리셋된 일반 임원:", regularPositions);

          // 페이지 새로고침
          location.reload();
        } catch (e) {
          console.error(e);
          showAlert("😥", "직책 리셋에 실패했습니다.");
        }
      }
    </script>
  </body>
</html>
