<!DOCTYPE html>
<html lang="ko" style="height: 100%; height: -webkit-fill-available">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#6366f1" />
    <title>Foodie</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Foodie" />
    <meta property="og:description" content="Foodie ë™ì•„ë¦¬ ì›¹ ì„œë¹„ìŠ¤" />
    <meta property="og:image" content="./icons/icon-512-new.png" />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta property="og:url" content="" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:title" content="Foodie" />
    <meta property="twitter:description" content="Foodie ë™ì•„ë¦¬ ì›¹ ì„œë¹„ìŠ¤" />
    <meta property="twitter:image" content="./icons/icon-512-new.png" />

    <!-- ì¼ë°˜ ë©”íƒ€ -->
    <meta name="description" content="Foodie ë™ì•„ë¦¬ ì›¹ ì„œë¹„ìŠ¤" />

    <!-- ì•± ì•„ì´ì½˜ -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./icons/favicon-32.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./icons/apple-touch-icon-180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="./icons/icon-192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="./icons/icon-512.png"
    />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Loading Animation -->
    <style>
      @keyframes dot-pulse {
        0%,
        100% {
          transform: scale(0.5);
          opacity: 0.3;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      @keyframes bounce {
        0%,
        100% {
          transform: scale(1) translateY(0);
        }
        50% {
          transform: scale(1.1) translateY(-10px);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(-10px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out;
      }

      /* ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œ íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes smoothFade {
        0% {
          opacity: 0;
          transform: translateY(10px) scale(0.95);
        }
        15% {
          opacity: 0;
          transform: translateY(10px) scale(0.95);
        }
        50% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        85% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-10px) scale(0.95);
        }
      }

      .smooth-fade {
        animation: smoothFade 2.5s ease-in-out;
        display: inline-block;
      }

      /* ë§í’ì„  ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      .speech-bubble-btn {
        position: relative;
        background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }

      .speech-bubble-btn::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 20px;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #ff6b6b;
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.1));
      }

      .speech-bubble-btn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .speech-bubble-btn:active {
        transform: translateY(0) scale(1);
      }

      @keyframes wiggle {
        0%,
        100% {
          transform: rotate(0deg);
        }
        25% {
          transform: rotate(-5deg);
        }
        75% {
          transform: rotate(5deg);
        }
      }

      .speech-bubble-btn:hover {
        animation: wiggle 0.5s ease-in-out;
      }

      /* ëª¨ë°”ì¼ í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ */
      * {
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
      }

      /* ëª¨ë°”ì¼ì—ì„œ í…ìŠ¤íŠ¸ í¬ê¸° ìµœì í™” */
      @media (max-width: 768px) {
        .text-sm {
          font-size: 0.875rem !important;
        }
        .text-base {
          font-size: 1rem !important;
        }
        .text-lg {
          font-size: 1.125rem !important;
        }
        .text-xl {
          font-size: 1.25rem !important;
        }
        .text-2xl {
          font-size: 1.5rem !important;
        }

        /* ê¸´ í…ìŠ¤íŠ¸ ìë™ ì¤„ë°”ê¿ˆ */
        .truncate {
          white-space: normal !important;
          overflow: visible !important;
          text-overflow: unset !important;
        }

        /* ëª¨ë°”ì¼ í™•ëŒ€ ë°©ì§€ ë° ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        body {
          -webkit-text-size-adjust: 100%;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          touch-action: manipulation;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        ::-webkit-scrollbar {
          width: 0px;
          background: transparent;
        }

        ::-webkit-scrollbar-track {
          background: transparent;
        }

        ::-webkit-scrollbar-thumb {
          background: transparent;
        }

        /* Firefoxìš© ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        html {
          scrollbar-width: none;
        }

        /* ë¯¸ì‹íšŒ ì‹ë‹¹/ë¦¬ë·°ëŠ” ì¹´ë“œ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì—†ì´ í˜ì´ì§€ ì „ì²´ ìŠ¤í¬ë¡¤ë§Œ ì‚¬ìš© */

        /* ì „ì²´ í™”ë©´ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        body {
          overflow-x: hidden;
        }

        /* ëª¨ë°”ì¼ì—ì„œ í™•ëŒ€ ë°©ì§€ */
        @media (max-width: 768px) {
          html {
            -webkit-text-size-adjust: none;
            -ms-text-size-adjust: none;
          }

          input,
          textarea,
          select {
            font-size: 16px !important;
          }
        }

        /* ë¸”ë¡ ì œëª© ìµœì í™” */
        .block-title {
          word-break: keep-all;
          line-height: 1.4;
          hyphens: auto;
        }

        /* ì¹´ë“œ ë‚´ í…ìŠ¤íŠ¸ ìµœì í™” */
        .card-text {
          word-break: keep-all;
          line-height: 1.5;
          overflow-wrap: break-word;
        }

        /* ë²„íŠ¼ í…ìŠ¤íŠ¸ ìµœì í™” */
        .btn-text {
          white-space: normal;
          word-break: keep-all;
        }

        /* ëª¨ë°”ì¼ì—ì„œ íŒ¨ë”© ì¡°ì • */
        .mobile-padding {
          padding-left: 0.75rem;
          padding-right: 0.75rem;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë§ˆì§„ ì¡°ì • */
        .mobile-margin {
          margin-left: 0.5rem;
          margin-right: 0.5rem;
        }
      }
    </style>
    <script>
      tailwind.config = {
        future: {
          hoverOnlyWhenSupported: true,
        },
        experimental: {
          optimizeUniversalDefaults: true,
        },
        // CDN ì‚¬ìš© ê²½ê³  ë¬´ì‹œ
        theme: {
          extend: {},
        },
      };
    </script>

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- FontAwesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>

    <!-- Kakao SDK -->
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>

    <!-- XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- DOMPurify (XSS ë°©ì§€) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

    <style>
      :root {
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
      }
      html,
      body {
        height: 100%;
        min-height: 100%;
        min-height: -webkit-fill-available;
      }
      body {
        font-family: "Noto Sans KR", sans-serif;
        margin: 0;
        min-height: 100vh;
        min-height: 100svh;
        min-height: 100dvh;
        min-height: -webkit-fill-available;
        padding-top: var(--safe-top);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .card-hover {
        transition: 0.3s;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      /* ë¡œë”© í™”ë©´ */
      #loading-screen {
        display: flex !important;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #ffffff;
        position: fixed !important;
        inset: 0 !important;
        width: 100% !important;
        height: 100vh !important;
        height: 100svh !important;
        height: 100lvh !important;
        height: 100dvh !important;
        min-height: 100vh !important;
        min-height: 100svh !important;
        min-height: 100lvh !important;
        min-height: 100dvh !important;
        min-height: -webkit-fill-available !important;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        z-index: 9999 !important;
        overflow: hidden !important;
      }

      #loading-screen::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
            circle at 20% 20%,
            rgba(249, 115, 22, 0.08),
            transparent 45%
          ),
          radial-gradient(
            circle at 80% 30%,
            rgba(251, 191, 36, 0.08),
            transparent 55%
          ),
          radial-gradient(
            circle at 50% 80%,
            rgba(248, 113, 113, 0.06),
            transparent 50%
          );
        opacity: 0.8;
        pointer-events: none;
        animation: loading-fade 12s ease-in-out infinite;
      }

      @keyframes loading-fade {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .modern-loader {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
        padding: 16px;
      }

      .loading-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
        padding: 28px 36px;
        border-radius: 28px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(249, 115, 22, 0.12);
        box-shadow: 0 25px 45px -20px rgba(249, 115, 22, 0.35),
          0 10px 25px -15px rgba(15, 23, 42, 0.25);
        backdrop-filter: blur(12px);
        max-width: 320px;
        text-align: center;
      }

      .loading-foods {
        display: flex;
        gap: 18px;
      }

      .loading-foods .food-icon {
        font-size: 2.6rem;
        animation: food-bounce 1.2s ease-in-out infinite;
        transform-origin: bottom center;
        filter: drop-shadow(0 8px 12px rgba(15, 23, 42, 0.15));
      }

      .loading-foods .food-icon:nth-child(2) {
        animation-delay: 0.15s;
      }
      .loading-foods .food-icon:nth-child(3) {
        animation-delay: 0.3s;
      }
      .loading-foods .food-icon:nth-child(4) {
        animation-delay: 0.45s;
      }

      @keyframes food-bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-14px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .loading-logo {
        font-size: 1.8rem;
        font-weight: 800;
        letter-spacing: 2px;
      }

      .loading-subtitle {
        font-size: 0.95rem;
        color: #6b7280;
        line-height: 1.5;
      }

      .loading-tip {
        font-size: 0.85rem;
        color: #94a3b8;
        text-align: center;
      }

      @media (max-width: 640px) {
        .loading-card {
          padding: 24px 28px;
          gap: 16px;
        }
        .loading-foods {
          gap: 14px;
        }
        .loading-foods .food-icon {
          font-size: 2.2rem;
        }
        .loading-logo {
          font-size: 1.6rem;
        }
        .loading-subtitle {
          font-size: 0.9rem;
        }
      }

      /* Foodie ë¡œê³  ìŠ¤íƒ€ì¼ (ë¹›ë‚˜ëŠ” íš¨ê³¼ ì œê±°) */
      .logo-glow {
        color: #f97316 !important;
      }

      @keyframes rank-gradient-shift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .tab-btn {
        position: relative;
        overflow: hidden;
      }
      .tab-btn.active {
        color: #fff;
        background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
        box-shadow: 0 6px 12px rgba(249, 115, 22, 0.3),
          0 2px 4px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      .tab-btn:not(.active) {
        background: #ffffff;
        border: 2px solid #e5e7eb;
      }
      .tab-btn:not(.active):hover {
        background: #fff7ed;
        border-color: #fdba74;
        box-shadow: 0 2px 8px rgba(249, 115, 22, 0.15);
        transform: translateY(-1px);
      }

      /* ì¹´í…Œê³ ë¦¬ í•„í„° ë²„íŠ¼ (ë¯¸ì‹íšŒ/ë­ë¨¹ì§€) */
      .category-filter-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        line-height: 1.2;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .category-filter-btn .category-emoji {
        font-size: 1.2rem;
        line-height: 1;
      }

      .category-filter-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 15px -12px rgba(15, 23, 42, 0.3);
      }

      @media (max-width: 640px) {
        .category-filter-btn {
          gap: 0.35rem;
          font-size: 0.85rem !important;
          padding: 0.35rem 0.65rem !important;
        }
        .category-filter-btn .category-emoji {
          font-size: 1.05rem;
        }
      }
      .roadmap-subtab.active {
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          padding 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 0;
        opacity: 0;
        will-change: max-height, padding, opacity;
      }

      .accordion-item.active .accordion-content {
        max-height: 2000px;
        padding: 0;
        opacity: 1;
      }

      .accordion-item.active .accordion-icon {
        transform: rotate(180deg);
      }
      .accordion-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: background-color;
      }
      .accordion-header:hover {
        background-color: rgba(0, 0, 0, 0.02);
      }
      .accordion-header .fa-chevron-down,
      .accordion-icon {
        flex: 0 0 auto;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
      }
      .accordion-item.active .accordion-header .fa-chevron-down,
      .accordion-item.active .accordion-icon {
        transform: rotate(180deg);
      }

      /* 120Hz ë””ìŠ¤í”Œë ˆì´ ì§€ì› */
      @media (min-resolution: 120dpi) {
        .accordion-content {
          transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            padding 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-header {
          transition: background-color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-header .fa-chevron-down,
        .accordion-icon {
          transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* ë¡œë“œë§µ ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ */
      .roadmap-accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        will-change: max-height, opacity;
      }

      .roadmap-accordion-content.expanded {
        max-height: 2000px;
        opacity: 1;
        padding-top: 1rem;
      }

      .roadmap-accordion-content.expanded .roadmap-timeline {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
      }

      /* 120Hz ë””ìŠ¤í”Œë ˆì´ ì§€ì› */
      @media (min-resolution: 120dpi) {
        .roadmap-accordion-content {
          transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* ì¼ì • ë¸”ë¡ ìŠ¤íƒ€ì¼ */
      .schedule-blocks-container {
        display: grid;
        gap: 1rem;
        margin-top: 1rem;
      }

      /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
      .schedule-blocks-container {
        grid-template-columns: 1fr;
      }

      /* ëª¨ë°”ì¼: 2ê°œì”© (320px ~ 640px) */
      @media (max-width: 640px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
          gap: 0.75rem;
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* ì‘ì€ íƒœë¸”ë¦¿: 2ê°œì”© (641px ~ 768px) */
      @media (min-width: 641px) and (max-width: 768px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* íƒœë¸”ë¦¿: 2ê°œì”© (769px ~ 1024px) */
      @media (min-width: 769px) and (max-width: 1024px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* ë°ìŠ¤í¬í†±: 3ê°œì”© (1025px ~ 1280px) */
      @media (min-width: 1025px) and (max-width: 1280px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(3, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 4) {
          display: none;
        }
      }

      /* ëŒ€í˜• ë°ìŠ¤í¬í†±: 4ê°œì”© (1281px ~ 1440px) */
      @media (min-width: 1281px) and (max-width: 1440px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(4, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 5) {
          display: none;
        }
      }

      /* ì´ˆëŒ€í˜• í™”ë©´: 4ê°œì”© (1441px+) */
      @media (min-width: 1441px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(4, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 5) {
          display: none;
        }
      }

      /* ì¼ì • ë¸”ë¡ ì¹´ë“œ */
      .schedule-block {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .schedule-block:hover {
        border-color: #f97316;
        box-shadow: 0 8px 25px rgba(249, 115, 22, 0.15);
        transform: translateY(-2px);
      }

      /* ë‹¤ìŒ ì¼ì • ê°•ì¡° */
      .schedule-block.next-schedule {
        border: 2px solid #fb923c;
        background: white;
        box-shadow: 0 4px 20px rgba(249, 115, 22, 0.15);
      }

      .schedule-block.next-schedule::before {
        content: "ë‹¤ìŒ ì¼ì •";
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
      }

      /* ì™„ë£Œëœ ì¼ì • */
      .schedule-block.completed {
        opacity: 0.7;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-color: #d1d5db;
      }

      .schedule-block.completed::before {
        content: "ì™„ë£Œ";
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: #ef4444;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      }

      /* ë¸”ë¡ ë‚´ìš© */
      .schedule-block-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .schedule-block-date {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .schedule-block-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        line-height: 1.4;
        flex-grow: 1;
      }

      .schedule-block-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
      }

      .schedule-action-btn {
        padding: 0.5rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
      }

      .schedule-edit-btn {
        background: #3b82f6;
        color: white;
      }

      .schedule-edit-btn:hover {
        background: #2563eb;
        transform: scale(1.05);
      }

      .schedule-delete-btn {
        background: #ef4444;
        color: white;
      }

      .schedule-delete-btn:hover {
        background: #dc2626;
        transform: scale(1.05);
      }

      .schedule-download-btn {
        background: #10b981;
        color: white;
      }

      .schedule-download-btn:hover {
        background: #059669;
        transform: scale(1.05);
      }

      /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
      .calendar-container {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        padding: 1.5rem;
        padding-bottom: 2rem; /* í•˜ë‹¨ íŒ¨ë”© ì¦ê°€ */
        margin-top: 1rem;
        margin-bottom: 1rem; /* í•˜ë‹¨ ë§ˆì§„ ì¶”ê°€ */
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        min-height: 500px;
        width: 100%;
        max-width: 100%;
        overflow: visible;
      }

      .calendar-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f97316;
      }

      .calendar-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .calendar-nav-prev {
        order: 1;
      }

      .calendar-month-year {
        order: 2;
        flex: 1;
        text-align: center;
      }

      .calendar-nav-next {
        order: 3;
      }

      .calendar-nav-btn {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.375rem 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        min-width: 2rem;
        height: 2rem;
      }

      .calendar-nav-btn:hover {
        background: linear-gradient(135deg, #ea580c, #dc2626);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      }

      .calendar-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        text-align: center;
      }

      .calendar-nav-btn {
        background: #f97316;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }

      .calendar-nav-btn:hover {
        background: #ea580c;
        transform: scale(1.05);
      }

      .calendar-nav-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
      }

      .calendar-month-year {
        font-size: 1.125rem;
        font-weight: 600;
        color: #374151;
        min-width: 150px;
        text-align: center;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #e5e7eb;
        border-radius: 8px;
        min-height: 450px; /* ë°ìŠ¤í¬í†±ì—ì„œë„ ì¶©ë¶„í•œ ë†’ì´ í™•ë³´ */
        overflow: hidden;
        width: 100%;
        table-layout: fixed;
      }

      .calendar-day-header {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.875rem;
      }

      .calendar-day {
        background: white;
        min-height: 100px;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .calendar-day:hover {
        background: #fef3c7;
      }

      .calendar-day.other-month {
        background: #f9fafb;
        color: #9ca3af;
      }

      .calendar-day.today {
        background: linear-gradient(135deg, #fff7ed, #fed7aa);
        border: 2px solid #f97316;
      }

      .calendar-day-number {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }

      .calendar-event {
        background: #f97316;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: visible;
        white-space: normal;
        line-height: 1.3;
        margin-bottom: 0.125rem;
        width: 100%;
        max-width: 100%;
        min-width: 0;
        flex-shrink: 0;
        box-sizing: border-box;
        /* ê¸€ì í¬ê¸° ìë™ ì¡°ì •ì„ ìœ„í•œ ì„¤ì • */
        font-size: clamp(0.625rem, 2.5vw, 0.75rem);
        transform-origin: center;
        text-align: center;
      }

      .calendar-event:hover {
        background: #ea580c;
        transform: scale(1.05);
      }

      .calendar-event.completed {
        background: #ef4444;
      }

      .calendar-event.completed:hover {
        background: #dc2626;
      }

      .calendar-event.next {
        background: #10b981;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      }

      .calendar-event.next:hover {
        background: #059669;
      }

      /* ë‹¬ë ¥ ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ í¬ê¸° í´ë˜ìŠ¤ */
      .calendar-event.text-xs {
        font-size: 0.625rem;
      }

      .calendar-event.text-sm {
        font-size: 0.6875rem;
      }

      /* ìš´ì˜ì§„ ì „ìš© ì¼ì • ìŠ¤íƒ€ì¼ (íŒŒë€ìƒ‰) */
      .calendar-event.admin-only {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
        color: white !important;
        border: 1px solid #1e40af !important;
        font-weight: 500;
      }

      .calendar-event.admin-only:hover {
        background: linear-gradient(135deg, #2563eb, #1e40af) !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }

      /* ë‹¬ë ¥ ë°˜ì‘í˜• */
      @media (max-width: 768px) {
        .calendar-container {
          padding: 0.75rem;
          padding-bottom: 1.5rem; /* ëª¨ë°”ì¼ì—ì„œë„ í•˜ë‹¨ íŒ¨ë”© ì¦ê°€ */
          margin-top: 0.5rem;
          margin-bottom: 1rem; /* ëª¨ë°”ì¼ì—ì„œë„ í•˜ë‹¨ ë§ˆì§„ ì¶”ê°€ */
          border-radius: 12px;
          width: 100%;
          max-width: 100%;
          overflow: visible;
        }

        .calendar-header {
          flex-direction: column;
          gap: 0.75rem;
          text-align: center;
          margin-bottom: 1rem;
          padding-bottom: 0.75rem;
        }

        .calendar-nav-btn {
          padding: 0.25rem 0.5rem;
          font-size: 0.75rem;
          min-width: 1.75rem;
          height: 1.75rem;
        }

        .calendar-title {
          font-size: 1.25rem;
        }

        .calendar-nav-btn {
          width: 36px;
          height: 36px;
          padding: 0.375rem;
        }

        .calendar-month-year {
          font-size: 1rem;
          min-width: 120px;
        }

        .calendar-grid {
          min-height: 400px; /* ìµœì†Œ ë†’ì´ ì¦ê°€ */
          grid-template-columns: repeat(7, 1fr);
          width: 100%;
          table-layout: fixed;
        }

        .calendar-day {
          min-height: 70px;
          padding: 0.25rem;
          overflow: hidden;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }

        .calendar-day-number {
          font-size: 0.75rem;
          margin-bottom: 0.125rem;
        }

        .calendar-event {
          font-size: clamp(0.5rem, 2vw, 0.625rem);
          padding: 0.1875rem 0.375rem;
          border-radius: 8px;
          white-space: nowrap;
          overflow: hidden;
          line-height: 1.1;
          width: 100%;
          max-width: 100%;
          flex-shrink: 0;
          box-sizing: border-box;
          transform-origin: center;
        }

        .calendar-day-header {
          padding: 0.5rem 0.25rem;
          font-size: 0.75rem;
        }

        /* ëª¨ë°”ì¼ ë‹¬ë ¥ ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ í¬ê¸° í´ë˜ìŠ¤ */
        .calendar-event.text-xs {
          font-size: 0.5rem;
        }

        .calendar-event.text-sm {
          font-size: 0.5625rem;
        }

        /* ëª¨ë°”ì¼ ìš´ì˜ì§„ ì „ìš© ì¼ì • ìŠ¤íƒ€ì¼ */
        .calendar-event.admin-only {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
          color: white !important;
          border: 1px solid #1e40af !important;
          font-weight: 500;
        }
      }

      /* í™”ë©´ ê¹œë¹¡ê±°ë¦¼ ë°©ì§€ë¥¼ ìœ„í•œ ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
      .smooth-transition {
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      }

      .content-loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .content-loaded {
        opacity: 1;
        pointer-events: auto;
      }

      /* ê´€ë¦¬ì íŒ¨ë„ ë° íŠ¹ì • ì˜ì—­ì—ì„œ í…ìŠ¤íŠ¸ ë³µì‚¬ í—ˆìš© */
      #dashboard-overlay,
      #dashboard-overlay *,
      .admin-panel,
      .admin-panel *,
      #subtab-container,
      #subtab-container *,
      .member-card,
      .member-card *,
      .footer-selectable,
      .footer-selectable *,
      input,
      textarea,
      select {
        -webkit-user-select: text !important;
        -khtml-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
      }

      /* ë²„íŠ¼ê³¼ ì•„ì´ì½˜ì€ ì—¬ì „íˆ ì„ íƒ ë¶ˆê°€ */
      button,
      button *,
      .fa,
      .fas,
      .far,
      .fab {
        -webkit-user-select: none !important;
        -khtml-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
      }

      /* ë¡œê³  ì´ë¯¸ì§€ ë°°ê²½ìƒ‰ ë³€ê²½ */
      .logo-image {
        background: linear-gradient(135deg, #f97316, #ea580c);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(249, 115, 22, 0.2);
        transition: all 0.3s ease;
      }

      .logo-image:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(249, 115, 22, 0.3);
      }

      /* ë¡œê³  ì´ë¯¸ì§€ ë‚´ë¶€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ë§ */
      .logo-image img {
        border-radius: 8px;
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
      }

      /* ëª¨ë°”ì¼ ì¼ì • ë¸”ë¡ ìµœì í™” */
      @media (max-width: 640px) {
        .schedule-blocks-container {
          gap: 0.75rem;
          margin-top: 0.75rem;
        }

        .schedule-block {
          padding: 0.875rem;
          border-radius: 10px;
          min-height: 120px;
        }

        .schedule-block-title {
          font-size: 0.9375rem;
          margin-bottom: 0.5rem;
          line-height: 1.3;
        }

        .schedule-block-date {
          font-size: 0.75rem;
          margin-bottom: 0.25rem;
        }

        .schedule-action-btn {
          padding: 0.25rem;
          font-size: 0.6875rem;
          min-height: 28px;
        }

        .schedule-block.next-schedule::before,
        .schedule-block.completed::before {
          font-size: 0.5625rem;
          padding: 0.125rem 0.375rem;
          top: 0.375rem;
          right: 0.375rem;
        }
      }

      /* ë§¤ìš° ì‘ì€ ëª¨ë°”ì¼ í™”ë©´ */
      @media (max-width: 480px) {
        .schedule-blocks-container {
          gap: 0.5rem;
          margin-top: 0.5rem;
        }

        .schedule-block {
          padding: 0.75rem;
          border-radius: 8px;
          min-height: 100px;
        }

        .schedule-block-title {
          font-size: 0.875rem;
          margin-bottom: 0.375rem;
          line-height: 1.2;
        }

        .schedule-block-date {
          font-size: 0.6875rem;
          margin-bottom: 0.25rem;
        }

        .schedule-action-btn {
          padding: 0.1875rem;
          font-size: 0.625rem;
          min-height: 24px;
        }

        .schedule-block.next-schedule::before,
        .schedule-block.completed::before {
          font-size: 0.5rem;
          padding: 0.125rem 0.25rem;
          top: 0.25rem;
          right: 0.25rem;
        }
      }

      .roadmap-item {
        position: relative;
        padding-left: 30px;
        padding-bottom: 1.25rem;
      }
      .roadmap-item:not(:last-child) {
        padding-bottom: 2rem;
      }
      .roadmap-item:not(:last-child)::before {
        content: "";
        position: absolute;
        left: 7px;
        top: 16px;
        width: 2px;
        height: 100%;
        background: #e2e8f0;
      }
      .roadmap-item.completed:not(:last-child)::before {
        background: #6366f1;
      }
      .roadmap-item::after {
        content: "";
        position: absolute;
        left: 0;
        top: 4px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #e2e8f0;
      }
      .roadmap-item.completed::after {
        border-color: #6366f1;
        background: #6366f1;
      }
      .roadmap-item.today::after {
        border-color: #f59e0b;
        background: #f59e0b;
      }
      .table-sticky th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 1;
      }
      input,
      select,
      textarea {
        font-size: 16px !important;
      }
      .btn-lg {
        padding: 0.8rem 1rem;
        border-radius: 0.65rem;
        font-weight: 700;
      }
      .input-lg {
        padding: 0.85rem 1rem;
        border-radius: 0.65rem;
      }
      .section {
        background: #fff;
        border-radius: 1.25rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04),
          0 8px 24px rgba(0, 0, 0, 0.06);
        padding: 1rem;
      }
      @media (min-width: 768px) {
        .section {
          padding: 1.5rem;
        }
      }
      .thumb {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
      }
      .dz {
        width: 64px;
        height: 64px;
        border: 2px dashed #c7d2fe;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #4f46e5;
        cursor: pointer;
        background: #eef2ff;
      }
      .dz.drag {
        border-color: #6366f1;
        background: #e0e7ff;
      }
      .dz-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border-radius: 0.5rem;
      }
      #presence-pop {
        position: absolute;
        transform: translateY(8px);
      }
      .subtab-btn.active {
        background: #111827;
        color: #fff;
      }
      .sortable li {
        user-select: none;
      }
      .dragging {
        opacity: 0.5;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
      }
      /* íƒ€ì…ë³„ ì¹´ë“œ ìƒë‹¨ ë³´ë”(ì§ê´€ì  ìƒ‰ìƒ) */
      .accent-tasting {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-general {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-mt {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-assembly {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      body {
        background: #f3f4f6;
        color: #111827;
      }
      .section {
        background: #ffffff;
      }
      #presence-pop,
      .accordion-content,
      .prose {
        color: #111827;
      }

      /* ==== ìˆ˜í‰ ë¡œë“œë§µ (ë¡œê·¸ì¸ í›„) ==== */
      .h-roadmap {
        display: flex;
        flex-direction: row;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 8px;
        scroll-snap-type: x mandatory;
        scrollbar-width: thin;
      }
      .h-item {
        min-width: 220px;
        scroll-snap-align: start;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 12px;
        padding: 12px;
        position: relative;
        transition: transform 0.2s;
      }
      .h-item:hover {
        transform: translateY(-2px);
      }
      .h-item.completed {
        opacity: 0.65;
        filter: grayscale(0.15);
      }
      .h-item.today::after {
        content: "ì˜¤ëŠ˜";
        position: absolute;
        top: 8px;
        right: 10px;
        font-size: 11px;
        color: #f59e0b;
        font-weight: 700;
      }
      .v-item {
        width: 100%;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        position: relative;
        transition: transform 0.2s;
      }
      .v-item:hover {
        transform: translateY(-2px);
      }
      .v-item.completed {
        opacity: 0.65;
        filter: grayscale(0.15);
      }
      .v-item.today::after {
        content: "ì˜¤ëŠ˜";
        position: absolute;
        top: 8px;
        right: 10px;
        font-size: 11px;
        color: #f59e0b;
        font-weight: 700;
      }

      .h-pulse {
        animation: hblink 1.6s ease-out infinite;
      }

      /* ==== ì»´íŒ©íŠ¸ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë¡œë“œë§µ (ë¡œê·¸ì¸ í™”ë©´ìš©) ==== */
      .roadmap-timeline {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        overflow-x: auto;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }

      .roadmap-timeline::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      .timeline-item {
        flex: 0 0 180px;
        min-width: 180px;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .timeline-content {
        background: white;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        border: 1px solid #f3f4f6;
        height: 100%;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 100px;
      }

      .timeline-content:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        border-color: #fb923c;
      }

      .timeline-admin-buttons {
        display: flex;
        gap: 4px;
        margin-left: 8px;
      }

      .timeline-edit-btn,
      .timeline-delete-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
      }

      .timeline-edit-btn {
        background: #3b82f6;
        color: white;
      }

      .timeline-edit-btn:hover {
        background: #2563eb;
        transform: scale(1.1);
      }

      .timeline-delete-btn {
        background: #ef4444;
        color: white;
      }

      .timeline-delete-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      .timeline-item.completed .timeline-content {
        opacity: 0.8;
        background: #fef7ed;
        border-color: #fed7aa;
      }

      /* ê´€ë¦¬ììš© ìƒˆ ì¼ì • ì¶”ê°€ ë¸”ë¡ ìŠ¤íƒ€ì¼ */
      .timeline-item.admin-placeholder .timeline-content {
        background: #fff7ed;
        border: 2px dashed #fb923c;
        opacity: 0.9;
        transition: all 0.3s ease;
      }

      .timeline-item.admin-placeholder .timeline-content:hover {
        background: #fed7aa;
        border-color: #ea580c;
        opacity: 1;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(251, 146, 60, 0.15);
      }

      .admin-placeholder-content {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .admin-placeholder-icon {
        color: #ea580c;
        font-size: 20px;
        background: #fed7aa;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .timeline-item.admin-placeholder:hover .admin-placeholder-icon {
        background: #fdba74;
        transform: scale(1.1);
      }

      .admin-placeholder-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .admin-placeholder-title {
        font-weight: 600;
        color: #c2410c;
        font-size: 13px;
      }

      .admin-placeholder-subtitle {
        font-size: 11px;
        color: #ea580c;
        line-height: 1.3;
      }

      .timeline-add-btn {
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .timeline-add-btn:hover {
        background: #4b5563;
        transform: scale(1.1);
      }

      .timeline-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 6px;
        font-size: 13px;
        line-height: 1.3;
        min-height: auto;
        display: flex;
        align-items: flex-start;
        flex-wrap: wrap;
        word-break: keep-all;
        overflow-wrap: break-word;
      }

      .timeline-date {
        font-size: 11px;
        color: #6b7280;
        font-weight: 500;
        margin-top: auto;
        padding-top: 6px;
        border-top: 1px solid #f3f4f6;
      }

      .timeline-today-badge {
        display: inline-block;
        background: #fed7aa;
        color: #ea580c;
        padding: 1px 6px;
        border-radius: 8px;
        font-size: 9px;
        font-weight: 600;
        margin-left: 6px;
        margin-top: 1px;
      }

      /* ëª¨ë°”ì¼ ìµœì í™” */
      @media (max-width: 768px) {
        .roadmap-timeline {
          gap: 8px;
          padding: 8px 0;
        }

        .timeline-item {
          flex: 0 0 140px;
          min-width: 140px;
        }

        .timeline-content {
          padding: 8px;
          min-height: 85px;
        }

        .timeline-title {
          font-size: 11px;
          min-height: 2.2em;
        }

        .timeline-date {
          font-size: 9px;
        }
      }
      @keyframes hblink {
        0% {
          box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.45);
        }
        70% {
          box-shadow: 0 0 0 14px rgba(99, 102, 241, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
        }
      }

      /* ==== ì°¸ê°€ì ì¹´ë“œí˜• ë¦¬ìŠ¤íŠ¸ (í…ìŠ¤íŠ¸ ì„ íƒ ê°€ëŠ¥ ìœ ì§€) ==== */
      .participants-wrap {
        display: grid;
        gap: 6px;
      }
      .participant-chip {
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: 10px;
        padding: 6px 8px;
      }
      .participant-chip .avatar {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--accent);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* ==== ëª¨ë“  í™”ë©´ì—ì„œ ë²„íŠ¼ ë°©ì‹ ìˆœì„œë³€ê²½ ==== */
      .mobile-reorder {
        display: flex;
        gap: 6px;
      }
      .mobile-reorder button {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 4px 8px;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
      }
      .mobile-reorder button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
      }
      .mobile-reorder button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .grip {
        display: none !important;
      } /* ëª¨ë“  í™”ë©´ì—ì„œ ë“œë˜ê·¸ í•¸ë“¤ ìˆ¨ê¹€ */
      .sortable [draggable="true"] {
        cursor: default;
      }

      /* ë‹¤í¬ëª¨ë“œì—ì„œ ì•½ê°„ ë” ëŒ€ë¹„ */
      [data-theme="dark"] .accordion-item.active .accordion-content {
        background: #0f1422;
        border-radius: 12px;
      }
      [data-theme="dark"] .dz {
        background: #0f1422;
        border-color: #233055;
        color: #a5b4fc;
      }

      /* ëª¨ë°”ì¼ ìµœì í™” - ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
      @media (max-width: 768px) {
        .block-admin-controls {
          position: absolute !important;
          top: 0.5rem !important;
          right: 0.5rem !important;
          bottom: auto !important;
        }

        .accordion-header {
          padding: 1rem !important;
        }

        .accordion-header h3 {
          font-size: 1rem !important;
          line-height: 1.4 !important;
        }

        .section {
          margin-bottom: 1rem !important;
        }

        .participant-chip {
          flex-direction: column !important;
          align-items: flex-start !important;
          gap: 0.5rem !important;
        }

        .event-card {
          padding: 1rem !important;
        }

        .event-card h3 {
          font-size: 1rem !important;
          margin-bottom: 0.5rem !important;
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-100 flex flex-col min-h-screen"
    style="min-height: 100vh; min-height: -webkit-fill-available"
  >
    <!-- Loading -->
    <div
      id="loading-screen"
      class="flex flex-col items-center justify-center bg-white fixed inset-0 w-full h-full z-[9999] overflow-hidden"
      style="
        min-height: -webkit-fill-available;
        z-index: 9999;
        overflow: hidden;
      "
    >
      <!-- ì‹¬í”Œí•˜ê³  ì„¸ë ¨ëœ ë¡œë”© í™”ë©´ -->
      <div class="modern-loader">
        <div class="loading-card">
          <div class="loading-foods" aria-hidden="true">
            <span class="food-icon">ğŸœ</span>
            <span class="food-icon">ğŸ£</span>
            <span class="food-icon">ğŸ•</span>
            <span class="food-icon">ğŸ°</span>
          </div>
          <div class="loading-logo logo-glow">Foodie</div>
          <p class="loading-subtitle">ì „ë¶ëŒ€í•™êµ ë§›ì§‘ íƒë°© ë™ì•„ë¦¬ âœ¨</p>
          <button
            id="loading-retry-btn"
            type="button"
            class="hidden mt-4 inline-flex items-center justify-center px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold rounded-full transition-colors duration-200 shadow-sm"
          >
            <i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì‹œë„
          </button>
        </div>
        <p class="loading-tip">í˜ì´ì§€ ë¯¸í‘œì‹œì‹œ ìˆ˜ë™ìœ¼ë¡œ ì¬ì—°ê²° í•´ì£¼ì„¸ìš”!</p>
      </div>
    </div>

    <div
      class="container mx-auto px-3 sm:px-4 md:px-6 py-4 md:py-8 flex-grow max-w-6xl"
    >
      <header class="text-center mb-6 md:mb-10 relative">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <!-- ë­ë¨¹ì§€ ë²„íŠ¼ (ë§¨ ì™¼ìª½) -->
          <button
            id="header-food-btn"
            class="speech-bubble-btn"
            style="margin-top: 0px"
            aria-label="ì‹ì‚¬ ì¶”ì²œ ë°›ê¸°"
            title="ì˜¤ëŠ˜ ë­ë¨¹ì„ì§€ ì¶”ì²œë°›ê¸°"
          >
            <span style="font-size: 14px" aria-hidden="true">ğŸ½ï¸</span>
            <span>ë­ë¨¹ì§€?</span>
          </button>

          <!-- ì ‘ì†ì ëª…ë‹¨ê³¼ ì¡°ëª¨ì„ ìˆœìœ„ - ëª¨ë“  í™”ë©´ì—ì„œ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ë°€ì°© -->
          <div
            id="game-buttons-container"
            class="flex items-center gap-2 ml-auto"
            role="group"
            aria-label="í—¤ë” ì•¡ì…˜ ë²„íŠ¼"
          >
            <!-- ì ‘ì†ì(ëª¨ë‘ ë³´ì„) -->
            <button
              id="presence-badge"
              class="text-sm md:text-base bg-gray-800 text-white rounded-full px-3 py-1 hover:bg-gray-700"
              aria-label="í˜„ì¬ ì ‘ì†ì ë³´ê¸°"
              aria-expanded="false"
              aria-controls="presence-pop"
              title="í˜„ì¬ ì ‘ì†ì ëª©ë¡"
            >
              <span aria-hidden="true">ğŸ‘¥</span>
              <b id="presence-count" aria-label="ì ‘ì†ì ìˆ˜">0</b>ëª…
            </button>
            <!-- ì¡°ëª¨ì„ ìˆœìœ„(ëª¨ë‘ ë³´ì„) -->
            <button
              id="rank-button"
              class="text-sm md:text-base bg-orange-500 text-white rounded-full px-3 py-1 hover:bg-orange-600 transition-all flex items-center gap-1.5"
              aria-label="ì¡°ëª¨ì„ ìˆœìœ„ ë³´ê¸°"
              title="ì¡°ëª¨ì„ ìˆœìœ„"
            >
              <span aria-hidden="true">ğŸ…</span> ì¡°ëª¨ì„
            </button>
            <!-- ë‚´ í™œë™ ë²„íŠ¼ -->
            <button
              id="notification-badge"
              class="text-sm md:text-base bg-orange-500 text-white rounded-full px-3 py-1 hover:bg-orange-600 shadow-md hover:shadow-lg transition-all relative flex items-center gap-1.5"
              aria-label="ë‚´ í™œë™ ì—´ê¸°"
              aria-expanded="false"
              aria-controls="notification-pop"
              title="ë‚´ í™œë™ ì—´ê¸°"
            >
              <i class="fas fa-user-circle" aria-hidden="true"></i>
              <span class="font-semibold">ë‚´ í™œë™</span>
              <span
                id="notification-count"
                class="hidden bg-red-600 text-white text-[10px] font-bold rounded-full px-1 py-0.5"
                aria-label="ìƒˆ ì•Œë¦¼ ê°œìˆ˜"
                >0</span
              >
            </button>
          </div>
        </div>

        <!-- ì ‘ì†ì íŒì˜¤ë²„(ê´€ë¦¬ì) -->
        <div
          id="presence-pop"
          class="hidden right-0 left-0 mx-auto md:left-auto md:right-10 md:mx-0 w-full max-w-xs bg-white border rounded-xl shadow-xl p-3 z-30"
          role="dialog"
          aria-labelledby="presence-title"
          aria-modal="true"
        >
          <div
            id="presence-title"
            class="text-sm font-semibold text-gray-700 mb-2"
          >
            í˜„ì¬ ì ‘ì†ì
          </div>
          <div
            id="presence-list"
            class="max-h-64 overflow-auto text-sm"
            role="list"
          ></div>
        </div>

        <!-- ë‚´ í™œë™ ë¹ ë¥¸ë³´ê¸° -->
        <div
          id="notification-pop"
          class="hidden right-0 left-0 mx-auto md:left-auto md:right-10 md:mx-0 w-full max-w-sm bg-white border rounded-2xl shadow-2xl p-4 z-30 mt-2"
          role="dialog"
          aria-labelledby="my-page-quick-title"
          aria-modal="true"
        >
          <div class="space-y-4" id="my-page-quick-panel">
            <div class="text-center">
              <h3
                id="my-page-quick-title"
                class="text-base font-bold text-gray-800"
              >
                ë‚´ í™œë™ í•œëˆˆì— ë³´ê¸°
              </h3>
              <p class="text-xs text-gray-500 mt-1">
                ìµœê·¼ ì‹ ì²­ ë‚´ì—­ì„ ë¹ ë¥´ê²Œ í™•ì¸í•˜ì„¸ìš”.
              </p>
            </div>
            <div
              id="my-page-quick-summary"
              class="bg-orange-50 border border-orange-200 rounded-xl px-4 py-3 text-sm text-gray-700"
            >
              <div class="text-center text-gray-500 text-sm py-3">
                ë‚´ í™œë™ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
              </div>
            </div>
          </div>
        </div>
      </header>

      <main id="app" class="space-y-6 md:space-y-8">
        <div id="app-wrapper">
          <!-- ===== ë¡œê·¸ì¸ ì „ ===== -->
          <div id="pre-login-info" class="space-y-6 md:space-y-8">
            <!-- ë¡œê·¸ì¸ -->
            <div id="login-section" class="section max-w-lg mx-auto">
              <!-- ë¡œê·¸ì¸ í—¤ë” ë””ìì¸ -->
              <div class="section mb-6">
                <div class="text-center">
                  <!-- Foodie ë¡œê³  -->
                  <div class="mb-4">
                    <h1 class="text-4xl md:text-5xl font-bold mb-2 logo-glow">
                      Foodie
                    </h1>
                    <div class="flex justify-center gap-2 mt-2">
                      <span class="text-xl">ğŸ½ï¸</span>
                      <span class="text-xl">ğŸœ</span>
                      <span class="text-xl">ğŸ•</span>
                    </div>
                  </div>

                  <!-- ë™ì•„ë¦¬ ì†Œê°œ -->
                  <p
                    class="text-sm md:text-base text-gray-700 font-medium mb-1"
                  >
                    ì „ë¶ëŒ€í•™êµ ë§›ì§‘ íƒë°© ë™ì•„ë¦¬âœ¨
                  </p>
                  <p class="text-xs md:text-sm text-gray-600 mb-4">
                    í•¨ê»˜ ë§›ìˆëŠ” ì¶”ì–µì„ ë§Œë“¤ì–´ìš”
                  </p>

                  <!-- êµ¬ë¶„ì„  -->
                  <div class="flex items-center justify-center gap-3 my-4">
                    <div class="flex-1 h-px bg-gray-200"></div>
                    <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                    <div class="flex-1 h-px bg-gray-200"></div>
                  </div>

                  <!-- íšŒì› ì¸ì¦ ì œëª© -->
                  <h2 class="text-lg md:text-xl font-bold text-gray-800">
                    íšŒì› ì¸ì¦
                  </h2>
                </div>
              </div>
              <div
                class="space-y-3 md:space-y-4"
                role="form"
                aria-label="íšŒì› ì¸ì¦ í¼"
              >
                <div>
                  <label for="studentId" class="sr-only">í•™ë²ˆ</label>
                  <input
                    id="studentId"
                    name="studentId"
                    type="text"
                    placeholder="í•™ë²ˆ"
                    aria-label="í•™ë²ˆ ì…ë ¥"
                    autocomplete="username"
                    class="w-full input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
                  />
                </div>
                <div>
                  <label for="studentName" class="sr-only">ì´ë¦„</label>
                  <input
                    id="studentName"
                    name="studentName"
                    type="text"
                    placeholder="ì´ë¦„"
                    aria-label="ì´ë¦„ ì…ë ¥"
                    autocomplete="name"
                    class="w-full input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
                  />
                </div>

                <!-- ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ -->
                <div class="flex items-center justify-center">
                  <label
                    for="auto-login-checkbox"
                    class="inline-flex items-center cursor-pointer select-none"
                  >
                    <div class="relative">
                      <input
                        id="auto-login-checkbox"
                        name="autoLogin"
                        type="checkbox"
                        class="sr-only"
                        aria-label="ìë™ ë¡œê·¸ì¸"
                      />
                      <div
                        class="w-5 h-5 bg-white border-2 border-gray-300 rounded-sm flex items-center justify-center transition-all duration-200 hover:border-orange-400"
                        role="checkbox"
                        aria-checked="false"
                      >
                        <svg
                          class="w-3 h-3 text-orange-600 opacity-0 transition-opacity duration-200"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                          aria-hidden="true"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clip-rule="evenodd"
                          ></path>
                        </svg>
                      </div>
                    </div>
                    <span class="ml-3 text-sm text-gray-700 font-medium">
                      ìë™ ë¡œê·¸ì¸
                    </span>
                  </label>
                </div>

                <button
                  id="login-button"
                  type="button"
                  class="w-full bg-orange-500 text-white btn-lg hover:bg-orange-600 transition-colors"
                  aria-label="ë¡œê·¸ì¸ ë²„íŠ¼"
                >
                  <i class="fas fa-right-to-bracket mr-2" aria-hidden="true"></i
                  >ë¡œê·¸ì¸
                </button>
                <button
                  id="kakao-login-button"
                  type="button"
                  onclick="if(typeof window.handleKakaoLogin === 'function') window.handleKakaoLogin(event);"
                  class="w-full bg-[#FEE500] text-gray-900 btn-lg hover:bg-[#FDD835] transition-colors flex items-center justify-center"
                  aria-label="ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼"
                >
                  <svg
                    class="w-5 h-5 mr-2"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M12 3c5.799 0 10.5 3.664 10.5 8.185 0 4.52-4.701 8.184-10.5 8.184a13.5 13.5 0 0 1-1.727-.11l-4.408 2.883c-.501.265-.678.236-.472-.413l.892-3.678c-2.88-1.46-4.785-3.99-4.785-6.866C1.5 6.665 6.201 3 12 3z"
                    />
                  </svg>
                  ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸
                </button>
                <button
                  id="signup-button"
                  type="button"
                  class="w-full bg-white text-orange-700 border border-orange-300 btn-lg hover:bg-orange-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  aria-label="íšŒì›ê°€ì… ë²„íŠ¼"
                >
                  <i class="fas fa-user-plus mr-2" aria-hidden="true"></i>ë™ì•„ë¦¬
                  ê°€ì…í•˜ê¸°
                </button>
                <div
                  id="signup-banner"
                  class="hidden text-center text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg p-2 mt-2"
                  role="alert"
                  aria-live="polite"
                >
                  ì§€ê¸ˆì€ <b>íšŒì›ê°€ì… ê¸°ê°„</b>ì…ë‹ˆë‹¤. ë¯¸íšŒì›ì€
                  <b>ë™ì•„ë¦¬ ê°€ì…í•˜ê¸°</b> ë²„íŠ¼ìœ¼ë¡œ ê°€ì…í•˜ì„¸ìš”.
                </div>
              </div>
            </div>

            <!-- ë¡œë“œë§µ (ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ í‘œì‹œ) -->
            <div class="section hidden" id="roadmap-section">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-700">
                  <i class="fas fa-map-signs mr-2 text-orange-500"></i>Foodie
                  í™œë™ ë¡œë“œë§µ
                </h3>
                <div id="roadmap-admin-controls" class="hidden">
                  <button
                    id="add-roadmap-event"
                    class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"
                    title="ìƒˆë¡œìš´ ì¼ì •ì„ ì¶”ê°€í•©ë‹ˆë‹¤"
                  >
                    <i class="fas fa-plus mr-1"></i>ì¼ì • ì¶”ê°€
                  </button>
                </div>
              </div>
              <div id="roadmap-container" class="space-y-3"></div>
              <div class="text-center mt-3">
                <button
                  id="roadmap-toggle-btn"
                  type="button"
                  class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-medium py-1.5 px-3 rounded-md transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5 text-sm hidden"
                >
                  <i class="fas fa-calendar-alt text-xs"></i>
                  <span id="roadmap-toggle-text">ë‹¬ë ¥ ë³´ê¸°</span>
                </button>
              </div>
            </div>

            <!-- í™ˆ í™”ë©´ ë¸”ë¡ -->
            <div id="dynamic-blocks" class="space-y-4 md:space-y-6"></div>
          </div>

          <!-- ===== ë¡œê·¸ì¸ í›„ ë©”ì¸ ===== -->
          <div id="main-content" class="hidden">
            <!-- ë¡œê·¸ì¸ í›„ ë©”ì¸ í™”ë©´ì€ renderAll()ì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </main>
    </div>

    <div id="logout-container" class="text-center py-2"></div>

    <footer class="text-center py-4 text-gray-500 text-sm footer-selectable">
      <p>ê°œë°œìğŸ§‘ğŸ»â€ğŸ’»: Foodie 2025 íšŒì¥ ì´ëŒ€í˜„</p>
      <p>ì—°ë½ì²˜ğŸ“¨: leedaehyun11@naver.com</p>
    </footer>

    <!-- Alert Modal -->

    <!-- Inquiry/Suggestions Modal -->
    <div
      id="inquiry-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div
        class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold text-orange-600">
            <i class="fas fa-question-circle mr-2"></i>ë¬¸ì˜í•˜ê¸°
          </h3>
          <button
            id="inquiry-close"
            class="text-gray-400 hover:text-gray-600 transition-colors"
            title="ë‹«ê¸°"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- ë¬¸ì˜ ì‘ì„± í¼ -->
        <div class="mb-6 bg-orange-50 p-4 rounded-lg border border-orange-200">
          <div class="mb-3">
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >ì œëª© (ì„ íƒ)</label
            >
            <input
              id="modal-sug-title"
              type="text"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors"
              placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)"
            />
          </div>
          <div class="mb-3">
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >ë‚´ìš© *</label
            >
            <textarea
              id="modal-sug-text"
              rows="4"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors resize-none"
              placeholder="ê¶ê¸ˆí•œ ì ì´ë‚˜ ë¬¸ì˜ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”."
            ></textarea>
          </div>
          <button
            id="modal-sug-submit"
            class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg"
          >
            <i class="fas fa-paper-plane mr-2"></i>ë¬¸ì˜ ë³´ë‚´ê¸°
          </button>
        </div>

        <!-- ê¸°ì¡´ ë¬¸ì˜ ëª©ë¡ -->
        <div class="border-t pt-4">
          <h4 class="text-lg font-bold text-gray-800 mb-3">
            <i class="fas fa-list mr-2"></i>ë¬¸ì˜ ë‚´ì—­
          </h4>
          <div id="modal-suggestions-list" class="space-y-3">
            <!-- ë¬¸ì˜ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
    </div>

    <!-- Rank Modal -->
    <div
      id="rank-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div
        class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-2xl font-bold text-orange-700">ğŸ… ì¡°ëª¨ì„</h3>
          <div class="flex items-center gap-2">
            <div id="rank-admin-controls" class="hidden">
              <button
                id="rank-add-team"
                class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"
                title="ìƒˆë¡œìš´ ì¡°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤"
              >
                <i class="fas fa-plus mr-1"></i>ì¡°ëª¨ì„ ì¶”ê°€
              </button>
            </div>
            <button
              id="rank-close-header"
              class="text-gray-400 hover:text-gray-600 transition-colors text-xl"
              title="ë‹«ê¸°"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div id="rank-list" class="space-y-2"></div>

        <!-- ì ìˆ˜ ë³€ê²½ ê¸°ë¡ (íšŒì¥/ë¶€íšŒì¥ë§Œ ë³´ì„) -->
        <div id="rank-history-section" class="hidden mt-6">
          <h4 class="text-lg font-bold text-gray-800 mb-3">
            <i class="fas fa-history mr-2 text-blue-600"></i>
            ì ìˆ˜ ë³€ê²½ ê¸°ë¡
          </h4>
          <div
            id="rank-history-list"
            class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 rounded-lg p-3"
          >
            <!-- ê¸°ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
          </div>
        </div>
        <div class="mt-4 flex justify-between">
          <div id="rank-admin-actions" class="hidden space-x-2">
            <button
              id="rank-save-changes"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors"
              title="ì¡°ëª¨ì„ ìˆœìœ„ ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•©ë‹ˆë‹¤"
            >
              <i class="fas fa-save mr-1"></i>ë³€ê²½ì‚¬í•­ ì €ì¥
            </button>
          </div>
          <button
            id="rank-close"
            class="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300"
          >
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- ë­ë¨¹ì§€ Modal -->
    <div
      id="food-recommend-modal"
      class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex justify-center items-center px-4 z-50 overflow-y-auto py-4"
    >
      <div
        class="bg-gradient-to-br from-orange-50 via-white to-red-50 p-1 rounded-3xl shadow-2xl max-w-lg w-full animate-fadeIn my-auto max-h-[95vh] overflow-y-auto"
      >
        <div class="bg-white/95 backdrop-blur-md p-4 md:p-6 rounded-3xl">
          <!-- í—¤ë” -->
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-2xl md:text-3xl font-black">
              <span
                class="bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent"
              >
                ğŸ½ï¸ ë­ë¨¹ì§€?
              </span>
            </h3>
            <button
              id="menu-manage-btn"
              class="hidden px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors text-sm font-medium"
            >
              <i class="fas fa-cog mr-1"></i>ë©”ë‰´ ê´€ë¦¬
            </button>
          </div>

          <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
          <div class="flex flex-wrap gap-2 mb-4">
            <button
              class="category-filter-btn active px-3 py-1.5 rounded-full bg-orange-500 text-white text-sm font-medium whitespace-nowrap"
              data-category="all"
            >
              <span class="category-label">ì „ì²´</span>
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="korean"
            >
              <span class="category-label">í•œì‹</span>
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="japanese"
            >
              <span class="category-label">ì¼ì‹</span>
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="chinese"
            >
              <span class="category-label">ì¤‘ì‹</span>
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="western"
            >
              <span class="category-label">ì–‘ì‹</span>
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="asian"
            >
              <span class="category-label">ì•„ì‹œì•ˆ</span>
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="snack"
            >
              <span class="category-label">ë¶„ì‹</span>
            </button>
            <button
              class="category-filter-btn px-3 py-1.5 rounded-full bg-gray-200 text-gray-700 text-sm font-medium whitespace-nowrap hover:bg-gray-300"
              data-category="dessert"
            >
              <span class="category-label">ë””ì €íŠ¸</span>
            </button>
          </div>

          <!-- ë£°ë › ì˜ì—­ -->
          <div
            class="relative bg-gradient-to-br from-orange-100 via-yellow-50 to-red-100 rounded-3xl p-8 md:p-12 mb-4 border-4 border-orange-300 shadow-inner overflow-hidden"
          >
            <!-- ì¥ì‹ ìš”ì†Œ -->
            <div
              class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none"
            >
              <div class="absolute top-2 left-2 text-4xl">ğŸ•</div>
              <div class="absolute top-2 right-2 text-4xl">ğŸœ</div>
              <div class="absolute bottom-2 left-2 text-4xl">ğŸ”</div>
              <div class="absolute bottom-2 right-2 text-4xl">ğŸ£</div>
            </div>

            <!-- ë£°ë › ë””ìŠ¤í”Œë ˆì´ -->
            <div class="relative z-10 text-center">
              <div
                id="roulette-display"
                class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-xl min-h-[200px] flex flex-col items-center justify-center"
              >
                <div
                  id="roulette-emoji"
                  class="text-6xl md:text-7xl mb-4 transition-all"
                >
                  ğŸ½ï¸
                </div>
                <div
                  id="roulette-text"
                  class="text-xl md:text-2xl font-black text-gray-800"
                >
                  ë©”ë‰´ë¥¼ ì¶”ê°€í•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!
                </div>
                <div id="roulette-category" class="text-sm text-gray-500 mt-2">
                  <!-- ì¹´í…Œê³ ë¦¬ í‘œì‹œ -->
                </div>
              </div>
            </div>
          </div>

          <!-- ë¹ ë¥¸ ë©”ë‰´ ì¶”ê°€ (íšŒì¥ë‹¨ë§Œ) -->
          <div id="quick-add-section" class="hidden flex gap-2 mb-4">
            <input
              id="quick-menu-input"
              type="text"
              placeholder="ë¹ ë¥´ê²Œ ë©”ë‰´ ì¶”ê°€ (Enter) - íšŒì¥ë‹¨ ì „ìš©"
              class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all"
            />
            <button
              id="quick-add-btn"
              class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors font-medium"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>

          <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
          <div class="flex gap-2 md:gap-3 mb-4">
            <button
              id="spin-roulette-btn"
              class="flex-1 relative overflow-hidden group bg-gradient-to-r from-orange-500 via-orange-600 to-red-600 hover:from-orange-600 hover:via-red-600 hover:to-red-700 text-white font-black py-4 px-6 rounded-2xl transition-all shadow-xl hover:shadow-2xl hover:scale-105"
            >
              <div
                class="absolute inset-0 bg-white/20 transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-700"
              ></div>
              <span class="relative flex items-center justify-center gap-2">
                <i class="fas fa-dice text-2xl"></i>
                <span class="text-lg">ë©”ë‰´ ë½‘ê¸°</span>
              </span>
            </button>
            <button
              id="food-recommend-close"
              class="px-6 py-4 bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 hover:from-gray-200 hover:to-gray-300 rounded-2xl transition-all shadow-md hover:shadow-lg font-bold"
            >
              <i class="fas fa-times text-lg"></i>
            </button>
          </div>

          <!-- ìµœê·¼ ì¶”ì²œ ë©”ë‰´ íˆìŠ¤í† ë¦¬ -->
          <div
            id="menu-history-section"
            class="hidden bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 rounded-xl p-4"
          >
            <h4
              class="text-sm font-bold text-orange-800 mb-3 flex items-center gap-2"
            >
              <i class="fas fa-history text-orange-600"></i>
              ìµœê·¼ ì¶”ì²œ ë©”ë‰´
            </h4>
            <div id="roulette-history" class="flex flex-wrap gap-2">
              <!-- íˆìŠ¤í† ë¦¬ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë©”ë‰´ ê´€ë¦¬ Modal -->
    <div
      id="menu-manage-modal"
      class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex justify-center items-center px-4 z-50 overflow-y-auto py-4"
    >
      <div
        class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full my-auto max-h-[95vh] overflow-y-auto"
      >
        <div class="p-6">
          <!-- í—¤ë” -->
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-black text-gray-800">
              <i class="fas fa-list-ul text-orange-500 mr-2"></i>ë©”ë‰´ ê´€ë¦¬
            </h3>
            <button
              id="menu-manage-close"
              class="text-gray-400 hover:text-gray-600 transition-colors"
            >
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>

          <!-- ë©”ë‰´ ì¶”ê°€ ì„¹ì…˜ -->
          <div
            class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 rounded-xl p-4 mb-6"
          >
            <h4 class="font-bold text-gray-800 mb-3">
              <i class="fas fa-plus-circle text-orange-500 mr-2"></i>ë©”ë‰´
              ì¶”ê°€í•˜ê¸°
            </h4>

            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ì¹´í…Œê³ ë¦¬ ì„ íƒ
              </label>
              <select
                id="menu-category-select"
                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200"
              >
                <option value="korean">í•œì‹</option>
                <option value="japanese">ì¼ì‹</option>
                <option value="chinese">ì¤‘ì‹</option>
                <option value="western">ì–‘ì‹</option>
                <option value="asian">ì•„ì‹œì•ˆ</option>
                <option value="snack">ë¶„ì‹</option>
                <option value="dessert">ë””ì €íŠ¸</option>
                <option value="cafe">ì¹´í˜</option>
                <option value="etc">ê¸°íƒ€</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                ë©”ë‰´ ì…ë ¥ (í•œ ì¤„ì— í•˜ë‚˜ì”©)
              </label>
              <textarea
                id="bulk-menu-input"
                rows="6"
                placeholder="ë©”ë‰´ë¥¼ í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•´ ì£¼ì„¸ìš”. (Enter í‚¤ë¡œ ì¤„ ë°”ê¿ˆ)

ì˜ˆ:
ê¹€ì¹˜ì°Œê°œ
ì´ˆë°¥
íŒŒìŠ¤íƒ€
ë–¡ë³¶ì´"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-400 focus:ring-2 focus:ring-orange-200 resize-none"
              ></textarea>
            </div>

            <button
              id="bulk-add-menu-btn"
              class="w-full px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-xl"
            >
              <i class="fas fa-plus mr-2"></i>ë©”ë‰´ ì¶”ê°€í•˜ê¸°
            </button>
          </div>

          <!-- ë©”ë‰´ ëª©ë¡ -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-bold text-gray-800">
                ë“±ë¡ëœ ë©”ë‰´
                <span id="menu-count-badge" class="text-sm text-gray-500"
                  >(0ê°œ)</span
                >
              </h4>
              <button
                id="delete-all-menus-btn"
                class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors"
              >
                <i class="fas fa-trash mr-1"></i>ì „ì²´ ì‚­ì œ
              </button>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ë³„ ë©”ë‰´ ëª©ë¡ -->
            <div
              id="menu-list-container"
              class="space-y-4 max-h-[400px] overflow-y-auto"
            >
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="alert-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]"
      role="alertdialog"
      aria-labelledby="alert-message"
      aria-modal="true"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center max-w-sm w-full"
      >
        <div
          id="modal-icon"
          class="text-4xl md:text-5xl mb-3 md:mb-4"
          aria-hidden="true"
        ></div>
        <p
          id="alert-message"
          class="text-base md:text-lg font-medium text-gray-700"
          role="alert"
        ></p>
        <button
          id="modal-close-button"
          type="button"
          class="mt-5 md:mt-6 bg-gray-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700"
          aria-label="í™•ì¸"
        >
          í™•ì¸
        </button>
      </div>
    </div>

    <!-- Emergency Modal -->
    <div
      id="emergency-modal"
      class="hidden fixed inset-0 bg-black/70 flex justify-center items-center px-4 z-50"
      role="dialog"
      aria-labelledby="emergency-title"
      aria-describedby="emergency-description"
      aria-modal="true"
    >
      <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-sm w-full">
        <h3
          id="emergency-title"
          class="text-2xl font-bold text-red-600 mb-4 text-center"
        >
          <i class="fas fa-exclamation-triangle mr-2" aria-hidden="true"></i
          >ë¹„ìƒ ë³µêµ¬ ëª¨ë“œ
        </h3>
        <p
          id="emergency-description"
          class="text-center text-gray-600 mb-4 md:mb-6"
        >
          ìƒˆë¡œìš´ ê´€ë¦¬ìë¥¼ ì„ëª…í•˜ì—¬ ì‹œìŠ¤í…œ ì ‘ê·¼ ê¶Œí•œì„ ë³µêµ¬í•©ë‹ˆë‹¤.
        </p>
        <div
          class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4"
          role="alert"
        >
          <p class="text-sm text-yellow-800">
            <i class="fas fa-info-circle mr-1" aria-hidden="true"></i>
            <strong>ì§ì ‘ ë¡œê·¸ì¸:</strong> í•™ë²ˆì—
            <code>foodie_emergency_2024!</code> ì…ë ¥ í›„ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ
            ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.
          </p>
        </div>
        <label for="new-admin-id" class="sr-only">ìƒˆ ê´€ë¦¬ì í•™ë²ˆ ì…ë ¥</label>
        <input
          type="text"
          id="new-admin-id"
          placeholder="ìƒˆ ê´€ë¦¬ìì˜ í•™ë²ˆì„ ì…ë ¥"
          class="w-full input-lg border border-gray-300"
          aria-label="ìƒˆ ê´€ë¦¬ì í•™ë²ˆ"
        />
        <div class="flex space-x-2 mt-4">
          <button
            id="emergency-add-button"
            type="button"
            class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600"
            aria-label="ìƒˆ ê´€ë¦¬ì ì„ëª…"
          >
            ê´€ë¦¬ì ì„ëª…
          </button>
          <button
            id="emergency-cancel-button"
            type="button"
            class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400"
            aria-label="ì·¨ì†Œ"
          >
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <!-- Signup Method Selection Modal -->
    <div
      id="signup-method-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
        <h3 class="text-2xl font-bold text-orange-700 text-center mb-3 md:mb-4">
          <i class="fas fa-user-plus mr-2"></i>ê°€ì… ë°©ë²• ì„ íƒ
        </h3>
        <p class="text-sm text-gray-600 text-center mb-6">
          ê°€ì… ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        </p>
        <div class="space-y-3">
          <button
            id="normal-signup-button"
            type="button"
            class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors flex items-center justify-center"
          >
            <i class="fas fa-user mr-2"></i>ì¼ë°˜ ê°€ì…
          </button>
          <button
            id="kakao-signup-button"
            type="button"
            class="w-full bg-[#FEE500] hover:bg-[#FDD835] text-gray-900 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
          >
            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 3c5.799 0 10.5 3.664 10.5 8.185 0 4.52-4.701 8.184-10.5 8.184a13.5 13.5 0 0 1-1.727-.11l-4.408 2.883c-.501.265-.678.236-.472-.413l.892-3.678c-2.88-1.46-4.785-3.99-4.785-6.866C1.5 6.665 6.201 3 12 3z"
              />
            </svg>
            ì¹´ì¹´ì˜¤ë¡œ ê°€ì…í•˜ê¸°
          </button>
        </div>
        <button
          id="signup-method-cancel-button"
          type="button"
          class="w-full mt-4 bg-gray-300 text-gray-800 font-bold py-2.5 px-4 rounded-lg hover:bg-gray-400 transition-colors"
        >
          ì·¨ì†Œ
        </button>
      </div>
    </div>

    <!-- Signup Modal -->
    <div
      id="signup-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-lg w-full">
        <h3 class="text-2xl font-bold text-orange-700 text-center mb-3 md:mb-4">
          <i class="fas fa-user-plus mr-2"></i>Foodie ë™ì•„ë¦¬ ê°€ì…í•˜ê¸°
        </h3>
        <p class="text-sm text-gray-600 text-center">
          ë™ì•„ë¦¬ ê°€ì…ì€ ìš´ì˜ì§„ì´ ì„¤ì •í•œ ê¸°ê°„ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </p>

        <div
          id="dues-box"
          class="hidden mt-4 bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-800"
        >
          <div class="font-bold mb-1">ğŸ’¸ íšŒë¹„/ê³„ì¢Œ ì•ˆë‚´</div>
          <div id="dues-box-content" class="text-sm"></div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input
            id="signupName"
            type="text"
            placeholder="ì´ë¦„"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <select
            id="signupGender"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          >
            <option value="">ì„±ë³„</option>
            <option value="ë‚¨">ë‚¨</option>
            <option value="ì—¬">ì—¬</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <select
            id="signupYear"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          >
            <option value="">í•™ë…„</option>
            <option value="1í•™ë…„">1í•™ë…„</option>
            <option value="2í•™ë…„">2í•™ë…„</option>
            <option value="3í•™ë…„">3í•™ë…„</option>
            <option value="4í•™ë…„">4í•™ë…„</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <input
            id="signupCollege"
            type="text"
            placeholder="ë‹¨ê³¼ëŒ€"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupDept"
            type="text"
            placeholder="í•™ê³¼"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupId"
            type="text"
            placeholder="í•™ë²ˆ"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupPhone"
            type="text"
            placeholder="000-0000-0000"
            maxlength="13"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 sm:col-span-2"
          />
        </div>
        <!-- ì¹´ì¹´ì˜¤ ì—°ë™ ë²„íŠ¼ (íšŒì›ê°€ì… ì‹œ) -->
        <div class="mt-4">
          <button
            id="signup-kakao-link-btn"
            type="button"
            class="w-full px-4 py-2 bg-[#FEE500] hover:bg-[#FDD835] text-gray-900 rounded-lg font-semibold transition-colors flex items-center justify-center"
          >
            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M12 3c5.799 0 10.5 3.664 10.5 8.185 0 4.52-4.701 8.184-10.5 8.184a13.5 13.5 0 0 1-1.727-.11l-4.408 2.883c-.501.265-.678.236-.472-.413l.892-3.678c-2.88-1.46-4.785-3.99-4.785-6.866C1.5 6.665 6.201 3 12 3z"
              />
            </svg>
            ì¹´ì¹´ì˜¤ ê³„ì • ì—°ë™í•˜ê¸°
          </button>
          <div
            id="signup-kakao-status"
            class="hidden mt-2 text-sm text-green-600 bg-green-50 border border-green-200 rounded-lg p-2"
          >
            <span id="signup-kakao-status-text"></span>
          </div>
        </div>
        <div class="flex gap-2 mt-5">
          <button
            id="signup-confirm-button"
            type="button"
            class="flex-1 bg-orange-500 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-orange-600"
          >
            ê°€ì… ì‹ ì²­
          </button>
          <button
            id="signup-cancel-button"
            type="button"
            class="flex-1 bg-gray-300 text-gray-800 font-bold py-2.5 px-4 rounded-lg hover:bg-gray-400"
          >
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <!-- íšŒë¹„ í™•ì¸ ëª¨ë‹¬ -->
    <div
      id="dues-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full">
        <h3 class="text-xl font-bold text-amber-700 text-center mb-3">
          ì ê¹! íšŒë¹„ëŠ” ë‚©ë¶€í•˜ì…¨ë‚˜ìš”?
        </h3>
        <div id="dues-modal-body" class="text-sm text-gray-700 space-y-1"></div>
        <div class="flex gap-2 mt-5">
          <button
            id="dues-copy-button"
            type="button"
            class="flex-1 bg-gray-200 text-gray-800 font-semibold py-2 rounded hover:bg-gray-300"
          >
            ê³„ì¢Œ ë³µì‚¬
          </button>
          <button
            id="dues-proceed-button"
            type="button"
            class="flex-1 bg-orange-500 text-white font-bold py-2 rounded hover:bg-orange-600"
          >
            ë‚©ë¶€ ì™„ë£Œ, ê°€ì…
          </button>
        </div>
        <button
          id="dues-cancel-button"
          type="button"
          class="mt-3 w-full bg-gray-100 text-gray-600 py-2 rounded hover:bg-gray-200"
        >
          ì·¨ì†Œ
        </button>
      </div>
    </div>

    <!-- ê³µìš©(ë¬¸ë‹¨) ì—ë””í„° ëª¨ë‹¬ -->
    <div
      id="block-editor"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-5">
        <h3
          class="text-xl font-bold text-gray-800 mb-3"
          id="block-editor-title"
        >
          ë¸”ë¡ í¸ì§‘
        </h3>
        <div id="block-editor-body" class="space-y-3"></div>
        <div class="flex gap-2 justify-end mt-4">
          <button
            id="block-editor-cancel"
            class="px-4 py-2 rounded bg-gray-200"
          >
            ì·¨ì†Œ
          </button>
          <button
            id="block-editor-save"
            class="px-4 py-2 rounded bg-orange-500 text-white"
          >
            ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- App Script -->
    <script>
      // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡, main.js ë¡œë“œ ì „ì—ë„ ì‘ë™)
      window.handleKakaoLogin = async function (e) {
        if (e) {
          e.preventDefault();
          e.stopPropagation();
        }

        console.log("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨");

        // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” í™•ì¸
        if (typeof window.Kakao === "undefined") {
          alert("ì¹´ì¹´ì˜¤ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ì‚¬ìš© (ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€)
        if (window.Kakao.isInitialized()) {
          console.log("ì¹´ì¹´ì˜¤ SDKëŠ” ì´ë¯¸ ì´ˆê¸°í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
        } else if (typeof window.initKakaoSDK === "function") {
          window.initKakaoSDK();
        } else {
          const KAKAO_JS_KEY = "28869968a8cfea9a996172c117d64eb2";
          if (KAKAO_JS_KEY) {
            try {
              window.Kakao.init(KAKAO_JS_KEY);
              console.log("ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì™„ë£Œ");
            } catch (error) {
              console.error("ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
              alert("ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              return;
            }
          }
        }

        if (!window.Kakao.isInitialized()) {
          alert("ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        try {
          // js/auth.jsì˜ loginWithKakao í•¨ìˆ˜ ì‚¬ìš©
          const { loginWithKakao } = await import("./js/auth.js");
          const ok = await loginWithKakao();
          if (ok) {
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.location.reload();
          }
        } catch (error) {
          console.error("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
          alert(
            "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + (error.message || error)
          );
        }
      };
    </script>

    <script type="module">
      /* ==== ê³µìš©: ë°ìŠ¤í¬í†± DnD + ëª¨ë°”ì¼ í™”ì‚´í‘œ ìˆœì„œ ë³€ê²½ ==== */
      // ì „ì—­ ìœ í‹¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰ë¼ë„ ì•ˆì „)
      window.FoodieUtils = window.FoodieUtils || {};
      FoodieUtils.enableSimpleDnd =
        FoodieUtils.enableSimpleDnd ||
        function (ul) {
          if (!ul) return;

          // ëª¨ë°”ì¼ í™”ì‚´í‘œ ì œê±° (ìˆœì„œë³€ê²½ ë²„íŠ¼ ì œê±°)
          ul.addEventListener("click", (e) => {
            const li = e.target.closest("li");
            if (!li) return;
            if (e.target.closest(".move-up")) {
              li.previousElementSibling &&
                ul.insertBefore(li, li.previousElementSibling);
            }
            if (e.target.closest(".move-down")) {
              li.nextElementSibling &&
                ul.insertBefore(li.nextElementSibling, li);
            }
          });

          // 2) ë°ìŠ¤í¬í†± DnD
          let dragEl = null;
          ul.addEventListener("dragstart", (e) => {
            dragEl = e.target.closest("li[draggable='true']");
            if (dragEl) dragEl.classList.add("dragging");
          });
          ul.addEventListener(
            "dragend",
            () => dragEl && dragEl.classList.remove("dragging")
          );
          ul.addEventListener("dragover", (e) => {
            e.preventDefault();
            const after = [
              ...ul.querySelectorAll("li[draggable='true']:not(.dragging)"),
            ].find((el) => {
              const box = el.getBoundingClientRect();
              return e.clientY <= box.top + box.height / 2;
            });
            if (dragEl) ul.insertBefore(dragEl, after || null);
          });
        };
      /* ==== ë¡œê³  ê²½ë¡œ & ë‹¤í¬ëª¨ë“œ ==== */
      const LOGO_SRC = "./assets/foodie-logo.png"; // <- ì‹¤ì œ ê²½ë¡œë¡œ ë°”ê¾¸ì„¸ìš”
      function applyLogo() {
        const img = document.getElementById("site-logo");
        if (img && LOGO_SRC) img.src = LOGO_SRC;
      }
      // ë‹¤í¬ëª¨ë“œ ê´€ë ¨ ì½”ë“œ ì œê±°ë¨
      applyLogo();

      /* ==== í™ˆ ë ˆì´ì•„ì›ƒ ìˆœì„œ(load & apply) ==== */
      let homeLayout = []; // ["login","roadmap","dynamic"]

      function applyHomeLayoutOrder() {
        const host = document.getElementById("pre-login-info");
        if (!host) return;
        const map = {
          login: document.getElementById("login-section"),
          roadmap: document.getElementById("roadmap-section"),
          dynamic: document.getElementById("dynamic-blocks"),
        };

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” roadmap ì„¹ì…˜ì„ ì œì™¸
        const defaultOrder = currentUser
          ? ["login", "roadmap", "dynamic"]
          : ["login", "dynamic"]; // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” roadmap ì œì™¸

        const order =
          Array.isArray(homeLayout) && homeLayout.length
            ? homeLayout
            : defaultOrder;

        order.forEach((key) => {
          const elx = map[key];
          if (elx) {
            // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” roadmap ì„¹ì…˜ì„ ìˆ¨ê¹€
            if (key === "roadmap") {
              if (!currentUser) {
                elx.style.display = "none";
                elx.classList.add("hidden");
              } else {
                elx.style.display = "";
                elx.classList.remove("hidden");
              }
            } else {
              elx.style.display = "";
            }
            host.appendChild(elx);
          }
        });
      }
      /* ===== Firebase ===== */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        runTransaction,
        collection,
        query,
        orderBy,
        addDoc,
        serverTimestamp,
        writeBatch,
        getDocs,
        where,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import {
        getStorage,
        ref as sRef,
        uploadBytesResumable,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDdrnlSQZa-GD006G9fvgYDL0V_ib3_pcE",
        authDomain: "foodie-club-694ba.firebaseapp.com",
        projectId: "foodie-club-694ba",
        storageBucket: "foodie-club-694ba.appspot.com",
        messagingSenderId: "563737208880",
        appId: "1:563737208880:web:d82b4ea6dd06754eb7e5f5",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const storage = getStorage(app);

      const IS_FILE = location.protocol === "file:";
      const USE_DEMO_OFFLINE = false; // í•­ìƒ Firebase ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
      const DEBUG_MODE = localStorage.getItem("foodie_debug") === "true"; // ê°œë°œ ëª¨ë“œ í† ê¸€

      // ë‚´ í™œë™ íŒì˜¤ë²„ Firebase ì •ë³´ ë¡œë“œ í”Œë˜ê·¸ (ì „ì—­)
      let firebaseKakaoInfoLoadedForUser = null; // studentIdë¥¼ í‚¤ë¡œ ì‚¬ìš©

      // ê°œë°œ ëª¨ë“œ ë¡œê·¸ í—¬í¼
      const debugLog = (...args) => {
        if (DEBUG_MODE) console.log(...args);
      };
      const debugWarn = (...args) => {
        if (DEBUG_MODE) console.warn(...args);
      };
      const debugError = (...args) => {
        if (DEBUG_MODE) console.error(...args);
      };

      /* ===== ìƒíƒœ ===== */
      let currentUser = null;
      let adminList = [];
      let adminPositions = {};
      let customDefaultPositions = [];
      let deletedDefaultPositions = [];
      // íšŒì¥ë‹¨ê³¼ ì¼ë°˜ ì„ì› ì§ì±… ë¶„ë¥˜
      let presidentPositions = []; // íšŒì¥ë‹¨ ì§ì±… (íšŒì¥, ë¶€íšŒì¥ ì™¸ ì¶”ê°€ ê°€ëŠ¥)
      let regularPositions = []; // ì¼ë°˜ ì„ì› ì§ì±… (ìš´ì˜ì§„ ì™¸ ì¶”ê°€ ê°€ëŠ¥)
      const MASTER_CODE = "foodie_emergency_2024!";
      const TRANSACTION_OPTIONS = { maxAttempts: 1 };

      // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í˜„ì¬ íƒ­ ìƒíƒœ ì €ì¥
      let currentDashboardTab = "activities"; // ê¸°ë³¸ê°’: í™œë™ ê´€ë¦¬ íƒ­
      let currentMainTab = "roadmap"; // ë©”ì¸ íƒ­ ìƒíƒœ ì €ì¥ (ê¸°ë³¸ê°’: ë¯¸ì‹íšŒ)

      // settings
      let signupSettings = { open: false };
      let duesSettings = {
        enabled: false,
        bank: "",
        number: "",
        holder: "",
        amount: "",
        note: "",
      };

      // data
      let roadmapData = [],
        suggestionsData = [];
      let historyData = [],
        eventsData = [];
      let membersData = [];
      let blocksData = [];
      let presenceData = [];
      let onlineUsers = [];
      let inquiriesData = [];
      let notificationsData = [];
      let memberSearchTerm = "";
      let editingEventId = null;
      let restaurantCategories = [
        { name: "í•œì‹", emoji: "ğŸš" },
        { name: "ì¼ì‹", emoji: "ğŸ£" },
        { name: "ì¤‘ì‹", emoji: "ğŸ¥Ÿ" },
        { name: "ì–‘ì‹", emoji: "ğŸ" },
        { name: "ì•„ì‹œì•ˆ", emoji: "ğŸœ" },
        { name: "ë””ì €íŠ¸", emoji: "ğŸ°" },
        { name: "ê¸°íƒ€", emoji: "ğŸ½ï¸" },
      ]; // ë¯¸ì‹íšŒ ì¹´í…Œê³ ë¦¬ ëª©ë¡
      let roadmapShowAll = false;
      let presenceTimer = null;
      let myProfileData = null;
      let myProfileLoading = false;
      let autoCloseSchedulerStarted = false;
      let autoCloseMinuteIntervalId = null;
      let autoCloseHourlyTimeoutId = null;
      let autoCloseHourlyIntervalId = null;

      // í™ˆë¸”ë¡ í¼ í¸ì§‘ ìƒíƒœ
      let editingBlockId_notice = null;
      let editingBlockId_qa = null;
      let editingBlockId_scores = null;

      /* ===== ê¶Œí•œ ê´€ë¦¬ í•¨ìˆ˜ ===== */
      function isAdmin() {
        return currentUser && adminList.includes(currentUser.studentId);
      }

      function isStaff() {
        if (!currentUser) return false;
        const position = adminPositions[currentUser.studentId];
        return position === "ìš´ì˜ì§„";
      }

      function isFullAdmin() {
        if (!currentUser) return false;
        const position = adminPositions[currentUser.studentId];
        return (
          position &&
          ["íšŒì¥", "ë¶€íšŒì¥", "ì´ë¬´", "ê¸°íšë¶€ì¥", "í™ë³´ë¶€ì¥", "ê°œë°œì"].includes(
            position
          )
        );
      }

      function isAdminOrStaff() {
        return isAdmin() || isStaff();
      }

      /* ===== DOM refs & helpers ===== */
      const el = {
        loading: document.getElementById("loading-screen"),
        pre: document.getElementById("pre-login-info"),
        main: document.getElementById("main-content"),
        id: document.getElementById("studentId"),
        name: document.getElementById("studentName"),
        alert: document.getElementById("alert-modal"),
        alertIcon: document.getElementById("modal-icon"),
        alertMsg: document.getElementById("alert-message"),
        emerg: document.getElementById("emergency-modal"),
        signupBanner: document.getElementById("signup-banner"),
        signupBtn: document.getElementById("signup-button"),
        signupModal: document.getElementById("signup-modal"),
        duesBox: document.getElementById("dues-box"),
        duesBoxContent: document.getElementById("dues-box-content"),
        duesModal: document.getElementById("dues-modal"),
        duesModalBody: document.getElementById("dues-modal-body"),
        presenceBadge: document.getElementById("presence-badge"),
        presenceCount: document.getElementById("presence-count"),
        presencePop: document.getElementById("presence-pop"),
        presenceList: document.getElementById("presence-list"),
        notificationBadge: document.getElementById("notification-badge"),
        notificationPop: document.getElementById("notification-pop"),
        notificationList: document.getElementById("notification-list"),
        blockEditor: document.getElementById("block-editor"),
        blockEditorTitle: document.getElementById("block-editor-title"),
        blockEditorBody: document.getElementById("block-editor-body"),
        blockEditorSave: document.getElementById("block-editor-save"),
        blockEditorCancel: document.getElementById("block-editor-cancel"),
      };
      const showAlert = (icon, msg) => {
        if (el.alertIcon) el.alertIcon.innerHTML = icon || "â„¹ï¸";
        if (el.alertMsg) el.alertMsg.innerHTML = msg || "";
        if (el.alert) el.alert.classList.remove("hidden");
      };
      const closeModal = () => {
        if (el.alert) el.alert.classList.add("hidden");
      };
      const closeEmergencyModal = () => el.emerg.classList.add("hidden");

      const updateMyPageQuickSummary = (html) => {
        const summaryEl = document.getElementById("my-page-quick-summary");
        if (summaryEl) {
          summaryEl.innerHTML = html;

          // ì¹´ì¹´ì˜¤ ì—°ë™ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì—°ê²°
          const quickKakaoLinkBtn = summaryEl.querySelector(
            "#quick-kakao-link-btn"
          );
          if (quickKakaoLinkBtn) {
            quickKakaoLinkBtn.addEventListener("click", async (e) => {
              if (e) {
                e.preventDefault();
                e.stopPropagation();
              }
              try {
                const { linkKakaoAccount } = await import("./js/auth.js");
                const success = await linkKakaoAccount();
                if (success) {
                  // ì„±ê³µ ì‹œ íŒì˜¤ë²„ ë‹«ê¸° (ì¹œêµ¬ì¶”ê°€ ëª¨ë‹¬ì´ ë‹«íŒ í›„ ìë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë¨)
                  el.notificationPop?.classList.add("hidden");
                }
              } catch (error) {
                console.error("ë‚´ í™œë™ ë¹ ë¥¸ë³´ê¸° ì¹´ì¹´ì˜¤ ì—°ë™ ì˜¤ë¥˜:", error);
              }
            });
          }

          // ì¹´ì¹´ì˜¤ ì—°ë™ í•´ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì—°ê²°
          const quickKakaoUnlinkBtn = summaryEl.querySelector(
            "#quick-kakao-unlink-btn"
          );
          if (quickKakaoUnlinkBtn) {
            quickKakaoUnlinkBtn.addEventListener("click", async (e) => {
              if (e) {
                e.preventDefault();
                e.stopPropagation();
              }
              try {
                const { unlinkKakaoAccount } = await import("./js/auth.js");
                const success = await unlinkKakaoAccount();
                if (success) {
                  // ì„±ê³µ ì‹œ íŒì˜¤ë²„ ë‹«ê³  í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                  el.notificationPop?.classList.add("hidden");
                  setTimeout(() => {
                    window.location.reload();
                  }, 500);
                }
              } catch (error) {
                console.error("ë‚´ í™œë™ ë¹ ë¥¸ë³´ê¸° ì¹´ì¹´ì˜¤ ì—°ë™ í•´ì§€ ì˜¤ë¥˜:", error);
              }
            });
          }
        }
      };

      const scrollToMyPageSection = () => {
        el.notificationPop?.classList.add("hidden");
        const section =
          document.getElementById("my-page-section") ||
          document.getElementById("my-activity-section");
        if (section) {
          section.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      };

      // í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
      const copyToClipboard = async (text) => {
        try {
          await navigator.clipboard.writeText(text);
          showAlert("âœ…", "ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        } catch (err) {
          // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ì²´ ë°©ë²•
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand("copy");
          document.body.removeChild(textArea);
          showAlert("âœ…", "ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }
      };

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.copyToClipboard = copyToClipboard;

      // ê¸ˆì•¡ í¬ë§·íŒ… í•¨ìˆ˜ëŠ” ì•„ë˜ì— ì •ì˜ë¨

      // ===================== ë¬¸ì˜í•˜ê¸° ëª¨ë‹¬ =====================
      function openInquiryModal() {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]";
        modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">ğŸ’¬ ë¬¸ì˜í•˜ê¸°</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors">
                      <i class="fas fa-times text-xl"></i>
                    </button>
                  </div>

                  <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                      <p class="text-sm text-blue-800 flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        íšŒì›ê°€ì…, ë¡œê·¸ì¸, ì´ë²¤íŠ¸ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì„ ë‚¨ê²¨ì£¼ì„¸ìš”. íšŒì¥ë‹¨ì´ í™•ì¸ í›„ ì—°ë½ë“œë¦½ë‹ˆë‹¤.
                      </p>
                    </div>

                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user text-blue-500 mr-2"></i>
                        ì´ë¦„ <span class="text-red-500">*</span>
                      </label>
                      <input
                        id="inquiry-name"
                        type="text"
                        placeholder="ì˜ˆ: í™ê¸¸ë™"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                        required
                      >
                    </div>

                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-phone text-blue-500 mr-2"></i>
                        ì—°ë½ì²˜ <span class="text-red-500">*</span>
                      </label>
                      <input
                        id="inquiry-contact"
                        type="tel"
                        placeholder="ì˜ˆ: 010-1234-5678"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                        required
                      >
                    </div>

                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-comment-dots text-blue-500 mr-2"></i>
                        ë¬¸ì˜ ë‚´ìš© <span class="text-red-500">*</span>
                      </label>
                      <textarea
                        id="inquiry-content"
                        rows="6"
                        placeholder="ë¬¸ì˜í•˜ì‹¤ ë‚´ìš©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base resize-none"
                        required
                      ></textarea>
                    </div>
                  </div>

                  <div class="flex gap-3 justify-end mt-6">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                      ì·¨ì†Œ
                    </button>
                    <button onclick="submitInquiry()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                      <i class="fas fa-paper-plane mr-2"></i>
                      ë¬¸ì˜ ë³´ë‚´ê¸°
                    </button>
                  </div>
                </div>
              `;
        document.body.appendChild(modal);

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.openInquiryModal = openInquiryModal;

      // ë¬¸ì˜ ì œì¶œ í•¨ìˆ˜
      window.submitInquiry = async () => {
        const name = document.getElementById("inquiry-name").value.trim();
        const contact = document.getElementById("inquiry-contact").value.trim();
        const content = document.getElementById("inquiry-content").value.trim();

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!name || !contact || !content) {
          showAlert("ğŸ˜¥", "ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ì—°ë½ì²˜ í˜•ì‹ ê²€ì‚¬
        const phoneRegex = /^[0-9-]+$/;
        if (!phoneRegex.test(contact)) {
          showAlert("ğŸ˜¥", "ì˜¬ë°”ë¥¸ ì—°ë½ì²˜ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const inquiryData = {
            name,
            contact,
            content,
            status: "pending", // pending, answered
            createdAt: serverTimestamp(),
            answeredAt: null,
            answer: null,
          };

          await addDoc(collection(db, "inquiries"), inquiryData);
          showAlert(
            "âœ…",
            "ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! íšŒì¥ë‹¨ì´ í™•ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
          );

          // ëª¨ë‹¬ ë‹«ê¸°
          document.querySelector(".fixed.inset-0").remove();
        } catch (error) {
          console.error("ë¬¸ì˜ ì „ì†¡ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë¬¸ì˜ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      };

      // ===================== íšŒì› ìˆ˜ë™ ì¶”ê°€ ëª¨ë‹¬ =====================
      function openAddMemberModal() {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]";
        modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">ğŸ‘¤ íšŒì› ìˆ˜ë™ ì¶”ê°€</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors">
                      <i class="fas fa-times text-xl"></i>
                    </button>
                  </div>

                  <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                      <p class="text-sm text-blue-800 flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        íšŒì¥ë‹¨ì´ ì§ì ‘ íšŒì›ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                      </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-id-card text-purple-500 mr-2"></i>
                          í•™ë²ˆ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="add-member-student-id"
                          type="text"
                          placeholder="ì˜ˆ: 2023123456"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-user text-purple-500 mr-2"></i>
                          ì´ë¦„ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="add-member-name"
                          type="text"
                          placeholder="ì˜ˆ: í™ê¸¸ë™"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-venus-mars text-purple-500 mr-2"></i>
                          ì„±ë³„ <span class="text-red-500">*</span>
                        </label>
                        <select
                          id="add-member-gender"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base bg-white"
                          required
                        >
                          <option value="">ì„±ë³„ ì„ íƒ</option>
                          <option value="ë‚¨">ë‚¨</option>
                          <option value="ì—¬">ì—¬</option>
                          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-graduation-cap text-purple-500 mr-2"></i>
                          í•™ë…„ <span class="text-red-500">*</span>
                        </label>
                        <select
                          id="add-member-year"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base bg-white"
                          required
                        >
                          <option value="">í•™ë…„ ì„ íƒ</option>
                          <option value="1í•™ë…„">1í•™ë…„</option>
                          <option value="2í•™ë…„">2í•™ë…„</option>
                          <option value="3í•™ë…„">3í•™ë…„</option>
                          <option value="4í•™ë…„">4í•™ë…„</option>
                          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-university text-purple-500 mr-2"></i>
                          ë‹¨ê³¼ëŒ€ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="add-member-college"
                          type="text"
                          placeholder="ì˜ˆ: ê³µê³¼ëŒ€í•™"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-book text-purple-500 mr-2"></i>
                          í•™ê³¼ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="add-member-department"
                          type="text"
                          placeholder="ì˜ˆ: ì»´í“¨í„°ê³µí•™ê³¼"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-phone text-purple-500 mr-2"></i>
                          ì „í™”ë²ˆí˜¸ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="add-member-phone"
                          type="tel"
                          placeholder="ì˜ˆ: 010-1234-5678"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-toggle-on text-purple-500 mr-2"></i>
                          ì´ˆê¸° ìƒíƒœ
                        </label>
                        <select
                          id="add-member-status"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base bg-white"
                        >
                          <option value="active">í™œì„± (ì¦‰ì‹œ ìŠ¹ì¸)</option>
                          <option value="pending">ëŒ€ê¸° (ìŠ¹ì¸ í•„ìš”)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">í™œì„±ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì¦‰ì‹œ ìŠ¹ì¸ëœ ìƒíƒœë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.</p>
                      </div>
                    </div>
                  </div>

                  <div class="flex gap-3 justify-end mt-6">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                      ì·¨ì†Œ
                    </button>
                    <button onclick="saveNewMember()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors">
                      <i class="fas fa-save mr-2"></i>
                      íšŒì› ì¶”ê°€
                    </button>
                  </div>
                </div>
              `;
        document.body.appendChild(modal);

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // íšŒì› ì €ì¥ í•¨ìˆ˜
      window.saveNewMember = async () => {
        const studentId = document
          .getElementById("add-member-student-id")
          .value.trim();
        const name = document.getElementById("add-member-name").value.trim();
        const gender = document.getElementById("add-member-gender").value;
        const year = document.getElementById("add-member-year").value;
        const college = document
          .getElementById("add-member-college")
          .value.trim();
        const department = document
          .getElementById("add-member-department")
          .value.trim();
        const phone = document.getElementById("add-member-phone").value.trim();
        const status = document.getElementById("add-member-status").value;

        // ìœ íš¨ì„± ê²€ì‚¬
        if (
          !studentId ||
          !name ||
          !gender ||
          !year ||
          !college ||
          !department ||
          !phone
        ) {
          showAlert("ğŸ˜¥", "ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // í•™ë²ˆ ì¤‘ë³µ í™•ì¸
        try {
          const mref = doc(db, "members", studentId);
          const ms = await getDoc(mref);
          if (ms.exists()) {
            showAlert("ğŸ˜¥", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í•™ë²ˆì…ë‹ˆë‹¤.");
            return;
          }
        } catch (error) {
          console.error("í•™ë²ˆ í™•ì¸ ì˜¤ë¥˜:", error);
        }

        // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì‚¬ (ê°„ë‹¨í•œ ê²€ì‚¬)
        const phoneRegex = /^[0-9-]+$/;
        if (!phoneRegex.test(phone)) {
          showAlert("ğŸ˜¥", "ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const memberData = {
            studentId,
            name,
            gender,
            year,
            college,
            department,
            phone,
            status,
            requestedAt: serverTimestamp(),
            addedBy: currentUser?.studentId || "admin",
          };

          // members ì»¬ë ‰ì…˜ì— í•™ë²ˆì„ ë¬¸ì„œ IDë¡œ ì‚¬ìš©
          await setDoc(doc(db, "members", studentId), memberData);
          showAlert("âœ…", "íšŒì›ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");

          // ëª¨ë‹¬ ë‹«ê¸°
          document.querySelector(".fixed.inset-0").remove();

          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ ë°˜ì˜
          setTimeout(() => {
            location.reload();
          }, 1000);
        } catch (error) {
          console.error("íšŒì› ì¶”ê°€ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "íšŒì› ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };

      // ì‹ë‹¹ ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
      window.openRestaurantEditModal = (
        eventId,
        restaurantName,
        currentInfo
      ) => {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]";
        modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">ëŒ€í‘œ ë©”ë‰´ ìˆ˜ì •</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors">
                      <i class="fas fa-times text-xl"></i>
                    </button>
                  </div>
                  <div class="mb-4">
                    <div class="text-sm text-gray-600 mb-2">ì‹ë‹¹: <span class="font-semibold">${restaurantName}</span></div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                      <i class="fas fa-utensils text-orange-500 mr-2"></i>
                      ëŒ€í‘œ ë©”ë‰´
                    </label>
                    <textarea id="restaurant-menu-edit" rows="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base resize-none" placeholder="ì´ ì‹ë‹¹ì˜ ëŒ€í‘œ ë©”ë‰´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”">${currentInfo}</textarea>
                  </div>
                  <div class="flex gap-3 justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                      ì·¨ì†Œ
                    </button>
                    <button onclick="saveRestaurantMenu('${eventId}', '${restaurantName.replace(
          /'/g,
          "\\'"
        )}')" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors">
                      ì €ì¥
                    </button>
                  </div>
                </div>
              `;
        document.body.appendChild(modal);

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      };

      // ì‹ë‹¹ ë©”ë‰´ ì €ì¥ í•¨ìˆ˜
      window.saveRestaurantMenu = async (eventId, restaurantName) => {
        const newMenu = document
          .getElementById("restaurant-menu-edit")
          .value.trim();
        if (!newMenu) {
          showAlert("ğŸ˜¥", "ëŒ€í‘œ ë©”ë‰´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const eventRef = doc(db, "events", eventId);
          const eventSnap = await getDoc(eventRef);
          if (!eventSnap.exists()) {
            showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const eventData = eventSnap.data();
          const restaurants = eventData.restaurants || [];
          const restaurantIndex = restaurants.findIndex(
            (r) => r.name === restaurantName
          );

          if (restaurantIndex === -1) {
            showAlert("ğŸ˜¥", "ì‹ë‹¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          restaurants[restaurantIndex].info = newMenu;

          await updateDoc(eventRef, { restaurants });
          showAlert("âœ…", "ëŒ€í‘œ ë©”ë‰´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

          // ëª¨ë‹¬ ë‹«ê¸°
          document.querySelector(".fixed.inset-0").remove();

          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ ë°˜ì˜
          setTimeout(() => {
            location.reload();
          }, 1000);
        } catch (error) {
          console.error("ë©”ë‰´ ìˆ˜ì • ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë©”ë‰´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };
      const mask = (sid) => (sid ? `${String(sid).slice(0, 4)}****` : "");
      const isWithin = (d, s, e) => {
        const x = new Date(d);
        x.setHours(0, 0, 0, 0);
        const S = s ? new Date(s) : null,
          E = e ? new Date(e) : null;
        if (S) S.setHours(0, 0, 0, 0);
        if (E) E.setHours(23, 59, 59, 999);
        return (!S || x >= S) && (!E || x <= E);
      };
      const isSignupOpen = () => {
        return signupSettings.open === true;
      };
      const isUserIn = (arr = []) =>
        arr?.some((p) => p.studentId === currentUser?.studentId);
      const formatKRW = (n) => {
        const v = Number(n || 0);
        return isNaN(v) ? "" : v.toLocaleString("ko-KR") + "ì›";
      };
      const toDateSafe = (value) => {
        if (!value) return null;
        if (value instanceof Date) {
          return Number.isNaN(value.getTime()) ? null : value;
        }
        if (
          typeof value === "object" &&
          value !== null &&
          typeof value.toDate === "function"
        ) {
          try {
            const converted = value.toDate();
            if (
              converted instanceof Date &&
              !Number.isNaN(converted.getTime())
            ) {
              return converted;
            }
          } catch (err) {
            // ignore conversion errors
          }
        }
        if (typeof value === "number") {
          const fromNumber = new Date(value);
          return Number.isNaN(fromNumber.getTime()) ? null : fromNumber;
        }
        if (typeof value === "string") {
          const fromString = new Date(value);
          return Number.isNaN(fromString.getTime()) ? null : fromString;
        }
        return null;
      };
      const formatDateTimeForInput = (value) => {
        const date = toDateSafe(value);
        if (!date) return "";
        const pad = (num) => String(num).padStart(2, "0");
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(
          date.getDate()
        )}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
      };
      const timeAgo = (ms) => {
        const diff = (Date.now() - ms) / 1000;
        if (diff < 60) return `${Math.max(0, Math.floor(diff))}ì´ˆ ì „`;
        const m = diff / 60;
        if (m < 60) return `${Math.floor(m)}ë¶„ ì „`;
        return `${Math.floor(m / 60)}ì‹œê°„ ì „`;
      };
      const typeLabel = (t) =>
        ({
          tasting: "ë¯¸ì‹íšŒ",
          general: "ì¼ë°˜",
          mt: "MT",
          assembly: "ì´íšŒ",
        }[t] || t);
      const typeBadgeClass = (t) =>
        t === "tasting"
          ? "bg-orange-100 text-orange-700"
          : t === "mt"
          ? "bg-orange-100 text-orange-700"
          : t === "assembly"
          ? "bg-pink-100 text-pink-700"
          : "bg-emerald-100 text-emerald-700"; /* general */
      const typeAccentClass = (t) =>
        t === "tasting"
          ? "accent-tasting"
          : t === "mt"
          ? "accent-mt"
          : t === "assembly"
          ? "accent-assembly"
          : "accent-general"; /* general */
      const statusLabel = (s) =>
        ({
          open: "ê³µê°œ",
          archived: "ìˆ¨ê¹€",
          closed: "ë§ˆê°ë¨",
          completed: "ì¢…ë£Œë¨",
          cancelled: "ì·¨ì†Œë¨",
        }[s] || s);
      const saf = (x) =>
        window.DOMPurify
          ? DOMPurify.sanitize(String(x ?? ""))
          : String(x ?? "");

      const getPositionSuffix = () => {
        if (!currentUser) return "";

        // ê´€ë¦¬ìì¸ ê²½ìš°
        if (adminList.includes(currentUser.studentId)) {
          const position = adminPositions[currentUser.studentId];
          return position ? ` ${position}` : "";
        }

        // ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš° íšŒì›ìœ¼ë¡œ í‘œì‹œ
        return " íšŒì›";
      };
      let __renderQueued = false;
      let __isInitialLoading = true;
      let __loadingDataCount = 0;
      const __expectedDataSources = 8; // blocks, roadmap, events, members, suggestions, history, positions, foodMenus

      const scheduleRender = () => {
        if (__renderQueued) return;
        __renderQueued = true;
        requestAnimationFrame(() => {
          __renderQueued = false;

          // í˜„ì¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œê°€ ì—´ë ¤ìˆëŠ” ê²½ìš°, í•´ë‹¹ íƒ­ë§Œ ì—…ë°ì´íŠ¸
          if (
            currentMainTab === "dashboard" &&
            currentUser &&
            adminList.includes(currentUser.studentId)
          ) {
            const subtabContainer = document.getElementById("subtab-container");
            if (subtabContainer && currentDashboardTab) {
              // í˜„ì¬ ì—´ë ¤ìˆëŠ” ëŒ€ì‹œë³´ë“œ ì„œë¸Œíƒ­ë§Œ ë‹¤ì‹œ ë Œë”ë§
              if (currentDashboardTab === "members") {
                import("./js/dashboard.js").then(({ renderMembersAdmin }) => {
                  renderMembersAdmin(subtabContainer);
                });
              } else if (currentDashboardTab === "groups") {
                renderGroupsAdmin(subtabContainer);
              } else {
                // ë‹¤ë¥¸ íƒ­ë“¤ì€ ì „ì²´ ë Œë”ë§ í•„ìš”
                renderAll();
              }
            } else {
              renderAll();
            }
          } else {
            renderAll();
          }
        });
      };

      // ë°ì´í„° ë¡œë”© ì¬ì‹œë„ ì¹´ìš´í„°
      let dataLoadRetryCount = 0;
      const MAX_RETRY_COUNT = 5; // ì¬ì‹œë„ íšŸìˆ˜ ì¦ê°€
      let dataLoadTimeout = null;
      let forceCheckTimeout = null; // ê°•ì œ ê²€ì¦ íƒ€ì„ì•„ì›ƒ
      let dataWatchdogTimer = null; // ë°ì´í„° ì‘ë‹µ ê°ì‹œ íƒ€ì´ë¨¸
      let autoReloadTimer = null; // ìë™ ì¬ì ‘ì† íƒ€ì´ë¨¸
      const AUTO_RELOAD_INTERVAL_MS = 3000;
      const AUTO_RELOAD_PARAM = "reloadTs";
      const INITIAL_LOAD_GRACE_MS = 2000;
      const MIN_RELOAD_INTERVAL_MS = 1200;
      const MAX_AUTO_RELOAD_ATTEMPTS = Number.MAX_SAFE_INTEGER;
      const MAX_RELOAD_BACKOFF_MS = 10000;

      let pageLoadTimestamp = Date.now();
      let lastReloadTime = 0;
      let reloadAttempts = 0;

      const normalizeUrlWithoutParam = () => {
        const [base, hash = ""] = window.location.href.split("#");
        const url = new URL(base, window.location.origin);
        url.searchParams.delete(AUTO_RELOAD_PARAM);
        const normalized = url.toString();
        return hash ? `${normalized}#${hash}` : normalized;
      };

      const appendReloadParam = () => {
        const normalized = normalizeUrlWithoutParam();
        const [base, hash = ""] = normalized.split("#");
        const url = new URL(base, window.location.origin);
        url.searchParams.set(AUTO_RELOAD_PARAM, `${Date.now()}`);
        const next = url.toString();
        return hash ? `${next}#${hash}` : next;
      };

      const forceReload = (reason = "") => {
        debugLog(`ê°•ì œ ì¬ì ‘ì† ì‹¤í–‰${reason ? ` (${reason})` : ""}`);
        try {
          const now = Date.now();
          lastReloadTime = now;
          reloadAttempts = Math.min(
            reloadAttempts + 1,
            MAX_AUTO_RELOAD_ATTEMPTS + 1
          );

          const nextUrl = appendReloadParam();
          if (isKakaoTalkInAppBrowser) {
            debugLog(`ì¹´ì¹´ì˜¤ ì¸ì•± ë¸Œë¼ìš°ì € ê°•ì œ ì´ë™: ${nextUrl}`);
          }
          window.location.replace(nextUrl);
        } catch (reloadError) {
          debugError("ê°•ì œ ì¬ì ‘ì† ì‹¤íŒ¨:", reloadError);
        }
      };

      const getNetworkCheckUrl = () => {
        try {
          const { origin, pathname } = window.location;
          return `${origin}${pathname}`;
        } catch (e) {
          return window.location.href;
        }
      };

      const checkNetworkConnectivity = async () => {
        if (navigator.onLine === false) {
          return false;
        }
        try {
          await fetch(getNetworkCheckUrl(), {
            mode: "no-cors",
            cache: "no-store",
          });
          return true;
        } catch (e) {
          debugError("ë„¤íŠ¸ì›Œí¬ ì²´í¬ ì‹¤íŒ¨, ì¬ì‹œë„ ì§„í–‰:", e);
          return true;
        }
      };

      const stopDataWatchdog = () => {
        if (dataWatchdogTimer) {
          clearTimeout(dataWatchdogTimer);
          dataWatchdogTimer = null;
        }
      };

      const startDataWatchdog = () => {
        if (dataWatchdogTimer) {
          return;
        }

        dataWatchdogTimer = setTimeout(async () => {
          dataWatchdogTimer = null;
          debugError("âš ï¸ ë°ì´í„° ê°ì‹œ íƒ€ì´ë¨¸ ë°œë™ - ì‘ë‹µ ì§€ì—°");
          showManualRetryButton();

          const networkOk = await checkNetworkConnectivity();
          if (!networkOk) {
            debugLog("ë„¤íŠ¸ì›Œí¬ ì´ìƒ ê°ì§€ - ì¬ì ‘ì† ë£¨í”„ ìœ ì§€");
            ensureAutoReconnectLoop(AUTO_RELOAD_INTERVAL_MS);
            return;
          }

          forceReload("ë°ì´í„° ê°ì‹œ íƒ€ì´ë¨¸");
        }, 10000);
      };

      const showManualRetryButton = () => {
        const btn = document.getElementById("loading-retry-btn");
        if (btn) {
          btn.classList.remove("hidden");
          btn.disabled = false;
        }
      };

      const hideManualRetryButton = () => {
        const btn = document.getElementById("loading-retry-btn");
        if (btn) {
          btn.classList.add("hidden");
          btn.disabled = true;
        }
      };

      const stopAutoReconnectLoop = () => {
        if (autoReloadTimer) {
          clearTimeout(autoReloadTimer);
          autoReloadTimer = null;
        }
      };

      const resetAutoReloadState = () => {
        reloadAttempts = 0;
        lastReloadTime = 0;
        pageLoadTimestamp = Date.now();
        stopAutoReconnectLoop();
        stopDataWatchdog();
        hideManualRetryButton();
      };

      const ensureAutoReconnectLoop = (delay = AUTO_RELOAD_INTERVAL_MS) => {
        if (autoReloadTimer) {
          if (delay === 0) {
            clearTimeout(autoReloadTimer);
            autoReloadTimer = null;
          } else {
            return;
          }
        }

        autoReloadTimer = setTimeout(async () => {
          autoReloadTimer = null;

          const loadingScreen = document.getElementById("loading-screen");
          const stillLoading =
            loadingScreen &&
            !loadingScreen.classList.contains("hidden") &&
            getComputedStyle(loadingScreen).display !== "none";

          // íšŒì› ëª©ë¡ì´ ë¡œë”© ì¤‘ì¸ì§€ í™•ì¸ (ìë™ ì¬ì ‘ì† ë°©ì§€)
          const subtabContainer = document.getElementById("subtab-container");
          const isMembersLoading =
            subtabContainer &&
            (subtabContainer.innerHTML.includes("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘") ||
              subtabContainer.innerHTML.includes("íšŒì› ë°ì´í„°ê°€ ì—†ìŒ") ||
              (subtabContainer.innerHTML.includes("íšŒì› ê´€ë¦¬") &&
                !subtabContainer.innerHTML.includes("íšŒì› ëª©ë¡") &&
                !subtabContainer.innerHTML.includes("member-card")));

          if (!stillLoading && !isMembersLoading) {
            resetAutoReloadState();
            return;
          }

          // íšŒì› ëª©ë¡ì´ ë¡œë”© ì¤‘ì´ë©´ ìë™ ì¬ì ‘ì† ì¤‘ë‹¨ (ë°ì´í„° ë¡œë”© ëŒ€ê¸°)
          if (isMembersLoading) {
            debugLog("íšŒì› ëª©ë¡ ë¡œë”© ì¤‘ - ìë™ ì¬ì ‘ì† ëŒ€ê¸°");
            ensureAutoReconnectLoop(AUTO_RELOAD_INTERVAL_MS * 2); // ë” ê¸´ ê°„ê²©ìœ¼ë¡œ ì¬í™•ì¸
            return;
          }

          const now = Date.now();

          if (reloadAttempts === 0) {
            const elapsedSinceLoad = now - pageLoadTimestamp;
            if (elapsedSinceLoad < INITIAL_LOAD_GRACE_MS) {
              const wait = Math.max(
                500,
                INITIAL_LOAD_GRACE_MS - elapsedSinceLoad
              );
              debugLog(
                `ì´ˆê¸° ë¡œë”© ìœ ì˜ˆ (${elapsedSinceLoad}ms ê²½ê³¼). ${wait}ms í›„ ì¬í™•ì¸`
              );
              ensureAutoReconnectLoop(wait);
              return;
            }
          }

          const elapsedSinceReload = now - lastReloadTime;
          if (elapsedSinceReload < MIN_RELOAD_INTERVAL_MS) {
            const wait = MIN_RELOAD_INTERVAL_MS - elapsedSinceReload;
            debugLog(
              `ì¬ì ‘ì† ì¿¨ë‹¤ìš´ (${elapsedSinceReload}ms). ${wait}ms í›„ ì¬ì‹œë„`
            );
            ensureAutoReconnectLoop(wait);
            return;
          }

          if (reloadAttempts >= MAX_AUTO_RELOAD_ATTEMPTS) {
            debugError("ìë™ ì¬ì ‘ì† ìµœëŒ€ íšŸìˆ˜ ë„ë‹¬ - ìˆ˜ë™ ì•ˆë‚´ í‘œì‹œ");
            showManualRetryButton();
            stopAutoReconnectLoop();
            stopDataWatchdog();
            return;
          }

          showManualRetryButton();

          const networkOk = await checkNetworkConnectivity();
          if (!networkOk) {
            debugLog("ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¶ˆì•ˆì • - ì¬ì‹œë„ ì˜ˆì•½");
            ensureAutoReconnectLoop(AUTO_RELOAD_INTERVAL_MS);
            return;
          }

          const nextDelay = Math.min(
            AUTO_RELOAD_INTERVAL_MS,
            MAX_RELOAD_BACKOFF_MS
          );

          forceReload("ì£¼ê¸°ì  ì¬ì ‘ì†");
          ensureAutoReconnectLoop(nextDelay);
        }, delay);
      };

      document.addEventListener("DOMContentLoaded", () => {
        pageLoadTimestamp = Date.now();
        reloadAttempts = 0;
        lastReloadTime = 0;
        ensureAutoReconnectLoop(AUTO_RELOAD_INTERVAL_MS);
        const retryBtn = document.getElementById("loading-retry-btn");
        if (retryBtn) {
          retryBtn.addEventListener("click", () => {
            showManualRetryButton();
            forceReload("ì‚¬ìš©ì ìˆ˜ë™ ì¬ì‹œë„");
          });
        }
      });

      // ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€
      const isKakaoTalkInAppBrowser = /KAKAOTALK/i.test(navigator.userAgent);
      debugLog("ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ë¸Œë¼ìš°ì €:", isKakaoTalkInAppBrowser);

      const checkLoadingComplete = () => {
        debugLog(
          `ë¡œë”© ì™„ë£Œ ì²´í¬: ${__loadingDataCount}/${__expectedDataSources}, ì´ˆê¸°ë¡œë”©: ${__isInitialLoading}`
        );

        // ìˆœì°¨ì ì¸ ë¡œë”© ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        if (__isInitialLoading) {
          startDataWatchdog();
          const progressPercentage = Math.min(
            (__loadingDataCount / __expectedDataSources) * 90,
            90
          );

          // ëª¨ë“  ë‹¨ê³„ì—ì„œ "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!" ë©”ì‹œì§€ í‘œì‹œ
          let loadingMessage = "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!";

          updateLoadingProgress(1, loadingMessage);

          // 3ì´ˆ ì´ë‚´ì— ë¡œë”©ì´ ì™„ë£Œë˜ì§€ ì•Šìœ¼ë©´ ì¦‰ì‹œ ì¬ì ‘ì†
          if (!dataLoadTimeout) {
            const loadingTimeout = 3000;
            debugLog(`ë¡œë”© íƒ€ì„ì•„ì›ƒ ì„¤ì •: ${loadingTimeout / 1000}ì´ˆ`);

            dataLoadTimeout = setTimeout(() => {
              const loadingScreen = document.getElementById("loading-screen");
              const stillLoading =
                loadingScreen &&
                !loadingScreen.classList.contains("hidden") &&
                loadingScreen.style.display !== "none";

              if (stillLoading) {
                debugError(
                  `âš ï¸ ë°ì´í„° ë¡œë”© ì‹œê°„ ì´ˆê³¼ (${loadingTimeout / 1000}ì´ˆ)`
                );
                debugLog(
                  `ë¡œë“œëœ ë°ì´í„°: ${__loadingDataCount}/${__expectedDataSources}`
                );
                ensureAutoReconnectLoop();
                forceReload("ë¡œë”© íƒ€ì„ì•„ì›ƒ");
              } else {
                debugLog("ë¡œë”© í™”ë©´ì´ ì´ë¯¸ ìˆ¨ê²¨ì ¸ ì¬ì ‘ì†ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
              }
              dataLoadTimeout = null;
            }, loadingTimeout);
          }

          if (__loadingDataCount >= __expectedDataSources) {
            debugLog("ëª¨ë“  ë°ì´í„° ì†ŒìŠ¤ ì¹´ìš´íŠ¸ ì™„ë£Œ. ë°ì´í„° ê²€ì¦ ì‹œì‘...");
            updateLoadingProgress(2, "ë°ì´í„° í™•ì¸ ì¤‘...");

            // íƒ€ì„ì•„ì›ƒ í´ë¦¬ì–´
            if (dataLoadTimeout) {
              clearTimeout(dataLoadTimeout);
              dataLoadTimeout = null;
            }
            resetAutoReloadState();

            // ë°ì´í„° ì™„ì „ ë¡œë“œ í™•ì¸ (ë¡œë”© í™”ë©´ì€ verifyAllDataLoadedì—ì„œë§Œ ìˆ¨ê¹€)
            // __isInitialLoadingì€ verifyAllDataLoadedì—ì„œ ì‹¤ì œë¡œ ë°ì´í„°ê°€ í™•ì¸ë  ë•Œ falseë¡œ ì„¤ì •
            verifyAllDataLoaded();

            // ê°•ì œ ê²€ì¦ íƒ€ì„ì•„ì›ƒ ì¶”ê°€ (5ì´ˆ í›„ì—ë„ ë¡œë”© í™”ë©´ì´ ë‚¨ì•„ìˆìœ¼ë©´ ê°•ì œë¡œ ìˆ¨ê¹€)
            if (forceCheckTimeout) {
              clearTimeout(forceCheckTimeout);
            }
            forceCheckTimeout = setTimeout(() => {
              const loadingScreen = document.getElementById("loading-screen");
              if (
                loadingScreen &&
                !loadingScreen.classList.contains("hidden")
              ) {
                debugLog("âš ï¸ ê°•ì œ ê²€ì¦ íƒ€ì„ì•„ì›ƒ: ë¡œë”© í™”ë©´ ê°•ì œ ìˆ¨ê¹€");
                const hasCriticalData =
                  eventsData &&
                  Array.isArray(eventsData) &&
                  foodMenusData &&
                  Array.isArray(foodMenusData);

                // ìˆœì°¨ ë¡œë”©ì´ ì™„ë£Œë˜ì—ˆê³  í•„ìˆ˜ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¡œë”© í™”ë©´ ë‹«ê¸°
                if (hasCriticalData && sequentialLoadingComplete) {
                  __isInitialLoading = false;
                  hideLoadingScreen();
                  stopDataWatchdog();
                  resetAutoReloadState();
                  hideManualRetryButton();
                } else if (!sequentialLoadingComplete) {
                  debugLog(
                    "â³ ìˆœì°¨ ë¡œë”©ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•„ ë¡œë”© í™”ë©´ì„ ìœ ì§€í•©ë‹ˆë‹¤."
                  );
                }
              }
            }, 5000); // 5ì´ˆ í›„ ê°•ì œ ê²€ì¦
          }
        }
      };

      // ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ ê²€ì¦ í•¨ìˆ˜
      const verifyAllDataLoaded = (retryCount = 0) => {
        debugLog("=== ë°ì´í„° ë¡œë“œ ì™„ì „ì„± ê²€ì¦ ===", retryCount);

        // í•„ìˆ˜ ë°ì´í„°ë§Œ í™•ì¸ (eventsì™€ foodMenusë§Œ í•„ìˆ˜)
        const hasCriticalData =
          eventsData &&
          Array.isArray(eventsData) &&
          foodMenusData &&
          Array.isArray(foodMenusData);

        debugLog("í•„ìˆ˜ ë°ì´í„° í™•ì¸:");
        debugLog("- eventsData:", hasCriticalData, eventsData?.length || 0);
        debugLog(
          "- foodMenusData:",
          foodMenusData && Array.isArray(foodMenusData),
          foodMenusData?.length || 0
        );

        // ë°°ì—´ì´ë©´ ë°ì´í„°ê°€ ë¡œë“œëœ ê²ƒìœ¼ë¡œ ê°„ì£¼ (ë¹ˆ ë°°ì—´ë„ OK)
        const hasRoadmap = roadmapData && Array.isArray(roadmapData);
        const hasEvents = eventsData && Array.isArray(eventsData);
        const hasBlocks = blocksData && Array.isArray(blocksData);
        const hasMembers = membersData && Array.isArray(membersData);
        const hasAdmins = adminList && Array.isArray(adminList);
        const hasFoodMenus = foodMenusData && Array.isArray(foodMenusData);

        debugLog("ì „ì²´ ë°ì´í„° í™•ì¸:");
        debugLog("- roadmapData:", hasRoadmap, roadmapData?.length || 0);
        debugLog("- eventsData:", hasEvents, eventsData?.length || 0);
        debugLog("- blocksData:", hasBlocks, blocksData?.length || 0);
        debugLog("- membersData:", hasMembers, membersData?.length || 0);
        debugLog("- adminList:", hasAdmins, adminList?.length || 0);
        debugLog("- foodMenusData:", hasFoodMenus, foodMenusData?.length || 0);

        // í•„ìˆ˜ ë°ì´í„°ë§Œ í™•ì¸ (eventsì™€ foodMenusë§Œ í•„ìˆ˜)
        const allDataLoaded = hasCriticalData;

        if (allDataLoaded) {
          // ëª¨ë“  ë°ì´í„°ê°€ ì‹¤ì œë¡œ ë¡œë“œëœ ê²½ìš°ì—ë§Œ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
          __isInitialLoading = false;
          debugLog("âœ… ëª¨ë“  ì»¨í…ì¸ ê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
          debugLog("ğŸ“Š ìµœì¢… ë°ì´í„° ìš”ì•½:");
          debugLog(`  - ë¡œë“œë§µ: ${roadmapData.length}ê°œ`);
          debugLog(`  - ì´ë²¤íŠ¸: ${eventsData.length}ê°œ`);
          debugLog(`  - ë¸”ë¡: ${blocksData.length}ê°œ`);
          debugLog(`  - íšŒì›: ${membersData.length}ëª…`);
          debugLog(`  - ê´€ë¦¬ì: ${adminList.length}ëª…`);
          debugLog(`  - ë­ë¨¹ì§€ ë©”ë‰´: ${foodMenusData.length}ê°œ`);

          // ëª¨ë“  ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìœ¼ë¯€ë¡œ ë¡œë”© í™”ë©´ ë‹«ê¸°
          updateLoadingProgress(100, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
          setTimeout(() => {
            hideLoadingScreen();
            debugLog("ğŸ‰ ë°ì´í„° ë¡œë”© ì™„ë£Œ - ì •ìƒ í‘œì‹œë¨");
          }, 500);
        } else {
          debugWarn(`âš ï¸ ì¼ë¶€ ë°ì´í„° ë¯¸ë¡œë“œ (ì¬í™•ì¸ ${retryCount + 1}/10)`);

          // ì–´ë–¤ ë°ì´í„°ê°€ ì—†ëŠ”ì§€ ëª…ì‹œ
          if (!hasRoadmap) debugWarn("  âŒ ë¡œë“œë§µ ë°ì´í„° ì—†ìŒ");
          if (!hasEvents) debugWarn("  âŒ ì´ë²¤íŠ¸ ë°ì´í„° ì—†ìŒ");
          if (!hasBlocks) debugWarn("  âŒ ë¸”ë¡ ë°ì´í„° ì—†ìŒ");
          if (!hasMembers) debugWarn("  âŒ íšŒì› ë°ì´í„° ì—†ìŒ");
          if (!hasAdmins) debugWarn("  âŒ ê´€ë¦¬ì ë°ì´í„° ì—†ìŒ");
          if (!hasFoodMenus) debugWarn("  âŒ ë­ë¨¹ì§€ ë©”ë‰´ ë°ì´í„° ì—†ìŒ");

          // ë¡œë”© í™”ë©´ ìœ ì§€í•˜ë©´ì„œ ê³„ì† ì¬í™•ì¸ (ìµœëŒ€ 3íšŒ = 6ì´ˆ)
          if (retryCount < 3) {
            // ì§„í–‰ë¥  í‘œì‹œ ì—…ë°ì´íŠ¸
            const progress = Math.min(90 + (retryCount / 3) * 5, 95);
            updateLoadingProgress(
              progress,
              `ë°ì´í„° í™•ì¸ ì¤‘... (${retryCount + 1}/3)`
            );

            setTimeout(() => {
              verifyAllDataLoaded(retryCount + 1);
            }, 2000); // 2ì´ˆë§ˆë‹¤ ì¬í™•ì¸
          } else {
            // ìµœëŒ€ ì¬ì‹œë„ í›„ì—ë„ í•„ìˆ˜ ë°ì´í„°ë§Œ ìˆìœ¼ë©´ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
            if (hasCriticalData) {
              debugLog("âš ï¸ í•„ìˆ˜ ë°ì´í„°ë§Œ ë¡œë“œë¨. ë¡œë”© í™”ë©´ ë‹«ê¸°");
              __isInitialLoading = false;
              updateLoadingProgress(100, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
              setTimeout(() => {
                hideLoadingScreen();
                debugLog("ğŸ‰ í•„ìˆ˜ ë°ì´í„° ë¡œë”© ì™„ë£Œ - ì •ìƒ í‘œì‹œë¨");
              }, 500);
            } else {
              debugError("âŒ ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ (6ì´ˆ)");
              debugError("ğŸ”„ ìë™ ì¬ì ‘ì† ì‹œë„...");
              updateLoadingProgress(95, "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. ì¬ì ‘ì† ì¤‘...");
              // 1ì´ˆ í›„ ìë™ ì¬ì ‘ì†
              setTimeout(() => {
                showManualRetryButton();
                ensureAutoReconnectLoop(MIN_RELOAD_INTERVAL_MS);
                forceReload("ë°ì´í„° í™•ì¸ ì‹¤íŒ¨");
              }, 1000);
            }
          }
        }
      };

      // ì»¨í…ì¸ ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
      const checkContentLoaded = () => {
        debugLog("=== ì»¨í…ì¸  ë¡œë“œ ìƒíƒœ í™•ì¸ ===");

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
        const isOnline = navigator.onLine;
        debugLog("ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:", isOnline ? "ì˜¨ë¼ì¸" : "ì˜¤í”„ë¼ì¸");

        // ìš°ì„ ìˆœìœ„ ë°ì´í„° í™•ì¸ (ê°€ì¥ ì¤‘ìš”í•œ ë°ì´í„°ë¶€í„°)
        const hasValidRoadmapData =
          roadmapData &&
          roadmapData.length > 0 &&
          roadmapData.some(
            (item) => item && item.id // IDë§Œ ìˆìœ¼ë©´ ìœ íš¨í•œ ë°ì´í„°ë¡œ ê°„ì£¼
          );
        const hasValidEventsData = eventsData && eventsData.length > 0;
        const hasValidBlocksData = blocksData && blocksData.length > 0;
        const hasValidMembersData = membersData && membersData.length > 0;
        const hasValidFoodMenusData =
          foodMenusData && Array.isArray(foodMenusData);

        debugLog("ìš°ì„ ìˆœìœ„ ë°ì´í„° ê²€ì‚¬:");
        debugLog(
          "- roadmapData (ìµœìš°ì„ ):",
          hasValidRoadmapData,
          roadmapData?.length || 0
        );
        debugLog("- eventsData:", hasValidEventsData, eventsData?.length || 0);
        debugLog("- blocksData:", hasValidBlocksData, blocksData?.length || 0);
        debugLog(
          "- membersData:",
          hasValidMembersData,
          membersData?.length || 0
        );
        debugLog(
          "- foodMenusData:",
          hasValidFoodMenusData,
          foodMenusData?.length || 0
        );

        // DOM ìš”ì†Œ í™•ì¸
        const mainContentEl = document.getElementById("main-content");
        const preContentEl = document.getElementById("pre-content");
        const loadingScreenEl = document.getElementById("loading-screen");

        const hasMainContent =
          mainContentEl && !mainContentEl.classList.contains("hidden");
        const hasPreContent =
          preContentEl && !preContentEl.classList.contains("hidden");
        const isLoadingScreenVisible =
          loadingScreenEl &&
          loadingScreenEl.style.display !== "none" &&
          !loadingScreenEl.classList.contains("hidden");

        debugLog("hasMainContent:", hasMainContent);
        debugLog("hasPreContent:", hasPreContent);
        debugLog("isLoadingScreenVisible:", isLoadingScreenVisible);

        // í˜ì´ì§€ ë¡œë“œ ì‹œê°„ í™•ì¸ (ë„ˆë¬´ ë¹¨ë¦¬ ì²´í¬í•˜ì§€ ì•Šë„ë¡)
        const pageLoadTime =
          Date.now() -
          (window.performance?.timing?.navigationStart || Date.now());
        debugLog("í˜ì´ì§€ ë¡œë“œ ì‹œê°„:", pageLoadTime + "ms");

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ í™•ì¸
        const isLoggedOut = !currentUser;

        // ì¬ì ‘ì† ì¡°ê±´ ì™„í™” (ë„ˆë¬´ ë¹ ë¥¸ ì¬ì ‘ì† ë°©ì§€)
        const criticalDataMissing =
          !hasValidRoadmapData && !hasValidEventsData && !hasValidBlocksData;

        // UI ê°€ì‹œì„± í™•ì¸ (ë” ê¸´ ì‹œê°„ ëŒ€ê¸°)
        const uiNotVisible = !hasMainContent && !hasPreContent;
        const stillLoading = isLoadingScreenVisible && pageLoadTime > 15000; // 15ì´ˆë¡œ ì¦ê°€
        const networkIssues = !isOnline && pageLoadTime > 10000; // 10ì´ˆë¡œ ì¦ê°€

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì¬ì ‘ì† ì•ˆ í•¨
        const needsQuickReconnect =
          !isLoggedOut &&
          (stillLoading || networkIssues) &&
          criticalDataMissing;

        debugLog("ì¬ì ‘ì† ì¡°ê±´:");
        debugLog("- í•µì‹¬ ë°ì´í„° ì—†ìŒ:", criticalDataMissing);
        debugLog("- ë¡œë”© ì§€ì—° (15ì´ˆ ì´ìƒ):", stillLoading);
        debugLog("- ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ (10ì´ˆ ì´ìƒ):", networkIssues);
        debugLog("- ì¬ì ‘ì† í•„ìš”:", needsQuickReconnect);

        // ì¬ì ‘ì†ì€ ë§¤ìš° ë“œë¬¸ ê²½ìš°ì—ë§Œ ì‹¤í–‰ (15ì´ˆ ì´ìƒ ë¡œë”© ì¤‘ì´ê³  ë°ì´í„° ì—†ì„ ë•Œë§Œ)
        if (needsQuickReconnect) {
          debugWarn("âš ï¸ ì¥ì‹œê°„ ë¡œë”© ì‹¤íŒ¨! ì¬ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤.");
          debugLog("ğŸ”„ ì¬ì ‘ì† ì‹¤í–‰");
          location.reload();
        } else {
          debugLog("âœ… ì¬ì ‘ì† ë¶ˆí•„ìš” - ì •ìƒ ë¡œë”© ì¤‘");
        }
      };

      /* ===== ì¸ì¦ & ê¶Œí•œ ===== */
      async function login() {
        const sid = el.id.value.trim();
        const nm = el.name.value.trim();

        // ë¹„ìƒë³µêµ¬ëª¨ë“œ: ë§ˆìŠ¤í„° ì½”ë“œ ì…ë ¥ ì‹œ ì´ë¦„ ì—†ì´ë„ ì ‘ê·¼ ê°€ëŠ¥
        if (sid === MASTER_CODE) {
          if (nm === "") {
            return el.emerg.classList.remove("hidden");
          } else {
            // ì´ë¦„ì´ ì…ë ¥ëœ ê²½ìš° ë¹„ìƒë³µêµ¬ëª¨ë“œë¡œ ë¡œê·¸ì¸
            currentUser = { studentId: sid, name: nm };
            myProfileData = null;
            myProfileLoading = false;

            // ë¹„ìƒë³µêµ¬ëª¨ë“œì—ì„œëŠ” ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬
            adminList = [sid];
            adminPositions = { [sid]: "ë¹„ìƒë³µêµ¬ê´€ë¦¬ì" };
            currentUser.position = "ë¹„ìƒë³µêµ¬ê´€ë¦¬ì";

            localStorage.setItem(
              "foodieUser",
              JSON.stringify({
                studentId: sid,
                name: nm,
                position: currentUser.position,
              })
            );

            debugLog("=== ë¹„ìƒë³µêµ¬ëª¨ë“œ ë¡œê·¸ì¸ ===");
            debugLog("currentUser:", currentUser);
            debugLog("adminList:", adminList);

            ensureAdminOptionals();
            renderAll();
            return;
          }
        }

        if (!sid || !nm)
          return showAlert("ğŸ˜¥", "í•™ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        try {
          debugLog("=== ë¡œê·¸ì¸ ì‹œë„ ===");
          debugLog("ì…ë ¥ í•™ë²ˆ:", sid);
          debugLog("ì…ë ¥ ì´ë¦„:", nm);

          const mref = doc(db, "members", sid);
          const ms = await getDoc(mref);

          debugLog("Firebase ì¡°íšŒ ê²°ê³¼:", {
            exists: ms.exists(),
            data: ms.exists() ? ms.data() : null,
          });

          if (!ms.exists())
            return showAlert(
              "â›”",
              "ë“±ë¡ëœ íšŒì›ì´ ì•„ë‹™ë‹ˆë‹¤. íšŒì›ê°€ì… ê¸°ê°„ì— <b>íšŒì›ê°€ì…</b> ë²„íŠ¼ìœ¼ë¡œ ê°€ì…í•´ì£¼ì„¸ìš”."
            );
          const data = ms.data() || {};

          debugLog("íšŒì› ë°ì´í„°:", data);
          debugLog("ì´ë¦„ ë¹„êµ:", {
            ì…ë ¥ì´ë¦„: nm,
            ì €ì¥ëœì´ë¦„: (data.name || "").trim(),
            ì¼ì¹˜ì—¬ë¶€: (data.name || "").trim() === nm,
          });

          if ((data.name || "").trim() !== nm)
            return showAlert(
              "ğŸ™…â€â™‚ï¸",
              "ì…ë ¥í•œ ì´ë¦„ì´ íšŒì› ì •ë³´ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìš´ì˜ì§„ì—ê²Œ ìˆ˜ì • ìš”ì²­í•´ì£¼ì„¸ìš”."
            );
          const status = data.status || "active";
          // ê°œë°œìš©: pending ìƒíƒœë„ í—ˆìš©í•˜ê³  ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬
          if (status === "pending") {
            debugLog("âš ï¸ ê°œë°œ ëª¨ë“œ: pending ìƒíƒœ ì‚¬ìš©ìë„ ë¡œê·¸ì¸ í—ˆìš©");
          }
          if (status === "rejected")
            return showAlert(
              "â›”",
              "ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤. ìš´ì˜ì§„ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”."
            );
          if (status === "blocked")
            return showAlert(
              "â›”",
              "ì ‘ê·¼ì´ ì œí•œëœ íšŒì›ì…ë‹ˆë‹¤. ìš´ì˜ì§„ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”."
            );

          currentUser = { studentId: sid, name: nm, status: status };
          myProfileData = null;
          myProfileLoading = false;

          // ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ëœ ê²½ìš° ì •ë³´ ì €ì¥
          const autoLoginCheckbox = document.getElementById(
            "auto-login-checkbox"
          );
          if (autoLoginCheckbox && autoLoginCheckbox.checked) {
            saveAutoLogin(sid, nm);
          }
          startPresence();
          try {
            const a = await getDoc(doc(db, "admins", "list"));
            adminList = a.exists() ? a.data().studentIds || [] : [];
            adminPositions = a.exists() ? a.data().positions || {} : {};

            // ê´€ë¦¬ìì¸ ê²½ìš° currentUser.position ì„¤ì •
            if (currentUser && adminList.includes(currentUser.studentId)) {
              currentUser.position =
                adminPositions[currentUser.studentId] || "ì¼ë°˜ íšŒì›";
              debugLog("=== ì‚¬ìš©ì ì§ì±… ì„¤ì • ===");
              debugLog("currentUser.studentId:", currentUser.studentId);
              debugLog("adminPositions:", adminPositions);
              debugLog("ì„¤ì •ëœ ì§ì±…:", currentUser.position);
            }
          } catch {}

          // position ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ localStorageì— ì €ì¥
          localStorage.setItem(
            "foodieUser",
            JSON.stringify({
              studentId: currentUser.studentId,
              name: currentUser.name,
              position: currentUser.position,
              status: currentUser.status,
            })
          );
          ensureAdminOptionals();

          renderAll();
        } catch (e) {
          debugWarn(e);
          showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }
      const logout = async () => {
        try {
          // ëª¨ë“  ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ (Firebase ê¶Œí•œ ì˜¤ë¥˜ ë°©ì§€)
          clearPublic();
          clearAdmin();
          stopPresence();
          localStorage.removeItem("foodieUser");
          currentUser = null;
          clearAutoLogin(); // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
          myProfileData = null;
          myProfileLoading = false;
          firebaseKakaoInfoLoadedForUser = null; // Firebase ì •ë³´ ë¡œë“œ í”Œë˜ê·¸ ë¦¬ì…‹
          await signOut(auth);
          clearAutoCloseScheduler();

          // ë¡œë”© í™”ë©´ í‘œì‹œ ë° "ì˜ ë¨¹ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€
          const loadingScreen = document.getElementById("loading-screen");
          const loadingText = document.getElementById("loading-text");
          const progressBar = document.getElementById("progress-bar");

          if (loadingScreen) {
            loadingScreen.classList.remove("hidden");
          }

          // ë¡œë”©ë°”ì™€ í…ìŠ¤íŠ¸ ì§ì ‘ ì—…ë°ì´íŠ¸
          if (progressBar) {
            progressBar.style.width = "100%";
            progressBar.style.transition =
              "width 0.8s cubic-bezier(0.4, 0, 0.2, 1)";
          }

          if (loadingText) {
            loadingText.textContent = "ì˜ ë¨¹ì—ˆìŠµë‹ˆë‹¤!";
            loadingText.style.opacity = "1";
            loadingText.style.transition = "opacity 0.3s ease";
          }

          // 2ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            location.reload();
          }, 2000);
        } catch (e) {
          debugWarn(e);
          location.reload();
        }
      };
      async function verifyAutoLogin(saved) {
        try {
          const mref = doc(db, "members", saved.studentId);
          const ms = await getDoc(mref);
          if (!ms.exists()) return logout();
          const d = ms.data() || {};
          if ((d.name || "").trim() !== saved.name) return logout();
          // ê°œë°œìš©: pending ìƒíƒœë„ í—ˆìš©
          const status = d.status || "active";
          if (status === "rejected" || status === "blocked") return logout();
          try {
            const a = await getDoc(doc(db, "admins", "list"));
            adminList = a.exists() ? a.data().studentIds || [] : [];
            adminPositions = a.exists() ? a.data().positions || {} : {};

            // ê´€ë¦¬ìì¸ ê²½ìš° currentUser.position ì„¤ì •
            if (currentUser && adminList.includes(currentUser.studentId)) {
              currentUser.position =
                adminPositions[currentUser.studentId] || "ì¼ë°˜ íšŒì›";
              debugLog("=== ìë™ ë¡œê·¸ì¸ ì‚¬ìš©ì ì§ì±… ì„¤ì • ===");
              debugLog("currentUser.studentId:", currentUser.studentId);
              debugLog("adminPositions:", adminPositions);
              debugLog("ì„¤ì •ëœ ì§ì±…:", currentUser.position);

              // localStorageì—ë„ ì—…ë°ì´íŠ¸ëœ position ì €ì¥
              localStorage.setItem(
                "foodieUser",
                JSON.stringify({
                  studentId: currentUser.studentId,
                  name: currentUser.name,
                  position: currentUser.position,
                })
              );
            }
          } catch {}
          ensureAdminOptionals();
        } catch {}
      }

      /* ===== Presence ===== */
      function startPresence() {
        if (!currentUser) return;
        try {
          const ref = doc(db, "presence", currentUser.studentId);
          const ping = () =>
            setDoc(
              ref,
              {
                studentId: currentUser.studentId,
                name: currentUser.name,
                ua: navigator.userAgent,
                lastActiveMs: Date.now(),
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            );
          ping();
          if (presenceTimer) clearInterval(presenceTimer);
          presenceTimer = setInterval(ping, 25000);
          const end = () => ping();
          let hiddenTime = null;
          window.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") {
              hiddenTime = Date.now();
              end();
            } else {
              // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ê²Œ ë  ë•Œ
              if (hiddenTime && Date.now() - hiddenTime > 30000) {
                // 30ì´ˆ ì´ìƒ í˜ì´ì§€ë¥¼ ë²—ì–´ë‚¬ë‹¤ê°€ ëŒì•„ì˜¨ ê²½ìš° ë¦¬ë¡œë“œ
                window.location.reload();
              } else {
                ping();
              }
              hiddenTime = null;
            }
          });
          window.addEventListener("pagehide", end);
          window.addEventListener("beforeunload", end);
        } catch (e) {
          debugWarn("presence start err", e);
        }
      }
      function stopPresence() {
        if (presenceTimer) {
          clearInterval(presenceTimer);
          presenceTimer = null;
        }
      }
      function computeOnline() {
        const threshold = Date.now() - 60 * 1000;
        onlineUsers = presenceData
          .filter((p) => (p.lastActiveMs || 0) >= threshold)
          .sort((a, b) => b.lastActiveMs - a.lastActiveMs);
      }
      function renderPresenceUI() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin) {
          el.presenceBadge.classList.add("hidden");
          el.presencePop.classList.add("hidden");
          return;
        }
        el.presenceBadge.classList.remove("hidden");
        el.presenceCount.textContent = onlineUsers.length;
        el.presenceList.innerHTML = onlineUsers.length
          ? onlineUsers
              .map(
                (u) =>
                  `<div class="flex items-center justify-between py-1"><div class="truncate"><b>${saf(
                    u.name || ""
                  )}</b> <span class="text-xs text-gray-500 font-mono">${mask(
                    u.studentId
                  )}</span></div><div class="text-xs text-gray-500 ml-2">${timeAgo(
                    u.lastActiveMs || 0
                  )}</div></div>`
              )
              .join("")
          : `<div class="text-gray-400">ì§€ê¸ˆì€ ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      }

      document.addEventListener("click", (e) => {
        if (
          !e.target.closest("#presence-badge") &&
          !e.target.closest("#presence-pop")
        )
          el.presencePop.classList.add("hidden");
        if (
          !e.target.closest("#notification-badge") &&
          !e.target.closest("#notification-pop")
        ) {
          el.notificationPop?.classList.add("hidden");
          const notificationBtn = document.getElementById("notification-badge");
          notificationBtn?.setAttribute("aria-expanded", "false");
        }
      });
      document
        .getElementById("presence-badge")
        .addEventListener("click", () =>
          el.presencePop.classList.toggle("hidden")
        );

      // ì•Œë¦¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      const notificationBadgeEl = document.getElementById("notification-badge");
      if (notificationBadgeEl) {
        notificationBadgeEl.addEventListener("click", () => {
          if (!el.notificationPop) return;
          const isHidden = el.notificationPop.classList.toggle("hidden");
          notificationBadgeEl.setAttribute(
            "aria-expanded",
            (!isHidden).toString()
          );
        });
      }
      /* ===== ë¦¬ìŠ¤ë„ˆ ===== */
      const unsubPublic = {
        admins: null,
        signup: null,
        dues: null,
        blocks: null,
        customPositions: null,
        roadmap: null,
        events: null,
        notifications: null,
      };
      const unsubAdmin = {
        suggestions: null,
        history: null,
        members: null,
        presence: null,
      };
      const clearPublic = () =>
        Object.keys(unsubPublic).forEach((k) => {
          if (unsubPublic[k]) {
            unsubPublic[k]();
            unsubPublic[k] = null;
          }
        });
      const clearAdmin = () =>
        Object.keys(unsubAdmin).forEach((k) => {
          if (unsubAdmin[k]) {
            unsubAdmin[k]();
            unsubAdmin[k] = null;
          }
        });

      let realtimeRecoveryAttempts = 0;
      let realtimeRecoveryTimer = null;
      let realtimeRecoveryPending = false;

      const markRealtimeHealthy = () => {
        realtimeRecoveryAttempts = 0;
        realtimeRecoveryPending = false;
        if (realtimeRecoveryTimer) {
          clearTimeout(realtimeRecoveryTimer);
          realtimeRecoveryTimer = null;
        }
      };

      const restartRealtimeListeners = (reason, immediate = false) => {
        if (realtimeRecoveryPending && !immediate) return;
        realtimeRecoveryPending = true;

        realtimeRecoveryAttempts = Math.min(realtimeRecoveryAttempts + 1, 6);
        const delay = immediate
          ? 0
          : Math.min(15000, 500 * Math.pow(2, realtimeRecoveryAttempts - 1));

        if (realtimeRecoveryTimer) {
          clearTimeout(realtimeRecoveryTimer);
        }

        const restartAction = () => {
          realtimeRecoveryTimer = null;
          realtimeRecoveryPending = false;
          const wasInitial = __isInitialLoading;
          if (wasInitial) {
            __loadingDataCount = 0;
          }
          clearPublic();
          clearAdmin();
          startPublicListeners();
          if (currentUser && adminList.includes(currentUser.studentId)) {
            startAdminListeners();
          }
        };

        if (delay === 0) {
          restartAction();
        } else {
          realtimeRecoveryTimer = setTimeout(restartAction, delay);
        }
      };

      const handleRealtimeListenerError = (context, error) => {
        console.warn(`[Firestore] ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜ ë°œìƒ (${context})`, error);

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ëª¨ë“  ì˜¤ë¥˜ë¥¼ ë¬´ì‹œ (ì •ìƒì ì¸ ë™ì‘)
        if (!currentUser) {
          console.log(
            `[Firestore] ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜ ë¬´ì‹œ (${context})`
          );
          return;
        }

        // ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ ì˜¤ë¥˜ ì²˜ë¦¬
        if (error?.code === "permission-denied") {
          showAlert(
            "âš ï¸",
            "ì¼ë¶€ ë°ì´í„°ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”."
          );
          return;
        }
        restartRealtimeListeners(`listener-error:${context}`);
      };

      window.addEventListener("online", () => {
        restartRealtimeListeners("network-online", true);
      });

      const DEMO = {
        roadmap: [
          {
            id: "r1",
            activityName: "Foodie ê°œê°•ì´íšŒ ğŸ»",
            activityDate: "2025-09-16",
            order: 0,
          },
          {
            id: "r2",
            activityName: "ğŸ™‹ğŸ»â€â™‚ï¸Foodie ì¡°ëª¨ì„ ì‹œì‘ !",
            activityDate: "2025-09-22",
            order: 1,
          },
          {
            id: "r3",
            activityName: "ğŸ‘¨ğŸ»â€ğŸ³Foodie ë¯¸ì‹íšŒ (í“¨ì „ìš”ë¦¬)",
            activityDate: "2025-09-24",
            order: 2,
          },
          {
            id: "r4",
            activityName: "ğŸ¥© Foodie ë¯¸ì‹íšŒ (ì–‘ì‹)ğŸ",
            activityDate: "2025-10-14",
            order: 3,
          },
          {
            id: "r5",
            activityName: "âœ¨ Foodie ë¯¸ì‹íšŒ (ë¯¸ì •)âœ¨",
            activityDate: "2025-11-05",
            order: 4,
          },
          {
            id: "r6",
            activityName: "Foodie MT ë– ë‚˜ìš”ğŸš—",
            activityDate: "2025-11-08",
            order: 5,
          },
          {
            id: "r7",
            activityName: "âœ¨ Foodie ë¯¸ì‹íšŒ (ë¯¸ì •)âœ¨",
            activityDate: "2025-11-12",
            order: 6,
          },
          {
            id: "r8",
            activityName: "âœ¨ Foodie ë¯¸ì‹íšŒ (ë¯¸ì •)âœ¨",
            activityDate: "2025-11-19",
            order: 7,
          },
          {
            id: "r9",
            activityName: "ğŸ™‹ğŸ»â€â™‚ï¸Foodie ì¡°ëª¨ì„ ì¢…ë£ŒğŸ‘‹",
            activityDate: "2025-11-25",
            order: 8,
          },
          {
            id: "r10",
            activityName: "ğŸ˜¢ì•„ì‰¬ìš´ ì¢…ê°•ì´íšŒğŸ˜¢",
            activityDate: "2025-12-05",
            order: 9,
          },
        ],
      };

      function startPublicListeners() {
        // ìˆœì°¨ ë¡œë”©ì„ ìœ„í•œ í
        const listenerQueue = [];
        let isProcessing = false;

        // ë¦¬ìŠ¤ë„ˆë¥¼ íì— ì¶”ê°€í•˜ê³  ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
        const addToQueue = (setupFn, key) => {
          listenerQueue.push({ setupFn, key });
          if (!isProcessing) {
            processQueue();
          }
        };

        // íì—ì„œ í•˜ë‚˜ì”© ì²˜ë¦¬
        const processQueue = async () => {
          if (isProcessing || listenerQueue.length === 0) return;
          isProcessing = true;

          while (listenerQueue.length > 0) {
            const { setupFn, key } = listenerQueue.shift();
            await new Promise((resolve) => {
              console.log(`[ìˆœì°¨ ë¡œë”©] ${key} ë°ì´í„° ë¡œë”© ì‹œì‘...`);

              // ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜ë¥¼ ë˜í•‘í•˜ì—¬ ì™„ë£Œ ì‹œ resolve
              const resolveOnce = () => {
                console.log(`[ìˆœì°¨ ë¡œë”©] ${key} ë°ì´í„° ë¡œë”© ì™„ë£Œ`);
                // ë‹¤ìŒ ë¦¬ìŠ¤ë„ˆë¥¼ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—°
                setTimeout(resolve, 200);
              };

              setupFn(resolveOnce);
            });
          }

          isProcessing = false;
          console.log("[ìˆœì°¨ ë¡œë”©] ëª¨ë“  ë°ì´í„° ë¡œë”© ì™„ë£Œ");

          // ìˆœì°¨ ë¡œë”© ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì •
          if (
            typeof window !== "undefined" &&
            window.setSequentialLoadingComplete
          ) {
            window.setSequentialLoadingComplete(true);
            console.log("[ìˆœì°¨ ë¡œë”©] í”Œë˜ê·¸ ì„¤ì • ì™„ë£Œ");
          } else {
            console.warn(
              "[ìˆœì°¨ ë¡œë”©] setSequentialLoadingComplete í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            );
          }

          // ìˆœì°¨ ë¡œë”© ì™„ë£Œ ì‹œ ë¡œë”© í™”ë©´ ë‹«ê¸° (ì§ì ‘ ë‹«ê¸°)
          const closeLoadingScreen = () => {
            console.log("[ìˆœì°¨ ë¡œë”©] ë¡œë”© í™”ë©´ ë‹«ê¸° ì‹œë„");
            const loadingScreen = document.getElementById("loading-screen");
            if (loadingScreen) {
              console.log("[ìˆœì°¨ ë¡œë”©] ë¡œë”© í™”ë©´ ìš”ì†Œ ì°¾ìŒ, ë‹«ëŠ” ì¤‘...");
              // í”Œë˜ê·¸ ì„¤ì • (ë‚˜ì¤‘ì— hideLoadingScreenì´ í˜¸ì¶œë  ë•Œë¥¼ ëŒ€ë¹„)
              if (
                typeof window !== "undefined" &&
                window.setSequentialLoadingComplete
              ) {
                window.setSequentialLoadingComplete(true);
              }
              // ì§ì ‘ ë¡œë”© í™”ë©´ ë‹«ê¸°
              loadingScreen.style.display = "none";
              loadingScreen.style.visibility = "hidden";
              loadingScreen.style.opacity = "0";
              loadingScreen.style.pointerEvents = "none";
              loadingScreen.style.zIndex = "-1";
              loadingScreen.classList.add("hidden");
              console.log("[ìˆœì°¨ ë¡œë”©] ë¡œë”© í™”ë©´ ë‹«ê¸° ì™„ë£Œ");

              // window.hideLoadingScreenë„ í˜¸ì¶œ (í˜¹ì‹œ ë‹¤ë¥¸ ë¡œì§ì´ ìˆì„ ìˆ˜ ìˆìŒ)
              if (typeof window !== "undefined" && window.hideLoadingScreen) {
                try {
                  window.hideLoadingScreen();
                } catch (e) {
                  console.warn(
                    "[ìˆœì°¨ ë¡œë”©] hideLoadingScreen í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:",
                    e
                  );
                }
              }
            } else {
              console.warn("[ìˆœì°¨ ë¡œë”©] ë¡œë”© í™”ë©´ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
          };

          // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ëª¨ë“  ë°ì´í„°ê°€ ì™„ì „íˆ ì²˜ë¦¬ë˜ë„ë¡ í•¨
          setTimeout(closeLoadingScreen, 300);
        };

        // ê° ë¦¬ìŠ¤ë„ˆë¥¼ íì— ì¶”ê°€
        if (!unsubPublic.homelayout) {
          const setupHomeLayout = (resolveOnce) => {
            let resolved = false;
            const resolveOnceWrapper = () => {
              if (!resolved) {
                resolved = true;
                resolveOnce();
              }
            };
            unsubPublic.homelayout = onSnapshot(
              doc(db, "settings", "homeLayout"),
              (snap) => {
                markRealtimeHealthy();
                homeLayout = snap.exists() ? snap.data().order || [] : [];
                applyHomeLayoutOrder();
                scheduleRender();
                resolveOnceWrapper();
              },
              (err) => {
                handleRealtimeListenerError("homeLayout", err);
                resolveOnceWrapper();
              }
            );
          };
          addToQueue(setupHomeLayout, "homeLayout");
        }
        if (!unsubPublic.admins) {
          const setupAdmins = (resolveOnce) => {
            let resolved = false;
            const resolveOnceWrapper = () => {
              if (!resolved) {
                resolved = true;
                resolveOnce();
              }
            };
            unsubPublic.admins = onSnapshot(
              doc(db, "admins", "list"),
              (snap) => {
                markRealtimeHealthy();
                adminList = snap.exists() ? snap.data().studentIds || [] : [];
                adminPositions = snap.exists()
                  ? snap.data().positions || {}
                  : {};

                // ê´€ë¦¬ìì¸ ê²½ìš° currentUser.position ì—…ë°ì´íŠ¸
                if (currentUser && adminList.includes(currentUser.studentId)) {
                  currentUser.position =
                    adminPositions[currentUser.studentId] || "ì¼ë°˜ íšŒì›";
                  console.log("=== Firebase ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©ì ì§ì±… ì—…ë°ì´íŠ¸ ===");
                  console.log("currentUser.studentId:", currentUser.studentId);
                  console.log("adminPositions:", adminPositions);
                  console.log("ì—…ë°ì´íŠ¸ëœ ì§ì±…:", currentUser.position);

                  // localStorageì—ë„ ì—…ë°ì´íŠ¸ëœ position ì €ì¥
                  localStorage.setItem(
                    "foodieUser",
                    JSON.stringify({
                      studentId: currentUser.studentId,
                      name: currentUser.name,
                      position: currentUser.position,
                    })
                  );
                }

                ensureAdminOptionals();
                scheduleRender();
                resolveOnceWrapper();
              },
              (err) => {
                handleRealtimeListenerError("admins", err);
                resolveOnceWrapper();
              }
            );
          };
          addToQueue(setupAdmins, "admins");
        }
        if (!unsubPublic.signup) {
          const setupSignup = (resolveOnce) => {
            let resolved = false;
            const resolveOnceWrapper = () => {
              if (!resolved) {
                resolved = true;
                resolveOnce();
              }
            };
            unsubPublic.signup = onSnapshot(
              doc(db, "settings", "signup"),
              (snap) => {
                markRealtimeHealthy();
                signupSettings = snap.exists()
                  ? snap.data()
                  : { open: false, start: "", end: "" };
                updateSignupUI();
                scheduleRender();
                resolveOnceWrapper();
              },
              (err) => {
                handleRealtimeListenerError("signup", err);
                resolveOnceWrapper();
              }
            );
          };
          addToQueue(setupSignup, "signup");
        }
        if (!unsubPublic.dues) {
          const setupDues = (resolveOnce) => {
            let resolved = false;
            const resolveOnceWrapper = () => {
              if (!resolved) {
                resolved = true;
                resolveOnce();
              }
            };
            unsubPublic.dues = onSnapshot(
              doc(db, "settings", "dues"),
              (snap) => {
                markRealtimeHealthy();
                duesSettings = snap.exists()
                  ? snap.data()
                  : {
                      enabled: false,
                      bank: "",
                      number: "",
                      holder: "",
                      amount: "",
                      note: "",
                    };
                updateSignupUI();
                scheduleRender();
                resolveOnceWrapper();
              },
              (err) => {
                handleRealtimeListenerError("dues", err);
                resolveOnceWrapper();
              }
            );
          };
          addToQueue(setupDues, "dues");
        }
        if (!unsubPublic.blocks) {
          const setupBlocks = (resolveOnce) => {
            let resolved = false;
            const resolveOnceWrapper = () => {
              if (!resolved) {
                resolved = true;
                resolveOnce();
              }
            };
            unsubPublic.blocks = onSnapshot(
              query(collection(db, "homepageBlocks"), orderBy("order", "asc")),
              (snap) => {
                markRealtimeHealthy();
                blocksData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
                if (__isInitialLoading) {
                  __loadingDataCount++;
                  checkLoadingComplete();
                }
                scheduleRender();
                resolveOnceWrapper();
              },
              (err) => {
                debugWarn("blocks:", err?.message);
                handleRealtimeListenerError("blocks", err);
                resolveOnceWrapper();
              }
            );
          };
          addToQueue(setupBlocks, "blocks");
        }
        if (!unsubPublic.customPositions) {
          unsubPublic.customPositions = onSnapshot(
            doc(db, "settings", "customPositions"),
            (snap) => {
              markRealtimeHealthy();
              customDefaultPositions = snap.exists()
                ? snap.data().positions || []
                : [];
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => {
              debugWarn("customPositions:", err?.message);
              handleRealtimeListenerError("customPositions", err);
            }
          );
        }
        if (!unsubPublic.deletedPositions) {
          unsubPublic.deletedPositions = onSnapshot(
            doc(db, "settings", "deletedPositions"),
            (snap) => {
              markRealtimeHealthy();
              deletedDefaultPositions = snap.exists()
                ? snap.data().positions || []
                : [];
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => {
              debugWarn("deletedPositions:", err?.message);
              handleRealtimeListenerError("deletedPositions", err);
            }
          );
        }
        if (!unsubPublic.presidentPositions) {
          unsubPublic.presidentPositions = onSnapshot(
            doc(db, "settings", "presidentPositions"),
            async (snap) => {
              markRealtimeHealthy();
              debugLog(
                "ğŸ“¥ presidentPositions Firebase ì—…ë°ì´íŠ¸:",
                snap.exists() ? snap.data() : "ë¬¸ì„œ ì—†ìŒ"
              );
              if (snap.exists()) {
                const existingPositions = snap.data().positions || [];
                // ê³ ì • ì§ì±… (íšŒì¥, ë¶€íšŒì¥, ì´ë¬´, ê¸°íšë¶€ì¥, í™ë³´ë¶€ì¥, ê°œë°œì)
                const fixedPositions = [
                  "íšŒì¥",
                  "ë¶€íšŒì¥",
                  "ì´ë¬´",
                  "ê¸°íšë¶€ì¥",
                  "í™ë³´ë¶€ì¥",
                  "ê°œë°œì",
                ];
                const hasAllFixed = fixedPositions.every((pos) =>
                  existingPositions.includes(pos)
                );

                if (!hasAllFixed) {
                  // ê³ ì • ì§ì±…ì„ ë¨¼ì € ì¶”ê°€í•˜ê³ , ë‚˜ë¨¸ì§€ ì§ì±…ì„ ë’¤ì— ì¶”ê°€
                  const updatedPositions = [
                    ...fixedPositions,
                    ...existingPositions.filter(
                      (pos) => !fixedPositions.includes(pos)
                    ),
                  ];
                  debugLog(
                    "âš ï¸ ê³ ì • ì§ì±… ëˆ„ë½ ë°œê²¬, ì¶”ê°€ ì¤‘:",
                    updatedPositions
                  );
                  await setDoc(doc(db, "settings", "presidentPositions"), {
                    positions: updatedPositions,
                  });
                  presidentPositions = updatedPositions;
                } else {
                  // ê³ ì • ì§ì±…ì´ ëª¨ë‘ ìˆìœ¼ë©´ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ê³ ì • ì§ì±… ë¨¼ì €)
                  const fixed = existingPositions.filter((pos) =>
                    fixedPositions.includes(pos)
                  );
                  const others = existingPositions.filter(
                    (pos) => !fixedPositions.includes(pos)
                  );
                  presidentPositions = [
                    ...fixedPositions.filter((pos) => fixed.includes(pos)),
                    ...others,
                  ];
                }
                debugLog("âœ… íšŒì¥ë‹¨ ì§ì±… ë¡œë“œë¨:", presidentPositions);
              } else {
                // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ìƒì„± (íšŒì¥, ë¶€íšŒì¥, ì´ë¬´, ê¸°íšë¶€ì¥, í™ë³´ë¶€ì¥, ê°œë°œì í¬í•¨)
                const defaultPositions = [
                  "íšŒì¥",
                  "ë¶€íšŒì¥",
                  "ì´ë¬´",
                  "ê¸°íšë¶€ì¥",
                  "í™ë³´ë¶€ì¥",
                  "ê°œë°œì",
                ];
                await setDoc(doc(db, "settings", "presidentPositions"), {
                  positions: defaultPositions,
                });
                presidentPositions = defaultPositions;
                debugLog(
                  "ğŸ†• íšŒì¥ë‹¨ ì§ì±… ë¬¸ì„œ ìƒì„± (ê¸°ë³¸ê°’):",
                  presidentPositions
                );
              }

              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => {
              debugError("âŒ presidentPositions ì˜¤ë¥˜:", err?.message);
              handleRealtimeListenerError("presidentPositions", err);
            }
          );
        }
        if (!unsubPublic.regularPositions) {
          unsubPublic.regularPositions = onSnapshot(
            doc(db, "settings", "regularPositions"),
            async (snap) => {
              markRealtimeHealthy();
              debugLog(
                "ğŸ“¥ regularPositions Firebase ì—…ë°ì´íŠ¸:",
                snap.exists() ? snap.data() : "ë¬¸ì„œ ì—†ìŒ"
              );
              if (snap.exists()) {
                const existingPositions = snap.data().positions || [];
                // "ê°œë°œì" ì§ì±…ì´ ìˆìœ¼ë©´ ì œê±° (íšŒì¥ë‹¨ìœ¼ë¡œ ì´ë™ë¨)
                let filteredPositions = existingPositions.filter(
                  (pos) => pos !== "ê°œë°œì"
                );

                // "ìš´ì˜ì§„" ì§ì±…ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (ê³ ì • ì§ì±… ë³´ì¥)
                const fixedPositions = ["ìš´ì˜ì§„"];
                const hasAllFixed = fixedPositions.every((pos) =>
                  filteredPositions.includes(pos)
                );

                if (!hasAllFixed) {
                  const updatedPositions = [
                    ...new Set([...fixedPositions, ...filteredPositions]),
                  ];
                  debugLog(
                    "âš ï¸ ê³ ì • ì§ì±… ëˆ„ë½ ë°œê²¬, ì¶”ê°€ ì¤‘:",
                    updatedPositions
                  );
                  await setDoc(doc(db, "settings", "regularPositions"), {
                    positions: updatedPositions,
                  });
                  regularPositions = updatedPositions;
                } else if (
                  filteredPositions.length !== existingPositions.length
                ) {
                  // "ê°œë°œì"ê°€ ì œê±°ë˜ì—ˆìœ¼ë©´ Firebase ì—…ë°ì´íŠ¸
                  debugLog(
                    "âš ï¸ ì¼ë°˜ ì„ì›ì—ì„œ ê°œë°œì ì§ì±… ì œê±° ì¤‘:",
                    filteredPositions
                  );
                  await setDoc(doc(db, "settings", "regularPositions"), {
                    positions: filteredPositions,
                  });
                  regularPositions = filteredPositions;
                } else {
                  regularPositions = filteredPositions;
                }
                debugLog("âœ… ì¼ë°˜ ì„ì› ì§ì±… ë¡œë“œë¨:", regularPositions);
              } else {
                // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ìƒì„± (ìš´ì˜ì§„ë§Œ)
                const defaultPositions = ["ìš´ì˜ì§„"];
                await setDoc(doc(db, "settings", "regularPositions"), {
                  positions: defaultPositions,
                });
                regularPositions = defaultPositions;
                debugLog(
                  "ğŸ†• ì¼ë°˜ ì„ì› ì§ì±… ë¬¸ì„œ ìƒì„± (ê¸°ë³¸ê°’):",
                  regularPositions
                );
              }

              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => {
              debugError("âŒ regularPositions ì˜¤ë¥˜:", err?.message);
              handleRealtimeListenerError("regularPositions", err);
            }
          );
        }
        if (!unsubPublic.restaurantCategories) {
          unsubPublic.restaurantCategories = onSnapshot(
            doc(db, "settings", "restaurantCategories"),
            async (snap) => {
              markRealtimeHealthy();
              if (snap.exists()) {
                const savedCategories = snap.data().categories || [];
                // ì•„ì‹œì•ˆ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
                const hasAsian = savedCategories.some(
                  (cat) => cat.name === "ì•„ì‹œì•ˆ"
                );
                if (!hasAsian) {
                  // ì•„ì‹œì•ˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ (ì–‘ì‹ ë‹¤ìŒì— ì¶”ê°€)
                  const asianIndex = savedCategories.findIndex(
                    (cat) => cat.name === "ì–‘ì‹"
                  );
                  if (asianIndex >= 0) {
                    savedCategories.splice(asianIndex + 1, 0, {
                      name: "ì•„ì‹œì•ˆ",
                      emoji: "ğŸœ",
                    });
                  } else {
                    savedCategories.push({ name: "ì•„ì‹œì•ˆ", emoji: "ğŸœ" });
                  }
                  // Firestore ì—…ë°ì´íŠ¸
                  await setDoc(doc(db, "settings", "restaurantCategories"), {
                    categories: savedCategories,
                  });
                  restaurantCategories = savedCategories;
                } else {
                  restaurantCategories = savedCategories;
                }
              } else {
                // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
                await setDoc(doc(db, "settings", "restaurantCategories"), {
                  categories: restaurantCategories,
                });
              }
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => {
              debugWarn("restaurantCategories:", err?.message);
              handleRealtimeListenerError("restaurantCategories", err);
            }
          );
        }
        if (!unsubPublic.roadmap) {
          const setupRoadmap = (resolveOnce) => {
            let resolved = false;
            const resolveOnceWrapper = () => {
              if (!resolved) {
                resolved = true;
                resolveOnce();
              }
            };
            // ë¡œë“œë§µ: order í•„ë“œë¥¼ ê´€ë¦¬í•˜ë¯€ë¡œ ì •ë ¬ì€ ë Œë”ë§ ì‹œì ì—ì„œ ì²˜ë¦¬
            debugLog(
              "ë¡œë“œë§µ ë°ì´í„° ë¡œë”© ì‹œì‘, USE_DEMO_OFFLINE:",
              USE_DEMO_OFFLINE
            );

            if (USE_DEMO_OFFLINE) {
              // ë¡œì»¬ íŒŒì¼ ëª¨ë“œì—ì„œëŠ” ë°ëª¨ ë°ì´í„° ì‚¬ìš©
              roadmapData = DEMO.roadmap;
              debugLog("DEMO ë¡œë“œë§µ ë°ì´í„° ì‚¬ìš©:", roadmapData);
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
              resolveOnceWrapper();
            } else {
              debugLog("Firebaseì—ì„œ ë¡œë“œë§µ ë°ì´í„° ë¡œë”© ì¤‘...");
              unsubPublic.roadmap = onSnapshot(
                collection(db, "roadmap"),
                (snap) => {
                  markRealtimeHealthy();
                  roadmapData = snap.docs.map((d) => ({
                    id: d.id,
                    ...d.data(),
                  }));
                  debugLog("Firebase ë¡œë“œë§µ ë°ì´í„° ì—…ë°ì´íŠ¸:", roadmapData);
                  debugLog("ë¬¸ì„œ ê°œìˆ˜:", snap.docs.length);
                  debugLog(
                    "ë³€ê²½ëœ ë¬¸ì„œë“¤:",
                    snap.docChanges().map((change) => ({
                      type: change.type,
                      docId: change.doc.id,
                      data: change.doc.data(),
                    }))
                  );
                  if (__isInitialLoading) {
                    __loadingDataCount++;
                    checkLoadingComplete();
                  }
                  scheduleRender();
                  resolveOnceWrapper();
                },
                (err) => {
                  debugWarn("roadmap ë¡œë”© ì˜¤ë¥˜:", err?.message);
                  roadmapData = DEMO.roadmap;
                  debugLog("ì˜¤ë¥˜ë¡œ ì¸í•´ DEMO ë°ì´í„° ì‚¬ìš©:", roadmapData);
                  if (__isInitialLoading) {
                    __loadingDataCount++;
                    checkLoadingComplete();
                  }
                  scheduleRender();
                  handleRealtimeListenerError("roadmap", err);
                  resolveOnceWrapper();
                }
              );
            }
          };
          addToQueue(setupRoadmap, "roadmap");
        }
        if (!unsubPublic.events) {
          const setupEvents = (resolveOnce) => {
            let resolved = false;
            const resolveOnceWrapper = () => {
              if (!resolved) {
                resolved = true;
                resolveOnce();
              }
            };
            unsubPublic.events = onSnapshot(
              query(collection(db, "events")),
              (snap) => {
                markRealtimeHealthy();
                eventsData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

                // order í•„ë“œê°€ ì—†ëŠ” ì´ë²¤íŠ¸ë“¤ì— ê¸°ë³¸ê°’ ì„¤ì •
                eventsData.forEach((event, index) => {
                  if (event.order === undefined || event.order === null) {
                    event.order = index;
                  }
                });

                // datetime ê¸°ì¤€ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (Firebaseì—ì„œ ì´ë¯¸ descë¡œ ê°€ì ¸ì˜¤ì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°ë¥¼ ëŒ€ë¹„)
                eventsData.sort((a, b) => {
                  const dateA = a.datetime?.toDate
                    ? a.datetime.toDate()
                    : new Date(a.datetime || 0);
                  const dateB = b.datetime?.toDate
                    ? b.datetime.toDate()
                    : new Date(b.datetime || 0);
                  return dateB - dateA; // ìµœì‹ ìˆœ (desc)
                });

                console.log("=== Firebaseì—ì„œ ì´ë²¤íŠ¸ ë¡œë“œ ===");
                console.log(
                  "ë¡œë“œëœ ì´ë²¤íŠ¸ ìˆœì„œ:",
                  eventsData.map((ev) => ({
                    id: ev.id,
                    order: ev.order,
                    title: ev.title,
                  }))
                );
                if (__isInitialLoading) {
                  __loadingDataCount++;
                  checkLoadingComplete();
                }
                scheduleRender();
                resolveOnceWrapper();
              },
              (err) => {
                debugWarn("events:", err?.message);
                handleRealtimeListenerError("events", err);
                resolveOnceWrapper();
              }
            );
          };
          addToQueue(setupEvents, "events");
        }
        if (!unsubPublic.foodMenus) {
          const setupFoodMenus = (resolveOnce) => {
            let resolved = false;
            const resolveOnceWrapper = () => {
              if (!resolved) {
                resolved = true;
                resolveOnce();
              }
            };
            unsubPublic.foodMenus = onSnapshot(
              collection(db, "foodMenus"),
              (snap) => {
                markRealtimeHealthy();
                foodMenusData = snap.docs.map((d) => ({
                  id: d.id,
                  ...d.data(),
                }));
                console.log("ë­ë¨¹ì§€ ë©”ë‰´ ë¡œë“œë¨:", foodMenusData.length, "ê°œ");
                if (__isInitialLoading) {
                  __loadingDataCount++;
                  checkLoadingComplete();
                }
                scheduleRender();
                resolveOnceWrapper();
              },
              (err) => {
                debugWarn("foodMenus:", err?.message);
                handleRealtimeListenerError("foodMenus", err);
                resolveOnceWrapper();
              }
            );
          };
          addToQueue(setupFoodMenus, "foodMenus");
        }
        // ì•Œë¦¼ êµ¬ë… (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì—ê²Œë§Œ)
        if (!unsubPublic.notifications && currentUser) {
          unsubPublic.notifications = onSnapshot(
            query(
              collection(db, "notifications"),
              orderBy("createdAt", "desc")
            ),
            (snap) => {
              markRealtimeHealthy();
              notificationsData = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              console.log("ì•Œë¦¼ ë¡œë“œë¨:", notificationsData.length, "ê°œ");
              renderNotifications();
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
            },
            (err) => {
              debugWarn("notifications:", err?.message);
              handleRealtimeListenerError("notifications", err);
            }
          );
        }
      }
      function startAdminListeners() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin) return;
        if (!unsubAdmin.suggestions) {
          unsubAdmin.suggestions = onSnapshot(
            query(collection(db, "suggestions"), orderBy("timestamp", "desc")),
            (snap) => {
              markRealtimeHealthy();
              suggestionsData = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => {
              debugWarn("suggestions:", err?.message);
              handleRealtimeListenerError("suggestions", err);
            }
          );
        }
        if (!unsubAdmin.inquiries) {
          unsubAdmin.inquiries = onSnapshot(
            query(collection(db, "inquiries"), orderBy("createdAt", "desc")),
            (snap) => {
              markRealtimeHealthy();
              inquiriesData = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              scheduleRender();
            },
            (err) => {
              debugWarn("inquiries:", err?.message);
              handleRealtimeListenerError("inquiries", err);
            }
          );
        }
        if (!unsubAdmin.history) {
          unsubAdmin.history = onSnapshot(
            query(collection(db, "history"), orderBy("createdAt", "desc")),
            (snap) => {
              markRealtimeHealthy();
              historyData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => {
              debugWarn("history:", err?.message);
              handleRealtimeListenerError("history", err);
            }
          );
        }
        if (!unsubAdmin.members) {
          unsubAdmin.members = onSnapshot(
            query(collection(db, "members"), orderBy("name", "asc")),
            (snap) => {
              markRealtimeHealthy();
              membersData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => {
              debugWarn("members:", err?.message);
              handleRealtimeListenerError("members", err);
            }
          );
        }
        if (!unsubAdmin.presence) {
          unsubAdmin.presence = onSnapshot(
            collection(db, "presence"),
            (snap) => {
              markRealtimeHealthy();
              presenceData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              computeOnline();
              renderPresenceUI();
            },
            (err) => {
              debugWarn("presence:", err?.message);
              handleRealtimeListenerError("presence", err);
            }
          );
        }
      }
      function ensureAdminOptionals() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (isAdmin) startAdminListeners();
        else {
          clearAdmin();
          renderPresenceUI();
        }

        if (isFullAdmin()) {
          setupAutoCloseScheduler();
        } else if (autoCloseSchedulerStarted) {
          clearAutoCloseScheduler();
        }

        // ì¡°ëª¨ì„ ë°ì´í„° ë¡œë“œ
        if (currentUser) {
          loadGroupsData();
        }
      }

      async function main() {
        try {
          await signInAnonymously(auth);
        } catch (e) {
          console.warn("auth fail:", e?.message || e);
        } finally {
          startPublicListeners();
          const saved = JSON.parse(
            localStorage.getItem("foodieUser") || "null"
          );
          if (saved) {
            currentUser = saved;
            myProfileData = null;
            myProfileLoading = false;
            verifyAutoLogin(saved).catch(() => {});
            startPresence();
          }
          setTimeout(() => el.loading.classList.add("hidden"), 2000);
          document
            .getElementById("login-button")
            .addEventListener("click", login);

          // ë¬¸ì˜í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
          document.addEventListener("click", (e) => {
            if (e.target.closest("#inquiry-button")) {
              e.preventDefault();
              openInquiryModal();
            }
          });

          // ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          const autoLoginCheckbox = document.getElementById(
            "auto-login-checkbox"
          );
          if (autoLoginCheckbox) {
            autoLoginCheckbox.addEventListener("change", function () {
              const checkbox = this;
              const checkboxContainer = checkbox.nextElementSibling;
              const svg = checkboxContainer.querySelector("svg");

              if (checkbox.checked) {
                checkboxContainer.classList.add(
                  "bg-orange-50",
                  "border-orange-400"
                );
                svg.style.opacity = "1";
              } else {
                checkboxContainer.classList.remove(
                  "bg-orange-50",
                  "border-orange-400"
                );
                svg.style.opacity = "0";
              }
            });
          }
          document
            .getElementById("signup-button")
            .addEventListener("click", openSignupModal);

          // ê°€ì… ë°©ë²• ì„ íƒ ëª¨ë‹¬ ë²„íŠ¼ í•¸ë“¤ëŸ¬
          const normalSignupBtn = document.getElementById(
            "normal-signup-button"
          );
          const kakaoSignupBtn = document.getElementById("kakao-signup-button");
          const signupMethodCancelBtn = document.getElementById(
            "signup-method-cancel-button"
          );

          if (normalSignupBtn) {
            normalSignupBtn.addEventListener("click", openNormalSignupForm);
          }
          if (kakaoSignupBtn) {
            kakaoSignupBtn.addEventListener("click", openKakaoSignupForm);
          }
          if (signupMethodCancelBtn) {
            signupMethodCancelBtn.addEventListener("click", () => {
              const methodModal = document.getElementById(
                "signup-method-modal"
              );
              if (methodModal) {
                methodModal.classList.add("hidden");
              }
            });
          }

          // ê°€ì… ë°©ë²• ì„ íƒ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
          const signupMethodModal = document.getElementById(
            "signup-method-modal"
          );
          if (signupMethodModal) {
            signupMethodModal.addEventListener("click", (e) => {
              if (e.target === signupMethodModal) {
                signupMethodModal.classList.add("hidden");
              }
            });
          }

          document
            .getElementById("modal-close-button")
            .addEventListener("click", closeModal);
          document
            .getElementById("signup-cancel-button")
            .addEventListener("click", () =>
              el.signupModal.classList.add("hidden")
            );
          // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·
          document
            .getElementById("signupPhone")
            .addEventListener("input", (e) => {
              let value = e.target.value.replace(/[^0-9]/g, ""); // ìˆ«ìë§Œ ì¶”ì¶œ
              if (value.length > 11) value = value.slice(0, 11); // ìµœëŒ€ 11ìë¦¬

              // 000-0000-0000 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
              if (value.length > 7) {
                e.target.value = `${value.slice(0, 3)}-${value.slice(
                  3,
                  7
                )}-${value.slice(7)}`;
              } else if (value.length > 3) {
                e.target.value = `${value.slice(0, 3)}-${value.slice(3)}`;
              } else {
                e.target.value = value;
              }
            });

          document
            .getElementById("signup-confirm-button")
            .addEventListener("click", () => confirmSignup(false));

          // íšŒì›ê°€ì… ëª¨ë‹¬ì˜ ì¹´ì¹´ì˜¤ ì—°ë™ ë²„íŠ¼
          const signupKakaoLinkBtn = document.getElementById(
            "signup-kakao-link-btn"
          );
          if (signupKakaoLinkBtn) {
            signupKakaoLinkBtn.addEventListener("click", async () => {
              try {
                const { linkKakaoAccount } = await import("./js/auth.js");
                const success = await linkKakaoAccount();
                if (success) {
                  // íšŒì›ê°€ì… ëª¨ë‹¬ì—ì„œ ì¹´ì¹´ì˜¤ ì—°ë™ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                  const { setSignupKakaoInfo } = await import("./js/signup.js");
                  const userInfo = await new Promise((resolve, reject) => {
                    if (typeof Kakao === "undefined" || !Kakao.API) {
                      reject(new Error("Kakao SDK not loaded"));
                      return;
                    }
                    Kakao.API.request({
                      url: "/v2/user/me",
                      success: (res) => resolve(res),
                      fail: (err) => reject(err),
                    });
                  });
                  setSignupKakaoInfo({
                    id: userInfo.id,
                    nickname: userInfo.kakao_account?.profile?.nickname || null,
                    profileImage:
                      userInfo.kakao_account?.profile?.profile_image_url ||
                      null,
                  });
                }
              } catch (error) {
                console.error("íšŒì›ê°€ì… ì¹´ì¹´ì˜¤ ì—°ë™ ì˜¤ë¥˜:", error);
              }
            });
          }

          // ë‚´ í™œë™ ì„¹ì…˜ì˜ ì¹´ì¹´ì˜¤ ì—°ë™ ë²„íŠ¼ í•¸ë“¤ëŸ¬
          window.handleKakaoLinkFromActivity = async function (e) {
            if (e) {
              e.preventDefault();
              e.stopPropagation();
            }
            try {
              const { linkKakaoAccount } = await import("./js/auth.js");
              await linkKakaoAccount();
            } catch (error) {
              console.error("ë‚´ í™œë™ ì¹´ì¹´ì˜¤ ì—°ë™ ì˜¤ë¥˜:", error);
            }
          };
          document
            .getElementById("dues-proceed-button")
            .addEventListener("click", () => {
              el.duesModal.classList.add("hidden");
              confirmSignup(true);
            });
          document
            .getElementById("dues-cancel-button")
            .addEventListener("click", () =>
              el.duesModal.classList.add("hidden")
            );
          document
            .getElementById("dues-copy-button")
            .addEventListener("click", () => {
              const d = duesSettings || {};
              const text = [d.bank, d.number].filter(Boolean).join(" ");
              navigator.clipboard
                ?.writeText(text)
                .then(() => showAlert("âœ…", "ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
            });
          document
            .getElementById("emergency-cancel-button")
            .addEventListener("click", closeEmergencyModal);
          document
            .getElementById("emergency-add-button")
            .addEventListener("click", addEmergencyAdmin);
          renderAll();
        }
      }
      main();

      /* ===== UI ì—…ë°ì´íŠ¸ ===== */
      function updateSignupUI() {
        const openNow = isSignupOpen();
        if (el.signupBanner)
          el.signupBanner.classList.toggle("hidden", !openNow);
        if (el.signupBtn) {
          el.signupBtn.disabled = !openNow;
          el.signupBtn.title = openNow
            ? "íšŒì›ê°€ì… ê°€ëŠ¥"
            : "í˜„ì¬ëŠ” íšŒì›ê°€ì… ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.";

          // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
          const iconElement = el.signupBtn.querySelector("i");
          if (openNow) {
            el.signupBtn.innerHTML =
              '<i class="fas fa-user-plus mr-2"></i>ë™ì•„ë¦¬ ê°€ì…í•˜ê¸°';
          } else {
            el.signupBtn.innerHTML =
              '<i class="fas fa-user-times mr-2"></i>íšŒì›ëª¨ì§‘ì´ ë§ˆê°ëìŠµë‹ˆë‹¤.';
          }
        }
        renderDuesInfoBox();
      }

      function renderAll() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (currentUser) {
          el.pre.classList.add("hidden");

          // ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì¸ì§€ í™•ì¸
          const isPendingMember = currentUser.status === "pending";

          // ë°ì´í„° ë¡œë“œ ìƒíƒœ í™•ì¸ (ì¼ì • ì‹œê°„ í›„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê²½ê³  í‘œì‹œ)
          const isOnline = navigator.onLine;
          const hasEventsData = eventsData && eventsData.length > 0;
          const hasRoadmapData = roadmapData && roadmapData.length > 0;
          const hasBlocksData = blocksData && blocksData.length > 0;

          // ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ëª¨ë‘ ë¹„ì–´ìˆëŠ” ê²½ìš°
          const noDataLoaded =
            !hasEventsData &&
            eventsData !== null &&
            eventsData !== undefined &&
            eventsData.length === 0 &&
            !hasRoadmapData &&
            roadmapData !== null &&
            roadmapData !== undefined &&
            roadmapData.length === 0 &&
            !hasBlocksData &&
            blocksData !== null &&
            blocksData !== undefined &&
            blocksData.length === 0;

          el.main.innerHTML = `
                  <div class="mb-4 md:mb-6">
                    <div class="flex items-center justify-between mb-4">
                      <p class="text-gray-700 text-lg md:text-xl font-medium">
                        <span class="text-orange-600 font-bold text-4xl md:text-5xl">Foodie</span>
                        <b id="userNameDisplay">${saf(
                          currentUser.name
                        )}</b>${getPositionSuffix()}ë‹˜
                      </p>
                    </div>

                    ${
                      !isOnline
                        ? `
                    <!-- ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜ -->
                    <div class="bg-red-50 border-2 border-red-300 rounded-xl p-4 md:p-5 mb-4 md:mb-6">
                      <div class="flex items-start gap-3">
                        <div class="flex-shrink-0">
                          <i class="fas fa-wifi text-red-600 text-2xl"></i>
                        </div>
                        <div class="flex-1">
                          <h3 class="text-base md:text-lg font-bold text-red-900 mb-2">
                            ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤
                          </h3>
                          <p class="text-sm md:text-base text-red-800 leading-relaxed mb-3">
                            ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì—°ê²°ì´ ë³µêµ¬ë˜ë©´ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.
                          </p>
                        </div>
                      </div>
                    </div>
                    `
                        : ""
                    }

                    ${""}

                    ${
                      isPendingMember
                        ? `
                    <!-- ëŒ€ê¸° íšŒì› ì•ˆë‚´ -->
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-xl p-4 md:p-5 mb-4 md:mb-6">
                      <div class="flex items-start gap-3">
                        <div class="flex-shrink-0">
                          <i class="fas fa-info-circle text-blue-600 text-2xl"></i>
                        </div>
                        <div class="flex-1">
                          <h3 class="text-base md:text-lg font-bold text-blue-900 mb-2">
                            íšŒì› ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤
                          </h3>
                          <p class="text-sm md:text-base text-blue-800 leading-relaxed">
                            í˜„ì¬ ë¯¸ì‹íšŒ ë¦¬ë·°ì™€ ìº˜ë¦°ë” ì¼ì •ë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                            ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ì€ íšŒì› ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
                          </p>
                        </div>
                      </div>
                    </div>
                    `
                        : ""
                    }

                    <!-- ë¡œê·¸ì¸ í›„ ë¸”ë¡ í‘œì‹œ ì˜ì—­ (ë¡œë“œë§µ ìœ„) -->
                    <div id="main-dynamic-blocks" class="space-y-4 md:space-y-6 mb-6"></div>

                    <div id="dashboard-roadmap" class="section mb-4">
                      <div class="mb-2 roadmap-accordion">
                        <div class="flex items-center justify-between mb-2">
                          <h3 class="text-lg md:text-xl font-bold">Foodie ì¼ì •</h3>
                        </div>
                        <div class="schedule-blocks-container" id="h-roadmap-list"></div>
                        <div class="roadmap-accordion-content" id="h-roadmap-full-list" style="max-height: 0; overflow: hidden; opacity: 0;">
                          <!-- ì „ì²´ ì¼ì •ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                        <div class="mt-4">
                          <button
                            id="h-roadmap-big-btn"
                            type="button"
                            class="w-full md:w-auto md:min-w-[200px] bg-orange-600 hover:bg-orange-700 text-white font-bold px-5 py-3 rounded-xl transition-colors flex items-center justify-center gap-2 mx-auto"
                          >
                            <i class="fas fa-calendar-alt"></i>
                            <span>ìº˜ë¦°ë”</span>
                            <i class="fas fa-chevron-down transition-transform duration-200" id="h-roadmap-big-chevron"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mb-6 md:mb-8 bg-gradient-to-r from-gray-100 to-gray-50 rounded-2xl p-2 flex flex-nowrap justify-center gap-2 shadow-inner" id="tab-buttons">
                    <button type="button" data-tab="roadmap" class="tab-btn flex-1 py-4 sm:py-5 px-4 sm:px-5 md:px-7 rounded-xl font-bold active transition-all duration-300 ease-out whitespace-nowrap">
                      <i class="fas fa-utensils mr-1.5 sm:mr-2 text-base sm:text-lg md:text-xl"></i>
                      <span class="text-base sm:text-lg md:text-xl">ë¯¸ì‹íšŒ í›„ê¸°</span>
                    </button>
                    <button type="button" data-tab="reservation" class="tab-btn flex-1 py-4 sm:py-5 px-4 sm:px-5 md:px-7 rounded-xl font-bold transition-all duration-300 ease-out whitespace-nowrap ${
                      isPendingMember ? "hidden" : ""
                    }">
                      <i class="fas fa-check mr-1.5 sm:mr-2 text-base sm:text-lg md:text-xl"></i>
                      <span class="text-base sm:text-lg md:text-xl">í™œë™ ì‹ ì²­</span>
                    </button>
                    <button type="button" data-tab="dashboard" class="tab-btn flex-1 py-4 sm:py-5 px-4 sm:px-5 md:px-7 rounded-xl font-bold transition-all duration-300 ease-out whitespace-nowrap ${
                      isFullAdmin() ? "" : "hidden"
                    }">
                      <i class="fas fa-crown mr-1.5 sm:mr-2 text-base sm:text-lg md:text-xl"></i>
                      <span class="text-base sm:text-lg md:text-xl">ê´€ë¦¬ì</span>
                    </button>
                  </div>
                  <div id="tab-content-container">
                    <div id="roadmap-tab" class="tab-content active"></div>
                    <div id="reservation-tab" class="tab-content"></div>
                    <div id="suggestions-tab" class="tab-content"></div>
                    <div id="dashboard-tab" class="tab-content"></div>
                  </div>`;
          el.main.classList.remove("hidden");

          // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ í˜ì´ì§€ ë§¨ ì•„ë˜ì— ì¶”ê°€
          const logoutContainer = document.getElementById("logout-container");
          if (logoutContainer && currentUser) {
            logoutContainer.innerHTML = `
                    <button id="logout-button" type="button" class="text-sm md:text-base text-gray-500 hover:text-red-500 bg-white px-4 py-2 rounded-full border shadow-sm transition-all duration-200 hover:shadow-md">
                      ë¡œê·¸ì•„ì›ƒ
                    </button>
                  `;
            document
              .getElementById("logout-button")
              .addEventListener("click", logout);
          }
          document
            .getElementById("tab-buttons")
            .addEventListener("click", (e) => {
              const btn = e.target.closest(".tab-btn");
              if (btn) showTab(btn.dataset.tab);
            });

          // ë¬¸ì˜ ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ìœ„ì—ì„œ ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ì²˜ë¦¬ë¨

          // ìƒë‹¨ ì¡°ëª¨ì„ ë²„íŠ¼ ì´ë²¤íŠ¸
          const rankBtnDup = document.getElementById("rank-button-duplicate");
          if (rankBtnDup) {
            rankBtnDup.addEventListener("click", () => {
              document.getElementById("rank-modal").classList.remove("hidden");
              renderRankList();
            });
          }
          const foodRecommendBtnDup = document.getElementById(
            "food-recommend-button-duplicate"
          );
          if (foodRecommendBtnDup) {
            foodRecommendBtnDup.addEventListener("click", () => {
              openFoodRecommendModal();
            });
          }

          // ë¬¸ì˜ ëª¨ë‹¬ ë‹«ê¸°
          document
            .getElementById("inquiry-close")
            .addEventListener("click", () => {
              document.getElementById("inquiry-modal").classList.add("hidden");
            });

          // ì¡°ëª¨ì„ ìˆœìœ„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          if (currentUser) {
            document
              .getElementById("rank-button")
              .addEventListener("click", () => {
                document
                  .getElementById("rank-modal")
                  .classList.remove("hidden");
                renderRankList();
              });
          }
          // í—¤ë”ì˜ ë­ë¨¹ì§€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          document
            .getElementById("header-food-btn")
            .addEventListener("click", () => {
              openFoodRecommendModal();
            });

          document
            .getElementById("rank-close")
            .addEventListener("click", () => {
              document.getElementById("rank-modal").classList.add("hidden");
            });

          // í—¤ë” ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
          const rankCloseHeader = document.getElementById("rank-close-header");
          if (rankCloseHeader) {
            rankCloseHeader.addEventListener("click", () => {
              document.getElementById("rank-modal").classList.add("hidden");
            });
          }

          // ì¡°ëª¨ì„ ìˆœìœ„ ê´€ë¦¬ì ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          document
            .getElementById("rank-add-team")
            ?.addEventListener("click", () => {
              // ì¡°ëª¨ì„ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
              openGroupAddModal();
            });

          document
            .getElementById("rank-save-changes")
            ?.addEventListener("click", () => {
              // ì¡°ëª¨ì„ ìˆœìœ„ ë³€ê²½ì‚¬í•­ ì €ì¥
              saveGroupRankings();
            });

          document
            .getElementById("food-recommend-close")
            .addEventListener("click", () => {
              document
                .getElementById("food-recommend-modal")
                .classList.add("hidden");
            });

          // ë©”ë‰´ ì •í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì‚­ì œë¨ (ì¹´í…Œê³ ë¦¬ ì„ íƒ ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
          document
            .getElementById("h-roadmap-big-btn")
            .addEventListener("click", () => {
              roadmapShowAll = !roadmapShowAll;

              // ì…°ë¸Œë¡  ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜
              const chevron = document.getElementById("h-roadmap-big-chevron");
              if (chevron) {
                chevron.style.transform = roadmapShowAll
                  ? "rotate(180deg)"
                  : "rotate(0deg)";
              }

              smoothRender("h-roadmap-list", renderHorizontalRoadmap);
            });

          // ë¡œë“œë§µ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          const roadmapAddBtn = document.getElementById("h-roadmap-add-btn");
          if (roadmapAddBtn) {
            roadmapAddBtn.addEventListener("click", () => {
              openRoadmapAddModal();
            });
          }

          renderReservationTab(isAdmin); // ì‹ ì²­í•˜ê¸° íƒ­
          renderHistoryTab(isAdmin);
          renderRoadmapTab(isAdmin);
          renderSuggestionsTab(isAdmin);
          if (isFullAdmin()) renderDashboardTab(); // ìš´ì˜ì§„ ì œì™¸, ì„ì›ì§„ë§Œ ì ‘ê·¼ ê°€ëŠ¥

          // ë¡œê·¸ì¸ ìƒíƒœì—ì„œ í—¤ë” ë²„íŠ¼ë“¤ í‘œì‹œ (ëŒ€ê¸° íšŒì› ì œì™¸)
          const foodBtn = document.getElementById("header-food-btn");
          const rankBtn = document.getElementById("rank-button");
          const notificationBtn = document.getElementById("notification-badge");
          if (foodBtn) foodBtn.style.display = "";
          if (rankBtn) rankBtn.style.display = "";
          if (notificationBtn) notificationBtn.style.display = "";

          // ëŒ€ê¸° íšŒì›ì¸ ê²½ìš° ì¼ë¶€ ê¸°ëŠ¥ ì œí•œ
          if (isPendingMember) {
            // í—¤ë”ì˜ ì¡°ëª¨ì„ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const rankBtnDup = document.getElementById("rank-button-duplicate");
            if (rankBtn) rankBtn.style.display = "none";
            if (rankBtnDup) rankBtnDup.style.display = "none";

            // í—¤ë”ì˜ ë­ë¨¹ì§€ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (foodBtn) foodBtn.style.display = "none";

            // íŒ€ êµ¬ì„±í•˜ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const teamMakerBtn = document.querySelector(
              '[data-act="group-maker"]'
            );
            if (teamMakerBtn) teamMakerBtn.style.display = "none";
          }

          // ì €ì¥ëœ íƒ­ìœ¼ë¡œ ë³µì›
          if (currentMainTab && currentMainTab !== "roadmap") {
            setTimeout(() => {
              showTab(currentMainTab);
            }, 50);
          }

          // DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ë¡œë“œë§µ ë Œë”ë§
          setTimeout(() => {
            updateLoadingProgress(4, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
            renderHorizontalRoadmap();
            renderBlocks(); // ë¡œê·¸ì¸ ìƒíƒœì—ì„œë„ ë¸”ë¡ ë Œë”ë§
          }, 100);
          computeOnline();
          renderPresenceUI();
        } else {
          el.pre.classList.remove("hidden");
          el.main.classList.add("hidden");

          // ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìˆ¨ê¹€
          const logoutContainer = document.getElementById("logout-container");
          if (logoutContainer) {
            logoutContainer.innerHTML = "";
          }

          // ë¡œê·¸ì•„ì›ƒ ì‹œ í—¤ë” ë²„íŠ¼ë“¤ ìˆ¨ê¹€
          const foodBtn = document.getElementById("header-food-btn");
          const rankBtn = document.getElementById("rank-button");
          const notificationBtn = document.getElementById("notification-badge");
          if (foodBtn) foodBtn.style.display = "none";
          if (rankBtn) rankBtn.style.display = "none";
          if (notificationBtn) notificationBtn.style.display = "none";

          updateLoadingProgress(4, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” renderRoadmap() í˜¸ì¶œí•˜ì§€ ì•ŠìŒ (ë¸”ë¡ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
          renderBlocks();
          updateSignupUI();
        }
        document.getElementById("rank-close").addEventListener("click", () => {
          document.getElementById("rank-modal").classList.add("hidden");
        });
        // í—¤ë” ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
        const rankCloseHeader = document.getElementById("rank-close-header");
        if (rankCloseHeader) {
          rankCloseHeader.addEventListener("click", () => {
            document.getElementById("rank-modal").classList.add("hidden");
          });
        }
        document
          .getElementById("food-recommend-close")
          .addEventListener("click", () => {
            document
              .getElementById("food-recommend-modal")
              .classList.add("hidden");
          });

        // ë©”ë‰´ ì •í•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‚­ì œë¨ (ì¹´í…Œê³ ë¦¬ ì„ íƒ ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
      }
      const showTab = (name) => {
        currentMainTab = name; // í˜„ì¬ íƒ­ ì €ì¥
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`${name}-tab`)?.classList.add("active");
        document
          .querySelector(`.tab-btn[data-tab='${name}']`)
          ?.classList.add("active");
      };

      /* ===== íšŒì›ê°€ì… + íšŒë¹„ ì•ˆë‚´ ===== */
      function renderDuesInfoBox() {
        const d = duesSettings || {};
        const enabled = !!d.enabled;
        el.duesBox.classList.toggle("hidden", !enabled);
        if (!enabled) {
          el.duesBoxContent.innerHTML = "";
          return;
        }
        const accountInfo =
          d.bank && d.number ? `${saf(d.bank)} ${saf(d.number)}` : "";
        const lines = [];
        if (accountInfo)
          lines.push(
            `<div class="select-all cursor-pointer hover:bg-orange-100 p-2 rounded transition-colors"
                       onclick="copyToClipboard('${accountInfo.replace(
                         /'/g,
                         "\\'"
                       )}')"
                       title="í´ë¦­í•˜ì—¬ ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬"><b>${accountInfo}</b>${
              d.holder ? ` (ì˜ˆê¸ˆì£¼ ${saf(d.holder)})` : ""
            }</div>`
          );
        if (d.amount) lines.push(`íšŒë¹„: <b>${formatKRW(d.amount)}</b>`);
        if (d.note)
          lines.push(
            `<span class="text-amber-700">${saf(d.note || "")}</span>`
          );

        const copyButton = accountInfo
          ? `<button
                        onclick="copyToClipboard('${accountInfo.replace(
                          /'/g,
                          "\\'"
                        )}')"
                  class="w-full mt-3 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2"
                  title="ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬">
                  <i class="fas fa-copy"></i>
                  ê³„ì¢Œ ë³µì‚¬í•˜ê¸°
                </button>`
          : "";

        el.duesBoxContent.innerHTML = lines.join("<br/>") + copyButton;
      }
      async function openSignupModal() {
        if (!isSignupOpen())
          return showAlert("â›”", "í˜„ì¬ëŠ” íšŒì›ê°€ì… ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
        // ì¹´ì¹´ì˜¤ ì—°ë™ ì •ë³´ ì´ˆê¸°í™”
        const { clearSignupKakaoInfo } = await import("./js/signup.js");
        clearSignupKakaoInfo();
        // ê°€ì… ë°©ë²• ì„ íƒ ëª¨ë‹¬ ë¨¼ì € í‘œì‹œ
        const methodModal = document.getElementById("signup-method-modal");
        if (methodModal) {
          methodModal.classList.remove("hidden");
        }
      }

      async function openNormalSignupForm() {
        // ì¼ë°˜ ê°€ì… í¼ í‘œì‹œ
        const methodModal = document.getElementById("signup-method-modal");
        if (methodModal) {
          methodModal.classList.add("hidden");
        }
        el.signupModal.classList.remove("hidden");
        document.getElementById("signupId").value = el.id.value.trim();
        document.getElementById("signupName").value = el.name.value.trim();
        renderDuesInfoBox();
        // ì¹´ì¹´ì˜¤ ì—°ë™ ì •ë³´ ì´ˆê¸°í™”
        const { clearSignupKakaoInfo } = await import("./js/signup.js");
        clearSignupKakaoInfo();
        const signupKakaoLinkBtn = document.getElementById(
          "signup-kakao-link-btn"
        );
        if (signupKakaoLinkBtn) {
          signupKakaoLinkBtn.style.display = "";
        }
      }

      async function openKakaoSignupForm() {
        // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë¨¼ì € ìˆ˜í–‰
        try {
          // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” í™•ì¸
          if (typeof Kakao === "undefined") {
            showAlert("ğŸ˜¥", "ì¹´ì¹´ì˜¤ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
          }

          // ì „ì—­ ì´ˆê¸°í™” í•¨ìˆ˜ ì‚¬ìš©
          if (Kakao.isInitialized()) {
            // ì´ë¯¸ ì´ˆê¸°í™”ë¨
          } else if (typeof window.initKakaoSDK === "function") {
            window.initKakaoSDK();
          } else {
            const KAKAO_JS_KEY = "28869968a8cfea9a996172c117d64eb2";
            if (KAKAO_JS_KEY) {
              try {
                Kakao.init(KAKAO_JS_KEY);
              } catch (error) {
                console.error("ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
              }
            }
          }

          if (!Kakao.isInitialized()) {
            showAlert("ğŸ˜¥", "ì¹´ì¹´ì˜¤ SDKê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
          }

          // ê¸°ì¡´ ì¹´ì¹´ì˜¤ ì„¸ì…˜ ì •ë¦¬
          if (
            window.Kakao &&
            window.Kakao.Auth &&
            window.Kakao.Auth.getAccessToken()
          ) {
            window.Kakao.Auth.logout();
            await new Promise((resolve) => setTimeout(resolve, 300));
          }

          // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ìš”ì²­
          const authObj = await new Promise((resolve, reject) => {
            Kakao.Auth.login({
              success: (auth) => resolve(auth),
              fail: (err) => reject(err),
            });
          });

          // ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const userInfo = await new Promise((resolve, reject) => {
            Kakao.API.request({
              url: "/v2/user/me",
              success: (res) => resolve(res),
              fail: (err) => reject(err),
            });
          });

          // ì¹´ì¹´ì˜¤ ì—°ë™ ì •ë³´ ì„¤ì •
          const { setSignupKakaoInfo } = await import("./js/signup.js");
          setSignupKakaoInfo({
            id: userInfo.id,
            nickname: userInfo.kakao_account?.profile?.nickname || null,
            profileImage:
              userInfo.kakao_account?.profile?.profile_image_url || null,
          });

          // ê°€ì… ë°©ë²• ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
          const methodModal = document.getElementById("signup-method-modal");
          if (methodModal) {
            methodModal.classList.add("hidden");
          }

          // ê°€ì… í¼ í‘œì‹œ
          el.signupModal.classList.remove("hidden");
          document.getElementById("signupId").value = el.id.value.trim();
          document.getElementById("signupName").value = el.name.value.trim();
          renderDuesInfoBox();

          // ì¹´ì¹´ì˜¤ ì—°ë™ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì´ë¯¸ ì—°ë™ë¨)
          const signupKakaoLinkBtn = document.getElementById(
            "signup-kakao-link-btn"
          );
          if (signupKakaoLinkBtn) {
            signupKakaoLinkBtn.style.display = "none";
          }
        } catch (error) {
          console.error("ì¹´ì¹´ì˜¤ ê°€ì… ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }
      const closeSignupModal = () => el.signupModal.classList.add("hidden");
      function openDuesModal() {
        const d = duesSettings || {};
        const body = [];
        if (d.amount)
          body.push(`<div>íšŒë¹„ ê¸ˆì•¡: <b>${formatKRW(d.amount)}</b></div>`);
        if (d.bank || d.number)
          body.push(
            `<div>ì…ê¸ˆ ê³„ì¢Œ: <b>${saf(d.bank || "")} ${saf(
              d.number || ""
            )}</b>${d.holder ? ` (ì˜ˆê¸ˆì£¼ ${saf(d.holder)})` : ""}</div>`
          );
        if (d.note)
          body.push(`<div class="text-gray-600">${saf(d.note)}</div>`);
        if (body.length === 0)
          body.push(
            `<div class="text-red-600">ê´€ë¦¬ìê°€ íšŒë¹„ ì •ë³´ë¥¼ ì•„ì§ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>`
          );
        el.duesModalBody.innerHTML = body.join("");
        el.duesModal.classList.remove("hidden");
      }
      async function confirmSignup(skipConfirm) {
        const sid = document.getElementById("signupId").value.trim();
        const nm = document.getElementById("signupName").value.trim();
        const gender = document.getElementById("signupGender").value.trim();
        const year = document.getElementById("signupYear").value.trim();
        const college = document.getElementById("signupCollege").value.trim();
        const dept = document.getElementById("signupDept").value.trim();
        const phone = document.getElementById("signupPhone").value.trim();
        if (!sid || !nm || !gender || !year || !college || !dept || !phone)
          return showAlert("ğŸ˜¥", "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if (!skipConfirm && duesSettings?.enabled) {
          openDuesModal();
          return;
        }
        if (!isSignupOpen())
          return showAlert("â›”", "í˜„ì¬ëŠ” íšŒì›ê°€ì… ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
        try {
          const mref = doc(db, "members", sid);
          const ms = await getDoc(mref);
          if (ms.exists()) {
            showAlert("â„¹ï¸", "ì´ë¯¸ ê°€ì…ëœ í•™ë²ˆì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
            closeSignupModal();
            el.id.value = sid;
            el.name.value = ms.data().name || nm;
            return;
          }
          await setDoc(mref, {
            studentId: sid,
            name: nm,
            gender,
            year,
            college,
            department: dept,
            phone,
            status: "pending",
            requestedAt: serverTimestamp(),
          });
          closeSignupModal();
          showAlert(
            "â³",
            "ê°€ì… ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤! <b>ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸°ì¤‘</b>ì…ë‹ˆë‹¤."
          );
          el.id.value = sid;
          el.name.value = nm;
        } catch (e) {
          console.warn(e);
          showAlert("ğŸ˜¥", "íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /* ===================== í™ˆ(ë¡œê·¸ì¸ ì „) ===================== */
      function attachAccordionHandlers(root) {
        root.querySelectorAll(".accordion-header").forEach((h) => {
          h.addEventListener("click", () => toggleAccordion(h));
        });
      }
      function toggleAccordion(header) {
        const item = header.closest(".accordion-item");
        item.classList.toggle("active");
      }

      // ê´€ë¦¬ììš© ë¸”ë¡ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìƒì„±
      function getBlockAdminButtons(block) {
        // ìš´ì˜ì§„ì€ ë¸”ë¡ ê´€ë¦¬ ë¶ˆê°€
        if (!isFullAdmin()) return "";

        // ê³µì§€ ë¸”ë¡ê³¼ Q&A ë¸”ë¡ì€ í•­ìƒ ë²„íŠ¼ í‘œì‹œ (ëª¨ë°”ì¼ ëŒ€ì‘)
        const opacityClass =
          block.type === "notice" || block.type === "qa"
            ? "opacity-100"
            : "opacity-0 group-hover:opacity-100";

        return `
                <div class="block-admin-controls absolute top-2 right-2 flex gap-1 ${opacityClass} transition-opacity z-10">
                  <button class="move-block-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors"
                          data-block-id="${block.id}" title="ìœ„ë¡œ ì´ë™">
                    <i class="fas fa-arrow-up"></i>
                  </button>
                  <button class="move-block-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors"
                          data-block-id="${block.id}" title="ì•„ë˜ë¡œ ì´ë™">
                    <i class="fas fa-arrow-down"></i>
                  </button>
                  <button class="edit-block-inline bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors"
                          data-id="${block.id}" data-type="${block.type}" title="ìˆ˜ì •">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="delete-block-inline bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors"
                          data-id="${block.id}" data-type="${block.type}" title="ì‚­ì œ">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `;
      }

      function renderBlocks() {
        const isLoggedIn = !!currentUser;
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì ì ˆí•œ ì»¨í…Œì´ë„ˆ ì„ íƒ
        const wrap = isLoggedIn
          ? document.getElementById("main-dynamic-blocks")
          : document.getElementById("dynamic-blocks");

        if (!wrap) return;

        // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ë¸”ë¡ í•„í„°ë§
        const visible = (blocksData || []).filter((b) => {
          if (b.visible === false) return false;

          // showWhen ì„¤ì •ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì¡°ê±´ í™•ì¸
          if (b.showWhen) {
            if (b.showWhen === "login" && !isLoggedIn) return false;
            if (b.showWhen === "logout" && isLoggedIn) return false;
          }

          return true;
        });

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì¼ì • ë¸”ë¡ ì¶”ê°€
        if (!isLoggedIn && roadmapData && roadmapData.length > 0) {
          const scheduleBlock = {
            id: "auto-schedule-block",
            type: "schedule",
            title: "Foodie ì¼ì •",
            visible: true,
            showWhen: "logout",
            order: 1,
            isAuto: true,
          };
          visible.unshift(scheduleBlock);
        }
        const snippets = visible.map((b) => {
          if (b.type === "announcement") {
            // ê³µì§€ì‚¬í•­ ë¸”ë¡ í‘œì‹œ
            return `
                    <div class="border rounded-lg p-3 md:p-4 bg-gradient-to-r from-blue-50 to-indigo-50 shadow-sm hover:shadow-md transition-shadow relative">
                      <div class="flex flex-col sm:flex-row items-start gap-3">
                        <div class="flex-shrink-0">
                          <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-bullhorn text-white"></i>
                          </div>
                        </div>
                        <div class="flex-1 min-w-0 w-full">
                          <div class="flex flex-wrap items-center gap-2 mb-2">
                            <h3 class="font-bold text-base md:text-lg text-blue-800 break-words">${saf(
                              b.title
                            )}</h3>
                            ${b.isAuto ? "" : ""}
                          </div>
                          <div class="text-sm md:text-base text-gray-700 whitespace-pre-wrap break-words">${saf(
                            b.content
                          )}</div>
                          <div class="text-xs text-gray-500 mt-2">
                            ${new Date(b.createdAt).toLocaleString("ko-KR")}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
          } else if (b.type === "schedule") {
            // ì¼ì • ë¸”ë¡ í‘œì‹œ (ë¡œê·¸ì•„ì›ƒ ì „ìš©)
            if (!isLoggedIn && roadmapData && roadmapData.length > 0) {
              // ìš´ì˜ì§„ ì „ìš© ì¼ì • í•„í„°ë§ í›„ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
              const filteredData = roadmapData.filter((item) => {
                if (!item || typeof item !== "object" || !item.id) return false;
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ìš´ì˜ì§„ ì „ìš© ì¼ì • ìˆ¨ê¹€
                if (item.isAdminOnly) return false;
                return true;
              });

              const sorted = [...filteredData].sort((a, b) => {
                const dateA = parseDate(a.activityDate);
                const dateB = parseDate(b.activityDate);
                return dateA - dateB;
              });

              // ë‹¬ë ¥ í˜•íƒœë¡œ ë Œë”ë§ (ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì—†ìŒ)
              const calendarHTML = generateCalendar(
                new Date().getFullYear(),
                new Date().getMonth(),
                sorted,
                false, // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                false, // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ
                false // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ê³¼ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œí•˜ì§€ ì•ŠìŒ
              );

              return `
                      <div class="border rounded-lg p-3 md:p-4 bg-white shadow-sm hover:shadow-md transition-shadow relative">
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                          <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-calendar-alt text-white text-sm"></i>
                          </div>
                          <h3 class="font-bold text-base md:text-lg text-gray-800 break-words flex-1 min-w-0">${saf(
                            b.title
                          )}</h3>
                          ${b.isAuto ? "" : ""}
                        </div>
                        <div class="schedule-content">
                          ${calendarHTML}
                        </div>
                      </div>
                    `;
            }
            return ""; // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
          } else if (b.type === "scores") {
            // ì ìˆ˜íŒ ë¸”ë¡ í‘œì‹œ
            const teams = b.payload?.teams || [];
            const sortedTeams = teams.sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );

            const teamsHTML = sortedTeams
              .map(
                (team, index) => `
                    <div class="flex items-center justify-between p-2 md:p-3 bg-gradient-to-r from-orange-50 to-orange-100 border border-orange-200 rounded-lg">
                      <div class="flex items-center gap-2 md:gap-3 flex-1 min-w-0">
                        <div class="flex items-center justify-center w-7 h-7 md:w-8 md:h-8 rounded-full text-white font-bold text-xs md:text-sm flex-shrink-0 ${
                          index === 0
                            ? "bg-yellow-500"
                            : index === 1
                            ? "bg-gray-400"
                            : index === 2
                            ? "bg-amber-600"
                            : "bg-orange-500"
                        }">
                          ${index + 1}
                        </div>
                        <div class="flex-1 min-w-0">
                          <span class="font-bold text-base md:text-lg text-gray-800 break-words block">${saf(
                            team.name
                          )}</span>
                          <div class="text-xs md:text-sm text-gray-600">${
                            team.score || 0
                          }ì </div>
                        </div>
                      </div>
                    </div>
                  `
              )
              .join("");

            // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ - ìš´ì˜ì§„ ì œì™¸
            const isAdminForBlocks = isFullAdmin();

            return `
                    <div class="border rounded-lg p-3 md:p-4 bg-white shadow-sm hover:shadow-md transition-shadow relative">
                      ${
                        isAdminForBlocks
                          ? `
                        <div class="absolute top-2 right-2 flex gap-1 flex-wrap">
                          <button class="move-block-up score-block-move-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors"
                                  data-block-id="${b.id}" title="ìœ„ë¡œ ì´ë™">
                            <i class="fas fa-arrow-up"></i>
                          </button>
                          <button class="move-block-down score-block-move-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors"
                                  data-block-id="${b.id}" title="ì•„ë˜ë¡œ ì´ë™">
                            <i class="fas fa-arrow-down"></i>
                          </button>
                          <button class="edit-score-block-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors"
                                  data-block-id="${b.id}" title="ìˆ˜ì •">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button class="delete-score-block-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors"
                                  data-block-id="${b.id}" title="ì‚­ì œ">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      `
                          : ""
                      }
                      <div class="flex justify-between items-start mb-3 pr-0 md:pr-0">
                        <h3 class="font-bold text-base md:text-lg text-gray-800 break-words pr-20">${saf(
                          b.title
                        )}</h3>
                      </div>
                      <div class="space-y-2">
                        ${
                          teamsHTML ||
                          '<p class="text-gray-400 text-center py-4 text-sm">íŒ€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                        }
                      </div>
                    </div>
                  `;
          } else if (b.type === "qa") {
            const items = b.payload?.items || [];
            const html = items.length
              ? items
                  .map(
                    (it) =>
                      `<div class="border rounded p-3 md:p-4 bg-white hover:bg-gray-50 transition-colors">
                              <div class="font-semibold text-sm md:text-base text-gray-800 mb-2 whitespace-pre-wrap break-words">Q. ${saf(
                                it.q || "-"
                              )}</div>
                              <div class="text-sm md:text-base text-gray-600 mt-2 pl-3 md:pl-4 whitespace-pre-wrap leading-relaxed break-words">A. ${saf(
                                it.a || "-"
                              )}</div>
                            </div>`
                  )
                  .join("")
              : `<div class="text-gray-400 text-sm">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return `<div class="accordion-item section relative" data-block="${
              b.id
            }">
                            ${getBlockAdminButtons(b)}
                            <div class="accordion-header cursor-pointer flex items-center justify-between py-3 px-2 md:px-3 hover:bg-gray-50 transition-colors">
                              <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 flex items-center break-words flex-1 min-w-0 pr-2">
                                <i class="fas fa-question-circle mr-2 text-orange-500 flex-shrink-0"></i>
                                <span class="break-words">${saf(
                                  b.title || "Q&A"
                                )}</span>
                              </h3>
                              <i class="fas fa-chevron-down accordion-icon transition-transform duration-300 text-gray-400 flex-shrink-0"></i>
                            </div>
                            <div class="accordion-content">
                              <div class="space-y-2 px-2 md:px-3 pb-3">${html}</div>
                            </div>
                          </div>`;
          } else if (b.type === "notice") {
            const content = b.payload?.html || b.payload?.text || "";
            return `<div class="section accordion-item relative" data-block="${
              b.id
            }">
                            ${getBlockAdminButtons(b)}
                            <div class="accordion-header cursor-pointer flex items-center justify-between py-3 px-2 md:px-3 hover:bg-gray-50 transition-colors">
                              <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 flex items-center break-words flex-1 min-w-0 pr-2">
                                <i class="fas fa-bullhorn mr-2 text-orange-500 flex-shrink-0"></i><span class="break-words">${saf(
                                  b.title || "ê³µì§€"
                                )}</span>
                              </h3>
                              <i class="fas fa-chevron-down accordion-icon transition-transform duration-300 text-gray-400 flex-shrink-0"></i>
                            </div>
                            <div class="accordion-content">
                              <div class="prose prose-sm max-w-none text-sm md:text-base text-gray-700 whitespace-pre-wrap break-words px-2 md:px-3 pb-3">${
                                content || "ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."
                              }</div>
                            </div>
                          </div>`;
          } else if (b.type === "roadmap") {
            // ë¡œë“œë§µ ë¸”ë¡ì˜ ì¼ì • ë°ì´í„° ì²˜ë¦¬
            const roadmapItems = b.payload?.items || [];
            const description = b.payload?.description || "";

            // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • ì§€ì› (í•˜ìœ„ í˜¸í™˜ì„±)
            if (!roadmapItems.length && b.payload?.date) {
              roadmapItems.push({
                title: b.title || "ì¼ì •",
                date: b.payload.date,
                description: b.payload.description || "",
              });
            }

            // ë¡œë“œë§µ ë¸”ë¡ ë‚´ì—ì„œ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
            const isAdminForRoadmap = currentUser; // ì„ì‹œë¡œ ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œ ë²„íŠ¼ í‘œì‹œ

            // ë””ë²„ê¹…ì„ ìœ„í•œ ì½˜ì†” ë¡œê·¸
            console.log("ë¡œë“œë§µ ë¸”ë¡ ê¶Œí•œ í™•ì¸:", {
              currentUser: currentUser?.name,
              position: currentUser?.position,
              studentId: currentUser?.studentId,
              isAdminList: adminList.includes(currentUser?.studentId),
              isAdminForRoadmap,
              roadmapItemsCount: roadmapItems.length,
              adminList: adminList,
            });

            return `<div class="accordion-item section relative" data-block="${
              b.id
            }">
                            ${getBlockAdminButtons(b)}
                            <div class="accordion-header cursor-pointer p-3 md:p-4 lg:p-6">
                          <div class="flex flex-col gap-2 w-full">
                                <div class="flex items-center justify-between w-full">
                                  <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 break-words flex-1 min-w-0 pr-2"><i class="fas fa-map-signs mr-2 text-orange-500 flex-shrink-0"></i><span class="break-words">${saf(
                                    b.title || "ë¡œë“œë§µ"
                                  )}</span></h3>
                                  <i class="fas fa-chevron-down text-gray-500 flex-shrink-0"></i>
                                </div>
                                ${
                                  isAdminForRoadmap
                                    ? `
                                  <div class="flex gap-1 justify-start flex-wrap">
                                    <button class="add-roadmap-item bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition-colors"
                                            data-block-id="${b.id}" title="ìƒˆ ì¼ì • ì¶”ê°€">
                                      <i class="fas fa-plus mr-1"></i>ì¼ì • ì¶”ê°€
                                    </button>
                                  </div>
                                `
                                    : ""
                                }
                              </div>
                            </div>
                            <div class="accordion-content">
                              <div class="space-y-3">
                                ${
                                  roadmapItems.length > 0
                                    ? roadmapItems
                                        .map((item, index) => {
                                          const formattedDate = item.date
                                            ? new Date(
                                                item.date
                                              ).toLocaleDateString("ko-KR", {
                                                year: "numeric",
                                                month: "long",
                                                day: "numeric",
                                              })
                                            : "ë‚ ì§œ ë¯¸ì •";

                                          return `
                                          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4">
                                            <div class="flex items-center justify-between mb-2 gap-2">
                                              <div class="flex items-center">
                                                <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                                                <span class="font-semibold text-blue-800">${saf(
                                                  item.title || "ì¼ì •"
                                                )}</span>
                                              </div>
                                              ${
                                                isAdminForRoadmap
                                                  ? `
                                                <div class="flex gap-1">
                                                  <button class="edit-roadmap-item bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors"
                                                          data-block-id="${b.id}" data-item-index="${index}" title="ì¼ì • ìˆ˜ì •">
                                                    <i class="fas fa-edit"></i>
                                                  </button>
                                                  <button class="delete-roadmap-item bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors"
                                                          data-block-id="${b.id}" data-item-index="${index}" title="ì¼ì • ì‚­ì œ">
                                                    <i class="fas fa-trash"></i>
                                                  </button>
                                                </div>
                                              `
                                                  : ""
                                              }
                                            </div>
                                            <p class="text-blue-700">${formattedDate}</p>
                                            ${
                                              item.description
                                                ? `<p class="text-blue-600 text-sm mt-2">${saf(
                                                    item.description
                                                  )}</p>`
                                                : ""
                                            }
                                          </div>
                                        `;
                                        })
                                        .join("")
                                    : `
                                      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-500">
                                        <i class="fas fa-calendar-plus text-2xl mb-2"></i>
                                        <p>ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                        ${
                                          isAdminForRoadmap
                                            ? `<p class="text-sm mt-1">ì¼ì • ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>`
                                            : ""
                                        }
                                      </div>
                                    `
                                }
                                ${
                                  description
                                    ? `
                                  <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                      <div class="flex items-center">
                                        <i class="fas fa-info-circle text-gray-500 mr-2"></i>
                                        <span class="font-semibold text-gray-800">ì„¤ëª…</span>
                                      </div>
                                      ${
                                        isAdminForRoadmap
                                          ? `
                                        <div class="flex gap-1">
                                          <button class="edit-roadmap-description bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors"
                                                  data-block-id="${b.id}" title="ì„¤ëª… ìˆ˜ì •">
                                            <i class="fas fa-edit"></i>
                                          </button>
                                        </div>
                                      `
                                          : ""
                                      }
                                    </div>
                                    <p class="text-gray-700 whitespace-pre-wrap">${saf(
                                      description
                                    )}</p>
                                  </div>
                                `
                                    : ""
                                }
                                ${
                                  isAdminForRoadmap
                                    ? `
                                  <div class="text-center pt-2">
                                    <button class="add-roadmap-item bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"
                                            data-block-id="${b.id}" title="ìƒˆ ì¼ì • ì¶”ê°€">
                                      <i class="fas fa-plus mr-1"></i>ìƒˆ ì¼ì • ì¶”ê°€
                                    </button>
                                  </div>
                                `
                                    : ""
                                }
                              </div>
                            </div>
                          </div>`;
          } else {
            const content = saf(b.payload?.html || b.payload?.text || "");
            return `<div class="section accordion-item" data-block="${b.id}">
                            <div class="accordion-header cursor-pointer flex items-center justify-between py-3 px-1 hover:bg-gray-50 transition-colors">
                              <h3 class="text-lg md:text-xl font-bold text-gray-700 flex items-center">
                                <i class="fas fa-info-circle mr-2 text-orange-500"></i>${saf(
                                  b.title || "ë¸”ë¡"
                                )}
                              </h3>
                              <i class="fas fa-chevron-down accordion-icon transition-transform duration-300 text-gray-400"></i>
                            </div>
                            <div class="accordion-content">
                              <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap px-1 pb-3">${
                                content || "ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."
                              }</div>
                            </div>
                          </div>`;
          }
        });

        // ê´€ë¦¬ììš© ìƒˆ ë¸”ë¡ ìƒì„± ë²„íŠ¼ ì¶”ê°€
        let finalSnippets = snippets;
        // ìš´ì˜ì§„ì€ ë¸”ë¡ ì¶”ê°€ ë¶ˆê°€, ì„ì›ì§„ë§Œ ê°€ëŠ¥
        if (isFullAdmin()) {
          // ìƒˆ ê³µì§€ ì¶”ê°€ ë°•ìŠ¤ë¥¼ ë§¨ ì•ì— ë°°ì¹˜
          const addBlockPlaceholder = `
                  <div class="add-block-placeholder border-2 border-dashed border-orange-300 rounded-lg p-4 text-center hover:border-orange-400 hover:bg-orange-50 transition-colors cursor-pointer group bg-orange-50"
                       data-position="1" data-act="add-new-block">
                    <div class="flex flex-col items-center justify-center space-y-2">
                      <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                        <i class="fas fa-plus-circle text-xl text-orange-500"></i>
                      </div>
                      <span class="text-sm font-medium text-orange-600 group-hover:text-orange-700">ìƒˆ ê³µì§€ ì¶”ê°€</span>
                    </div>
                  </div>
                `;

          if (snippets.length > 0) {
            // ê¸°ì¡´ ë¸”ë¡ì´ ìˆìœ¼ë©´ ìƒˆ ê³µì§€ ì¶”ê°€ ë°•ìŠ¤ë¥¼ ë§¨ ì•ì— ë°°ì¹˜
            finalSnippets = [addBlockPlaceholder, ...snippets];
          } else {
            // ë¸”ë¡ì´ ì—†ì„ ë•Œ ì²« ë²ˆì§¸ ë¸”ë¡ ìƒì„± ë²„íŠ¼
            finalSnippets = [
              `
                    <div class="add-block-placeholder border-2 border-dashed border-orange-300 rounded-lg p-8 text-center hover:border-orange-400 hover:bg-orange-50 transition-colors cursor-pointer group bg-orange-50"
                         data-position="1" data-act="add-new-block">
                      <div class="flex flex-col items-center justify-center space-y-4">
                        <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                          <i class="fas fa-plus-circle text-4xl text-orange-500"></i>
                        </div>
                        <span class="text-lg font-medium text-orange-600 group-hover:text-orange-700">ì²« ë²ˆì§¸ ê³µì§€ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</span>
                      </div>
                    </div>
                    `,
            ];
          }
        }

        wrap.innerHTML = finalSnippets.length
          ? finalSnippets.join("")
          : `<div class="section text-center text-gray-400">í‘œì‹œí•  ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        attachAccordionHandlers(wrap);

        // ìƒˆ ë¸”ë¡ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (isAdmin) {
          // íšŒìƒ‰ ì ì„  ë¸”ë¡ ì „ì²´ í´ë¦­ ì´ë²¤íŠ¸
          wrap
            .querySelectorAll(".add-block-placeholder")
            .forEach((placeholder) => {
              placeholder.addEventListener("click", (e) => {
                e.stopPropagation();
                const position = parseInt(placeholder.dataset.position) || 1;
                // ë¸”ë¡ íƒ€ì… ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
                openBlockModal(null, null, position);
              });
            });

          wrap.querySelectorAll(".add-block-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const position = parseInt(btn.dataset.position);
              // ë¸”ë¡ íƒ€ì… ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
              openBlockModal(null, null, position);
            });
          });

          // ì¸ë¼ì¸ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          wrap.querySelectorAll(".edit-block-inline").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.id;
              const blockType = btn.dataset.type;
              openBlockModal(blockType, blockId);
            });
          });

          wrap.querySelectorAll(".delete-block-inline").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.id;
              const blockType = btn.dataset.type;

              if (
                confirm(
                  `${getBlockTypeName(blockType)} ë¸”ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                )
              ) {
                try {
                  await deleteDoc(doc(db, "homepageBlocks", blockId));
                  showAlert("âœ…", "ë¸”ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                  console.error("ë¸”ë¡ ì‚­ì œ ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ë¸”ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });
          });

          // ì ìˆ˜íŒ ë¸”ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          wrap.querySelectorAll(".edit-score-block-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openBlockModal("scores", blockId);
            });
          });

          // ì ìˆ˜íŒ ë¸”ë¡ ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          wrap.querySelectorAll(".score-block-move-up").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              console.log("ì ìˆ˜íŒ ë¸”ë¡ ìœ„ë¡œ ì´ë™ ë²„íŠ¼ í´ë¦­:", blockId);
              await moveBlockUp(blockId);
            });
          });

          wrap.querySelectorAll(".score-block-move-down").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              console.log("ì ìˆ˜íŒ ë¸”ë¡ ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼ í´ë¦­:", blockId);
              await moveBlockDown(blockId);
            });
          });

          wrap.querySelectorAll(".delete-score-block-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              if (!confirm("ì ìˆ˜íŒ ë¸”ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

              try {
                await deleteDoc(doc(db, "homepageBlocks", blockId));
                showAlert("âœ…", "ì ìˆ˜íŒ ë¸”ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              } catch (error) {
                console.error("ì ìˆ˜íŒ ë¸”ë¡ ì‚­ì œ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "ì ìˆ˜íŒ ë¸”ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            });
          });

          // ì¼ë°˜ ë¸”ë¡(ê³µì§€, Q&A ë“±) ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          wrap
            .querySelectorAll(".move-block-up:not(.score-block-move-up)")
            .forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                e.stopPropagation();
                const blockId = btn.dataset.blockId;
                console.log("ì¼ë°˜ ë¸”ë¡ ìœ„ë¡œ ì´ë™ ë²„íŠ¼ í´ë¦­:", blockId);
                await moveBlockUp(blockId);
              });
            });

          wrap
            .querySelectorAll(".move-block-down:not(.score-block-move-down)")
            .forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                e.stopPropagation();
                const blockId = btn.dataset.blockId;
                console.log("ì¼ë°˜ ë¸”ë¡ ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼ í´ë¦­:", blockId);
                await moveBlockDown(blockId);
              });
            });

          // ë¡œë“œë§µ ë¸”ë¡ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í—¤ë”ì™€ ì½˜í…ì¸  ëª¨ë‘)
          wrap.querySelectorAll(".edit-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              const itemIndex = parseInt(btn.dataset.itemIndex);
              openRoadmapItemEditModal(blockId, itemIndex);
            });
          });

          wrap.querySelectorAll(".delete-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              const itemIndex = parseInt(btn.dataset.itemIndex);

              if (confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteRoadmapItem(blockId, itemIndex);
                showAlert("âœ…", "ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderBlocks(); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              }
            });
          });

          wrap.querySelectorAll(".edit-roadmap-description").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openRoadmapDescriptionEditModal(blockId);
            });
          });

          wrap.querySelectorAll(".add-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openRoadmapItemAddModal(blockId);
            });
          });
        }
      }

      // ë¡œë“œë§µ ì¼ì • ìˆ˜ì • ëª¨ë‹¬
      function openRoadmapItemEditModal(blockId, itemIndex) {
        const block = blocksData.find((b) => b.id === blockId);
        if (!block) return;

        // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ì—ì„œ í•´ë‹¹ ì¼ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const items = block.payload?.items || [];
        let itemData = null;

        if (items.length > 0 && itemIndex >= 0 && itemIndex < items.length) {
          // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°
          itemData = items[itemIndex];
        } else if (block.payload?.date) {
          // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • êµ¬ì¡°
          itemData = {
            title: block.title || "",
            date: block.payload.date,
            description: block.payload.description || "",
          };
        }

        if (!itemData) {
          showAlert("ğŸ˜¥", "ì¼ì • ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const modalHTML = `
                <div id="roadmap-item-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ë¡œë“œë§µ ì¼ì • ìˆ˜ì •</h3>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                        <input id="roadmap-item-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${saf(
                          itemData.title || ""
                        )}" placeholder="ì¼ì • ì œëª©">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <input id="roadmap-item-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${
                          itemData.date || ""
                        }">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                        <textarea id="roadmap-item-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="ì„¤ëª…">${saf(
                          itemData.description || ""
                        )}</textarea>
                      </div>
                      <input id="roadmap-item-block-id" type="hidden" value="${blockId}">
                      <input id="roadmap-item-index" type="hidden" value="${itemIndex}">
                    </div>
                    <div class="flex gap-3 mt-6">
                      <button id="roadmap-item-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                      </button>
                      <button id="roadmap-item-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                </div>
              `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById(
          "roadmap-item-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-item-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-item-block-id"
            ).value;
            const itemIndex = parseInt(
              document.getElementById("roadmap-item-index").value
            );
            const title = document
              .getElementById("roadmap-item-title")
              .value.trim();
            const date = document.getElementById("roadmap-item-date").value;
            const description = document
              .getElementById("roadmap-item-description")
              .value.trim();

            if (!title) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            await updateRoadmapItem(
              blockId,
              itemIndex,
              title,
              date,
              description
            );
            showAlert("âœ…", "ë¡œë“œë§µ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("roadmap-item-edit-modal").remove();
            smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          });

        document
          .getElementById("roadmap-item-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-item-edit-modal").remove();
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("roadmap-item-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-item-edit-modal") {
              document.getElementById("roadmap-item-edit-modal").remove();
            }
          });
      }

      // ë¡œë“œë§µ ì„¤ëª… ìˆ˜ì • ëª¨ë‹¬
      function openRoadmapDescriptionEditModal(blockId) {
        const block = blocksData.find((b) => b.id === blockId);
        if (!block) return;

        const description = block.payload?.description || "";

        const modalHTML = `
                <div id="roadmap-description-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ë¡œë“œë§µ ì„¤ëª… ìˆ˜ì •</h3>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                        <textarea id="roadmap-description-text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="4" placeholder="ì„¤ëª…">${saf(
                          description
                        )}</textarea>
                      </div>
                      <input id="roadmap-description-block-id" type="hidden" value="${blockId}">
                    </div>
                    <div class="flex gap-3 mt-6">
                      <button id="roadmap-description-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                      </button>
                      <button id="roadmap-description-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                </div>
              `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById(
          "roadmap-description-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-description-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-description-block-id"
            ).value;
            const description = document
              .getElementById("roadmap-description-text")
              .value.trim();

            await updateRoadmapDescription(blockId, description);
            showAlert("âœ…", "ë¡œë“œë§µ ì„¤ëª…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("roadmap-description-edit-modal").remove();
            renderBlocks(); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          });

        document
          .getElementById("roadmap-description-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-description-edit-modal").remove();
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("roadmap-description-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-description-edit-modal") {
              document
                .getElementById("roadmap-description-edit-modal")
                .remove();
            }
          });
      }

      // ë¡œë“œë§µ ì¼ì • ì¶”ê°€ ëª¨ë‹¬
      function openRoadmapItemAddModal(blockId) {
        const modalHTML = `
                <div id="roadmap-item-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ìƒˆ ë¡œë“œë§µ ì¼ì • ì¶”ê°€</h3>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                        <input id="roadmap-add-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì¼ì • ì œëª©">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <input id="roadmap-add-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                        <textarea id="roadmap-add-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="ì„¤ëª…"></textarea>
                      </div>
                      <input id="roadmap-add-block-id" type="hidden" value="${blockId}">
                    </div>
                    <div class="flex gap-3 mt-6">
                      <button id="roadmap-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>ì¶”ê°€
                      </button>
                      <button id="roadmap-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                </div>
              `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById("roadmap-item-add-modal");
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-add-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-add-block-id"
            ).value;
            const title = document
              .getElementById("roadmap-add-title")
              .value.trim();
            const date = document.getElementById("roadmap-add-date").value;
            const description = document
              .getElementById("roadmap-add-description")
              .value.trim();

            if (!title) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (!date) {
              showAlert("ğŸ˜¥", "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            await addRoadmapItem(blockId, title, date, description);
            showAlert("âœ…", "ìƒˆ ë¡œë“œë§µ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("roadmap-item-add-modal").remove();
            renderBlocks(); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          });

        document
          .getElementById("roadmap-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-item-add-modal").remove();
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("roadmap-item-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-item-add-modal") {
              document.getElementById("roadmap-item-add-modal").remove();
            }
          });
      }

      // ë¡œë“œë§µ ë¸”ë¡ ì—…ë°ì´íŠ¸
      async function updateRoadmapBlock(blockId, title, date, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        await updateDoc(blockRef, {
          title: title,
          payload: {
            date: date,
            description: description,
          },
        });
      }

      // ë¡œë“œë§µ ì„¤ëª… ì—…ë°ì´íŠ¸
      async function updateRoadmapDescription(blockId, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const block = blocksData.find((b) => b.id === blockId);
        await updateDoc(blockRef, {
          payload: {
            ...block.payload,
            description: description,
          },
        });
      }

      // ë¡œë“œë§µ ì¼ì • ì‚­ì œ (ë‹¤ì¤‘ ì¼ì • ì§€ì›)
      async function deleteRoadmapItem(blockId, itemIndex) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • êµ¬ì¡°ì¸ ê²½ìš° ì „ì²´ ë¸”ë¡ ì‚­ì œ
        if (items.length === 0 && blockData.payload?.date) {
          await deleteDoc(blockRef);
          return;
        }

        // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ì¸ ê²½ìš° í•´ë‹¹ ì¼ì •ë§Œ ì‚­ì œ
        if (itemIndex >= 0 && itemIndex < items.length) {
          items.splice(itemIndex, 1);

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: items,
            },
          });
        }
      }

      // ë¡œë“œë§µ ì¼ì • ì¶”ê°€ (ë‹¤ì¤‘ ì¼ì • ì§€ì›)
      async function addRoadmapItem(blockId, title, date, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • êµ¬ì¡°ë¥¼ ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ë¡œ ë³€í™˜
        if (items.length === 0 && blockData.payload?.date) {
          const existingItem = {
            title: blockData.title || "ê¸°ì¡´ ì¼ì •",
            date: blockData.payload.date,
            description: blockData.payload.description || "",
          };

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: [
                existingItem,
                {
                  title: title,
                  date: date,
                  description: description,
                },
              ],
            },
          });
        } else {
          // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ì— ìƒˆ ì¼ì • ì¶”ê°€
          const newItem = {
            title: title,
            date: date,
            description: description,
          };

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: [...items, newItem],
            },
          });
        }
      }

      // ë¡œë“œë§µ ì¼ì • ìˆ˜ì • (ë‹¤ì¤‘ ì¼ì • ì§€ì›)
      async function updateRoadmapItem(
        blockId,
        itemIndex,
        title,
        date,
        description
      ) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • êµ¬ì¡°ì¸ ê²½ìš°
        if (items.length === 0 && blockData.payload?.date) {
          await updateDoc(blockRef, {
            title: title,
            payload: {
              ...blockData.payload,
              date: date,
              description: description,
            },
          });
        } else {
          // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ì¸ ê²½ìš°
          if (itemIndex >= 0 && itemIndex < items.length) {
            items[itemIndex] = {
              title: title,
              date: date,
              description: description,
            };

            await updateDoc(blockRef, {
              payload: {
                ...blockData.payload,
                items: items,
              },
            });
          }
        }
      }

      function renderRoadmap() {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì•„ë¬´ê²ƒë„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ (ë¸”ë¡ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
        if (!currentUser) {
          debugLog("renderRoadmap: ë¡œê·¸ì•„ì›ƒ ìƒíƒœ - ë Œë”ë§í•˜ì§€ ì•ŠìŒ");
          return;
        }

        const c = document.getElementById("roadmap-container");
        const btn = document.getElementById("roadmap-toggle-btn");
        if (!c) return;
        const total = roadmapData.length;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // order ìš°ì„  â†’ ë‚ ì§œ(ì˜¤ë¦„ì°¨ìˆœ)
        const sorted = [...roadmapData].sort((a, b) => {
          const ao = a.order ?? 999999,
            bo = b.order ?? 999999;
          if (ao !== bo) return ao - bo;
          return (a.activityDate || "").localeCompare(b.activityDate || "");
        });

        const enriched = sorted.map((item) => {
          const d = parseDate(item.activityDate);
          let status = "upcoming";
          if (d < today) status = "completed";
          else if (d.toDateString() === today.toDateString()) status = "today";
          return { ...item, _date: d, _status: status };
        });
        let itemsToShow = enriched;
        if (!roadmapShowAll) {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ: ëë‚œ ì¼ì • 1ê°œ + ì•ìœ¼ë¡œ ìˆì„ ì¼ì • 3ê°œ
          if (!currentUser) {
            const completed = enriched.filter((x) => x._status === "completed");
            const upcoming = enriched.filter((x) => x._status !== "completed");

            // ì™„ë£Œëœ ì¼ì •ì„ ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ ìµœê·¼ ê²ƒ ì„ íƒ
            const sortedCompleted = completed.sort((a, b) => b._date - a._date);
            const latestCompleted =
              sortedCompleted.length > 0 ? [sortedCompleted[0]] : [];

            // ì•ìœ¼ë¡œ ìˆì„ ì¼ì • ì¤‘ ìµœëŒ€ 3ê°œë§Œ ì„ íƒ
            const upcomingLimited = upcoming.slice(0, 3);

            itemsToShow = [...latestCompleted, ...upcomingLimited];
          } else {
            // ë¡œê·¸ì¸ ìƒíƒœ: ìµœê·¼ ëë‚œ ì¼ì • 1ê°œ + ì•ìœ¼ë¡œ ì˜¬ ì¼ì •ë“¤ë§Œ í‘œì‹œ
            const completed = enriched.filter((x) => x._status === "completed");
            const upcoming = enriched.filter((x) => x._status !== "completed");

            // ì™„ë£Œëœ ì¼ì •ì„ ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ ìµœê·¼ ê²ƒ ì„ íƒ
            const sortedCompleted = completed.sort((a, b) => b._date - a._date);
            const latestCompleted =
              sortedCompleted.length > 0 ? [sortedCompleted[0]] : [];

            itemsToShow = [...latestCompleted, ...upcoming];
          }
        }
        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ - ìš´ì˜ì§„ ì œì™¸, ì„ì›ì§„ë§Œ ê°€ëŠ¥
        const isAdminForRoadmap = isFullAdmin();

        console.log("ë¡œë“œë§µ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸:", {
          currentUser: currentUser?.name,
          isAdminForRoadmap,
          roadmapDataLength: roadmapData.length,
        });

        // ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ í‘œì‹œ/ìˆ¨ê¹€
        const adminControls = document.getElementById("roadmap-admin-controls");
        console.log("ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ ìš”ì†Œ:", adminControls);

        if (adminControls) {
          if (isAdminForRoadmap) {
            adminControls.classList.remove("hidden");
            console.log("ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ í‘œì‹œë¨");
          } else {
            adminControls.classList.add("hidden");
            console.log("ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ë¨");
          }
        } else {
          console.error("roadmap-admin-controls ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        }

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ë¡œë“œë§µì„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ (ë¸”ë¡ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
        if (!currentUser) {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì•„ë¬´ê²ƒë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
          c.innerHTML = "";
        } else {
          // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ í˜•íƒœ ìœ ì§€
          c.innerHTML =
            total === 0
              ? `<p class="text-gray-400 text-center py-4">ì˜ˆì •ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤. íšŒì¥ë‹˜ì´ ê³§ ì¼ì •ì„ ì¶”ê°€í•  ê±°ì˜ˆìš”!</p>`
              : itemsToShow
                  .map(
                    (item, index) => `<div class="v-item ${
                      item._status
                    } relative">
                      <div class="flex items-center justify-between">
                        <div class="flex-1">
                          <div class="font-bold text-gray-800">${saf(
                            item.activityName
                          )}</div>
                          <div class="text-sm text-gray-500">${item._date.toLocaleDateString(
                            "ko-KR"
                          )}</div>
                        </div>
                        ${
                          isAdminForRoadmap
                            ? `
                          <div class="flex gap-1 ml-2">
                            <button class="edit-roadmap-event bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors"
                                    data-event-id="${item.id}" data-event-index="${index}" title="ì¼ì • ìˆ˜ì •">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-roadmap-event bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors"
                                    data-event-id="${item.id}" data-event-index="${index}" title="ì¼ì • ì‚­ì œ">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        `
                            : ""
                        }
                      </div>
                    </div>`
                  )
                  .join("");
        }
        if (btn) {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” í•­ìƒ ë²„íŠ¼ ìˆ¨ê¹€ (ì´ë¯¸ ë‹¬ë ¥ í˜•íƒœë¡œ í‘œì‹œë˜ë¯€ë¡œ)
          if (!currentUser) {
            btn.classList.add("hidden");
          } else {
            // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€
            const shouldShowButton = total > 4;
            if (shouldShowButton) {
              btn.classList.remove("hidden");
              const textElement = btn.querySelector("#roadmap-toggle-text");
              if (textElement) {
                textElement.textContent = roadmapShowAll
                  ? "ê°„ë‹¨íˆ ë³´ê¸°"
                  : "ìº˜ë¦°ë”";
              }
              btn.onclick = () => {
                roadmapShowAll = !roadmapShowAll;
                renderRoadmap();
              };
            } else {
              btn.classList.add("hidden");
            }
          }
        }

        // ë¡œë“œë§µ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (isAdminForRoadmap) {
          // ì¼ì • ì¶”ê°€ ë²„íŠ¼
          const addBtn = document.getElementById("add-roadmap-event");
          if (addBtn) {
            addBtn.onclick = () => {
              openRoadmapEventAddModal();
            };
          }

          // ì¼ì • ìˆ˜ì • ë²„íŠ¼ë“¤
          document.querySelectorAll(".edit-roadmap-event").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const eventId = btn.dataset.eventId;
              const eventIndex = parseInt(btn.dataset.eventIndex);
              openRoadmapEventEditModal(eventId, eventIndex);
            });
          });

          // ì¼ì • ì‚­ì œ ë²„íŠ¼ë“¤
          document.querySelectorAll(".delete-roadmap-event").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const eventId = btn.dataset.eventId;
              const eventIndex = parseInt(btn.dataset.eventIndex);

              if (confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                try {
                  await deleteDoc(doc(db, "roadmap", eventId));
                  showAlert("âœ…", "ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  renderRoadmap();
                } catch (error) {
                  console.error("ì¼ì • ì‚­ì œ ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });
          });
        }
      }

      // ë¡œë“œë§µ ì¼ì • ì¶”ê°€ ëª¨ë‹¬
      function openRoadmapEventAddModal() {
        const modalHTML = `
                <div id="roadmap-event-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ë¡œë“œë§µ ì¼ì • ì¶”ê°€</h3>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                        <input id="roadmap-event-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì¼ì • ì œëª©">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <input id="roadmap-event-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                      </div>
                      <div class="flex items-center gap-2">
                        <input id="roadmap-event-admin-only" type="checkbox" class="w-4 h-4 text-orange-600 bg-gray-100 border-gray-300 rounded focus:ring-orange-500">
                        <label for="roadmap-event-admin-only" class="text-sm font-medium text-gray-700">
                          <i class="fas fa-lock mr-1 text-orange-600"></i>ìš´ì˜ì§„ ì „ìš© ì¼ì • (ì¼ë°˜ íšŒì›ì—ê²ŒëŠ” ë³´ì´ì§€ ì•ŠìŒ)
                        </label>
                      </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                      <button id="roadmap-event-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>ì¶”ê°€
                      </button>
                      <button id="roadmap-event-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                </div>
              `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById(
          "roadmap-event-add-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-event-add-save")
          .addEventListener("click", async () => {
            const name = document
              .getElementById("roadmap-event-name")
              .value.trim();
            const date = document.getElementById("roadmap-event-date").value;
            const isAdminOnly = document.getElementById(
              "roadmap-event-admin-only"
            ).checked;

            if (!name) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (!date) {
              showAlert("ğŸ˜¥", "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              const ord = roadmapData?.length || 0;
              await addDoc(collection(db, "roadmap"), {
                activityName: name,
                activityDate: date,
                order: ord,
                isAdminOnly: isAdminOnly,
              });
              showAlert("âœ…", "ë¡œë“œë§µ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document.getElementById("roadmap-event-add-modal").remove();
              renderRoadmap();
            } catch (error) {
              console.error("ì¼ì • ì¶”ê°€ ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });

        document
          .getElementById("roadmap-event-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-event-add-modal").remove();
          });
      }

      // ë¡œë“œë§µ ì¼ì • ìˆ˜ì • ëª¨ë‹¬
      window.openRoadmapEventEditModal = function (eventId, eventIndex) {
        const event = roadmapData.find((e) => e.id === eventId);
        if (!event) return;

        const modalHTML = `
                <div id="roadmap-event-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ë¡œë“œë§µ ì¼ì • ìˆ˜ì •</h3>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                        <input id="roadmap-event-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${saf(
                          event.activityName
                        )}" placeholder="ì¼ì • ì œëª©">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <input id="roadmap-event-edit-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${
                          event.activityDate
                        }">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                        <textarea id="roadmap-event-edit-description" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì¼ì • ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤">${saf(
                          event.description || ""
                        )}</textarea>
                        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Enter í‚¤ë¡œ ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                      </div>
                      <div>
                        <label class="flex items-center gap-2">
                          <input id="roadmap-event-edit-admin-only" type="checkbox" class="w-4 h-4 text-orange-600 bg-white border border-gray-300 rounded focus:ring-orange-500 focus:ring-2" ${
                            event.isAdminOnly ? "checked" : ""
                          }>
                          <span class="text-sm font-medium text-gray-700">ê´€ë¦¬ìë§Œ ë³´ì´ë„ë¡ ì„¤ì •</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1">ì²´í¬í•˜ë©´ ì¼ë°˜ íšŒì›ì—ê²ŒëŠ” ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                      </div>
                      <input id="roadmap-event-edit-id" type="hidden" value="${eventId}">
                    </div>
                    <div class="flex gap-3 mt-6">
                      <button id="roadmap-event-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>ìˆ˜ì •
                      </button>
                      <button id="roadmap-event-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                </div>
              `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById(
          "roadmap-event-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-event-edit-save")
          .addEventListener("click", async () => {
            const eventId = document.getElementById(
              "roadmap-event-edit-id"
            ).value;
            const name = document
              .getElementById("roadmap-event-edit-name")
              .value.trim();
            const date = document.getElementById(
              "roadmap-event-edit-date"
            ).value;
            const description = document.getElementById(
              "roadmap-event-edit-description"
            ).value;
            const isAdminOnly = document.getElementById(
              "roadmap-event-edit-admin-only"
            ).checked;

            if (!name) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (!date) {
              showAlert("ğŸ˜¥", "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              console.log("ë¡œë“œë§µ ìˆ˜ì • ì‹œë„:", {
                eventId,
                name,
                date,
                description,
              });
              console.log("í˜„ì¬ roadmapData:", roadmapData);
              console.log(
                "ì°¾ìœ¼ë ¤ëŠ” ì´ë²¤íŠ¸:",
                roadmapData.find((e) => e.id === eventId)
              );

              // ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
              const docRef = doc(db, "roadmap", eventId);
              const docSnap = await getDoc(docRef);

              console.log("ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€:", docSnap.exists());
              console.log(
                "ë¬¸ì„œ ë°ì´í„°:",
                docSnap.exists() ? docSnap.data() : "ë¬¸ì„œ ì—†ìŒ"
              );

              if (!docSnap.exists()) {
                showAlert("ğŸ˜¥", "ìˆ˜ì •í•˜ë ¤ëŠ” ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
              }

              await updateDoc(docRef, {
                activityName: name,
                activityDate: date,
                description: description,
                isAdminOnly: isAdminOnly,
              });
              showAlert("âœ…", "ë¡œë“œë§µ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document.getElementById("roadmap-event-edit-modal").remove();
              // ìˆ˜ì • í›„ ë¡œë“œë§µ ìƒˆë¡œê³ ì¹¨ (onSnapshotìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸ë¨)
            } catch (error) {
              console.error("ì¼ì • ìˆ˜ì • ì˜¤ë¥˜:", error);
              if (error.code === "not-found") {
                showAlert("ğŸ˜¥", "ìˆ˜ì •í•˜ë ¤ëŠ” ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              } else {
                showAlert("ğŸ˜¥", "ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            }
          });

        document
          .getElementById("roadmap-event-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-event-edit-modal").remove();
          });
      };

      /* ===================== ì°¸ê°€ì ë”ë³´ê¸° í† ê¸€ ===================== */
      window.toggleParticipantsList = function (event, uniqueId, hiddenCount) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        const hiddenDiv = document.getElementById(`${uniqueId}-hidden`);
        if (!hiddenDiv) {
          console.error("ìˆ¨ê²¨ì§„ ì°¸ê°€ì ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", uniqueId);
          return;
        }

        // event.target ë˜ëŠ” event.currentTarget ì‚¬ìš©
        let button = event ? event.currentTarget || event.target : null;

        // ë²„íŠ¼ì´ í´ë¦­ëœ ìš”ì†Œê°€ ì•„ë‹ˆë¼ë©´ ê°€ì¥ ê°€ê¹Œìš´ button ì°¾ê¸°
        if (button && button.tagName !== "BUTTON") {
          button = button.closest("button");
        }

        if (!button) {
          console.error("ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        const icon = button.querySelector("i");
        const text = button.querySelector("span");

        if (!icon || !text) {
          // í´ë°±: innerHTMLë¡œ ì§ì ‘ ë³€ê²½ (ì •ìƒ ì‘ë™)
          const isHidden = hiddenDiv.classList.contains("hidden");
          if (isHidden) {
            hiddenDiv.classList.remove("hidden");
            button.innerHTML = `<i class="fas fa-chevron-up"></i><span>ì ‘ê¸°</span>`;
          } else {
            hiddenDiv.classList.add("hidden");
            button.innerHTML = `<i class="fas fa-chevron-down"></i><span>ì™¸ ${hiddenCount}ëª… ë”ë³´ê¸°</span>`;
          }
          return;
        }

        const isHidden = hiddenDiv.classList.contains("hidden");

        if (isHidden) {
          // í¼ì¹˜ê¸°
          hiddenDiv.classList.remove("hidden");
          icon.className = "fas fa-chevron-up";
          text.textContent = "ì ‘ê¸°";
        } else {
          // ì ‘ê¸°
          hiddenDiv.classList.add("hidden");
          icon.className = "fas fa-chevron-down";
          text.textContent = `ì™¸ ${hiddenCount}ëª… ë”ë³´ê¸°`;
        }
      };

      /* ===================== ì‹ ì²­ íƒ­ ===================== */
      function computeEventStats(ev) {
        const getAll = () => {
          if (ev.type === "tasting") {
            const arr = [];
            (ev.restaurants || []).forEach((r) => {
              arr.push(...(r.reservations || []), ...(r.waiting || []));
            });
            return arr;
          }
          return [...(ev.applicants || []), ...(ev.waiting || [])];
        };
        const all = getAll();
        const stats = all.map((p) => ({
          gender: p.gender || "ë¯¸ìƒ",
          college: p.college || "ë¯¸ìƒ",
        }));
        const total = stats.length;
        const genderCount = { ë‚¨: 0, ì—¬: 0, ê¸°íƒ€: 0, ë¯¸ìƒ: 0 };
        stats.forEach((s) => {
          if (genderCount[s.gender] == null) genderCount["ë¯¸ìƒ"]++;
          else genderCount[s.gender]++;
        });
        const genderPct = Object.fromEntries(
          Object.entries(genderCount).map(([k, v]) => [
            k,
            total ? Math.round((v / total) * 1000) / 10 : 0,
          ])
        );
        const collegeMap = new Map();
        stats.forEach((s) => {
          const key = s.college || "ë¯¸ìƒ";
          collegeMap.set(key, (collegeMap.get(key) || 0) + 1);
        });
        const colleges = [...collegeMap.entries()]
          .map(([name, cnt]) => ({
            name,
            cnt,
            pct: total ? Math.round((cnt / total) * 1000) / 10 : 0,
          }))
          .sort((a, b) => b.cnt - a.cnt);
        return { total, genderPct, genderCount, colleges };
      }
      function adminStatsHTML(ev) {
        if (!isFullAdmin()) return "";
        const st = computeEventStats(ev);
        const gLine =
          st.total > 0
            ? `ë‚¨ ${st.genderCount.ë‚¨}ëª… Â· ì—¬ ${st.genderCount.ì—¬}ëª…${
                st.genderCount.ê¸°íƒ€ ? ` Â· ê¸°íƒ€ ${st.genderCount.ê¸°íƒ€}ëª…` : ""
              }`
            : "ìë£Œ ì—†ìŒ";
        const colleges =
          st.colleges
            .slice(0, 5)
            .map((c) => `${saf(c.name)} ${c.cnt}ëª…`)
            .join(" Â· ") || "ìë£Œ ì—†ìŒ";
        return `<div class="mt-3 text-xs bg-gray-50 border rounded p-2">
                       <div class="font-semibold text-gray-700">ê´€ë¦¬ììš© ì‹ ì²­ì í†µê³„ <span class="text-[11px] text-gray-500">(ì‹ ì²­+ëŒ€ê¸° í¬í•¨)</span></div>
                       <div class="mt-1 text-gray-700">ì„±ë³„: ${gLine}</div>
                       <div class="mt-1 text-gray-700">ë‹¨ê³¼ëŒ€ ìƒìœ„: ${colleges}</div>
                     </div>`;
      }
      const adminInline = (ev) => {
        if (!isFullAdmin()) return "";
        return `<div class="mt-3 flex gap-2 flex-wrap">
                        <button type="button" class="text-blue-600 hover:text-blue-800 text-sm" data-act="admin-edit" data-id="${ev.id}"><i class="fas fa-pen"></i> ìˆ˜ì •</button>
                        <button type="button" class="text-red-600 hover:text-red-800 text-sm font-semibold" data-act="admin-close" data-id="${ev.id}"><i class="fas fa-door-closed"></i> ì‹ ì²­ ë§ˆê°</button>
                        <button type="button" class="text-purple-600 hover:text-purple-800 text-sm" data-act="group-maker" data-id="${ev.id}"><i class="fas fa-users"></i> íŒ€ êµ¬ì„±í•˜ê¸°</button>
                        <button type="button" class="text-orange-700 hover:text-orange-900 text-sm" data-act="export-xlsx" data-id="${ev.id}"><i class="fas fa-file-excel"></i> ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ</button>
                        <button type="button" class="text-red-600 hover:text-red-800 text-sm" data-act="admin-delete" data-id="${ev.id}"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                      </div>
                      <div class="absolute top-2 right-2 flex gap-1">
                        <button type="button" class="move-event-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors"
                                data-act="move-event-up" data-id="${ev.id}" title="ìœ„ë¡œ ì´ë™">
                          <i class="fas fa-arrow-up"></i>
                        </button>
                        <button type="button" class="move-event-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors"
                                data-act="move-event-down" data-id="${ev.id}" title="ì•„ë˜ë¡œ ì´ë™">
                          <i class="fas fa-arrow-down"></i>
                        </button>
                      </div>`;
      };
      function paymentInfoHTML(ev) {
        if (!(ev.type === "mt" || ev.type === "assembly")) return "";
        const p = ev.payment || {};
        if (!p.bank && !p.number && !p.holder && !p.amount && !p.note)
          return "";

        // ì‹ ì²­ ì‹œì‘ ì‹œê°„ ì²´í¬
        const now = new Date();
        const registrationStartTime = ev.registrationStart
          ? new Date(ev.registrationStart)
          : null;
        const isBeforeRegistrationStart =
          registrationStartTime && now < registrationStartTime;

        // ì‹ ì²­ ì‹œì‘ ì „ì´ë©´ ì…ê¸ˆ ì •ë³´ë¥¼ ìˆ¨ê¹€
        if (isBeforeRegistrationStart) {
          return `<div class="mt-2 text-sm bg-gray-100 border border-gray-300 rounded p-3">
                          <div class="font-semibold text-gray-600 mb-2 flex items-center gap-2">
                            <i class="fas fa-lock"></i>
                            ğŸ’¸ íšŒë¹„ ì…ê¸ˆ ì •ë³´
                          </div>
                          <div class="text-gray-500 text-sm">ì‹ ì²­ ì‹œì‘ í›„ ì…ê¸ˆ ì •ë³´ê°€ ê³µê°œë©ë‹ˆë‹¤</div>
                        </div>`;
        }

        const line = [p.bank, p.number].filter(Boolean).map(saf).join(" ");
        const accountInfo = line || "";
        const amount = p.amount ? formatKRW(p.amount) : "";
        return `<div class="mt-2 text-sm bg-orange-50 border border-orange-200 rounded p-3">
                        <div class="font-semibold text-orange-800 mb-2">ğŸ’¸ íšŒë¹„ ì…ê¸ˆ ì •ë³´</div>
                        ${
                          amount
                            ? `<div class="text-orange-700 mb-2 font-bold text-lg">íšŒë¹„: ${amount}</div>`
                            : ""
                        }
                        <div class="text-orange-700 mb-2 select-all cursor-pointer hover:bg-orange-100 p-2 rounded transition-colors"
                             onclick="copyToClipboard('${accountInfo.replace(
                               /'/g,
                               "\\'"
                             )}')"
                             title="í´ë¦­í•˜ì—¬ ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬">${accountInfo}${
          p.holder ? ` (ì˜ˆê¸ˆì£¼ ${saf(p.holder)})` : ""
        }</div>
                        ${
                          p.note
                            ? `<div class="text-orange-700 mb-2">${saf(
                                p.note
                              )}</div>`
                            : ""
                        }
                        ${
                          accountInfo
                            ? `<button
                                onclick="copyToClipboard('${accountInfo.replace(
                                  /'/g,
                                  "\\'"
                                )}')"
                                class="w-full bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2"
                                title="ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬">
                                <i class="fas fa-copy"></i>
                                ê³„ì¢Œ ë³µì‚¬í•˜ê¸°
                              </button>`
                            : ""
                        }
                      </div>`;
      }

      // ì‹ ì²­ ì·¨ì†Œ ì•ˆë‚´ ë¬¸êµ¬ (ê³µí†µ)
      const getCancelNotice = () => "";

      function generalCardHTML(ev) {
        const count = (ev.applicants || []).length,
          lim = ev.limit || 0;
        const my = isUserIn(ev.applicants)
          ? "apply"
          : isUserIn(ev.waiting)
          ? "wait"
          : "none";

        // ë””ë²„ê¹…: ì‚¬ìš©ì ìƒíƒœ í™•ì¸
        debugLog(`Event ${ev.id}: currentUser =`, currentUser);
        debugLog(`Event ${ev.id}: my = ${my}, count = ${count}, lim = ${lim}`);

        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì—ê²Œë§Œ ë²„íŠ¼ í‘œì‹œ
        let btn;

        // ì‹ ì²­ ì‹œì‘ ì‹œê°„ ì²´í¬
        const now = new Date();
        const registrationStartTime = ev.registrationStart
          ? new Date(ev.registrationStart)
          : null;
        const isBeforeRegistrationStart =
          registrationStartTime && now < registrationStartTime;

        if (currentUser) {
          if (my === "apply") {
            btn = `<button type="button" class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer" data-act="cancel-general" data-id="${ev.id}">ì‹ ì²­ ì·¨ì†Œ</button>`;
          } else if (my === "wait") {
            btn = `<button type="button" class="w-full mt-3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer" data-act="cancel-wait-general" data-id="${ev.id}">ëŒ€ê¸° ì·¨ì†Œ</button>`;
          } else if (isBeforeRegistrationStart) {
            // ì‹ ì²­ ì‹œì‘ ì „ - ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ
            const timeLeft = registrationStartTime - now;
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor(
              (timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
            );
            const minutes = Math.floor(
              (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            btn = `<button type="button" class="w-full mt-3 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed flex items-center justify-center gap-2" disabled data-countdown="${
              ev.id
            }" data-start="${ev.registrationStart}">
                    <i class="fas fa-hourglass-half"></i>
                    <span id="countdown-${ev.id}">${
              days > 0 ? `${days}ì¼ ` : ""
            }${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ í›„ ì˜¤í”ˆ</span>
                  </button>`;
          } else {
            btn = `<button type="button" class="w-full mt-3 ${
              count < lim
                ? "bg-orange-600 hover:bg-orange-700"
                : "bg-red-600 hover:bg-red-700"
            } text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer flex items-center justify-center gap-2" data-act="reserve-general" data-id="${
              ev.id
            }">
                    ${
                      count < lim
                        ? '<i class="fas fa-check"></i><span>í™œë™ ì‹ ì²­</span>'
                        : '<i class="fas fa-clock"></i><span>ì‹ ì²­ ë§ˆê° / ëŒ€ê¸°í•˜ê¸°</span>'
                    }
                  </button>`;
          }
        } else {
          btn = `<div class="w-full mt-3 bg-gray-100 text-gray-500 font-bold py-2 rounded text-center">ë¡œê·¸ì¸ í›„ ì‹ ì²­ ê°€ëŠ¥</div>`;
        }

        // í•™ë²ˆ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
        const maskStudentId = (studentId) => {
          if (!studentId) return "";
          if (studentId.length <= 4) return studentId;
          return studentId.substring(0, 4) + "*".repeat(studentId.length - 4);
        };

        // ì°¸ê°€ì ëª©ë¡ ìƒì„± (4ëª… ì´ìƒì¼ ë•Œ ë”ë³´ê¸° ë²„íŠ¼) - ìµœì‹  ì‹ ì²­ìë¶€í„° í‘œì‹œ
        const applicantsList = (ev.applicants || []).slice().reverse();
        const waitingListArr = (ev.waiting || []).slice().reverse();

        const createParticipantsList = (list, bgColor, textColor) => {
          const items = list.map(
            (a) =>
              `<span class="${bgColor} ${textColor} px-2 py-1 rounded-full text-xs flex items-center gap-1">
                    <span class="text-xs">${saf(a.name)}</span>
                    <span class="${textColor} font-mono text-xs">(${maskStudentId(
                a.studentId
              )})</span>
                    ${
                      isFullAdmin()
                        ? `<button class="ml-1 text-red-600 hover:text-red-800 transition-colors" onclick="confirmRemoveParticipant('${ev.id}', '${a.studentId}', 'applicants')" title="ì°¸ê°€ì ì œì™¸"><i class="fas fa-times"></i></button>`
                        : ""
                    }
                  </span>`
          );

          if (items.length <= 4) {
            return items.join("");
          } else {
            const visibleItems = items.slice(0, 4).join("");
            const hiddenItems = items.slice(4).join("");
            const uniqueId = `participants-${ev.id}`;
            return `
                    ${visibleItems}
                    <div id="${uniqueId}-hidden" class="hidden flex flex-wrap gap-1">
                      ${hiddenItems}
                    </div>
                    <button
                      class="mt-2 w-full text-sm text-orange-600 hover:text-orange-700 font-semibold py-2 px-3 bg-orange-50 hover:bg-orange-100 rounded-lg transition-all flex items-center justify-center gap-2 border border-orange-200"
                      data-toggle-id="${uniqueId}"
                      onclick="toggleParticipantsList(event, '${uniqueId}', ${
              items.length - 4
            })">
                      <i class="fas fa-chevron-down"></i>
                      <span>ì™¸ ${items.length - 4}ëª… ë”ë³´ê¸°</span>
                    </button>
                  `;
          }
        };

        const namesList = createParticipantsList(
          applicantsList,
          "bg-orange-100",
          "text-orange-800"
        );

        // ëŒ€ê¸°ììš© ë³„ë„ í•¨ìˆ˜ (ë‹¤ë¥¸ ID ì‚¬ìš©)
        const createWaitingList = (list, bgColor, textColor) => {
          const items = list.map(
            (a) =>
              `<span class="${bgColor} ${textColor} px-2 py-1 rounded-full text-xs flex items-center gap-1">
                    <span class="text-xs">${saf(a.name)}</span>
                    <span class="${textColor} font-mono text-xs">(${maskStudentId(
                a.studentId
              )})</span>
                    ${
                      isFullAdmin()
                        ? `<button class="ml-1 text-red-600 hover:text-red-800 transition-colors" onclick="confirmRemoveParticipant('${ev.id}', '${a.studentId}', 'waiting')" title="ëŒ€ê¸°ì ì œì™¸"><i class="fas fa-times"></i></button>`
                        : ""
                    }
                  </span>`
          );

          if (items.length <= 4) {
            return items.join("");
          } else {
            const visibleItems = items.slice(0, 4).join("");
            const hiddenItems = items.slice(4).join("");
            const uniqueId = `waiting-${ev.id}`;
            return `
                    ${visibleItems}
                    <div id="${uniqueId}-hidden" class="hidden flex flex-wrap gap-1">
                      ${hiddenItems}
                    </div>
                    <button
                      class="mt-2 w-full text-sm text-orange-600 hover:text-orange-700 font-semibold py-2 px-3 bg-orange-50 hover:bg-orange-100 rounded-lg transition-all flex items-center justify-center gap-2 border border-orange-200"
                      data-toggle-id="${uniqueId}"
                      onclick="toggleParticipantsList(event, '${uniqueId}', ${
              items.length - 4
            })">
                      <i class="fas fa-chevron-down"></i>
                      <span>ì™¸ ${items.length - 4}ëª… ë”ë³´ê¸°</span>
                    </button>
                  `;
          }
        };

        const waitingList = createWaitingList(
          waitingListArr,
          "bg-orange-200",
          "text-orange-900"
        );
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // ì´ë²¤íŠ¸ íƒ€ì…ë³„ ì´ëª¨ì§€
        const typeIcon =
          ev.type === "tasting"
            ? "ğŸ½ï¸"
            : ev.type === "mt"
            ? "ğŸ•ï¸"
            : ev.type === "assembly"
            ? "ğŸ¤"
            : "ğŸ“…";

        return `<div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 group" data-event-id="${
          ev.id
        }" style="position: relative; z-index: 1;">
                    <div class="p-4 sm:p-6">
                      <div class="mb-3 sm:mb-4">
                        <div class="flex items-start justify-between mb-3">
                          <div class="flex-1">
                            <div class="mb-2">
                              <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-calendar text-orange-600 text-sm"></i>
                                <span class="text-xs sm:text-sm font-semibold text-orange-700 uppercase tracking-wide">í™œë™ ì •ë³´</span>
                              </div>
                              <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-3xl sm:text-4xl">${typeIcon}</span>
                                <h3 class="text-2xl sm:text-3xl font-extrabold text-gray-900">
                                  ${saf(ev.title)}
                                </h3>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="mt-3 space-y-2">
                          <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl p-3 sm:p-4 border-2 border-orange-200 shadow-sm">
                            <div class="flex items-center gap-2 mb-1">
                              <i class="fas fa-calendar-check text-orange-600 text-base"></i>
                              <span class="text-sm font-bold text-gray-900">ì´ë²¤íŠ¸ ì‹¤ì‹œì¼</span>
                            </div>
                            <p class="text-base text-gray-800">${
                              ev.datetime
                                ? new Date(ev.datetime).toLocaleString(
                                    "ko-KR",
                                    {
                                      year: "numeric",
                                      month: "long",
                                      day: "numeric",
                                      hour: "2-digit",
                                      minute: "2-digit",
                                    }
                                  )
                                : "-"
                            }</p>
                          </div>
                          <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-3 sm:p-4 border-2 border-red-200 shadow-sm">
                            <div class="flex items-center gap-2 mb-1">
                              <i class="fas fa-clock text-red-600 text-base"></i>
                              <span class="text-sm font-bold text-gray-900">ì‹ ì²­ ë§ˆê°ì¼</span>
                            </div>
                            <p class="text-base text-gray-800">${
                              ev.deadline
                                ? new Date(ev.deadline).toLocaleString(
                                    "ko-KR",
                                    {
                                      year: "numeric",
                                      month: "long",
                                      day: "numeric",
                                      hour: "2-digit",
                                      minute: "2-digit",
                                    }
                                  )
                                : "ë¯¸ì„¤ì •"
                            }</p>
                          </div>
                        </div>
                        ${paymentInfoHTML(ev)}
                        ${btn}
                        ${getCancelNotice()}
                        ${
                          currentUser
                            ? `
                        <div class="mt-3">
                          ${
                            (ev.applicants || []).length > 0
                              ? `<div class="mt-2 text-xs text-gray-600">
                                  <div class="flex items-center justify-between mb-1">
                                    <span class="font-medium text-xs">ì°¸ê°€ì (${
                                      (ev.applicants || []).length
                                    }ëª…)</span>
                                    ${
                                      isFullAdmin()
                                        ? `<button
                                            type="button"
                                            class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors"
                                            onclick="toggleParticipantsPublicVisibility('${
                                              ev.id
                                            }', 'applicants')"
                                            id="toggle-participants-public-${
                                              ev.id
                                            }"
                                          >
                                            <i class="fas ${
                                              ev.participantsVisibleToAll
                                                ? "fa-user-lock"
                                                : "fa-users"
                                            } mr-1"></i>${
                                            ev.participantsVisibleToAll
                                              ? "íšŒì¥ë‹¨ë§Œ ë³´ì´ê¸°"
                                              : "ëª¨ë‘ì—ê²Œ ë³´ì´ê¸°"
                                          }
                                          </button>`
                                        : ""
                                    }
                                  </div>
                                  ${
                                    isFullAdmin() && ev.participantsVisibleToAll
                                      ? `
                                  <div class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-3"><div class="bg-orange-500 h-3 rounded-full" style="width:${
                                      lim
                                        ? Math.min(
                                            100,
                                            Math.round((count / lim) * 100)
                                          )
                                        : 0
                                    }%"></div></div>
                                    <p class="text-right text-[11px] mt-0.5 text-gray-600">ì‹ ì²­: ${count} / ${lim} ëª…</p>
                                  </div>
                                  `
                                      : ""
                                  }
                                  ${adminStatsHTML(ev)}
                                  ${
                                    ev.participantsVisibleToAll || isFullAdmin()
                                      ? `<div class="flex flex-wrap gap-1 mt-2">
                                          ${namesList}
                                        </div>`
                                      : ""
                                  }
                                </div>`
                              : ""
                          }
                          ${
                            (ev.waiting || []).length > 0
                              ? `<div class="mt-2 text-xs text-gray-600">
                                  <div class="flex items-center justify-between mb-1">
                                    <span class="font-medium text-xs">ëŒ€ê¸°ì (${
                                      (ev.waiting || []).length
                                    }ëª…)</span>
                                    ${
                                      isFullAdmin()
                                        ? `<button
                                            type="button"
                                            class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors"
                                            onclick="toggleParticipantsPublicVisibility('${
                                              ev.id
                                            }', 'waiting')"
                                            id="toggle-waiting-public-${ev.id}"
                                          >
                                            <i class="fas ${
                                              ev.waitingVisibleToAll
                                                ? "fa-user-lock"
                                                : "fa-users"
                                            } mr-1"></i>${
                                            ev.waitingVisibleToAll
                                              ? "íšŒì¥ë‹¨ë§Œ ë³´ì´ê¸°"
                                              : "ëª¨ë‘ì—ê²Œ ë³´ì´ê¸°"
                                          }
                                          </button>`
                                        : ""
                                    }
                                  </div>
                                  ${
                                    ev.waitingVisibleToAll || isFullAdmin()
                                      ? `<div class="flex flex-wrap gap-1">
                                          ${waitingList}
                                        </div>`
                                      : ""
                                  }
                                </div>`
                              : ""
                          }
                        </div>
                        `
                            : ""
                        }
                        <div class="text-[11px] text-gray-400 mt-2">ìƒíƒœ: ${statusLabel(
                          ev.status || "open"
                        )}</div>
                        <div class="flex gap-2 mt-2 text-sm text-gray-600">
                          <span class="px-2 py-0.5 rounded ${typeBadgeClass(
                            ev.type
                          )}">${typeLabel(ev.type)}</span>
                          ${
                            ev.status === "archived" && isAdmin
                              ? '<span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-800 text-xs font-medium"><i class="fas fa-eye-slash mr-1"></i>ë³´ê´€ (íšŒì¥ë‹¨ë§Œ í‘œì‹œ)</span>'
                              : ""
                          }
                        </div>
                        ${adminFullTableHTML(ev)}
                        ${adminInline(ev)}
                    </div>
                  </div>`;
      }
      function tastingCardHTML(ev) {
        const restaurantsSorted = (ev.restaurants || [])
          .slice()
          .sort((a, b) => {
            const aCapRaw = a.capacity ?? ev.limit ?? 0;
            const bCapRaw = b.capacity ?? ev.limit ?? 0;
            const aCap =
              Number.isFinite(Number(aCapRaw)) && Number(aCapRaw) > 0
                ? Number(aCapRaw)
                : 0;
            const bCap =
              Number.isFinite(Number(bCapRaw)) && Number(bCapRaw) > 0
                ? Number(bCapRaw)
                : 0;
            const aCnt = (a.reservations || []).length;
            const bCnt = (b.reservations || []).length;
            const aAvailable = aCap === 0 || aCnt < aCap;
            const bAvailable = bCap === 0 || bCnt < bCap;
            if (aAvailable === bAvailable) return 0;
            return aAvailable ? -1 : 1;
          });

        const list = restaurantsSorted
          .map((r) => {
            const rawCapacity = r.capacity ?? ev.limit ?? 0;
            const capNumber = Number(rawCapacity);
            const cap =
              Number.isFinite(capNumber) && capNumber > 0 ? capNumber : 0;
            const cnt = (r.reservations || []).length;
            const spotsRemaining = cap > 0 ? Math.max(cap - cnt, 0) : null;
            const isNearlyFull =
              spotsRemaining !== null && spotsRemaining === 1;
            const mine = (r.reservations || [])
              .concat(r.waiting || [])
              .some((p) => p.studentId === currentUser?.studentId);
            const isInReservations = (r.reservations || []).some(
              (p) => p.studentId === currentUser?.studentId
            );
            const isInWaiting = (r.waiting || []).some(
              (p) => p.studentId === currentUser?.studentId
            );

            // ì‹ ì²­ ì‹œì‘ ì‹œê°„ ì²´í¬
            const now = new Date();
            const registrationStartTime = ev.registrationStart
              ? new Date(ev.registrationStart)
              : null;
            const isBeforeRegistrationStart =
              registrationStartTime && now < registrationStartTime;

            let btn;
            if (currentUser) {
              if (isInReservations) {
                btn = `<button type="button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="cancel-tasting" data-id="${ev.id}" data-rid="${r.id}">
                        <i class="fas fa-times"></i>
                        <span>ì‹ ì²­ ì·¨ì†Œ</span>
                      </button>`;
              } else if (isInWaiting) {
                btn = `<button type="button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="cancel-wait-tasting" data-id="${ev.id}" data-rid="${r.id}">
                        <i class="fas fa-hourglass-half"></i>
                        <span>ëŒ€ê¸° ì·¨ì†Œ</span>
                      </button>`;
              } else if (isBeforeRegistrationStart) {
                // ì‹ ì²­ ì‹œì‘ ì „ - ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ
                const timeLeft = registrationStartTime - now;
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor(
                  (timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
                );
                const minutes = Math.floor(
                  (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
                );
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                btn = `<button type="button" class="w-full bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed flex items-center justify-center gap-2" disabled data-countdown="${
                  ev.id
                }-${r.id}" data-start="${ev.registrationStart}">
                        <i class="fas fa-hourglass-half"></i>
                        <span id="countdown-${ev.id}-${r.id}">${
                  days > 0 ? `${days}ì¼ ` : ""
                }${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ í›„ ì˜¤í”ˆ</span>
                      </button>`;
              } else {
                btn = `<button type="button" class="w-full ${
                  cnt < cap
                    ? "bg-orange-600 hover:bg-orange-700 shadow-orange-200"
                    : "bg-red-600 hover:bg-red-700 shadow-red-200"
                } text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="reserve-tasting" data-id="${
                  ev.id
                }" data-rid="${r.id}">
                        <i class="fas ${
                          cnt < cap ? "fa-check" : "fa-clock"
                        }"></i>
                        <span>${cnt < cap ? "í™œë™ ì‹ ì²­" : "ëŒ€ê¸°ì ì‹ ì²­"}</span>
                      </button>`;
              }
            } else {
              btn = `<div class="w-full bg-gray-100 text-gray-500 font-bold py-2 px-4 rounded-lg text-center flex items-center justify-center gap-2">
                      <i class="fas fa-lock"></i>
                      <span>ë¡œê·¸ì¸ í•„ìš”</span>
                    </div>`;
            }
            // í•™ë²ˆ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
            const maskStudentId = (studentId) => {
              if (!studentId) return "";
              if (studentId.length <= 4) return studentId;
              return (
                studentId.substring(0, 4) + "*".repeat(studentId.length - 4)
              );
            };

            // ì°¸ê°€ì ëª©ë¡ ìƒì„± (4ëª… ì´ìƒì¼ ë•Œ ë”ë³´ê¸° ë²„íŠ¼) - ìµœì‹  ì‹ ì²­ìë¶€í„° í‘œì‹œ
            const createRestaurantParticipantsList = (
              list,
              bgColor,
              textColor,
              restaurantId,
              type
            ) => {
              const items = list
                .slice()
                .reverse()
                .map((entry, index, arr) => {
                  const member =
                    (membersData || []).find(
                      (m) => m.studentId === entry.studentId
                    ) || null;
                  const name = saf(member?.name || entry.name || "ì´ë¦„ ì—†ìŒ");
                  const profileImage = member?.kakaoProfileImage || null;
                  const initials = name.charAt(0) || "F";
                  const isMe =
                    currentUser &&
                    entry.studentId === currentUser.studentId;
                  const waitPositionLabel =
                    type === "waiting"
                      ? `<span class="inline-flex items-center justify-center bg-white/40 border border-white/60 text-[10px] font-semibold px-1.5 py-0.5 rounded-full text-orange-900">ëŒ€ê¸° ${
                          arr.length - index
                        }ë²ˆ</span>`
                      : "";
                  return `<span class="${bgColor} ${textColor} px-2 py-1 rounded-full text-xs flex items-center gap-2 border border-white/60 shadow-sm">
                          <div class="w-7 h-7 rounded-full overflow-hidden flex items-center justify-center bg-white/70 ${
                            isMe ? "ring-2 ring-orange-500" : ""
                          }">
                            ${
                              profileImage
                                ? `<img src="${profileImage}" alt="${name}" class="w-full h-full object-cover">`
                                : `<span class="text-xs font-bold text-orange-700">${initials}</span>`
                            }
                          </div>
                          <div class="flex items-center gap-1">
                            ${waitPositionLabel}
                            <span class="text-xs font-semibold">${name}</span>
                            <span class="${textColor} font-mono text-[11px]">(${maskStudentId(
                              entry.studentId
                            )})</span>
                          </div>
                          ${
                            isFullAdmin()
                              ? `<button class="ml-1 text-red-600 hover:text-red-800 transition-colors" onclick="confirmRemoveParticipant('${ev.id}', '${entry.studentId}', '${type}', '${restaurantId}')" title="ì°¸ê°€ì ì œì™¸"><i class="fas fa-times"></i></button>`
                              : ""
                          }
                        </span>`;
                });

              if (items.length === 0) return "";

              const maxVisible = 2;
              if (items.length <= maxVisible) {
                return items.join("");
              } else {
                const visibleItems = items.slice(0, maxVisible).join("");
                const hiddenItems = items.slice(maxVisible).join("");
                const uniqueId = `restaurant-${restaurantId}-${type}`;
                return `
                        ${visibleItems}
                        <div id="${uniqueId}-hidden" class="hidden flex flex-wrap gap-1">
                          ${hiddenItems}
                        </div>
                        <button
                          class="mt-2 w-full text-sm text-orange-600 hover:text-orange-700 font-semibold py-2 px-3 bg-orange-50 hover:bg-orange-100 rounded-lg transition-all flex items-center justify-center gap-2 border border-orange-200"
                          data-toggle-id="${uniqueId}"
                          onclick="toggleParticipantsList(event, '${uniqueId}', ${
                  items.length - maxVisible
                })">
                          <i class="fas fa-chevron-down"></i>
                          <span>ì™¸ ${items.length - maxVisible}ëª… ë”ë³´ê¸°</span>
                        </button>
                      `;
              }
            };

            const namesList =
              (r.reservations || []).length > 0
                ? `<div class="mt-2 text-xs text-gray-600">
                          <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-xs">ì°¸ê°€ì (${
                              (r.reservations || []).length
                            }ëª…)</span>
                            ${
                              isFullAdmin()
                                ? `<button
                                    type="button"
                                    class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors"
                                    onclick="toggleRestaurantParticipantsPublicVisibility('${
                                      ev.id
                                    }', '${r.id}', 'reservations')"
                                    id="toggle-restaurant-participants-public-${
                                      ev.id
                                    }-${r.id}"
                                  >
                                    <i class="fas ${
                                      ev.participantsVisibleToAll
                                        ? "fa-user-lock"
                                        : "fa-users"
                                    } mr-1"></i>${
                                    ev.participantsVisibleToAll
                                      ? "íšŒì¥ë‹¨ë§Œ ë³´ì´ê¸°"
                                      : "ëª¨ë‘ì—ê²Œ ë³´ì´ê¸°"
                                  }
                                  </button>`
                                : ""
                            }
                          </div>
                          ${
                            isFullAdmin() && ev.participantsVisibleToAll
                              ? `
                          <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-3">
                              <div class="bg-orange-500 h-3 rounded-full transition-all duration-300" style="width:${
                                cap
                                  ? Math.min(100, Math.round((cnt / cap) * 100))
                                  : 0
                              }%"></div>
                            </div>
                            <p class="text-right text-[11px] mt-0.5 text-gray-600">ì‹ ì²­: ${cnt} / ${cap} ëª…</p>
                          </div>
                          `
                              : ""
                          }
                          ${
                            ev.participantsVisibleToAll || isFullAdmin()
                              ? `<div class="flex flex-wrap gap-1 mt-2">
                                  ${createRestaurantParticipantsList(
                                    r.reservations || [],
                                    "bg-orange-100",
                                    "text-orange-800",
                                    r.id,
                                    "reservations"
                                  )}
                                </div>`
                              : ""
                          }
                        </div>`
                : "";
            const waitingList =
              (r.waiting || []).length > 0
                ? `<div class="mt-2 text-xs text-gray-600">
                          <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-xs">ëŒ€ê¸°ì (${
                              (r.waiting || []).length
                            }ëª…)</span>
                            ${
                              isFullAdmin()
                                ? `<button
                                    type="button"
                                    class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 transition-colors"
                                    onclick="toggleRestaurantParticipantsPublicVisibility('${
                                      ev.id
                                    }', '${r.id}', 'waiting')"
                                    id="toggle-restaurant-waiting-public-${
                                      ev.id
                                    }-${r.id}"
                                  >
                                    <i class="fas ${
                                      ev.waitingVisibleToAll
                                        ? "fa-user-lock"
                                        : "fa-users"
                                    } mr-1"></i>${
                                    ev.waitingVisibleToAll
                                      ? "íšŒì¥ë‹¨ë§Œ ë³´ì´ê¸°"
                                      : "ëª¨ë‘ì—ê²Œ ë³´ì´ê¸°"
                                  }
                                  </button>`
                                : ""
                            }
                          </div>
                          ${
                            ev.waitingVisibleToAll || isFullAdmin()
                              ? `<div class="flex flex-wrap gap-1 mt-2">
                                  ${createRestaurantParticipantsList(
                                    r.waiting || [],
                                    "bg-orange-200",
                                    "text-orange-900",
                                    r.id,
                                    "waiting"
                                  )}
                                </div>`
                              : ""
                          }
                        </div>`
                : "";
            return `
                    <div class="restaurant-card w-full bg-gradient-to-r from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-3xl shadow-sm hover:shadow-lg transition-all duration-300 p-5 space-y-4">
                      <div class="flex flex-col gap-5">
                        ${
                          r.imageUrl
                            ? `<div class="w-full">
                                <img src="${saf(r.imageUrl)}" alt="${saf(
                                r.name
                              )}" class="w-full h-40 object-cover rounded-2xl border border-orange-100" onerror="this.style.display='none'">
                              </div>`
                            : ""
                        }
                        <div class="flex flex-col gap-3">
                          <div class="space-y-2">
                            <div class="flex items-center gap-2 flex-wrap">
                              <h4 class="font-bold text-lg ${
                                cnt >= cap && cap > 0
                                  ? "text-gray-400 line-through decoration-2 decoration-red-400"
                                  : "text-gray-900"
                              } flex items-center gap-2">${saf(r.name)}
                              ${
                                isNearlyFull && cnt < cap
                                  ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 text-[11px] font-semibold rounded-full bg-red-500/10 text-red-600 border border-red-200">
                                      <i class="fas fa-fire text-red-500"></i>ë§ˆê° ì„ë°•!
                                    </span>`
                                  : ""
                              }
                              </h4>
                              ${
                                cnt >= cap && cap > 0
                                  ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 text-red-600 text-[11px] font-semibold">
                                      <i class="fas fa-ban text-xs"></i>ë§ˆê°
                                    </span>`
                                  : ""
                              }
                            </div>
                            <p class="text-sm mt-1 ${
                              cnt >= cap && cap > 0
                                ? "text-gray-400 line-through decoration-2 decoration-red-300"
                                : "text-gray-600"
                            }">${saf(
              r.info || "ì„¸ë¶€ ì •ë³´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤."
            )}</p>
                            <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                              <span class="px-2 py-1 rounded-full bg-orange-50 border border-orange-200 font-semibold text-gray-800">
                                ì •ì› ${cnt}/${cap}
                              </span>
                              ${
                                currentUser &&
                                adminList.includes(currentUser.studentId)
                                  ? `<span class="px-2 py-1 rounded-full bg-slate-50 border border-slate-200">
                                      ì˜ˆì•½ ${cnt} Â· ëŒ€ê¸° ${
                                      (r.waiting || []).length
                                    }
                                    </span>`
                                  : ""
                              }
                            </div>
                          </div>
                          ${
                            currentUser
                              ? `
                            ${namesList}
                            ${waitingList}
                          `
                              : ""
                          }
                        </div>
                        <div class="flex flex-col gap-2">
                          ${btn}
                          ${getCancelNotice()}
                        </div>
                      </div>
                    </div>`;
          })
          .join("");
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // ì´ë²¤íŠ¸ íƒ€ì…ë³„ ì´ëª¨ì§€
        const typeIcon = "ğŸ½ï¸"; // ë¯¸ì‹íšŒëŠ” í•­ìƒ ğŸ½ï¸

        return `<div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 group" data-event-id="${
          ev.id
        }" style="position: relative; z-index: 1;">
                        <div class="p-4 sm:p-6">
                          <div class="mb-3 sm:mb-4">
                            <div class="flex items-start justify-between mb-3">
                              <div class="flex-1">
                                <div class="mb-2">
                                  <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-utensils text-orange-600 text-sm"></i>
                                    <span class="text-xs sm:text-sm font-semibold text-orange-700 uppercase tracking-wide">ë¯¸ì‹íšŒ ì •ë³´</span>
                                  </div>
                                  <div class="flex items-center gap-2 flex-wrap">
                                    <span class="text-3xl sm:text-4xl">${typeIcon}</span>
                                    <h3 class="text-2xl sm:text-3xl font-bold text-gray-800">
                                      ${saf(ev.title)}
                                    </h3>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="mt-3 space-y-2">
                              <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl p-3 sm:p-4 border-2 border-orange-200 shadow-sm">
                                <div class="flex items-center gap-2 mb-1">
                                  <i class="fas fa-calendar-check text-orange-600 text-base"></i>
                                  <span class="text-sm font-bold text-gray-900">ì´ë²¤íŠ¸ ì‹¤ì‹œì¼</span>
                                </div>
                                <p class="text-base text-gray-800 ml-6">${
                                  ev.datetime
                                    ? new Date(ev.datetime).toLocaleString(
                                        "ko-KR",
                                        {
                                          year: "numeric",
                                          month: "long",
                                          day: "numeric",
                                          hour: "2-digit",
                                          minute: "2-digit",
                                        }
                                      )
                                    : "-"
                                }</p>
                              </div>
                              <div class="bg-gradient-to-r from-red-50 to-pink-50 rounded-xl p-3 sm:p-4 border-2 border-red-200 shadow-sm">
                                <div class="flex items-center gap-2 mb-1">
                                  <i class="fas fa-clock text-red-600 text-base"></i>
                                  <span class="text-sm font-bold text-gray-900">ì‹ ì²­ ë§ˆê°ì¼</span>
                                </div>
                                <p class="text-base text-gray-800 ml-6">${
                                  ev.deadline
                                    ? new Date(ev.deadline).toLocaleString(
                                        "ko-KR",
                                        {
                                          year: "numeric",
                                          month: "long",
                                          day: "numeric",
                                          hour: "2-digit",
                                          minute: "2-digit",
                                        }
                                      )
                                    : "ë¯¸ì„¤ì •"
                                }</p>
                              </div>
                            </div>
                        ${adminStatsHTML(ev)}
                          </div>

                          <div class="pt-4">
                            <div class="flex flex-col gap-4 w-full">${list}</div>

                            <div class="mt-4 pt-3 border-t border-gray-100">
                              <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                <div class="text-xs text-gray-500">
                                  ìƒíƒœ: ${statusLabel(ev.status || "open")}
                                  </div>
                                  ${
                                    ev.status === "archived" && isFullAdmin()
                                      ? '<span class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-800 text-xs font-medium"><i class="fas fa-eye-slash mr-1"></i>ë³´ê´€ (íšŒì¥ë‹¨ë§Œ í‘œì‹œ)</span>'
                                      : ""
                                  }
                        </div>
                        ${adminInline(ev)}
                              </div>
                            </div>
                          </div>
                    </div>
                  </div>`;
      }
      function eventCardHTML(ev) {
        return ev.type === "tasting"
          ? tastingCardHTML(ev)
          : generalCardHTML(ev);
      }

      function adminFullTableHTML(ev) {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin || !(ev.type === "mt" || ev.type === "assembly"))
          return "";
        const header = `<thead class="text-gray-700 table-sticky"><tr>
                  <th class="px-2 py-1 text-left">ì´ë¦„</th><th class="px-2 py-1 text-left">í•™ë²ˆ</th><th class="px-2 py-1 text-left">ì„±ë³„</th>
                  <th class="px-2 py-1 text-left">í•™ë…„</th><th class="px-2 py-1 text-left">ë‹¨ê³¼ëŒ€</th><th class="px-2 py-1 text-left">í•™ê³¼</th><th class="px-2 py-1 text-left">ì „í™”ë²ˆí˜¸</th>
                </tr></thead>`;
        const rows = (ev.applicants || [])
          .slice()
          .sort((a, b) => (a.name || "").localeCompare(b.name || "")) // ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
          .map(
            (m, index) => `<tr class="border-t">
                  <td class="px-2 py-1 max-w-0 truncate" title="${saf(
                    m.name || ""
                  )}">${saf(m.name || "")}</td>
                  <td class="px-2 py-1 font-mono">${saf(m.studentId || "")}</td>
                  <td class="px-2 py-1">${saf(m.gender || "")}</td>
                  <td class="px-2 py-1">${saf(m.year || "")}</td>
                  <td class="px-2 py-1">${saf(m.college || "")}</td>
                  <td class="px-2 py-1">${saf(m.department || "")}</td>
                  <td class="px-2 py-1">${saf(m.phone || "")}</td>
                </tr>`
          )
          .join("");
        const body =
          rows ||
          `<tr><td class="px-2 py-6 text-center text-gray-400" colspan="7">ì‹ ì²­ì ì—†ìŒ</td></tr>`;
        const toolbar = `<div class="flex items-center justify-between mb-2">
                  <div class="text-xs font-semibold text-gray-700">ê´€ë¦¬ì ì „ìš© â€¢ ì°¸ê°€ì ìƒì„¸</div>
                  <button type="button" class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded" data-act="export-xlsx" data-id="${ev.id}">
                    <i class="fas fa-file-excel mr-1"></i>ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ
                  </button>
                </div>`;
        return `<div class="mt-4 border-t pt-3">${toolbar}<div class="overflow-auto max-h-60 border rounded">
                  <table class="min-w-full text-xs">${header}<tbody>${body}</tbody></table></div></div>`;
      }

      function renderReservationTab(isAdmin) {
        const c = document.getElementById("reservation-tab");
        if (!c) return;

        // ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œë”© í‘œì‹œ
        if (eventsData === null || eventsData === undefined) {
          c.innerHTML = `<div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-orange-500 border-t-transparent mb-3"></div>
            <p class="text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>`;
          return;
        }

        // í™œì„± ì´ë²¤íŠ¸ì™€ ë³´ê´€ ì´ë²¤íŠ¸ë¥¼ ë¶„ë¦¬
        const activeEvents = eventsData.filter((e) => {
          if (e.status === "closed") return false;
          if (e.status === "archived") return false;
          if (e.status === "completed") return false;
          if (e.status === "deleted") return false; // ì‚­ì œëœ ì´ë²¤íŠ¸ ì œì™¸
          if (e.status === "cancelled") return false;
          return true;
        });

        const archivedEvents = isAdmin
          ? eventsData.filter((e) => e.status === "archived")
          : [];

        // ë‚´ í™œë™ ë‚´ì—­ ë° í”„ë¡œí•„ ì •ë³´ ì¤€ë¹„
        const isUserParticipating = (ev) => {
          if (!currentUser) return false;
          const sid = currentUser.studentId;
          if (!sid) return false;
          if (ev.applicants?.some((a) => a.studentId === sid)) return true;
          if (ev.waiting?.some?.((a) => a.studentId === sid)) return true;
          if (Array.isArray(ev.restaurants)) {
            return ev.restaurants.some(
              (restaurant) =>
                restaurant.reservations?.some((res) => res.studentId === sid) ||
                restaurant.waiting?.some((res) => res.studentId === sid)
            );
          }
          return false;
        };

        if (!currentUser) {
          myProfileData = null;
          myProfileLoading = false;
        } else {
          if (
            myProfileData &&
            myProfileData.__uid &&
            myProfileData.__uid !== currentUser.studentId
          ) {
            myProfileData = null;
          }
          if (!myProfileData && !myProfileLoading) {
            myProfileLoading = true;
            getCurrentMemberProfile()
              .then((data) => {
                myProfileData = {
                  ...(data || {}),
                  __uid: currentUser.studentId || null,
                };
              })
              .catch((error) =>
                console.warn("í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:", error?.message || error)
              )
              .finally(() => {
                myProfileLoading = false;
                renderReservationTab(isAdmin);
              });
          }
        }

        const myAppliedEvents = currentUser
          ? eventsData.filter(
              (ev) =>
                ev.status !== "deleted" &&
                ev.status !== "cancelled" &&
                isUserParticipating(ev)
            )
          : [];

        const sortedMyEvents = myAppliedEvents
          .slice()
          .sort(
            (a, b) =>
              new Date(
                b.datetime ||
                  b.registrationStart ||
                  b.createdAt ||
                  b.created_at ||
                  b.created ||
                  0
              ).getTime() -
              new Date(
                a.datetime ||
                  a.registrationStart ||
                  a.createdAt ||
                  a.created_at ||
                  a.created ||
                  0
              ).getTime()
          );

        const latestEvent = sortedMyEvents[0] || null;
        const remainingEvents = latestEvent ? sortedMyEvents.slice(1) : [];

        const today = new Date();
        const myUpcomingEvents = currentUser
          ? myAppliedEvents.filter((ev) => {
              if (ev.status === "completed") return false;
              const dt = ev.datetime ? new Date(ev.datetime) : null;
              return dt && dt >= today;
            })
          : [];

        const nextUpcoming = myUpcomingEvents
          .slice()
          .sort(
            (a, b) =>
              new Date(a.datetime || 0).getTime() -
              new Date(b.datetime || 0).getTime()
          )[0];

        const stats = sortedMyEvents.reduce(
          (acc, ev) => {
            if (ev.type === "tasting") acc.tasting += 1;
            else if (ev.type === "mt") acc.mt += 1;
            else if (ev.type === "assembly") acc.assembly += 1;
            else acc.general += 1;

            if (
              (ev.reviews || []).some(
                (r) => r.studentId === (currentUser?.studentId || "")
              )
            ) {
              acc.reviews += 1;
            }
            return acc;
          },
          { tasting: 0, mt: 0, assembly: 0, general: 0, reviews: 0 }
        );
        stats.total = sortedMyEvents.length;
        stats.upcoming = myUpcomingEvents.length;

        const formatDateTime = (value) => {
          if (!value) return "ì¼ì • ë¯¸ì •";
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) return "ì¼ì • ë¯¸ì •";
          const weekday = date.toLocaleDateString("ko-KR", {
            weekday: "short",
          });
          return `${date.toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })} (${weekday}) ${date.toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit",
          })}`;
        };

        const getEventMeta = (type) => {
          switch (type) {
            case "tasting":
              return {
                icon: "ğŸ½ï¸",
                label: "ë¯¸ì‹íšŒ",
                chipClass: "bg-orange-100 text-orange-700",
              };
            case "mt":
              return {
                icon: "ğŸ•ï¸",
                label: "MT",
                chipClass: "bg-emerald-100 text-emerald-700",
              };
            case "assembly":
              return {
                icon: "ğŸ¤",
                label: "ì´íšŒ",
                chipClass: "bg-purple-100 text-purple-700",
              };
            default:
              return {
                icon: "ğŸ“…",
                label: "ì´ë²¤íŠ¸",
                chipClass: "bg-blue-100 text-blue-700",
              };
          }
        };

        const formatPhoneNumber = (value) => {
          if (!value) return "";
          const digits = String(value).replace(/\D/g, "");
          if (digits.length === 10)
            return digits.replace(/(\d{3})(\d{3})(\d{4})/, "$1-$2-$3");
          if (digits.length === 11)
            return digits.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
          return value;
        };

        const formatDisplay = (value) => {
          if (value == null || String(value).trim() === "") {
            return '<span class="text-gray-400">-</span>';
          }
          return saf(String(value));
        };

        const getParticipationDetails = (ev) => {
          if (!currentUser?.studentId) {
            return {
              restaurantName: "",
              companionsLine: "",
              isWaitlisted: false,
              myEntry: null,
              waitPosition: null,
              restaurantInfo: null,
              restaurantId: null,
              applicantCount: (ev.applicants || []).length,
              waitingCount: (ev.waiting || []).length,
            };
          }

          const sid = currentUser.studentId;
          let restaurantName = "";
          let restaurantInfo = null;
          let isWaitlisted = false;
          let waitPosition = null;
          let myEntry = null;
          const companionNames = [];

          if (ev.type === "tasting" && Array.isArray(ev.restaurants)) {
            for (const restaurant of ev.restaurants) {
              const restaurantId =
                restaurant.id ||
                restaurant.rid ||
                restaurant.restaurantId ||
                restaurant.name ||
                "";
              const reservations = restaurant.reservations || [];
              const waitings = restaurant.waiting || [];
              const reservationIndex = reservations.findIndex(
                (res) => res.studentId === sid
              );

              if (reservationIndex >= 0) {
                restaurantName = restaurant.name || "";
                myEntry = reservations[reservationIndex];
                restaurantInfo = {
                  id: restaurantId || null,
                  name: restaurant.name || "",
                  capacity: restaurant.capacity ?? reservations.length,
                  reservations: reservations.length,
                  waiting: waitings.length,
                };
                reservations.forEach((res) => {
                  if (res.studentId !== sid) {
                    companionNames.push(
                      res.name || maskStudentIdGlobal(res.studentId)
                    );
                  }
                });
                break;
              }

              const waitingIndex = waitings.findIndex(
                (res) => res.studentId === sid
              );
              if (waitingIndex >= 0) {
                restaurantName = restaurant.name || "";
                isWaitlisted = true;
                waitPosition = waitingIndex + 1;
                myEntry = waitings[waitingIndex];
                restaurantInfo = {
                  id: restaurantId || null,
                  name: restaurant.name || "",
                  capacity: restaurant.capacity ?? reservations.length,
                  reservations: reservations.length,
                  waiting: waitings.length,
                };
                waitings.forEach((res) => {
                  if (res.studentId !== sid) {
                    companionNames.push(
                      res.name || maskStudentIdGlobal(res.studentId)
                    );
                  }
                });
                break;
              }
            }
          } else {
            const applicants = ev.applicants || [];
            const waiting = ev.waiting || [];
            const applicantIndex = applicants.findIndex(
              (applicant) => applicant.studentId === sid
            );
            const waitingIndex = waiting.findIndex(
              (applicant) => applicant.studentId === sid
            );

            if (applicantIndex >= 0) {
              myEntry = applicants[applicantIndex];
              applicants.forEach((applicant, index) => {
                if (applicant.studentId !== sid) {
                  companionNames.push(
                    applicant.name || maskStudentIdGlobal(applicant.studentId)
                  );
                }
              });
            } else if (waitingIndex >= 0) {
              myEntry = waiting[waitingIndex];
              isWaitlisted = true;
              waitPosition = waitingIndex + 1;
              waiting.forEach((applicant) => {
                if (applicant.studentId !== sid) {
                  companionNames.push(
                    applicant.name || maskStudentIdGlobal(applicant.studentId)
                  );
                }
              });
            } else {
              applicants.forEach((applicant) => {
                companionNames.push(
                  applicant.name || maskStudentIdGlobal(applicant.studentId)
                );
              });
            }
          }

          let companionsLine = "";
          if (companionNames.length > 0) {
            const uniqueNames = [
              ...new Set(companionNames.filter((name) => !!name)),
            ].map((name) => saf(name));
            const displayNames = uniqueNames.slice(0, 3).join(", ");
            const extraCount =
              uniqueNames.length > 3 ? ` ì™¸ ${uniqueNames.length - 3}ëª…` : "";
            companionsLine = `í•¨ê»˜í•œ íšŒì›: ${displayNames}${extraCount}`;
          } else if (isWaitlisted) {
            companionsLine = "ëŒ€ê¸° ëª©ë¡ì— ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.";
          }

          return {
            restaurantName,
            companionsLine,
            isWaitlisted,
            myEntry,
            waitPosition,
            restaurantInfo,
            restaurantId: restaurantInfo?.id || null,
            applicantCount: (ev.applicants || []).length,
            waitingCount: (ev.waiting || []).length,
          };
        };
        window.getParticipationDetails = getParticipationDetails;

        const renderRatingStars = (rating) => {
          if (rating == null || Number.isNaN(Number(rating))) return "";
          const rounded = Math.round(Number(rating));
          return `
                  <div class="flex items-center gap-0.5" aria-label="ë³„ì  ${Number(
                    rating
                  ).toFixed(1)}ì ">
                    ${[1, 2, 3, 4, 5]
                      .map(
                        (star) =>
                          `<i class="fas fa-star ${
                            star <= rounded
                              ? "text-yellow-400"
                              : "text-gray-300"
                          }"></i>`
                      )
                      .join("")}
                    <span class="text-xs text-gray-600 ml-1">${Number(
                      rating
                    ).toFixed(1)}</span>
                  </div>
                `;
        };

        const renderMyEventCard = (ev, { featured = false } = {}) => {
          const meta = getEventMeta(ev.type);
          const participation = getParticipationDetails(ev);
          const myEntry = participation.myEntry;
          const reviewEntry = (ev.reviews || []).find(
            (r) => r.studentId === (currentUser?.studentId || "")
          );
          const eventDate = ev.datetime ? new Date(ev.datetime) : null;
          const primaryTitle =
            participation.restaurantName || ev.title || "ë¬´ì œ";
          const subtitleTitle =
            (!participation.restaurantName || ev.type !== "tasting") && ev.title
              ? ev.title
              : "";

          let statusLabel = "";
          let statusClass = "";
          const now = new Date();
          if (participation.isWaitlisted) {
            statusLabel = "ëŒ€ê¸°ì¤‘";
            statusClass = "bg-yellow-100 text-yellow-700";
          } else if (ev.status === "cancelled") {
            statusLabel = "ì·¨ì†Œë¨";
            statusClass = "bg-red-100 text-red-700";
          } else if (ev.status === "completed") {
            statusLabel = "ì™„ë£Œ";
            statusClass = "bg-slate-200 text-slate-700";
          } else if (ev.status === "archived" || ev.status === "closed") {
            statusLabel = "ë§ˆê°";
            statusClass = "bg-gray-200 text-gray-700";
          } else if (eventDate && eventDate >= now) {
            statusLabel = "ì˜ˆì •";
            statusClass = "bg-emerald-100 text-emerald-700";
          } else {
            statusLabel = "ì§„í–‰ì¤‘";
            statusClass = "bg-blue-100 text-blue-700";
          }

          const detailItems = [];
          detailItems.push({
            icon: "fa-calendar-alt",
            label: "ì´ë²¤íŠ¸ ë‚ ì§œ",
            value: formatDateTime(ev.datetime),
            fullWidth: true,
          });
          if (participation.waitPosition) {
            detailItems.push({
              icon: "fa-clock-rotate-left",
              label: "ëŒ€ê¸° ìˆœë²ˆ",
              value: `${participation.waitPosition}ë²ˆ`,
            });
          }
          if (
            (ev.type === "mt" || ev.type === "assembly") &&
            ev.payment &&
            (ev.payment.amount || ev.payment.bank || ev.payment.number)
          ) {
            const amountText = ev.payment.amount
              ? `${Number(ev.payment.amount).toLocaleString("ko-KR")}ì›`
              : "ë¯¸ì •";
            const accountText =
              ev.payment.bank && ev.payment.number
                ? `${saf(ev.payment.bank)} ${saf(ev.payment.number)}${
                    ev.payment.holder
                      ? ` (ì˜ˆê¸ˆì£¼: ${saf(ev.payment.holder)})`
                      : ""
                  }`
                : "ë¯¸ë“±ë¡";

            detailItems.push({
              icon: "fa-wallet",
              label: "íšŒë¹„ ê¸ˆì•¡",
              value: amountText,
            });
            detailItems.push({
              icon: "fa-university",
              label: "ì…ê¸ˆ ê³„ì¢Œ",
              value: accountText,
            });
          }

          const detailGridHTML = detailItems.length
            ? `<div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-gray-600 w-full">
                      ${detailItems
                        .map((item) => {
                          const spanClass = item.fullWidth
                            ? "sm:col-span-2"
                            : "";
                          return `
                        <div class="${spanClass} flex items-start gap-2 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 w-full">
                          <i class="fas ${item.icon} text-slate-500 mt-0.5"></i>
                          <div class="flex-1">
                            <div class="text-[11px] text-slate-500">${item.label}</div>
                            <div class="font-semibold text-slate-800 leading-snug">${item.value}</div>
                          </div>
                        </div>`;
                        })
                        .join("")}
                    </div>`
            : "";

          const containerClass = featured
            ? "rounded-3xl border-2 border-blue-100 bg-white shadow-lg p-5 space-y-3"
            : "rounded-2xl border border-gray-200 bg-white shadow-sm p-4 space-y-3";

          const reviewButtonHTML =
            ev.type === "mt" || ev.type === "assembly"
              ? ""
              : `<button type="button" class="px-3 py-2 text-xs rounded-lg ${
                  reviewEntry
                    ? "bg-stone-200 text-stone-700 hover:bg-stone-300"
                    : "bg-orange-500 text-white hover:bg-orange-600"
                } transition-colors" data-act="write-review" data-id="${ev.id}">
                        <i class="fas ${
                          reviewEntry ? "fa-edit" : "fa-pen-to-square"
                        } mr-1"></i>${reviewEntry ? "í›„ê¸° ìˆ˜ì •" : "í›„ê¸° ì‘ì„±"}
                      </button>`;

          const detailButtonHTML = `<button type="button" class="px-3 py-2 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" onclick="showEventDetailModal('${ev.id}')">
                    <i class="fas fa-info-circle mr-1"></i>ìƒì„¸ ë³´ê¸°
                  </button>`;

          const statusChipsHTML = `
                  <div class="flex flex-wrap items-center gap-2">
                    <span class="text-[11px] font-semibold px-2 py-0.5 rounded-full ${
                      meta.chipClass
                    }">
                      ${meta.label}
                    </span>
                    ${
                      statusLabel
                        ? `<span class="text-[11px] font-semibold px-2 py-0.5 rounded-full ${statusClass}">
                            ${statusLabel}
                          </span>`
                        : ""
                    }
                    ${
                      reviewEntry
                        ? '<span class="text-[11px] font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 flex items-center gap-1"><i class="fas fa-star text-yellow-500"></i>ì‘ì„±</span>'
                        : '<span class="text-[11px] font-semibold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 flex items-center gap-1"><i class="fas fa-star"></i>ë¯¸ì‘ì„±</span>'
                    }
                  </div>
                `;

          return `
                  <div class="${containerClass}">
                    <div class="flex flex-col gap-2">
                      <div class="flex items-center gap-3">
                        <div class="w-11 h-11 rounded-2xl bg-orange-100 flex items-center justify-center text-2xl flex-shrink-0">
                          ${meta.icon}
                        </div>
                        <div class="flex-1 min-w-0">
                          <h5 class="text-base font-bold text-gray-900 leading-tight truncate">
                            ${saf(primaryTitle)}
                          </h5>
                          ${
                            subtitleTitle
                              ? `<p class="text-xs text-gray-500 truncate mt-0.5">${saf(
                                  subtitleTitle
                                )}</p>`
                              : ""
                          }
                        </div>
                      </div>
                      ${statusChipsHTML}
                      ${detailGridHTML}
                      <div class="flex flex-wrap items-center justify-end gap-2 pt-1">
                        ${detailButtonHTML}
                        ${reviewButtonHTML}
                      </div>
                    </div>
                  </div>
                `;
        };

        const profile = myProfileData || {};
        const quickProfileImage =
          (currentUser && currentUser.kakaoProfileImage) ||
          profile.kakaoProfileImage ||
          null;
        const membershipStatusMap = {
          active: "í™œë™ì¤‘",
          pending: "ìŠ¹ì¸ ëŒ€ê¸°",
          blocked: "ì œí•œ",
          rejected: "ë°˜ë ¤",
          inactive: "íœ´ë©´",
        };
        const membershipStatus = currentUser
          ? membershipStatusMap[currentUser.status] || "ë“±ë¡ë¨"
          : "";

        const profileItems = currentUser
          ? [
              { label: "ì´ë¦„", value: currentUser.name },
              { label: "í•™ë²ˆ", value: currentUser.studentId },
              { label: "ë‹¨ê³¼ëŒ€", value: profile.college },
              { label: "í•™ê³¼", value: profile.department },
              {
                label: "í•™ë…„",
                value: profile.year ? `${profile.year}í•™ë…„` : "",
              },
              {
                label: "ì—°ë½ì²˜",
                value: profile.phone
                  ? formatPhoneNumber(profile.phone)
                  : profile.contact
                  ? profile.contact
                  : "",
              },
              { label: "ì§ì±…", value: currentUser.position || "ì¼ë°˜ íšŒì›" },
              { label: "ìƒíƒœ", value: membershipStatus },
            ]
          : [];

        const profileGridHTML = profileItems
          .map(
            (item) => `
                  <div class="rounded-2xl border border-orange-100 bg-white px-4 py-3">
                    <div class="text-[11px] text-gray-500">${item.label}</div>
                    <div class="text-sm font-semibold text-gray-900">${formatDisplay(
                      item.value
                    )}</div>
                  </div>
                `
          )
          .join("");

        const statsHTML = currentUser
          ? `
                <div class="grid grid-cols-2 gap-3">
                  <div class="rounded-xl border border-orange-100 bg-orange-50/80 px-3 py-2 text-center">
                    <div class="text-[11px] text-gray-500">ì´ ì°¸ì—¬</div>
                    <div class="text-lg font-bold text-orange-600">${stats.total}</div>
                  </div>
                  <div class="rounded-xl border border-orange-100 bg-orange-50/80 px-3 py-2 text-center">
                    <div class="text-[11px] text-gray-500">ë¯¸ì‹íšŒ</div>
                    <div class="text-lg font-semibold text-orange-600">${stats.tasting}</div>
                  </div>
                  <div class="rounded-xl border border-emerald-100 bg-emerald-50/80 px-3 py-2 text-center">
                    <div class="text-[11px] text-gray-500">ì˜ˆì •ëœ í™œë™</div>
                    <div class="text-lg font-semibold text-emerald-600">${stats.upcoming}</div>
                  </div>
                  <div class="rounded-xl border border-yellow-100 bg-yellow-50/80 px-3 py-2 text-center">
                    <div class="text-[11px] text-gray-500">ì‘ì„±í•œ í›„ê¸°</div>
                    <div class="text-lg font-semibold text-yellow-600">${stats.reviews}</div>
                  </div>
                </div>
              `
          : "";

        const nextUpcomingHTML = nextUpcoming
          ? `
                <div class="mt-4 bg-orange-50 border border-orange-100 rounded-xl px-3 py-2 text-xs text-gray-700">
                  <div class="flex items-center justify-between gap-2">
                    <div class="font-semibold text-gray-800 truncate">
                      ${saf(nextUpcoming.title || "ì˜ˆì •ëœ í™œë™")}
                    </div>
                    <span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 font-semibold text-[11px]">ì˜ˆì •</span>
                  </div>
                  <div class="mt-1 flex items-center gap-1 text-[11px] text-gray-500">
                    <i class="fas fa-clock text-orange-500"></i>${formatDateTime(
                      nextUpcoming.datetime
                    )}
                  </div>
                </div>
              `
          : latestEvent
          ? `
                <div class="mt-4 rounded-xl border border-blue-100 bg-blue-50/70 px-3 py-2 text-xs text-gray-600">
                  <div class="font-semibold text-gray-800 truncate">
                    ìµœê·¼ í™œë™: ${saf(latestEvent.title || "í™œë™")}
                  </div>
                  <div class="flex items-center gap-1 text-[11px]	text-gray-500 mt-1">
                    <i class="fas fa-flag-checkered text-blue-500"></i>${formatDateTime(
                      latestEvent.datetime
                    )}
                  </div>
                                        </div>
                                        `
          : `
                <div class="mt-4 rounded-xl border border-dashed border-orange-200 bg-orange-50/70 px-3 py-4 text-xs text-orange-600 text-center">
                  ì•„ì§ ì‹ ì²­í•œ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
              `;

        const myProfileHTML = "";

        const latestEventHTML = latestEvent
          ? renderMyEventCard(latestEvent, { featured: true })
          : `
                <div class="rounded-2xl border border-dashed border-blue-200 bg-blue-50/70 text-center text-sm text-blue-600 py-6">
                  ì•„ì§ ì‹ ì²­í•œ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤. ì´ë²¤íŠ¸ë¥¼ ì‹ ì²­í•´ë³´ì„¸ìš”!
                </div>
              `;

        const remainingEventsSection =
          remainingEvents.length > 0
            ? `
                <div class="rounded-2xl bg-white border border-blue-100">
                  <button
                    type="button"
                    id="my-history-toggle"
                    class="w-full px-5 py-3 flex items-center justify-between text-sm font-semibold text-blue-800 hover:bg-blue-50 transition-colors"
                    aria-expanded="false"
                  >
                    <span class="toggle-label">ì§€ë‚œ í™œë™ ${
                      remainingEvents.length
                    }ê±´ í¼ì¹˜ê¸°</span>
                    <i class="fas fa-chevron-down transition-transform" id="my-history-toggle-icon"></i>
                                          </button>
                  <div id="my-history-content" class="hidden border-t border-blue-100 px-5 pb-5">
                    <div class="space-y-3 pt-4">
                      ${remainingEvents
                        .map((ev) => renderMyEventCard(ev))
                        .join("")}
                    </div>
                  </div>
                                        </div>
                                        `
            : "";

        const myHistoryHTML = currentUser
          ? `
              <section id="my-activity-section" class="section mt-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                  <div>
                    <h3 class="text-xl font-extrabold text-blue-900 flex items-center gap-2">
                      <i class="fas fa-circle-user text-blue-600"></i>ìµœê·¼ ì‹ ì²­í•œ í™œë™
                    </h3>
                  </div>
                  <div class="flex items-center gap-2 text-xs text-blue-700 flex-wrap">
                    <span class="px-2 py-1 bg-blue-50 rounded-full border border-blue-200 font-semibold">
                      ì´ ${sortedMyEvents.length}ê±´
                    </span>
                    ${
                      stats.tasting
                        ? `<span class="px-2 py-1 bg-orange-50 rounded-full border border-orange-200 text-orange-600 font-semibold">ë¯¸ì‹íšŒ ${stats.tasting}</span>`
                        : ""
                    }
                    ${
                      stats.reviews
                        ? `<span class="px-2 py-1 bg-yellow-50 rounded-full border border-yellow-200 text-yellow-600 font-semibold"><i class="fas fa-star text-yellow-500 mr-1"></i>í›„ê¸° ${stats.reviews}</span>`
                        : ""
                    }
                  </div>
                </div>
                <div class="mt-4 space-y-4">
                  ${latestEventHTML}
                  ${remainingEventsSection}
                </div>
              </section>
              `
          : "";

        const quickEventSummaryHTML = latestEvent
          ? (() => {
              const meta = getEventMeta(latestEvent.type);
              const participation = getParticipationDetails(latestEvent);
              return `
                      <div class="rounded-2xl border border-blue-100 bg-blue-50/70 px-3 py-3 space-y-2">
                        <div class="flex items-center justify-center gap-2">
                          <div class="font-semibold text-gray-800 truncate">
                            ë‹¤ìŒì¼ì • Â· ${saf(
                              latestEvent.title || "ìµœê·¼ ì‹ ì²­í•œ í™œë™"
                            )}${
                participation.restaurantName
                  ? ` - ${saf(participation.restaurantName)}`
                  : ""
              }
                          <span class="text-[11px] font-semibold px-2 py-0.5 rounded-full ${
                            meta.chipClass
                          }">
                            ${meta.label}
                          </span>
                        </div>
                        <div class="flex flex-wrap items-center justify-center gap-2 text-[11px] text-gray-600">
                          <span><i class="fas fa-calendar-day text-blue-500 mr-1"></i>${formatDateTime(
                            latestEvent.datetime
                          )}</span>
                          ${
                            participation.isWaitlisted
                              ? '<span class="px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 font-semibold">ëŒ€ê¸°ì¤‘</span>'
                              : '<span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 font-semibold">ì‹ ì²­ì™„ë£Œ</span>'
                          }
                        </div>
                        ${
                          participation.companionsLine
                            ? `<p class="text-[11px] text-gray-500 leading-relaxed text-center">${participation.companionsLine}</p>`
                            : ""
                        }
                                      </div>
                                    `;
            })()
          : `
                  <div class="rounded-2xl border border-dashed border-orange-200 bg-orange-50/60 px-3 py-4 text-xs text-orange-600 text-center">
                    ì•„ì§ ì‹ ì²­í•œ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤. ë¯¸ì‹íšŒì™€ ì´ë²¤íŠ¸ë¥¼ ì‹ ì²­í•´ë³´ì„¸ìš”!
                  </div>
                `;

        // ì¹´ì¹´ì˜¤ ì—°ë™ ìƒíƒœ í™•ì¸ (Firebaseì—ì„œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸°)
        // ë¹„ë™ê¸°ë¡œ Firebaseì—ì„œ ìµœì‹  ì¹´ì¹´ì˜¤ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ í™•ì¸
        let hasKakaoAccount = false;
        let kakaoUserId = null;

        // Firebaseì—ì„œ ìµœì‹  ì¹´ì¹´ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        if (currentUser?.studentId) {
          // Firebaseì—ì„œ ìµœì‹  ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” Promise
          const getKakaoInfoFromFirebase = async () => {
            // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ (ì „ì—­ í”Œë˜ê·¸ ì‚¬ìš©)
            if (firebaseKakaoInfoLoadedForUser === currentUser.studentId)
              return;

            try {
              const { doc, getDoc } = await import(
                "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
              );
              const { db } = await import("./js/firebase.js");
              const memberRef = doc(db, "members", currentUser.studentId);
              const memberSnap = await getDoc(memberRef);

              if (memberSnap.exists()) {
                const memberData = memberSnap.data();
                const firebaseKakaoUserId = memberData.kakaoUserId;

                // ìˆ«ìì™€ ë¬¸ìì—´ ëª¨ë‘ í™•ì¸
                if (
                  firebaseKakaoUserId !== null &&
                  firebaseKakaoUserId !== undefined &&
                  firebaseKakaoUserId !== "" &&
                  firebaseKakaoUserId !== 0
                ) {
                  kakaoUserId = firebaseKakaoUserId;
                  hasKakaoAccount = true;

                  // currentUserë„ ì—…ë°ì´íŠ¸
                  if (currentUser) {
                    currentUser.kakaoUserId =
                      typeof firebaseKakaoUserId === "number"
                        ? String(firebaseKakaoUserId)
                        : firebaseKakaoUserId;
                  }

                  // DEBUG_MODEì¼ ë•Œë§Œ ë¡œê·¸ ì¶œë ¥
                  if (DEBUG_MODE) {
                    console.log(
                      "[ë‚´ í™œë™ íŒì˜¤ë²„] Firebaseì—ì„œ ì¹´ì¹´ì˜¤ ì •ë³´ ê°€ì ¸ì˜´:",
                      {
                        kakaoUserId,
                        hasKakaoAccount,
                      }
                    );
                  }

                  firebaseKakaoInfoLoadedForUser = currentUser.studentId;
                  // HTML ë‹¤ì‹œ ìƒì„± ë° ì—…ë°ì´íŠ¸
                  generateAndUpdateQuickSummary();
                } else {
                  firebaseKakaoInfoLoadedForUser = currentUser.studentId;
                  if (DEBUG_MODE) {
                    console.log(
                      "[ë‚´ í™œë™ íŒì˜¤ë²„] Firebaseì—ì„œ ì¹´ì¹´ì˜¤ ì •ë³´ ì—†ìŒ"
                    );
                  }
                }
              } else {
                firebaseKakaoInfoLoadedForUser = currentUser.studentId;
              }
            } catch (error) {
              firebaseKakaoInfoLoadedForUser = currentUser.studentId;
              if (DEBUG_MODE) {
                console.error(
                  "[ë‚´ í™œë™ íŒì˜¤ë²„] Firebaseì—ì„œ ì¹´ì¹´ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:",
                  error
                );
              }
              // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
              checkKakaoFromStateOrCurrentUser();
            }
          };

          // ê¸°ì¡´ stateë‚˜ currentUserì—ì„œ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
          const checkKakaoFromStateOrCurrentUser = () => {
            const stateUser =
              typeof window !== "undefined" && window.state?.currentUser
                ? window.state.currentUser
                : null;
            const userForKakaoCheck = stateUser || currentUser;
            kakaoUserId = userForKakaoCheck?.kakaoUserId;
            hasKakaoAccount =
              kakaoUserId !== undefined &&
              kakaoUserId !== null &&
              kakaoUserId !== "" &&
              kakaoUserId !== 0 &&
              !(typeof kakaoUserId === "string" && kakaoUserId.trim() === "");
          };

          // quickSummaryHTMLì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
          const generateAndUpdateQuickSummary = () => {
            checkKakaoFromStateOrCurrentUser(); // ë¨¼ì € stateë‚˜ currentUserì—ì„œ í™•ì¸

            // DEBUG_MODEì¼ ë•Œë§Œ ë¡œê·¸ ì¶œë ¥
            if (DEBUG_MODE) {
              console.log("[ë‚´ í™œë™ íŒì˜¤ë²„] ì¹´ì¹´ì˜¤ ì—°ë™ ìƒíƒœ í™•ì¸:", {
                studentId: currentUser?.studentId,
                kakaoUserId,
                hasKakaoAccount,
                state_currentUser:
                  typeof window !== "undefined" && window.state?.currentUser
                    ? window.state.currentUser?.kakaoUserId
                    : "state ì—†ìŒ",
                currentUser_kakaoUserId: currentUser?.kakaoUserId,
              });
            }

            // quickSummaryHTML ìƒì„± (ê¸°ì¡´ ì½”ë“œ)
            const quickSummaryHTML = currentUser
              ? generateQuickSummaryHTML()
              : `<div class="text-center text-gray-500 text-sm py-3">
                        ë¡œê·¸ì¸ í›„ ë‚´ í™œë™ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                      </div>`;

            updateMyPageQuickSummary(quickSummaryHTML);
          };

          // quickSummaryHTML ìƒì„± í•¨ìˆ˜ ë¶„ë¦¬
          const generateQuickSummaryHTML = () => {
            return `
                <div class="space-y-3 text-sm text-center">
                  <div class="rounded-2xl border border-orange-100 bg-white px-4 py-3 shadow-sm">
                    <div class="flex flex-col items-center gap-2">
                      <div class="flex flex-wrap items-center justify-center gap-2">
                        ${
                          quickProfileImage
                            ? `<span class="w-7 h-7 rounded-full bg-gradient-to-br from-orange-400 to-yellow-400 flex items-center justify-center text-white text-xs font-bold overflow-hidden">
                                 <img src="${quickProfileImage}" alt="í”„ë¡œí•„" class="w-full h-full object-cover" />
                               </span>`
                            : `<span class="w-7 h-7 rounded-full bg-gradient-to-br from-orange-400 to-yellow-400 flex items-center justify-center text-white text-xs font-bold">
                                 ${saf(
                                   currentUser.name
                                     ? currentUser.name?.charAt(0)
                                     : "U"
                                 )}
                               </span>`
                        }
                        <span class="font-semibold text-gray-900">${saf(
                          currentUser.name || ""
                        )}</span>
                        <span class="text-[11px] px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 font-semibold">
                          ${saf(currentUser.position || "ì¼ë°˜ íšŒì›")}
                        </span>
                        ${
                          hasKakaoAccount
                            ? `<span class="text-[11px] px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 font-semibold flex items-center gap-1">
                                <i class="fas fa-check-circle text-yellow-600"></i>ì¹´ì¹´ì˜¤ ì—°ë™
                              </span>`
                            : ""
                        }
                      </div>
                      <p class="text-xs text-gray-500">
                        ${saf(currentUser.studentId || "-")}${
              profile.department ? ` Â· ${saf(profile.department)}` : ""
            }
                      </p>
                    </div>
                    ${
                      !hasKakaoAccount
                        ? `<div class="mt-3 pt-3 border-t border-orange-100">
                            <button
                              id="quick-kakao-link-btn"
                              type="button"
                              class="w-full px-3 py-2 bg-[#FEE500] hover:bg-[#FDD835] text-gray-900 rounded-lg font-semibold transition-all duration-200 flex items-center justify-center text-xs shadow-sm hover:shadow-md"
                            >
                              <svg
                                class="w-4 h-4 mr-2"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                              >
                                <path
                                  d="M12 3c5.799 0 10.5 3.664 10.5 8.185 0 4.52-4.701 8.184-10.5 8.184a13.5 13.5 0 0 1-1.727-.11l-4.408 2.883c-.501.265-.678.236-.472-.413l.892-3.678c-2.88-1.46-4.785-3.99-4.785-6.866C1.5 6.665 6.201 3 12 3z"
                                />
                              </svg>
                              ì¹´ì¹´ì˜¤ ê³„ì • ì—°ë™í•˜ê¸°
                            </button>
                          </div>`
                        : `<div class="mt-3 pt-3 border-t border-orange-100">
                            <button
                              id="quick-kakao-unlink-btn"
                              type="button"
                              class="w-full px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-all duration-200 flex items-center justify-center text-xs shadow-sm hover:shadow-md"
                            >
                              <i class="fas fa-unlink mr-2"></i>
                              ì¹´ì¹´ì˜¤ ê³„ì • ì—°ë™ í•´ì§€í•˜ê¸°
                            </button>
                          </div>`
                    }
                    <div class="flex flex-wrap items-center justify-center gap-2 text-[11px] text-gray-600 mt-2">
                      <span class="px-2 py-1 bg-orange-50 rounded-full border border-orange-200 font-semibold">
                        ì´ ${stats.total}íšŒ ì°¸ì—¬
                      </span>
                      <span><i class="fas fa-calendar-check mr-1 text-emerald-500"></i>ì˜ˆì • ${
                        stats.upcoming
                      }</span>
                      <span><i class="fas fa-star mr-1 text-yellow-500"></i>í›„ê¸° ${
                        stats.reviews
                      }</span>
                    </div>
                    ${""}
                  </div>
                </div>
              `;
          };

          // ë¨¼ì € ê¸°ì¡´ ë¡œì§ìœ¼ë¡œ ë¹ ë¥´ê²Œ í‘œì‹œ
          generateAndUpdateQuickSummary();

          // ê·¸ ë‹¤ìŒ Firebaseì—ì„œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°)
          getKakaoInfoFromFirebase();
        } else {
          // currentUserê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
          const quickSummaryHTML = `<div class="text-center text-gray-500 text-sm py-3">
                    ë¡œê·¸ì¸ í›„ ë‚´ í™œë™ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  </div>`;
          updateMyPageQuickSummary(quickSummaryHTML);
        }

        const activeListHTML =
          activeEvents.length === 0
            ? `<div class="text-center py-12"><i class="fas fa-calendar-xmark text-4xl text-gray-300"></i><p class="mt-3 text-gray-500">ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸/ë¯¸ì‹íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`
            : `<div id="events-container" class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6" style="position: relative; z-index: 1; min-height: 200px;">
                      ${activeEvents
                        .sort((a, b) => (a.order || 999) - (b.order || 999))
                        .map(eventCardHTML)
                        .join("")}
                     </div>`;

        // ë³´ê´€ëœ ì´ë²¤íŠ¸ ëª©ë¡ (íšŒì¥ë‹¨ë§Œ)
        const archivedListHTML = "";

        // ê´€ë¦¬ìì¸ ê²½ìš°: ì ì„  ë¸”ë¡ + ì´ë²¤íŠ¸ ëª©ë¡ + ë³´ê´€ ëª©ë¡, ì¼ë°˜ íšŒì›: ì´ë²¤íŠ¸ ëª©ë¡ + ë‚´ í™œë™ ë‚´ì—­
        const myPageContent = `${myHistoryHTML}`;

        c.innerHTML = isAdmin
          ? `
                  ${myPageContent}
                  <div class="section mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                      <!-- ë¯¸ì‹íšŒ ë§Œë“¤ê¸° ì ì„  ë¸”ë¡ -->
                      <div class="border-2 border-dashed border-orange-300 rounded-xl p-4 sm:p-6 text-center hover:border-orange-400 hover:bg-orange-50 transition-all cursor-pointer group" id="create-tasting-block">
                        <div class="flex flex-col items-center justify-center space-y-3">
                          <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                            <i class="fas fa-utensils text-2xl text-orange-500"></i>
                          </div>
                          <div>
                            <h3 class="text-lg font-bold text-gray-800">ë¯¸ì‹íšŒ ë§Œë“¤ê¸°</h3>
                            <p class="text-sm text-gray-500">ìƒˆë¡œìš´ ë¯¸ì‹íšŒë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
                          </div>
                        </div>
                      </div>

                      <!-- ì´ë²¤íŠ¸ ë§Œë“¤ê¸° ì ì„  ë¸”ë¡ -->
                      <div class="border-2 border-dashed border-blue-300 rounded-xl p-4 sm:p-6 text-center hover:border-blue-400 hover:bg-blue-50 transition-all cursor-pointer group" id="create-event-block">
                        <div class="flex flex-col items-center justify-center space-y-3">
                          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                            <i class="fas fa-calendar-plus text-2xl text-blue-500"></i>
                          </div>
                          <div>
                            <h3 class="text-lg font-bold text-gray-800 group-hover:text-blue-600">ì´ë²¤íŠ¸ ë§Œë“¤ê¸°</h3>
                            <p class="text-sm text-gray-500 group-hover:text-blue-500">ìƒˆë¡œìš´ ì´ë²¤íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="section mt-8">
                    <div class="flex items-center gap-2 mb-4">
                      <i class="fas fa-list text-gray-600 text-xl"></i>
                      <h4 class="text-xl font-bold text-gray-800">ìƒì„±ëœ ì´ë²¤íŠ¸ ëª©ë¡</h4>
                    </div>
                    ${activeListHTML}
                  </div>
                  ${archivedListHTML}
                `
          : `${myPageContent}
                  <div class="section mt-8">
                    <div class="flex items-center gap-2 mb-4">
                      <i class="fas fa-list text-gray-600 text-xl"></i>
                      <h4 class="text-xl font-bold text-gray-800">ìƒì„±ëœ ì´ë²¤íŠ¸ ëª©ë¡</h4>
                    </div>
                    ${activeListHTML}
                  </div>`;

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        c.removeEventListener("click", handleReservationTabClick);

        // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        c.addEventListener("click", handleReservationTabClick);

        // ë³´ê´€ëœ ì´ë²¤íŠ¸ í† ê¸€ ê¸°ëŠ¥
        if (isAdmin) {
          const toggleButton = document.getElementById(
            "archived-events-toggle"
          );
          const toggleIcon = document.getElementById("archived-toggle-icon");
          const content = document.getElementById("archived-events-content");

          if (toggleButton && content && toggleIcon) {
            toggleButton.addEventListener("click", () => {
              const isHidden = content.classList.contains("hidden");

              if (isHidden) {
                content.classList.remove("hidden");
                toggleIcon.style.transform = "rotate(180deg)";
              } else {
                content.classList.add("hidden");
                toggleIcon.style.transform = "rotate(0deg)";
              }
            });
          }
        }

        // ë‚´ í™œë™ ë‚´ì—­ í† ê¸€ ê¸°ëŠ¥
        if (remainingEvents.length > 0) {
          const myHistoryToggleButton =
            document.getElementById("my-history-toggle");
          const myHistoryToggleIcon = document.getElementById(
            "my-history-toggle-icon"
          );
          const myHistoryContent =
            document.getElementById("my-history-content");

          if (
            myHistoryToggleButton &&
            myHistoryContent &&
            myHistoryToggleIcon
          ) {
            const toggleLabel =
              myHistoryToggleButton.querySelector(".toggle-label");
            myHistoryToggleButton.setAttribute("aria-expanded", "false");
            myHistoryToggleButton.addEventListener("click", () => {
              const isHidden = myHistoryContent.classList.contains("hidden");

              if (isHidden) {
                myHistoryContent.classList.remove("hidden");
                myHistoryToggleIcon.style.transform = "rotate(180deg)";
                myHistoryToggleButton.setAttribute("aria-expanded", "true");
                if (toggleLabel) {
                  toggleLabel.textContent = `ì§€ë‚œ í™œë™ ${remainingEvents.length}ê±´ ì ‘ê¸°`;
                }
              } else {
                myHistoryContent.classList.add("hidden");
                myHistoryToggleIcon.style.transform = "rotate(0deg)";
                myHistoryToggleButton.setAttribute("aria-expanded", "false");
                if (toggleLabel) {
                  toggleLabel.textContent = `ì§€ë‚œ í™œë™ ${remainingEvents.length}ê±´ í¼ì¹˜ê¸°`;
                }
              }
            });
          }
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ ì‹œì‘
        startCountdownTimers();

        // ë¯¸ì‹íšŒ/ì´ë²¤íŠ¸ ìƒì„± ì ì„  ë¸”ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬ë¨

        // bindAdminEventsPanelì€ ëª¨ë‹¬ ë‚´ë¶€ì—ì„œë§Œ í˜¸ì¶œë¨
      }

      // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      let countdownIntervals = [];

      function startCountdownTimers() {
        // ê¸°ì¡´ íƒ€ì´ë¨¸ ëª¨ë‘ ì œê±°
        countdownIntervals.forEach((interval) => clearInterval(interval));
        countdownIntervals = [];

        // ëª¨ë“  ì¹´ìš´íŠ¸ë‹¤ìš´ ë²„íŠ¼ ì°¾ê¸°
        const countdownButtons = document.querySelectorAll("[data-countdown]");

        countdownButtons.forEach((button) => {
          const eventId = button.dataset.countdown;
          const startTime = new Date(button.dataset.start);
          const countdownElement = document.getElementById(
            `countdown-${eventId}`
          );

          if (!countdownElement) return;

          const interval = setInterval(() => {
            const now = new Date();
            const timeLeft = startTime - now;

            if (timeLeft <= 0) {
              // ì‹œê°„ì´ ì§€ë‚˜ë©´ í˜ì´ì§€ ë¦¬ë¡œë“œí•˜ì—¬ ë²„íŠ¼ í™œì„±í™”
              clearInterval(interval);
              window.location.reload();
            } else {
              // ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸
              const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
              const hours = Math.floor(
                (timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
              );
              const minutes = Math.floor(
                (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
              );
              const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

              countdownElement.textContent = `${
                days > 0 ? `${days}ì¼ ` : ""
              }${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ í›„ ì˜¤í”ˆ`;
            }
          }, 1000);

          countdownIntervals.push(interval);
        });
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë¥¼ ë³„ë„ë¡œ ë¶„ë¦¬
      async function handleReservationTabClick(e) {
        const b = e.target.closest("button[data-act]");
        if (!b) return;
        const act = b.dataset.act,
          id = b.dataset.id,
          rid = b.dataset.rid;
        if (act === "reserve-general") return reserveGeneral(id);
        if (act === "cancel-general") return cancelGeneral(id);
        if (act === "cancel-wait-general") return cancelWaitGeneral(id);
        if (act === "reserve-tasting") return reserveTasting(id, rid);
        if (act === "cancel-tasting") return cancelTasting(id, rid);
        if (act === "cancel-wait-tasting") return cancelWaitTasting(id, rid);
        if (act === "admin-cancel") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return cancelEventForAdmin(id);
        }
        if (act === "admin-edit") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          // ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ì˜¬ë°”ë¥¸ ëª¨ë‹¬ ì—´ê¸°
          const event = eventsData.find((e) => e.id === id);
          if (event && event.type === "tasting") {
            return openTastingModal("edit", id);
          } else {
            return openEventModal("edit", id);
          }
        }
        if (act === "admin-close") return closeEvent(id);
        if (act === "admin-reopen") return reopenEvent(id);
        if (act === "admin-archive") return archiveEvent(id);
        if (act === "admin-unarchive") return unarchiveEvent(id);
        if (act === "admin-add-participant") return openAddParticipantModal(id);
        if (act === "admin-complete") return completeEvent(id);
        if (act === "admin-unpost") return unpostEvent(id);
        if (act === "group-maker") {
          console.log("ğŸ¯ ì¡°ì§œê¸° ë²„íŠ¼ í´ë¦­ë¨:", id);
          return openGroupMakerModal(id);
        }
        if (act === "admin-delete") return deleteEvent(id);
        if (act === "export-xlsx") return exportApplicantsXLSX(id);
      }

      /* ===== ê¸°ì¡´ ì´ë²¤íŠ¸ ê´€ë¦¬ì íŒ¨ë„ (ìƒˆë¡œìš´ ëª¨ë‹¬ êµ¬ì¡°ë¡œ ëŒ€ì²´ë¨) ===== */
      // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ëª¨ë‹¬ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
      function adminEventsPanelHTML_DEPRECATED(defaultType = null) {
        return `<div class="section">
                <!-- í˜„ì¬ ì´ë²¤íŠ¸ ëª©ë¡ (ë§¨ ìœ„ë¡œ ì´ë™) -->
                <div class="mb-8 pb-6 border-b-2 border-gray-200">
                  <div class="flex items-center gap-2 mb-4">
                    <i class="fas fa-list text-gray-600 text-xl"></i>
                    <h4 class="text-xl font-bold text-gray-800">ìƒì„±ëœ ì´ë²¤íŠ¸ ëª©ë¡</h4>
                  </div>
                  <p class="text-sm text-gray-600 mb-4">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    ë§Œë“¤ì–´ì§„ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”
                  </p>
                  <div class="space-y-3">${adminEventsListHTML()}</div>
                </div>

                <!-- í—¤ë” -->
                <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-4 mb-6">
                  <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <i class="fas fa-calendar-plus text-orange-600"></i>
                    ìƒˆ ì´ë²¤íŠ¸ ë§Œë“¤ê¸°
                  </h3>
                  <p class="text-sm text-gray-600">
                    <i class="fas fa-info-circle text-orange-500 mr-1"></i>
                    ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì‹œë©´ ì‰½ê²Œ ì´ë²¤íŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”!
                  </p>
                </div>

                <!-- Step 1: ì´ë²¤íŠ¸ ìœ í˜• -->
                <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">1</span>
                    <h4 class="text-lg font-bold text-gray-800">ì–´ë–¤ ì¢…ë¥˜ì˜ ì´ë²¤íŠ¸ì¸ê°€ìš”?</h4>
                  </div>
                  <select id="event-type" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-white text-gray-900 hover:border-orange-400 focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base font-medium">
                    <option value="tasting">ğŸ½ï¸ ë¯¸ì‹íšŒ (ì—¬ëŸ¬ ì‹ë‹¹ ì¤‘ ì„ íƒ)</option>
                    <option value="general">ğŸ“Œ ì¼ë°˜ ì´ë²¤íŠ¸ (ë‹¨ì¼ í™œë™)</option>
                    <option value="mt">ğŸ•ï¸ MT (íšŒë¹„ ì…ê¸ˆ í•„ìš”)</option>
                    <option value="assembly">ğŸ‘¥ ì´íšŒ (íšŒë¹„ ì…ê¸ˆ í•„ìš”)</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-2 pl-10">ğŸ’¡ ë¯¸ì‹íšŒëŠ” ì—¬ëŸ¬ ì‹ë‹¹ì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”</p>
                </div>

                <!-- Step 2: ê¸°ë³¸ ì •ë³´ -->
                <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
                  <div class="flex items-center gap-2 mb-4">
                    <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">2</span>
                    <h4 class="text-lg font-bold text-gray-800">ì´ë²¤íŠ¸ ê¸°ë³¸ ì •ë³´</h4>
                  </div>
                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-heading text-orange-500"></i>
                        ì´ë²¤íŠ¸ ì œëª© <span class="text-red-500">*</span>
                      </label>
                      <input id="event-title" type="text" placeholder="ì˜ˆ: í‘¸ë”” ê°€ì„ ë¯¸ì‹íšŒ, ê°€ì„ MT" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-orange-500"></i>
                        ì´ë²¤íŠ¸ ì‹¤ì‹œì¼ (ì–¸ì œ ì§„í–‰í•˜ë‚˜ìš”?) <span class="text-red-500">*</span>
                      </label>
                      <input id="event-datetime" type="datetime-local" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                      <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ“… ì´ë²¤íŠ¸ê°€ ì‹¤ì œë¡œ ì§„í–‰ë˜ëŠ” ë‚ ì§œì™€ ì‹œê°„</p>
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-play text-orange-500"></i>
                        ì‹ ì²­ ì‹œì‘ì¼ (ì–¸ì œë¶€í„° ì‹ ì²­ë°›ë‚˜ìš”?)
                      </label>
                      <input id="event-registration-start" type="datetime-local" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base">
                      <p class="text-xs text-gray-500 mt-1 pl-6">ğŸš€ ì´ ì‹œê°„ë¶€í„° ì‹ ì²­ì´ ì‹œì‘ë©ë‹ˆë‹¤ (ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ ì‹ ì²­ ê°€ëŠ¥)</p>
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-clock text-orange-500"></i>
                        ì‹ ì²­ ë§ˆê°ì¼ (ì–¸ì œê¹Œì§€ ì‹ ì²­ë°›ë‚˜ìš”?) <span class="text-red-500">*</span>
                      </label>
                      <input id="event-deadline" type="datetime-local" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                      <p class="text-xs text-gray-500 mt-1 pl-6">â° ì´ ì‹œê°„ ì´í›„ë¡œëŠ” ì‹ ì²­í•  ìˆ˜ ì—†ì–´ìš”</p>
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-users text-orange-500"></i>
                        ìµœëŒ€ ëª‡ ëª…ê¹Œì§€ ì°¸ê°€í•  ìˆ˜ ìˆë‚˜ìš”? <span class="text-red-500">*</span>
                      </label>
                      <input id="event-limit" type="number" min="1" placeholder="ì˜ˆ: 30" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                      <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ‘¥ ì •ì›ì„ ì´ˆê³¼í•˜ë©´ ëŒ€ê¸° ì‹ ì²­ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤</p>
                    </div>
                  </div>
                </div>

                <!-- Step 3: ê³µê°œ ì„¤ì • ë° ì•Œë¦¼ -->
                <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
                  <div class="flex items-center gap-2 mb-4">
                    <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">3</span>
                    <h4 class="text-lg font-bold text-gray-800">ê³µê°œ ì„¤ì • ë° ì•Œë¦¼</h4>
                  </div>
                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-eye text-orange-500"></i>
                        íšŒì›ë“¤ì—ê²Œ ë³´ì—¬ì¤„ê¹Œìš”?
                      </label>
                      <div class="flex bg-gray-100 rounded-lg p-1.5 w-fit gap-1">
                        <button type="button" id="status-open" class="px-4 py-2 text-sm font-bold rounded-lg transition-all bg-white text-orange-600 shadow-sm flex items-center gap-2">
                          <i class="fas fa-globe"></i>ê³µê°œ
                        </button>
                        <button type="button" id="status-hidden" class="px-4 py-2 text-sm font-bold rounded-lg transition-all text-gray-600 hover:text-gray-800 hover:bg-white/50 flex items-center gap-2">
                          <i class="fas fa-eye-slash"></i>ìˆ¨ê¹€
                        </button>
                      </div>
                      <input type="hidden" id="event-status" value="open">
                      <p class="text-xs text-gray-500 mt-2 pl-6">ğŸ”’ "ìˆ¨ê¹€"ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
                    </div>
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-bell text-orange-500"></i>
                        ìë™ ì•Œë¦¼ ì„¤ì •
                      </label>
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                        <div class="flex items-start gap-2">
                          <input type="checkbox" id="enable-auto-post" class="mt-1 w-4 h-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500" checked>
                          <label for="enable-auto-post" class="text-sm font-medium text-gray-700 flex-1">
                            ìë™ìœ¼ë¡œ ì•Œë¦¼ ê¸€ ì˜¬ë¦¬ê¸°
                            <p class="text-xs text-gray-500 font-normal mt-1">ì´ë²¤íŠ¸ í•˜ë£¨ ì „ì— íšŒì›ë“¤ì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚´ìš”</p>
                          </label>
                        </div>
                      </div>
                      <div id="post-time-container" class="space-y-3 pl-6">
                        <div class="flex items-center gap-3">
                          <input type="radio" id="post-time-auto" name="post-time-type" value="auto" class="w-4 h-4 text-orange-600 focus:ring-orange-500" checked>
                          <label for="post-time-auto" class="text-sm text-gray-700 flex items-center gap-2">
                            <i class="fas fa-clock text-gray-400"></i>
                            <span>ì´ë²¤íŠ¸ 24ì‹œê°„ ì „ ìë™</span>
                            <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-semibold">ì¶”ì²œ</span>
                          </label>
                        </div>
                        <div class="flex items-center gap-3">
                          <input type="radio" id="post-time-custom" name="post-time-type" value="custom" class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                          <label for="post-time-custom" class="text-sm text-gray-700 flex items-center gap-2">
                            <i class="fas fa-calendar-check text-gray-400"></i>
                            <span>ì§ì ‘ ì§€ì •í•˜ê¸°</span>
                          </label>
                        </div>
                        <div class="pl-8">
                          <input id="post-datetime" type="datetime-local" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-200" disabled>
                        </div>
                      </div>
                      <button type="button" id="test-announcement-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium">
                        <i class="fas fa-flask"></i>
                        í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë¯¸ë¦¬ë³´ê¸°
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Step 4: íšŒë¹„ ì…ê¸ˆ ì •ë³´ (MT/ì´íšŒë§Œ) -->
                <div id="payment-fields" class="hidden">
                  <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
                    <div class="flex items-center gap-2 mb-4">
                      <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">4</span>
                      <h4 class="text-lg font-bold text-gray-800">ğŸ’° íšŒë¹„ ì…ê¸ˆ ì •ë³´</h4>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                      <p class="text-xs text-yellow-800 flex items-center gap-2">
                        <i class="fas fa-lightbulb"></i>
                        ì‹œìŠ¤í…œ ì„¤ì •ì˜ ê³„ì¢Œ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ì •í•˜ì„¸ìš”.
                      </p>
                    </div>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                          <i class="fas fa-landmark text-orange-500"></i>
                          ì€í–‰ëª…
                        </label>
                        <input id="pay-bank" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="ì˜ˆ: êµ­ë¯¼ì€í–‰, ì‹ í•œì€í–‰">
                      </div>
                      <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                          <i class="fas fa-credit-card text-orange-500"></i>
                          ê³„ì¢Œë²ˆí˜¸
                        </label>
                        <input id="pay-number" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="000-000-000000">
                      </div>
                      <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                          <i class="fas fa-user text-orange-500"></i>
                          ì˜ˆê¸ˆì£¼
                        </label>
                        <input id="pay-holder" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="í™ê¸¸ë™">
                      </div>
                      <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                          <i class="fas fa-comment-dots text-orange-500"></i>
                          ì…ê¸ˆ ì•ˆë‚´ (ì„ íƒì‚¬í•­)
                        </label>
                        <input id="pay-note" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="ì˜ˆ: ì…ê¸ˆ ì‹œ ì´ë¦„ ê¼­ ì ì–´ì£¼ì„¸ìš”">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 4/5: ì‹ë‹¹ ê´€ë¦¬ (ë¯¸ì‹íšŒë§Œ) -->
                <div id="tasting-fields">
                  <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
                    <div class="flex items-center gap-2 mb-4">
                      <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">4</span>
                      <h4 class="text-lg font-bold text-gray-800">ğŸ½ï¸ ì‹ë‹¹ ì¶”ê°€í•˜ê¸°</h4>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                      <p class="text-xs text-green-800 flex items-center gap-2">
                        <i class="fas fa-check-circle"></i>
                        ë¯¸ì‹íšŒëŠ” ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‹ë‹¹ì„ ì¶”ê°€í•´ì•¼ í•´ìš”!
                      </p>
                    </div>
                    <div id="event-restaurants-wrap" class="space-y-3 mb-4">${createRestaurantFieldHTML()}</div>
                    <button id="add-restaurant-btn" type="button" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                      <i class="fas fa-plus-circle text-lg"></i>
                      <span>ì‹ë‹¹ ì¶”ê°€í•˜ê¸°</span>
                    </button>
                  </div>
                </div>

                <!-- ì €ì¥ ë²„íŠ¼ -->
                <div class="flex gap-3 mt-6">
                  <button id="save-event-btn" type="button" class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-4 px-6 rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-3 text-lg">
                    <i class="fas fa-check-circle text-xl"></i>
                    <span>ì´ë²¤íŠ¸ ë§Œë“¤ê¸° ì™„ë£Œ!</span>
                  </button>
                  <button id="reset-event-btn" type="button" class="flex-none bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-4 px-6 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                    <i class="fas fa-redo"></i>
                    <span>ë‹¤ì‹œ ì‘ì„±</span>
                  </button>
                </div>
              </div>`;
      }
      // ê¸°ì¡´ bindAdminEventsPanel í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ ëª¨ë‹¬ êµ¬ì¡°ë¡œ ëŒ€ì²´ë¨
      function bindAdminEventsPanel_DEPRECATED() {
        const wrap = document.getElementById("event-restaurants-wrap");
        const eventType = document.getElementById("event-type");
        const addRestaurantBtn = document.getElementById("add-restaurant-btn");
        const saveEventBtn = document.getElementById("save-event-btn");
        const resetEventBtn = document.getElementById("reset-event-btn");

        // null ì²´í¬
        if (
          !wrap ||
          !eventType ||
          !addRestaurantBtn ||
          !saveEventBtn ||
          !resetEventBtn
        ) {
          console.warn("bindAdminEventsPanel: ì¼ë¶€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ê¸°ì¡´ onTypeChangeëŠ” ìƒˆë¡œìš´ ëª¨ë‹¬ êµ¬ì¡°ì—ì„œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
        // eventType.addEventListener("change", (e) => onTypeChange(e.target.value));
        addRestaurantBtn.addEventListener("click", () => addRestaurantField());

        // ê¸°ì¡´ ì‹ë‹¹ í•„ë“œë“¤ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
        const existingRows = wrap.querySelectorAll(".restaurant-row");
        existingRows.forEach((row) => bindRestaurantFieldEvents(row));

        // ì‹ë‹¹ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        wrap.addEventListener("click", (e) => {
          const row = e.target.closest(".restaurant-row");
          if (!row) return;
          if (e.target.closest(".remove-restaurant")) row.remove();
        });
        // ê¸°ì¡´ createOrSaveEventëŠ” ìƒˆë¡œìš´ ëª¨ë‹¬ êµ¬ì¡°ì—ì„œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
        // saveEventBtn.addEventListener("click", () => createOrSaveEvent());
        resetEventBtn.addEventListener("click", () => resetEventForm());

        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ê²Œì‹œ ë²„íŠ¼
        const testAnnouncementBtn = document.getElementById(
          "test-announcement-btn"
        );
        if (testAnnouncementBtn) {
          testAnnouncementBtn.addEventListener("click", async () => {
            const testContent = `ğŸ§ª í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ğŸ§ª

      ğŸ“… ì¼ì‹œ: ${new Date().toLocaleString("ko-KR")}
      ğŸ“ ì œëª©: í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸

      ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ìš© ì•Œë¦¼ì…ë‹ˆë‹¤.
      ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ˜Š

      #Foodie #í…ŒìŠ¤íŠ¸`;

            try {
              await postAnnouncement(testContent);
            } catch (error) {
              console.error("í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ê²Œì‹œ ì˜¤ë¥˜:", error);
            }
          });
        }

        // ê²Œì‹œì¼ì‹œ ì„¤ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const enableAutoPost = document.getElementById("enable-auto-post");
        const postTimeAuto = document.getElementById("post-time-auto");
        const postTimeCustom = document.getElementById("post-time-custom");
        const postDatetime = document.getElementById("post-datetime");
        const postTimeContainer = document.getElementById(
          "post-time-container"
        );

        if (
          enableAutoPost &&
          postTimeAuto &&
          postTimeCustom &&
          postDatetime &&
          postTimeContainer
        ) {
          // ìë™ ì•Œë¦¼ ê²Œì‹œ ì‚¬ìš©/í•´ì œ
          enableAutoPost.addEventListener("change", (e) => {
            postTimeContainer.style.opacity = e.target.checked ? "1" : "0.5";
            postTimeContainer.style.pointerEvents = e.target.checked
              ? "auto"
              : "none";
          });

          // ê²Œì‹œ ì‹œê°„ íƒ€ì… ë³€ê²½
          postTimeAuto.addEventListener("change", () => {
            if (postTimeAuto.checked) {
              postDatetime.disabled = true;
            }
          });

          postTimeCustom.addEventListener("change", () => {
            if (postTimeCustom.checked) {
              postDatetime.disabled = false;
              // ì´ë²¤íŠ¸ ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
              const eventDatetime =
                document.getElementById("event-datetime").value;
              if (eventDatetime) {
                const eventTime = new Date(eventDatetime);
                const postTime = new Date(
                  eventTime.getTime() - 24 * 60 * 60 * 1000
                );
                postDatetime.value = postTime.toISOString().slice(0, 16);
              }
            }
          });

          // ì´ë²¤íŠ¸ ì‹œê°„ ë³€ê²½ ì‹œ ìë™ ê²Œì‹œ ì‹œê°„ ì—…ë°ì´íŠ¸
          const eventDatetime = document.getElementById("event-datetime");
          if (eventDatetime) {
            eventDatetime.addEventListener("change", () => {
              if (postTimeAuto.checked) {
                // ìë™ ëª¨ë“œì—ì„œëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ
              } else if (postTimeCustom.checked && !postDatetime.value) {
                // ì»¤ìŠ¤í…€ ëª¨ë“œì—ì„œ ê²Œì‹œ ì‹œê°„ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
                const eventTime = new Date(eventDatetime.value);
                const postTime = new Date(
                  eventTime.getTime() - 24 * 60 * 60 * 1000
                );
                postDatetime.value = postTime.toISOString().slice(0, 16);
              }
            });
          }
        }

        // ê³µê°œ/ìˆ¨ê¹€ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
        const statusOpenBtn = document.getElementById("status-open");
        const statusHiddenBtn = document.getElementById("status-hidden");
        const statusInput = document.getElementById("event-status");

        if (statusOpenBtn && statusHiddenBtn && statusInput) {
          const updateStatusButtons = (status) => {
            if (status === "open") {
              statusOpenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white text-orange-600 shadow-sm";
              statusHiddenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800";
            } else {
              statusOpenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800";
              statusHiddenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white text-orange-600 shadow-sm";
            }
            statusInput.value = status;
          };

          statusOpenBtn.addEventListener("click", () =>
            updateStatusButtons("open")
          );
          statusHiddenBtn.addEventListener("click", () =>
            updateStatusButtons("archived")
          );

          // ì´ˆê¸° ìƒíƒœ ì„¤ì •
          updateStatusButtons(statusInput.value);
        }

        // ê¸°ì¡´ onTypeChangeëŠ” ìƒˆë¡œìš´ ëª¨ë‹¬ êµ¬ì¡°ì—ì„œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
        // onTypeChange(eventType.value);
      }
      // ê¸°ì¡´ restaurantFieldHTML í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ createRestaurantFieldHTMLë¡œ ëŒ€ì²´ë¨
      function restaurantFieldHTML_DEPRECATED(
        n = "",
        i = "",
        c = "",
        url = "",
        id = "",
        category = "ê¸°íƒ€"
      ) {
        const rid = id || `res_${Math.random().toString(36).slice(2, 9)}`;
        return `<div class="restaurant-row bg-gradient-to-br from-white to-orange-50 border-2 border-orange-300 rounded-xl p-5 relative" data-id="${rid}">
                <!-- ì‚­ì œ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨) -->
                <button type="button" class="remove-restaurant absolute top-3 right-3 bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full transition-all shadow-md hover:shadow-lg flex items-center justify-center" title="ì´ ì‹ë‹¹ ì‚­ì œ">
                  <i class="fas fa-trash text-sm"></i>
                </button>

                <div class="space-y-4">
                  <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ (ë™ì  ìƒì„±) -->
                  <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                      <i class="fas fa-tags text-orange-500"></i>
                      ìŒì‹ ì¢…ë¥˜ <span class="text-red-500">*</span>
                    </label>
                    <select data-field="category" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base bg-white" required>
                      ${restaurantCategories
                        .map(
                          (cat) => `
                        <option value="${cat.name}" ${
                            category === cat.name ? "selected" : ""
                          }>${cat.emoji} ${cat.name}</option>
                      `
                        )
                        .join("")}
                    </select>
                    <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ·ï¸ ì‹ë‹¹ì˜ ìŒì‹ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                  </div>


                  <!-- ì…ë ¥ í•„ë“œë“¤ -->
                  <div class="space-y-4">
                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-utensils text-orange-500"></i>
                        ì‹ë‹¹ ì´ë¦„ <span class="text-red-500">*</span>
                      </label>
                      <input data-field="name" type="text" value="${saf(
                        n
                      )}" placeholder="ì˜ˆ: ìŠ¤ì‹œ ë§›ì§‘, íŒŒìŠ¤íƒ€ ë ˆìŠ¤í† ë‘" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                    </div>

                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-users text-orange-500"></i>
                        ì´ ì‹ë‹¹ì˜ ì •ì› <span class="text-red-500">*</span>
                      </label>
                      <input data-field="capacity" type="number" min="1" value="${saf(
                        c
                      )}" placeholder="ì˜ˆ: 10" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                      <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ‘¥ ì´ ì‹ë‹¹ì— ëª‡ ëª…ê¹Œì§€ ê°ˆ ìˆ˜ ìˆë‚˜ìš”?</p>
                    </div>

                    <div>
                      <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-utensils text-orange-500"></i>
                        ëŒ€í‘œ ë©”ë‰´ <span class="text-red-500">*</span>
                      </label>
                      <textarea data-field="info" rows="3" placeholder="ì´ ì‹ë‹¹ì˜ ëŒ€í‘œ ë©”ë‰´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”&#10;ì˜ˆ: í† ë§ˆí†  íŒŒìŠ¤íƒ€, í¬ë¦¼ ë¦¬ì¡°ë˜, ë§ˆë¥´ê²Œë¦¬íƒ€ í”¼ì" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base resize-none" required>${saf(
                        i
                      )}</textarea>
                      <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ½ï¸ ì´ ì‹ë‹¹ì—ì„œ ê¼­ ë¨¹ì–´ë´ì•¼ í•  ë©”ë‰´ë¥¼ ì ì–´ì£¼ì„¸ìš”</p>
                    </div>
                  </div>
                </div>
              </div>`;
      }
      // ê¸°ì¡´ onTypeChange í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ ëª¨ë‹¬ êµ¬ì¡°ì—ì„œ bindEventFormìœ¼ë¡œ ëŒ€ì²´ë¨
      function onTypeChange_DEPRECATED(type) {
        const tastingFields = document.getElementById("tasting-fields");
        const paymentFields = document.getElementById("payment-fields");

        if (!tastingFields || !paymentFields) {
          console.warn("onTypeChange: í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        tastingFields.classList.toggle("hidden", type !== "tasting");
        paymentFields.classList.toggle(
          "hidden",
          !(type === "mt" || type === "assembly")
        );

        if (type === "mt" || type === "assembly") {
          const d = duesSettings || {};
          const payBank = document.getElementById("pay-bank");
          const payNumber = document.getElementById("pay-number");
          const payHolder = document.getElementById("pay-holder");
          const payNote = document.getElementById("pay-note");

          if (payBank && !payBank.value) payBank.value = d.bank || "";
          if (payNumber && !payNumber.value) payNumber.value = d.number || "";
          if (payHolder && !payHolder.value) payHolder.value = d.holder || "";
          if (payNote && !payNote.value) {
            payNote.value =
              (d.amount ? `íšŒë¹„ ${formatKRW(d.amount)} ` : "") + (d.note || "");
          }
        }
      }
      function adminEventsListHTML() {
        if (eventsData.length === 0) return `<p class="text-gray-500">ì—†ìŒ</p>`;
        return eventsData
          .map((ev) => {
            const when = ev.datetime
              ? new Date(ev.datetime).toLocaleString("ko-KR")
              : "-";
            const badge = typeBadgeClass(ev.type);
            return `<div class="flex items-center justify-between bg-white p-3 rounded border">
                  <div class="min-w-0">
                    <span class="text-sm px-2 py-0.5 rounded ${badge}">${typeLabel(
              ev.type
            )}</span>
                    <span class="font-semibold ml-2">${saf(
                      ev.title || "(ì œëª© ì—†ìŒ)"
                    )}</span>
                    <span class="text-sm text-gray-500 ml-2">(${when})</span>
                    <span class="text-xs ml-2 px-2 py-0.5 rounded ${
                      ev.status === "open"
                        ? "bg-green-100 text-green-700"
                        : ev.autoClosedAt
                        ? "bg-orange-100 text-orange-700"
                        : "bg-gray-200 text-gray-700"
                    }" ${
              ev.autoClosedAt
                ? `title="ìë™ ë§ˆê°ë¨: ${new Date(
                    ev.autoClosedAt
                  ).toLocaleString("ko-KR")}"`
                : ""
            }>${
              ev.autoClosedAt ? "ìë™ ë§ˆê°" : statusLabel(ev.status || "open")
            }</span>
                  </div>
                  <div class="flex gap-2">
                    <button type="button" class="text-blue-600 hover:text-blue-800" data-act="admin-edit" data-id="${
                      ev.id
                    }" title="ìˆ˜ì •"><i class="fas fa-pen"></i></button>
                    ${
                      ev.status === "closed"
                        ? `<button type="button" class="text-green-600 hover:text-green-800 font-semibold" data-act="admin-reopen" data-id="${ev.id}" title="ë‹¤ì‹œ ì—´ê¸°"><i class="fas fa-door-open"></i></button>`
                        : `<button type="button" class="text-red-600 hover:text-red-800" data-act="admin-close" data-id="${ev.id}" title="ì‹ ì²­ ë§ˆê°"><i class="fas fa-door-closed"></i></button>`
                    }
                    <button type="button" class="text-amber-600 hover:text-amber-800" data-act="admin-archive" data-id="${
                      ev.id
                    }" title="ë³´ê´€(ìˆ¨ê¹€)"><i class="fas fa-box-archive"></i></button>
                    <button type="button" class="text-indigo-600 hover:text-indigo-800" data-act="admin-unpost" data-id="${
                      ev.id
                    }" title="ê¸€ ë‚´ë¦¬ê¸°"><i class="fas fa-arrow-down"></i></button>
                    <button type="button" class="text-purple-600 hover:text-purple-800" data-act="group-maker" data-id="${
                      ev.id
                    }" title="íŒ€ êµ¬ì„±í•˜ê¸°"><i class="fas fa-users"></i></button>
                    <button type="button" class="text-red-600 hover:text-red-800" data-act="admin-delete" data-id="${
                      ev.id
                    }" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
                  </div>
                </div>`;
          })
          .join("");
      }
      const addRestaurantField = () => {
        const wrap = document.getElementById("event-restaurants-wrap");
        if (!wrap) return;

        wrap.insertAdjacentHTML("beforeend", createRestaurantFieldHTML());

        // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindRestaurantFieldEvents(wrap.lastElementChild);
      };

      // ì‹ë‹¹ í•„ë“œì— ì´ë²¤íŠ¸ ë°”ì¸ë”©í•˜ëŠ” í•¨ìˆ˜ (ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ ì œê±°ë¨)
      function bindRestaurantFieldEvents(row) {
        if (!row) {
          console.error("bindRestaurantFieldEvents: rowê°€ ì—†ìŠµë‹ˆë‹¤");
          return;
        }
        console.log("ì‹ë‹¹ í•„ë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ (ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œê±°ë¨)");
      }

      /* ===== ì´ë¯¸ì§€ ì—…ë¡œë“œ ===== */
      async function uploadRestaurantImage(row, file) {
        console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘:", file);

        if (IS_FILE) {
          showAlert(
            "â„¹ï¸",
            "ë¡œì»¬ íŒŒì¼ë¡œ ì—¬ì‹  ê²½ìš° ì—…ë¡œë“œê°€ ì œí•œë  ìˆ˜ ìˆì–´ìš”. GitHub Pages/ì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸í•´ ì£¼ì„¸ìš”."
          );
          return;
        }

        if (!currentUser) {
          console.error("í˜„ì¬ ì‚¬ìš©ì ì—†ìŒ");
          return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        if (!file || !file.type.startsWith("image/")) {
          console.error("ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹˜:", file?.type);
          return showAlert("â„¹ï¸", "ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }

        const overlay = row.querySelector("[data-role='uploading']");
        const imageUrlField = row.querySelector("[data-field='imageUrl']");
        const previewImg = row.querySelector("[data-role='preview']");
        const dropzone = row.querySelector("[data-role='dropzone']");

        if (!overlay || !imageUrlField || !previewImg || !dropzone) {
          console.error("í•„ìš”í•œ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", {
            overlay: !!overlay,
            imageUrlField: !!imageUrlField,
            previewImg: !!previewImg,
            dropzone: !!dropzone,
          });
          return showAlert("ğŸ˜¥", "ì´ë¯¸ì§€ ì—…ë¡œë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        overlay.classList.remove("hidden");

        try {
          const ext = (file.name.split(".").pop() || "png").toLowerCase();
          const path = `event-images/${
            currentUser.studentId
          }/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;

          console.log("ì—…ë¡œë“œ ê²½ë¡œ:", path);

          const ref = sRef(storage, path);
          const task = uploadBytesResumable(ref, file);

          await new Promise((resolve, reject) => {
            task.on(
              "state_changed",
              (snapshot) => {
                const progress =
                  (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log(`ì—…ë¡œë“œ ì§„í–‰ë¥ : ${progress.toFixed(2)}%`);
              },
              (error) => {
                console.error("ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
                reject(error);
              },
              () => {
                console.log("ì—…ë¡œë“œ ì™„ë£Œ");
                resolve();
              }
            );
          });

          const url = await getDownloadURL(task.snapshot.ref);
          console.log("ë‹¤ìš´ë¡œë“œ URL:", url);

          // DOM ìš”ì†Œ ì—…ë°ì´íŠ¸
          imageUrlField.value = url;
          previewImg.src = url;
          previewImg.classList.remove("hidden");
          dropzone.classList.add("hidden");

          showAlert("âœ…", "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!");
        } catch (err) {
          console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
          let errorMessage = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨. ";

          if (err.code === "storage/unauthorized") {
            errorMessage += "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
          } else if (err.code === "storage/network-request-failed") {
            errorMessage += "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          } else {
            errorMessage += "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          }

          showAlert("ğŸ˜¥", errorMessage);
        } finally {
          overlay.classList.add("hidden");
        }
      }

      /* ===== íšŒì› í”„ë¡œí•„ ì¡°íšŒ(ì‹ ì²­ ì •ë³´ í’ë¶€í™”) ===== */
      async function getCurrentMemberProfile() {
        try {
          if (!currentUser?.studentId) return {};
          const snap = await getDoc(doc(db, "members", currentUser.studentId));
          return snap.exists() ? snap.data() || {} : {};
        } catch {
          return {};
        }
      }
      function pickProfileFields(p = {}) {
        return {
          gender: p.gender || "",
          year: p.year || "",
          college: p.college || "",
          department: p.department || "",
          phone: p.phone || "",
        };
      }

      /* ===== ì‹ ì²­ ë¡œì§ ===== */
      async function reserveGeneral(id) {
        if (!currentUser) return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        const requestKey = `reserve-general-${id}`;
        if (processingRequests.has(requestKey)) {
          console.log("ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì…ë‹ˆë‹¤:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="reserve-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì‹ ì²­ ì¤‘...';
        }

        const prof = pickProfileFields(await getCurrentMemberProfile());
        try {
          // ê° ì´ë²¤íŠ¸ëŠ” ë…ë¦½ì ì´ë¯€ë¡œ ë‹¤ë¥¸ ì´ë²¤íŠ¸ ì‹ ì²­ ì—¬ë¶€ëŠ” ì²´í¬í•˜ì§€ ì•ŠìŒ
          // ë‹¨, ê°™ì€ ì´ë²¤íŠ¸ ë‚´ì—ì„œë§Œ ì¤‘ë³µ ì²´í¬

          await runTransaction(
            db,
            async (tx) => {
              const ref = doc(db, "events", id);
              const snap = await tx.get(ref);
              if (!snap.exists()) throw new Error("not found");
              const ev = snap.data();
              ev.applicants ??= [];
              ev.waiting ??= [];
              if (isUserIn([...ev.applicants, ...ev.waiting])) return;
              const now = new Date().toISOString();
              const entry = {
                ...currentUser,
                ...prof,
                timestamp: now,
                appliedAt: now,
              };
              const lim = parseInt(ev.limit || 0, 10) || 0;
              if (lim === 0 || ev.applicants.length < lim)
                ev.applicants.push(entry);
              else ev.waiting.push(entry);
              tx.update(ref, {
                applicants: ev.applicants,
                waiting: ev.waiting,
              });
            },
            TRANSACTION_OPTIONS
          );
          showAlert("âœ…", "ì‹ ì²­ ì™„ë£Œ!");
        } catch (e) {
          if (String(e?.message).includes("DUP"))
            showAlert("ğŸ™‚", "ì´ë¯¸ ì´ ì´ë²¤íŠ¸ì— ì‹ ì²­(ë˜ëŠ” ëŒ€ê¸°)ë˜ì–´ ìˆì–´ìš”.");
          else if (e?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì‹ ì²­ ì‹¤íŒ¨");
        } finally {
          // ì²˜ë¦¬ ì™„ë£Œ ì‹œ ì „ì—­ ë³€ìˆ˜ì—ì„œ ì œê±°
          processingRequests.delete(requestKey);

          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelGeneral(id) {
        if (!currentUser) return;

        // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        const requestKey = `cancel-general-${id}`;
        if (processingRequests.has(requestKey)) {
          console.log("ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì…ë‹ˆë‹¤:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="cancel-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì·¨ì†Œ ì¤‘...';
        }

        try {
          await runTransaction(
            db,
            async (tx) => {
              const ref = doc(db, "events", id);
              const snap = await tx.get(ref);
              const ev = snap.data();
              ev.applicants ??= [];
              ev.waiting ??= [];
              const before = ev.applicants.length;
              ev.applicants = ev.applicants.filter(
                (p) => p.studentId !== currentUser.studentId
              );
              if (ev.applicants.length < before) {
                if (ev.waiting.length > 0)
                  ev.applicants.push(ev.waiting.shift());
              } else
                ev.waiting = ev.waiting.filter(
                  (p) => p.studentId !== currentUser.studentId
                );
              tx.update(ref, {
                applicants: ev.applicants,
                waiting: ev.waiting,
              });
            },
            TRANSACTION_OPTIONS
          );
          showAlert("ğŸ—‘ï¸", "ì‹ ì²­ ì·¨ì†Œë¨");
        } catch (e) {
          if (e?.message === "cancelled-by-user") {
            showToast("ì‹ ì²­ì„ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.");
          } else if (e?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì·¨ì†Œ ì‹¤íŒ¨");
        } finally {
          // ì²˜ë¦¬ ì™„ë£Œ ì‹œ ì „ì—­ ë³€ìˆ˜ì—ì„œ ì œê±°
          processingRequests.delete(requestKey);

          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelWaitGeneral(id) {
        if (!currentUser) return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        const requestKey = `cancel-wait-general-${id}`;
        if (processingRequests.has(requestKey)) {
          console.log("ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì…ë‹ˆë‹¤:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="cancel-wait-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì·¨ì†Œ ì¤‘...';
        }

        try {
          await runTransaction(
            db,
            async (tx) => {
              const ref = doc(db, "events", id);
              const snap = await tx.get(ref);
              const ev = snap.data();
              ev.waiting ??= [];
              ev.waiting = ev.waiting.filter(
                (p) => p.studentId !== currentUser.studentId
              );
              tx.update(ref, { waiting: ev.waiting });
            },
            TRANSACTION_OPTIONS
          );
          showAlert("ğŸ—‘ï¸", "ëŒ€ê¸° ì·¨ì†Œë¨");
        } catch (e) {
          if (e?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì·¨ì†Œ ì‹¤íŒ¨");
        } finally {
          // ì²˜ë¦¬ ì™„ë£Œ ì‹œ ì „ì—­ ë³€ìˆ˜ì—ì„œ ì œê±°
          processingRequests.delete(requestKey);

          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      // ì¤‘ë³µ í´ë¦­ ë°©ì§€ë¥¼ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
      const processingRequests = new Set();

      async function reserveTasting(id, rid) {
        if (!currentUser) return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        const requestKey = `reserve-tasting-${id}-${rid}`;
        if (processingRequests.has(requestKey)) {
          console.log("ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì…ë‹ˆë‹¤:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="reserve-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì‹ ì²­ ì¤‘...';
        }

        const prof = pickProfileFields(await getCurrentMemberProfile());
        try {
          await runTransaction(
            db,
            async (tx) => {
              const ref = doc(db, "events", id);
              const snap = await tx.get(ref);
              const ev = snap.data();
              ev.restaurants ??= [];

              // ë¯¸ì‹íšŒëŠ” ê°™ì€ ì´ë²¤íŠ¸ ë‚´ì—ì„œë§Œ ì¤‘ë³µ ì²´í¬ (ë‹¤ë¥¸ ë¯¸ì‹íšŒ ì´ë²¤íŠ¸ëŠ” í—ˆìš©)
              const already = ev.restaurants.some((r) =>
                (r.reservations || [])
                  .concat(r.waiting || [])
                  .some((p) => p.studentId === currentUser.studentId)
              );
              if (already) throw new Error("DUP");
              const idx = ev.restaurants.findIndex((r) => r.id === rid);
              if (idx === -1) throw new Error("restaurant not found");
              const r = ev.restaurants[idx];
              r.reservations ??= [];
              r.waiting ??= [];
              const cap = r.capacity ?? ev.limit ?? 0;
              const now = new Date().toISOString();
              const entry = {
                ...currentUser,
                ...prof,
                timestamp: now,
                appliedAt: now,
              };
              if (r.reservations.length < cap) r.reservations.push(entry);
              else r.waiting.push(entry);
              ev.restaurants[idx] = r;
              tx.update(ref, { restaurants: ev.restaurants });
            },
            TRANSACTION_OPTIONS
          );
          showAlert("âœ…", "ì‹ ì²­ ì™„ë£Œ!");
        } catch (e) {
          if (String(e?.message).includes("DUP"))
            showAlert(
              "ğŸ™‚",
              "ì´ë¯¸ ì´ ë¯¸ì‹íšŒì—ì„œ ë‹¤ë¥¸ ì‹ë‹¹ì— ì‹ ì²­(ë˜ëŠ” ëŒ€ê¸°)ë˜ì–´ ìˆì–´ìš”.<br><b>í•œ ë¯¸ì‹íšŒì—ì„œ í•œ ì‹ë‹¹ë§Œ</b> ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            );
          else if (e?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì‹ ì²­ ì‹¤íŒ¨");
        } finally {
          // ì²˜ë¦¬ ì™„ë£Œ ì‹œ ì „ì—­ ë³€ìˆ˜ì—ì„œ ì œê±°
          processingRequests.delete(requestKey);

          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelTasting(id, rid) {
        if (!currentUser) return;

        const confirmModalHTML = `
                <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-[9999] px-4" id="cancel-tasting-confirm">
                  <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 space-y-4">
                    <div class="flex items-center gap-3">
                      <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-2xl">âš ï¸</div>
                      <div>
                        <h3 class="text-lg font-bold text-gray-900">ì‹ ì²­ ì·¨ì†Œ ì „ í™•ì¸í•´ì£¼ì„¸ìš”</h3>
                        <p class="text-sm text-gray-500">ì‹ ì²­ì„ ì·¨ì†Œí•˜ë©´ ëŒ€ê¸°ì ëª…ë‹¨ì˜ ì²« ë²ˆì§¸ íšŒì›ì´ ìë™ìœ¼ë¡œ ì°¸ê°€ìë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
                      </div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 text-xs text-orange-800 leading-relaxed">
                      <ul class="list-disc pl-4 space-y-1">
                        <li>ì·¨ì†Œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                        <li>ëŒ€ê¸°ìê°€ ì—†ìœ¼ë©´ ìë¦¬ë§Œ ë¹„ì›Œì§‘ë‹ˆë‹¤.</li>
                        <li>ë‹¤ì‹œ ì‹ ì²­í•˜ë ¤ë©´ ì •ì›ì´ ë‚¨ì•„ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
                      </ul>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                      <button type="button" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition-colors" data-cancel-action="keep">
                        ì‹ ì²­ ìœ ì§€
                      </button>
                      <button type="button" class="flex-1 px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors font-semibold" data-cancel-action="confirm">
                        ì‹ ì²­ ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                </div>
              `;

        const existingModal = document.getElementById("cancel-tasting-confirm");
        if (existingModal) existingModal.remove();
        document.body.insertAdjacentHTML("beforeend", confirmModalHTML);

        const modal = document.getElementById("cancel-tasting-confirm");
        const keepBtn = modal?.querySelector('[data-cancel-action="keep"]');
        const confirmBtn = modal?.querySelector(
          '[data-cancel-action="confirm"]'
        );

        const cleanupModal = () => {
          if (modal) modal.remove();
        };

        await new Promise((resolve, reject) => {
          if (!modal || !keepBtn || !confirmBtn) {
            cleanupModal();
            reject(new Error("confirmation modal failed"));
            return;
          }

          const handleKeep = () => {
            cleanupModal();
            reject(new Error("cancelled-by-user"));
          };

          const handleConfirm = () => {
            cleanupModal();
            resolve();
          };

          keepBtn.addEventListener("click", handleKeep, { once: true });
          confirmBtn.addEventListener("click", handleConfirm, { once: true });

          modal.addEventListener(
            "click",
            (e) => {
              if (e.target === modal) {
                cleanupModal();
                reject(new Error("cancelled-by-user"));
              }
            },
            { once: true }
          );
        }).catch((error) => {
          if (error?.message !== "cancelled-by-user") {
            console.error("ì·¨ì†Œ í™•ì¸ ì˜¤ë¥˜:", error);
          }
          throw error;
        });

        // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        const requestKey = `cancel-tasting-${id}-${rid}`;
        if (processingRequests.has(requestKey)) {
          console.log("ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì…ë‹ˆë‹¤:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="cancel-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì·¨ì†Œ ì¤‘...';
        }

        try {
          await runTransaction(
            db,
            async (tx) => {
              const ref = doc(db, "events", id);
              const snap = await tx.get(ref);
              const ev = snap.data();
              ev.restaurants ??= [];
              const idx = ev.restaurants.findIndex((r) => r.id === rid);
              if (idx === -1) throw new Error("restaurant not found");
              const r = ev.restaurants[idx];
              r.reservations ??= [];
              r.waiting ??= [];
              const before = r.reservations.length;
              r.reservations = r.reservations.filter(
                (p) => p.studentId !== currentUser.studentId
              );
              if (r.reservations.length < before) {
                if (r.waiting.length > 0)
                  r.reservations.push(r.waiting.shift());
              } else
                r.waiting = r.waiting.filter(
                  (p) => p.studentId !== currentUser.studentId
                );
              ev.restaurants[idx] = r;
              tx.update(ref, { restaurants: ev.restaurants });
            },
            TRANSACTION_OPTIONS
          );
          showAlert("ğŸ—‘ï¸", "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
          if (e?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì·¨ì†Œ ì‹¤íŒ¨");
        } finally {
          // ì²˜ë¦¬ ì™„ë£Œ ì‹œ ì „ì—­ ë³€ìˆ˜ì—ì„œ ì œê±°
          processingRequests.delete(requestKey);

          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelWaitTasting(id, rid) {
        if (!currentUser) return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        const requestKey = `cancel-wait-tasting-${id}-${rid}`;
        if (processingRequests.has(requestKey)) {
          console.log("ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì…ë‹ˆë‹¤:", requestKey);
          return;
        }
        processingRequests.add(requestKey);

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="cancel-wait-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì·¨ì†Œ ì¤‘...';
        }

        try {
          await runTransaction(
            db,
            async (tx) => {
              const ref = doc(db, "events", id);
              const snap = await tx.get(ref);
              const ev = snap.data();
              ev.restaurants ??= [];
              const idx = ev.restaurants.findIndex((r) => r.id === rid);
              if (idx === -1) throw new Error("restaurant not found");
              const r = ev.restaurants[idx];
              r.waiting ??= [];
              r.waiting = r.waiting.filter(
                (p) => p.studentId !== currentUser.studentId
              );
              ev.restaurants[idx] = r;
              tx.update(ref, { restaurants: ev.restaurants });
            },
            TRANSACTION_OPTIONS
          );
          showAlert("ğŸ—‘ï¸", "ëŒ€ê¸° ì·¨ì†Œë¨");
        } catch (e) {
          if (e?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì·¨ì†Œ ì‹¤íŒ¨");
        } finally {
          // ì²˜ë¦¬ ì™„ë£Œ ì‹œ ì „ì—­ ë³€ìˆ˜ì—ì„œ ì œê±°
          processingRequests.delete(requestKey);

          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }

      /* ===== ì°¸ê°€ì ì œì™¸ ê¸°ëŠ¥ ===== */
      // í•™ë²ˆ ë§ˆìŠ¤í‚¹ í—¬í¼ í•¨ìˆ˜ (ì „ì—­)
      function maskStudentIdGlobal(studentId) {
        if (!studentId) return "";
        if (studentId.length <= 4) return studentId;
        return studentId.substring(0, 4) + "*".repeat(studentId.length - 4);
      }

      // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ (onclick í•¸ë“¤ëŸ¬ì—ì„œ ì‚¬ìš©)
      window.confirmRemoveParticipant = async function (
        eventId,
        studentId,
        listType,
        restaurantId = null
      ) {
        // íšŒì¥ë‹¨ ê¶Œí•œ ì²´í¬
        if (!isFullAdmin()) {
          showAlert("ğŸ”’", "íšŒì¥ë‹¨ë§Œ ì°¸ê°€ìë¥¼ ì œì™¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }

        // ì´ë²¤íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) {
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ì°¸ê°€ì ì •ë³´ ì°¾ê¸°
        let participant = null;
        let participantName = "";

        if (restaurantId) {
          // ë¯¸ì‹íšŒ ê²½ìš°
          const restaurant = event.restaurants?.find(
            (r) => r.id === restaurantId
          );
          if (!restaurant) {
            showAlert("ğŸ˜¥", "ì‹ë‹¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          const list =
            listType === "reservations"
              ? restaurant.reservations
              : restaurant.waiting;
          participant = list?.find((p) => p.studentId === studentId);
          participantName = participant?.name || "";
        } else {
          // ì¼ë°˜ ì´ë²¤íŠ¸ ê²½ìš°
          const list =
            listType === "applicants" ? event.applicants : event.waiting;
          participant = list?.find((p) => p.studentId === studentId);
          participantName = participant?.name || "";
        }

        if (!participant) {
          showAlert("ğŸ˜¥", "ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // í™•ì¸ ë¬¸êµ¬
        const confirmMsg = `í•´ë‹¹ ì°¸ê°€ìë¥¼ ì œì™¸ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?\n\nì´ë¦„: ${participantName} (${maskStudentIdGlobal(
          studentId
        )})\nì´ë²¤íŠ¸: ${event.title}`;

        if (!confirm(confirmMsg)) {
          return;
        }

        // ì œì™¸ ì‹¤í–‰
        await removeParticipant(eventId, studentId, listType, restaurantId);
      };

      async function removeParticipant(
        eventId,
        studentId,
        listType,
        restaurantId = null
      ) {
        let wasRemoved = false;
        let eventTitle = "";

        try {
          await runTransaction(
            db,
            async (tx) => {
              const ref = doc(db, "events", eventId);
              const snap = await tx.get(ref);
              const ev = snap.data();
              eventTitle = ev.title;

              if (restaurantId) {
                // ë¯¸ì‹íšŒ ê²½ìš°
                const idx = ev.restaurants.findIndex(
                  (r) => r.id === restaurantId
                );
                if (idx === -1) throw new Error("restaurant not found");
                const r = ev.restaurants[idx];

                // ì°¸ê°€ì ì°¾ê¸° ë° ì œì™¸
                const before =
                  listType === "reservations"
                    ? r.reservations?.length
                    : r.waiting?.length;

                if (listType === "reservations") {
                  r.reservations = r.reservations.filter(
                    (p) => p.studentId !== studentId
                  );
                } else {
                  r.waiting = r.waiting.filter(
                    (p) => p.studentId !== studentId
                  );
                }

                ev.restaurants[idx] = r;
                tx.update(ref, { restaurants: ev.restaurants });

                wasRemoved =
                  (listType === "reservations"
                    ? r.reservations.length
                    : r.waiting.length) < before;
              } else {
                // ì¼ë°˜ ì´ë²¤íŠ¸ ê²½ìš°
                const before =
                  listType === "applicants"
                    ? ev.applicants?.length
                    : ev.waiting?.length;

                if (listType === "applicants") {
                  ev.applicants = ev.applicants.filter(
                    (p) => p.studentId !== studentId
                  );
                } else {
                  ev.waiting = ev.waiting.filter(
                    (p) => p.studentId !== studentId
                  );
                }

                tx.update(ref, {
                  applicants: ev.applicants,
                  waiting: ev.waiting,
                });

                wasRemoved =
                  (listType === "applicants"
                    ? ev.applicants.length
                    : ev.waiting.length) < before;
              }
            },
            TRANSACTION_OPTIONS
          );

          // transaction ì™„ë£Œ í›„ ì•Œë¦¼ ì „ì†¡
          if (wasRemoved) {
            await sendRemovalNotification(eventId, studentId, eventTitle);
          }

          showAlert("âœ…", "ì°¸ê°€ìê°€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
          renderReservationTab(isFullAdmin());
        } catch (error) {
          console.error("ì°¸ê°€ì ì œì™¸ ì˜¤ë¥˜:", error);
          if (error?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì°¸ê°€ì ì œì™¸ ì‹¤íŒ¨");
        }
      }

      async function sendRemovalNotification(eventId, studentId, eventTitle) {
        try {
          console.log("ğŸ“¤ ì°¸ê°€ì ì œì™¸ ì•Œë¦¼ ì „ì†¡ ì‹œë„:", {
            eventId,
            studentId,
            eventTitle,
          });

          // ì•Œë¦¼ ë°ì´í„° ìƒì„±
          const notificationData = {
            type: "participant_removed",
            eventId: eventId,
            eventTitle: eventTitle,
            studentId: studentId,
            message: `ì•ˆë…•í•˜ì„¸ìš”. ${eventTitle} ì´ë²¤íŠ¸ì—ì„œ ì°¸ê°€ìì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ìš´ì˜ì§„ì—ê²Œ ì—°ë½í•´ì£¼ì„¸ìš”.`,
            createdAt: new Date().toISOString(),
            read: false,
          };

          // ì•Œë¦¼ ì €ì¥ (notifications ì»¬ë ‰ì…˜ ì‚¬ìš©)
          await addDoc(collection(db, "notifications"), notificationData);
          console.log("âœ… ì°¸ê°€ì ì œì™¸ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ");
        } catch (error) {
          console.error("âŒ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:", error);
        }
      }

      /* ===== ì•Œë¦¼ UI ë Œë”ë§ ===== */
      function renderNotifications() {
        if (!currentUser) return;

        // í˜„ì¬ ì‚¬ìš©ìì˜ ì½ì§€ ì•Šì€ ì•Œë¦¼ í•„í„°
        const myNotifications = notificationsData.filter(
          (notif) => notif.studentId === currentUser.studentId && !notif.read
        );
        const unreadCount = myNotifications.length;

        // ì•Œë¦¼ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        const notificationBadge = document.getElementById("notification-badge");
        const notificationCount = document.getElementById("notification-count");

        if (notificationBadge) {
          // ë°›ì€í•¨ ë²„íŠ¼ì€ í•­ìƒ ë…¸ì¶œ, ë±ƒì§€ë§Œ í† ê¸€
          if (notificationCount) {
            if (unreadCount > 0) {
              notificationCount.textContent = unreadCount;
              notificationCount.classList.remove("hidden");
            } else {
              notificationCount.classList.add("hidden");
            }
          }
        }

        // ì•Œë¦¼ ëª©ë¡ ë Œë”ë§
        renderNotificationList();
      }

      function renderNotificationList() {
        if (!currentUser) return;

        const notificationList = document.getElementById("notification-list");
        if (!notificationList) return;

        // ëª¨ë“  ì•Œë¦¼ (ì½ì€ ê²ƒ í¬í•¨)
        const myNotifications = notificationsData
          .filter((notif) => notif.studentId === currentUser.studentId)
          .sort((a, b) => {
            const dateA = new Date(a.createdAt);
            const dateB = new Date(b.createdAt);
            return dateB - dateA;
          })
          .slice(0, 10); // ìµœê·¼ 10ê°œë§Œ í‘œì‹œ

        if (myNotifications.length === 0) {
          notificationList.innerHTML =
            '<div class="text-center text-gray-500 py-4">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }

        notificationList.innerHTML = myNotifications
          .map((notif) => {
            const date = new Date(notif.createdAt);
            const dateStr = date.toLocaleDateString("ko-KR", {
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            return `
                    <div class="py-3 border-b border-gray-100 hover:bg-gray-50 ${
                      notif.read ? "opacity-60" : ""
                    }" data-notif-id="${notif.id}">
                      <div class="flex items-start gap-3">
                        <div class="flex-1 min-w-0">
                          <p class="text-sm text-gray-800 ${
                            notif.read ? "" : "font-semibold"
                          }">${saf(
              notif.message || notif.eventTitle || "ì•Œë¦¼"
            )}</p>
                          <p class="text-xs text-gray-500 mt-1">${dateStr}</p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                          ${
                            !notif.read
                              ? '<div class="w-2 h-2 bg-orange-500 rounded-full"></div>'
                              : ""
                          }
                          <button
                            type="button"
                            class="text-gray-400 hover:text-red-600 transition-colors p-1"
                            onclick="deleteNotification('${notif.id}')"
                            title="ì‚­ì œ"
                          >
                            <i class="fas fa-times text-sm"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  `;
          })
          .join("");
      }

      // ì•Œë¦¼ ì‚­ì œ í•¨ìˆ˜
      window.deleteNotification = async function (notificationId) {
        if (!currentUser) return;

        if (!confirm("ì´ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        try {
          await deleteDoc(doc(db, "notifications", notificationId));
          showAlert("âœ…", "ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          renderNotificationList();
          renderNotifications(); // ë±ƒì§€ ì—…ë°ì´íŠ¸
        } catch (error) {
          console.error("ì•Œë¦¼ ì‚­ì œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì•Œë¦¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };

      /* ===== ìë™ ê¸€ ì˜¬ë¦¬ê¸° ê¸°ëŠ¥ ===== */
      async function scheduleAutoPost(
        type,
        title,
        datetime,
        customPostTime = null
      ) {
        try {
          // ê²Œì‹œ ì‹œê°„ ê²°ì •
          let postTime;
          if (customPostTime) {
            // ì‚¬ìš©ìê°€ ì§ì ‘ ì„¤ì •í•œ ì‹œê°„ ì‚¬ìš©
            postTime = new Date(customPostTime);
          } else {
            // ì´ë²¤íŠ¸ ì‹œê°„ 24ì‹œê°„ ì „ì— ì•Œë¦¼ ê¸€ ì˜¬ë¦¬ê¸°
            const eventTime = new Date(datetime);
            postTime = new Date(eventTime.getTime() - 24 * 60 * 60 * 1000); // 24ì‹œê°„ ì „
          }

          const now = new Date();

          // ê²Œì‹œ ì‹œê°„ ê²€ì¦ì€ ì•„ë˜ì—ì„œ ì²˜ë¦¬

          // ê²Œì‹œê¸€ ë‚´ìš© ìƒì„±
          const typeLabel =
            {
              tasting: "ë¯¸ì‹íšŒ",
              general: "ì¼ë°˜ ì´ë²¤íŠ¸",
              mt: "MT",
              assembly: "ì´íšŒ",
            }[type] || type;

          const postContent = `ğŸ½ï¸ ${typeLabel} ì•Œë¦¼ ğŸ½ï¸

      ğŸ“… ì¼ì‹œ: ${eventTime.toLocaleString("ko-KR")}
      ğŸ“ ì œëª©: ${title}

      ê³§ ì‹ ì²­ì´ ì‹œì‘ë©ë‹ˆë‹¤!
      ë§ì€ ì°¸ì—¬ ë¶€íƒë“œë ¤ìš”~ ğŸ˜Š

      #Foodie #${typeLabel}`;

          // ìë™ ê¸€ ì˜¬ë¦¬ê¸° ìŠ¤ì¼€ì¤„ ì €ì¥
          await addDoc(collection(db, "scheduledPosts"), {
            eventType: type,
            eventTitle: title,
            eventTime: datetime,
            postTime: postTime.toISOString(),
            content: postContent,
            status: "scheduled", // scheduled, posted, cancelled
            createdAt: new Date(),
            createdBy: currentUser?.studentId || "system",
          });

          // ê²Œì‹œ ì‹œê°„ì´ í˜„ì¬ ì‹œê°„ë³´ë‹¤ ì´ì „ì´ë©´ ì¦‰ì‹œ ê²Œì‹œ
          if (postTime <= now) {
            console.log(
              "ê²Œì‹œ ì‹œê°„ì´ í˜„ì¬ ì‹œê°„ë³´ë‹¤ ì´ì „ì´ë¯€ë¡œ ì¦‰ì‹œ ê²Œì‹œí•©ë‹ˆë‹¤."
            );
            await scheduleActualPost(postTime, postContent);
          } else {
            console.log(
              `ìë™ ê¸€ ì˜¬ë¦¬ê¸°ê°€ ${postTime.toLocaleString(
                "ko-KR"
              )}ì— ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.`
            );

            // ì‹¤ì œ ê¸€ ì˜¬ë¦¬ê¸° ìŠ¤ì¼€ì¤„ë§ (setTimeout ì‚¬ìš©)
            const delay = postTime.getTime() - now.getTime();
            setTimeout(async () => {
              await scheduleActualPost(postTime, postContent);
            }, delay);
          }
        } catch (error) {
          console.error("ìë™ ê¸€ ì˜¬ë¦¬ê¸° ìŠ¤ì¼€ì¤„ë§ ì˜¤ë¥˜:", error);
          // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì´ë²¤íŠ¸ ìƒì„±ì€ ê³„ì† ì§„í–‰
        }
      }

      // ì‹¤ì œ ê¸€ ì˜¬ë¦¬ê¸° í•¨ìˆ˜ (ì¦‰ì‹œ ì‹¤í–‰)
      async function scheduleActualPost(postTime, content) {
        try {
          await postAnnouncement(content);
          console.log("ìë™ ê¸€ ì˜¬ë¦¬ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("ìë™ ê¸€ ì˜¬ë¦¬ê¸° ì‹¤í–‰ ì˜¤ë¥˜:", error);
        }
      }

      // ê³µì§€ì‚¬í•­ ê²Œì‹œ í•¨ìˆ˜
      async function postAnnouncement(content) {
        try {
          // ê³µì§€ì‚¬í•­ ë¸”ë¡ ìƒì„±
          const announcementBlock = {
            type: "announcement",
            title: "ğŸ“¢ ê³µì§€ì‚¬í•­",
            content: content,
            createdAt: new Date(),
            createdBy: currentUser?.studentId || "system",
            isAuto: true, // ìë™ ìƒì„±ëœ ê³µì§€ì‚¬í•­ í‘œì‹œ
            order: 999, // ë§¨ ìœ„ì— í‘œì‹œ
          };

          // Firebaseì— ì €ì¥
          const docRef = await addDoc(
            collection(db, "homeLayout"),
            announcementBlock
          );

          console.log("ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤:", docRef.id);

          // blocksDataì— ì¶”ê°€
          if (!blocksData) blocksData = [];
          blocksData.push(announcementBlock);

          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          renderAll();

          // ì„±ê³µ ì•Œë¦¼
          showAlert("ğŸ“¢", "ì•Œë¦¼ ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!");
        } catch (error) {
          console.error("ê³µì§€ì‚¬í•­ ê²Œì‹œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ê³µì§€ì‚¬í•­ ê²Œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          throw error;
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜ˆì•½ëœ ê¸€ë“¤ í™•ì¸ ë° ì‹¤í–‰
      function checkScheduledPosts() {
        if (!currentUser || !adminList.includes(currentUser.studentId)) return;

        // í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆì•½ëœ ê¸€ë“¤ í™•ì¸
        const now = new Date();

        // Firebaseì—ì„œ scheduledPosts í™•ì¸ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” onSnapshot ì‚¬ìš©)
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ localStorageë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ˆì‹œ
        const scheduledPosts = JSON.parse(
          localStorage.getItem("scheduledPosts") || "[]"
        );

        scheduledPosts.forEach((post) => {
          const postTime = new Date(post.postTime);
          if (post.status === "scheduled" && postTime <= now) {
            scheduleActualPost(postTime, post.content);
          }
        });
      }

      /* ===== ì´ë²¤íŠ¸ ì €ì¥/ë³´ê´€/ì‚­ì œ/ì¬ê²Œì‹œ ===== */
      // ê¸°ì¡´ createOrSaveEvent í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ saveEventì™€ saveTastingEventë¡œ ëŒ€ì²´ë¨
      async function createOrSaveEvent_DEPRECATED() {
        const type = document.getElementById("event-type").value;
        const title = document.getElementById("event-title").value.trim();
        const datetime = document.getElementById("event-datetime").value;
        const deadline = document.getElementById("event-deadline").value;
        const limit =
          parseInt(document.getElementById("event-limit").value, 10) || 0;
        const status = document.getElementById("event-status").value;
        if (!type || !title || !datetime || !deadline || !limit)
          return showAlert(
            "ğŸ˜¥",
            "íƒ€ì…/ì œëª©/ì‹¤ì‹œì¼/ë§ˆê°ì¼/ì •ì›ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."
          );

        let payment = null;
        if (type === "mt" || type === "assembly") {
          const b = document.getElementById("pay-bank").value.trim();
          const n = document.getElementById("pay-number").value.trim();
          const h = document.getElementById("pay-holder").value.trim();
          const a = document.getElementById("pay-amount").value.trim();
          const note = document.getElementById("pay-note").value.trim();
          const d = duesSettings || {};
          payment = {
            bank: b || d.bank || "",
            number: n || d.number || "",
            holder: h || d.holder || "",
            amount: a ? parseInt(a) : d.amount ? parseInt(d.amount) : null,
            note:
              note ||
              (d.amount ? `íšŒë¹„ ${formatKRW(d.amount)} ` : "") + (d.note || ""),
          };
        }
        try {
          if (!editingEventId) {
            if (type === "tasting") {
              const rows = [
                ...document.querySelectorAll(
                  "#event-restaurants-wrap .restaurant-row"
                ),
              ];
              const restaurants = rows
                .map((row) => {
                  const categoryValue =
                    row.querySelector("[data-field='category']")?.value ||
                    "ê¸°íƒ€";
                  // restaurantCategoriesì— ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì¸ì§€ í™•ì¸
                  const categoryExists = restaurantCategories.some(
                    (cat) => cat.name === categoryValue
                  );
                  const finalCategory = categoryExists ? categoryValue : "ê¸°íƒ€";

                  return {
                    id: row.getAttribute("data-id"),
                    name: row.querySelector("[data-field='name']").value.trim(),
                    info: row.querySelector("[data-field='info']").value.trim(),
                    imageUrl: "",
                    capacity:
                      parseInt(
                        row.querySelector("[data-field='capacity']").value,
                        10
                      ) || limit,
                    category: finalCategory,
                    reservations: [],
                    waiting: [],
                  };
                })
                .filter((r) => r.name && r.capacity > 0);
              if (restaurants.length === 0)
                return showAlert("ğŸ˜¥", "ì‹ë‹¹ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
              await addDoc(collection(db, "events"), {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                restaurants,
              });
            } else {
              const base = {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                applicants: [],
                waiting: [],
              };
              if (payment) base.payment = payment;
              await addDoc(collection(db, "events"), base);
            }
            showAlert("ğŸ‰", "ì´ë²¤íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // ìë™ ê¸€ ì˜¬ë¦¬ê¸° ê¸°ëŠ¥
            const enableAutoPost =
              document.getElementById("enable-auto-post")?.checked;
            if (enableAutoPost) {
              const postTimeType = document.querySelector(
                'input[name="post-time-type"]:checked'
              )?.value;
              let customPostTime = null;

              if (postTimeType === "custom") {
                const postDatetime =
                  document.getElementById("post-datetime")?.value;
                if (postDatetime) {
                  customPostTime = postDatetime;
                }
              }

              await scheduleAutoPost(type, title, datetime, customPostTime);
            }

            closeEventModal();
            // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì „ì²´ í˜ì´ì§€ ë Œë”ë§)
            renderAll();
          } else {
            const ref = doc(db, "events", editingEventId);
            const snap = await getDoc(ref);
            if (!snap.exists()) throw new Error("not found");
            const prev = snap.data();
            if (type === "tasting") {
              const map = new Map(
                (prev.restaurants || []).map((r) => [r.id, r])
              );
              const rows = [
                ...document.querySelectorAll(
                  "#event-restaurants-wrap .restaurant-row"
                ),
              ];
              const restaurants = rows
                .map((row) => {
                  const idAttr = row.getAttribute("data-id");
                  const old = map.get(idAttr);
                  const categoryValue =
                    row.querySelector("[data-field='category']")?.value ||
                    "ê¸°íƒ€";
                  // restaurantCategoriesì— ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì¸ì§€ í™•ì¸
                  const categoryExists = restaurantCategories.some(
                    (cat) => cat.name === categoryValue
                  );
                  const finalCategory = categoryExists ? categoryValue : "ê¸°íƒ€";

                  return {
                    id: idAttr,
                    name: row.querySelector("[data-field='name']").value.trim(),
                    info: row.querySelector("[data-field='info']").value.trim(),
                    imageUrl:
                      row
                        .querySelector("[data-field='imageUrl']")
                        ?.value.trim() || "",
                    capacity:
                      parseInt(
                        row.querySelector("[data-field='capacity']").value,
                        10
                      ) || limit,
                    category: finalCategory,
                    reservations: old?.reservations || [],
                    waiting: old?.waiting || [],
                  };
                })
                .filter((r) => r.name && r.capacity > 0);
              await updateDoc(ref, {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                restaurants,
              });
            } else {
              const payload = {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
              };
              if (payment) payload.payment = payment;
              await updateDoc(ref, payload);
            }
            showAlert("âœ…", "ì´ë²¤íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeEventModal();
            // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì „ì²´ í˜ì´ì§€ ë Œë”ë§)
            renderAll();
          }
          resetEventForm();
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", `ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
      }
      // ê¸°ì¡´ resetEventForm í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ êµ¬ì¡°ë¡œ ëŒ€ì²´ë¨
      async function closeEvent(id) {
        if (
          !confirm(
            "ì´ë²¤íŠ¸ ì‹ ì²­ì„ ë§ˆê°í•˜ê³  ë³´ê´€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì¼ë°˜ íšŒì›ì—ê²ŒëŠ” ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤\nâ€¢ íšŒì¥ë‹¨ë§Œ ë³´ê´€ëœ ì´ë²¤íŠ¸ ëª©ë¡ì—ì„œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤\nâ€¢ ì‹ ì²­ì ëª…ë‹¨ì€ ëª¨ë‘ ë³´ì¡´ë©ë‹ˆë‹¤\nâ€¢ ì–¸ì œë“ ì§€ ë³µì› ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ ê³µê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            status: "archived",
            closedAt: new Date().toISOString(),
          });
          showAlert(
            "ğŸ“¦",
            "ì´ë²¤íŠ¸ê°€ ë§ˆê°ë˜ê³  ë³´ê´€ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ê´€ëœ ì´ë²¤íŠ¸ ëª©ë¡ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          );
        } catch {
          showAlert("ğŸ˜¥", "ë§ˆê° ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      }
      async function reopenEvent(id) {
        if (
          !confirm(
            "ë§ˆê°ëœ ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ì—´ì–´ ì‹ ì²­ì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì‹ ì²­ íƒ­ì— ë‹¤ì‹œ í‘œì‹œë©ë‹ˆë‹¤\nâ€¢ íšŒì›ë“¤ì´ ë‹¤ì‹œ ì‹ ì²­í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤\nâ€¢ ê¸°ì¡´ ì°¸ê°€ì ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          // ê¸°ì¡´ ì´ë²¤íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì°¸ê°€ì ì •ë³´ ë³´ì¡´ì„ ìœ„í•´)
          const eventDoc = await getDoc(doc(db, "events", id));
          if (!eventDoc.exists()) {
            showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const eventData = eventDoc.data();

          // ë””ë²„ê¹…: ê¸°ì¡´ ì°¸ê°€ì ì •ë³´ í™•ì¸
          console.log("ì¬ê°œì‹œ ì „ ì´ë²¤íŠ¸ ë°ì´í„°:", eventData);
          if (eventData.type === "tasting" && eventData.restaurants) {
            console.log("ê¸°ì¡´ restaurants:", eventData.restaurants);
            eventData.restaurants.forEach((r, idx) => {
              console.log(`ì‹ë‹¹ ${idx + 1} (${r.name}):`, {
                reservations: r.reservations?.length || 0,
                waiting: r.waiting?.length || 0,
              });
            });
          }

          // updateDocì€ ê¸°ë³¸ì ìœ¼ë¡œ mergeì´ë¯€ë¡œ, restaurantsë¥¼ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ë°°ì—´ì´ ìœ ì§€ë©ë‹ˆë‹¤
          // ìƒíƒœë§Œ ì—…ë°ì´íŠ¸í•˜ë©´ restaurants ë°°ì—´ì˜ ëª¨ë“  ì°¸ê°€ì ì •ë³´ê°€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤
          await updateDoc(doc(db, "events", id), {
            status: "open",
            reopenedAt: new Date().toISOString(),
          });

          // ì—…ë°ì´íŠ¸ í›„ í™•ì¸
          const updatedDoc = await getDoc(doc(db, "events", id));
          if (updatedDoc.exists()) {
            const updatedData = updatedDoc.data();
            console.log("ì¬ê°œì‹œ í›„ ì´ë²¤íŠ¸ ë°ì´í„°:", updatedData);
            if (updatedData.type === "tasting" && updatedData.restaurants) {
              updatedData.restaurants.forEach((r, idx) => {
                console.log(`ì‹ë‹¹ ${idx + 1} (${r.name}) - ì—…ë°ì´íŠ¸ í›„:`, {
                  reservations: r.reservations?.length || 0,
                  waiting: r.waiting?.length || 0,
                });
              });
            }
          }

          showAlert(
            "âœ…",
            "ì´ë²¤íŠ¸ê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤. ì‹ ì²­ íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          );
        } catch (error) {
          console.error("ì¬ê°œì‹œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë‹¤ì‹œ ì—´ê¸° ì‹¤íŒ¨: " + error.message);
        }
      }

      async function unpostEvent(id) {
        if (
          !confirm(
            "ì´ ì´ë²¤íŠ¸ì˜ ê³µì§€ì‚¬í•­ì„ ë‚´ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ê´€ë ¨ ê³µì§€ì‚¬í•­ì´ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤\nâ€¢ íšŒì›ë“¤ì´ ê³µì§€ì‚¬í•­ì„ ë³¼ ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          // ì´ë²¤íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const eventDoc = await getDoc(doc(db, "events", id));
          if (!eventDoc.exists()) {
            showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const eventData = eventDoc.data();
          const eventTitle = eventData.title;
          let foundAnnouncement = false;

          // 1. scheduledPosts ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì™€ ê´€ë ¨ëœ ì˜ˆì•½ëœ ê¸€ ì°¾ê¸°
          const scheduledPostsSnapshot = await getDocs(
            collection(db, "scheduledPosts")
          );
          for (const postDoc of scheduledPostsSnapshot.docs) {
            const postData = postDoc.data();
            if (
              postData.eventTitle === eventTitle &&
              postData.status !== "cancelled"
            ) {
              // ì˜ˆì•½ëœ ê¸€ì„ ì·¨ì†Œ ìƒíƒœë¡œ ë³€ê²½
              await updateDoc(doc(db, "scheduledPosts", postDoc.id), {
                status: "cancelled",
                cancelledAt: new Date().toISOString(),
                cancelledBy: currentUser?.studentId || "unknown",
              });
              foundAnnouncement = true;
            }
          }

          // 2. ê³µì§€ì‚¬í•­ ë¸”ë¡ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì™€ ê´€ë ¨ëœ ê³µì§€ì‚¬í•­ ì°¾ê¸°
          const blocksSnapshot = await getDocs(collection(db, "blocks"));
          for (const blockDoc of blocksSnapshot.docs) {
            const blockData = blockDoc.data();
            if (
              blockData.type === "announcement" &&
              blockData.payload &&
              blockData.payload.content &&
              blockData.payload.content.includes(eventTitle) &&
              blockData.visible !== false
            ) {
              // ê³µì§€ì‚¬í•­ ë¸”ë¡ì„ ìˆ¨ê¹€ ì²˜ë¦¬
              await updateDoc(doc(db, "blocks", blockDoc.id), {
                visible: false,
                unpostedAt: new Date().toISOString(),
                unpostedBy: currentUser?.studentId || "unknown",
              });
              foundAnnouncement = true;
            }
          }

          if (foundAnnouncement) {
            showAlert("âœ…", "ê³µì§€ì‚¬í•­ì´ ë‚´ë ¤ì¡ŒìŠµë‹ˆë‹¤.");
          } else {
            showAlert("â„¹ï¸", "ì´ ì´ë²¤íŠ¸ì™€ ê´€ë ¨ëœ ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("ê¸€ ë‚´ë¦¬ê¸° ì‹¤íŒ¨:", error);
          showAlert("ğŸ˜¥", "ê¸€ ë‚´ë¦¬ê¸° ì‹¤íŒ¨");
        }
      }
      async function archiveEvent(id) {
        try {
          await updateDoc(doc(db, "events", id), { status: "archived" });
          showAlert("ğŸ“¦", "ë³´ê´€(ìˆ¨ê¹€) ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ë³´ê´€ ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      }
      window.archiveEvent = archiveEvent;
      async function unarchiveEvent(id) {
        if (
          !confirm(
            "ë³´ê´€ëœ ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ê³µê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì‹ ì²­ íƒ­ì— ë‹¤ì‹œ í‘œì‹œë©ë‹ˆë‹¤\nâ€¢ ê¸°ì¡´ ì‹ ì²­ì ëª…ë‹¨ì´ ëª¨ë‘ ìœ ì§€ë©ë‹ˆë‹¤\nâ€¢ íšŒì›ë“¤ì´ ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            status: "open",
            unarchivedAt: new Date().toISOString(),
          });
          showAlert(
            "âœ…",
            "ì´ë²¤íŠ¸ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹ ì²­ íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          );
        } catch {
          showAlert("ğŸ˜¥", "ë³µì› ì‹¤íŒ¨");
        }
      }
      window.unarchiveEvent = unarchiveEvent;

      // ë³´ê´€ëœ ì´ë²¤íŠ¸ì— ì°¸ê°€ì ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
      async function openAddParticipantModal(eventId) {
        // ì´ë¯¸ ì—´ë ¤ ìˆëŠ” ì°¸ê°€ì ìˆ˜ì • ëª¨ë‹¬ì´ ìˆë‹¤ë©´ ì œê±°
        closeAddParticipantModal();

        const event = eventsData.find((e) => e.id === eventId);
        if (!event) {
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // í˜„ì¬ ì°¸ê°€ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const getCurrentParticipants = () => {
          if (event.type === "tasting" && event.restaurants) {
            const allParticipants = [];
            event.restaurants.forEach((r) => {
              (r.reservations || []).forEach((p) => {
                allParticipants.push({
                  studentId: p.studentId,
                  name: p.name,
                  restaurantId: r.id,
                  restaurantName: r.name,
                  type: "reservation",
                });
              });
              (r.waiting || []).forEach((p) => {
                allParticipants.push({
                  studentId: p.studentId,
                  name: p.name,
                  restaurantId: r.id,
                  restaurantName: r.name,
                  type: "waiting",
                });
              });
            });
            return allParticipants;
          } else {
            const participants = (event.applicants || []).map((p) => ({
              studentId: p.studentId,
              name: p.name,
              type: "applicant",
            }));
            const waiting = (event.waiting || []).map((w) => ({
              studentId: w.studentId,
              name: w.name,
              type: "waiting",
            }));
            return [...participants, ...waiting];
          }
        };

        const currentParticipants = getCurrentParticipants();
        const currentParticipantIds = currentParticipants.map(
          (p) => p.studentId
        );

        // ë¯¸ì‹íšŒì¸ ê²½ìš° ì‹ë‹¹ ì„ íƒ í¬í•¨
        let restaurantSelectHTML = "";
        if (event.type === "tasting" && event.restaurants) {
          restaurantSelectHTML = `
                  <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-utensils mr-2 text-orange-500"></i>ì‹ë‹¹ ì„ íƒ <span class="text-red-500">*</span>
                    </label>
                    <select id="participant-restaurant-select" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                      ${event.restaurants
                        .map(
                          (r) => `
                        <option value="${r.id}">${saf(r.name)} (${
                            r.reservations?.length || 0
                          }/${r.capacity || event.limit || 0}ëª…)</option>
                      `
                        )
                        .join("")}
                    </select>
                  </div>
                `;
        }

        // í˜„ì¬ ì°¸ê°€ì ëª©ë¡ HTML ìƒì„± (ì‹ë‹¹ í•„í„°ë§ ì§€ì›)
        const renderCurrentParticipants = (filteredParticipants = null) => {
          const participantsToShow =
            filteredParticipants !== null
              ? filteredParticipants
              : currentParticipants;

          if (participantsToShow.length === 0) {
            return '<p class="text-sm text-gray-400 italic text-center py-4">ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</p>';
          }

          return participantsToShow
            .map((p) => {
              const memberInfo = membersData?.find(
                (m) => m.studentId === p.studentId
              );
              return `
                      <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center gap-3 flex-1">
                          <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm">
                            ${(p.name || "").charAt(0) || "?"}
                          </div>
                          <div class="flex-1">
                            <div class="font-semibold text-gray-800">${saf(
                              p.name || "ì•Œ ìˆ˜ ì—†ìŒ"
                            )}</div>
                            <div class="text-xs text-gray-500">
                              ${p.studentId || ""}${
                memberInfo && memberInfo.college
                  ? ` Â· ${memberInfo.college}`
                  : ""
              }
                              ${
                                p.restaurantName
                                  ? ` Â· ${saf(p.restaurantName)}`
                                  : ""
                              }
                              ${
                                p.type === "waiting"
                                  ? ' <span class="text-amber-600 font-semibold">(ëŒ€ê¸°)</span>'
                                  : ""
                              }
                            </div>
                          </div>
                        </div>
                        <button
                          type="button"
                          class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors"
                          onclick="removeParticipantFromEvent('${eventId}', '${
                p.studentId
              }', ${p.restaurantId ? `'${p.restaurantId}'` : "null"}, '${saf(
                p.name
              )}')"
                        >
                          <i class="fas fa-trash mr-1"></i>ì œê±°
                        </button>
                      </div>
                    `;
            })
            .join("");
        };

        const modalHTML = `
                <div id="add-participant-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                      <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-gray-800">ì°¸ê°€ì ìˆ˜ì •</h3>
                        <button onclick="closeAddParticipantModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                          <i class="fas fa-times text-xl"></i>
                        </button>
                      </div>

                      <div class="mb-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
                        <p class="text-sm font-semibold text-gray-800 mb-1">
                          <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>${saf(
                            event.title
                          )}
                        </p>
                        <p class="text-xs text-gray-600">
                          ${new Date(event.datetime).toLocaleString("ko-KR")}
                        </p>
                      </div>

                      ${restaurantSelectHTML}

                      <!-- í˜„ì¬ ì°¸ê°€ì ëª©ë¡ -->
                      <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          <i class="fas fa-users mr-2 text-green-500"></i>í˜„ì¬ ì°¸ê°€ì <span class="text-gray-500 font-normal" id="participant-count">(${
                            currentParticipants.length
                          }ëª…)</span>
                        </label>
                        <div id="participant-current-list" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
                          ${renderCurrentParticipants()}
                        </div>
                      </div>

                      <!-- íšŒì› ê²€ìƒ‰ -->
                      <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                          <i class="fas fa-user-plus mr-2 text-blue-500"></i>íšŒì› ê²€ìƒ‰ ë° ìˆ˜ì •
                        </label>
                        <input
                          type="text"
                          id="participant-search-input"
                          placeholder="ì´ë¦„ ë˜ëŠ” í•™ë²ˆìœ¼ë¡œ ê²€ìƒ‰..."
                          class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                          autocomplete="off"
                        />
                        <div id="participant-search-results" class="mt-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-white">
                          <p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ íšŒì›ì„ ì°¾ì•„ì£¼ì„¸ìš”</p>
                        </div>
                      </div>

                      <div class="flex gap-3">
                        <button
                          onclick="closeAddParticipantModal()"
                          class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
                        >
                          ë‹«ê¸°
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ê²€ìƒ‰ ê¸°ëŠ¥ (ì¡°ëª¨ì„ ë°©ì‹ê³¼ ìœ ì‚¬)
        const searchInput = document.getElementById("participant-search-input");
        const searchResults = document.getElementById(
          "participant-search-results"
        );
        const currentList = document.getElementById("participant-current-list");
        const participantCount = document.getElementById("participant-count");
        const restaurantSelect = document.getElementById(
          "participant-restaurant-select"
        );

        // ì‹ë‹¹ ì„ íƒì— ë”°ë¥¸ ì°¸ê°€ì í•„í„°ë§
        const updateParticipantList = () => {
          let filteredParticipants = currentParticipants;

          // ë¯¸ì‹íšŒì´ê³  ì‹ë‹¹ ì„ íƒì´ ìˆìœ¼ë©´ í•´ë‹¹ ì‹ë‹¹ì˜ ì°¸ê°€ìë§Œ í•„í„°ë§
          if (
            event.type === "tasting" &&
            event.restaurants &&
            restaurantSelect
          ) {
            const selectedRestaurantId = restaurantSelect.value;
            if (selectedRestaurantId) {
              filteredParticipants = currentParticipants.filter(
                (p) => p.restaurantId === selectedRestaurantId
              );
            }
          }

          // ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸
          if (currentList) {
            currentList.innerHTML =
              renderCurrentParticipants(filteredParticipants);
          }

          // ì°¸ê°€ì ìˆ˜ ì—…ë°ì´íŠ¸
          if (participantCount) {
            participantCount.textContent = `(${filteredParticipants.length}ëª…)`;
          }
        };

        // ì‹ë‹¹ ì„ íƒ ë³€ê²½ ì‹œ ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸
        if (restaurantSelect) {
          restaurantSelect.addEventListener("change", () => {
            updateParticipantList();
            // ê²€ìƒ‰ ê²°ê³¼ë„ ìƒˆë¡œê³ ì¹¨ (ì„ íƒëœ ì‹ë‹¹ì˜ ì°¸ê°€ìëŠ” ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì œì™¸)
            if (searchInput.value) {
              searchParticipants(searchInput.value);
            }
          });
        }

        const searchParticipants = (searchTerm) => {
          if (!searchTerm.trim()) {
            searchResults.innerHTML =
              '<p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ íšŒì›ì„ ì°¾ì•„ì£¼ì„¸ìš”</p>';
            return;
          }

          // ë„ì–´ì“°ê¸°ë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ ê²€ìƒ‰ì–´ ì²˜ë¦¬
          const searchKeywords = searchTerm
            .trim()
            .split(/\s+/)
            .filter((keyword) => keyword.length > 0)
            .map((keyword) => keyword.toLowerCase());

          // ê° ê²€ìƒ‰ì–´ì— ë§¤ì¹­ë˜ëŠ” íšŒì›ë“¤ì„ ì°¾ê¸°
          const matchedMembers = new Map();

          // ì„ íƒëœ ì‹ë‹¹ì˜ ì°¸ê°€ì ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ë¯¸ì‹íšŒì¸ ê²½ìš°)
          let filteredParticipantIds = currentParticipantIds;
          if (
            event.type === "tasting" &&
            event.restaurants &&
            restaurantSelect
          ) {
            const selectedRestaurantId = restaurantSelect.value;
            if (selectedRestaurantId) {
              filteredParticipantIds = currentParticipants
                .filter((p) => p.restaurantId === selectedRestaurantId)
                .map((p) => p.studentId);
            }
          }

          searchKeywords.forEach((keyword) => {
            (membersData || []).forEach((m) => {
              const nameMatch = m.name?.toLowerCase().includes(keyword);
              const idMatch = m.studentId?.toLowerCase().includes(keyword);
              const isAlreadyParticipant = filteredParticipantIds.includes(
                m.studentId
              );
              const isActive = (m.status || "pending") === "active";

              if ((nameMatch || idMatch) && !isAlreadyParticipant && isActive) {
                matchedMembers.set(m.studentId || m.name, m);
              }
            });
          });

          const filtered = Array.from(matchedMembers.values()).slice(0, 50);

          if (filtered.length === 0) {
            searchResults.innerHTML =
              '<p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
          } else {
            searchResults.innerHTML = filtered
              .map((member) => {
                const matchedKeywords = searchKeywords.filter(
                  (keyword) =>
                    member.name?.toLowerCase().includes(keyword) ||
                    member.studentId?.toLowerCase().includes(keyword)
                );

                return `
                        <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                          <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">
                              ${member.name?.charAt(0) || "?"}
                            </div>
                            <div>
                              <div class="font-semibold text-gray-800">${saf(
                                member.name || "ì•Œ ìˆ˜ ì—†ìŒ"
                              )}</div>
                              <div class="text-xs text-gray-500">${
                                member.studentId || ""
                              } Â· ${member.college || ""}</div>
                              ${
                                matchedKeywords.length > 0
                                  ? `<div class="text-xs text-blue-500 mt-0.5">
                                      <i class="fas fa-search mr-1"></i>${matchedKeywords.join(
                                        ", "
                                      )} ê²€ìƒ‰ì–´ë¡œ ë§¤ì¹­
                                    </div>`
                                  : ""
                              }
                            </div>
                          </div>
                          <button
                            type="button"
                            class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-sm transition-colors"
                            onclick="addParticipantToEventQuick('${eventId}', '${
                  member.studentId
                }', '${saf(member.name).replace(/'/g, "\\'")}')"
                          >
                            <i class="fas fa-plus mr-1"></i>ì¶”ê°€
                          </button>
                        </div>
                      `;
              })
              .join("");
          }
        };

        searchInput.addEventListener("input", (e) => {
          searchParticipants(e.target.value);
        });

        // ì´ˆê¸° ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ ì‹¤í–‰
        if (searchInput.value) {
          searchParticipants(searchInput.value);
        }
      }
      window.openAddParticipantModal = openAddParticipantModal;

      // ì°¸ê°€ì ì¶”ê°€ ëª¨ë‹¬ ë‹«ê¸°
      function closeAddParticipantModal() {
        const modal = document.getElementById("add-participant-modal");
        if (modal) {
          modal.remove();
        }
      }
      window.closeAddParticipantModal = closeAddParticipantModal;

      // ë¹ ë¥¸ ì°¸ê°€ì ì¶”ê°€ í•¨ìˆ˜ (ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ë°”ë¡œ ì¶”ê°€)
      window.addParticipantToEventQuick = async function (
        eventId,
        studentId,
        memberName
      ) {
        try {
          const event = eventsData.find((e) => e.id === eventId);
          if (!event) {
            showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // ë¯¸ì‹íšŒì¸ ê²½ìš° ì‹ë‹¹ ì„ íƒ í™•ì¸
          if (event.type === "tasting" && event.restaurants) {
            const restaurantSelect = document.getElementById(
              "participant-restaurant-select"
            );
            if (!restaurantSelect) {
              showAlert("âš ï¸", "ì‹ë‹¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }
          }

          const member = { studentId, name: memberName };
          await addParticipantToEvent(eventId, member);

          // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            const event = eventsData.find((e) => e.id === eventId);
            if (event) {
              openAddParticipantModal(eventId);
            }
          }, 500);

          showAlert("âœ…", `${memberName} íšŒì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (error) {
          console.error("ì°¸ê°€ì ì¶”ê°€ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì°¸ê°€ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      };

      // ì°¸ê°€ì ì œê±° í•¨ìˆ˜
      window.removeParticipantFromEvent = async function (
        eventId,
        studentId,
        restaurantId,
        memberName
      ) {
        if (
          !confirm(`ì •ë§ë¡œ ${memberName} íšŒì›ì„ ì´ë²¤íŠ¸ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)
        ) {
          return;
        }

        try {
          const eventRef = doc(db, "events", eventId);

          await runTransaction(
            db,
            async (transaction) => {
              const eventDoc = await transaction.get(eventRef);
              if (!eventDoc.exists()) {
                throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }

              const eventData = eventDoc.data();

              if (
                eventData.type === "tasting" &&
                eventData.restaurants &&
                restaurantId
              ) {
                // ë¯¸ì‹íšŒì¸ ê²½ìš° íŠ¹ì • ì‹ë‹¹ì—ì„œ ì œê±°
                const restaurants = [...(eventData.restaurants || [])];
                const restaurantIndex = restaurants.findIndex(
                  (r) => r.id === restaurantId
                );

                if (restaurantIndex === -1) {
                  throw new Error("ì‹ë‹¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                const restaurant = restaurants[restaurantIndex];
                const reservations = [
                  ...(restaurant.reservations || []),
                ].filter((r) => r.studentId !== studentId);
                const waiting = [...(restaurant.waiting || [])].filter(
                  (w) => w.studentId !== studentId
                );

                restaurant.reservations = reservations;
                restaurant.waiting = waiting;
                restaurants[restaurantIndex] = restaurant;

                transaction.update(eventRef, { restaurants });
              } else {
                // ì¼ë°˜ ì´ë²¤íŠ¸ì¸ ê²½ìš°
                const applicants = [...(eventData.applicants || [])].filter(
                  (a) => a.studentId !== studentId
                );
                const waiting = [...(eventData.waiting || [])].filter(
                  (w) => w.studentId !== studentId
                );

                transaction.update(eventRef, { applicants, waiting });
              }
            },
            TRANSACTION_OPTIONS
          );

          showAlert("âœ…", `${memberName} íšŒì›ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);

          // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            const event = eventsData.find((e) => e.id === eventId);
            if (event) {
              openAddParticipantModal(eventId);
            }
          }, 500);

          // ì „ì²´ í™”ë©´ ìƒˆë¡œê³ ì¹¨
          scheduleRender();
        } catch (error) {
          console.error("ì°¸ê°€ì ì œê±° ì˜¤ë¥˜:", error);
          if (error?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì°¸ê°€ì ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      };
      async function addParticipantToEvent(eventId, member) {
        const eventRef = doc(db, "events", eventId);

        await runTransaction(
          db,
          async (transaction) => {
            const eventDoc = await transaction.get(eventRef);
            if (!eventDoc.exists()) {
              throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }

            const eventData = eventDoc.data();
            const participant = {
              studentId: member.studentId,
              name: member.name,
              appliedAt: new Date().toISOString(),
              timestamp: new Date().toISOString(),
            };

            if (eventData.type === "tasting" && eventData.restaurants) {
              // ë¯¸ì‹íšŒì¸ ê²½ìš°
              const restaurantSelect = document.getElementById(
                "participant-restaurant-select"
              );
              if (!restaurantSelect) {
                throw new Error("ì‹ë‹¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
              }

              const restaurantId = restaurantSelect.value;
              const restaurants = [...(eventData.restaurants || [])];

              const restaurantIndex = restaurants.findIndex(
                (r) => r.id === restaurantId
              );

              if (restaurantIndex === -1) {
                throw new Error("ì„ íƒí•œ ì‹ë‹¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }

              const restaurant = restaurants[restaurantIndex];
              const reservations = [...(restaurant.reservations || [])];
              const waiting = [...(restaurant.waiting || [])];

              // ì´ë¯¸ ì°¸ê°€ì ë˜ëŠ” ëŒ€ê¸°ìì¸ì§€ í™•ì¸
              const isAlreadyParticipant = reservations.some(
                (r) => r.studentId === member.studentId
              );
              const isAlreadyWaiting = waiting.some(
                (w) => w.studentId === member.studentId
              );

              if (isAlreadyParticipant || isAlreadyWaiting) {
                throw new Error("ì´ë¯¸ ì°¸ê°€ ì¤‘ì¸ íšŒì›ì…ë‹ˆë‹¤.");
              }

              // ì •ì› í™•ì¸
              const capacity = restaurant.capacity || eventData.limit || 0;
              if (reservations.length >= capacity) {
                // ì •ì›ì´ ê½‰ ì°¼ìœ¼ë©´ ëŒ€ê¸°ì—´ì— ì¶”ê°€
                waiting.push(participant);
                restaurant.waiting = waiting;
              } else {
                // ì •ì›ì´ ë‚¨ì•˜ìœ¼ë©´ ì°¸ê°€ì ëª©ë¡ì— ì¶”ê°€
                reservations.push(participant);
                restaurant.reservations = reservations;
              }

              restaurants[restaurantIndex] = restaurant;
              transaction.update(eventRef, { restaurants });
            } else {
              // ì¼ë°˜ ì´ë²¤íŠ¸ì¸ ê²½ìš°
              const applicants = [...(eventData.applicants || [])];
              const waiting = [...(eventData.waiting || [])];

              // ì´ë¯¸ ì°¸ê°€ì ë˜ëŠ” ëŒ€ê¸°ìì¸ì§€ í™•ì¸
              const isAlreadyParticipant = applicants.some(
                (a) => a.studentId === member.studentId
              );
              const isAlreadyWaiting = waiting.some(
                (w) => w.studentId === member.studentId
              );

              if (isAlreadyParticipant || isAlreadyWaiting) {
                throw new Error("ì´ë¯¸ ì°¸ê°€ ì¤‘ì¸ íšŒì›ì…ë‹ˆë‹¤.");
              }

              // ì •ì› í™•ì¸
              const limit = eventData.limit || 0;
              if (limit > 0 && applicants.length >= limit) {
                // ì •ì›ì´ ê½‰ ì°¼ìœ¼ë©´ ëŒ€ê¸°ì—´ì— ì¶”ê°€
                waiting.push(participant);
                transaction.update(eventRef, { waiting });
              } else {
                // ì •ì›ì´ ë‚¨ì•˜ê±°ë‚˜ ì œí•œì´ ì—†ìœ¼ë©´ ì°¸ê°€ì ëª©ë¡ì— ì¶”ê°€
                applicants.push(participant);
                transaction.update(eventRef, { applicants });
              }
            }
          },
          TRANSACTION_OPTIONS
        );
      }

      async function completeEvent(id) {
        if (
          !confirm(
            "í™œë™ì„ ì™„ì „íˆ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜ì‚¬í•­:\nâ€¢ ì´ë²¤íŠ¸ê°€ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤\nâ€¢ ì‹ ì²­ì ì •ë³´ëŠ” ëª¨ë‘ ë³´ì¡´ë©ë‹ˆë‹¤ (ë‚´ í™œë™ì—ì„œ ê³„ì† í‘œì‹œë¨)\nâ€¢ ë³´ê´€í•¨ì—ì„œë„ ì‚¬ë¼ì§‘ë‹ˆë‹¤\nâ€¢ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤\n\nì •ë§ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
          )
        ) {
          return;
        }
        try {
          // ì´ë²¤íŠ¸ë¥¼ ì™„ì „íˆ ì¢…ë£Œ (completed ìƒíƒœë¡œ ë³€ê²½)
          await updateDoc(doc(db, "events", id), {
            status: "completed",
            completedAt: new Date().toISOString(),
            completedBy: currentUser?.studentId || "unknown",
          });
          showAlert(
            "âœ…",
            "í™œë™ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ê°€ìë“¤ì€ ë‚´ í™œë™ì—ì„œ ê³„ì† í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          );
        } catch (error) {
          console.error("í™œë™ ì¢…ë£Œ ì‹¤íŒ¨:", error);
          showAlert("ğŸ˜¥", "í™œë™ ì¢…ë£Œ ì‹¤íŒ¨");
        }
      }

      async function confirmActivity(id) {
        if (
          !confirm(
            "ì´ í™œë™ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì°¸ê°€ìë“¤ì—ê²Œ í™•ì • ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤\nâ€¢ í™œë™ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œëœ ê²ƒìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            activityStatus: "confirmed",
            confirmedAt: new Date().toISOString(),
            confirmedBy: currentUser?.studentId || "unknown",
          });
          showAlert("âœ…", "í™œë™ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("í™œë™ í™•ì • ì‹¤íŒ¨:", error);
          showAlert("ğŸ˜¥", "í™œë™ í™•ì • ì‹¤íŒ¨");
        }
      }

      async function cancelActivity(id) {
        if (
          !confirm(
            "ì´ í™œë™ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì°¸ê°€ìë“¤ì—ê²Œ ì·¨ì†Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤\nâ€¢ í™˜ë¶ˆ ë“±ì˜ í›„ì† ì¡°ì¹˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            activityStatus: "cancelled",
            cancelledAt: new Date().toISOString(),
            cancelledBy: currentUser?.studentId || "unknown",
          });
          showAlert("âŒ", "í™œë™ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("í™œë™ ì·¨ì†Œ ì‹¤íŒ¨:", error);
          showAlert("ğŸ˜¥", "í™œë™ ì·¨ì†Œ ì‹¤íŒ¨");
        }
      }

      // ìë™ ì‹ ì²­ ë§ˆê° ê¸°ëŠ¥
      async function autoCloseExpiredEvents() {
        if (!currentUser || !isFullAdmin()) return;
        if (!Array.isArray(eventsData) || eventsData.length === 0) return;

        const now = Date.now();
        const expired = eventsData.filter((event) => {
          if (!event || !event.id) return false;
          if (
            ["closed", "archived", "completed", "deleted"].includes(
              event.status
            )
          )
            return false;
          if (!event.deadline) return false;
          // ì´ë¯¸ ìë™ ë§ˆê° ì²˜ë¦¬í•œ ì´ë²¤íŠ¸ëŠ” ë‹¤ì‹œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
          if (event.autoClosedReason === "deadline_expired") return false;

          const deadlineTime = new Date(event.deadline).getTime();
          if (Number.isNaN(deadlineTime)) return false;
          return deadlineTime < now;
        });

        if (expired.length === 0) return;

        const timestamp = new Date().toISOString();
        let processedCount = 0;

        for (const event of expired) {
          try {
            await updateDoc(doc(db, "events", event.id), {
              status: "archived",
              autoClosedAt: timestamp,
              autoClosedReason: "deadline_expired",
            });
            processedCount++;
            console.log(
              `ìë™ ë§ˆê° ì²˜ë¦¬: ${event.title || event.id} (ë§ˆê°ì¼: ${
                event.deadline
              })`
            );
          } catch (error) {
            console.error("ìë™ ë§ˆê° ì²˜ë¦¬ ì‹¤íŒ¨:", {
              eventId: event.id,
              message: error?.message || error,
            });
          }
        }

        if (processedCount > 0) {
          console.log(
            `ì´ ${processedCount}ê°œì˜ ì´ë²¤íŠ¸ê°€ ìë™ ë§ˆê° ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
          if (isFullAdmin()) {
            showAlert(
              "â°",
              `${processedCount}ê°œì˜ ì´ë²¤íŠ¸ê°€ ë§ˆê°ì¼ ë„ê³¼ë¡œ ìë™ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.`
            );
          }
        }
      }

      function clearAutoCloseScheduler() {
        if (autoCloseMinuteIntervalId) {
          clearInterval(autoCloseMinuteIntervalId);
          autoCloseMinuteIntervalId = null;
        }
        if (autoCloseHourlyIntervalId) {
          clearInterval(autoCloseHourlyIntervalId);
          autoCloseHourlyIntervalId = null;
        }
        if (autoCloseHourlyTimeoutId) {
          clearTimeout(autoCloseHourlyTimeoutId);
          autoCloseHourlyTimeoutId = null;
        }
        autoCloseSchedulerStarted = false;
      }

      // ìë™ ë§ˆê° ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •
      function setupAutoCloseScheduler() {
        if (autoCloseSchedulerStarted) return;
        if (!currentUser || !isFullAdmin()) return;

        autoCloseSchedulerStarted = true;
        const runAutoClose = () => {
          autoCloseExpiredEvents().catch((error) =>
            console.error("ìë™ ë§ˆê° ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹¤íŒ¨:", error)
          );
        };

        runAutoClose();

        autoCloseMinuteIntervalId = setInterval(runAutoClose, 60 * 1000);

        const now = new Date();
        const minutesUntilNextHour = 60 - now.getMinutes();
        const secondsUntilNextHour =
          minutesUntilNextHour * 60 - now.getSeconds();
        const msUntilNextHour = Math.max(secondsUntilNextHour, 1) * 1000;

        autoCloseHourlyTimeoutId = setTimeout(() => {
          runAutoClose();
          autoCloseHourlyIntervalId = setInterval(runAutoClose, 60 * 60 * 1000);
        }, msUntilNextHour);

        debugLog("ìë™ ì‹ ì²­ ë§ˆê° ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
      async function deleteEvent(id) {
        const event = eventsData.find((e) => e.id === id);
        if (!event) {
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ë¯¸ì‹íšŒì´ê³  ë¦¬ë·°ê°€ ìˆëŠ” ê²½ìš° ì‚­ì œ ë°©ì§€
        if (
          event.type === "tasting" &&
          event.reviews &&
          event.reviews.length > 0
        ) {
          showAlert(
            "â›”",
            `<div class="text-left">
                    <p class="font-bold mb-2">ë¯¸ì‹íšŒ í›„ê¸°ê°€ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                    <p class="text-sm">â€¢ í˜„ì¬ <strong>${event.reviews.length}ê°œì˜ í›„ê¸°</strong>ê°€ ì‘ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤</p>
                    <p class="text-sm">â€¢ ë¯¸ì‹íšŒ í›„ê¸°ëŠ” íšŒì›ë“¤ì˜ ì†Œì¤‘í•œ ê¸°ë¡ì…ë‹ˆë‹¤</p>
                    <p class="text-sm mt-2 text-gray-600">ğŸ’¡ Tip: í›„ê¸°ë¥¼ ëª¨ë‘ ì‚­ì œí•œ í›„ ì´ë²¤íŠ¸ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                  </div>`
          );
          return;
        }

        if (
          !confirm(
            `ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ì–´ìš”?\n\nâš ï¸ ì£¼ì˜:\nâ€¢ ì´ë²¤íŠ¸ê°€ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤\nâ€¢ ë‚´ í™œë™ íƒ­ì—ì„œë„ ë³´ì´ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤\nâ€¢ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          )
        ) {
          return;
        }

        try {
          // statusë¥¼ 'deleted'ë¡œ ë³€ê²½ (ì™„ì „ ì‚­ì œê°€ ì•„ë‹Œ ìˆ¨ê¹€)
          await updateDoc(doc(db, "events", id), {
            status: "deleted",
            deletedAt: new Date().toISOString(),
          });
          showAlert(
            "ğŸ—‘ï¸",
            "ì´ë²¤íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (ë‚´ í™œë™ì—ì„œë„ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤)"
          );
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ì‚­ì œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", `ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
      }

      async function cancelEventForAdmin(id) {
        if (!isFullAdmin()) {
          showAlert("ğŸ”’", "íšŒì¥ë‹¨ ì´ìƒë§Œ í™œë™ì„ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }

        const event = eventsData.find((e) => e.id === id);
        if (!event) {
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const confirmMessage = [
          "ì´ í™œë™ì„ ì‚­ì œí•˜ë©´:",
          "â€¢ ëª¨ë“  ì‹ ì²­ìì™€ ëŒ€ê¸°ìëŠ” ë” ì´ìƒ í™œë™ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
          "â€¢ 'ë‚´ í™œë™' íƒ­ì—ì„œë„ ì™„ì „íˆ ì‚¬ë¼ì§‘ë‹ˆë‹¤.",
          "â€¢ ì‘ì„±ëœ ë¯¸ì‹íšŒ í›„ê¸°ëŠ” ê·¸ëŒ€ë¡œ ë³´ê´€ë©ë‹ˆë‹¤.",
          "",
          "ì •ë§ë¡œ í™œë™ì„ ì·¨ì†Œ(ì‚­ì œ)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
        ].join("\n");

        if (!confirm(confirmMessage)) return;

        const verification = prompt(
          'í™œë™ì„ ì™„ì „íˆ ì·¨ì†Œí•˜ë ¤ë©´ "í™œë™ì·¨ì†Œ"ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',
          ""
        );

        if (verification !== "í™œë™ì·¨ì†Œ") {
          showAlert(
            "âš ï¸",
            'í™œë™ ì·¨ì†Œê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. "í™œë™ì·¨ì†Œ"ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.'
          );
          return;
        }

        try {
          await updateDoc(doc(db, "events", id), {
            status: "deleted",
            deletedAt: new Date().toISOString(),
            deletedBy: currentUser?.studentId || "admin",
          });
          showAlert("ğŸ—‘ï¸", "í™œë™ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("í™œë™ ì·¨ì†Œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", `í™œë™ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
      }
      // ==================== ì¡°ì§œê¸° ê¸°ëŠ¥ (ìƒˆ ë²„ì „ - ê°„ë‹¨ëª…ë£Œ) ====================

      // ì¡°ì¥ ì„ íƒê¸° ì—…ë°ì´íŠ¸ (ë¨¼ì € ì •ì˜)
      function updateLeaderSelectorsNew(
        participants,
        groupCount,
        preserveSelections = false
      ) {
        const container = document.getElementById("leader-selectors-new");
        if (!container) return;

        // ê¸°ì¡´ ì„ íƒ ì •ë³´ ì €ì¥ (preserveSelectionsê°€ trueì¼ ë•Œë§Œ)
        const previousSelections = {};
        if (preserveSelections) {
          container.querySelectorAll(".leader-select-new").forEach((select) => {
            if (select.value) {
              previousSelections[select.dataset.group] = select.value;
            }
          });
        }

        // ëª¨ë“  ì„ íƒê¸°ì—ì„œ ì„ íƒëœ ì¡°ì¥ë“¤ ìˆ˜ì§‘
        const selectedLeaders = new Set(Object.values(previousSelections));

        container.innerHTML = "";
        for (let i = 1; i <= groupCount; i++) {
          const currentSelection = previousSelections[i] || "";

          container.innerHTML += `
                  <div class="flex items-center gap-2 p-2 bg-white border rounded-lg">
                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-400 rounded-full flex items-center justify-center text-white font-bold">
                      ${i}
                    </div>
                    <select class="leader-select-new flex-1 px-3 py-2 border rounded-lg text-sm focus:border-yellow-400" data-group="${i}">
                      <option value="">ì¡°ì¥ ì„ íƒ</option>
                      ${participants
                        .map((p) => {
                          // ì´ë¯¸ ë‹¤ë¥¸ ì¡°ì—ì„œ ì„ íƒëœ ì¡°ì¥ì€ ë¹„í™œì„±í™” (í˜„ì¬ ì¡°ì˜ ì„ íƒì€ ì œì™¸)
                          const isSelected =
                            selectedLeaders.has(p.studentId) &&
                            currentSelection !== p.studentId;
                          const selectedAttr =
                            currentSelection === p.studentId ? "selected" : "";
                          const disabledAttr = isSelected ? "disabled" : "";
                          const label = isSelected
                            ? `${p.name} (ì´ë¯¸ ì„ íƒë¨)`
                            : `${p.name} (${p.gender}/${p.college})`;
                          return `<option value="${p.studentId}" ${selectedAttr} ${disabledAttr}>${label}</option>`;
                        })
                        .join("")}
                    </select>
                  </div>
                `;
        }

        // ì¡°ì¥ ì„ íƒ ì‹œ ë‹¤ë¥¸ ì„ íƒê¸° ì—…ë°ì´íŠ¸
        container.querySelectorAll(".leader-select-new").forEach((select) => {
          select.addEventListener("change", () => {
            updateLeaderSelectorsNew(participants, groupCount, true);
          });
        });
      }

      // ì¡° ìƒì„± ì•Œê³ ë¦¬ì¦˜ (ë¼ìš´ë“œ ë¡œë¹ˆ)
      function createGroupsNew(
        participants,
        groupCount,
        genderBalance,
        collegeMix,
        leaderMode
      ) {
        const groups = Array.from({ length: groupCount }, () => []);
        // ê¸°ì¡´ isLeader í”Œë˜ê·¸ ì œê±°í•˜ê³  ë³µì‚¬
        const members = participants.map((p) => {
          const clean = { ...p };
          delete clean.isLeader;
          return clean;
        });

        // 1. ìˆ˜ë™ ì¡°ì¥ ì„ íƒ
        const selectedLeaders = new Set();
        const manualLeaderAssignments = []; // ì¡°ì¥ í• ë‹¹ ì •ë³´ ì €ì¥

        if (leaderMode === "manual") {
          document.querySelectorAll(".leader-select-new").forEach((select) => {
            const leaderStudentId = select.value;
            if (leaderStudentId && !selectedLeaders.has(leaderStudentId)) {
              selectedLeaders.add(leaderStudentId);
              const leaderIdx = members.findIndex(
                (p) => p.studentId === leaderStudentId
              );
              if (leaderIdx >= 0) {
                const leader = members.splice(leaderIdx, 1)[0];
                leader.isLeader = true;
                const groupIdx = parseInt(select.dataset.group) - 1;

                // ì¡°ì¥ì„ ë§¨ ì•ì— ë°°ì¹˜
                groups[groupIdx].unshift(leader);

                manualLeaderAssignments.push({
                  studentId: leaderStudentId,
                  name: leader.name,
                  groupIdx: groupIdx,
                });

                console.log(
                  `ğŸ‘‘ ì¡°ì¥ ë°°ì¹˜: ${leader.name} â†’ ${groupIdx + 1}ì¡° (ë§¨ ì•)`
                );
              }
            }
          });

          if (manualLeaderAssignments.length > 0) {
            console.log("âœ… ìˆ˜ë™ ì¡°ì¥ ë°°ì¹˜ ì™„ë£Œ:", manualLeaderAssignments);
          }
        }

        // 2. ë‚˜ë¨¸ì§€ ì¸ì› ë°°ì¹˜
        // ì¡°ì¥ì´ ë°°ì¹˜ëœ ì¡°ë¥¼ ê³ ë ¤í•˜ì—¬ ê°€ì¥ ì ì€ ì¸ì›ì„ ê°€ì§„ ì¡°ë¶€í„° ë°°ì¹˜
        const getSmallestGroupIdx = () => {
          const sizes = groups.map((g, idx) => ({ idx, size: g.length }));
          // ì¡°ì¥ì´ ì—†ëŠ” ì¡°ë¥¼ ìš°ì„  ì„ íƒ
          const groupsWithoutLeader = sizes.filter(
            (s) => !groups[s.idx].some((m) => m.isLeader)
          );
          if (groupsWithoutLeader.length > 0) {
            // ì¡°ì¥ì´ ì—†ëŠ” ì¡° ì¤‘ ê°€ì¥ ì‘ì€ ì¡°
            groupsWithoutLeader.sort((a, b) => a.size - b.size);
            return groupsWithoutLeader[0].idx;
          }
          // ëª¨ë“  ì¡°ì— ì¡°ì¥ì´ ìˆìœ¼ë©´ ê°€ì¥ ì‘ì€ ì¡°
          sizes.sort((a, b) => a.size - b.size);
          return sizes[0].idx;
        };

        if (genderBalance && collegeMix) {
          // ì„±ë³„ + í•™ê³¼ ê· í˜•
          const byGenderCollege = {};
          members.forEach((p) => {
            const key = `${p.gender}-${p.college || "ê¸°íƒ€"}`;
            if (!byGenderCollege[key]) byGenderCollege[key] = [];
            byGenderCollege[key].push(p);
          });

          Object.values(byGenderCollege).forEach((list) =>
            list.sort(() => Math.random() - 0.5)
          );

          Object.keys(byGenderCollege)
            .sort()
            .forEach((key) => {
              byGenderCollege[key].forEach((member) => {
                const smallestIdx = getSmallestGroupIdx();
                groups[smallestIdx].push(member);
              });
            });
        } else if (genderBalance) {
          // ì„±ë³„ë§Œ ê· í˜•
          const males = members
            .filter((p) => p.gender === "ë‚¨ì„±")
            .sort(() => Math.random() - 0.5);
          const females = members
            .filter((p) => p.gender === "ì—¬ì„±")
            .sort(() => Math.random() - 0.5);
          const others = members
            .filter((p) => p.gender !== "ë‚¨ì„±" && p.gender !== "ì—¬ì„±")
            .sort(() => Math.random() - 0.5);

          [males, females, others].forEach((list) => {
            list.forEach((member) => {
              const smallestIdx = getSmallestGroupIdx();
              groups[smallestIdx].push(member);
            });
          });
        } else if (collegeMix) {
          // í•™ê³¼ë§Œ ê· í˜•
          const byCollege = {};
          members.forEach((p) => {
            const college = p.college || "ê¸°íƒ€";
            if (!byCollege[college]) byCollege[college] = [];
            byCollege[college].push(p);
          });

          Object.values(byCollege).forEach((list) =>
            list.sort(() => Math.random() - 0.5)
          );

          Object.keys(byCollege)
            .sort()
            .forEach((college) => {
              byCollege[college].forEach((member) => {
                const smallestIdx = getSmallestGroupIdx();
                groups[smallestIdx].push(member);
              });
            });
        } else {
          // ë¬´ì‘ìœ„
          members.sort(() => Math.random() - 0.5);
          members.forEach((member) => {
            const smallestIdx = getSmallestGroupIdx();
            groups[smallestIdx].push(member);
          });
        }

        // 3. ì¸ì› ê· í˜• ë§ì¶”ê¸°
        for (let iter = 0; iter < 10; iter++) {
          const sizes = groups.map((g) => g.length);
          const maxSize = Math.max(...sizes);
          const minSize = Math.min(...sizes);
          if (maxSize - minSize <= 1) break;

          const maxIdx = sizes.indexOf(maxSize);
          const minIdx = sizes.indexOf(minSize);
          const memberToMove = groups[maxIdx]
            .slice()
            .reverse()
            .find((m) => !m.isLeader);

          if (memberToMove) {
            groups[maxIdx].splice(groups[maxIdx].indexOf(memberToMove), 1);
            groups[minIdx].push(memberToMove);
          }
        }

        // 4. ìë™ ì¡°ì¥ ì„¤ì • (ë˜ëŠ” ìˆ˜ë™ ëª¨ë“œì—ì„œ ì¡°ì¥ ë¯¸ì„ íƒ ì‹œ ìë™ ì„¤ì •)
        if (leaderMode === "auto" || leaderMode === "manual") {
          groups.forEach((group, idx) => {
            if (group.length > 0 && !group.some((m) => m.isLeader)) {
              group[0].isLeader = true;
              console.log(`ğŸ‘‘ ìë™ ì¡°ì¥ ì„¤ì •: ${group[0].name} â†’ ${idx + 1}ì¡°`);
            }
          });
        }

        // 5. ì¡°ì¥ì„ ë§¨ ì•ìœ¼ë¡œ (ì•ˆì „ì¥ì¹˜)
        groups.forEach((group, idx) => {
          const leaderIdx = group.findIndex((m) => m.isLeader);
          if (leaderIdx > 0) {
            console.log(
              `âš ï¸ ì¡°ì¥ì´ ${leaderIdx + 1}ë²ˆì§¸ì— ìˆìŒ. ë§¨ ì•ìœ¼ë¡œ ì´ë™: ${
                group[leaderIdx].name
              } (${idx + 1}ì¡°)`
            );
            const [leader] = group.splice(leaderIdx, 1);
            group.unshift(leader);
          } else if (leaderIdx === 0) {
            console.log(
              `âœ… ${idx + 1}ì¡° ì¡°ì¥ í™•ì¸: ${group[0].name} (ì´ë¯¸ ë§¨ ì•)`
            );
          }
        });

        // ìµœì¢… ê²°ê³¼ ë¡œê·¸
        console.log("ğŸ¯ ìµœì¢… ì¡° í¸ì„± ê²°ê³¼:");
        groups.forEach((group, idx) => {
          const leader = group.find((m) => m.isLeader);
          console.log(
            `${idx + 1}ì¡° (${group.length}ëª…): ì¡°ì¥=${
              leader?.name || "ì—†ìŒ"
            }, ë©¤ë²„=[${group.map((m) => m.name).join(", ")}]`
          );
        });

        return groups;
      }

      // ê²°ê³¼ í‘œì‹œ
      function showGroupResultsNew(eventId, groups) {
        const ev = eventsData.find((e) => e.id === eventId);
        const totalMembers = groups.reduce((sum, g) => sum + g.length, 0);

        const resultsHTML = `
                <div id="group-results-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex justify-between items-center">
                      <div>
                        <h3 class="text-2xl font-bold text-white">ì¡° í¸ì„± ê²°ê³¼</h3>
                        <p class="text-purple-100 text-sm">${
                          ev.title
                        } - ì´ ${totalMembers}ëª… / ${groups.length}ê°œ ì¡°</p>
                      </div>
                      <button onclick="document.getElementById('group-results-modal').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                        <i class="fas fa-times text-xl"></i>
                      </button>
                    </div>

                    <div class="p-6 overflow-y-auto flex-1">
                      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${groups
                          .map(
                            (group, idx) => `
                          <div class="border-2 border-purple-200 rounded-xl p-4 hover:shadow-lg transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                              <h4 class="text-xl font-bold text-purple-600">${
                                idx + 1
                              }ì¡°</h4>
                              <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-bold">${
                                group.length
                              }ëª…</span>
                            </div>
                            <div class="space-y-2">
                              ${group
                                .map(
                                  (member) => `
                                <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                                  ${
                                    member.isLeader
                                      ? '<i class="fas fa-crown text-yellow-500 text-lg"></i>'
                                      : '<div class="w-5"></div>'
                                  }
                                  <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-gray-900">${
                                      member.name
                                    }</div>
                                    <div class="text-xs text-gray-500">${
                                      member.gender
                                    } / ${member.college}</div>
                                  </div>
                                </div>
                              `
                                )
                                .join("")}
                            </div>
                          </div>
                        `
                          )
                          .join("")}
                      </div>
                    </div>

                    <div class="px-6 py-4 bg-gray-50 border-t flex gap-3">
                      <button onclick="document.getElementById('group-results-modal').remove(); openGroupMakerModal('${eventId}')"
                        class="px-6 py-3 border-2 border-purple-300 text-purple-700 rounded-xl hover:bg-purple-50 font-semibold">
                        <i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì§œê¸°
                      </button>
                      <button onclick="document.getElementById('group-results-modal').remove()"
                        class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 font-semibold">
                        <i class="fas fa-check mr-2"></i>í™•ì¸
                      </button>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", resultsHTML);
      }

      // ì¡°ì§œê¸° ëª¨ë‹¬ ì—´ê¸°
      window.openGroupMakerModal = async function (eventId) {
        const ev = eventsData.find((e) => e.id === eventId);
        if (!ev) return showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        // ì°¸ê°€ì ëª©ë¡ ìˆ˜ì§‘
        let participants = [];
        if (ev.type === "tasting") {
          (ev.restaurants || []).forEach((r) => {
            (r.reservations || []).forEach((p) => {
              if (!participants.find((x) => x.studentId === p.studentId)) {
                participants.push(p);
              }
            });
          });
        } else {
          participants = ev.applicants || [];
        }

        if (participants.length === 0) {
          return showAlert("ğŸ˜¥", "ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        // ê¸°ì¡´ ëª¨ë‹¬ë“¤ ëª¨ë‘ ì œê±°
        document.getElementById("group-maker-modal")?.remove();
        document.getElementById("group-results-modal")?.remove();

        // ê°„ë‹¨í•œ ëª¨ë‹¬ HTML
        const modalHTML = `
                              <div id="group-maker-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                                  <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex justify-between items-center">
                                      <div>
                                        <h3 class="text-2xl font-bold text-white">íŒ€ êµ¬ì„±í•˜ê¸°</h3>
                        <p class="text-purple-100 text-sm">ì°¸ê°€ì ${participants.length}ëª…ì„ ì¡°ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤</p>
                                      </div>
                      <button type="button" id="group-maker-close-btn" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-colors">
                          <i class="fas fa-times text-xl"></i>
                        </button>
                      </div>

                    <div class="p-6 overflow-y-auto flex-1 space-y-4">
                      <div class="border-2 border-gray-200 rounded-xl p-4">
                        <label class="block text-lg font-bold text-gray-800 mb-2">
                          <i class="fas fa-users mr-2 text-purple-600"></i>ì¡° ê°œìˆ˜
                        </label>
                        <input type="number" id="group-count-new" min="2" max="10" value="3"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-bold focus:border-purple-500">
                      </div>

                      <div class="border-2 border-gray-200 rounded-xl p-4">
                        <label class="block text-lg font-bold text-gray-800 mb-3">
                          <i class="fas fa-balance-scale mr-2 text-blue-600"></i>ê· í˜• ì˜µì…˜
                        </label>
                        <div class="space-y-2">
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="gender-balance-new" checked class="w-5 h-5">
                            <span>ì„±ë³„ ê· í˜• ë§ì¶”ê¸°</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="college-mix-new" checked class="w-5 h-5">
                            <span>í•™ê³¼ ê³ ë¥´ê²Œ ì„ê¸°</span>
                          </label>
                        </div>
                      </div>

                      <div class="border-2 border-gray-200 rounded-xl p-4">
                        <label class="block text-lg font-bold text-gray-800 mb-3">
                          <i class="fas fa-crown mr-2 text-yellow-600"></i>ì¡°ì¥ ì„¤ì •
                        </label>
                        <div class="space-y-2 mb-3">
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="leader-mode-new" value="manual" checked class="w-5 h-5">
                            <span>ìˆ˜ë™ìœ¼ë¡œ ì„ íƒ</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="leader-mode-new" value="auto" class="w-5 h-5">
                            <span>ìë™ ì„¤ì • (ê° ì¡° ì²« ë²ˆì§¸ ì‚¬ëŒ)</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="leader-mode-new" value="none" class="w-5 h-5">
                            <span>ì¡°ì¥ ì—†ìŒ</span>
                          </label>
                        </div>

                        <div id="manual-leader-area-new">
                          <div id="leader-selectors-new" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                      </div>
                    </div>

                    <div class="px-6 py-4 bg-gray-50 border-t flex gap-3">
                      <button type="button" id="group-maker-cancel-btn" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-white hover:border-gray-400 transition-colors font-semibold">
                        <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                      </button>
                      <button type="button" id="generate-groups-btn" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all font-semibold shadow-lg">
                        <i class="fas fa-magic mr-2"></i>íŒ€ êµ¬ì„±í•˜ê¸° ì‹œì‘!
                      </button>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setTimeout(() => {
          // í˜„ì¬ ì…ë ¥ëœ ì¡° ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’ 3)
          const initialGroupCount =
            parseInt(document.getElementById("group-count-new").value) || 3;
          updateLeaderSelectorsNew(participants, initialGroupCount);

          // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          const closeBtn = document.getElementById("group-maker-close-btn");
          if (closeBtn) {
            closeBtn.addEventListener("click", () => {
              console.log("ğŸ”´ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨");
              closeGroupMakerModal();
            });
          }

          // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          const cancelBtn = document.getElementById("group-maker-cancel-btn");
          if (cancelBtn) {
            cancelBtn.addEventListener("click", () => {
              console.log("ğŸ”´ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ë¨");
              closeGroupMakerModal();
            });
          }

          // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
          const modal = document.getElementById("group-maker-modal");
          if (modal) {
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                console.log("ğŸ”´ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°");
                closeGroupMakerModal();
              }
            });
          }

          document
            .getElementById("group-count-new")
            ?.addEventListener("input", (e) => {
              updateLeaderSelectorsNew(
                participants,
                parseInt(e.target.value) || 3,
                true // ì„ íƒ ì •ë³´ ë³´ì¡´
              );
            });

          document
            .querySelectorAll('input[name="leader-mode-new"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                const area = document.getElementById("manual-leader-area-new");
                area.style.display =
                  radio.value === "manual" ? "block" : "none";
                if (radio.value === "manual") {
                  updateLeaderSelectorsNew(
                    participants,
                    parseInt(
                      document.getElementById("group-count-new").value
                    ) || 3,
                    true // ì„ íƒ ì •ë³´ ë³´ì¡´
                  );
                }
              });
            });

          // ì¡° ì§œê¸° ë²„íŠ¼
          document
            .getElementById("generate-groups-btn")
            ?.addEventListener("click", () => {
              console.log("ğŸ”µ ì¡° ì§œê¸° ë²„íŠ¼ í´ë¦­ë¨");

              // ì˜µì…”ë„ ì²´ì´ë‹ê³¼ ê¸°ë³¸ê°’ ì‚¬ìš©ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
              const groupCount =
                parseInt(document.getElementById("group-count-new")?.value) ||
                3;
              const genderBalance =
                document.getElementById("gender-balance-new")?.checked ?? true;
              const collegeMix =
                document.getElementById("college-mix-new")?.checked ?? true;
              const leaderMode =
                document.querySelector('input[name="leader-mode-new"]:checked')
                  ?.value || "none";

              console.log("âœ… ì¡° ì§œê¸° ì„¤ì •:", {
                groupCount,
                genderBalance,
                collegeMix,
                leaderMode,
              });

              const groups = createGroupsNew(
                participants,
                groupCount,
                genderBalance,
                collegeMix,
                leaderMode
              );
              closeGroupMakerModal();
              showGroupResultsNew(eventId, groups);
            });
        }, 50);
      };

      // ëª¨ë‹¬ ë‹«ê¸°
      window.closeGroupMakerModal = function () {
        document.getElementById("group-maker-modal")?.remove();
      };

      // ê¸°ì¡´ ë³µì¡í•œ ì¡°ì§œê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ì•„ë˜ì— ì£¼ì„ ì²˜ë¦¬ë¨ (ì‚¬ìš© ì•ˆí•¨)
      /*
                                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200">
                                      <div class="flex items-center gap-3">
                                        <div class="bg-blue-600 rounded-full p-3">
                                          <i class="fas fa-user-friends text-white text-lg"></i>
                                        </div>
                                        <div>
                                          <p class="text-sm text-blue-600 font-medium">ì´ ì°¸ê°€ì</p>
                                          <p class="text-3xl font-bold text-blue-900">${
                                            participants.length
                                          }<span class="text-lg ml-1">ëª…</span></p>
                                        </div>
                                      </div>
                      </div>

                                    <div class="space-y-6">
                                      <!-- 1. ì¡° ê°œìˆ˜ ì„¤ì • -->
                                      <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-blue-300 transition-all duration-200">
                                        <div class="flex items-center gap-3 mb-4">
                                          <div class="bg-blue-100 rounded-full p-2">
                                            <i class="fas fa-layer-group text-blue-600 text-lg"></i>
                                          </div>
                        <div>
                                            <label class="text-lg font-bold text-gray-800">1ë‹¨ê³„: ì¡° ê°œìˆ˜</label>
                                            <p class="text-sm text-gray-500">ëª‡ ê°œì˜ ì¡°ë¡œ ë‚˜ëˆ„ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                                          </div>
                                        </div>
                          <div class="relative">
                            <input type="number" id="group-count" min="1" max="${
                              participants.length
                            }" value="3"
                                                 class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-all duration-200 text-2xl font-bold text-center">
                                          <div class="absolute inset-y-0 right-0 flex items-center pr-6 pointer-events-none">
                                            <span class="text-gray-400 text-lg font-medium">ê°œ</span>
                            </div>
                                        </div>
                                        <div class="mt-3 flex items-center gap-2 text-xs text-gray-500">
                                          <i class="fas fa-lightbulb"></i>
                                          <span>ê¶Œì¥: ${Math.ceil(
                                            participants.length / 4
                                          )}-${Math.ceil(
                  participants.length / 6
                )}ê°œ ì¡° (ì¡°ë‹¹ 4-6ëª…)</span>
                          </div>
                        </div>

                                      <!-- 2. ì„±ë³„ ë°°ë¶„ -->
                                      <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-pink-300 transition-all duration-200">
                                        <div class="flex items-center gap-3 mb-4">
                                          <div class="bg-pink-100 rounded-full p-2">
                                            <i class="fas fa-venus-mars text-pink-600 text-lg"></i>
                                          </div>
                        <div>
                                            <label class="text-lg font-bold text-gray-800">2ë‹¨ê³„: ì„±ë³„ ë°°ë¶„</label>
                                            <p class="text-sm text-gray-500">ì„±ë³„ì„ ì–´ë–»ê²Œ ë°°ì •í• ê¹Œìš”?</p>
                                          </div>
                                        </div>
                                        <div class="space-y-2">
                                          <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                            <input type="radio" name="gender-ratio" value="balanced" checked class="w-5 h-5 text-green-600 focus:ring-green-500">
                                            <div class="flex-1">
                                              <div class="flex items-center gap-2">
                                                <i class="fas fa-balance-scale text-green-600 text-lg group-hover:scale-110 transition-transform"></i>
                                                <span class="font-bold text-gray-800">ê· ë“± ë°°ë¶„</span>
                                              </div>
                                              <p class="text-xs text-green-700 mt-1">ë‚¨ë…€ ë¹„ìœ¨ì„ ìµœëŒ€í•œ ê· ë“±í•˜ê²Œ ë°°ì •í•©ë‹ˆë‹¤</p>
                                            </div>
                          </label>
                                          <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-blue-50 to-sky-50 border-2 border-blue-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                            <input type="radio" name="gender-ratio" value="mixed" class="w-5 h-5 text-blue-600 focus:ring-blue-500">
                                            <div class="flex-1">
                                              <div class="flex items-center gap-2">
                                                <i class="fas fa-random text-blue-600 text-lg group-hover:scale-110 transition-transform"></i>
                                                <span class="font-bold text-gray-800">ë¬´ì‘ìœ„ ì„ê¸°</span>
                                              </div>
                                              <p class="text-xs text-blue-700 mt-1">ì„±ë³„ì„ ì™„ì „íˆ ë¬´ì‘ìœ„ë¡œ ë°°ì •í•©ë‹ˆë‹¤</p>
                                            </div>
                            </label>
                                          <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                            <input type="radio" name="gender-ratio" value="ignore" class="w-5 h-5 text-gray-600 focus:ring-gray-500">
                                            <div class="flex-1">
                                              <div class="flex items-center gap-2">
                                                <i class="fas fa-users text-gray-600 text-lg group-hover:scale-110 transition-transform"></i>
                                                <span class="font-bold text-gray-800">ì„±ë³„ ë¬´ê´€</span>
                                              </div>
                                              <p class="text-xs text-gray-700 mt-1">ì„±ë³„ì„ ê³ ë ¤í•˜ì§€ ì•Šê³  ë°°ì •í•©ë‹ˆë‹¤</p>
                                            </div>
                            </label>
                          </div>
                        </div>

                                      <!-- 3. ë‹¨ê³¼ëŒ€ë³„ ë¶„ë°° -->
                                      <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-purple-300 transition-all duration-200">
                                        <div class="flex items-center gap-3 mb-4">
                                          <div class="bg-purple-100 rounded-full p-2">
                                            <i class="fas fa-university text-purple-600 text-lg"></i>
                                          </div>
                        <div>
                                            <label class="text-lg font-bold text-gray-800">3ë‹¨ê³„: ë‹¨ê³¼ëŒ€ ë°°ë¶„</label>
                                            <p class="text-sm text-gray-500">ë‹¨ê³¼ëŒ€ë¥¼ ì–´ë–»ê²Œ ë°°ì •í• ê¹Œìš”?</p>
                                          </div>
                                        </div>
                                        <div class="space-y-2">
                                          <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-violet-50 border-2 border-purple-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                            <input type="radio" name="college-mix" value="mixed" checked class="w-5 h-5 text-purple-600 focus:ring-purple-500">
                                            <div class="flex-1">
                                              <div class="flex items-center gap-2">
                                                <i class="fas fa-shuffle text-purple-600 text-lg group-hover:scale-110 transition-transform"></i>
                                                <span class="font-bold text-gray-800">ê³ ë¥´ê²Œ ë¶„ë°°</span>
                                              </div>
                                              <p class="text-xs text-purple-700 mt-1">ê° ë‹¨ê³¼ëŒ€ê°€ ê³¨ê³ ë£¨ ì„ì´ë„ë¡ ë°°ì •í•©ë‹ˆë‹¤</p>
                                            </div>
                          </label>
                                          <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                            <input type="radio" name="college-mix" value="ignore" class="w-5 h-5 text-gray-600 focus:ring-gray-500">
                                            <div class="flex-1">
                                              <div class="flex items-center gap-2">
                                                <i class="fas fa-random text-gray-600 text-lg group-hover:scale-110 transition-transform"></i>
                                                <span class="font-bold text-gray-800">ë¬´ì‘ìœ„ ë°°ì •</span>
                                              </div>
                                              <p class="text-xs text-gray-700 mt-1">ë‹¨ê³¼ëŒ€ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šê³  ë¬´ì‘ìœ„ ë°°ì •í•©ë‹ˆë‹¤</p>
                                            </div>
                            </label>
                          </div>
                        </div>

                                      <!-- 4. ì¡°ì¥ ì„¤ì • (ëª¨ë“  ì‚¬ìš©ì) -->
                                      <div class="bg-white border-2 border-gray-200 rounded-xl p-5 hover:border-yellow-300 transition-all duration-200">
                                        <div class="flex items-center gap-3 mb-4">
                                          <div class="bg-yellow-100 rounded-full p-2">
                                            <i class="fas fa-crown text-yellow-600 text-lg"></i>
                                          </div>
                        <div>
                                            <label class="text-lg font-bold text-gray-800">4ë‹¨ê³„: ì¡°ì¥ ì„¤ì •</label>
                                            <p class="text-sm text-gray-500">ì¡°ì¥ì„ ì–´ë–»ê²Œ ì§€ì •í• ê¹Œìš”?</p>
                                          </div>
                                        </div>
                                        <div class="space-y-2">
                                          <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                            <input type="radio" name="leader-setting" value="manual" checked class="w-5 h-5 text-yellow-600 focus:ring-yellow-500">
                                            <div class="flex-1">
                                              <div class="flex items-center gap-2">
                                                <i class="fas fa-hand-pointer text-yellow-600 text-lg group-hover:scale-110 transition-transform"></i>
                                                <span class="font-bold text-gray-800">ìˆ˜ë™ ì„ íƒ</span>
                                              </div>
                                              <p class="text-xs text-yellow-700 mt-1">ê° ì¡°ì˜ ì¡°ì¥ì„ ì§ì ‘ ì„ íƒí•©ë‹ˆë‹¤</p>
                                            </div>
                          </label>
                                          <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                            <input type="radio" name="leader-setting" value="auto" class="w-5 h-5 text-orange-600 focus:ring-orange-500">
                                            <div class="flex-1">
                                              <div class="flex items-center gap-2">
                                                <i class="fas fa-magic text-orange-600 text-lg group-hover:scale-110 transition-transform"></i>
                                                <span class="font-bold text-gray-800">ìë™ ì„¤ì •</span>
                                              </div>
                                              <p class="text-xs text-orange-700 mt-1">í•™ë…„ì´ ë†’ì€ ìˆœìœ¼ë¡œ ìë™ ë°°ì •í•©ë‹ˆë‹¤</p>
                                            </div>
                              </label>
                                          <label class="flex items-center gap-3 p-4 bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-200 rounded-xl hover:shadow-md transition-all duration-200 cursor-pointer group">
                                            <input type="radio" name="leader-setting" value="none" class="w-5 h-5 text-gray-600 focus:ring-gray-500">
                                            <div class="flex-1">
                                              <div class="flex items-center gap-2">
                                                <i class="fas fa-users text-gray-600 text-lg group-hover:scale-110 transition-transform"></i>
                                                <span class="font-bold text-gray-800">ì¡°ì¥ ì—†ìŒ</span>
                                              </div>
                                              <p class="text-xs text-gray-700 mt-1">ì¡°ì¥ì„ ë”°ë¡œ ì„¤ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                                            </div>
                              </label>
                            </div>
                                        <div id="manual-leader-selection" class="mt-4 space-y-3">
                                          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4">
                                            <p class="text-sm text-blue-900 font-bold mb-3 flex items-center gap-2">
                                              <i class="fas fa-info-circle"></i>
                                              <span>ê° ì¡°ì˜ ì¡°ì¥ì„ ì„ íƒí•˜ì„¸ìš”</span>
                                </p>
                                <div id="leader-selectors" class="space-y-2">
                                  <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì¡°ì¥ ì„ íƒê¸°ë“¤ -->
                                </div>
                              </div>
                            </div>
                          </div>

                                      <!-- ì°¸ê°€ì ëª©ë¡ (ê´€ë¦¬ìë§Œ) -->
                              ${
                                currentUser &&
                                adminList.includes(currentUser.studentId)
                                  ? `
                                      <div class="bg-white border-2 border-gray-200 rounded-xl p-5">
                                        <div class="flex items-center gap-3 mb-3">
                                          <div class="bg-gray-100 rounded-full p-2">
                                            <i class="fas fa-list text-gray-600 text-lg"></i>
                                          </div>
                                          <label class="text-lg font-bold text-gray-800">ì°¸ê°€ì ëª©ë¡</label>
                                        </div>
                                        <div class="max-h-48 overflow-y-auto border-2 border-gray-200 rounded-xl p-3 bg-gray-50">
                                          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                              ${participants
                                .slice().reverse()
                                .map(
                                  (p, idx) => `
                                              <div class="flex items-center justify-between p-2 bg-white rounded-lg text-sm hover:shadow-sm transition-shadow">
                                                <span class="font-medium text-gray-800">${
                                                  idx + 1
                                                }. ${p.name}</span>
                                                <span class="text-xs text-gray-500">${
                                                  p.gender
                                                } Â· ${p.college}</span>
                                </div>
                              `
                                )
                                .join("")}
                            </div>
                          </div>
                        </div>
                        `
                                  : ""
                              }
                                    </div>
                      </div>

                                  <!-- í‘¸í„° -->
                                  <div class="px-6 py-4 bg-gray-50 border-t-2 border-gray-200 flex gap-3">
                        <button type="button" id="group-maker-cancel"
                                            class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-white hover:border-gray-400 transition-all duration-200 font-semibold">
                          <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                              </button>
                                    <button type="button" id="group-maker-generate"
                                            class="flex-1 bg-gradient-to-r from-purple-600 via-purple-700 to-indigo-600 text-white py-4 px-6 rounded-xl hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-3 font-bold text-lg group">
                                      <i class="fas fa-magic text-xl group-hover:rotate-12 transition-transform"></i>
                                      <span>ì¡°ì§œê¸° ì‹œì‘!</span>
                                      <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                `;

                // ëª¨ë‹¬ ì¶”ê°€
                document.body.insertAdjacentHTML("beforeend", modalHTML);
                console.log("âœ… ì¡°ì§œê¸° ëª¨ë‹¬ DOMì— ì¶”ê°€ ì™„ë£Œ");

                // ì§§ì€ ì§€ì—° í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (DOM ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°)
                setTimeout(() => {
                  console.log("ğŸ”— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì¤‘...");
                  const closeBtn = document.getElementById("group-maker-close");
                  const cancelBtn = document.getElementById("group-maker-cancel");
                  const generateBtn = document.getElementById("group-maker-generate");

                  console.log("ğŸ” ë²„íŠ¼ ìš”ì†Œ í™•ì¸:", {
                    closeBtn: !!closeBtn,
                    cancelBtn: !!cancelBtn,
                    generateBtn: !!generateBtn,
                  });

                  if (closeBtn) {
                    closeBtn.addEventListener("click", (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      console.log("ğŸ”´ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨ - ì´ë²¤íŠ¸:", e);
                      closeGroupMakerModal();
                    });
                    console.log("âœ… ë‹«ê¸° ë²„íŠ¼ ì—°ê²° ì™„ë£Œ");
                  } else {
                    console.error("âŒ ë‹«ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
                  }

                  if (cancelBtn) {
                    cancelBtn.addEventListener("click", (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      console.log("ğŸ”´ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ë¨ - ì´ë²¤íŠ¸:", e);
                      closeGroupMakerModal();
                    });
                    console.log("âœ… ì·¨ì†Œ ë²„íŠ¼ ì—°ê²° ì™„ë£Œ");
                  } else {
                    console.error("âŒ ì·¨ì†Œ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
                  }

                  if (generateBtn) {
                    generateBtn.addEventListener("click", (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      console.log("ğŸŸ¢ ì¡°ì§œê¸° ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨ - ì´ë²¤íŠ¸:", e);
                      console.log("ğŸŸ¢ ë²„íŠ¼ ìš”ì†Œ:", generateBtn);
                      console.log("ğŸŸ¢ ì´ë²¤íŠ¸ ID:", eventId);
                      console.log("ğŸŸ¢ ì°¸ê°€ì ìˆ˜:", participants.length);
                      generateGroups(eventId, participants);
                    });
                    console.log("âœ… ì¡°ì§œê¸° ì‹œì‘ ë²„íŠ¼ ì—°ê²° ì™„ë£Œ");
                  } else {
                    console.error("âŒ ì¡°ì§œê¸° ì‹œì‘ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
                  }

                  console.log("âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì™„ë£Œ");

                  // ì¡°ì¥ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ëª¨ë“  ì‚¬ìš©ì)
                  console.log("ğŸ‘¨â€ğŸ’¼ ì¡°ì¥ ê´€ë ¨ ê¸°ëŠ¥ í™œì„±í™”");

                  // ì¡° ê°œìˆ˜ ë³€ê²½ ì‹œ ì¡°ì¥ ì„ íƒê¸° ì—…ë°ì´íŠ¸
                  const groupCountInput1 = document.getElementById("group-count");
                  if (groupCountInput1) {
                    groupCountInput1.addEventListener("input", () => {
                      console.log("ğŸ“Š ì¡° ê°œìˆ˜ ë³€ê²½ë¨");
                      updateLeaderSelectors(participants);
                    });
                    console.log("âœ… ì¡° ê°œìˆ˜ ì…ë ¥ ì´ë²¤íŠ¸ ì—°ê²° ì™„ë£Œ");
                  } else {
                    console.error("âŒ group-count ì…ë ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
                  }

                  // ì¡°ì¥ ì„¤ì • ë°©ì‹ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
                  const leaderSettingRadios = document.querySelectorAll(
                    'input[name="leader-setting"]'
                  );
                  console.log(
                    "ğŸ‘‘ ì¡°ì¥ ì„¤ì • ë¼ë””ì˜¤ ë²„íŠ¼ ìˆ˜:",
                    leaderSettingRadios.length
                  );
                  if (leaderSettingRadios.length > 0) {
                    leaderSettingRadios.forEach((radio) => {
                      radio.addEventListener("change", () => {
                        console.log("ğŸ‘‘ ì¡°ì¥ ì„¤ì • ë°©ì‹ ë³€ê²½ë¨:", radio.value);
                        updateLeaderSelectionVisibility();
                      });
                    });
                    console.log("âœ… ì¡°ì¥ ì„¤ì • ë¼ë””ì˜¤ ì´ë²¤íŠ¸ ì—°ê²° ì™„ë£Œ");
                  } else {
                    console.error("âŒ ì¡°ì¥ ì„¤ì • ë¼ë””ì˜¤ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
                  }

                  // ì¦‰ì‹œ ì¡°ì¥ ì„ íƒê¸° ê°•ì œ ìƒì„±
                  console.log("ğŸ”§ ì¡°ì¥ ì„ íƒê¸° ì¦‰ì‹œ ê°•ì œ ìƒì„± ì‹œì‘...");
                  console.log("ğŸ”§ ì°¸ê°€ì ë°ì´í„°:", participants);
                  console.log("ğŸ”§ ì°¸ê°€ì ìˆ˜:", participants.length);

                  // ì¦‰ì‹œ ì‹¤í–‰
                  const createLeaderSelectors = () => {
                    const leaderSelectors =
                      document.getElementById("leader-selectors");
                    const groupCount =
                      parseInt(document.getElementById("group-count")?.value) || 3;

                    console.log("ğŸ” leader-selectors ìš”ì†Œ:", leaderSelectors);
                    console.log("ğŸ” ì¡° ê°œìˆ˜:", groupCount);

                    if (leaderSelectors) {
                      let html = "";
                      for (let i = 1; i <= groupCount; i++) {
                        html += `
                                      <div class="flex items-center gap-3 bg-white rounded-lg p-3 border-2 border-gray-200 hover:border-yellow-300 transition-colors">
                                        <div class="flex items-center justify-center w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-400 rounded-full text-white font-bold">
                                          ${i}
                                        </div>
                                        <div class="flex-1">
                                          <label class="text-xs text-gray-500 font-medium">${i}ì¡° ì¡°ì¥</label>
                                          <select class="leader-select w-full mt-1 px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition-all" data-group="${i}">
                                            <option value="">ğŸ‘‰ ì¡°ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                            ${participants
                                              .map(
                                                (p) =>
                                                  `<option value="${p.studentId}">${p.name} (${p.studentId}) - ${p.gender}/${p.college}</option>`
                                              )
                                              .join("")}
                                          </select>
                                        </div>
                                      </div>
                                    `;
                      }

                      leaderSelectors.innerHTML = html;
                      console.log("âœ… ì¡°ì¥ ì„ íƒê¸° ì¦‰ì‹œ ìƒì„± ì™„ë£Œ:", groupCount, "ê°œ");
                      console.log("ğŸ” ìƒì„±ëœ HTML:", leaderSelectors.innerHTML);
                    } else {
                      console.error("âŒ leader-selectors ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                    }
                  };

                  // ì¡°ì¥ ì„ íƒ UI ì¦‰ì‹œ ì´ˆê¸°í™” - ë¨¼ì € ìƒì„±í•˜ê³  visibility ì„¤ì •
                  console.log("ğŸ”§ 1ì°¨ ì¡°ì¥ ì„ íƒê¸° ìƒì„±");
                  createLeaderSelectors(); // ì¦‰ì‹œ ìƒì„±

                  console.log("ğŸ”§ 2ì°¨ ì¡°ì¥ ì„ íƒê¸° ì—…ë°ì´íŠ¸");
                  updateLeaderSelectors(participants);

                  console.log("ğŸ”§ ì¡°ì¥ ì„ íƒ UI ê°€ì‹œì„± ì—…ë°ì´íŠ¸");
                  updateLeaderSelectionVisibility();

                  // ì§€ì—° í›„ ì¬ì‹¤í–‰ (ì•ˆì „ì¥ì¹˜)
                  setTimeout(() => {
                    console.log("ğŸ”§ 100ms í›„ ì¬ìƒì„±");
                    updateLeaderSelectors(participants);
                    updateLeaderSelectionVisibility();
                  }, 100);

                  setTimeout(() => {
                    console.log("ğŸ”§ 500ms í›„ ì¬ìƒì„±");
                    updateLeaderSelectors(participants);
                    updateLeaderSelectionVisibility();
                  }, 500);

                  console.log("âœ… ì¡°ì¥ ì„ íƒê¸° ì´ˆê¸°í™” ì™„ë£Œ");

                  // ì¶”ê°€ ì•ˆì „ì¥ì¹˜: ì „ì—­ ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
                  const globalClickHandler = (e) => {
                    const target = e.target.closest(
                      "#group-maker-close, #group-maker-cancel, #group-maker-generate"
                    );
                    if (target) {
                      e.preventDefault();
                      e.stopPropagation();
                      console.log(
                        "ğŸŒ ì „ì—­ ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ë²„íŠ¼ í´ë¦­ ê°ì§€:",
                        target.id
                      );

                      if (
                        target.id === "group-maker-close" ||
                        target.id === "group-maker-cancel"
                      ) {
                        console.log("ğŸ”´ ì „ì—­ í•¸ë“¤ëŸ¬ë¡œ ëª¨ë‹¬ ë‹«ê¸°");
                        closeGroupMakerModal();
                      } else if (target.id === "group-maker-generate") {
                        console.log("ğŸŸ¢ ì „ì—­ í•¸ë“¤ëŸ¬ë¡œ ì¡°ì§œê¸° ì‹œì‘");
                        generateGroups(eventId, participants);
                      }
                    }
                  };

                  document.addEventListener("click", globalClickHandler);
                  console.log("ğŸŒ ì „ì—­ ì´ë²¤íŠ¸ ìœ„ì„ í•¸ë“¤ëŸ¬ ì¶”ê°€ ì™„ë£Œ");

                  // ì¡° ê°œìˆ˜ ë³€ê²½ ì‹œ ì¡°ì¥ ì„ íƒ UI ì—…ë°ì´íŠ¸
                  const groupCountInput2 = document.getElementById("group-count");
                  if (groupCountInput2) {
                    groupCountInput2.addEventListener("change", () => {
                      console.log("ğŸ”„ ì¡° ê°œìˆ˜ ë³€ê²½ ê°ì§€, ì¡°ì¥ ì„ íƒ UI ì—…ë°ì´íŠ¸");
                      updateLeaderSelectors(participants);
                      updateLeaderSelectionVisibility();
                    });
                  }

                  // ì¡°ì¥ ì„¤ì • ì˜µì…˜ ë³€ê²½ ì‹œ ì¡°ì¥ ì„ íƒ UI ì—…ë°ì´íŠ¸
                  const leaderSettingInputs = document.querySelectorAll(
                    'input[name="leader-setting"]'
                  );
                  leaderSettingInputs.forEach((input) => {
                    input.addEventListener("change", () => {
                      console.log("ğŸ”„ ì¡°ì¥ ì„¤ì • ë³€ê²½ ê°ì§€:", input.value);
                      updateLeaderSelectionVisibility();
                      if (input.value === "manual") {
                        updateLeaderSelectors(participants);
                      }
                    });
                  });

                  // ëª¨ë‹¬ ë‹«ê¸° ì‹œ ì „ì—­ í•¸ë“¤ëŸ¬ ì œê±°ë¥¼ ìœ„í•´ ì €ì¥
                  window.groupMakerGlobalHandler = globalClickHandler;

                  // ì¶”ê°€: ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
                  const modal = document.getElementById("group-maker-modal");
                  if (modal) {
                    modal.addEventListener("click", (e) => {
                      if (e.target === modal) {
                        console.log("ğŸ–±ï¸ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°");
                        closeGroupMakerModal();
                      }
                    });
                    console.log("âœ… ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²° ì™„ë£Œ");
                  }
                }, 100); // 100ms ì§€ì—°

            */
      // ê¸°ì¡´ ì¡°ì§œê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤ (ì£¼ì„ ì²˜ë¦¬ë¨)

      // ì¡°ì¥ ì„ íƒê¸° ì—…ë°ì´íŠ¸ - OLD VERSION (ì‚¬ìš©ì•ˆí•¨)
      function updateLeaderSelectors_OLD(participants) {
        console.log("ğŸ”„ ì¡°ì¥ ì„ íƒê¸° ì—…ë°ì´íŠ¸ ì‹œì‘", participants.length, "ëª…");
        const groupCountInput3 = document.getElementById("group-count");
        const container = document.getElementById("leader-selectors");

        if (!groupCountInput3) {
          console.error("âŒ group-count ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }
        if (!container) {
          console.error("âŒ leader-selectors ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        const groupCount = parseInt(groupCountInput3.value) || 3;
        console.log("ğŸ“Š ì¡°ì¥ ì„ íƒê¸° ìƒì„±í•  ì¡° ê°œìˆ˜:", groupCount);

        container.innerHTML = "";
        console.log("ğŸ§¹ ì»¨í…Œì´ë„ˆ ë‚´ìš© ì´ˆê¸°í™” ì™„ë£Œ");

        for (let i = 1; i <= groupCount; i++) {
          console.log(`ğŸ”§ ${i}ì¡° ì¡°ì¥ ì„ íƒê¸° ìƒì„± ì¤‘...`);
          const selectorHTML = `
                              <div class="flex items-center gap-3 bg-white rounded-lg p-3 border-2 border-gray-200 hover:border-yellow-300 transition-colors">
                                <div class="flex items-center justify-center w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-400 rounded-full text-white font-bold">
                                  ${i}
                                </div>
                                <div class="flex-1">
                                  <label class="text-xs text-gray-500 font-medium">${i}ì¡° ì¡°ì¥</label>
                                  <select class="leader-select w-full mt-1 px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition-all" data-group="${i}">
                                    <option value="">ğŸ‘‰ ì¡°ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                      ${participants
                        .map(
                          (p) => `
                        <option value="${p.studentId}">${p.name} (${p.studentId}) - ${p.gender}/${p.college}</option>
                      `
                        )
                        .join("")}
                    </select>
                                </div>
                  </div>
                `;
          container.insertAdjacentHTML("beforeend", selectorHTML);
          console.log(`âœ… ${i}ì¡° ì¡°ì¥ ì„ íƒê¸° ìƒì„± ì™„ë£Œ`);
        }
        console.log("âœ… ì¡°ì¥ ì„ íƒê¸° ìƒì„± ì™„ë£Œ:", groupCount, "ê°œ");
        console.log("ğŸ” ìµœì¢… ì»¨í…Œì´ë„ˆ ë‚´ìš©:", container.innerHTML);
      }

      // ì¡°ì¥ ì„ íƒ UI í‘œì‹œ/ìˆ¨ê¹€ - OLD VERSION (ì‚¬ìš©ì•ˆí•¨)
      function updateLeaderSelectionVisibility_OLD() {
        console.log("ğŸ‘ï¸ ì¡°ì¥ ì„ íƒ UI í‘œì‹œ/ìˆ¨ê¹€ ì—…ë°ì´íŠ¸");

        // ì¡°ì¥ ì„¤ì • ë¼ë””ì˜¤ ë²„íŠ¼ ì°¾ê¸°
        const leaderSettingElement = document.querySelector(
          'input[name="leader-setting"]:checked'
        );
        const manualSelection = document.getElementById(
          "manual-leader-selection"
        );

        if (!leaderSettingElement) {
          console.error("âŒ leader-setting ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          // ê¸°ë³¸ê°’ìœ¼ë¡œ "manual" ì„¤ì •
          const manualRadio = document.querySelector(
            'input[name="leader-setting"][value="manual"]'
          );
          if (manualRadio) {
            manualRadio.checked = true;
            console.log("ğŸ”§ ê¸°ë³¸ê°’ìœ¼ë¡œ ìˆ˜ë™ ì¡°ì¥ ì„¤ì • ì ìš©");
          }
          return;
        }

        if (!manualSelection) {
          console.error("âŒ manual-leader-selection ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        const leaderSetting = leaderSettingElement.value;
        console.log("ğŸ‘‘ í˜„ì¬ ì¡°ì¥ ì„¤ì • ëª¨ë“œ:", leaderSetting);

        if (leaderSetting === "manual") {
          manualSelection.style.display = "block";
          console.log("âœ… ìˆ˜ë™ ì¡°ì¥ ì„ íƒ UI í‘œì‹œ");

          // ì¡°ì¥ ì„ íƒê¸°ê°€ ì—†ë‹¤ë©´ ìƒì„±
          const leaderSelectors = document.getElementById("leader-selectors");
          if (leaderSelectors && leaderSelectors.children.length === 0) {
            console.log("ğŸ”§ ì¡°ì¥ ì„ íƒê¸°ê°€ ë¹„ì–´ìˆì–´ì„œ ì¬ìƒì„±");
            // ì°¸ê°€ì ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ ì¡°ì¥ ì„ íƒê¸° ìƒì„±
            const eventId = window.currentGroupMakerEventId;
            if (eventId) {
              const ev = eventsData.find((e) => e.id === eventId);
              if (ev) {
                let participants = [];
                if (ev.type === "tasting") {
                  (ev.restaurants || []).forEach((r) => {
                    (r.reservations || []).forEach((p) => {
                      participants.push({
                        name: p.name || "",
                        studentId: p.studentId || "",
                        gender: p.gender || "",
                        year: p.year || "",
                        college: p.college || "",
                        department: p.department || "",
                        phone: p.phone || "",
                      });
                    });
                  });
                } else {
                  (ev.applicants || []).forEach((p) => {
                    participants.push({
                      name: p.name || "",
                      studentId: p.studentId || "",
                      gender: p.gender || "",
                      year: p.year || "",
                      college: p.college || "",
                      department: p.department || "",
                      phone: p.phone || "",
                    });
                  });
                }
                updateLeaderSelectors(participants);
              }
            }
          }
        } else {
          manualSelection.style.display = "none";
          console.log("âœ… ìˆ˜ë™ ì¡°ì¥ ì„ íƒ UI ìˆ¨ê¹€");
        }
      }

      // ì¡°ì§œê¸° ëª¨ë‹¬ ë‹«ê¸° - OLD VERSION (ì‚¬ìš©ì•ˆí•¨)
      function closeGroupMakerModal_OLD2() {
        console.log("ğŸ”´ ì¡°ì§œê¸° ëª¨ë‹¬ ë‹«ê¸° í˜¸ì¶œë¨");

        // í˜„ì¬ ì´ë²¤íŠ¸ ID ì •ë¦¬
        window.currentGroupMakerEventId = null;

        // ì „ì—­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±°
        if (window.groupMakerGlobalHandler) {
          document.removeEventListener("click", window.groupMakerGlobalHandler);
          delete window.groupMakerGlobalHandler;
          console.log("ğŸŒ ì „ì—­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±° ì™„ë£Œ");
        }

        const modal = document.getElementById("group-maker-modal");
        if (modal) {
          modal.remove();
          console.log("âœ… ì¡°ì§œê¸° ëª¨ë‹¬ ì œê±° ì™„ë£Œ");
        } else {
          console.warn("âš ï¸ ì¡°ì§œê¸° ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        }
      }

      // ì¡° ìƒì„±í•˜ê¸°
      async function generateGroups(eventId, participants) {
        try {
          console.log("ğŸ¯ ì¡°ì§œê¸° ì‹œì‘!", {
            eventId,
            participantsCount: participants.length,
          });

          const groupCountInput5 = document.getElementById("group-count");
          if (!groupCountInput5) {
            console.error("âŒ group-count ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
            return showAlert("ğŸ˜¥", "ì¡° ê°œìˆ˜ ì…ë ¥ë€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          const groupCount = parseInt(groupCountInput5.value);
          console.log("ğŸ“Š ì¡° ê°œìˆ˜:", groupCount);

          if (
            !groupCount ||
            groupCount < 1 ||
            groupCount > participants.length
          ) {
            console.error("âŒ ì¡° ê°œìˆ˜ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:", groupCount);
            return showAlert(
              "ğŸ˜¥",
              `ì¡° ê°œìˆ˜ë¥¼ 1ë¶€í„° ${participants.length} ì‚¬ì´ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.`
            );
          }

          const genderRatioElement = document.querySelector(
            'input[name="gender-ratio"]:checked'
          );
          if (!genderRatioElement) {
            console.error("âŒ ì„±ë³„ ë°°ë¶„ ì˜µì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
            return showAlert("ğŸ˜¥", "ì„±ë³„ ë°°ë¶„ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          }
          const genderRatio = genderRatioElement.value;
          console.log("ğŸ‘« ì„±ë³„ ë°°ë¶„:", genderRatio);

          const collegeMixElement = document.querySelector(
            'input[name="college-mix"]:checked'
          );
          if (!collegeMixElement) {
            console.error("âŒ ë‹¨ê³¼ëŒ€ ë°°ë¶„ ì˜µì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
            return showAlert("ğŸ˜¥", "ë‹¨ê³¼ëŒ€ ë°°ë¶„ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          }
          const collegeMix = collegeMixElement.value;
          console.log("ğŸ›ï¸ ë‹¨ê³¼ëŒ€ ë°°ë¶„:", collegeMix);

          // ì¡°ì¥ ì„¤ì • ìš”ì†Œ í™•ì¸ (ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥)
          const leaderSettingElement = document.querySelector(
            'input[name="leader-setting"]:checked'
          );
          const leaderSetting = leaderSettingElement
            ? leaderSettingElement.value
            : "none";
          console.log("ğŸ‘‘ ì¡°ì¥ ì„¤ì •:", leaderSetting);

          // ìˆ˜ë™ ì¡°ì¥ ì„ íƒ ì •ë³´ ìˆ˜ì§‘
          let manualLeaders = {};
          if (leaderSetting === "manual") {
            const leaderSelects = document.querySelectorAll(".leader-select");
            console.log("ğŸ‘‘ ì¡°ì¥ ì„ íƒê¸° ê°œìˆ˜:", leaderSelects.length);
            leaderSelects.forEach((select) => {
              const groupNum = parseInt(select.dataset.group);
              const studentId = select.value;
              if (studentId) {
                manualLeaders[groupNum] = studentId;
                console.log(`ğŸ‘‘ ${groupNum}ì¡° ì¡°ì¥ ì„ íƒ:`, studentId);
              }
            });
            console.log("ğŸ‘‘ ìˆ˜ë™ ì„ íƒëœ ì¡°ì¥ ëª©ë¡:", manualLeaders);
          }

          console.log("âš™ï¸ ì¡° ìƒì„± ì•Œê³ ë¦¬ì¦˜ ì‹¤í–‰ ì¤‘...");
          // ì¡° ìƒì„± ì•Œê³ ë¦¬ì¦˜
          const groups = createGroups(
            participants,
            groupCount,
            genderRatio,
            collegeMix,
            leaderSetting,
            manualLeaders
          );

          console.log("âœ… ì¡° ìƒì„± ì™„ë£Œ!", {
            groupsCount: groups.length,
            groups,
          });

          // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
          showGroupResults(eventId, groups, participants);
        } catch (error) {
          console.error("âŒ ì¡° ìƒì„± ì˜¤ë¥˜:", error);
          console.error("ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
          showAlert("ğŸ˜¥", `ì¡° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
      }

      // ì¡° ìƒì„± ì•Œê³ ë¦¬ì¦˜ - OLD VERSION (ì‚¬ìš©ì•ˆí•¨)
      function createGroups_OLD(
        participants,
        groupCount,
        genderRatio,
        collegeMix,
        leaderSetting,
        manualLeaders = {}
      ) {
        let groups = Array.from({ length: groupCount }, () => []);

        // ìˆ˜ë™ ì¡°ì¥ ì •ë³´ ë¯¸ë¦¬ ì„¤ì •
        if (leaderSetting === "manual") {
          Object.keys(manualLeaders).forEach((groupIndex) => {
            const leaderStudentId = manualLeaders[groupIndex];
            const leader = participants.find(
              (p) => p.studentId === leaderStudentId
            );
            if (leader) {
              leader.isLeader = true;
              leader.targetGroup = parseInt(groupIndex) - 1; // 0-based index
            }
          });
        }

        // ëª¨ë“  ì°¸ê°€ìë¥¼ ì¡°ê±´ì— í¬í•¨í•˜ì—¬ ê· í˜• ë°°ë¶„
        if (genderRatio === "balanced" && collegeMix === "mixed") {
          // ì„±ë³„ê³¼ ë‹¨ê³¼ëŒ€ë¥¼ ëª¨ë‘ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
          groups = balanceGroupsByAllFactorsWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else if (genderRatio === "balanced") {
          // ì„±ë³„ë§Œ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
          groups = balanceGroupsByGenderWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else if (collegeMix === "mixed") {
          // ë‹¨ê³¼ëŒ€ë§Œ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
          groups = balanceGroupsByCollegeWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else {
          // ë¬´ì‘ìœ„ ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
          groups = randomDistributionWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        }

        // ìë™ ì¡°ì¥ ì„¤ì •
        if (leaderSetting === "auto") {
          groups.forEach((group) => {
            if (group.length > 0 && !group.some((member) => member.isLeader)) {
              // í•™ë…„ì´ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì²« ë²ˆì§¸ë¥¼ ì¡°ì¥ìœ¼ë¡œ ì„¤ì •
              group.sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                return yearB - yearA;
              });
              group[0].isLeader = true;
            }
          });
        }

        // ì¡°ì¥ì„ ê° ì¡°ì˜ ë§¨ ì•ìœ¼ë¡œ ì´ë™
        groups.forEach((group) => {
          const leader = group.find((member) => member.isLeader);
          if (leader) {
            const leaderIndex = group.indexOf(leader);
            group.splice(leaderIndex, 1);
            group.unshift(leader);
          }
        });

        return groups;
      }

      // ì„±ë³„ê³¼ ë‹¨ê³¼ëŒ€ë¥¼ ëª¨ë‘ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨) - ê°œì„ ëœ ì•Œê³ ë¦¬ì¦˜
      function balanceGroupsByAllFactorsWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        console.log(
          "ğŸ”„ ì„±ë³„+ë‹¨ê³¼ëŒ€ ê· í˜• ë°°ë¶„ ì‹œì‘",
          participants.length,
          "ëª…,",
          groupCount,
          "ì¡°"
        );

        // 1ë‹¨ê³„: ì¡°ì¥ë“¤ì„ ë¨¼ì € ë°°ì¹˜
        const leaders = participants.filter(
          (p) => p.isLeader && p.targetGroup !== undefined
        );
        leaders.forEach((leader) => {
          groups[leader.targetGroup].push(leader);
          console.log(
            `ğŸ‘‘ ì¡°ì¥ ë°°ì¹˜: ${leader.name} â†’ ${leader.targetGroup + 1}ì¡°`
          );
        });

        // 2ë‹¨ê³„: ë‚¨ì€ ì°¸ê°€ìë“¤ì„ ì„±ë³„ê³¼ ë‹¨ê³¼ëŒ€ë¡œ ë¶„ë¥˜
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const categorizedParticipants = {
          male: {},
          female: {},
          other: {},
        };

        remainingParticipants.forEach((p) => {
          const gender =
            p.gender === "ë‚¨ì„±"
              ? "male"
              : p.gender === "ì—¬ì„±"
              ? "female"
              : "other";
          const college = p.college || "ê¸°íƒ€";

          if (!categorizedParticipants[gender][college]) {
            categorizedParticipants[gender][college] = [];
          }
          categorizedParticipants[gender][college].push(p);
        });

        // 3ë‹¨ê³„: ê° ì¡°ì˜ í˜„ì¬ ì„±ë³„/ë‹¨ê³¼ëŒ€ êµ¬ì„± í™•ì¸
        const groupStats = groups.map(() => ({
          male: 0,
          female: 0,
          other: 0,
          colleges: {},
        }));

        groups.forEach((group, groupIndex) => {
          group.forEach((member) => {
            const gender =
              member.gender === "ë‚¨ì„±"
                ? "male"
                : member.gender === "ì—¬ì„±"
                ? "female"
                : "other";
            const college = member.college || "ê¸°íƒ€";
            groupStats[groupIndex][gender]++;
            if (!groupStats[groupIndex].colleges[college]) {
              groupStats[groupIndex].colleges[college] = 0;
            }
            groupStats[groupIndex].colleges[college]++;
          });
        });

        // 4ë‹¨ê³„: ì„±ë³„ê³¼ í•™ê³¼ë³„ë¡œ ê· ë“± ë°°ë¶„ (ë¼ìš´ë“œ ë¡œë¹ˆ ë°©ì‹)
        // ì„±ë³„ë³„ë¡œ ë¶„ë¥˜
        const malesByCollege = {};
        const femalesByCollege = {};
        const othersByCollege = {};

        remainingParticipants.forEach((p) => {
          const college = p.college || "ê¸°íƒ€";
          const target =
            p.gender === "ë‚¨ì„±"
              ? malesByCollege
              : p.gender === "ì—¬ì„±"
              ? femalesByCollege
              : othersByCollege;
          if (!target[college]) target[college] = [];
          target[college].push(p);
        });

        // ê° í•™ê³¼ë³„ ì¸ì›ì„ ì„ê¸°
        Object.values(malesByCollege).forEach((arr) =>
          arr.sort(() => Math.random() - 0.5)
        );
        Object.values(femalesByCollege).forEach((arr) =>
          arr.sort(() => Math.random() - 0.5)
        );
        Object.values(othersByCollege).forEach((arr) =>
          arr.sort(() => Math.random() - 0.5)
        );

        // 5ë‹¨ê³„: í•™ê³¼ë³„, ì„±ë³„ë³„ë¡œ ë¼ìš´ë“œ ë¡œë¹ˆ ë°°ì¹˜
        const distributeByCollege = (membersByCollege, genderLabel) => {
          const colleges = Object.keys(membersByCollege);
          colleges.forEach((college) => {
            const members = membersByCollege[college];
            members.forEach((member, idx) => {
              // ë¼ìš´ë“œ ë¡œë¹ˆ: ê° í•™ê³¼ì˜ ì‚¬ëŒë“¤ì„ ìˆœì„œëŒ€ë¡œ ê° ì¡°ì— ë°°ì¹˜
              const targetGroup = idx % groupCount;
              groups[targetGroup].push(member);

              // í†µê³„ ì—…ë°ì´íŠ¸
              const gender =
                member.gender === "ë‚¨ì„±"
                  ? "male"
                  : member.gender === "ì—¬ì„±"
                  ? "female"
                  : "other";
              groupStats[targetGroup][gender]++;
              if (!groupStats[targetGroup].colleges[college]) {
                groupStats[targetGroup].colleges[college] = 0;
              }
              groupStats[targetGroup].colleges[college]++;

              console.log(
                `ğŸ‘¤ ${member.name} (${member.gender}/${member.college}) â†’ ${
                  targetGroup + 1
                }ì¡° [${genderLabel} ë¼ìš´ë“œ ë¡œë¹ˆ]`
              );
            });
          });
        };

        // ë‚¨ì„± ë°°ì¹˜
        distributeByCollege(malesByCollege, "ë‚¨ì„±");
        // ì—¬ì„± ë°°ì¹˜
        distributeByCollege(femalesByCollege, "ì—¬ì„±");
        // ê¸°íƒ€ ì„±ë³„ ë°°ì¹˜
        distributeByCollege(othersByCollege, "ê¸°íƒ€");

        // 6ë‹¨ê³„: ì¡° ì¸ì› ê· í˜• ë§ì¶”ê¸° (ì¸ì› ì°¨ì´ê°€ 2ëª… ì´ìƒ ë‚˜ë©´ ì¬ë°°ì¹˜)
        const maxIterations = 10;
        for (let iter = 0; iter < maxIterations; iter++) {
          const sizes = groups.map((g) => g.length);
          const maxSize = Math.max(...sizes);
          const minSize = Math.min(...sizes);

          if (maxSize - minSize <= 1) break; // ì°¨ì´ê°€ 1 ì´í•˜ë©´ ê· í˜• ì¡í˜

          // ê°€ì¥ í° ì¡°ì—ì„œ ê°€ì¥ ì‘ì€ ì¡°ë¡œ ì´ë™
          const maxGroupIdx = sizes.indexOf(maxSize);
          const minGroupIdx = sizes.indexOf(minSize);

          // ì¡°ì¥ì´ ì•„ë‹Œ ë§ˆì§€ë§‰ ë©¤ë²„ë¥¼ ì´ë™
          const maxGroup = groups[maxGroupIdx];
          const memberToMove = maxGroup
            .slice()
            .reverse()
            .find((m) => !m.isLeader);

          if (memberToMove) {
            const idx = maxGroup.indexOf(memberToMove);
            maxGroup.splice(idx, 1);
            groups[minGroupIdx].push(memberToMove);
            console.log(
              `âš–ï¸ ê· í˜• ì¡°ì •: ${memberToMove.name} ${maxGroupIdx + 1}ì¡° â†’ ${
                minGroupIdx + 1
              }ì¡°`
            );
          }
        }

        console.log("âœ… ì„±ë³„+ë‹¨ê³¼ëŒ€ ê· í˜• ë°°ë¶„ ì™„ë£Œ");
        return groups;
      }

      // ì„±ë³„ê³¼ ë‹¨ê³¼ëŒ€ë¥¼ ëª¨ë‘ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
      function balanceGroupsByAllFactors(participants, groups, groupCount) {
        return balanceGroupsByAllFactorsWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // ì„±ë³„ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨) - ê°œì„ ëœ ì•Œê³ ë¦¬ì¦˜
      function balanceGroupsByGenderWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        console.log(
          "ğŸ”„ ì„±ë³„ ê· í˜• ë°°ë¶„ ì‹œì‘",
          participants.length,
          "ëª…,",
          groupCount,
          "ì¡°"
        );

        // 1ë‹¨ê³„: ì¡°ì¥ë“¤ì„ ë¨¼ì € ë°°ì¹˜
        const leaders = participants.filter(
          (p) => p.isLeader && p.targetGroup !== undefined
        );
        leaders.forEach((leader) => {
          groups[leader.targetGroup].push(leader);
          console.log(
            `ğŸ‘‘ ì¡°ì¥ ë°°ì¹˜: ${leader.name} â†’ ${leader.targetGroup + 1}ì¡°`
          );
        });

        // 2ë‹¨ê³„: ê° ì¡°ì˜ í˜„ì¬ ì„±ë³„ êµ¬ì„± í™•ì¸
        const groupStats = groups.map(() => ({
          male: 0,
          female: 0,
          other: 0,
        }));

        groups.forEach((group, groupIndex) => {
          group.forEach((member) => {
            const gender =
              member.gender === "ë‚¨ì„±"
                ? "male"
                : member.gender === "ì—¬ì„±"
                ? "female"
                : "other";
            groupStats[groupIndex][gender]++;
          });
        });

        // 3ë‹¨ê³„: ë‚¨ì€ ì°¸ê°€ìë“¤ì„ ì„±ë³„ë¡œ ë¶„ë¥˜
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const maleParticipants = remainingParticipants.filter(
          (p) => p.gender === "ë‚¨ì„±"
        );
        const femaleParticipants = remainingParticipants.filter(
          (p) => p.gender === "ì—¬ì„±"
        );
        const otherParticipants = remainingParticipants.filter(
          (p) => p.gender !== "ë‚¨ì„±" && p.gender !== "ì—¬ì„±"
        );

        // ê° ì„±ë³„ ê·¸ë£¹ì„ ì„ê¸°
        maleParticipants.sort(() => Math.random() - 0.5);
        femaleParticipants.sort(() => Math.random() - 0.5);
        otherParticipants.sort(() => Math.random() - 0.5);

        // 4ë‹¨ê³„: ì„±ë³„ ê· í˜•ì„ ê³ ë ¤í•œ ë¼ìš´ë“œ ë¡œë¹ˆ ë°°ì¹˜
        const distributeGender = (members, genderLabel) => {
          members.forEach((member, idx) => {
            const targetGroup = idx % groupCount;
            groups[targetGroup].push(member);

            const gender =
              member.gender === "ë‚¨ì„±"
                ? "male"
                : member.gender === "ì—¬ì„±"
                ? "female"
                : "other";
            groupStats[targetGroup][gender]++;

            console.log(
              `ğŸ‘¤ ${member.name} (${member.gender}) â†’ ${
                targetGroup + 1
              }ì¡° [${genderLabel} ë¼ìš´ë“œ ë¡œë¹ˆ]`
            );
          });
        };

        // ë‚¨ì„±, ì—¬ì„±, ê¸°íƒ€ ìˆœì„œë¡œ ë¼ìš´ë“œ ë¡œë¹ˆ ë°°ì¹˜
        distributeGender(maleParticipants, "ë‚¨ì„±");
        distributeGender(femaleParticipants, "ì—¬ì„±");
        distributeGender(otherParticipants, "ê¸°íƒ€");

        // 5ë‹¨ê³„: ì¡° ì¸ì› ê· í˜• ë§ì¶”ê¸°
        const maxIterations = 10;
        for (let iter = 0; iter < maxIterations; iter++) {
          const sizes = groups.map((g) => g.length);
          const maxSize = Math.max(...sizes);
          const minSize = Math.min(...sizes);

          if (maxSize - minSize <= 1) break;

          const maxGroupIdx = sizes.indexOf(maxSize);
          const minGroupIdx = sizes.indexOf(minSize);

          const maxGroup = groups[maxGroupIdx];
          const memberToMove = maxGroup
            .slice()
            .reverse()
            .find((m) => !m.isLeader);

          if (memberToMove) {
            const idx = maxGroup.indexOf(memberToMove);
            maxGroup.splice(idx, 1);
            groups[minGroupIdx].push(memberToMove);
            console.log(
              `âš–ï¸ ê· í˜• ì¡°ì •: ${memberToMove.name} ${maxGroupIdx + 1}ì¡° â†’ ${
                minGroupIdx + 1
              }ì¡°`
            );
          }
        }

        console.log("âœ… ì„±ë³„ ê· í˜• ë°°ë¶„ ì™„ë£Œ");
        return groups;
      }

      // ì„±ë³„ ê· í˜• ë°°ë¶„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
      function balanceGroupsByGender(participants, groups, groupCount) {
        return balanceGroupsByGenderWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // ë‹¨ê³¼ëŒ€ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨) - ê°œì„ ëœ ì•Œê³ ë¦¬ì¦˜
      function balanceGroupsByCollegeWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        console.log(
          "ğŸ”„ ë‹¨ê³¼ëŒ€ ê· í˜• ë°°ë¶„ ì‹œì‘",
          participants.length,
          "ëª…,",
          groupCount,
          "ì¡°"
        );

        // 1ë‹¨ê³„: ì¡°ì¥ë“¤ì„ ë¨¼ì € ë°°ì¹˜
        const leaders = participants.filter(
          (p) => p.isLeader && p.targetGroup !== undefined
        );
        leaders.forEach((leader) => {
          groups[leader.targetGroup].push(leader);
          console.log(
            `ğŸ‘‘ ì¡°ì¥ ë°°ì¹˜: ${leader.name} â†’ ${leader.targetGroup + 1}ì¡°`
          );
        });

        // 2ë‹¨ê³„: ê° ì¡°ì˜ í˜„ì¬ ë‹¨ê³¼ëŒ€ êµ¬ì„± í™•ì¸
        const groupStats = groups.map(() => ({
          colleges: {},
        }));

        groups.forEach((group, groupIndex) => {
          group.forEach((member) => {
            const college = member.college || "ê¸°íƒ€";
            if (!groupStats[groupIndex].colleges[college]) {
              groupStats[groupIndex].colleges[college] = 0;
            }
            groupStats[groupIndex].colleges[college]++;
          });
        });

        // 3ë‹¨ê³„: ë‚¨ì€ ì°¸ê°€ìë“¤ì„ ë‹¨ê³¼ëŒ€ë³„ë¡œ ë¶„ë¥˜
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const collegeGroups = {};
        remainingParticipants.forEach((p) => {
          const college = p.college || "ê¸°íƒ€";
          if (!collegeGroups[college]) collegeGroups[college] = [];
          collegeGroups[college].push(p);
        });

        // ê° ë‹¨ê³¼ëŒ€ì˜ ì°¸ê°€ìë“¤ì„ ì„ê¸°
        Object.keys(collegeGroups).forEach((college) => {
          collegeGroups[college].sort(() => Math.random() - 0.5);
        });

        // 4ë‹¨ê³„: ë‹¨ê³¼ëŒ€ë³„ ë¼ìš´ë“œ ë¡œë¹ˆ ë°°ì¹˜
        Object.keys(collegeGroups).forEach((college) => {
          const members = collegeGroups[college];
          members.forEach((member, idx) => {
            const targetGroup = idx % groupCount;
            groups[targetGroup].push(member);

            // í†µê³„ ì—…ë°ì´íŠ¸
            if (!groupStats[targetGroup].colleges[college]) {
              groupStats[targetGroup].colleges[college] = 0;
            }
            groupStats[targetGroup].colleges[college]++;

            console.log(
              `ğŸ‘¤ ${member.name} (${member.college}) â†’ ${
                targetGroup + 1
              }ì¡° [${college} ë¼ìš´ë“œ ë¡œë¹ˆ]`
            );
          });
        });

        // 5ë‹¨ê³„: ì¡° ì¸ì› ê· í˜• ë§ì¶”ê¸°
        const maxIterations = 10;
        for (let iter = 0; iter < maxIterations; iter++) {
          const sizes = groups.map((g) => g.length);
          const maxSize = Math.max(...sizes);
          const minSize = Math.min(...sizes);

          if (maxSize - minSize <= 1) break;

          const maxGroupIdx = sizes.indexOf(maxSize);
          const minGroupIdx = sizes.indexOf(minSize);

          const maxGroup = groups[maxGroupIdx];
          const memberToMove = maxGroup
            .slice()
            .reverse()
            .find((m) => !m.isLeader);

          if (memberToMove) {
            const idx = maxGroup.indexOf(memberToMove);
            maxGroup.splice(idx, 1);
            groups[minGroupIdx].push(memberToMove);
            console.log(
              `âš–ï¸ ê· í˜• ì¡°ì •: ${memberToMove.name} ${maxGroupIdx + 1}ì¡° â†’ ${
                minGroupIdx + 1
              }ì¡°`
            );
          }
        }

        console.log("âœ… ë‹¨ê³¼ëŒ€ ê· í˜• ë°°ë¶„ ì™„ë£Œ");
        return groups;
      }

      // ë‹¨ê³¼ëŒ€ ê· í˜• ë°°ë¶„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
      function balanceGroupsByCollege(participants, groups, groupCount) {
        return balanceGroupsByCollegeWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // ë¬´ì‘ìœ„ ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
      function randomDistributionWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        console.log(
          "ğŸ”„ ë¬´ì‘ìœ„ ë°°ë¶„ ì‹œì‘",
          participants.length,
          "ëª…,",
          groupCount,
          "ì¡°"
        );

        // 1ë‹¨ê³„: ì¡°ì¥ë“¤ì„ ë¨¼ì € ë°°ì¹˜
        const leaders = participants.filter(
          (p) => p.isLeader && p.targetGroup !== undefined
        );
        leaders.forEach((leader) => {
          groups[leader.targetGroup].push(leader);
          console.log(
            `ğŸ‘‘ ì¡°ì¥ ë°°ì¹˜: ${leader.name} â†’ ${leader.targetGroup + 1}ì¡°`
          );
        });

        // 2ë‹¨ê³„: ë‚¨ì€ ì°¸ê°€ìë“¤ì„ ë¬´ì‘ìœ„ë¡œ ì„ê¸°
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const shuffled = [...remainingParticipants].sort(
          () => Math.random() - 0.5
        );

        // 3ë‹¨ê³„: ì¡° í¬ê¸° ê· í˜•ì„ ê³ ë ¤í•œ ë°°ì¹˜
        shuffled.forEach((participant, index) => {
          // ê°€ì¥ ì¸ì›ì´ ì ì€ ì¡°ì— ë°°ì¹˜
          let targetGroup = 0;
          let minSize = groups[0].length;

          for (let i = 1; i < groupCount; i++) {
            if (groups[i].length < minSize) {
              minSize = groups[i].length;
              targetGroup = i;
            }
          }

          groups[targetGroup].push(participant);
          console.log(`ğŸ‘¤ ${participant.name} â†’ ${targetGroup + 1}ì¡°`);
        });

        console.log("âœ… ë¬´ì‘ìœ„ ë°°ë¶„ ì™„ë£Œ");
        return groups;
      }

      // ë¬´ì‘ìœ„ ë°°ë¶„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
      function randomDistribution(participants, groups, groupCount) {
        return randomDistributionWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // ì¡° ê²°ê³¼ í‘œì‹œ ëª¨ë‹¬ - OLD VERSION (ì‚¬ìš©ì•ˆí•¨)
      function showGroupResults_OLD(eventId, groups, participants) {
        console.log("ğŸŠ ì¡° ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ ì‹œì‘", {
          eventId,
          groupsCount: groups.length,
          participantsCount: participants.length,
        });
        closeGroupMakerModal();
        console.log("ğŸ”´ ì¡°ì§œê¸° ì„¤ì • ëª¨ë‹¬ ë‹«ê¸° ì™„ë£Œ");

        // ê° ì¡°ì˜ ì„±ë³„ í†µê³„ ê³„ì‚°
        const getGroupStats = (group) => {
          const maleCount = group.filter((m) => m.gender === "ë‚¨ì„±").length;
          const femaleCount = group.filter((m) => m.gender === "ì—¬ì„±").length;
          return { maleCount, femaleCount };
        };

        const modalHTML = `
                            <div id="group-results-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                              <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                                <!-- í—¤ë” -->
                                <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-6 py-5 flex justify-between items-center">
                                  <div class="flex items-center gap-4">
                                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                                      <i class="fas fa-check-circle text-white text-2xl"></i>
                    </div>
                                    <div>
                                      <h3 class="text-2xl font-bold text-white">ì¡°ì§œê¸° ì™„ë£Œ!</h3>
                                      <p class="text-green-100 text-sm mt-1">
                                        <i class="fas fa-users mr-1"></i>
                              ì´ <strong>${
                                participants.length
                              }ëª…</strong>ì„ <strong>${
          groups.length
        }ê°œ ì¡°</strong>ë¡œ ë‚˜ëˆ„ì—ˆìŠµë‹ˆë‹¤
                      </p>
                                    </div>
                                  </div>
                                  <button type="button" id="group-results-close" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200">
                                    <i class="fas fa-times text-2xl"></i>
                                  </button>
                    </div>

                                <!-- ì»¨í…ì¸  ì˜ì—­ -->
                                <div class="overflow-y-auto flex-1 px-6 py-6">
                                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                      ${groups
                        .map((group, index) => {
                          const stats = getGroupStats(group);
                          const colors = [
                            "from-blue-500 to-blue-600",
                            "from-purple-500 to-purple-600",
                            "from-pink-500 to-pink-600",
                            "from-orange-500 to-orange-600",
                            "from-teal-500 to-teal-600",
                            "from-indigo-500 to-indigo-600",
                            "from-red-500 to-red-600",
                            "from-yellow-500 to-yellow-600",
                          ];
                          const color = colors[index % colors.length];

                          return `
                                          <div class="bg-white border-2 border-gray-200 rounded-2xl overflow-hidden hover:shadow-xl transition-all duration-300">
                                            <!-- ì¡° í—¤ë” -->
                                            <div class="bg-gradient-to-r ${color} px-5 py-4">
                                              <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                  <div class="bg-white bg-opacity-30 rounded-full px-4 py-2">
                                                    <span class="text-2xl font-bold text-white">${
                                                      index + 1
                                                    }</span>
                                                  </div>
                                                  <div>
                                                    <h4 class="text-xl font-bold text-white">${
                                                      index + 1
                                                    }ì¡°</h4>
                                                    <p class="text-white text-opacity-90 text-sm">ì´ ${
                                                      group.length
                                                    }ëª…</p>
                                                  </div>
                                                </div>
                                                <div class="flex gap-2">
                                                  <div class="bg-white bg-opacity-20 rounded-lg px-3 py-1 text-white text-sm font-medium">
                                                    <i class="fas fa-mars mr-1"></i>${
                                                      stats.maleCount
                                                    }
                                                  </div>
                                                  <div class="bg-white bg-opacity-20 rounded-lg px-3 py-1 text-white text-sm font-medium">
                                                    <i class="fas fa-venus mr-1"></i>${
                                                      stats.femaleCount
                                                    }
                                                  </div>
                                                </div>
                                              </div>
                                            </div>

                                            <!-- ì¡°ì› ëª©ë¡ -->
                                            <div class="p-4">
                                              <div class="space-y-2">
                          ${group
                            .map(
                              (member, memberIndex) => `
                                                  <div class="flex items-center gap-3 p-3 rounded-xl transition-all duration-200 ${
                                                    member.isLeader
                                                      ? "bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-300 shadow-md"
                                                      : "bg-gray-50 hover:bg-gray-100 border-2 border-transparent"
                                                  }">
                                                    ${
                                                      member.isLeader
                                                        ? `<div class="flex items-center justify-center w-8 h-8 bg-gradient-to-br from-yellow-400 to-orange-400 rounded-full">
                                                             <i class="fas fa-crown text-white text-sm"></i>
                                                           </div>`
                                                        : `<div class="flex items-center justify-center w-8 h-8 bg-gray-300 rounded-full text-gray-700 font-bold text-sm">
                                                             ${memberIndex + 1}
                                                           </div>`
                                                    }
                                                    <div class="flex-1">
                                                      <div class="flex items-center gap-2">
                                                        <span class="font-bold text-gray-800">${
                                                          member.name
                                                        }</span>
                                                        ${
                                                          member.isLeader
                                                            ? '<span class="text-xs bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full font-bold">ì¡°ì¥</span>'
                                                            : ""
                                                        }
                                                      </div>
                                                      <p class="text-xs text-gray-500 mt-0.5">
                                                        ${member.studentId} Â· ${
                                member.gender
                              } Â· ${member.college}
                                                      </p>
                                                    </div>
                            </div>
                          `
                            )
                            .join("")}
                        </div>
                                            </div>
                                          </div>
                                        `;
                        })
                        .join("")}
                                  </div>
                    </div>

                                <!-- í‘¸í„° -->
                                <div class="px-6 py-4 bg-gray-50 border-t-2 border-gray-200">
                                  <div class="flex flex-col sm:flex-row gap-3">
                      <button type="button" id="group-export-excel"
                                            class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 px-6 rounded-xl hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2 font-semibold group">
                                      <i class="fas fa-file-excel text-lg group-hover:scale-110 transition-transform"></i>
                                      <span>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</span>
                      </button>
                      <button type="button" id="group-export-csv"
                                            class="flex-1 bg-gradient-to-r from-blue-600 to-sky-600 text-white py-3 px-6 rounded-xl hover:shadow-lg transition-all duration-200 flex items-center justify-center gap-2 font-semibold group">
                                      <i class="fas fa-file-csv text-lg group-hover:scale-110 transition-transform"></i>
                                      <span>CSV ë‹¤ìš´ë¡œë“œ</span>
                      </button>
                      <button type="button" id="group-results-cancel"
                                            class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-white hover:border-gray-400 transition-all duration-200 font-semibold">
                                      <i class="fas fa-times mr-2"></i>ë‹«ê¸°
                      </button>
                                  </div>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
        console.log("âœ… ì¡° ê²°ê³¼ ëª¨ë‹¬ DOMì— ì¶”ê°€ ì™„ë£Œ");

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        console.log("ğŸ”— ê²°ê³¼ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì¤‘...");
        const closeBtn = document.getElementById("group-results-close");
        const cancelBtn = document.getElementById("group-results-cancel");
        const excelBtn = document.getElementById("group-export-excel");
        const csvBtn = document.getElementById("group-export-csv");

        if (!closeBtn || !cancelBtn || !excelBtn || !csvBtn) {
          console.error("âŒ ê²°ê³¼ ëª¨ë‹¬ ë²„íŠ¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤", {
            closeBtn,
            cancelBtn,
            excelBtn,
            csvBtn,
          });
        }

        if (closeBtn) {
          closeBtn.addEventListener("click", () => {
            console.log("ğŸ”´ ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨");
            closeGroupResultsModal();
          });
        }
        if (cancelBtn) {
          cancelBtn.addEventListener("click", () => {
            console.log("ğŸ”´ ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨");
            closeGroupResultsModal();
          });
        }
        if (excelBtn) {
          excelBtn.addEventListener("click", () => {
            console.log("ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ë¨");
            exportGroupsToExcel(eventId, groups, participants);
          });
        }
        if (csvBtn) {
          csvBtn.addEventListener("click", () => {
            console.log("ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ë¨");
            exportGroupsToCSV(eventId, groups, participants);
          });
        }
        console.log("âœ… ê²°ê³¼ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì™„ë£Œ");
        console.log("ğŸ‰ ì¡° ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ!");
      }

      // ì¡° ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
      function closeGroupResultsModal() {
        console.log("ğŸ”´ ì¡° ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸° í˜¸ì¶œë¨");
        const modal = document.getElementById("group-results-modal");
        if (modal) {
          modal.remove();
          console.log("âœ… ì¡° ê²°ê³¼ ëª¨ë‹¬ ì œê±° ì™„ë£Œ");
        } else {
          console.warn("âš ï¸ ì¡° ê²°ê³¼ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        }
      }

      // ì—‘ì…€ íŒŒì¼ë¡œ ì¡° ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      async function exportGroupsToExcel(eventId, groups, participants) {
        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) return showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
          if (typeof XLSX === "undefined") {
            return showAlert("ğŸ˜¥", "ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          // ì›Œí¬ë¶ ìƒì„±
          const wb = XLSX.utils.book_new();

          // ê°„ë‹¨í•œ í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ìƒì„± (ì—´: ì¡°, í–‰: ì´ë¦„)
          const maxGroupSize = Math.max(...groups.map((group) => group.length));
          const simpleData = [];

          // í—¤ë” ìƒì„± (1ì¡°, 2ì¡°, 3ì¡°...)
          const headers = [];
          for (let i = 1; i <= groups.length; i++) {
            headers.push(`${i}ì¡°`);
          }
          simpleData.push(headers);

          // ê° í–‰ì— ì¡°ì› ì´ë¦„ë“¤ ì¶”ê°€
          for (let row = 0; row < maxGroupSize; row++) {
            const rowData = [];
            groups.forEach((group, groupIndex) => {
              const member = group[row];
              if (member) {
                // ì¡°ì¥ì€ ì´ë¦„ ë’¤ì— (ì¡°ì¥) í‘œì‹œ
                const name = member.isLeader
                  ? `${member.name} (ì¡°ì¥)`
                  : member.name;
                rowData.push(name);
              } else {
                rowData.push(""); // ë¹ˆ ì…€
              }
            });
            simpleData.push(rowData);
          }

          // ì›Œí¬ì‹œíŠ¸ ìƒì„±
          const ws = XLSX.utils.aoa_to_sheet(simpleData);

          // ì—´ ë„ˆë¹„ ì„¤ì •
          ws["!cols"] = groups.map(() => ({ wch: 15 })); // ê° ì¡°ì—´ì˜ ë„ˆë¹„

          // ì‹œíŠ¸ ì¶”ê°€
          XLSX.utils.book_append_sheet(wb, ws, "ì¡°êµ¬ì„±");

          // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          const fileName = `${
            ev.title || "ì´ë²¤íŠ¸"
          }_ì¡°êµ¬ì„±_${getTodayString()}.xlsx`;
          XLSX.writeFile(wb, fileName);

          showAlert("âœ…", "ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
          closeGroupResultsModal();
        } catch (error) {
          console.error("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // CSV íŒŒì¼ë¡œ ì¡° ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      async function exportGroupsToCSV(eventId, groups, participants) {
        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) return showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          let csvContent = "";

          // ê°„ë‹¨í•œ í˜•ì‹ìœ¼ë¡œ CSV ìƒì„± (ì—´: ì¡°, í–‰: ì´ë¦„)
          const maxGroupSize = Math.max(...groups.map((group) => group.length));

          // í—¤ë” ìƒì„± (1ì¡°, 2ì¡°, 3ì¡°...)
          const headers = [];
          for (let i = 1; i <= groups.length; i++) {
            headers.push(`${i}ì¡°`);
          }
          csvContent += headers.join(",") + "\n";

          // ê° í–‰ì— ì¡°ì› ì´ë¦„ë“¤ ì¶”ê°€
          for (let row = 0; row < maxGroupSize; row++) {
            const rowData = [];
            groups.forEach((group, groupIndex) => {
              const member = group[row];
              if (member) {
                // ì¡°ì¥ì€ ì´ë¦„ ë’¤ì— (ì¡°ì¥) í‘œì‹œ
                const name = member.isLeader
                  ? `${member.name} (ì¡°ì¥)`
                  : member.name;
                rowData.push(name);
              } else {
                rowData.push(""); // ë¹ˆ ì…€
              }
            });
            csvContent += rowData.join(",") + "\n";
          }

          // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);

          const fileName = `${
            ev.title || "ì´ë²¤íŠ¸"
          }_ì¡°êµ¬ì„±_${getTodayString()}.csv`;
          link.setAttribute("download", fileName);
          link.style.visibility = "hidden";

          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          URL.revokeObjectURL(url);

          showAlert("âœ…", "CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
          closeGroupResultsModal();
        } catch (error) {
          console.error("CSV ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function exportApplicantsXLSX(id) {
        try {
          const ev = eventsData.find((e) => e.id === id);
          if (!ev) return showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          let rows = [],
            header = [];

          if (ev.type === "tasting") {
            header = [
              "êµ¬ë¶„",
              "ì‹ë‹¹",
              "ì´ë¦„",
              "í•™ë²ˆ",
              "ì„±ë³„",
              "í•™ë…„",
              "ë‹¨ê³¼ëŒ€",
              "í•™ê³¼",
              "ì „í™”ë²ˆí˜¸",
              "ë¹„ê³ ",
            ];
            (ev.restaurants || []).forEach((r) => {
              (r.reservations || []).forEach((p) =>
                rows.push({
                  êµ¬ë¶„: "ì°¸ê°€",
                  ì‹ë‹¹: r.name || "",
                  ì´ë¦„: p.name || "",
                  í•™ë²ˆ: p.studentId || "",
                  ì„±ë³„: p.gender || "",
                  í•™ë…„: p.year || "",
                  ë‹¨ê³¼ëŒ€: p.college || "",
                  í•™ê³¼: p.department || "",
                  ì „í™”ë²ˆí˜¸: p.phone || "",
                  ë¹„ê³ : "",
                })
              );
              (r.waiting || []).forEach((p) =>
                rows.push({
                  êµ¬ë¶„: "ëŒ€ê¸°",
                  ì‹ë‹¹: r.name || "",
                  ì´ë¦„: p.name || "",
                  í•™ë²ˆ: p.studentId || "",
                  ì„±ë³„: p.gender || "",
                  í•™ë…„: p.year || "",
                  ë‹¨ê³¼ëŒ€: p.college || "",
                  í•™ê³¼: p.department || "",
                  ì „í™”ë²ˆí˜¸: p.phone || "",
                  ë¹„ê³ : "",
                })
              );
            });
          } else if (ev.type === "mt" || ev.type === "assembly") {
            header = [
              "êµ¬ë¶„",
              "ì´ë¦„",
              "í•™ë²ˆ",
              "ì„±ë³„",
              "í•™ë…„",
              "ë‹¨ê³¼ëŒ€",
              "í•™ê³¼",
              "ì „í™”ë²ˆí˜¸",
              "ë¹„ê³ ",
            ];
            (ev.applicants || []).forEach((p) =>
              rows.push({
                êµ¬ë¶„: "ì°¸ê°€",
                ì´ë¦„: p.name || "",
                í•™ë²ˆ: p.studentId || "",
                ì„±ë³„: p.gender || "",
                í•™ë…„: p.year || "",
                ë‹¨ê³¼ëŒ€: p.college || "",
                í•™ê³¼: p.department || "",
                ì „í™”ë²ˆí˜¸: p.phone || "",
                ë¹„ê³ : "",
              })
            );
            (ev.waiting || []).forEach((p) =>
              rows.push({
                êµ¬ë¶„: "ëŒ€ê¸°",
                ì´ë¦„: p.name || "",
                í•™ë²ˆ: p.studentId || "",
                ì„±ë³„: p.gender || "",
                í•™ë…„: p.year || "",
                ë‹¨ê³¼ëŒ€: p.college || "",
                í•™ê³¼: p.department || "",
                ì „í™”ë²ˆí˜¸: p.phone || "",
                ë¹„ê³ : "",
              })
            );
          } else {
            header = [
              "êµ¬ë¶„",
              "ì´ë¦„",
              "í•™ë²ˆ",
              "ì„±ë³„",
              "í•™ë…„",
              "ë‹¨ê³¼ëŒ€",
              "í•™ê³¼",
              "ì „í™”ë²ˆí˜¸",
              "ë¹„ê³ ",
            ];
            (ev.applicants || []).forEach((p) =>
              rows.push({
                êµ¬ë¶„: "ì°¸ê°€",
                ì´ë¦„: p.name || "",
                í•™ë²ˆ: p.studentId || "",
                ì„±ë³„: p.gender || "",
                í•™ë…„: p.year || "",
                ë‹¨ê³¼ëŒ€: p.college || "",
                í•™ê³¼: p.department || "",
                ì „í™”ë²ˆí˜¸: p.phone || "",
                ë¹„ê³ : "",
              })
            );
            (ev.waiting || []).forEach((p) =>
              rows.push({
                êµ¬ë¶„: "ëŒ€ê¸°",
                ì´ë¦„: p.name || "",
                í•™ë²ˆ: p.studentId || "",
                ì„±ë³„: p.gender || "",
                í•™ë…„: p.year || "",
                ë‹¨ê³¼ëŒ€: p.college || "",
                í•™ê³¼: p.department || "",
                ì „í™”ë²ˆí˜¸: p.phone || "",
                ë¹„ê³ : "",
              })
            );
          }
          if (rows.length === 0)
            rows = [
              {
                êµ¬ë¶„: "-",
                ì´ë¦„: "-",
                í•™ë²ˆ: "-",
                ì„±ë³„: "-",
                í•™ë…„: "-",
                ë‹¨ê³¼ëŒ€: "-",
                í•™ê³¼: "-",
                ì „í™”ë²ˆí˜¸: "-",
                ë¹„ê³ : "",
              },
            ];

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(rows, { header });
          XLSX.utils.book_append_sheet(wb, ws, "ëª…ë‹¨");
          const fname = `${ev.title || "event"}_ëª…ë‹¨.xlsx`;
          XLSX.writeFile(wb, fname);
        } catch (e) {
          console.warn(e);
          showAlert("ğŸ˜¥", "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
        }
      }

      /* ===== ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ë° íšŒì› ê´€ë¦¬ ===== */

      // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("click", (e) => {
        if (e.target.id === "excel-upload-btn") {
          document.getElementById("excel-upload").click();
        }

        if (e.target.id === "download-template") {
          downloadExcelTemplate();
        }

        if (e.target.closest("#file-drop-zone")) {
          document.getElementById("excel-upload").click();
        }
      });

      document.addEventListener("change", (e) => {
        if (e.target.id === "excel-upload") {
          const file = e.target.files[0];
          if (file) {
            handleFileUpload(file);
          }
        }
      });

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("dragover", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.add("border-green-400", "bg-green-50");
        }
      });

      document.addEventListener("dragleave", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.remove("border-green-400", "bg-green-50");
        }
      });

      document.addEventListener("drop", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.remove("border-green-400", "bg-green-50");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFileUpload(files[0]);
          }
        }
      });

      // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
      function downloadExcelTemplate() {
        try {
          const templateData = [
            [
              "ì´ë¦„",
              "í•™ë²ˆ",
              "ì„±ë³„",
              "í•™ë…„",
              "ë‹¨ê³¼ëŒ€",
              "í•™ê³¼",
              "ì „í™”ë²ˆí˜¸",
              "ìƒíƒœ",
            ],
            [
              "í™ê¸¸ë™",
              "20241234",
              "ë‚¨",
              "1",
              "ê³µê³¼ëŒ€í•™",
              "ì»´í“¨í„°ê³µí•™ê³¼",
              "010-1234-5678",
              "ìŠ¹ì¸",
            ],
            [
              "ê¹€ì˜í¬",
              "20245678",
              "ì—¬",
              "2",
              "ì¸ë¬¸ëŒ€í•™",
              "ì˜ì–´ì˜ë¬¸í•™ê³¼",
              "010-9876-5432",
              "ëŒ€ê¸°",
            ],
          ];

          const ws = XLSX.utils.aoa_to_sheet(templateData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "íšŒì›ì •ë³´");

          XLSX.writeFile(wb, "íšŒì›ì •ë³´_í…œí”Œë¦¿.xlsx");
          showAlert("âœ…", "ì—‘ì…€ í…œí”Œë¦¿ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // íŒŒì¼ ì²˜ë¦¬ (Excel/CSV)
      async function handleFileUpload(file) {
        const progressDiv = document.getElementById("upload-progress");
        const resultDiv = document.getElementById("upload-result");

        try {
          // íŒŒì¼ í¬ê¸° ê²€ì¦ (10MB ì œí•œ)
          if (file.size > 10 * 1024 * 1024) {
            throw new Error("íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€ 10MB)");
          }

          // íŒŒì¼ í˜•ì‹ ê²€ì¦
          const fileName = file.name.toLowerCase();
          if (
            !fileName.endsWith(".xlsx") &&
            !fileName.endsWith(".xls") &&
            !fileName.endsWith(".csv")
          ) {
            throw new Error(
              "ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (.xlsx, .xls, .csvë§Œ ì§€ì›)"
            );
          }

          // ì§„í–‰ ìƒíƒœ í‘œì‹œ
          progressDiv.classList.remove("hidden");
          resultDiv.classList.add("hidden");

          // íŒŒì¼ ì½ê¸°
          const data = await readFile(file);
          console.log("íŒŒì¼ ë°ì´í„°:", data);

          if (!data || data.length < 2) {
            throw new Error("íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          }

          // ë°ì´í„° ê²€ì¦
          const validationResult = validateFileData(data);
          console.log("ê²€ì¦ ê²°ê³¼:", validationResult);

          if (!validationResult.isValid) {
            throw new Error(
              `ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨: ${validationResult.errors.join(", ")}`
            );
          }

          // ë³€ê²½ì‚¬í•­ ë¶„ì„
          const analysis = analyzeMemberData(data);
          console.log("ë³€ê²½ì‚¬í•­ ë¶„ì„:", analysis);

          // ì§„í–‰ ìƒíƒœ ìˆ¨ê¸°ê¸°
          progressDiv.classList.add("hidden");

          // ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
          if (analysis.changes.length > 0 || analysis.newMembers.length > 0) {
            showChangeConfirmationModal(analysis, data);
          } else {
            showAlert("â„¹ï¸", "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);

          // ì§„í–‰ ìƒíƒœ ìˆ¨ê¸°ê¸°
          progressDiv.classList.add("hidden");

          // ì˜¤ë¥˜ ì•Œë¦¼
          showAlert("ğŸ˜¥", `íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        } finally {
          // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
          const fileInput = document.getElementById("excel-upload");
          if (fileInput) {
            fileInput.value = "";
          }
        }
      }

      // íŒŒì¼ ì½ê¸° (Excel/CSV)
      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const fileName = file.name.toLowerCase();

              if (fileName.endsWith(".csv")) {
                // CSV íŒŒì¼ ì²˜ë¦¬
                const csvText = e.target.result;
                const lines = csvText.split("\n");
                const data = lines.map((line) => {
                  // CSV íŒŒì‹± (ì‰¼í‘œ êµ¬ë¶„, ë”°ì˜´í‘œ ì²˜ë¦¬)
                  const result = [];
                  let current = "";
                  let inQuotes = false;

                  for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                      inQuotes = !inQuotes;
                    } else if (char === "," && !inQuotes) {
                      result.push(current.trim());
                      current = "";
                    } else {
                      current += char;
                    }
                  }
                  result.push(current.trim());
                  return result;
                });
                resolve(data);
              } else {
                // Excel íŒŒì¼ ì²˜ë¦¬
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                  header: 1,
                });
                resolve(jsonData);
              }
            } catch (error) {
              reject(new Error("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            }
          };
          reader.onerror = () => reject(new Error("íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));

          if (file.name.toLowerCase().endsWith(".csv")) {
            reader.readAsText(file, "UTF-8");
          } else {
            reader.readAsArrayBuffer(file);
          }
        });
      }

      // íŒŒì¼ ë°ì´í„° ê²€ì¦ (ìœ ì—°í•œ íŒŒì‹±)
      function validateFileData(data) {
        const warnings = [];
        const errors = [];

        if (!data || data.length < 2) {
          errors.push("íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return { isValid: false, errors, warnings };
        }

        // í—¤ë” ë§¤í•‘ (ìœ ì—°í•œ ì»¬ëŸ¼ ì¸ì‹)
        const headers = data[0];
        const headerMapping = findHeaderMapping(headers);

        if (headerMapping.name === -1 || headerMapping.studentId === -1) {
          errors.push("ì´ë¦„ê³¼ í•™ë²ˆ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // ê²½ê³  ë©”ì‹œì§€ ì¶”ê°€
        if (headerMapping.gender === -1)
          warnings.push("ì„±ë³„ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.year === -1)
          warnings.push("í•™ë…„ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.college === -1)
          warnings.push("ë‹¨ê³¼ëŒ€ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.department === -1)
          warnings.push("í•™ê³¼ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.phone === -1)
          warnings.push("ì „í™”ë²ˆí˜¸ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.status === -1)
          warnings.push("ìƒíƒœ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        return {
          isValid: errors.length === 0,
          errors,
          warnings,
          headerMapping,
        };
      }

      // í—¤ë” ë§¤í•‘ ì°¾ê¸° (ìœ ì—°í•œ ì»¬ëŸ¼ ì¸ì‹)
      function findHeaderMapping(headers) {
        const mapping = {
          name: -1,
          studentId: -1,
          gender: -1,
          year: -1,
          college: -1,
          department: -1,
          phone: -1,
          status: -1,
        };

        headers.forEach((header, index) => {
          const headerLower = header?.toString().toLowerCase().trim();

          if (headerLower?.includes("ì´ë¦„") || headerLower?.includes("name")) {
            mapping.name = index;
          } else if (
            headerLower?.includes("í•™ë²ˆ") ||
            headerLower?.includes("student") ||
            headerLower?.includes("id")
          ) {
            mapping.studentId = index;
          } else if (
            headerLower?.includes("ì„±ë³„") ||
            headerLower?.includes("gender")
          ) {
            mapping.gender = index;
          } else if (
            headerLower?.includes("í•™ë…„") ||
            headerLower?.includes("year") ||
            headerLower?.includes("grade")
          ) {
            mapping.year = index;
          } else if (
            headerLower?.includes("ë‹¨ê³¼ëŒ€") ||
            headerLower?.includes("college")
          ) {
            mapping.college = index;
          } else if (
            headerLower?.includes("í•™ê³¼") ||
            headerLower?.includes("department") ||
            headerLower?.includes("major")
          ) {
            mapping.department = index;
          } else if (
            headerLower?.includes("ì „í™”") ||
            headerLower?.includes("phone") ||
            headerLower?.includes("ì—°ë½ì²˜")
          ) {
            mapping.phone = index;
          } else if (
            headerLower?.includes("ìƒíƒœ") ||
            headerLower?.includes("status")
          ) {
            mapping.status = index;
          }
        });

        return mapping;
      }

      // íšŒì› ë°ì´í„° ë¶„ì„ (ë³€ê²½ì‚¬í•­ í”„ë¦¬ë·°)
      function analyzeMemberData(data) {
        const headers = data[0];
        const rows = data.slice(1);
        const headerMapping = findHeaderMapping(headers);

        const changes = [];
        const newMembers = [];
        const errors = [];

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          try {
            // ìœ ì—°í•œ ë°ì´í„° ì¶”ì¶œ
            const memberData = {
              name:
                headerMapping.name !== -1
                  ? row[headerMapping.name]?.toString().trim()
                  : "",
              studentId:
                headerMapping.studentId !== -1
                  ? row[headerMapping.studentId]?.toString().trim()
                  : "",
              gender:
                headerMapping.gender !== -1
                  ? row[headerMapping.gender]?.toString().trim()
                  : "",
              year:
                headerMapping.year !== -1
                  ? row[headerMapping.year]?.toString().trim()
                  : "",
              college:
                headerMapping.college !== -1
                  ? row[headerMapping.college]?.toString().trim()
                  : "",
              department:
                headerMapping.department !== -1
                  ? row[headerMapping.department]?.toString().trim()
                  : "",
              phone:
                headerMapping.phone !== -1
                  ? row[headerMapping.phone]?.toString().trim()
                  : "",
              status:
                headerMapping.status !== -1
                  ? row[headerMapping.status]?.toString().trim()
                  : "",
            };

            // í•„ìˆ˜ í•„ë“œ í™•ì¸
            if (!memberData.name || !memberData.studentId) {
              errors.push(`${i + 2}ë²ˆì§¸ í–‰: ì´ë¦„ê³¼ í•™ë²ˆì€ í•„ìˆ˜ì…ë‹ˆë‹¤.`);
              continue;
            }

            // ìƒíƒœê°’ ë³€í™˜ (í•œêµ­ì–´ â†’ ì˜ì–´)
            const convertedStatus = convertStatusToEnglish(memberData.status);

            // ê¸°ì¡´ íšŒì› í™•ì¸
            const existingMember = membersData.find(
              (m) => m.studentId === memberData.studentId
            );

            if (existingMember) {
              // ë³€ê²½ì‚¬í•­ í™•ì¸
              const changeDetails = [];

              if (memberData.name && memberData.name !== existingMember.name) {
                changeDetails.push({
                  field: "ì´ë¦„",
                  old: existingMember.name,
                  new: memberData.name,
                });
              }
              if (
                memberData.gender &&
                memberData.gender !== existingMember.gender
              ) {
                changeDetails.push({
                  field: "ì„±ë³„",
                  old: existingMember.gender,
                  new: memberData.gender,
                });
              }
              if (memberData.year && memberData.year !== existingMember.year) {
                changeDetails.push({
                  field: "í•™ë…„",
                  old: existingMember.year,
                  new: memberData.year,
                });
              }
              if (
                memberData.college &&
                memberData.college !== existingMember.college
              ) {
                changeDetails.push({
                  field: "ë‹¨ê³¼ëŒ€",
                  old: existingMember.college,
                  new: memberData.college,
                });
              }
              if (
                memberData.department &&
                memberData.department !== existingMember.department
              ) {
                changeDetails.push({
                  field: "í•™ê³¼",
                  old: existingMember.department,
                  new: memberData.department,
                });
              }
              if (
                memberData.phone &&
                memberData.phone !== existingMember.phone
              ) {
                changeDetails.push({
                  field: "ì „í™”ë²ˆí˜¸",
                  old: existingMember.phone,
                  new: memberData.phone,
                });
              }

              // ìƒíƒœëŠ” í™œë™ì¤‘ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë³€ê²½ ê°€ëŠ¥í•˜ë„ë¡ í‘œì‹œ
              if (
                convertedStatus &&
                convertedStatus !== existingMember.status
              ) {
                const statusDisplay = {
                  active: "í™œë™ì¤‘",
                  pending: "ìŠ¹ì¸ëŒ€ê¸°",
                  rejected: "ê±°ì ˆë¨",
                  blocked: "ì°¨ë‹¨ë¨",
                };
                changeDetails.push({
                  field: "ìƒíƒœ",
                  old:
                    statusDisplay[existingMember.status] ||
                    existingMember.status,
                  new: statusDisplay[convertedStatus] || convertedStatus,
                  warning:
                    existingMember.status === "active"
                      ? "âš ï¸ í™œë™ì¤‘ íšŒì›ì˜ ìƒíƒœ ë³€ê²½"
                      : null,
                });
              }

              if (changeDetails.length > 0) {
                changes.push({
                  studentId: existingMember.studentId,
                  name: existingMember.name,
                  currentStatus: existingMember.status,
                  changes: changeDetails,
                  existingMember: existingMember,
                  newData: memberData,
                  convertedStatus: convertedStatus,
                });
              }
            } else {
              // ìƒˆ íšŒì›
              newMembers.push({
                ...memberData,
                status: convertedStatus || "pending",
              });
            }
          } catch (error) {
            errors.push(`${i + 2}ë²ˆì§¸ í–‰ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`);
          }
        }

        return { changes, newMembers, errors };
      }

      // íšŒì› ë°ì´í„° ì²˜ë¦¬ (ìŠ¹ì¸ëœ ë³€ê²½ì‚¬í•­ë§Œ ì ìš©)
      async function processMemberData(data, approvedChanges = []) {
        let updatedCount = 0;
        let newCount = 0;
        let errorCount = 0;
        const errors = [];

        const batch = writeBatch(db);

        // ìŠ¹ì¸ëœ ë³€ê²½ì‚¬í•­ ì ìš©
        for (const change of approvedChanges) {
          try {
            const updateData = { lastUpdated: new Date().toISOString() };

            // ìŠ¹ì¸ëœ ë³€ê²½ì‚¬í•­ë§Œ ì ìš©
            for (const detail of change.changes) {
              const fieldMap = {
                ì´ë¦„: "name",
                ì„±ë³„: "gender",
                í•™ë…„: "year",
                ë‹¨ê³¼ëŒ€: "college",
                í•™ê³¼: "department",
                ì „í™”ë²ˆí˜¸: "phone",
                ìƒíƒœ: "status",
              };

              const dbField = fieldMap[detail.field];
              if (dbField === "status") {
                updateData[dbField] = change.convertedStatus;
              } else {
                updateData[dbField] = detail.new;
              }
            }

            const memberRef = doc(db, "members", change.existingMember.id);
            batch.update(memberRef, updateData);
            updatedCount++;
          } catch (error) {
            errors.push(
              `${change.name} (${change.studentId}) ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`
            );
            errorCount++;
          }
        }

        try {
          await batch.commit();
          return {
            success: true,
            updatedCount,
            newCount,
            errorCount,
            errors,
          };
        } catch (error) {
          console.error("ë°°ì¹˜ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
          throw new Error(`ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
      }

      // ë³€ê²½ì‚¬í•­ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
      function showChangeConfirmationModal(analysis, originalData) {
        const { changes, newMembers, errors } = analysis;

        const modalHTML = `
                <div id="change-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                  <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4 flex justify-between items-center">
                      <div>
                        <h3 class="text-2xl font-bold text-white">ë³€ê²½ì‚¬í•­ í™•ì¸</h3>
                        <p class="text-orange-100 text-sm">ë³€ê²½ì‚¬í•­ì„ ê²€í† í•˜ê³  ì ìš©í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
                      </div>
                      <button type="button" onclick="document.getElementById('change-confirmation-modal').remove()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2">
                        <i class="fas fa-times text-xl"></i>
                      </button>
                    </div>

                    <div class="p-6 overflow-y-auto flex-1">
                      ${
                        changes.length > 0
                          ? `
                        <div class="mb-6">
                          <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-bold text-gray-800">
                              <i class="fas fa-edit mr-2 text-blue-600"></i>ê¸°ì¡´ íšŒì› ë³€ê²½ì‚¬í•­ (${
                                changes.length
                              }ê±´)
                            </h4>
                            <div class="flex gap-2">
                              <button onclick="selectAllChanges(true)" class="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">ì „ì²´ ì„ íƒ</button>
                              <button onclick="selectAllChanges(false)" class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">ì „ì²´ í•´ì œ</button>
                            </div>
                          </div>
                          <div class="space-y-3">
                            ${changes
                              .map(
                                (change, idx) => `
                              <div class="border-2 rounded-lg p-4 ${
                                change.currentStatus === "active"
                                  ? "border-green-200 bg-green-50"
                                  : "border-gray-200 bg-white"
                              }">
                                <label class="flex items-start gap-3 cursor-pointer">
                                  <input type="checkbox" class="change-checkbox mt-1 w-5 h-5" data-change-index="${idx}" checked>
                                  <div class="flex-1">
                                    <div class="font-bold text-gray-800 mb-1">
                                      ${saf(change.name)} (${saf(
                                  change.studentId
                                )})
                                      ${
                                        change.currentStatus === "active"
                                          ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">í™œë™ì¤‘</span>'
                                          : ""
                                      }
                                    </div>
                                    <div class="text-sm space-y-1">
                                      ${change.changes
                                        .map(
                                          (detail) => `
                                        <div class="flex items-center gap-2">
                                          <span class="text-gray-600">${
                                            detail.field
                                          }:</span>
                                          <span class="line-through text-gray-400">${saf(
                                            detail.old || "ì—†ìŒ"
                                          )}</span>
                                          <i class="fas fa-arrow-right text-xs text-gray-400"></i>
                                          <span class="font-semibold ${
                                            detail.warning
                                              ? "text-red-600"
                                              : "text-blue-600"
                                          }">${saf(detail.new)}</span>
                                          ${
                                            detail.warning
                                              ? `<span class="text-xs text-red-500">${detail.warning}</span>`
                                              : ""
                                          }
                                        </div>
                                      `
                                        )
                                        .join("")}
                                    </div>
                                  </div>
                                </label>
                              </div>
                            `
                              )
                              .join("")}
                          </div>
                        </div>
                      `
                          : ""
                      }

                      ${
                        newMembers.length > 0
                          ? `
                        <div class="mb-6">
                          <h4 class="text-lg font-bold text-gray-800 mb-3">
                            <i class="fas fa-user-plus mr-2 text-green-600"></i>ìƒˆ íšŒì› ì¶”ê°€ (${
                              newMembers.length
                            }ëª…)
                          </h4>
                          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p class="text-sm text-green-700 mb-2">
                              <i class="fas fa-info-circle mr-1"></i>
                              ìƒˆ íšŒì›ì€ ëª¨ë‘ <strong>ìŠ¹ì¸ëŒ€ê¸°</strong> ìƒíƒœë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                              ${newMembers
                                .map(
                                  (m) => `
                                <div class="bg-white p-2 rounded border border-green-200">
                                  <span class="font-semibold">${saf(
                                    m.name
                                  )}</span>
                                  <span class="text-gray-600 ml-1">(${saf(
                                    m.studentId
                                  )})</span>
                                </div>
                              `
                                )
                                .join("")}
                            </div>
                          </div>
                        </div>
                      `
                          : ""
                      }

                      ${
                        errors.length > 0
                          ? `
                        <div class="mb-4">
                          <h4 class="text-lg font-bold text-red-800 mb-3">
                            <i class="fas fa-exclamation-triangle mr-2"></i>ì˜¤ë¥˜ (${
                              errors.length
                            }ê±´)
                          </h4>
                          <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-sm text-red-700 space-y-1">
                            ${errors
                              .map((err) => `<div>â€¢ ${err}</div>`)
                              .join("")}
                          </div>
                        </div>
                      `
                          : ""
                      }
                    </div>

                    <div class="px-6 py-4 bg-gray-50 border-t flex gap-3">
                      <button type="button" onclick="document.getElementById('change-confirmation-modal').remove()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-white font-semibold">
                        <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                      </button>
                      <button type="button" onclick="applySelectedChanges()" class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-xl hover:from-orange-600 hover:to-orange-700 font-semibold shadow-lg">
                        <i class="fas fa-check mr-2"></i>ì„ íƒí•œ ë³€ê²½ì‚¬í•­ ì ìš©
                      </button>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (applySelectedChangesì—ì„œ ì‚¬ìš©)
        window.__pendingChanges = changes;
        window.__pendingNewMembers = newMembers;
      }

      // ì „ì²´ ì„ íƒ/í•´ì œ
      window.selectAllChanges = function (select) {
        document.querySelectorAll(".change-checkbox").forEach((cb) => {
          cb.checked = select;
        });
      };

      // ì„ íƒí•œ ë³€ê²½ì‚¬í•­ ì ìš©
      window.applySelectedChanges = async function () {
        const selectedIndexes = [
          ...document.querySelectorAll(".change-checkbox:checked"),
        ].map((cb) => parseInt(cb.dataset.changeIndex));

        const selectedChanges = window.__pendingChanges.filter((_, idx) =>
          selectedIndexes.includes(idx)
        );

        if (
          selectedChanges.length === 0 &&
          (!window.__pendingNewMembers ||
            window.__pendingNewMembers.length === 0)
        ) {
          showAlert("â„¹ï¸", "ì ìš©í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // í™•ì¸ ë©”ì‹œì§€
        const confirmMsg = `
      ì´ ${selectedChanges.length}ëª…ì˜ íšŒì› ì •ë³´ ë³€ê²½
      ${window.__pendingNewMembers.length}ëª…ì˜ ìƒˆ íšŒì› ì¶”ê°€

      ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
              `.trim();

        if (!confirm(confirmMsg)) return;

        try {
          // ë¡œë”© í‘œì‹œ
          const modal = document.getElementById("change-confirmation-modal");
          modal.querySelector(".px-6.py-4.bg-gray-50").innerHTML = `
                  <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i>
                    <p class="mt-2 text-gray-600">ë³€ê²½ì‚¬í•­ ì ìš© ì¤‘...</p>
                  </div>
                `;

          // ë³€ê²½ì‚¬í•­ ì ìš©
          const batch = writeBatch(db);

          // ê¸°ì¡´ íšŒì› ì—…ë°ì´íŠ¸
          for (const change of selectedChanges) {
            const updateData = { lastUpdated: new Date().toISOString() };

            for (const detail of change.changes) {
              const fieldMap = {
                ì´ë¦„: "name",
                ì„±ë³„: "gender",
                í•™ë…„: "year",
                ë‹¨ê³¼ëŒ€: "college",
                í•™ê³¼: "department",
                ì „í™”ë²ˆí˜¸: "phone",
                ìƒíƒœ: "status",
              };

              const dbField = fieldMap[detail.field];
              if (dbField === "status") {
                updateData[dbField] = change.convertedStatus;
              } else {
                updateData[dbField] = detail.new;
              }
            }

            const memberRef = doc(db, "members", change.existingMember.id);
            batch.update(memberRef, updateData);
          }

          // ìƒˆ íšŒì› ì¶”ê°€
          for (const newMember of window.__pendingNewMembers) {
            const memberRef = doc(db, "members", newMember.studentId);
            batch.set(memberRef, {
              ...newMember,
              status: "pending", // ìƒˆ íšŒì›ì€ í•­ìƒ ëŒ€ê¸° ìƒíƒœ
              createdAt: new Date().toISOString(),
              lastUpdated: new Date().toISOString(),
            });
          }

          await batch.commit();

          // ì„±ê³µ ì•Œë¦¼
          showAlert(
            "âœ…",
            `${selectedChanges.length}ëª… ì—…ë°ì´íŠ¸, ${window.__pendingNewMembers.length}ëª… ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );

          // ëª¨ë‹¬ ë‹«ê¸°
          modal.remove();

          // ì „ì—­ ë³€ìˆ˜ ì •ë¦¬
          delete window.__pendingChanges;
          delete window.__pendingNewMembers;
        } catch (error) {
          console.error("ë³€ê²½ì‚¬í•­ ì ìš© ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", `ì ìš© ì‹¤íŒ¨: ${error.message}`);
        }
      };

      // ìƒíƒœê°’ ë³€í™˜ (í•œêµ­ì–´ â†’ ì˜ì–´)
      function convertStatusToEnglish(status) {
        if (!status) return null;

        const statusLower = status.toLowerCase().trim();

        if (statusLower.includes("ìŠ¹ì¸") || statusLower === "active") {
          return "active";
        } else if (statusLower.includes("ëŒ€ê¸°") || statusLower === "pending") {
          return "pending";
        } else if (statusLower.includes("ê±°ì ˆ") || statusLower === "rejected") {
          return "rejected";
        } else if (statusLower.includes("ì°¨ë‹¨") || statusLower === "blocked") {
          return "blocked";
        }

        return null;
      }

      // ì—…ë¡œë“œ ê²°ê³¼ í‘œì‹œ
      function showUploadResult(result) {
        const resultDiv = document.getElementById("upload-result");

        let resultHTML = `
                <div class="bg-green-100 border border-green-300 rounded p-4">
                  <h5 class="font-semibold text-green-800 mb-2">
                    <i class="fas fa-check-circle mr-2"></i>ì—‘ì…€ ì—…ë¡œë“œ ì™„ë£Œ
                  </h5>
                  <div class="text-sm text-green-700 space-y-1">
                    <p>âœ… ì—…ë°ì´íŠ¸ëœ íšŒì›: ${result.updatedCount}ëª…</p>
                    <p>ğŸ†• ìƒˆë¡œ ì¶”ê°€ëœ íšŒì›: ${result.newCount}ëª…</p>
                    ${
                      result.errorCount > 0
                        ? `<p>âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${result.errorCount}ê±´</p>`
                        : ""
                    }
                  </div>
              `;

        if (result.errors && result.errors.length > 0) {
          resultHTML += `
                  <details class="mt-3">
                    <summary class="cursor-pointer text-sm font-medium text-green-800">ì˜¤ë¥˜ ìƒì„¸ ë³´ê¸°</summary>
                    <div class="mt-2 text-xs text-green-600 bg-green-50 p-2 rounded">
                      ${result.errors
                        .map((error) => `<div>â€¢ ${error}</div>`)
                        .join("")}
                    </div>
                  </details>
                `;
        }

        resultHTML += `</div>`;
        resultDiv.innerHTML = resultHTML;
        resultDiv.classList.remove("hidden");

        // íšŒì› ëª©ë¡ ì—…ë°ì´íŠ¸ (Firebase ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™œìš©)
        setTimeout(() => {
          try {
            // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œê°€ ì—´ë ¤ìˆê³  íšŒì› ê´€ë¦¬ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
            const dashboardTab = document.getElementById("dashboard-tab");
            const subtabContainer = document.getElementById("subtab-container");

            if (
              dashboardTab &&
              subtabContainer &&
              dashboardTab.innerHTML.includes("íšŒì› ê´€ë¦¬")
            ) {
              // í˜„ì¬ í™œì„±í™”ëœ íƒ­ì´ íšŒì› ê´€ë¦¬ì¸ì§€ í™•ì¸
              const activeTab = document.querySelector(
                ".subtab-btn.bg-gray-800"
              );
              if (activeTab && activeTab.dataset.sub === "members") {
                import("./js/dashboard.js").then(({ renderMembersAdmin }) => {
                  renderMembersAdmin(subtabContainer);
                });
              }
            }
          } catch (error) {
            console.error("íšŒì› ëª©ë¡ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë§Œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            location.reload();
          }
        }, 2000);
      }

      /* ===================== ë””ë²„ê¹… í•¨ìˆ˜ ===================== */
      // Firebase ë°ì´í„°ë² ì´ìŠ¤ ë””ë²„ê¹… í•¨ìˆ˜
      window.debugFirebaseData = async function () {
        console.log("=== Firebase ë°ì´í„°ë² ì´ìŠ¤ ë””ë²„ê¹… ì‹œì‘ ===");

        try {
          // members ì»¬ë ‰ì…˜ í™•ì¸
          const membersSnapshot = await getDocs(collection(db, "members"));
          console.log("=== Members ì»¬ë ‰ì…˜ ===");
          console.log("ì´ íšŒì› ìˆ˜:", membersSnapshot.docs.length);

          membersSnapshot.docs.forEach((doc, index) => {
            const data = doc.data();
            console.log(`${index + 1}. ID: ${doc.id}`);
            console.log(`   ë°ì´í„°:`, data);

            // ìš°í…Œì½” ì‚¬ìš©ì ì°¾ê¸°
            if (data.name === "ìš°í…Œì½”" || data.studentId === "20251010") {
              console.log("ğŸš¨ ìš°í…Œì½” ì‚¬ìš©ì ë°œê²¬!");
              console.log("ë¬¸ì„œ ID:", doc.id);
              console.log("ì „ì²´ ë°ì´í„°:", data);
            }
          });

          // admins ì»¬ë ‰ì…˜ í™•ì¸
          const adminsDoc = await getDoc(doc(db, "admins", "list"));
          console.log("\n=== Admins ì»¬ë ‰ì…˜ ===");
          if (adminsDoc.exists()) {
            const adminData = adminsDoc.data();
            console.log("ê´€ë¦¬ì ëª©ë¡:", adminData.studentIds || []);
            console.log("ì§ì±… ì •ë³´:", adminData.positions || {});

            // ìš°í…Œì½”ê°€ ê´€ë¦¬ìì¸ì§€ í™•ì¸
            if (adminData.studentIds?.includes("20251010")) {
              console.log("ğŸš¨ ìš°í…Œì½”ê°€ ê´€ë¦¬ì ëª©ë¡ì— ìˆìŒ!");
            }
          } else {
            console.log("admins/list ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ");
          }

          // í˜„ì¬ ë¡œì»¬ ìƒíƒœ í™•ì¸
          console.log("\n=== ë¡œì»¬ ìƒíƒœ ===");
          console.log("membersData ê¸¸ì´:", membersData?.length || 0);
          console.log("adminList:", adminList);
          console.log("adminPositions:", adminPositions);
        } catch (error) {
          console.error("ë””ë²„ê¹… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      };

      // ìš°í…Œì½” ì‚¬ìš©ì ê°•ì œ ì‚­ì œ í•¨ìˆ˜
      window.forceDeleteWooteco = async function () {
        console.log("=== ìš°í…Œì½” ì‚¬ìš©ì ê°•ì œ ì‚­ì œ ì‹œì‘ ===");

        try {
          // members ì»¬ë ‰ì…˜ì—ì„œ ìš°í…Œì½” ì‚¬ìš©ì ì°¾ê¸° ë° ì‚­ì œ
          const membersSnapshot = await getDocs(collection(db, "members"));
          let deletedCount = 0;
          const deletedStudentIds = [];

          for (const docSnap of membersSnapshot.docs) {
            const data = docSnap.data();
            // ì´ë¦„ì´ "ìš°í…Œì½”"ì¸ ëª¨ë“  ì‚¬ìš©ì ì‚­ì œ
            if (
              data.name === "ìš°í…Œì½”" ||
              data.college === "ìš°í…Œì½”" ||
              data.department === "ìš°í…Œì½”"
            ) {
              console.log("ìš°í…Œì½” ì‚¬ìš©ì ë°œê²¬, ì‚­ì œ ì¤‘:", docSnap.id, data);
              await deleteDoc(doc(db, "members", docSnap.id));
              deletedStudentIds.push(docSnap.id);
              deletedCount++;
            }
          }

          // ê´€ë¦¬ì ëª©ë¡ì—ì„œë„ ì œê±°
          const adminsDoc = await getDoc(doc(db, "admins", "list"));
          if (adminsDoc.exists()) {
            const adminData = adminsDoc.data();
            const studentIds = adminData.studentIds || [];
            const positions = adminData.positions || {};

            // ì‚­ì œëœ ëª¨ë“  í•™ë²ˆ ì œê±°
            const newStudentIds = studentIds.filter(
              (id) => !deletedStudentIds.includes(id)
            );

            // positionsì—ì„œë„ ì œê±°
            deletedStudentIds.forEach((id) => {
              delete positions[id];
            });

            if (newStudentIds.length !== studentIds.length) {
              console.log("ê´€ë¦¬ì ëª©ë¡ì—ì„œ ìš°í…Œì½” ì‚¬ìš©ìë“¤ ì œê±°");
              await setDoc(doc(db, "admins", "list"), {
                studentIds: newStudentIds,
                positions: positions,
              });
            }
          }

          console.log(`ìš°í…Œì½” ì‚¬ìš©ì ${deletedCount}ëª… ì‚­ì œ ì™„ë£Œ`);
          console.log("ì‚­ì œëœ í•™ë²ˆ:", deletedStudentIds);
          alert(
            `ìš°í…Œì½” ì‚¬ìš©ì ${deletedCount}ëª…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚­ì œëœ í•™ë²ˆ: ${deletedStudentIds.join(
              ", "
            )}\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`
          );
          location.reload();
        } catch (error) {
          console.error("ìš°í…Œì½” ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
          alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      };

      /* ===================== ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ===================== */
      function renderDashboardTab() {
        const c = document.getElementById("dashboard-tab");
        c.innerHTML = `<div class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                <div class="flex flex-wrap gap-2 mb-4">
                  <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="members">
                    <i class="fas fa-users mr-1"></i>íšŒì›
                  </button>
                  <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="groups">
                    <i class="fas fa-users-cog mr-1"></i>ì¡°ëª¨ì„ ê´€ë¦¬
                  </button>
                  <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="activities">
                    <i class="fas fa-clipboard-list mr-1"></i>í™œë™ ê´€ë¦¬
                  </button>
                  <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="positions">
                    <i class="fas fa-user-tie mr-1"></i>ì„ì› ê´€ë¦¬
                  </button>
                  <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="system">
                    <i class="fas fa-credit-card mr-1"></i>íšŒë¹„ ê´€ë¦¬
                  </button>
                  <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="inquiries">
                    <i class="fas fa-comment-dots mr-1"></i>ë¬¸ì˜ ê´€ë¦¬
                  </button>
                </div>
                <div id="subtab-container"></div>
              </div>`;
        const bWrap = c.querySelector(".flex.flex-wrap");
        bWrap.addEventListener("click", (e) => {
          const b = e.target.closest(".subtab-btn");
          if (!b) return;
          c.querySelectorAll(".subtab-btn").forEach((x) =>
            x.classList.remove("bg-gray-800", "text-white")
          );
          b.classList.add("bg-gray-800", "text-white");
          currentDashboardTab = b.dataset.sub; // í˜„ì¬ íƒ­ ì €ì¥
          showSubtab(b.dataset.sub);
        });

        // ì €ì¥ëœ íƒ­ìœ¼ë¡œ ë³µì›, ê¸°ë³¸ê°’ì€ "íšŒì›" íƒ­
        const initialTab = currentDashboardTab || "activities";
        const initialBtn = c.querySelector(
          `.subtab-btn[data-sub="${initialTab}"]`
        );
        if (initialBtn) {
          initialBtn.classList.add("bg-gray-800", "text-white");
        }
        showSubtab(initialTab);
      }
      async function showSubtab(name) {
        const cont = document.getElementById("subtab-container");
        if (name === "members") {
          // js/dashboard.jsì˜ renderMembersAdmin í•¨ìˆ˜ ì‚¬ìš©
          const { renderMembersAdmin } = await import("./js/dashboard.js");
          renderMembersAdmin(cont);
          return;
        }
        if (name === "groups") {
          renderGroupsAdmin(cont);
          return;
        }
        if (name === "activities") {
          renderActivitiesAdmin(cont);
          return;
        }
        if (name === "positions") {
          renderPositionsAdmin(cont);
          return;
        }
        if (name === "system") {
          renderSystemAdmin(cont);
          return;
        }
        if (name === "inquiries") {
          renderInquiriesAdmin(cont);
          return;
        }
      }

      /* ===== ì¡°ëª¨ì„ ê´€ë¦¬ ===== */
      function renderGroupsAdmin(container) {
        // ì¡°ëª¨ì„ ë°ì´í„°ë¥¼ ì ìˆ˜ìˆœìœ¼ë¡œ ì •ë ¬
        const sortedGroups = [...groupsData]
          .filter((g) => g.name && g.score !== undefined)
          .sort((a, b) => (b.score || 0) - (a.score || 0));

        container.innerHTML = `
                <div class="section">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">ğŸ… ì¡°ëª¨ì„ ê´€ë¦¬</h3>
                    <button
                      type="button"
                      class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors"
                      onclick="openGroupAddModal()"
                    >
                      <i class="fas fa-plus mr-1"></i>ì¡°ëª¨ì„ ì¶”ê°€
                    </button>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    ${
                      sortedGroups.length > 0
                        ? sortedGroups
                            .map((group, index) => {
                              const members = group.members || [];
                              // membersê°€ ë¬¸ìì—´ ë°°ì—´ì¸ì§€ ê°ì²´ ë°°ì—´ì¸ì§€ í™•ì¸ í•„ìš”
                              // ì¼ë‹¨ ë¬¸ìì—´ë¡œ ê°€ì •í•˜ê³ , ê°ì²´ë©´ studentIdë¡œ ì°¾ì•„ì•¼ í•¨

                              return `
                              <div class="bg-white border-2 border-gray-200 rounded-xl p-4 shadow-md hover:shadow-lg transition-shadow">
                                <div class="flex items-center justify-between mb-3">
                                  <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                      ${index + 1}
                                    </div>
                                    <div>
                                      <h4 class="text-lg font-bold text-gray-800">${saf(
                                        group.name
                                      )}</h4>
                                      <p class="text-sm text-gray-600">${
                                        group.score || 0
                                      }ì </p>
                                    </div>
                                  </div>
                                  <div class="flex gap-2">
                                    <button
                                      type="button"
                                      class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors"
                                      onclick="openGroupManageModal('${
                                        group.id
                                      }', '${saf(group.name).replace(
                                /'/g,
                                "\\'"
                              )}')"
                                      title="íšŒì› ê´€ë¦¬"
                                    >
                                      <i class="fas fa-users-cog mr-1"></i>ê´€ë¦¬
                                    </button>
                                    <button
                                      type="button"
                                      class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm transition-colors"
                                      onclick="openGroupEditModal('${
                                        group.id
                                      }', '${saf(group.name).replace(
                                /'/g,
                                "\\'"
                              )}', ${group.score || 0})"
                                      title="ìˆ˜ì •"
                                    >
                                      <i class="fas fa-edit"></i>
                                    </button>
                                  </div>
                                </div>

                                <div class="mt-3 space-y-2">
                                  <div class="text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-users mr-1"></i>íšŒì› (${
                                      members.length
                                    }ëª…)
                                  </div>
                                  ${
                                    members.length > 0
                                      ? `<div class="flex flex-wrap gap-2">
                                          ${members
                                            .map((member) => {
                                              // memberê°€ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ, ê°ì²´ë©´ name í‘œì‹œ
                                              const memberName =
                                                typeof member === "string"
                                                  ? member
                                                  : member.name ||
                                                    member.studentId ||
                                                    "ì•Œ ìˆ˜ ì—†ìŒ";
                                              const memberStudentId =
                                                typeof member === "object"
                                                  ? member.studentId
                                                  : null;
                                              const isLeader =
                                                typeof member === "object"
                                                  ? member.role === "leader" ||
                                                    member.isLeader
                                                  : false;
                                              const isSubLeader =
                                                typeof member === "object"
                                                  ? member.role === "subleader"
                                                  : false;

                                              return `
                                                <span class="px-2 py-1 rounded-full text-xs ${
                                                  isLeader
                                                    ? "bg-yellow-100 text-yellow-800 font-semibold"
                                                    : isSubLeader
                                                    ? "bg-orange-100 text-orange-800 font-semibold"
                                                    : "bg-gray-100 text-gray-700"
                                                }">
                                                  ${saf(memberName)}${
                                                isLeader
                                                  ? " ğŸ‘‘"
                                                  : isSubLeader
                                                  ? " â­"
                                                  : ""
                                              }
                                                </span>
                                              `;
                                            })
                                            .join("")}
                                        </div>`
                                      : `<p class="text-sm text-gray-400 italic">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p>`
                                  }
                                </div>
                              </div>
                            `;
                            })
                            .join("")
                        : `<div class="col-span-2 text-center py-12 text-gray-400">
                          <i class="fas fa-users text-4xl mb-3"></i>
                          <p>ì•„ì§ ì¡°ëª¨ì„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                          <p class="text-sm mt-1">ì¡°ëª¨ì„ì„ ì¶”ê°€í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.</p>
                        </div>`
                    }
                  </div>
                </div>
              `;
      }

      // ì¡°ëª¨ì„ íšŒì› ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
      window.openGroupManageModal = function (groupId, groupName) {
        const group = groupsData.find((g) => g.id === groupId);
        if (!group) {
          showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const modalHTML = `
                <div id="group-manage-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-6 border-b border-gray-200 flex-shrink-0">
                      <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">ğŸ… ${saf(
                          groupName
                        )} íšŒì› ê´€ë¦¬</h3>
                        <button
                          type="button"
                          class="text-gray-500 hover:text-gray-700 p-2"
                          onclick="document.getElementById('group-manage-modal').remove()"
                        >
                          <i class="fas fa-times text-xl"></i>
                        </button>
                      </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-6">
                      <!-- í˜„ì¬ íšŒì› ëª©ë¡ -->
                      <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                          <i class="fas fa-users mr-2"></i>í˜„ì¬ íšŒì› (${
                            (group.members || []).length
                          }ëª…)
                        </h4>
                        <div id="group-current-members" class="space-y-2">
                          ${renderGroupMembersList(
                            group.members || [],
                            groupId
                          )}
                        </div>
                      </div>

                      <!-- íšŒì› ì¶”ê°€ -->
                      <div class="border-t border-gray-200 pt-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                          <i class="fas fa-user-plus mr-2"></i>íšŒì› ì¶”ê°€
                        </h4>
                        <div class="mb-4">
                          <input
                            type="text"
                            id="group-member-search"
                            placeholder="ì´ë¦„ ë˜ëŠ” í•™ë²ˆìœ¼ë¡œ ê²€ìƒ‰..."
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200"
                            oninput="searchMembersForGroup(this.value, '${groupId}')"
                          />
                        </div>
                        <div id="group-member-search-results" class="space-y-2 max-h-64 overflow-y-auto">
                          <p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ íšŒì›ì„ ì°¾ì•„ì£¼ì„¸ìš”</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;

        // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
        const existingModal = document.getElementById("group-manage-modal");
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("group-manage-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "group-manage-modal") {
              document.getElementById("group-manage-modal").remove();
            }
          });
      };

      function renderActivitiesAdmin(container) {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin) {
          container.innerHTML = `
                  <div class="section">
                    <div class="bg-red-50 border border-red-200 text-red-700 rounded-2xl px-4 py-6 text-sm text-center">
                      <i class="fas fa-lock mr-2"></i>ì´ ë©”ë‰´ëŠ” íšŒì¥ë‹¨ ì´ìƒë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                  </div>`;
          return;
        }

        const events = (eventsData || [])
          .filter((ev) => ev && ev.status !== "deleted")
          .sort((a, b) => {
            const getTime = (event) =>
              new Date(
                event.datetime ||
                  event.deadline ||
                  event.registrationStart ||
                  event.createdAt ||
                  event.created_at ||
                  event.created ||
                  0
              ).getTime();
            return getTime(b) - getTime(a);
          });

        if (!events.length) {
          container.innerHTML = `
                  <div class="section">
                    <p class="text-center text-gray-500 py-12 text-sm">
                      ì•„ì§ ë“±ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.
                    </p>
                  </div>`;
          return;
        }

        container.innerHTML = `
                <div class="section">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                      <i class="fas fa-clipboard-list text-orange-500 mr-2"></i>í™œë™ ê´€ë¦¬
                    </h3>
                    <span class="text-xs text-gray-500">ì´ ${
                      events.length
                    }ê±´</span>
                  </div>
                  <div class="space-y-4">
                    ${events.map(renderActivitiesAdminCard).join("")}
                  </div>
                </div>
              `;
      }

      function renderActivitiesAdminCard(ev) {
        const status = statusLabel(ev.status || "open");
        const meta = (() => {
          switch (ev.type) {
            case "tasting":
              return { icon: "ğŸ½ï¸", accent: "bg-orange-100 text-orange-700" };
            case "mt":
              return { icon: "ğŸ•ï¸", accent: "bg-orange-100 text-orange-700" };
            case "assembly":
              return { icon: "ğŸ¤", accent: "bg-pink-100 text-pink-700" };
            default:
              return { icon: "ğŸ“…", accent: "bg-emerald-100 text-emerald-700" };
          }
        })();

        const formatDateTimeLabel = (value) => {
          const date = toDateSafe(value);
          if (!date) return "ë¯¸ì •";
          return date.toLocaleString("ko-KR", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        };

        const restaurants = ev.restaurants || [];
        const applicants = ev.applicants || [];
        const waiting = ev.waiting || [];

        const totalReservations =
          ev.type === "tasting"
            ? restaurants.reduce(
                (sum, r) => sum + (r.reservations?.length || 0),
                0
              )
            : applicants.length;
        const totalWaiting =
          ev.type === "tasting"
            ? restaurants.reduce((sum, r) => sum + (r.waiting?.length || 0), 0)
            : waiting.length;
        const totalCapacityValue =
          ev.type === "tasting"
            ? restaurants.reduce(
                (sum, r) => sum + (r.capacity ?? ev.limit ?? 0),
                0
              )
            : ev.limit && ev.limit > 0
            ? ev.limit
            : null;

        const participantEntries =
          ev.type === "tasting"
            ? restaurants.flatMap((r) => [
                ...(r.reservations || []),
                ...(r.waiting || []),
              ])
            : [...applicants, ...waiting];

        const participantChips = (() => {
          if (!participantEntries.length) {
            return `<p class="text-xs text-gray-400">ì‹ ì²­ìê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>`;
          }
          const uniqueNames = [
            ...new Set(
              participantEntries
                .map((p) =>
                  p.name
                    ? p.name
                    : p.studentId
                    ? maskStudentIdGlobal(p.studentId)
                    : "ìµëª… ì‹ ì²­ì"
                )
                .filter(Boolean)
            ),
          ];
          const chips = uniqueNames
            .slice(0, 6)
            .map(
              (name) => `
                      <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs">
                        ${saf(name)}
                      </span>`
            )
            .join("");
          const extra =
            uniqueNames.length > 6
              ? `<span class="px-2 py-1 rounded-full bg-gray-200 text-gray-600 text-xs">+ ${
                  uniqueNames.length - 6
                }ëª…</span>`
              : "";
          return `<div class="flex flex-wrap gap-1">${chips}${extra}</div>`;
        })();

        const reviews = ev.reviews || [];
        const ratingAverage =
          reviews.length > 0
            ? (
                reviews.reduce(
                  (sum, review) => sum + (Number(review.rating) || 0),
                  0
                ) / reviews.length
              ).toFixed(1)
            : null;

        const sanitizedReviewId = (ev.id || "event")
          .toString()
          .replace(/[^\w-]/g, "");
        const reviewToggleId = `reviews-${sanitizedReviewId}`;
        const renderReviewItem = (review) => `
                <div class="rounded-xl bg-white/90 border border-yellow-100 px-3 py-2 text-xs text-gray-600">
                  <div class="flex items-center justify-between text-[11px] text-gray-500 mb-1">
                    <span class="font-semibold text-gray-700">${saf(
                      review.name || maskStudentIdGlobal(review.studentId || "")
                    )}</span>
                    <span class="flex items-center gap-1 text-yellow-600 font-semibold">
                      <i class="fas fa-star text-yellow-500"></i>${Number(
                        review.rating || 0
                      ).toFixed(1)}ì 
                    </span>
                  </div>
                  <p>${saf(review.comment || "í›„ê¸° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.")}</p>
                </div>`;

        const reviewPreviewHTML = reviews
          .slice(0, 2)
          .map(renderReviewItem)
          .join("");
        const reviewExtraHTML = reviews.slice(2).map(renderReviewItem).join("");
        const extraReviewCount = Math.max(reviews.length - 2, 0);

        const reviewHTML =
          reviews.length > 0
            ? `
                    <div class="rounded-2xl border border-yellow-200 bg-yellow-50/60 px-4 py-3 space-y-2">
                      <div class="flex items-center gap-2 text-sm text-yellow-700 font-semibold">
                        <i class="fas fa-star text-yellow-500"></i>í›„ê¸° ${
                          reviews.length
                        }ê±´${ratingAverage ? ` Â· í‰ê·  ${ratingAverage}ì ` : ""}
                      </div>
                      <div class="space-y-2">
                        ${reviewPreviewHTML}
                        ${
                          extraReviewCount > 0
                            ? `
                              <div id="${reviewToggleId}-hidden" class="hidden space-y-2 mt-2">
                                ${reviewExtraHTML}
                              </div>
                              <button type="button" class="text-xs text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1" data-review-toggle="${reviewToggleId}" data-review-count="${extraReviewCount}">
                                <i class="fas fa-chevron-down"></i>ì™¸ ${extraReviewCount}ê°œ ë¦¬ë·° ë³´ê¸°
                              </button>
                            `
                            : ""
                        }
                      </div>
                    </div>
                  `
            : `
                    <div class="rounded-2xl border border-gray-200 bg-gray-50 px-4 py-3 text-xs text-gray-500">
                      <i class="fas fa-comment-slash mr-1"></i>ì‘ì„±ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                  `;

        const cancellationNotice =
          ev.status === "cancelled" || ev.status === "deleted"
            ? `
                    <div class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-xs text-red-600">
                      <i class="fas fa-triangle-exclamation mr-1"></i>ì‚­ì œëœ í™œë™ì…ë‹ˆë‹¤. ì‹ ì²­ ë‚´ì—­ì€ ìˆ¨ê²¨ì§€ë©°, ì‘ì„±ëœ ë¯¸ì‹íšŒ í›„ê¸°ëŠ” ë³„ë„ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.
                    </div>
                  `
            : "";

        const tastingDetails =
          ev.type === "tasting"
            ? `
                    <div class="mt-3 space-y-2">
                      ${restaurants
                        .map((restaurant) => {
                          const cap =
                            restaurant.capacity != null
                              ? restaurant.capacity
                              : ev.limit != null
                              ? ev.limit
                              : (restaurant.reservations || []).length || 0;
                          const reservationsCount =
                            restaurant.reservations?.length || 0;
                          const waitingCount = restaurant.waiting?.length || 0;
                          const isRestaurantFull =
                            cap > 0 && reservationsCount >= cap;
                          return `
                            <div class="border border-orange-200 rounded-2xl bg-orange-50/60 px-3 py-2">
                              <div class="flex items-center justify-between gap-2 flex-wrap">
                                <div class="flex items-center gap-2">
                                  <div class="font-semibold ${
                                    isRestaurantFull
                                      ? "text-gray-400 line-through decoration-2 decoration-red-400"
                                      : "text-orange-800"
                                  }">${saf(
                            restaurant.name || "ì‹ë‹¹ ë¯¸ì •"
                          )}</div>
                                  ${
                                    isRestaurantFull
                                      ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-100 text-red-600 text-[11px] font-semibold">
                                          <i class="fas fa-ban text-xs"></i>ë§ˆê°
                                        </span>`
                                      : ""
                                  }
                                </div>
                                <div class="text-xs text-orange-700">
                                  ì˜ˆì•½ ${reservationsCount}/${cap} Â· ëŒ€ê¸° ${waitingCount}
                                </div>
                              </div>
                              ${
                                restaurant.info
                                  ? `<p class="text-xs mt-1 ${
                                      isRestaurantFull
                                        ? "text-gray-400 line-through decoration-2 decoration-red-300"
                                        : "text-gray-600"
                                    }">${saf(restaurant.info)}</p>`
                                  : ""
                              }
                            </div>
                          `;
                        })
                        .join("")}
                    </div>
                  `
            : "";

        const registrationStart =
          ev.registrationStart && ev.registrationStart !== ""
            ? formatDateTimeLabel(ev.registrationStart)
            : "ì¦‰ì‹œ";

        const cancelButtonHTML =
          ev.status === "deleted"
            ? `<span class="px-3 py-1.5 text-xs bg-red-100 text-red-700 rounded-full border border-red-200">ì‚­ì œëœ í™œë™</span>`
            : `<button type="button" class="px-3 py-1.5 text-xs bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors" data-act="admin-cancel" data-id="${ev.id}">
                      <i class="fas fa-ban mr-1"></i>í™œë™ ì·¨ì†Œ
                    </button>`;

        const participantManageButton = `<button type="button" class="px-3 py-1.5 text-xs bg-green-500 hover:bg-green-600 text-white rounded-full transition-colors" data-act="admin-add-participant" data-id="${ev.id}" onclick="openAddParticipantModal('${ev.id}')">
                  <i class="fas fa-user-edit mr-1"></i>ì°¸ê°€ì ìˆ˜ì •
                </button>`;
        const groupButton = `<button type="button" class="px-3 py-1.5 text-xs bg-purple-500 hover:bg-purple-600 text-white rounded-full transition-colors" data-act="group-maker" data-id="${ev.id}">
                  <i class="fas fa-users mr-1"></i>íŒ€ êµ¬ì„±í•˜ê¸°
                </button>`;
        const archiveToggleButton =
          ev.status === "archived"
            ? `<button type="button" class="px-3 py-1.5 text-xs bg-amber-500 hover:bg-amber-600 text-white rounded-full transition-colors" data-act="admin-unarchive" data-id="${ev.id}" onclick="unarchiveEvent('${ev.id}')">
                      <i class="fas fa-rotate-left mr-1"></i>ì¬ê²Œì‹œ
                    </button>`
            : `<button type="button" class="px-3 py-1.5 text-xs bg-amber-500 hover:bg-amber-600 text-white rounded-full transition-colors" data-act="admin-archive" data-id="${ev.id}" onclick="archiveEvent('${ev.id}')">
                      <i class="fas fa-box-archive mr-1"></i>ìˆ¨ê¹€ ì²˜ë¦¬
                    </button>`;

        const actionButtons = `
                <div class="flex flex-wrap gap-2 mt-4">
                  ${cancelButtonHTML}
                  ${archiveToggleButton}
                  ${participantManageButton}
                  ${groupButton}
                  <button type="button" class="px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-colors" onclick="showEventDetailModal('${ev.id}')">
                    <i class="fas fa-circle-info mr-1"></i>ìƒì„¸ ë³´ê¸°
                  </button>
                  <button type="button" class="px-3 py-1.5 text-xs bg-gray-700 hover:bg-gray-800 text-white rounded-full transition-colors" data-act="export-xlsx" data-id="${ev.id}">
                    <i class="fas fa-file-excel mr-1"></i>ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ
                  </button>
                </div>
              `;

        return `
                <div class="bg-white border border-gray-200 rounded-3xl shadow-sm hover:shadow-lg transition-all p-5 space-y-4">
                  <div class="flex flex-wrap items-start justify-between gap-3">
                    <div class="flex items-center gap-3">
                      <span class="text-3xl">${meta.icon}</span>
                      <div>
                        <h4 class="text-xl font-bold text-gray-900">${saf(
                          ev.title || "ì œëª© ì—†ìŒ"
                        )}</h4>
                        <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500 mt-1">
                          <span class="px-2 py-0.5 rounded-full ${
                            meta.accent
                          }">${typeLabel(ev.type)}</span>
                          <span class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">${status}</span>
                        </div>
                      </div>
                    </div>
                    <div class="text-right text-xs text-gray-500 space-y-1">
                      <div><i class="fas fa-calendar-day mr-1 text-blue-500"></i>${formatDateTimeLabel(
                        ev.datetime
                      )}</div>
                      <div><i class="fas fa-hourglass mr-1 text-red-500"></i>ë§ˆê° ${formatDateTimeLabel(
                        ev.deadline
                      )}</div>
                      <div><i class="fas fa-door-open mr-1 text-emerald-500"></i>ì‹ ì²­ ${registrationStart}</div>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-xs text-gray-600">
                    <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                      <div class="text-[11px] text-gray-500">ì´ ì‹ ì²­</div>
                      <div class="font-semibold text-gray-800">${totalReservations}ëª…</div>
                    </div>
                    <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                      <div class="text-[11px] text-gray-500">ëŒ€ê¸° ì¸ì›</div>
                      <div class="font-semibold text-gray-800">${totalWaiting}ëª…</div>
                    </div>
                    <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                      <div class="text-[11px] text-gray-500">ì •ì›</div>
                      <div class="font-semibold text-gray-800">${
                        totalCapacityValue != null
                          ? `${totalCapacityValue}ëª…`
                          : "ì œí•œ ì—†ìŒ"
                      }</div>
                    </div>
                    <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                      <div class="text-[11px] text-gray-500">í›„ê¸°</div>
                      <div class="font-semibold text-gray-800">${
                        reviews.length > 0
                          ? `${reviews.length}ê±´ Â· ${ratingAverage}ì `
                          : "ì‘ì„± ì—†ìŒ"
                      }</div>
                    </div>
                  </div>
                  ${participantChips}
                  ${tastingDetails}
                  ${cancellationNotice}
                  ${reviewHTML}
                  ${actionButtons}
                </div>
              `;
      }

      // ì¡°ëª¨ì„ íšŒì› ëª©ë¡ ë Œë”ë§
      function renderGroupMembersList(members, groupId) {
        if (members.length === 0) {
          return '<p class="text-sm text-gray-400 italic">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        }

        return members
          .map((member, index) => {
            const memberData =
              typeof member === "object"
                ? member
                : { name: member, studentId: null };
            const memberName =
              memberData.name || memberData.studentId || member || "ì•Œ ìˆ˜ ì—†ìŒ";
            const memberStudentId = memberData.studentId || null;
            const isLeader =
              memberData.role === "leader" || memberData.isLeader === true;
            const isSubLeader = memberData.role === "subleader";

            // íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸° (membersDataì—ì„œ)
            const fullMemberInfo = membersData.find(
              (m) =>
                (memberStudentId && m.studentId === memberStudentId) ||
                (!memberStudentId && m.name === memberName)
            );

            return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                      <div class="flex items-center gap-3 flex-1">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${
                          isLeader
                            ? "bg-yellow-400 text-yellow-900"
                            : isSubLeader
                            ? "bg-orange-400 text-orange-900"
                            : "bg-gray-300 text-gray-700"
                        } font-bold text-sm">
                          ${isLeader ? "ğŸ‘‘" : isSubLeader ? "â­" : index + 1}
                        </div>
                        <div class="flex-1">
                          <div class="font-semibold text-gray-800">${saf(
                            memberName
                          )}</div>
                          ${
                            fullMemberInfo
                              ? `<div class="text-xs text-gray-500">${
                                  fullMemberInfo.studentId || ""
                                } Â· ${fullMemberInfo.college || ""}</div>`
                              : ""
                          }
                        </div>
                        <div class="flex gap-2">
                          ${
                            !isLeader
                              ? `
                            <button
                              type="button"
                              class="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs transition-colors"
                              onclick="setGroupMemberRole('${groupId}', '${
                                  memberStudentId || saf(memberName)
                                }', 'leader')"
                              title="ì¡°ì¥ìœ¼ë¡œ ì„ëª…"
                            >
                              <i class="fas fa-crown mr-1"></i>ì¡°ì¥
                            </button>
                          `
                              : ""
                          }
                          ${
                            !isSubLeader && !isLeader
                              ? `
                            <button
                              type="button"
                              class="px-2 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded text-xs transition-colors"
                              onclick="setGroupMemberRole('${groupId}', '${
                                  memberStudentId || saf(memberName)
                                }', 'subleader')"
                              title="ë¶€ì¡°ì¥ìœ¼ë¡œ ì„ëª…"
                            >
                              <i class="fas fa-star mr-1"></i>ë¶€ì¡°ì¥
                            </button>
                          `
                              : ""
                          }
                          ${
                            isLeader || isSubLeader
                              ? `
                            <button
                              type="button"
                              class="px-2 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-xs transition-colors"
                              onclick="setGroupMemberRole('${groupId}', '${
                                  memberStudentId || saf(memberName)
                                }', 'member')"
                              title="ì¼ë°˜ íšŒì›ìœ¼ë¡œ ë³€ê²½"
                            >
                              <i class="fas fa-user mr-1"></i>ì¼ë°˜
                            </button>
                          `
                              : ""
                          }
                          <button
                            type="button"
                            class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs transition-colors"
                            onclick="removeGroupMember('${groupId}', '${
              memberStudentId || saf(memberName)
            }')"
                            title="ì¡°ì—ì„œ ì œê±°"
                          >
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  `;
          })
          .join("");
      }

      // íšŒì› ê²€ìƒ‰ (ì¡°ëª¨ì„ì— ì¶”ê°€ìš©)
      window.searchMembersForGroup = function (searchTerm, groupId) {
        const searchResults = document.getElementById(
          "group-member-search-results"
        );
        if (!searchResults) return;

        if (!searchTerm.trim()) {
          searchResults.innerHTML =
            '<p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ íšŒì›ì„ ì°¾ì•„ì£¼ì„¸ìš”</p>';
          return;
        }

        const group = groupsData.find((g) => g.id === groupId);
        const currentMembers = (group?.members || []).map((m) =>
          typeof m === "object" ? m.studentId || m.name : m
        );

        // ë„ì–´ì“°ê¸°ë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ ê²€ìƒ‰ì–´ ì²˜ë¦¬
        const searchKeywords = searchTerm
          .trim()
          .split(/\s+/)
          .filter((keyword) => keyword.length > 0)
          .map((keyword) => keyword.toLowerCase());

        // ê° ê²€ìƒ‰ì–´ì— ë§¤ì¹­ë˜ëŠ” íšŒì›ë“¤ì„ ì°¾ê¸°
        const matchedMembers = new Map(); // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ Map ì‚¬ìš©

        searchKeywords.forEach((keyword) => {
          (membersData || []).forEach((m) => {
            const nameMatch = m.name?.toLowerCase().includes(keyword);
            const idMatch = m.studentId?.toLowerCase().includes(keyword);
            const isAlreadyMember = currentMembers.includes(
              m.studentId || m.name
            );
            const isActive = (m.status || "pending") === "active";

            if ((nameMatch || idMatch) && !isAlreadyMember && isActive) {
              // Mapì— ì¶”ê°€ (í•™ë²ˆì„ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ì œê±°)
              matchedMembers.set(m.studentId || m.name, m);
            }
          });
        });

        // Mapì„ ë°°ì—´ë¡œ ë³€í™˜ (ìµœëŒ€ 50ê°œê¹Œì§€ í‘œì‹œ)
        const filtered = Array.from(matchedMembers.values()).slice(0, 50);

        if (filtered.length === 0) {
          searchResults.innerHTML =
            '<p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
          return;
        }

        // ë§¤ì¹­ëœ ê²€ìƒ‰ì–´ ì •ë³´ ì¶”ê°€ (ì–´ë–¤ ê²€ìƒ‰ì–´ë¡œ ë§¤ì¹­ë˜ì—ˆëŠ”ì§€ í‘œì‹œ)
        searchResults.innerHTML = filtered
          .map((member) => {
            // ì–´ë–¤ ê²€ìƒ‰ì–´ì— ë§¤ì¹­ë˜ì—ˆëŠ”ì§€ ì°¾ê¸°
            const matchedKeywords = searchKeywords.filter(
              (keyword) =>
                member.name?.toLowerCase().includes(keyword) ||
                member.studentId?.toLowerCase().includes(keyword)
            );

            return `
                  <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-bold">
                        ${member.name?.charAt(0) || "?"}
                      </div>
                      <div>
                        <div class="font-semibold text-gray-800">${saf(
                          member.name || "ì•Œ ìˆ˜ ì—†ìŒ"
                        )}</div>
                        <div class="text-xs text-gray-500">${
                          member.studentId || ""
                        } Â· ${member.college || ""}</div>
                        ${
                          matchedKeywords.length > 0
                            ? `<div class="text-xs text-orange-500 mt-0.5">
                                <i class="fas fa-search mr-1"></i>${matchedKeywords.join(
                                  ", "
                                )} ê²€ìƒ‰ì–´ë¡œ ë§¤ì¹­
                              </div>`
                            : ""
                        }
                      </div>
                    </div>
                    <button
                      type="button"
                      class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded text-sm transition-colors"
                      onclick="addMemberToGroup('${groupId}', '${
              member.studentId
            }', '${saf(member.name).replace(/'/g, "\\'")}')"
                    >
                      <i class="fas fa-plus mr-1"></i>ì¶”ê°€
                    </button>
                  </div>
                `;
          })
          .join("");
      };

      // ì¡°ëª¨ì„ì— íšŒì› ì¶”ê°€
      window.addMemberToGroup = async function (
        groupId,
        studentId,
        memberName
      ) {
        try {
          const groupRef = doc(db, "groups", groupId);
          const groupDoc = await getDoc(groupRef);

          if (!groupDoc.exists()) {
            showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const groupData = groupDoc.data();
          const currentMembers = groupData.members || [];

          // ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          const isAlreadyMember = currentMembers.some(
            (m) =>
              (typeof m === "object" && m.studentId === studentId) ||
              (typeof m === "string" && m === studentId) ||
              (typeof m === "string" && m === memberName)
          );

          if (isAlreadyMember) {
            showAlert("ğŸ˜¥", "ì´ë¯¸ í•´ë‹¹ ì¡°ì— ì†Œì†ëœ íšŒì›ì…ë‹ˆë‹¤.");
            return;
          }

          // íšŒì› ì¶”ê°€ (ê°ì²´ í˜•íƒœë¡œ ì €ì¥: {studentId, name, role: 'member'})
          const newMember = {
            studentId: studentId,
            name: memberName,
            role: "member",
          };

          await updateDoc(groupRef, {
            members: [...currentMembers, newMember],
            lastUpdated: new Date().toISOString(),
          });

          showAlert("âœ…", `${memberName} íšŒì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);

          // groupsData ìƒˆë¡œê³ ì¹¨ (onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•´ì¤Œ)
          // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•´ ì ì‹œ ëŒ€ê¸°
          setTimeout(() => {
            const group = groupsData.find((g) => g.id === groupId);
            if (group) {
              const currentMembersDiv = document.getElementById(
                "group-current-members"
              );
              if (currentMembersDiv) {
                currentMembersDiv.innerHTML = renderGroupMembersList(
                  group.members || [],
                  groupId
                );
              }
              // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì œê±°
              searchMembersForGroup(
                document.getElementById("group-member-search")?.value || "",
                groupId
              );
            }
          }, 500);
        } catch (error) {
          console.error("íšŒì› ì¶”ê°€ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "íšŒì› ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };

      // ì¡°ëª¨ì„ì—ì„œ íšŒì› ì œê±°
      window.removeGroupMember = async function (groupId, memberIdentifier) {
        if (!confirm("ì •ë§ë¡œ ì´ íšŒì›ì„ ì¡°ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        try {
          const groupRef = doc(db, "groups", groupId);
          const groupDoc = await getDoc(groupRef);

          if (!groupDoc.exists()) {
            showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const groupData = groupDoc.data();
          const currentMembers = groupData.members || [];

          // íšŒì› ì œê±° (studentId ë˜ëŠ” nameìœ¼ë¡œ ë§¤ì¹­)
          const updatedMembers = currentMembers.filter((m) => {
            if (typeof m === "object") {
              return (
                m.studentId !== memberIdentifier && m.name !== memberIdentifier
              );
            }
            return m !== memberIdentifier;
          });

          await updateDoc(groupRef, {
            members: updatedMembers,
            lastUpdated: new Date().toISOString(),
          });

          showAlert("âœ…", "íšŒì›ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");

          // groupsData ìƒˆë¡œê³ ì¹¨ (onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•´ì¤Œ)
          // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•´ ì ì‹œ ëŒ€ê¸°
          setTimeout(() => {
            const group = groupsData.find((g) => g.id === groupId);
            if (group) {
              const currentMembersDiv = document.getElementById(
                "group-current-members"
              );
              if (currentMembersDiv) {
                currentMembersDiv.innerHTML = renderGroupMembersList(
                  group.members || [],
                  groupId
                );
              }
              // ê²€ìƒ‰ ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
              const searchInput = document.getElementById(
                "group-member-search"
              );
              if (searchInput) {
                searchMembersForGroup(searchInput.value, groupId);
              }
            }
          }, 500);
        } catch (error) {
          console.error("íšŒì› ì œê±° ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "íšŒì› ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };

      // ì¡°ëª¨ì„ íšŒì› ì—­í•  ë³€ê²½ (ì¡°ì¥/ë¶€ì¡°ì¥/ì¼ë°˜)
      window.setGroupMemberRole = async function (
        groupId,
        memberIdentifier,
        role
      ) {
        try {
          const groupRef = doc(db, "groups", groupId);
          const groupDoc = await getDoc(groupRef);

          if (!groupDoc.exists()) {
            showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const groupData = groupDoc.data();
          const currentMembers = groupData.members || [];

          // ì—­í•  ë³€ê²½
          const updatedMembers = currentMembers.map((m) => {
            if (typeof m === "object") {
              if (
                m.studentId === memberIdentifier ||
                m.name === memberIdentifier
              ) {
                // ì¡°ì¥ìœ¼ë¡œ ì„ëª…í•  ë•Œ, ê¸°ì¡´ ì¡°ì¥ì„ ì¼ë°˜ íšŒì›ìœ¼ë¡œ ë³€ê²½
                if (role === "leader") {
                  // ë‹¤ë¥¸ ì¡°ì¥ ì°¾ì•„ì„œ ì¼ë°˜ íšŒì›ìœ¼ë¡œ ë³€ê²½
                  return { ...m, role: "member" };
                }
                return { ...m, role: role };
              }
              return m;
            } else {
              // ë¬¸ìì—´ì¸ ê²½ìš° ê°ì²´ë¡œ ë³€í™˜ í•„ìš”
              if (m === memberIdentifier) {
                const memberInfo = membersData.find(
                  (mem) =>
                    mem.studentId === memberIdentifier ||
                    mem.name === memberIdentifier
                );
                return {
                  studentId: memberInfo?.studentId || memberIdentifier,
                  name: memberInfo?.name || memberIdentifier,
                  role: role,
                };
              }
              return m;
            }
          });

          // ì¡°ì¥ì€ í•œ ëª…ë§Œ ìˆì–´ì•¼ í•¨
          if (role === "leader") {
            // ë‹¤ë¥¸ ì¡°ì¥ë“¤ì„ ì¼ë°˜ íšŒì›ìœ¼ë¡œ ë³€ê²½
            updatedMembers.forEach((m, idx) => {
              if (typeof m === "object" && m.role === "leader") {
                const isTarget =
                  m.studentId === memberIdentifier ||
                  m.name === memberIdentifier;
                if (!isTarget) {
                  updatedMembers[idx] = { ...m, role: "member" };
                }
              }
            });

            // í˜„ì¬ ì„ íƒëœ íšŒì›ì„ ì¡°ì¥ìœ¼ë¡œ ë³€ê²½
            const targetIndex = updatedMembers.findIndex((m) => {
              if (typeof m === "object") {
                return (
                  m.studentId === memberIdentifier ||
                  m.name === memberIdentifier
                );
              }
              return m === memberIdentifier;
            });

            if (targetIndex >= 0) {
              if (typeof updatedMembers[targetIndex] === "object") {
                updatedMembers[targetIndex] = {
                  ...updatedMembers[targetIndex],
                  role: "leader",
                };
              } else {
                const memberInfo = membersData.find(
                  (mem) =>
                    mem.studentId === memberIdentifier ||
                    mem.name === memberIdentifier
                );
                updatedMembers[targetIndex] = {
                  studentId: memberInfo?.studentId || memberIdentifier,
                  name: memberInfo?.name || memberIdentifier,
                  role: "leader",
                };
              }
            }
          }

          await updateDoc(groupRef, {
            members: updatedMembers,
            lastUpdated: new Date().toISOString(),
          });

          const roleText =
            role === "leader"
              ? "ì¡°ì¥"
              : role === "subleader"
              ? "ë¶€ì¡°ì¥"
              : "ì¼ë°˜ íšŒì›";
          showAlert("âœ…", `íšŒì› ì—­í• ì´ ${roleText}ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);

          // groupsData ìƒˆë¡œê³ ì¹¨ (onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•´ì¤Œ)
          // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•´ ì ì‹œ ëŒ€ê¸°
          setTimeout(() => {
            const group = groupsData.find((g) => g.id === groupId);
            if (group) {
              const currentMembersDiv = document.getElementById(
                "group-current-members"
              );
              if (currentMembersDiv) {
                currentMembersDiv.innerHTML = renderGroupMembersList(
                  group.members || [],
                  groupId
                );
              }
            }
          }, 500);
        } catch (error) {
          console.error("ì—­í•  ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì—­í•  ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };

      /* ===== ë¬¸ì˜ ê´€ë¦¬ ===== */
      function renderInquiriesAdmin(container) {
        const pendingInquiries = (inquiriesData || []).filter(
          (i) => i.status === "pending"
        );
        const answeredInquiries = (inquiriesData || []).filter(
          (i) => i.status === "answered"
        );

        container.innerHTML = `
                <div class="section">
                  <h3 class="text-xl font-bold text-gray-800 mb-4">ë¬¸ì˜ ê´€ë¦¬</h3>

                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- ë¯¸ë‹µë³€ ë¬¸ì˜ -->
                    <div>
                      <h4 class="font-semibold text-amber-700 mb-2">
                        ë¯¸ë‹µë³€ ë¬¸ì˜
                        <span class="bg-amber-100 text-amber-800 px-2 py-1 rounded-full text-xs ml-2">
                          ${pendingInquiries.length}ê±´
                        </span>
                      </h4>
                      <div class="space-y-3 max-h-[600px] overflow-y-auto">
                        ${
                          pendingInquiries.length > 0
                            ? pendingInquiries
                                .map((inq) => createInquiryCard(inq, false))
                                .join("")
                            : '<div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-400">ë¯¸ë‹µë³€ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
                        }
                      </div>
                    </div>

                    <!-- ë‹µë³€ ì™„ë£Œ -->
                    <div>
                      <h4 class="font-semibold text-emerald-700 mb-2">
                        ë‹µë³€ ì™„ë£Œ
                        <span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-xs ml-2">
                          ${answeredInquiries.length}ê±´
                        </span>
                      </h4>
                      <div class="space-y-3 max-h-[600px] overflow-y-auto">
                        ${
                          answeredInquiries.length > 0
                            ? answeredInquiries
                                .map((inq) => createInquiryCard(inq, true))
                                .join("")
                            : '<div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-400">ë‹µë³€ ì™„ë£Œëœ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'
                        }
                      </div>
                    </div>
                  </div>
                </div>
              `;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        container.addEventListener("click", onInquiryClick);
      }

      function createInquiryCard(inquiry, isAnswered) {
        const createdAt = inquiry.createdAt?.toDate
          ? inquiry.createdAt.toDate()
          : new Date();
        const timeStr = `${createdAt.getFullYear()}.${String(
          createdAt.getMonth() + 1
        ).padStart(2, "0")}.${String(createdAt.getDate()).padStart(
          2,
          "0"
        )} ${String(createdAt.getHours()).padStart(2, "0")}:${String(
          createdAt.getMinutes()
        ).padStart(2, "0")}`;

        return `
                <div class="bg-white border ${
                  isAnswered ? "border-emerald-200" : "border-amber-200"
                } rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                  <div class="flex items-start justify-between mb-2">
                    <div>
                      <span class="font-semibold text-gray-800">${saf(
                        inquiry.name
                      )}</span>
                      <span class="text-sm text-gray-500 ml-2">${saf(
                        inquiry.contact
                      )}</span>
                    </div>
                    <span class="text-xs text-gray-400">${timeStr}</span>
                  </div>

                  <div class="text-sm text-gray-700 mb-3 line-clamp-3">
                    ${saf(inquiry.content)}
                  </div>

                  <div class="flex gap-2">
                    <button
                      data-act="view-inquiry"
                      data-id="${inquiry.id}"
                      class="flex-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm"
                    >
                      <i class="fas fa-eye mr-1"></i>ìƒì„¸ë³´ê¸°
                    </button>
                    ${
                      !isAnswered
                        ? `<button
                            data-act="mark-answered"
                            data-id="${inquiry.id}"
                            class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors text-sm"
                          >
                            <i class="fas fa-check mr-1"></i>ì™„ë£Œ
                          </button>`
                        : ""
                    }
                    <button
                      data-act="delete-inquiry"
                      data-id="${inquiry.id}"
                      class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              `;
      }

      async function onInquiryClick(e) {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;

        const id = btn.dataset.id;
        const inquiry = inquiriesData.find((i) => i.id === id);
        if (!inquiry) return;

        if (btn.dataset.act === "view-inquiry") {
          showInquiryDetailModal(inquiry);
        } else if (btn.dataset.act === "mark-answered") {
          if (!confirm("ì´ ë¬¸ì˜ë¥¼ ë‹µë³€ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
          try {
            await updateDoc(doc(db, "inquiries", id), {
              status: "answered",
              answeredAt: serverTimestamp(),
            });
            showAlert("âœ…", "ë‹µë³€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (error) {
            console.error("ë¬¸ì˜ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
            showAlert("ğŸ˜¥", "ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        } else if (btn.dataset.act === "delete-inquiry") {
          if (!confirm("ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
          try {
            await deleteDoc(doc(db, "inquiries", id));
            showAlert("ğŸ—‘ï¸", "ë¬¸ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (error) {
            console.error("ë¬¸ì˜ ì‚­ì œ ì˜¤ë¥˜:", error);
            showAlert("ğŸ˜¥", "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        }
      }

      function showInquiryDetailModal(inquiry) {
        const createdAt = inquiry.createdAt?.toDate
          ? inquiry.createdAt.toDate()
          : new Date();
        const timeStr = `${createdAt.getFullYear()}ë…„ ${
          createdAt.getMonth() + 1
        }ì›” ${createdAt.getDate()}ì¼ ${String(createdAt.getHours()).padStart(
          2,
          "0"
        )}:${String(createdAt.getMinutes()).padStart(2, "0")}`;

        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]";
        modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                  <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">ğŸ“‹ ë¬¸ì˜ ìƒì„¸ ë‚´ì—­</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors">
                      <i class="fas fa-times text-xl"></i>
                    </button>
                  </div>

                  <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <label class="text-sm font-semibold text-gray-600">ì´ë¦„</label>
                          <p class="text-base text-gray-800 mt-1">${saf(
                            inquiry.name
                          )}</p>
                        </div>
                        <div>
                          <label class="text-sm font-semibold text-gray-600">ì—°ë½ì²˜</label>
                          <p class="text-base text-gray-800 mt-1">${saf(
                            inquiry.contact
                          )}</p>
                        </div>
                        <div class="col-span-2">
                          <label class="text-sm font-semibold text-gray-600">ë¬¸ì˜ ì¼ì‹œ</label>
                          <p class="text-base text-gray-800 mt-1">${timeStr}</p>
                        </div>
                        <div class="col-span-2">
                          <label class="text-sm font-semibold text-gray-600">ìƒíƒœ</label>
                          <p class="text-base text-gray-800 mt-1">
                            <span class="px-3 py-1 rounded-full text-sm ${
                              inquiry.status === "answered"
                                ? "bg-emerald-100 text-emerald-800"
                                : "bg-amber-100 text-amber-800"
                            }">
                              ${
                                inquiry.status === "answered"
                                  ? "ë‹µë³€ ì™„ë£Œ"
                                  : "ë¯¸ë‹µë³€"
                              }
                            </span>
                          </p>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label class="block text-sm font-semibold text-gray-600 mb-2">ë¬¸ì˜ ë‚´ìš©</label>
                      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <p class="text-gray-800 whitespace-pre-wrap">${saf(
                          inquiry.content
                        )}</p>
                      </div>
                    </div>
                  </div>

                  <div class="flex gap-3 justify-end mt-6">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                      ë‹«ê¸°
                    </button>
                  </div>
                </div>
              `;
        document.body.appendChild(modal);

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      /* ===== ë­ë¨¹ì§€ ë©”ë‰´ ê´€ë¦¬ ===== */
      function renderFoodMenuAdmin(container) {
        container.innerHTML = `
                <div class="section">
                  <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-utensils text-orange-500 mr-2"></i>ë­ë¨¹ì§€ ë©”ë‰´ ê´€ë¦¬
                  </h3>

                  <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 rounded-xl p-6 mb-6">
                    <p class="text-sm text-gray-700 mb-4">
                      íšŒì›ë“¤ì´ "ë­ë¨¹ì§€?" ë£°ë ›ì— í‘œì‹œë  ë©”ë‰´ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ë©´ ì—¬ëŸ¬ ë©”ë‰´ë¥¼ í•œ ë²ˆì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>

                    <button
                      id="admin-add-food-menu-btn"
                      class="w-full md:w-auto px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-xl hover:scale-105"
                    >
                      <i class="fas fa-plus mr-2"></i>ë©”ë‰´ ì¶”ê°€í•˜ê¸°
                    </button>
                  </div>

                  <div class="bg-white rounded-lg border-2 border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                      <h4 class="font-semibold text-gray-800">
                        ë“±ë¡ëœ ë©”ë‰´ ëª©ë¡
                        <span id="admin-menu-count-badge" class="text-sm text-gray-500 ml-2">(ë¡œë”©ì¤‘...)</span>
                      </h4>
                      <button
                        id="admin-delete-all-menus-btn"
                        class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors"
                      >
                        <i class="fas fa-trash mr-1"></i>ì „ì²´ ì‚­ì œ
                      </button>
                    </div>
                    <div id="admin-menu-list-container">
                      <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                  </div>
                </div>
              `;

        // ë©”ë‰´ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
        const addBtn = container.querySelector("#admin-add-food-menu-btn");
        if (addBtn) {
          addBtn.addEventListener("click", () => {
            openMenuManageModal();
          });
        }

        // ì „ì²´ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        const deleteAllBtn = container.querySelector(
          "#admin-delete-all-menus-btn"
        );
        if (deleteAllBtn) {
          deleteAllBtn.addEventListener("click", deleteAllMenus);
        }

        // ë©”ë‰´ ë¡œë“œ ë° í‘œì‹œ
        loadFoodMenus().then(() => {
          renderAdminMenuList();
        });
      }

      // ê´€ë¦¬ì í˜ì´ì§€ ë©”ë‰´ ëª©ë¡ ë Œë”ë§
      function renderAdminMenuList() {
        const container = document.getElementById("admin-menu-list-container");
        const countBadge = document.getElementById("admin-menu-count-badge");

        if (!container) return;

        if (countBadge) countBadge.textContent = `(${foodMenusData.length}ê°œ)`;

        if (foodMenusData.length === 0) {
          container.innerHTML = `
                  <div class="text-center py-12 text-gray-400">
                    <i class="fas fa-utensils text-4xl mb-3"></i>
                    <p>ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p class="text-sm">ë©”ë‰´ ì¶”ê°€í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©”ë‰´ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                  </div>
                `;
          return;
        }

        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
        const groupedMenus = {};
        foodMenusData.forEach((menu) => {
          if (!groupedMenus[menu.category]) {
            groupedMenus[menu.category] = [];
          }
          groupedMenus[menu.category].push(menu);
        });

        const categoryNames = {
          korean: "í•œì‹",
          japanese: "ì¼ì‹",
          chinese: "ì¤‘ì‹",
          western: "ì–‘ì‹",
          asian: "ì•„ì‹œì•ˆ",
          snack: "ë¶„ì‹",
          dessert: "ë””ì €íŠ¸",
          cafe: "ì¹´í˜",
          etc: "ê¸°íƒ€",
        };

        let html = '<div class="space-y-4">';
        Object.keys(groupedMenus).forEach((category) => {
          const emoji = getCategoryEmoji(category);
          const categoryName = categoryNames[category] || category;
          const menus = groupedMenus[category];

          html += `
                  <div class="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
                    <h5 class="font-bold text-gray-800 mb-3">
                      ${emoji} ${categoryName} <span class="text-sm text-gray-500">(${
            menus.length
          }ê°œ)</span>
                    </h5>
                    <div class="flex flex-wrap gap-2">
                      ${menus
                        .map((menu) => {
                          // ì‹ë‹¹ ì´ë¦„ê³¼ ë©”ë‰´ë¥¼ ë¶„ë¦¬í•˜ì—¬ í‘œì‹œ
                          const displayName =
                            menu.restaurantName && menu.menuName
                              ? `<div class="flex flex-col">
                                  <span class="font-semibold text-gray-800">${saf(
                                    menu.restaurantName
                                  )}</span>
                                  <span class="text-gray-600 text-xs">${saf(
                                    menu.menuName
                                  )}</span>
                                </div>`
                              : menu.name
                              ? `<div class="flex flex-col">
                                  ${
                                    menu.name.includes(" - ")
                                      ? menu.name
                                          .split(" - ")
                                          .map((part, idx) =>
                                            idx === 0
                                              ? `<span class="font-semibold text-gray-800">${saf(
                                                  part
                                                )}</span>`
                                              : `<span class="text-gray-600 text-xs">${saf(
                                                  part
                                                )}</span>`
                                          )
                                          .join("")
                                      : `<span>${saf(menu.name)}</span>`
                                  }
                                </div>`
                              : `<span>ë©”ë‰´ ì´ë¦„ ì—†ìŒ</span>`;

                          return `
                        <span class="inline-flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-300 text-sm">
                          ${displayName}
                          <button
                            class="admin-delete-menu-btn text-red-500 hover:text-red-700 transition-colors"
                            data-id="${menu.id}"
                            data-name="${
                              menu.name ||
                              (menu.restaurantName && menu.menuName
                                ? `${menu.restaurantName} - ${menu.menuName}`
                                : "")
                            }"
                          >
                            <i class="fas fa-times"></i>
                          </button>
                        </span>
                      `;
                        })
                        .join("")}
                    </div>
                  </div>
                `;
        });
        html += "</div>";

        container.innerHTML = html;

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        container.querySelectorAll(".admin-delete-menu-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const name = btn.dataset.name;

            if (confirm(`'${name}' ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              try {
                await deleteDoc(doc(db, "foodMenus", id));
                showAlert("âœ…", "ë©”ë‰´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                // onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ loadFoodMenus() ë¶ˆí•„ìš”
                renderAdminMenuList();
              } catch (error) {
                console.error("ë©”ë‰´ ì‚­ì œ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "ë©”ë‰´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            }
          });
        });
      }

      /* ===== ì§ì±… ê´€ë¦¬ ===== */
      function renderPositionsAdmin(container) {
        // íšŒì¥, ë¶€íšŒì¥ ê¶Œí•œ í™•ì¸ (ê´€ë¦¬ì ëª©ë¡ê³¼ ì§ì±… ëª¨ë‘ í™•ì¸)
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        const isPresidentOrVice =
          currentUser &&
          (currentUser.position === "íšŒì¥" ||
            currentUser.position === "ë¶€íšŒì¥");

        debugLog("=== ì§ì±… ê´€ë¦¬ ê¶Œí•œ í™•ì¸ ===");
        debugLog("currentUser:", currentUser);
        debugLog("adminList:", adminList);
        debugLog("isAdmin:", isAdmin);
        debugLog("isPresidentOrVice:", isPresidentOrVice);
        debugLog("currentUser.position:", currentUser?.position);

        if (!isAdmin || !isPresidentOrVice) {
          container.innerHTML = `
                  <div class="section">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì ì§ì±… ê´€ë¦¬</h3>
                    <div class="p-8 text-center">
                      <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                      <p class="text-gray-600 mb-2">ì„ì› ê´€ë¦¬ëŠ” íšŒì¥ê³¼ ë¶€íšŒì¥ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                      <p class="text-sm text-gray-500">í˜„ì¬ ê¶Œí•œ: ${
                        currentUser?.position || "ì¼ë°˜ íšŒì›"
                      }</p>
                      <p class="text-xs text-gray-400 mt-2">ê´€ë¦¬ì ì—¬ë¶€: ${
                        isAdmin ? "ê´€ë¦¬ì" : "ì¼ë°˜ íšŒì›"
                      }</p>
                    </div>
                  </div>
                `;
          return;
        }

        container.innerHTML = `
                <div class="section">
                  <h3 class="text-xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì ì§ì±… ê´€ë¦¬</h3>
                  <p class="text-xs text-gray-600 mb-4">ê´€ë¦¬ìë“¤ì—ê²Œ ì§ì±…ì„ ë¶€ì—¬í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                  <div class="mb-4">
                    <h4 class="font-semibold text-gray-700 mb-2">í˜„ì¬ ê´€ë¦¬ì ëª©ë¡ <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs ml-2">${
                      adminList.length
                    }ëª…</span></h4>
                    <div id="admin-positions-list" class="space-y-2">
                      ${renderAdminPositionsList()}
                    </div>

                    <!-- ê´€ë¦¬ì ì¶”ê°€ ì•ˆë‚´ -->
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <h5 class="font-medium text-blue-800 mb-2">ê´€ë¦¬ì ì¶”ê°€</h5>
                      <p class="text-sm text-blue-700 mb-2">
                        ê´€ë¦¬ì ì¶”ê°€ëŠ” <strong>ì‹œìŠ¤í…œ</strong> íƒ­ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                      </p>
                      <div class="text-xs text-blue-600 bg-blue-100 p-2 rounded">
                        <strong>ë¹„ìƒì‹œ:</strong> ë¡œê·¸ì¸ í™”ë©´ì—ì„œ í•™ë²ˆì— <code>foodie_emergency_2024!</code> ì…ë ¥ í›„ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.
                      </div>
                    </div>
                  </div>

                  <div class="border-t pt-4">
                    <h4 class="font-semibold text-gray-700 mb-2">ì§ì±… ë¶„ë¥˜ ê´€ë¦¬</h4>
                    <p class="text-xs text-gray-500 mb-4">ì§ì±…ì„ íšŒì¥ë‹¨ê³¼ ì¼ë°˜ ì„ì›ìœ¼ë¡œ ë¶„ë¥˜í•˜ì—¬ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <!-- íšŒì¥ë‹¨ ì§ì±… -->
                      <div class="border rounded-lg p-4 bg-blue-50">
                        <h5 class="font-semibold text-blue-900 mb-3 flex items-center">
                          <i class="fas fa-crown mr-2"></i>íšŒì¥ë‹¨
                        </h5>
                        <div class="space-y-2 mb-3">
                          ${renderPresidentPositions()}
                        </div>
                        <div class="border-t border-blue-200 pt-3">
                          <label class="block text-sm font-medium text-blue-900 mb-2">íšŒì¥ë‹¨ ì§ì±… ì¶”ê°€</label>
                          <div class="flex gap-2">
                            <input id="new-president-position" type="text" placeholder="ì§ì±…ëª… ì…ë ¥"
                                   autocomplete="off" spellcheck="false"
                                   class="flex-1 px-3 py-2 border border-blue-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="add-president-position-btn" type="button"
                                    class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm whitespace-nowrap">
                              <i class="fas fa-plus"></i>
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- ì¼ë°˜ ì„ì› ì§ì±… -->
                      <div class="border rounded-lg p-4 bg-green-50">
                        <h5 class="font-semibold text-green-900 mb-3 flex items-center">
                          <i class="fas fa-users mr-2"></i>ì¼ë°˜ ì„ì›
                        </h5>
                        <div class="space-y-2 mb-3">
                          ${renderRegularPositions()}
                        </div>
                        <div class="border-t border-green-200 pt-3">
                          <label class="block text-sm font-medium text-green-900 mb-2">ì¼ë°˜ ì„ì› ì§ì±… ì¶”ê°€</label>
                          <div class="flex gap-2">
                            <input id="new-regular-position" type="text" placeholder="ì§ì±…ëª… ì…ë ¥"
                                   autocomplete="off" spellcheck="false"
                                   class="flex-1 px-3 py-2 border border-green-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                            <button id="add-regular-position-btn" type="button"
                                    class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm whitespace-nowrap">
                              <i class="fas fa-plus"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document
          .getElementById("add-president-position-btn")
          .addEventListener("click", () => addPositionToCategory("president"));
        document
          .getElementById("new-president-position")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") addPositionToCategory("president");
          });

        document
          .getElementById("add-regular-position-btn")
          .addEventListener("click", () => addPositionToCategory("regular"));
        document
          .getElementById("new-regular-position")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") addPositionToCategory("regular");
          });

        // ê´€ë¦¬ì ì§ì±… ë³€ê²½ ì´ë²¤íŠ¸
        container.addEventListener("change", (e) => {
          if (e.target.matches("select[data-admin-id]")) {
            updateAdminPosition(e.target.dataset.adminId, e.target.value);
          }
        });

        // ê´€ë¦¬ì ì œê±° ë° ì§ì±… ì´ë™/ì œê±° ì´ë²¤íŠ¸
        container.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;

          console.log("ë²„íŠ¼ í´ë¦­ë¨:", btn);
          console.log("ë²„íŠ¼ í´ë˜ìŠ¤:", btn.className);
          console.log("ë²„íŠ¼ ë°ì´í„°:", btn.dataset);

          if (btn.classList.contains("remove-admin-btn")) {
            removeAdmin(btn.dataset.adminId);
          } else if (btn.classList.contains("move-to-regular-btn")) {
            movePositionToCategory(btn.dataset.position, "regular");
          } else if (btn.classList.contains("move-to-president-btn")) {
            movePositionToCategory(btn.dataset.position, "president");
          } else if (btn.classList.contains("remove-position-btn")) {
            console.log("ì§ì±… ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨!");
            removePositionFromCategory(
              btn.dataset.position,
              btn.dataset.category
            );
          }
        });
      }

      // ê´€ë¦¬ì ì¶”ê°€ ê¸°ëŠ¥ì€ ì‹œìŠ¤í…œ íƒ­ì—ì„œ ì²˜ë¦¬ë¨

      function renderPresidentPositions() {
        // íšŒì¥, ë¶€íšŒì¥, ê°œë°œìëŠ” ê³ ì •
        const fixedPositions = ["íšŒì¥", "ë¶€íšŒì¥", "ê°œë°œì"];

        // Firebaseì—ì„œ ë¡œë“œëœ ë°ì´í„° ì‚¬ìš© (ë Œë”ë§ í•¨ìˆ˜ëŠ” ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ)
        const positionsToRender =
          presidentPositions.length > 0 ? presidentPositions : fixedPositions;

        return positionsToRender
          .map((pos) => {
            const isFixed = fixedPositions.includes(pos);
            return `
                  <div class="flex items-center justify-between p-2 bg-white rounded border border-blue-200">
                    <span class="text-sm font-medium text-blue-900">${pos}${
              isFixed
                ? ' <span class="text-xs text-blue-500">(ê³ ì •)</span>'
                : ""
            }</span>
                    <div class="flex items-center gap-2">
                      ${
                        !isFixed
                          ? `
                        <button class="move-to-regular-btn text-green-600 hover:text-green-800 text-xs px-2 py-1"
                                data-position="${pos}"
                                title="ì¼ë°˜ ì„ì›ìœ¼ë¡œ ì´ë™">
                          <i class="fas fa-arrow-right"></i>
                        </button>
                        <button class="remove-position-btn text-red-500 hover:text-red-700 text-xs px-2 py-1"
                                data-position="${pos}"
                                data-category="president"
                                title="ì‚­ì œ">
                          <i class="fas fa-times"></i>
                        </button>
                      `
                          : '<span class="text-xs text-gray-400">ê³ ì •</span>'
                      }
                    </div>
                  </div>
                `;
          })
          .join("");
      }

      function renderRegularPositions() {
        // ìš´ì˜ì§„ë§Œ ê³ ì •
        const fixedPositions = ["ìš´ì˜ì§„"];

        // Firebaseì—ì„œ ë¡œë“œëœ ë°ì´í„° ì‚¬ìš© (ë Œë”ë§ í•¨ìˆ˜ëŠ” ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ)
        const positionsToRender =
          regularPositions.length > 0 ? regularPositions : fixedPositions;

        return positionsToRender
          .map((pos) => {
            const isFixed = fixedPositions.includes(pos);
            return `
                  <div class="flex items-center justify-between p-2 bg-white rounded border border-green-200">
                    <span class="text-sm font-medium text-green-900">${pos}${
              isFixed
                ? ' <span class="text-xs text-green-500">(ê³ ì •)</span>'
                : ""
            }</span>
                    <div class="flex items-center gap-2">
                      ${
                        !isFixed
                          ? `
                        <button class="move-to-president-btn text-blue-600 hover:text-blue-800 text-xs px-2 py-1"
                                data-position="${pos}"
                                title="íšŒì¥ë‹¨ìœ¼ë¡œ ì´ë™">
                          <i class="fas fa-arrow-left"></i>
                        </button>
                        <button class="remove-position-btn text-red-500 hover:text-red-700 text-xs px-2 py-1"
                                data-position="${pos}"
                                data-category="regular"
                                title="ì‚­ì œ">
                          <i class="fas fa-times"></i>
                        </button>
                      `
                          : '<span class="text-xs text-gray-400">ê³ ì •</span>'
                      }
                    </div>
                  </div>
                `;
          })
          .join("");
      }

      function renderAdminPositionsList() {
        if (!adminList.length)
          return '<p class="text-gray-500 text-center py-4">ë“±ë¡ëœ ê´€ë¦¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        // ê´€ë¦¬ìë“¤ì„ ì§ì±…ë³„ë¡œ ë¶„ë¥˜
        const presidentAdmins = [];
        const regularAdmins = [];
        const otherPositionAdmins = []; // presidentPositionsì™€ regularPositionsì— ì—†ëŠ” ë‹¤ë¥¸ ì§ì±…
        const noPositionAdmins = [];

        adminList.forEach((studentId) => {
          const position = adminPositions[studentId] || "";
          const member = membersData?.find((m) => m.studentId === studentId);
          const adminData = {
            studentId,
            position,
            name: member?.name || "ì•Œ ìˆ˜ ì—†ìŒ",
          };

          if (!position) {
            noPositionAdmins.push(adminData);
          } else if (presidentPositions.includes(position)) {
            presidentAdmins.push(adminData);
          } else if (regularPositions.includes(position)) {
            regularAdmins.push(adminData);
          } else {
            // presidentPositionsì™€ regularPositionsì— ì—†ëŠ” ì§ì±…ë„ ë³„ë„ ì„¹ì…˜ìœ¼ë¡œ í‘œì‹œ
            otherPositionAdmins.push(adminData);
          }
        });

        const renderAdminCard = (admin) => `
                <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200">
                  <div>
                          <div class="font-medium text-gray-800">${saf(
                            admin.name
                          )}</div>
                    <div class="text-sm text-gray-500">${admin.studentId}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <select data-admin-id="${
                      admin.studentId
                    }" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                      <option value="">ì§ì±… ì—†ìŒ</option>
                      ${renderPositionOptions(admin.position)}
                    </select>
                    <button class="remove-admin-btn text-red-500 hover:text-red-700 p-1" data-admin-id="${
                      admin.studentId
                    }" title="ê´€ë¦¬ì ì œê±°">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              `;

        let html = "";

        // íšŒì¥ë‹¨
        if (presidentAdmins.length > 0) {
          const showAll = presidentAdmins.length <= 2;
          const visibleAdmins = showAll
            ? presidentAdmins
            : presidentAdmins.slice(0, 2);
          const hiddenAdmins = showAll ? [] : presidentAdmins.slice(2);

          html += `
                  <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                      <h5 class="font-semibold text-blue-900 flex items-center">
                        <i class="fas fa-crown mr-2 text-blue-600"></i>íšŒì¥ë‹¨
                        <span class="ml-2 bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">${
                          presidentAdmins.length
                        }ëª…</span>
                      </h5>
                      ${
                        presidentAdmins.length > 2
                          ? `
                        <button
                          onclick="toggleAdminList('president')"
                          id="president-toggle-btn"
                          class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1 transition-colors"
                        >
                          <span id="president-toggle-text">ì „ì²´ë³´ê¸°</span>
                          <i class="fas fa-chevron-down text-xs transition-transform" id="president-toggle-icon"></i>
                        </button>
                      `
                          : ""
                      }
                    </div>
                    <div class="space-y-2 bg-blue-50 p-3 rounded-lg">
                      <div id="president-visible-list">
                        ${visibleAdmins.map(renderAdminCard).join("")}
                      </div>
                      ${
                        hiddenAdmins.length > 0
                          ? `
                        <div id="president-hidden-list" style="display: none;" class="space-y-2 mt-2">
                          ${hiddenAdmins.map(renderAdminCard).join("")}
                        </div>
                      `
                          : ""
                      }
                    </div>
                  </div>
                `;
        }

        // ì¼ë°˜ ì„ì›
        if (regularAdmins.length > 0) {
          const showAll = regularAdmins.length <= 2;
          const visibleAdmins = showAll
            ? regularAdmins
            : regularAdmins.slice(0, 2);
          const hiddenAdmins = showAll ? [] : regularAdmins.slice(2);

          html += `
                  <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                      <h5 class="font-semibold text-green-900 flex items-center">
                        <i class="fas fa-users mr-2 text-green-600"></i>ì¼ë°˜ ì„ì›
                        <span class="ml-2 bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs">${
                          regularAdmins.length
                        }ëª…</span>
                      </h5>
                      ${
                        regularAdmins.length > 2
                          ? `
                        <button
                          onclick="toggleAdminList('regular')"
                          id="regular-toggle-btn"
                          class="text-sm text-green-600 hover:text-green-800 flex items-center gap-1 transition-colors"
                        >
                          <span id="regular-toggle-text">ì „ì²´ë³´ê¸°</span>
                          <i class="fas fa-chevron-down text-xs transition-transform" id="regular-toggle-icon"></i>
                        </button>
                      `
                          : ""
                      }
                    </div>
                    <div class="space-y-2 bg-green-50 p-3 rounded-lg">
                      <div id="regular-visible-list">
                        ${visibleAdmins.map(renderAdminCard).join("")}
                      </div>
                      ${
                        hiddenAdmins.length > 0
                          ? `
                        <div id="regular-hidden-list" style="display: none;" class="space-y-2 mt-2">
                          ${hiddenAdmins.map(renderAdminCard).join("")}
                        </div>
                      `
                          : ""
                      }
                    </div>
                  </div>
                `;
        }

        // ê¸°íƒ€ ì§ì±… (presidentPositionsì™€ regularPositionsì— ì—†ëŠ” ì§ì±…)
        if (otherPositionAdmins.length > 0) {
          html += `
                  <div class="mb-4">
                    <h5 class="font-semibold text-purple-700 mb-2 flex items-center">
                      <i class="fas fa-briefcase mr-2 text-purple-600"></i>ê¸°íƒ€ ì§ì±…
                      <span class="ml-2 bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs">${
                        otherPositionAdmins.length
                      }ëª…</span>
                    </h5>
                    <div class="space-y-2 bg-purple-50 p-3 rounded-lg">
                      ${otherPositionAdmins.map(renderAdminCard).join("")}
                    </div>
                  </div>
                `;
        }

        // ì§ì±… ì—†ìŒ
        if (noPositionAdmins.length > 0) {
          html += `
                  <div class="mb-4">
                    <h5 class="font-semibold text-gray-700 mb-2 flex items-center">
                      <i class="fas fa-user mr-2 text-gray-500"></i>ì§ì±… ë¯¸ì§€ì •
                      <span class="ml-2 bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs">${
                        noPositionAdmins.length
                      }ëª…</span>
                    </h5>
                    <div class="space-y-2 bg-gray-50 p-3 rounded-lg">
                      ${noPositionAdmins.map(renderAdminCard).join("")}
                    </div>
                  </div>
                `;
        }

        return html;
      }

      function renderPositionOptions(selectedPosition = "") {
        // íšŒì¥ë‹¨ê³¼ ì¼ë°˜ ì„ì› ì§ì±…ì„ ëª¨ë‘ í¬í•¨
        const allPositions = [
          ...presidentPositions,
          ...regularPositions,
          ...Object.values(adminPositions).filter(
            (p) =>
              !presidentPositions.includes(p) && !regularPositions.includes(p)
          ),
        ];
        const uniquePositions = [...new Set(allPositions)];

        return uniquePositions
          .map(
            (pos) =>
              `<option value="${pos}" ${
                pos === selectedPosition ? "selected" : ""
              }>${pos}</option>`
          )
          .join("");
      }

      // ì„ì› ëª©ë¡ í† ê¸€ í•¨ìˆ˜
      window.toggleAdminList = (category) => {
        const hiddenList = document.getElementById(`${category}-hidden-list`);
        const toggleText = document.getElementById(`${category}-toggle-text`);
        const toggleIcon = document.getElementById(`${category}-toggle-icon`);

        if (hiddenList) {
          if (hiddenList.style.display === "none") {
            hiddenList.style.display = "block";
            toggleText.textContent = "ì ‘ê¸°";
            toggleIcon.style.transform = "rotate(180deg)";
          } else {
            hiddenList.style.display = "none";
            toggleText.textContent = "ì „ì²´ë³´ê¸°";
            toggleIcon.style.transform = "rotate(0deg)";
          }
        }
      };

      // ì§ì±… ì¶”ê°€ í•¨ìˆ˜
      async function addPositionToCategory(category) {
        const inputId =
          category === "president"
            ? "new-president-position"
            : "new-regular-position";
        const input = document.getElementById(inputId);
        const position = input.value.trim();

        if (!position) {
          showAlert("ğŸ˜¥", "ì§ì±…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        // ì¤‘ë³µ ì²´í¬
        const allPositions = [...presidentPositions, ...regularPositions];
        if (allPositions.includes(position)) {
          showAlert("âš ï¸", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì§ì±…ì…ë‹ˆë‹¤.");
          return;
        }

        try {
          if (category === "president") {
            const newPositions = [...presidentPositions, position];
            debugLog("ğŸ’¾ íšŒì¥ë‹¨ ì§ì±… ì €ì¥ ì‹œë„:", newPositions);
            await setDoc(doc(db, "settings", "presidentPositions"), {
              positions: newPositions,
            });
            presidentPositions = newPositions;
            debugLog("âœ… íšŒì¥ë‹¨ ì§ì±… ì €ì¥ ì™„ë£Œ:", presidentPositions);
            showAlert("âœ…", `"${position}" ì§ì±…ì´ íšŒì¥ë‹¨ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } else {
            const newPositions = [...regularPositions, position];
            debugLog("ğŸ’¾ ì¼ë°˜ ì„ì› ì§ì±… ì €ì¥ ì‹œë„:", newPositions);
            await setDoc(doc(db, "settings", "regularPositions"), {
              positions: newPositions,
            });
            regularPositions = newPositions;
            debugLog("âœ… ì¼ë°˜ ì„ì› ì§ì±… ì €ì¥ ì™„ë£Œ:", regularPositions);
            showAlert("âœ…", `"${position}" ì§ì±…ì´ ì¼ë°˜ ì„ì›ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          }

          input.value = "";
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          debugError("âŒ ì§ì±… ì¶”ê°€ ì˜¤ë¥˜:", e);
          showAlert("ğŸ˜¥", "ì§ì±… ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì§ì±… ì´ë™ í•¨ìˆ˜
      async function movePositionToCategory(position, targetCategory) {
        debugLog("=== ì§ì±… ì´ë™ í•¨ìˆ˜ í˜¸ì¶œ ===");
        debugLog("position:", position);
        debugLog("targetCategory:", targetCategory);
        debugLog("í˜„ì¬ íšŒì¥ë‹¨:", presidentPositions);
        debugLog("í˜„ì¬ ì¼ë°˜ ì„ì›:", regularPositions);

        try {
          let newPresidentPositions = [...presidentPositions];
          let newRegularPositions = [...regularPositions];

          // ë¨¼ì € ì–‘ìª½ì—ì„œ ëª¨ë‘ ì œê±° (ì¤‘ë³µ ë°©ì§€)
          newPresidentPositions = newPresidentPositions.filter(
            (p) => p !== position
          );
          newRegularPositions = newRegularPositions.filter(
            (p) => p !== position
          );

          debugLog("ì œê±° í›„ íšŒì¥ë‹¨:", newPresidentPositions);
          debugLog("ì œê±° í›„ ì¼ë°˜ ì„ì›:", newRegularPositions);

          // íƒ€ê²Ÿ ì¹´í…Œê³ ë¦¬ì— ì¶”ê°€
          if (targetCategory === "regular") {
            // íšŒì¥ë‹¨ -> ì¼ë°˜ ì„ì›
            if (!newRegularPositions.includes(position)) {
              newRegularPositions.push(position);
            }
          } else {
            // ì¼ë°˜ ì„ì› -> íšŒì¥ë‹¨
            if (!newPresidentPositions.includes(position)) {
              newPresidentPositions.push(position);
            }
          }

          debugLog("ìµœì¢… íšŒì¥ë‹¨:", newPresidentPositions);
          debugLog("ìµœì¢… ì¼ë°˜ ì„ì›:", newRegularPositions);

          // Firebaseì— ì €ì¥ (ë™ì‹œì— ì €ì¥)
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: newPresidentPositions,
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: newRegularPositions,
            }),
          ]);

          presidentPositions = newPresidentPositions;
          regularPositions = newRegularPositions;

          showAlert("âœ…", `"${position}" ì§ì±…ì´ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          debugError(e);
          showAlert("ğŸ˜¥", "ì§ì±… ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì§ì±… ì œê±° í•¨ìˆ˜
      async function removePositionFromCategory(position, category) {
        debugLog("=== ì§ì±… ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œ ===");
        debugLog("position:", position);
        debugLog("category:", category);

        // ê³ ì • ì§ì±…ì€ ì‚­ì œ ë¶ˆê°€
        const fixedPositions = ["íšŒì¥", "ë¶€íšŒì¥", "ìš´ì˜ì§„", "ê°œë°œì"];
        if (fixedPositions.includes(position)) {
          showAlert("ğŸ˜¥", "ê³ ì • ì§ì±…ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        if (!confirm(`"${position}" ì§ì±…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          debugLog("ì‚¬ìš©ìê°€ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.");
          return;
        }

        debugLog("ì‚­ì œ ì§„í–‰ ì¤‘...");

        try {
          let newPositions;
          if (category === "president") {
            newPositions = presidentPositions.filter((p) => p !== position);
            await setDoc(doc(db, "settings", "presidentPositions"), {
              positions: newPositions,
            });
            presidentPositions = newPositions;
          } else {
            newPositions = regularPositions.filter((p) => p !== position);
            await setDoc(doc(db, "settings", "regularPositions"), {
              positions: newPositions,
            });
            regularPositions = newPositions;
          }

          // í•´ë‹¹ ì§ì±…ì„ ê°€ì§„ ëª¨ë“  ê´€ë¦¬ìì—ì„œ ì œê±°
          const newAdminPositions = { ...adminPositions };
          Object.keys(newAdminPositions).forEach((studentId) => {
            if (newAdminPositions[studentId] === position) {
              delete newAdminPositions[studentId];
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: newAdminPositions,
          });

          showAlert("âœ…", `"${position}" ì§ì±…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          debugError(e);
          showAlert("ğŸ˜¥", "ì§ì±… ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function updateAdminPosition(studentId, position) {
        try {
          debugLog("=== ì§ì±… ì—…ë°ì´íŠ¸ ì‹œì‘ ===");
          debugLog("studentId:", studentId);
          debugLog("newPosition:", position);
          debugLog("í˜„ì¬ adminPositions:", adminPositions);

          const newPositions = { ...adminPositions };

          // positionì´ ë¹ˆ ë¬¸ìì—´ì´ê±°ë‚˜ falsy ê°’ì´ë©´ ì§ì±… ì œê±°
          if (position && position.trim()) {
            newPositions[studentId] = position.trim();
            debugLog("ì§ì±… ì„¤ì •:", position.trim());
          } else {
            // "ì§ì±… ì—†ìŒ"ì„ ì„ íƒí•œ ê²½ìš°
            delete newPositions[studentId];
            debugLog("ì§ì±… ì œê±°ë¨");
          }

          debugLog("ì—…ë°ì´íŠ¸ë  adminPositions:", newPositions);

          // Firebaseì— positionsë§Œ ì—…ë°ì´íŠ¸ (merge: true ì‚¬ìš©)
          await setDoc(
            doc(db, "admins", "list"),
            {
              positions: newPositions,
            },
            { merge: true }
          );

          // ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (ì¦‰ì‹œ ë°˜ì˜)
          adminPositions = newPositions;
          debugLog("âœ… ë¡œì»¬ adminPositions ì—…ë°ì´íŠ¸ ì™„ë£Œ:", adminPositions);

          // í˜„ì¬ ì‚¬ìš©ìì˜ ì§ì±…ë„ ì—…ë°ì´íŠ¸
          if (currentUser && currentUser.studentId === studentId) {
            currentUser.position =
              position && position.trim() ? position.trim() : "ì¼ë°˜ íšŒì›";
            debugLog("âœ… currentUser.position ì—…ë°ì´íŠ¸:", currentUser.position);

            // localStorageì—ë„ ì—…ë°ì´íŠ¸ëœ position ì €ì¥
            const savedUser = JSON.parse(
              localStorage.getItem("foodieUser") || "{}"
            );
            if (savedUser.studentId === studentId) {
              savedUser.position = currentUser.position;
              localStorage.setItem("foodieUser", JSON.stringify(savedUser));
            }
          }

          showAlert("âœ…", "ì§ì±…ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");

          // í˜ì´ì§€ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ UI ì—…ë°ì´íŠ¸
          const container = document.getElementById("subtab-container");
          if (container) {
            renderPositionsAdmin(container);
          }
        } catch (e) {
          console.error("ì§ì±… ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e);
          showAlert("ğŸ˜¥", "ì§ì±… ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // addAdmin í•¨ìˆ˜ ì œê±°ë¨

      async function removeAdmin(studentId) {
        if (!confirm(`${studentId} ê´€ë¦¬ì ê¶Œí•œì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }

        try {
          const newAdminList = adminList.filter((id) => id !== studentId);
          const newPositions = { ...adminPositions };
          delete newPositions[studentId];

          await setDoc(
            doc(db, "admins", "list"),
            {
              studentIds: newAdminList,
              positions: newPositions,
            },
            { merge: true }
          );

          showAlert("âœ…", `${studentId} ê´€ë¦¬ì ê¶Œí•œì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          console.error(e);
          showAlert("ğŸ˜¥", "ê´€ë¦¬ì ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë¸”ë¡ ìˆœì„œ ë³€ê²½ í•¨ìˆ˜ë“¤
      async function moveBlockUp(blockId) {
        try {
          console.log("=== ë¸”ë¡ ìœ„ë¡œ ì´ë™ ì‹œì‘ ===");
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          // ì¼ì • ë¸”ë¡ ì²˜ë¦¬ - ì‹¤ì œë¡œëŠ” ìˆœì„œ ë³€ê²½ í—ˆìš©
          if (blockId === "auto-schedule-block") {
            console.log("ì¼ì • ë¸”ë¡ì˜ ìˆœì„œ ë³€ê²½ ìš”ì²­");
            // ìë™ ì¼ì • ë¸”ë¡ì€ ì‹¤ì œë¡œëŠ” ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ì§€ë§Œ,
            // UIì—ì„œëŠ” ë‹¤ë¥¸ ë¡œê·¸ì•„ì›ƒ ë¸”ë¡ë“¤ê³¼ í•¨ê»˜ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
            showAlert("â„¹ï¸", "ì¼ì • ë¸”ë¡ì˜ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ë‹¤ì‹œ ë Œë”ë§
            return;
          }

          // order í•„ë“œë¡œ ì •ë ¬ëœ ìƒíƒœì—ì„œ ì°¾ê¸°
          const sortedBlocks = [...blocksData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedBlocks:", sortedBlocks);

          const currentBlock = sortedBlocks.find((b) => b.id === blockId);
          console.log("currentBlock:", currentBlock);

          if (!currentBlock) {
            console.log("í˜„ì¬ ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const currentIndex = sortedBlocks.indexOf(currentBlock);
          console.log("currentIndex:", currentIndex);

          if (currentIndex <= 0) {
            console.log("ì´ë¯¸ ë§¨ ìœ„ì— ìˆìŠµë‹ˆë‹¤.");
            return; // ì´ë¯¸ ë§¨ ìœ„
          }

          const targetBlock = sortedBlocks[currentIndex - 1];
          console.log("targetBlock:", targetBlock);

          // order ê°’ êµí™˜ - ë” ëª…í™•í•œ ë°©ì‹ìœ¼ë¡œ
          const currentOrder = currentBlock.order ?? currentIndex;
          const targetOrder = targetBlock.order ?? currentIndex - 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          // ê°™ì€ order ê°’ì´ë©´ ì‹¤ì œë¡œ êµí™˜í•˜ì§€ ì•ŠìŒ
          if (currentOrder === targetOrder) {
            console.log(
              "ê°™ì€ order ê°’ì„ ê°€ì§„ ë¸”ë¡ë“¤ì…ë‹ˆë‹¤. ì‹¤ì œ order ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );

            // ì‹¤ì œ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ order ê°’ ì„¤ì •
            const newCurrentOrder = currentIndex - 1;
            const newTargetOrder = currentIndex;

            console.log(
              "ìƒˆë¡œìš´ order ê°’ - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: newTargetOrder,
            });
          } else {
            // Firebase ì—…ë°ì´íŠ¸
            console.log("Firebase ì—…ë°ì´íŠ¸ ì‹œì‘...");
            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");

          showAlert("âœ…", "ë¸”ë¡ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
          console.error("ë¸”ë¡ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë¸”ë¡ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function moveBlockDown(blockId) {
        try {
          console.log("=== ë¸”ë¡ ì•„ë˜ë¡œ ì´ë™ ì‹œì‘ ===");
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          // ì¼ì • ë¸”ë¡ ì²˜ë¦¬ - ì‹¤ì œë¡œëŠ” ìˆœì„œ ë³€ê²½ í—ˆìš©
          if (blockId === "auto-schedule-block") {
            console.log("ì¼ì • ë¸”ë¡ì˜ ìˆœì„œ ë³€ê²½ ìš”ì²­");
            // ìë™ ì¼ì • ë¸”ë¡ì€ ì‹¤ì œë¡œëŠ” ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ì§€ë§Œ,
            // UIì—ì„œëŠ” ë‹¤ë¥¸ ë¡œê·¸ì•„ì›ƒ ë¸”ë¡ë“¤ê³¼ í•¨ê»˜ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
            showAlert("â„¹ï¸", "ì¼ì • ë¸”ë¡ì˜ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ë‹¤ì‹œ ë Œë”ë§
            return;
          }

          // order í•„ë“œë¡œ ì •ë ¬ëœ ìƒíƒœì—ì„œ ì°¾ê¸°
          const sortedBlocks = [...blocksData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedBlocks:", sortedBlocks);

          const currentBlock = sortedBlocks.find((b) => b.id === blockId);
          console.log("currentBlock:", currentBlock);

          if (!currentBlock) {
            console.log("í˜„ì¬ ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const currentIndex = sortedBlocks.indexOf(currentBlock);
          console.log("currentIndex:", currentIndex);

          if (currentIndex >= sortedBlocks.length - 1) {
            console.log("ì´ë¯¸ ë§¨ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤.");
            return; // ì´ë¯¸ ë§¨ ì•„ë˜
          }

          const targetBlock = sortedBlocks[currentIndex + 1];
          console.log("targetBlock:", targetBlock);

          // order ê°’ êµí™˜ - ë” ëª…í™•í•œ ë°©ì‹ìœ¼ë¡œ
          const currentOrder = currentBlock.order ?? currentIndex;
          const targetOrder = targetBlock.order ?? currentIndex + 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          // ê°™ì€ order ê°’ì´ë©´ ì‹¤ì œë¡œ êµí™˜í•˜ì§€ ì•ŠìŒ
          if (currentOrder === targetOrder) {
            console.log(
              "ê°™ì€ order ê°’ì„ ê°€ì§„ ë¸”ë¡ë“¤ì…ë‹ˆë‹¤. ì‹¤ì œ order ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );

            // ì‹¤ì œ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ order ê°’ ì„¤ì •
            const newCurrentOrder = currentIndex + 1;
            const newTargetOrder = currentIndex;

            console.log(
              "ìƒˆë¡œìš´ order ê°’ - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: newTargetOrder,
            });
          } else {
            // Firebase ì—…ë°ì´íŠ¸
            console.log("Firebase ì—…ë°ì´íŠ¸ ì‹œì‘...");
            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");

          showAlert("âœ…", "ë¸”ë¡ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
          console.error("ë¸”ë¡ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë¸”ë¡ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ í•¨ìˆ˜ë“¤
      async function moveEventUp(eventId) {
        try {
          console.log("=== ì´ë²¤íŠ¸ ìœ„ë¡œ ì´ë™ ì‹œì‘ ===");
          console.log("eventId:", eventId);
          console.log("eventsData:", eventsData);

          // order í•„ë“œë¡œ ì •ë ¬ëœ ìƒíƒœì—ì„œ ì°¾ê¸°
          const sortedEvents = [...eventsData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedEvents:", sortedEvents);

          const currentEvent = sortedEvents.find((e) => e.id === eventId);
          console.log("currentEvent:", currentEvent);

          if (!currentEvent) {
            console.log("í˜„ì¬ ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const currentIndex = sortedEvents.indexOf(currentEvent);
          console.log("currentIndex:", currentIndex);

          if (currentIndex <= 0) {
            console.log("ì´ë¯¸ ë§¨ ìœ„ì— ìˆìŠµë‹ˆë‹¤.");
            return;
          }

          const targetEvent = sortedEvents[currentIndex - 1];
          console.log("targetEvent:", targetEvent);

          // order ê°’ êµí™˜
          const currentOrder = currentEvent.order ?? currentIndex;
          const targetOrder = targetEvent.order ?? currentIndex - 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          if (currentOrder === targetOrder) {
            console.log(
              "ê°™ì€ order ê°’ì„ ê°€ì§„ ì´ë²¤íŠ¸ë“¤ì…ë‹ˆë‹¤. ì‹¤ì œ order ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );

            const newCurrentOrder = currentIndex - 1;
            const newTargetOrder = currentIndex;

            console.log(
              "ìƒˆë¡œìš´ order ê°’ - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "events", eventId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: newTargetOrder,
            });
          } else {
            console.log("Firebase ì—…ë°ì´íŠ¸ ì‹œì‘...");
            await updateDoc(doc(db, "events", eventId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");

          // eventsData ë°°ì—´ì˜ order ê°’ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
          const currentEventInData = eventsData.find((e) => e.id === eventId);
          const targetEventInData = eventsData.find(
            (e) => e.id === targetEvent.id
          );
          if (currentEventInData && targetEventInData) {
            if (currentOrder === targetOrder) {
              currentEventInData.order = currentIndex - 1;
              targetEventInData.order = currentIndex;
            } else {
              currentEventInData.order = targetOrder;
              targetEventInData.order = currentOrder;
            }
            // ë‹¤ì‹œ ì •ë ¬
            eventsData.sort((a, b) => (a.order || 0) - (b.order || 0));
          }

          showAlert("âœ…", "ì´ë²¤íŠ¸ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          smoothRender("main-content", renderAll);

          // ì‹ ì²­ íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹¤ì‹œ ë Œë”ë§
          const reservationTab = document.getElementById("reservation-tab");
          if (reservationTab && reservationTab.classList.contains("active")) {
            const isAdmin =
              currentUser && adminList.includes(currentUser.studentId);
            renderReservationTab(isAdmin);
          }
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function moveEventDown(eventId) {
        try {
          console.log("=== ì´ë²¤íŠ¸ ì•„ë˜ë¡œ ì´ë™ ì‹œì‘ ===");
          console.log("eventId:", eventId);
          console.log("eventsData:", eventsData);

          // order í•„ë“œë¡œ ì •ë ¬ëœ ìƒíƒœì—ì„œ ì°¾ê¸°
          const sortedEvents = [...eventsData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedEvents:", sortedEvents);

          const currentEvent = sortedEvents.find((e) => e.id === eventId);
          console.log("currentEvent:", currentEvent);

          if (!currentEvent) {
            console.log("í˜„ì¬ ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const currentIndex = sortedEvents.indexOf(currentEvent);
          console.log("currentIndex:", currentIndex);

          if (currentIndex >= sortedEvents.length - 1) {
            console.log("ì´ë¯¸ ë§¨ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤.");
            return;
          }

          const targetEvent = sortedEvents[currentIndex + 1];
          console.log("targetEvent:", targetEvent);

          // order ê°’ êµí™˜
          const currentOrder = currentEvent.order ?? currentIndex;
          const targetOrder = targetEvent.order ?? currentIndex + 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          if (currentOrder === targetOrder) {
            console.log(
              "ê°™ì€ order ê°’ì„ ê°€ì§„ ì´ë²¤íŠ¸ë“¤ì…ë‹ˆë‹¤. ì‹¤ì œ order ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );

            const newCurrentOrder = currentIndex + 1;
            const newTargetOrder = currentIndex;

            console.log(
              "ìƒˆë¡œìš´ order ê°’ - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "events", eventId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: newTargetOrder,
            });
          } else {
            console.log("Firebase ì—…ë°ì´íŠ¸ ì‹œì‘...");
            await updateDoc(doc(db, "events", eventId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");

          // eventsData ë°°ì—´ì˜ order ê°’ë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
          const currentEventInData = eventsData.find((e) => e.id === eventId);
          const targetEventInData = eventsData.find(
            (e) => e.id === targetEvent.id
          );
          if (currentEventInData && targetEventInData) {
            if (currentOrder === targetOrder) {
              currentEventInData.order = currentIndex + 1;
              targetEventInData.order = currentIndex;
            } else {
              currentEventInData.order = targetOrder;
              targetEventInData.order = currentOrder;
            }
            // ë‹¤ì‹œ ì •ë ¬
            eventsData.sort((a, b) => (a.order || 0) - (b.order || 0));
          }

          showAlert("âœ…", "ì´ë²¤íŠ¸ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          smoothRender("main-content", renderAll);

          // ì‹ ì²­ íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹¤ì‹œ ë Œë”ë§
          const reservationTab = document.getElementById("reservation-tab");
          if (reservationTab && reservationTab.classList.contains("active")) {
            const isAdmin =
              currentUser && adminList.includes(currentUser.studentId);
            renderReservationTab(isAdmin);
          }
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /* ===== í™ˆ ë¸”ë¡ + ë¡œë“œë§µ ê´€ë¦¬ ===== */
      function renderBlockListItem(block) {
        return `
                <li class="flex flex-col sm:flex-row sm:items-start sm:justify-between p-3 bg-gray-50 rounded-lg border block-item gap-3" data-block-id="${
                  block.id
                }">
                  <div class="flex items-start gap-3 flex-1 min-w-0">
                    <span class="text-xs px-2 py-1 rounded flex-shrink-0 ${
                      block.type === "scores"
                        ? "bg-green-100 text-green-700"
                        : block.type === "qa"
                        ? "bg-blue-100 text-blue-700"
                        : block.type === "roadmap"
                        ? "bg-purple-100 text-purple-700"
                        : "bg-orange-100 text-orange-700"
                    }">${
          block.type === "notice"
            ? "ê³µì§€"
            : block.type === "qa"
            ? "Q&A"
            : block.type === "roadmap"
            ? "ë¡œë“œë§µ"
            : "ì ìˆ˜íŒ"
        }</span>
                    <div class="flex-1 min-w-0">
                      <span class="font-medium block-title text-gray-800 break-words">${saf(
                        block.title || "(ì œëª© ì—†ìŒ)"
                      )}</span>
                      <span class="text-xs ${
                        block.visible !== false
                          ? "text-green-600"
                          : "text-gray-400"
                      }">
                        <i class="fas ${
                          block.visible !== false ? "fa-eye" : "fa-eye-slash"
                        } mr-1"></i>
                        ${block.visible !== false ? "ë…¸ì¶œ" : "ìˆ¨ê¹€"}
                      </span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0 sm:ml-2">
                    <button class="edit-block-btn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors"
                                        data-id="${block.id}" data-type="${
          block.type
        }" title="ì´ ë¸”ë¡ì„ ìˆ˜ì •í•©ë‹ˆë‹¤">
                      <i class="fas fa-edit mr-1"></i>ìˆ˜ì •
                    </button>
                    <button class="delete-block-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors"
                                        data-id="${
                                          block.id
                                        }" title="ì´ ë¸”ë¡ì„ ì‚­ì œí•©ë‹ˆë‹¤">
                      <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                    </button>
                  </div>
                </li>
              `;
      }

      // ë¸”ë¡ ìˆœì„œ ì €ì¥ í•¨ìˆ˜
      async function saveBlockOrder() {
        try {
          const sortableLists = document.querySelectorAll(".block-sortable");
          const updates = [];

          sortableLists.forEach((list) => {
            const showWhen = list.dataset.showWhen;
            const items = list.querySelectorAll(".block-item");

            items.forEach((item, index) => {
              const blockId = item.dataset.blockId;
              updates.push({
                id: blockId,
                order: index,
                showWhen: showWhen || "",
              });
            });
          });

          const batch = writeBatch(db);
          updates.forEach((update) => {
            const blockRef = doc(db, "homepageBlocks", update.id);
            batch.update(blockRef, {
              order: update.order,
              showWhen: update.showWhen,
            });
          });

          await batch.commit();
          showAlert("âœ…", "ë¸”ë¡ ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("ë¸”ë¡ ìˆœì„œ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë¸”ë¡ ìˆœì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë¸”ë¡ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ (ì„¹ì…˜ ê°„ ì´ë™ ê°€ëŠ¥)
      function enableBlockDragAndDrop(list) {
        let draggedElement = null;

        list.addEventListener("dragstart", (e) => {
          if (e.target.classList.contains("block-item")) {
            draggedElement = e.target;
            e.target.style.opacity = "0.5";
            e.dataTransfer.effectAllowed = "move";
          }
        });

        list.addEventListener("dragend", (e) => {
          if (e.target.classList.contains("block-item")) {
            e.target.style.opacity = "";
            draggedElement = null;
          }
        });

        list.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        list.addEventListener("drop", (e) => {
          e.preventDefault();
          if (draggedElement) {
            if (e.target.closest(".block-item")) {
              // ê°™ì€ ì„¹ì…˜ ë‚´ì—ì„œ ì´ë™
              const targetElement = e.target.closest(".block-item");
              const rect = targetElement.getBoundingClientRect();
              const next =
                (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
              list.insertBefore(
                draggedElement,
                next ? targetElement.nextSibling : targetElement
              );
            } else {
              // ë‹¤ë¥¸ ì„¹ì…˜ìœ¼ë¡œ ì´ë™
              list.appendChild(draggedElement);
            }
          }
        });
      }

      // ëª¨ë“  ë¸”ë¡ ì„¹ì…˜ì— ë²„íŠ¼ ë°©ì‹ ìˆœì„œ ë³€ê²½ í™œì„±í™”
      function enableAllBlockDragAndDrop() {
        const allSortableLists = document.querySelectorAll(".block-sortable");
        allSortableLists.forEach((list) => {
          enableBlockButtonReorder(list);
        });
      }

      // ë¸”ë¡ ë²„íŠ¼ ë°©ì‹ ìˆœì„œ ë³€ê²½ í™œì„±í™”
      function enableBlockButtonReorder(list) {
        list.addEventListener("click", (e) => {
          const blockItem = e.target.closest(".block-item");
          if (!blockItem) return;

          if (e.target.classList.contains("move-up")) {
            const prev = blockItem.previousElementSibling;
            if (prev && prev.classList.contains("block-item")) {
              list.insertBefore(blockItem, prev);
              updateBlockButtonStates(list);
            }
          } else if (e.target.classList.contains("move-down")) {
            const next = blockItem.nextElementSibling;
            if (next && next.classList.contains("block-item")) {
              list.insertBefore(next, blockItem);
              updateBlockButtonStates(list);
            }
          }
        });

        // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        updateBlockButtonStates(list);
      }

      // ë¸”ë¡ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateBlockButtonStates(list) {
        const items = list.querySelectorAll(".block-item");
        items.forEach((item, index) => {
          const upBtn = item.querySelector(".move-up");
          const downBtn = item.querySelector(".move-down");

          if (upBtn) upBtn.disabled = index === 0;
          if (downBtn) downBtn.disabled = index === items.length - 1;
        });
      }

      // ë¡œë“œë§µ ë¸”ë¡ ìƒì„± ê¸°ëŠ¥ ì œê±°ë¨

      function renderHomeBlocksAdmin(container) {
        // í™ˆ ë ˆì´ì•„ì›ƒ ìˆœì„œ ê´€ë¦¬
        const homeOrderSec = `
        <div class="section">
          <h3 class="text-xl font-bold text-gray-800 mb-2">í™ˆ ì£¼ìš” ë¸”ë¡ ìˆœì„œ (ë¡œê·¸ì¸ ê³ ì •)</h3>
          <p class="text-xs text-gray-600  mb-2">ë¡œê·¸ì¸ ë¸”ë¡ì€ í•­ìƒ ë§¨ ìœ„ì— ê³ ì •ë©ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ìˆœì„œë¥¼ ë³€ê²½í•˜ì„¸ìš”.</p>
          <ul id="home-layout-sortable" class="sortable divide-y rounded border bg-white">
            <li class="flex items-center justify-between px-3 py-2 opacity-60 select-none">
              <div class="flex items-center gap-2"><i class="fas fa-lock text-gray-400"></i><span>ë¡œê·¸ì¸ (ê³ ì •)</span></div>
            </li>
            <li draggable="true" data-key="roadmap" class="flex items-center justify-between px-3 py-2">
              <div class="flex items-center gap-2 min-w-0">
                <i class="fas fa-grip-vertical text-gray-400 grip"></i><span class="truncate">Foodie ì¼ì •</span>
              </div>
            </li>
            <li draggable="true" data-key="dynamic" class="flex items-center justify-between px-3 py-2">
              <div class="flex items-center gap-2 min-w-0">
                <i class="fas fa-grip-vertical text-gray-400 grip"></i><span class="truncate">í™ˆ í™”ë©´ ë¸”ë¡</span>
              </div>
            </li>
          </ul>
          <div class="mt-3">
            <button id="home-layout-save" class="px-3 py-2 bg-gray-800 text-white rounded">ìˆœì„œ ì €ì¥</button>
          </div>
        </div>`;
        container.insertAdjacentHTML("afterbegin", homeOrderSec);

        // ë²„íŠ¼ ë°©ì‹ ìˆœì„œ ë³€ê²½ í™œì„±í™”
        const hlUl = container.querySelector("#home-layout-sortable");

        // ì´ˆê¸°ê°’ ë°˜ì˜
        const cur =
          Array.isArray(homeLayout) && homeLayout.length
            ? homeLayout
            : ["login", "roadmap", "dynamic"];
        const orderNow = cur.filter((k) => k !== "login"); // ë‘ ê°œë§Œ
        if (orderNow[0] === "dynamic") {
          const liRoadmap = hlUl.querySelector("li[data-key='roadmap']");
          const liDynamic = hlUl.querySelector("li[data-key='dynamic']");
          liDynamic && hlUl.insertBefore(liDynamic, liRoadmap);
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        hlUl.addEventListener("click", (e) => {
          const li = e.target.closest("li[data-key]");
          if (!li) return;

          if (e.target.classList.contains("move-up")) {
            const prev = li.previousElementSibling;
            if (prev && prev.dataset.key) {
              hlUl.insertBefore(li, prev);
              updateButtonStates(hlUl);
            }
          } else if (e.target.classList.contains("move-down")) {
            const next = li.nextElementSibling;
            if (next && next.dataset.key) {
              hlUl.insertBefore(next, li);
              updateButtonStates(hlUl);
            }
          }
        });

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateButtonStates(ul) {
          const items = ul.querySelectorAll("li[data-key]");
          items.forEach((item, index) => {
            const upBtn = item.querySelector(".move-up");
            const downBtn = item.querySelector(".move-down");

            if (upBtn) upBtn.disabled = index === 0;
            if (downBtn) downBtn.disabled = index === items.length - 1;
          });
        }

        // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        updateButtonStates(hlUl);

        // ì €ì¥
        container.querySelector("#home-layout-save").onclick = async () => {
          const keys = [...hlUl.querySelectorAll("li[data-key]")].map(
            (li) => li.dataset.key
          );
          try {
            await setDoc(
              doc(db, "settings", "homeLayout"),
              { order: ["login", ...keys] },
              { merge: true }
            );
            showAlert("âœ…", "í™ˆ ë ˆì´ì•„ì›ƒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ì €ì¥ ì‹¤íŒ¨: " + e.message);
          }
        };

        // ìš´ì˜ì§„ì€ ë¸”ë¡ ê´€ë¦¬ íŒ¨ë„ ì ‘ê·¼ ë¶ˆê°€
        if (!isFullAdmin()) {
          container.innerHTML = `
                  <div class="section">
                    <div class="p-8 text-center">
                      <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                      <p class="text-gray-600 mb-2">ë¸”ë¡ ê´€ë¦¬ëŠ” ì„ì›ì§„ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                      <p class="text-sm text-gray-500">í˜„ì¬ ê¶Œí•œ: ${
                        currentUser?.position || "ì¼ë°˜ íšŒì›"
                      }</p>
                    </div>
                  </div>
                `;
          return;
        }

        container.innerHTML = `
                <div class="grid grid-cols-1 gap-4">
                  <!-- ë¸”ë¡ ê´€ë¦¬ -->
                  <div class="section">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ë¸”ë¡ ê´€ë¦¬</h3>
                    <p class="text-xs text-gray-600 mb-2">ê³µì§€, Q&A, ì ìˆ˜íŒ, ë¡œë“œë§µ ë¸”ë¡ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                    <div class="flex flex-col sm:flex-row gap-3 mb-4">
                      <button id="add-new-block" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors btn-text">
                        <i class="fas fa-plus mr-2"></i>ìƒˆ ê³µì§€ ì¶”ê°€
                      </button>
                    </div>

                    <!-- ë¸”ë¡ ì„¹ì…˜ë³„ ê´€ë¦¬ -->
                    <div class="space-y-4">
                      <!-- í•­ìƒ í‘œì‹œ ë¸”ë¡ -->
                      <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                          <i class="fas fa-eye mr-2 text-green-500"></i>í•­ìƒ í‘œì‹œ ë¸”ë¡
                          <span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded">${
                            blocksData.filter(
                              (b) => !b.showWhen || b.showWhen === ""
                            ).length
                          }ê°œ</span>
                        </h4>
                        <ul class="space-y-2 block-sortable" data-show-when="">
                          ${blocksData
                            .filter((b) => !b.showWhen || b.showWhen === "")
                            .sort((a, b) => (a.order || 0) - (b.order || 0))
                            .map((b) => renderBlockListItem(b))
                            .join("")}
                        </ul>
                      </div>

                      <!-- ë¡œê·¸ì¸ì‹œë§Œ í‘œì‹œ ë¸”ë¡ -->
                      <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                          <i class="fas fa-sign-in-alt mr-2 text-blue-500"></i>ë¡œê·¸ì¸ì‹œë§Œ í‘œì‹œ ë¸”ë¡
                          <span class="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${
                            blocksData.filter((b) => b.showWhen === "login")
                              .length
                          }ê°œ</span>
                        </h4>
                        <ul class="space-y-2 block-sortable" data-show-when="login">
                          ${blocksData
                            .filter((b) => b.showWhen === "login")
                            .sort((a, b) => (a.order || 0) - (b.order || 0))
                            .map((b) => renderBlockListItem(b))
                            .join("")}
                        </ul>
                      </div>

                      <!-- ë¡œê·¸ì•„ì›ƒì‹œë§Œ í‘œì‹œ ë¸”ë¡ -->
                      <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                          <i class="fas fa-sign-out-alt mr-2 text-purple-500"></i>ë¡œê·¸ì•„ì›ƒì‹œë§Œ í‘œì‹œ ë¸”ë¡
                          <span class="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">${
                            blocksData.filter((b) => b.showWhen === "logout")
                              .length +
                            (roadmapData && roadmapData.length > 0 ? 1 : 0)
                          }ê°œ</span>
                        </h4>
                        <ul class="space-y-2 block-sortable" data-show-when="logout">
                          ${
                            roadmapData && roadmapData.length > 0
                              ? `
                            <li class="flex items-center justify-between px-3 py-2 bg-orange-50 border border-orange-200 rounded">
                              <div class="flex items-center gap-2 min-w-0">
                                <i class="fas fa-grip-vertical text-gray-400 grip"></i>
                                <i class="fas fa-calendar-alt text-orange-500"></i>
                                <span class="truncate font-medium">Foodie ì¼ì •</span>
                              </div>
                              <div class="flex gap-1">
                                <button class="move-block-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors"
                                        data-block-id="auto-schedule-block" title="ìœ„ë¡œ ì´ë™">
                                  <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="move-block-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors"
                                        data-block-id="auto-schedule-block" title="ì•„ë˜ë¡œ ì´ë™">
                                  <i class="fas fa-arrow-down"></i>
                                </button>
                              </div>
                            </li>
                          `
                              : ""
                          }
                          ${blocksData
                            .filter((b) => b.showWhen === "logout")
                            .sort((a, b) => (a.order || 0) - (b.order || 0))
                            .map((b) => renderBlockListItem(b))
                            .join("")}
                        </ul>
                      </div>
                    </div>

                    <div class="mt-4 flex flex-col sm:flex-row gap-2">
                      <button id="save-block-order" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors btn-text">
                        <i class="fas fa-save mr-2"></i>ë¸”ë¡ ìˆœì„œ ì €ì¥
                      </button>
                    </div>
                  </div>

                  <!-- ë¡œë“œë§µ ê´€ë¦¬ - ë¸”ë¡ ê´€ë¦¬ ì‹œìŠ¤í…œìœ¼ë¡œ í†µí•©ë¨ -->
                  <div class="section">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Foodie ì¼ì • ê´€ë¦¬</h3>
                    <p class="text-xs text-gray-600 mb-2">
                      ì´ì œ ë¸”ë¡ ê´€ë¦¬ ì‹œìŠ¤í…œì—ì„œ ë¡œë“œë§µì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
                      <a href="#blocks" class="text-blue-600 hover:underline">ë¸”ë¡ ê´€ë¦¬</a> íƒ­ì—ì„œ ë¡œë“œë§µ ë¸”ë¡ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.
                    </p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                        <div>
                          <h4 class="font-medium text-blue-800">ë¡œë“œë§µì´ ë¸”ë¡ ê´€ë¦¬ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤</h4>
                          <p class="text-sm text-blue-600 mt-1">
                            ë¡œë“œë§µ í•­ëª©ë“¤ì„ ê°œë³„ ë¸”ë¡ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            ë¸”ë¡ ê´€ë¦¬ íƒ­ì—ì„œ "ë¡œë“œë§µ" íƒ€ì…ì˜ ë¸”ë¡ì„ ìƒì„±í•˜ê³  ìˆœì„œë¥¼ ì¡°ì •í•˜ì„¸ìš”.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>`;

        // ë¸”ë¡ ìˆœì„œ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        const saveOrderBtn = container.querySelector("#save-block-order");
        if (saveOrderBtn) {
          saveOrderBtn.addEventListener("click", async () => {
            await saveBlockOrder();
          });
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í™œì„±í™”
        setTimeout(() => {
          enableAllBlockDragAndDrop();
        }, 100);

        // ìƒˆë¡œìš´ í†µí•© ë¸”ë¡ ê´€ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        container.addEventListener("click", async (e) => {
          // ìƒˆ ë¸”ë¡ ìƒì„± ë²„íŠ¼
          if (
            e.target.closest("#add-new-block") ||
            e.target.closest(".add-block-placeholder")
          ) {
            openBlockModal();
            return;
          }

          // ë¡œë“œë§µ ë¸”ë¡ ìƒì„± ê¸°ëŠ¥ ì œê±°ë¨

          // ë¸”ë¡ ìˆ˜ì • ë²„íŠ¼
          if (e.target.closest(".edit-block-btn")) {
            const btn = e.target.closest(".edit-block-btn");
            const blockId = btn.dataset.id;
            const blockType = btn.dataset.type;
            openBlockModal(blockType, blockId);
            return;
          }

          // ë¸”ë¡ ì‚­ì œ ë²„íŠ¼
          if (e.target.closest(".delete-block-btn")) {
            const btn = e.target.closest(".delete-block-btn");
            const blockId = btn.dataset.id;
            if (!confirm("ë¸”ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

            try {
              await deleteDoc(doc(db, "homepageBlocks", blockId));
              showAlert("âœ…", "ë¸”ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
              renderHomeBlocksAdmin(container);
            } catch (error) {
              showAlert("ğŸ˜¥", "ë¸”ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
            return;
          }
        });

        // ë¡œë“œë§µ ê´€ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const rmUl = container.querySelector("#roadmap-sortable");
        if (rmUl) {
          enableSimpleDnd(rmUl);
        }

        // ë¡œë“œë§µ ê´€ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const rmAddBtn = container.querySelector("#rm-add");
        if (rmAddBtn) {
          rmAddBtn.addEventListener("click", async () => {
            const name = container.querySelector("#rm-name")?.value.trim();
            const date = container.querySelector("#rm-date")?.value;
            if (!name || !date) {
              showAlert("ğŸ˜¥", "í™œë™ ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
              return;
            }
            try {
              await addDoc(collection(db, "roadmap"), {
                activityName: name,
                activityDate: date,
                order: roadmapData?.length || 0,
              });
              showAlert("âœ…", "ë¡œë“œë§µ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              container.querySelector("#rm-name").value = "";
              container.querySelector("#rm-date").value = "";
            } catch (err) {
              showAlert("ğŸ˜¥", "ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          });
        }

        const rmSaveBtn = container.querySelector("#save-roadmap-order");
        if (rmSaveBtn) {
          rmSaveBtn.addEventListener("click", async () => {
            const lis = [
              ...container.querySelectorAll("#roadmap-sortable li[data-id]"),
            ];
            if (!lis.length) return showAlert("â„¹ï¸", "ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

            try {
              const batch = writeBatch(db);
              lis.forEach((li, idx) => {
                const id = li.dataset.id;
                batch.set(
                  doc(db, "roadmap", id),
                  { order: idx },
                  { merge: true }
                );
              });
              await batch.commit();
              showAlert("âœ…", "ë¡œë“œë§µ ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
              showAlert("ğŸ˜¥", "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          });
        }

        if (rmUl) {
          rmUl.addEventListener("click", async (e) => {
            const li = e.target.closest("li[data-id]");
            if (!li) return;
            const id = li.dataset.id;

            if (e.target.closest(".rm-edit")) {
              const name = prompt(
                "í™œë™ ì´ë¦„:",
                li.querySelector("b").textContent
              );
              const date = prompt(
                "ë‚ ì§œ (YYYY-MM-DD):",
                li.querySelector(".text-sm").textContent
              );
              if (name && date) {
                try {
                  await updateDoc(doc(db, "roadmap", id), {
                    activityName: name,
                    activityDate: date,
                  });
                  showAlert("âœ…", "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (err) {
                  showAlert("ğŸ˜¥", "ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
              }
              return;
            }
            if (e.target.closest(".rm-delete")) {
              if (!confirm("í•´ë‹¹ ë¡œë“œë§µ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?")) return;
              await deleteDoc(doc(db, "roadmap", id));
              showAlert("ğŸ—‘ï¸", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          });
        }
      }

      function renderRoadmapAdminList() {
        if (!roadmapData?.length)
          return `<li class="px-3 py-2 text-gray-400">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
        const sorted = [...roadmapData].sort((a, b) => {
          const ao = a.order ?? 999999,
            bo = b.order ?? 999999;
          if (ao !== bo) return ao - bo;
          return (a.activityDate || "").localeCompare(b.activityDate || "");
        });
        return sorted
          .map(
            (r) => `<li draggable="true" data-id="${
              r.id
            }" class="flex items-center justify-between px-3 py-2">
                  <div class="flex items-center gap-2 min-w-0">
                    <i class="fas fa-grip-vertical text-gray-400"></i>
                    <span class="truncate"><b>${saf(
                      r.activityName || ""
                    )}</b> <span class="text-sm text-gray-500 ml-1">${saf(
              r.activityDate || "-"
            )}</span></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button class="rm-edit text-blue-600" title="ìˆ˜ì •"><i class="fas fa-pen"></i></button>
                    <button class="rm-delete text-red-600" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
                  </div>
                </li>`
          )
          .join("");
      }

      function addQAItem(host, q = "", a = "") {
        host.insertAdjacentHTML(
          "beforeend",
          `<div class="qa-row grid grid-cols-1 md:grid-cols-5 gap-2">
                  <input data-q class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 md:col-span-2" placeholder="ì§ˆë¬¸" value="${saf(
                    q
                  )}">
                  <input data-a class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 md:col-span-3" placeholder="ë‹µë³€" value="${saf(
                    a
                  )}">
                  <button type="button" class="remove-qa text-red-600 text-sm"><i class="fas fa-trash"></i></button>
                </div>`
        );
      }

      function addScoreRow(host, name = "", score = 0) {
        host.insertAdjacentHTML(
          "beforeend",
          `<div class="score-row grid grid-cols-12 gap-2">
                  <input data-name class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-7" placeholder="ì¡° ì´ë¦„" value="${saf(
                    name
                  )}">
                  <input data-score type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-4" placeholder="ì ìˆ˜" value="${saf(
                    score
                  )}">
                  <button type="button" class="remove-score-row text-red-600 col-span-1"><i class="fas fa-trash"></i></button>
                </div>`
        );
      }

      function enableSimpleDnd(ul) {
        let dragging = null;
        ul.addEventListener("dragstart", (e) => {
          dragging = e.target.closest("li");
          if (dragging) dragging.classList.add("dragging");
        });
        ul.addEventListener("dragend", () => {
          if (dragging) dragging.classList.remove("dragging");
          dragging = null;
        });
        ul.addEventListener("dragover", (e) => {
          e.preventDefault();
          const after = [...ul.querySelectorAll("li:not(.dragging)")].find(
            (li) => {
              const rect = li.getBoundingClientRect();
              return e.clientY <= rect.top + rect.height / 2;
            }
          );
          if (!dragging) return;
          if (after) ul.insertBefore(dragging, after);
          else ul.appendChild(dragging);
        });
      }

      /* ===== íšŒì› ê´€ë¦¬ íƒ­ (ìš”ì²­ì‚¬í•­ 2, 7: ë²„íŠ¼ ë‹¨ìˆœí™”/ê·¸ë£¹ ë¶„ë¦¬) ===== */
      // index.htmlì˜ renderMembersAdmin í•¨ìˆ˜ëŠ” ì œê±°ë¨ - js/dashboard.jsì˜ í•¨ìˆ˜ ì‚¬ìš©
      // ì‹¤ì œ renderMembersAdminì€ js/dashboard.jsì—ì„œ importí•˜ì—¬ ì‚¬ìš©
      async function renderMembersAdmin(container) {
        const { renderMembersAdmin: renderMembersAdminFromJS } = await import(
          "./js/dashboard.js"
        );
        return renderMembersAdminFromJS(container);
      }

      // ê¸°ì¡´ í•¨ìˆ˜ì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„ì€ ì œê±°ë¨ (js/dashboard.jsë¡œ ì´ë™)
      // ì•„ë˜ëŠ” í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ë˜ëŠ” í—¬í¼ í•¨ìˆ˜ë“¤
      function membersRowsHTMLGrouped(list, isPendingGroup, keyword) {
        const kw = (keyword || "").toLowerCase();
        const filtered = (list || []).filter((m) => {
          const s = [m.name, m.studentId, m.department, m.college, m.phone].map(
            (x) => String(x || "").toLowerCase()
          );
          return kw ? s.some((v) => v.includes(kw)) : true;
        });
        if (filtered.length === 0)
          return `<tr><td colspan="${
            isPendingGroup ? 9 : 8
          }" class="px-3 py-4 text-center text-gray-400">í•´ë‹¹ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

        const mapStatus = (s) =>
          ({
            active: "í™œë™ì¤‘",
            pending: "ìŠ¹ì¸ëŒ€ê¸°",
            rejected: "ê±°ì ˆ",
            blocked: "ì°¨ë‹¨",
          }[s] ||
          s ||
          "-");

        return filtered
          .map((m) => {
            // ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
            const isAdmin = adminList.includes(m.studentId);
            const adminBtn = isAdmin
              ? `<span class="text-xs text-purple-600 font-semibold"><i class="fas fa-crown mr-1"></i>ê´€ë¦¬ì</span>`
              : `<button class="text-purple-700 hover:text-purple-900 text-xs" data-act="make-admin" data-id="${m.studentId}"><i class="fas fa-user-shield mr-1"></i>ê´€ë¦¬ì ì¶”ê°€</button>`;

            const actionBtns = isPendingGroup
              ? `<button class="text-emerald-700 hover:text-emerald-900 text-xs" data-act="approve" data-id="${m.studentId}"><i class="fas fa-check mr-1"></i>ìŠ¹ì¸</button>
                     <button class="text-amber-700 hover:text-amber-900 text-xs" data-act="reject" data-id="${m.studentId}"><i class="fas fa-xmark mr-1"></i>ê±°ì ˆ</button>
                                 <button class="text-green-700 hover:text-green-900 text-xs" data-act="retention" data-id="${m.studentId}"><i class="fas fa-user-plus mr-1"></i>ì”ë¥˜</button>
                     <button class="text-blue-700 hover:text-blue-900 text-xs" data-act="edit" data-id="${m.studentId}"><i class="fas fa-pen mr-1"></i>ìˆ˜ì •</button>
                     <button class="text-red-700 hover:text-red-900 text-xs" data-act="delete" data-id="${m.studentId}"><i class="fas fa-trash mr-1"></i>ì‚­ì œ</button>
                     ${adminBtn}`
              : `<button class="text-green-700 hover:text-green-900 text-xs" data-act="retention" data-id="${m.studentId}"><i class="fas fa-user-plus mr-1"></i>ì”ë¥˜</button>
                     <button class="text-blue-700 hover:text-blue-900 text-xs" data-act="edit" data-id="${m.studentId}"><i class="fas fa-pen mr-1"></i>ìˆ˜ì •</button>
                     <button class="text-red-700 hover:text-red-900 text-xs" data-act="delete" data-id="${m.studentId}"><i class="fas fa-trash mr-1"></i>ì‚­ì œ</button>
                     ${adminBtn}`;

            return `<tr class="border-t">
                        <td class="px-3 py-2 whitespace-nowrap">${saf(
                          m.name || ""
                        )}</td>
                  <td class="px-3 py-2 font-mono whitespace-nowrap">${saf(
                    m.studentId || ""
                  )}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${saf(
                          m.gender || ""
                        )}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${saf(
                          m.year || ""
                        )}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${saf(
                          m.college || ""
                        )}</td>
                  <td class="px-3 py-2 whitespace-nowrap">${saf(
                    m.department || ""
                  )}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${saf(
                          m.phone || ""
                        )}</td>
                  ${
                    isPendingGroup
                      ? `<td class="px-3 py-2">${mapStatus(m.status)}</td>`
                      : ""
                  }
                  <td class="px-3 py-2 space-x-2 whitespace-nowrap">${actionBtns}</td>
                </tr>`;
          })
          .join("");
      }
      function onMembersTableClick(e) {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const act = btn.dataset.act;
        const sid = btn.dataset.id;
        if (act === "approve") return approveMember(sid);
        if (act === "reject") return updateMemberStatus(sid, "rejected");
        if (act === "retention") return applyRetention(sid);
        if (act === "delete") return deleteMember(sid);
        if (act === "edit") return openMemberEditModal(sid);
        if (act === "make-admin") return makeAdminFromMember(sid);
      }
      async function approveMember(sid) {
        try {
          await updateDoc(doc(db, "members", sid), { status: "active" });
          showAlert("âœ…", "ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      }

      // ì”ë¥˜ ì‹ ì²­ í•¨ìˆ˜
      async function applyRetention(sid) {
        try {
          const member = membersData.find((m) => m.studentId === sid);
          if (!member) {
            showAlert("ğŸ˜¥", "íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          if (
            !confirm(
              `${member.name}ë‹˜ì„ ë‹¤ìŒ í•™ê¸° ì”ë¥˜ ì‹ ì²­ìë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì”ë¥˜ ì‹ ì²­ìëŠ” ìŠ¹ì¸ í•„ìš” ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.`
            )
          ) {
            return;
          }

          await updateDoc(doc(db, "members", sid), {
            status: "pending",
            retentionApplied: true,
            retentionAppliedAt: serverTimestamp(),
          });
          showAlert(
            "âœ…",
            "ì”ë¥˜ ì‹ ì²­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í•™ê¸° ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
          );
        } catch (error) {
          console.error("ì”ë¥˜ ì‹ ì²­ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì”ë¥˜ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }
      async function updateMemberStatus(sid, status) {
        try {
          await updateDoc(doc(db, "members", sid), { status });
          showAlert("âœ…", "ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      }
      async function deleteMember(sid) {
        // íšŒì› ì •ë³´ í™•ì¸
        const member = membersData.find((m) => m.studentId === sid);
        if (!member) {
          showAlert("ğŸ˜¥", "íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // íšŒì¥ë‹¨ ì—¬ë¶€ í™•ì¸
        const isAdmin = adminList.includes(sid);
        if (isAdmin) {
          showAlert(
            "âš ï¸",
            "íšŒì¥ë‹¨ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € íšŒì¥ë‹¨ ì§ì±…ì„ í•´ì œí•´ì•¼ í•©ë‹ˆë‹¤."
          );
          return;
        }

        // ì”ë¥˜ ì‹ ì²­ì ì—¬ë¶€ í™•ì¸
        if (member.retentionApplied === true) {
          showAlert(
            "âš ï¸",
            "ì”ë¥˜ ì‹ ì²­ìëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ìŒ í•™ê¸° ìŠ¹ì¸ í›„ì— ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
          );
          return;
        }

        if (!confirm(`${member.name}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
          await deleteDoc(doc(db, "members", sid));
          showAlert("ğŸ—‘ï¸", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ì‚­ì œ ì‹¤íŒ¨");
        }
      }

      async function makeAdminFromMember(sid) {
        // íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const member = membersData.find((m) => m.studentId === sid);
        if (!member) {
          showAlert("ğŸ˜¥", "íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ì´ë¯¸ ê´€ë¦¬ìì¸ ê²½ìš°
        if (adminList.includes(sid)) {
          showAlert("â„¹ï¸", "ì´ë¯¸ ê´€ë¦¬ìì…ë‹ˆë‹¤.");
          return;
        }

        // ì§ì±… ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (íšŒì¥ë‹¨ + ì¼ë°˜ ì„ì›)
        const allPositions = [...presidentPositions, ...regularPositions];

        // ì§ì±… ì„ íƒ ëª¨ë‹¬ ìƒì„±
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">
                      <i class="fas fa-user-shield mr-2 text-purple-600"></i>ê´€ë¦¬ìë¡œ ì¶”ê°€
                    </h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>

                  <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">
                      <strong>${
                        member.name
                      }</strong> (${sid}) ë‹˜ì„ ê´€ë¦¬ìë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
                    </p>
                  </div>

                  <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì§ì±… ì„ íƒ</label>
                    <select id="admin-position-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                      <option value="">ì§ì±…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                      <optgroup label="íšŒì¥ë‹¨">
                        ${presidentPositions
                          .map(
                            (pos) => `<option value="${pos}">${pos}</option>`
                          )
                          .join("")}
                      </optgroup>
                      <optgroup label="ì¼ë°˜ ì„ì›">
                        ${regularPositions
                          .map(
                            (pos) => `<option value="${pos}">${pos}</option>`
                          )
                          .join("")}
                      </optgroup>
                    </select>
                  </div>

                  <div class="flex gap-2 justify-end">
                    <button
                      onclick="this.closest('.fixed').remove()"
                      class="px-4 py-2 text-gray-600 hover:text-gray-800"
                    >
                      ì·¨ì†Œ
                    </button>
                    <button
                      id="confirm-make-admin"
                      class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
                    >
                      <i class="fas fa-user-shield mr-2"></i>ê´€ë¦¬ì ì¶”ê°€
                    </button>
                  </div>
                </div>
              `;

        document.body.appendChild(modal);

        // í™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
        modal
          .querySelector("#confirm-make-admin")
          .addEventListener("click", async () => {
            const position = modal.querySelector(
              "#admin-position-select"
            ).value;

            if (!position) {
              showAlert("ğŸ˜¥", "ì§ì±…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              // ê´€ë¦¬ì ëª©ë¡ì— ì¶”ê°€
              const newAdminList = [...adminList, sid];
              const newAdminPositions = { ...adminPositions, [sid]: position };

              await setDoc(doc(db, "admins", "list"), {
                studentIds: newAdminList,
                positions: newAdminPositions,
              });

              showAlert(
                "âœ…",
                `${member.name} ë‹˜ì´ ${position} ê´€ë¦¬ìë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`
              );
              modal.remove();

              // íšŒì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              const subtabContainer =
                document.getElementById("subtab-container");
              if (subtabContainer) {
                import("./js/dashboard.js").then(({ renderMembersAdmin }) => {
                  renderMembersAdmin(subtabContainer);
                });
              }
            } catch (error) {
              console.error("ê´€ë¦¬ì ì¶”ê°€ ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ê´€ë¦¬ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });
      }
      function openMemberEditModal(sid) {
        const m = membersData.find((x) => (x.studentId || x.id) === sid) || {};
        el.blockEditorTitle.textContent = `íšŒì› ì •ë³´ ìˆ˜ì • â€” ${saf(
          m.name || ""
        )}`;
        el.blockEditorBody.innerHTML = `<div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                    <input id="mem-name" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value="${saf(
                      m.name || ""
                    )}">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">í•™ë²ˆ</label>
                    <input id="mem-id" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 bg-gray-50" disabled placeholder="í•™ë²ˆ" value="${saf(
                      m.studentId || ""
                    )}">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„±ë³„</label>
                    <select id="mem-gender" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                    <option value="ë‚¨" ${
                      m.gender === "ë‚¨" ? "selected" : ""
                    }>ë‚¨</option>
                    <option value="ì—¬" ${
                      m.gender === "ì—¬" ? "selected" : ""
                    }>ì—¬</option>
                    <option value="ê¸°íƒ€" ${
                      m.gender === "ê¸°íƒ€" ? "selected" : ""
                    }>ê¸°íƒ€</option>
                  </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">í•™ë…„</label>
                    <select id="mem-year" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                    <option value="1í•™ë…„" ${
                      m.year === "1í•™ë…„" ? "selected" : ""
                    }>1í•™ë…„</option>
                    <option value="2í•™ë…„" ${
                      m.year === "2í•™ë…„" ? "selected" : ""
                    }>2í•™ë…„</option>
                    <option value="3í•™ë…„" ${
                      m.year === "3í•™ë…„" ? "selected" : ""
                    }>3í•™ë…„</option>
                    <option value="4í•™ë…„" ${
                      m.year === "4í•™ë…„" ? "selected" : ""
                    }>4í•™ë…„</option>
                    <option value="ê¸°íƒ€" ${
                      m.year === "ê¸°íƒ€" ? "selected" : ""
                    }>ê¸°íƒ€</option>
                  </select>
                  <input id="mem-college" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="ë‹¨ê³¼ëŒ€" value="${saf(
                    m.college || ""
                  )}">
                  <input id="mem-dept" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="í•™ê³¼" value="${saf(
                    m.department || ""
                  )}">
                  <input id="mem-phone" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="ì „í™”ë²ˆí˜¸" value="${saf(
                    m.phone || ""
                  )}">
                  <select id="mem-status" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                    <option value="active" ${
                      m.status === "active" ? "selected" : ""
                    }>í™œë™ì¤‘</option>
                    <option value="pending" ${
                      m.status === "pending" ? "selected" : ""
                    }>ìŠ¹ì¸ëŒ€ê¸°</option>
                    <option value="rejected" ${
                      m.status === "rejected" ? "selected" : ""
                    }>ê±°ì ˆ</option>
                    <option value="blocked" ${
                      m.status === "blocked" ? "selected" : ""
                    }>ì°¨ë‹¨</option>
                  </select>
                </div>`;
        el.blockEditor.classList.remove("hidden");
        el.blockEditorSave.onclick = async () => {
          try {
            await updateDoc(doc(db, "members", sid), {
              name: document.getElementById("mem-name").value.trim(),
              gender: document.getElementById("mem-gender").value,
              year: document.getElementById("mem-year").value,
              college: document.getElementById("mem-college").value.trim(),
              department: document.getElementById("mem-dept").value.trim(),
              phone: document.getElementById("mem-phone").value.trim(),
              status: document.getElementById("mem-status").value,
            });
            el.blockEditor.classList.add("hidden");
            showAlert("âœ…", "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch {
            showAlert("ğŸ˜¥", "ìˆ˜ì • ì‹¤íŒ¨");
          }
        };
        el.blockEditorCancel.onclick = () =>
          el.blockEditor.classList.add("hidden");
      }
      function exportMembersCSV() {
        const mapStatus = (s) =>
          ({
            active: "í™œë™ì¤‘",
            pending: "ìŠ¹ì¸ëŒ€ê¸°",
            rejected: "ê±°ì ˆ",
            blocked: "ì°¨ë‹¨",
          }[s] ||
          s ||
          "-");
        const rows = (membersData || []).map((m) => [
          m.name || "",
          m.studentId || "",
          m.gender || "",
          m.year || "",
          m.college || "",
          m.department || "",
          m.phone || "",
          mapStatus(m.status),
        ]);
        const header = [
          "ì´ë¦„",
          "í•™ë²ˆ",
          "ì„±ë³„",
          "í•™ë…„",
          "ë‹¨ê³¼ëŒ€",
          "í•™ê³¼",
          "ì „í™”ë²ˆí˜¸",
          "ìƒíƒœ",
        ];
        const escape = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
        const lines = [
          header.map(escape).join(","),
          ...rows.map((r) => r.map(escape).join(",")),
        ].join("\r\n");
        const bom = "\uFEFF";
        const blob = new Blob([bom + lines], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `members_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      async function bulkApproveMembers() {
        // ëŒ€ê¸° ì¤‘ì¸ íšŒì›ë“¤ í•„í„°ë§
        const pendingMembers = (membersData || []).filter(
          (m) => (m.status || "pending") === "pending"
        );

        if (pendingMembers.length === 0) {
          showAlert("â„¹ï¸", "ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const confirmMessage = `ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íšŒì› ${
          pendingMembers.length
        }ëª…ì„ ëª¨ë‘ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìŠ¹ì¸ë  íšŒì›:\n${pendingMembers
          .map((m) => `â€¢ ${m.name} (${m.studentId})`)
          .join("\n")}`;

        if (!confirm(confirmMessage)) return;

        try {
          const batch = writeBatch(db);

          // ëª¨ë“  ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì„ activeë¡œ ë³€ê²½
          pendingMembers.forEach((member) => {
            const memberRef = doc(db, "members", member.id || member.studentId);
            batch.update(memberRef, {
              status: "active",
              lastUpdated: new Date().toISOString(),
            });
          });

          await batch.commit();
          showAlert(
            "âœ…",
            `${pendingMembers.length}ëª…ì˜ íšŒì›ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );

          // íšŒì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            const subtabContainer = document.getElementById("subtab-container");
            if (subtabContainer) {
              import("./js/dashboard.js").then(({ renderMembersAdmin }) => {
                renderMembersAdmin(subtabContainer);
              });
            }
          }, 1000);
        } catch (error) {
          console.error("ì¼ê´„ ìŠ¹ì¸ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì¼ê´„ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function deleteAllMembers() {
        // 1ë‹¨ê³„: ì²« ë²ˆì§¸ ê²½ê³ 
        if (
          !confirm(
            "âš ï¸ ê²½ê³ : íšŒì› ì „ì²´ ì‚­ì œë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ëª¨ë“  íšŒì› ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.\n\nâš ï¸ íšŒì¥ë‹¨ê³¼ ì”ë¥˜ ì‹ ì²­ìëŠ” ì‚­ì œì—ì„œ ì œì™¸ë©ë‹ˆë‹¤."
          )
        ) {
          return;
        }

        // 2ë‹¨ê³„: í…ìŠ¤íŠ¸ ì…ë ¥ í™•ì¸
        const confirmText = prompt(
          "âš ï¸ ìµœì¢… í™•ì¸\n\n" +
            "íšŒì›ì„ ì „ì²´ ì‚­ì œí•˜ë ¤ë©´ ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”:\n" +
            '"íšŒì›ì„ ì „ì²´ ì‚­ì œí•©ë‹ˆë‹¤."\n\n' +
            "ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
        );
        if (confirmText !== "íšŒì›ì„ ì „ì²´ ì‚­ì œí•©ë‹ˆë‹¤.") {
          showAlert(
            "âŒ",
            "ì…ë ¥í•œ í…ìŠ¤íŠ¸ê°€ ì •í™•í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
          );
          return;
        }

        // 3ë‹¨ê³„: ìµœì¢… í™•ì¸
        if (
          !confirm(
            "ğŸš¨ ìµœì¢… í™•ì¸\n\nëª¨ë“  íšŒì› ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ íšŒì¥ë‹¨ê³¼ ì”ë¥˜ ì‹ ì²­ìëŠ” ë³´í˜¸ë©ë‹ˆë‹¤.\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          )
        ) {
          return;
        }

        try {
          const snap = await getDocs(collection(db, "members"));
          const batch = writeBatch(db);
          let deletedCount = 0;
          let protectedCount = 0;

          snap.forEach((doc) => {
            const data = doc.data();
            const isAdmin = adminList.includes(data.studentId);
            const isRetentionApplied = data.retentionApplied === true;

            if (isAdmin || isRetentionApplied) {
              protectedCount++;
            } else {
              batch.delete(doc.ref);
              deletedCount++;
            }
          });

          await batch.commit();
          showAlert(
            "ğŸ—‘ï¸",
            `ì „ì²´ ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì‚­ì œëœ íšŒì›: ${deletedCount}ëª…\në³´í˜¸ëœ íšŒì›: ${protectedCount}ëª… (íšŒì¥ë‹¨ + ì”ë¥˜ ì‹ ì²­ì)`
          );
        } catch {
          showAlert("ğŸ˜¥", "ì „ì²´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /* ===== ëª…ì˜ˆì˜ ì „ë‹¹(ë³´ê´€) ì‚¬ìš©ì íƒ­ ===== */
      function renderHistoryTab(isAdmin) {
        const c = document.getElementById("history-tab");
        if (!c) return;

        // ì°¸ê°€í•œ ì´ë²¤íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì‚­ì œë˜ì§€ ì•Šì€ ë§ˆê°/ë³´ê´€ ì´ë²¤íŠ¸ë§Œ)
        const participatedEvents = eventsData.filter((ev) => {
          if (!currentUser) return false;

          // ì‚­ì œëœ ì´ë²¤íŠ¸ëŠ” ì œì™¸
          if (ev.status === "deleted") return false;

          // ì‹ ì²­ì ëª©ë¡ì—ì„œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
          const isApplicant = ev.applicants?.some(
            (a) => a.studentId === currentUser.studentId
          );

          // ë¯¸ì‹íšŒì˜ ê²½ìš° ê° ì‹ë‹¹ë³„ ì˜ˆì•½ì í™•ì¸
          let isRestaurantApplicant = false;
          if (ev.type === "tasting" && ev.restaurants) {
            isRestaurantApplicant = ev.restaurants.some((r) =>
              r.reservations?.some(
                (res) => res.studentId === currentUser.studentId
              )
            );
          }

          const isParticipant = isApplicant || isRestaurantApplicant;

          // ë§ˆê°ëœ ì´ë²¤íŠ¸, ë³´ê´€ëœ ì´ë²¤íŠ¸, ì™„ë£Œëœ ì´ë²¤íŠ¸, ë˜ëŠ” ì´ë¯¸ ì§€ë‚œ ì´ë²¤íŠ¸
          const isClosed =
            ev.status === "closed" ||
            ev.status === "archived" ||
            ev.status === "completed";
          const eventDate = new Date(ev.datetime);
          const today = new Date();
          const isPastEvent = eventDate < today;

          return isParticipant && (isClosed || isPastEvent);
        });

        if (participatedEvents.length === 0) {
          c.innerHTML = `<div class="section text-center py-12">
                  <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-orange-100 mb-4">
                    <i class="fas fa-calendar-check text-4xl text-orange-400"></i>
                  </div>
                  <h3 class="text-xl font-bold text-gray-800 mb-2">ì•„ì§ ì°¸ê°€í•œ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                  <p class="text-gray-500 mb-4">ì´ë²¤íŠ¸ì— ì°¸ê°€í•˜ê³  ì¦ê±°ìš´ ê²½í—˜ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
                </div>`;
          return;
        }

        // ê´€ë¦¬ì ë° ìš´ì˜ì§„ ì—¬ë¶€ í™•ì¸
        const isUserAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // í•™ë²ˆ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
        const maskStudentId = (studentId) => {
          if (!studentId) return "";
          if (studentId.length <= 4) return studentId;
          return studentId.substring(0, 4) + "****";
        };

        const eventCards = participatedEvents
          .map((ev) => {
            const eventDate = new Date(ev.datetime).toLocaleDateString("ko-KR");
            const hasReview = ev.reviews?.find(
              (r) => r.studentId === currentUser.studentId
            );

            // ì´ë²¤íŠ¸ ìƒíƒœ í™•ì¸
            const isClosed = ev.status === "closed" || ev.status === "archived";
            const eventDateTime = new Date(ev.datetime);
            const today = new Date();
            const isPastEvent = eventDateTime < today;

            // ë¯¸ì‹íšŒì¸ ê²½ìš° ì‹ ì²­í•œ ì‹ë‹¹ ì´ë¦„ê³¼ ì¸ì›ìˆ˜ ì°¾ê¸°
            let restaurantName = "";
            let restaurantParticipants = 0;
            if (ev.type === "tasting" && ev.restaurants && currentUser) {
              for (const restaurant of ev.restaurants) {
                if (
                  restaurant.reservations?.some(
                    (res) => res.studentId === currentUser.studentId
                  )
                ) {
                  restaurantName = restaurant.name;
                  restaurantParticipants = restaurant.reservations?.length || 0;
                  break;
                }
              }
            }

            // ì‚¬ìš©ìê°€ ì‹ ì²­í•œ ì •ë³´ ì°¾ê¸°
            const userApplicant = ev.applicants?.find(
              (a) => a.studentId === currentUser.studentId
            );
            const userRestaurantReservation = ev.restaurants
              ?.find((r) =>
                r.reservations?.some(
                  (res) => res.studentId === currentUser.studentId
                )
              )
              ?.reservations?.find(
                (res) => res.studentId === currentUser.studentId
              );

            // ì°¸ê°€ ì¸ì› ê³„ì‚° (ë¯¸ì‹íšŒëŠ” ì‹ë‹¹ ì¸ì›, ì¼ë°˜ ì´ë²¤íŠ¸ëŠ” ì „ì²´ ì¸ì›)
            const participantCount =
              ev.type === "tasting" && restaurantName
                ? restaurantParticipants
                : ev.applicants?.length || 0;

            return `<div class="section relative overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300">
                              <!-- ì•„ì½”ë””ì–¸ í—¤ë” (í•­ìƒ í‘œì‹œ) -->
                              <div class="cursor-pointer" onclick="toggleActivityDetails('${
                                ev.id
                              }')">
                                <div class="p-3 md:p-4">
                                  <div class="flex items-start gap-2 md:gap-3">
                                    <!-- ì´ë²¤íŠ¸ ë¡œê³ /ì•„ì´ì½˜ -->
                                    <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 md:w-12 md:h-12 rounded-xl ${typeBadgeClass(
                                      ev.type
                                    )}">
                                      <i class="fas ${
                                        ev.type === "tasting"
                                          ? "fa-utensils"
                                          : ev.type === "mt"
                                          ? "fa-mountain"
                                          : ev.type === "meeting"
                                          ? "fa-users"
                                          : "fa-calendar"
                                      } text-white text-base md:text-lg"></i>
                                    </div>

                                    <!-- ì¤‘ìš” ì •ë³´ -->
                                    <div class="flex-1 min-w-0">
                                      <div class="flex items-start justify-between gap-2 mb-1">
                                        <h3 class="text-base md:text-lg font-bold text-gray-800 truncate">${saf(
                                          ev.title || "(ì œëª© ì—†ìŒ)"
                                        )}</h3>
                                        <span class="flex-shrink-0 inline-flex items-center px-1.5 md:px-2 py-0.5 rounded-full text-xs font-medium ${typeBadgeClass(
                                          ev.type
                                        )}">
                          ${typeLabel(ev.type)}
                        </span>
                                      </div>

                                      <!-- ìƒíƒœ ë° ì¼ì‹œ - ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œ ì •ë ¬ -->
                                      <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 text-xs sm:text-sm text-gray-600">
                                        <div class="flex items-center gap-3">
                                          <div class="flex items-center gap-1 flex-shrink-0">
                                            <i class="fas fa-calendar text-orange-500"></i>
                                            <span class="whitespace-nowrap">${new Date(
                                              ev.datetime
                                            ).toLocaleDateString("ko-KR", {
                                              month: "short",
                                              day: "numeric",
                                            })}</span>
                                          </div>
                                          <div class="flex items-center gap-1 flex-shrink-0">
                                            <i class="fas fa-clock text-blue-500"></i>
                                            <span class="whitespace-nowrap">${new Date(
                                              ev.datetime
                                            ).toLocaleTimeString("ko-KR", {
                                              hour: "2-digit",
                                              minute: "2-digit",
                                            })}</span>
                                          </div>
                                        </div>
                                        <div class="flex items-center gap-1 flex-wrap">
                        ${
                          ev.status === "completed"
                            ? '<span class="bg-purple-100 text-purple-800 px-1.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-flag-checkered mr-1"></i>ì¢…ë£Œë¨</span>'
                            : isClosed
                            ? '<span class="bg-green-100 text-green-800 px-1.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-check-circle mr-1"></i>í™•ì •</span>'
                            : ""
                        }
                        ${
                          ev.activityStatus === "confirmed"
                            ? '<span class="bg-emerald-100 text-emerald-800 px-1.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-thumbs-up mr-1"></i>ì™„ë£Œ</span>'
                            : ""
                        }
                        ${
                          ev.activityStatus === "cancelled"
                            ? '<span class="bg-red-100 text-red-800 px-1.5 py-0.5 rounded-full text-xs font-medium whitespace-nowrap"><i class="fas fa-ban mr-1"></i>ì·¨ì†Œ</span>'
                            : ""
                        }
                      </div>
                    </div>
                  </div>

                                    <!-- í¼ì¹˜ê¸°/ì ‘ê¸° ì•„ì´ì½˜ -->
                                    <div class="flex-shrink-0 flex items-center justify-center w-7 h-7 md:w-8 md:h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                                      <i class="fas fa-chevron-down text-gray-600 transition-transform duration-200 text-sm" id="chevron-${
                                        ev.id
                                      }"></i>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <!-- ì•„ì½”ë””ì–¸ ë‚´ìš© (ì ‘í˜€ìˆìŒ) -->
                              <div class="hidden" id="details-${ev.id}">
                                <div class="px-4 pb-4 border-t border-gray-200 pt-4">

                  <!-- ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ - PCì—ì„œ ë” ë‚˜ì€ ë ˆì´ì•„ì›ƒ -->
                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center gap-2 text-sm">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-orange-100">
                        <i class="fas fa-calendar text-orange-600"></i>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">ì´ë²¤íŠ¸ ì¼ì‹œ</p>
                        <p class="font-semibold text-gray-800">${new Date(
                          ev.datetime
                        ).toLocaleString("ko-KR", {
                          year: "numeric",
                          month: "long",
                          day: "numeric",
                          hour: "2-digit",
                          minute: "2-digit",
                        })}</p>
                      </div>
                    </div>

                    <div class="flex items-center gap-2 text-sm">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100">
                        <i class="fas fa-users text-blue-600"></i>
                      </div>
                      <div>
                        <p class="text-xs text-gray-500">${
                          ev.type === "tasting" && restaurantName
                            ? "ì‹ ì²­ ì‹ë‹¹ ì¸ì›"
                            : "ì°¸ê°€ ì¸ì›"
                        }</p>
                        <p class="font-semibold text-gray-800">${participantCount}ëª…</p>
                      </div>
                    </div>
                  </div>

                  <!-- ë‚´ ì‹ ì²­ ì •ë³´ (ê°•ì¡°) -->
                  ${
                    userApplicant || restaurantName
                      ? `
                  <div class="bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl p-4 mb-4">
                    <div class="flex items-center gap-2 mb-3">
                      <i class="fas fa-user-check text-orange-600"></i>
                      <h4 class="font-bold text-gray-800">ë‚´ ì‹ ì²­ ì •ë³´</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                      ${
                        restaurantName
                          ? `
                      <div class="flex items-center gap-2">
                        <i class="fas fa-utensils text-orange-500 w-4"></i>
                        <span class="text-gray-600">ì‹ ì²­ ì‹ë‹¹:</span>
                        <span class="font-bold text-orange-700">${saf(
                          restaurantName
                        )}</span>
                      </div>
                      `
                          : ""
                      }
                      ${
                        userApplicant
                          ? `
                      <div class="flex items-center gap-2">
                        <i class="fas fa-clock text-orange-500 w-4"></i>
                        <span class="text-gray-600">ì‹ ì²­ì¼:</span>
                        <span class="font-semibold text-gray-700">${new Date(
                          userApplicant.timestamp
                        ).toLocaleDateString("ko-KR")}</span>
                      </div>
                      `
                          : ""
                      }
                      ${
                        userRestaurantReservation
                          ? `
                      <div class="flex items-center gap-2">
                        <i class="fas fa-clock text-orange-500 w-4"></i>
                        <span class="text-gray-600">ì‹ ì²­ì¼:</span>
                        <span class="font-semibold text-gray-700">${new Date(
                          userRestaurantReservation.timestamp
                        ).toLocaleDateString("ko-KR")}</span>
                      </div>
                      `
                          : ""
                      }
                    </div>
                  </div>
                  `
                      : ""
                  }

                  <!-- ì‹ ì²­ì ëª©ë¡ -->
                  <div class="mt-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-3">
                      <i class="fas fa-list-ul text-gray-600"></i>
                      <h4 class="font-bold text-gray-800">ì‹ ì²­ì ëª…ë‹¨</h4>
                    </div>
                    ${
                      ev.type === "tasting" && restaurantName
                        ? `
                      <!-- ë¯¸ì‹íšŒ: ì‹ ì²­í•œ ì‹ë‹¹ì˜ ì˜ˆì•½ì ëª©ë¡ -->
                      <div class="space-y-1">
                        ${
                          ev.restaurants
                            ?.find((r) => r.name === restaurantName)
                            ?.reservations?.slice()
                            .reverse()
                            .map(
                              (res, idx) => `
                          <div class="flex items-center justify-between bg-white rounded px-3 py-2 text-sm">
                            <div class="flex items-center gap-2">
                              <span class="text-gray-500">${idx + 1}.</span>
                              <span class="font-medium text-gray-800">${saf(
                                res.name
                              )}</span>
                            </div>
                            <span class="font-mono text-xs text-gray-600">${maskStudentId(
                              res.studentId
                            )}</span>
                          </div>
                        `
                            )
                            .join("") ||
                          '<p class="text-sm text-gray-500">ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                        }
                      </div>
                    `
                        : `
                      <!-- ì¼ë°˜ ì´ë²¤íŠ¸: ì „ì²´ ì‹ ì²­ì ëª©ë¡ -->
                      <div class="space-y-1">
                        ${
                          ev.applicants
                            ?.slice()
                            .reverse()
                            .map(
                              (app, idx) => `
                          <div class="flex items-center justify-between bg-white rounded px-3 py-2 text-sm">
                            <div class="flex items-center gap-2">
                              <span class="text-gray-500">${idx + 1}.</span>
                              <span class="font-medium text-gray-800">${saf(
                                app.name
                              )}</span>
                            </div>
                            <span class="font-mono text-xs text-gray-600">${maskStudentId(
                              app.studentId
                            )}</span>
                          </div>
                        `
                            )
                            .join("") ||
                          '<p class="text-sm text-gray-500">ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                        }
                      </div>
                    `
                    }
                  </div>

                  <!-- í‰ê°€ ì„¹ì…˜ -->
                  ${
                    hasReview
                      ? `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                      <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                          <i class="fas fa-star text-gray-600"></i>
                          <span class="font-bold text-gray-800">ë‚´ í‰ê°€</span>
                        </div>
                        <div class="flex items-center gap-1">
                          ${Array.from(
                            { length: 5 },
                            (_, i) =>
                              `<i class="fas fa-star ${
                                i < hasReview.rating
                                  ? "text-yellow-400"
                                  : "text-gray-300"
                              }"></i>`
                          ).join("")}
                          <span class="ml-2 font-bold text-gray-700">${
                            hasReview.rating
                          }.0</span>
                        </div>
                      </div>
                      ${
                        hasReview.comment
                          ? `
                      <div class="bg-white rounded-lg p-3 border border-gray-100">
                        <p class="text-sm text-gray-700 leading-relaxed">${saf(
                          hasReview.comment
                        )}</p>
                      </div>
                      `
                          : ""
                      }
                      <div class="mt-3 text-xs text-gray-500 flex items-center gap-1">
                        <i class="fas fa-clock"></i>
                        <span>${
                          hasReview.timestamp
                            ? new Date(hasReview.timestamp).toLocaleString(
                                "ko-KR"
                              )
                            : "-"
                        }</span>
                      </div>
                    </div>
                  `
                      : ""
                  }

                  <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                  <div class="flex gap-2">
                    ${
                      isPastEvent || isClosed
                        ? ev.type !== "mt" && ev.type !== "assembly"
                          ? `
                    <button type="button" class="flex-1 ${
                      hasReview
                        ? "bg-gray-600 hover:bg-gray-700"
                        : "bg-orange-500 hover:bg-orange-600"
                    } text-white py-3 px-4 rounded-lg transition-colors font-medium shadow-md"
                            data-act="write-review" data-id="${ev.id}">
                      <i class="fas ${
                        hasReview ? "fa-edit" : "fa-pen-to-square"
                      } mr-2"></i>
                      ${hasReview ? "í‰ê°€ ìˆ˜ì •" : "í‰ê°€ ì‘ì„±"}
                    </button>
                    `
                          : `
                    <div class="flex-1 bg-gray-100 text-gray-500 py-3 px-4 rounded-lg text-center font-medium">
                      <i class="fas fa-info-circle mr-2"></i>
                      MT/ì´íšŒëŠ” í›„ê¸° ì‘ì„±ì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                    `
                        : `
                    <div class="flex-1 bg-gray-100 text-gray-500 py-3 px-4 rounded-lg text-center font-medium">
                      <i class="fas fa-lock mr-2"></i>
                      í™œë™ ì¢…ë£Œ í›„ í‰ê°€ ê°€ëŠ¥
                    </div>
                    `
                    }
                  </div>

                  ${
                    isFullAdmin()
                      ? `
                  <div class="mt-3 pt-3 border-t border-gray-200">
                    <div class="flex gap-2 flex-wrap">
                      <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm transition-colors"
                              data-act="admin-edit" data-id="${
                                ev.id
                              }" title="ì´ë²¤íŠ¸ ìˆ˜ì •">
                        <i class="fas fa-pen mr-1"></i>ìˆ˜ì •
                      </button>
                      ${
                        isClosed
                          ? `
                      <button type="button" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm transition-colors"
                              data-act="admin-reopen" data-id="${ev.id}" title="ë‹¤ì‹œ ì—´ê¸°">
                        <i class="fas fa-door-open mr-1"></i>ë‹¤ì‹œ ì—´ê¸°
                      </button>
                      `
                          : `
                      <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm transition-colors"
                              data-act="admin-close" data-id="${ev.id}" title="ì‹ ì²­ ë§ˆê°">
                        <i class="fas fa-door-closed mr-1"></i>ì‹ ì²­ ë§ˆê°
                      </button>
                      `
                      }
                      <button type="button" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded text-sm transition-colors"
                              data-act="admin-unpost" data-id="${
                                ev.id
                              }" title="ê¸€ ë‚´ë¦¬ê¸°">
                        <i class="fas fa-arrow-down mr-1"></i>ê¸€ ë‚´ë¦¬ê¸°
                      </button>
                      <button type="button" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded text-sm transition-colors"
                              data-act="group-maker" data-id="${
                                ev.id
                              }" title="íŒ€ êµ¬ì„±í•˜ê¸°">
                        <i class="fas fa-users mr-1"></i>íŒ€ êµ¬ì„±í•˜ê¸°
                      </button>
                      <button type="button" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded text-sm transition-colors"
                              data-act="export-xlsx" data-id="${
                                ev.id
                              }" title="ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ">
                        <i class="fas fa-file-excel mr-1"></i>ëª…ë‹¨
                      </button>
                      ${
                        isPastEvent || isClosed
                          ? `
                      <button type="button" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm transition-colors"
                              data-act="admin-confirm-activity" data-id="${ev.id}" title="í™œë™ í™•ì •">
                        <i class="fas fa-check-circle mr-1"></i>í™œë™ í™•ì •
                      </button>
                      <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm transition-colors"
                              data-act="admin-cancel-activity" data-id="${ev.id}" title="í™œë™ ì·¨ì†Œ">
                        <i class="fas fa-times-circle mr-1"></i>í™œë™ ì·¨ì†Œ
                      </button>
                      `
                          : ""
                      }
                    </div>
                  </div>
                  `
                      : ""
                  }
                                </div>
                              </div>
                </div>`;
          })
          .join("");

        c.innerHTML = `
                <div class="section mb-6">
                  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div class="flex-1">
                      <h2 class="text-2xl font-bold mb-2 text-gray-800 flex items-center gap-2">
                        <i class="fas fa-history text-orange-500"></i>
                        í™œë™ ê¸°ë¡
                      </h2>
                      <p class="text-sm text-gray-600">ì°¸ê°€í•œ ì´ë²¤íŠ¸ ${participatedEvents.length}ê°œ â€¢ í‰ê°€ë¥¼ ë‚¨ê²¨ ë™ì•„ë¦¬ í™œë™ì„ ë”ìš± í’ì„±í•˜ê²Œ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                    </div>
                    <div class="flex-shrink-0">
                      <div class="inline-flex items-center gap-2 bg-orange-50 px-4 py-2 rounded-lg">
                        <i class="fas fa-trophy text-orange-500"></i>
                        <span class="font-bold text-orange-700">${participatedEvents.length}ê°œ ì°¸ì—¬</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="space-y-4">${eventCards}</div>
              `;

        // ì•„ì½”ë””ì–¸ í† ê¸€ í•¨ìˆ˜ ë“±ë¡
        window.toggleActivityDetails = function (eventId) {
          const details = document.getElementById(`details-${eventId}`);
          const chevron = document.getElementById(`chevron-${eventId}`);

          if (details && chevron) {
            if (details.classList.contains("hidden")) {
              details.classList.remove("hidden");
              chevron.style.transform = "rotate(180deg)";
            } else {
              details.classList.add("hidden");
              chevron.style.transform = "rotate(0deg)";
            }
          }
        };

        // í‰ê°€ ì‘ì„± ì´ë²¤íŠ¸ ë°”ì¸ë”©
        c.addEventListener("click", async (e) => {
          if (e.target.closest('[data-act="write-review"]')) {
            const eventId = e.target.closest('[data-act="write-review"]')
              .dataset.id;
            openReviewModal(eventId);
          }
        });
      }

      // ë‚ ì§œ íŒŒì‹± í—¬í¼ í•¨ìˆ˜ (ì‹œê°„ëŒ€ ë¬¸ì œ í•´ê²°)
      function parseDate(dateString) {
        if (!dateString) return new Date();

        // YYYY-MM-DD í˜•ì‹ì˜ ë‚ ì§œ ë¬¸ìì—´ì„ ë¡œì»¬ ì‹œê°„ëŒ€ë¡œ íŒŒì‹±
        const parts = dateString.split("-");
        if (parts.length === 3) {
          const year = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1; // JavaScript DateëŠ” 0ë¶€í„° ì‹œì‘
          const day = parseInt(parts[2], 10);
          return new Date(year, month, day);
        }

        return new Date(dateString);
      }

      // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë°˜í™˜ (ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€)
      function getTodayString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // ê¹œë¹¡ê±°ë¦¼ ë°©ì§€ë¥¼ ìœ„í•œ ë¶€ë“œëŸ¬ìš´ ë Œë”ë§ í•¨ìˆ˜
      function smoothRender(
        containerId,
        renderFunction,
        loadingText = "ë¡œë”© ì¤‘..."
      ) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // 1. ë¡œë”© ìƒíƒœ í‘œì‹œ
        container.classList.add("content-loading", "smooth-transition");

        // 2. requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ë¶€ë“œëŸ¬ìš´ ì „í™˜
        requestAnimationFrame(() => {
          // 3. ìƒˆë¡œìš´ ì½˜í…ì¸  ë Œë”ë§
          renderFunction();

          // 4. ì§§ì€ ì§€ì—° í›„ ë¡œë”© ìƒíƒœ í•´ì œ
          setTimeout(() => {
            container.classList.remove("content-loading");
            container.classList.add("content-loaded");

            // 5. ì „í™˜ ì™„ë£Œ í›„ í´ë˜ìŠ¤ ì •ë¦¬
            setTimeout(() => {
              container.classList.remove("smooth-transition", "content-loaded");
            }, 200);
          }, 50);
        });
      }

      // ë‹¬ë ¥ ìƒì„± í•¨ìˆ˜

      function generateCalendar(
        year,
        month,
        events = [],
        showDownloadButtons = false,
        isAdmin = false,
        isLoggedIn = true
      ) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const endDate = new Date(lastDay);
        endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const weekDays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
        const monthNames = [
          "1ì›”",
          "2ì›”",
          "3ì›”",
          "4ì›”",
          "5ì›”",
          "6ì›”",
          "7ì›”",
          "8ì›”",
          "9ì›”",
          "10ì›”",
          "11ì›”",
          "12ì›”",
        ];

        let calendarHTML = `
                <div class="calendar-container">
                  <div class="calendar-header">
                    <h3 class="calendar-title">Foodie ë‹¬ë ¥</h3>
                    <div class="calendar-nav">
                      ${
                        isLoggedIn
                          ? `
                      <button class="calendar-nav-btn calendar-nav-prev" onclick="changeCalendarMonth(-1)">
                        <i class="fas fa-chevron-left"></i>
                      </button>
                      `
                          : ""
                      }
                      <div class="calendar-month-year">${year}ë…„ ${
          monthNames[month]
        }</div>
                      ${
                        isLoggedIn
                          ? `
                      <button class="calendar-nav-btn calendar-nav-next" onclick="changeCalendarMonth(1)">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                      `
                          : ""
                      }
                    </div>
                  </div>
                  <div class="calendar-grid">
              `;

        // ìš”ì¼ í—¤ë”
        weekDays.forEach((day) => {
          calendarHTML += `<div class="calendar-day-header">${day}</div>`;
        });

        // ë‹¬ë ¥ ë‚ ì§œë“¤
        const currentDate = new Date(startDate);
        while (currentDate <= endDate) {
          const isCurrentMonth = currentDate.getMonth() === month;
          const isToday = currentDate.getTime() === today.getTime();
          // ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (UTC ë³€í™˜ ë°©ì§€)
          const currentYear = currentDate.getFullYear();
          const currentMonth = String(currentDate.getMonth() + 1).padStart(
            2,
            "0"
          );
          const currentDay = String(currentDate.getDate()).padStart(2, "0");
          const dateStr = `${currentYear}-${currentMonth}-${currentDay}`;

          // í•´ë‹¹ ë‚ ì§œì˜ ì´ë²¤íŠ¸ë“¤ ì°¾ê¸° (ê¶Œí•œì— ë”°ë¼ í•„í„°ë§)
          const dayEvents = events.filter((event) => {
            const eventDate = event.activityDate;
            if (!eventDate) return false;
            if (eventDate !== dateStr) return false;

            // ìš´ì˜ì§„ ì „ìš© ì¼ì •ì¸ ê²½ìš° ê¶Œí•œ ì²´í¬
            if (event.isAdminOnly && !isAdminOrStaff()) {
              return false;
            }

            return true;
          });

          let dayClass = "calendar-day";
          if (!isCurrentMonth) dayClass += " other-month";
          if (isToday) dayClass += " today";

          // ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (UTC ë³€í™˜ ë°©ì§€)
          const yearForModal = currentDate.getFullYear();
          const monthForModal = String(currentDate.getMonth() + 1).padStart(
            2,
            "0"
          );
          const dayForModal = String(currentDate.getDate()).padStart(2, "0");
          const dateString = `${yearForModal}-${monthForModal}-${dayForModal}`;

          const dayClickAttr = isAdmin
            ? `onclick="openAddEventModal('${dateString}')"`
            : "";

          calendarHTML += `<div class="${dayClass}" ${dayClickAttr}>`;
          calendarHTML += `<div class="calendar-day-number">${currentDate.getDate()}</div>`;

          // ì´ë²¤íŠ¸ë“¤ ì¶”ê°€
          dayEvents.forEach((event) => {
            const eventDate = parseDate(event.activityDate);
            let eventClass = "calendar-event";

            // ìš´ì˜ì§„ ì „ìš© ì¼ì •ì¸ ê²½ìš° íŒŒë€ìƒ‰ í´ë˜ìŠ¤ ì¶”ê°€
            if (event.isAdminOnly) {
              eventClass += " admin-only";
            }

            if (eventDate < today) {
              eventClass += " completed";
            } else if (eventDate.getTime() === today.getTime()) {
              eventClass += " next";
            }

            const title = event.activityName || event.title || "ì¼ì • ì—†ìŒ";

            // 4ê¸€ìë§ˆë‹¤ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ (ì´ëª¨í‹°ì½˜ í¬í•¨)
            const wrappedTitle = title.match(/.{1,4}/g)?.join("<br>") || title;

            // HTML ì—”í‹°í‹° ë³€í™˜ (XSS ë°©ì§€)
            const escapedTitle = title.replace(
              /[&<>"']/g,
              (m) =>
                ({
                  "&": "&amp;",
                  "<": "&lt;",
                  ">": "&gt;",
                  '"': "&quot;",
                  "'": "&#39;",
                }[m])
            );

            calendarHTML += `<div class="${eventClass}" title="${escapedTitle}" data-event-id="${event.id}">${wrappedTitle}</div>`;
          });

          calendarHTML += "</div>";
          currentDate.setDate(currentDate.getDate() + 1);
        }

        calendarHTML += `
                  </div>

                  ${
                    isLoggedIn
                      ? `
                  <div class="text-center mt-3 px-4">
                    <p class="text-sm text-gray-600 font-medium">
                      <i class="fas fa-calendar-check mr-2 text-blue-500"></i>
                      ì¼ì •ì„ í´ë¦­í•˜ì—¬ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•´ë³´ì„¸ìš”
                    </p>
                  </div>
                  `
                      : ""
                  }
                </div>

              `;

        return calendarHTML;
      }

      window.openAddEventModal = function (selectedDate) {
        // íšŒì¥ë‹¨(í’€ ì–´ë“œë¯¼)ë§Œ ìƒˆ ì¼ì • ì¶”ê°€ ê°€ëŠ¥
        if (!currentUser || !isFullAdmin()) {
          showAlert("â„¹ï¸", "í‘¸ë”” ìº˜ë¦°ë”ëŠ” íšŒì¥ë‹¨ë§Œ ìˆ˜ì •/ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }

        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">ìƒˆ ì¼ì • ì¶”ê°€</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>

                  <form id="calendar-add-event-form">
                    <div class="mb-4">
                      <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì •ëª…</label>
                      <input
                        id="calendar-event-name"
                        type="text"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                        placeholder="ì¼ì •ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                        required
                      >
                    </div>

                    <div class="mb-4">
                      <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                      <input
                        id="calendar-event-date"
                        type="date"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                        value="${selectedDate}"
                        required
                      >
                    </div>

                    <div class="mb-4">
                      <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                      <textarea
                        id="calendar-event-description"
                        rows="5"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                        placeholder="ì¼ì • ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤"
                      ></textarea>
                      <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Enter í‚¤ë¡œ ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                    </div>

                    <div class="flex justify-end gap-2">
                      <button
                        type="button"
                        onclick="this.closest('.fixed').remove()"
                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
                      >
                        ì·¨ì†Œ
                      </button>
                      <button
                        type="submit"
                        class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600"
                      >
                        ì¼ì • ì¶”ê°€
                      </button>
                    </div>
                  </form>
                </div>
              `;

        document.body.appendChild(modal);

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        modal
          .querySelector("#calendar-add-event-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const name = document.getElementById("calendar-event-name").value;
            const date = document.getElementById("calendar-event-date").value;
            const description = document.getElementById(
              "calendar-event-description"
            ).value;

            if (!name || !date) {
              showAlert("ğŸ˜¥", "ì¼ì •ëª…ê³¼ ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");
              return;
            }

            // ì¼ì • ì¶”ê°€ ë¡œì§ (ì—¬ê¸°ì— ì‹¤ì œ ì¶”ê°€ ì½”ë“œ êµ¬í˜„)
            console.log("ìƒˆ ì¼ì • ì¶”ê°€:", { name, date, description });
            showAlert("âœ…", "ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");

            modal.remove();
          });
      };

      // ë‹¬ë ¥ ì›” ë³€ê²½ í•¨ìˆ˜
      let currentCalendarYear = new Date().getFullYear();
      let currentCalendarMonth = new Date().getMonth();

      window.changeCalendarMonth = function (direction) {
        currentCalendarMonth += direction;
        if (currentCalendarMonth < 0) {
          currentCalendarMonth = 11;
          currentCalendarYear--;
        } else if (currentCalendarMonth > 11) {
          currentCalendarMonth = 0;
          currentCalendarYear++;
        }

        // ë‹¬ë ¥ ë‹¤ì‹œ ë Œë”ë§
        const accordionContent = document.getElementById("h-roadmap-full-list");
        if (
          accordionContent &&
          roadmapShowAll &&
          roadmapData &&
          roadmapData.length > 5
        ) {
          // roadmapDataë¥¼ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
          const sorted = roadmapData
            .filter((item) => item && item.id)
            .sort((a, b) => {
              const dateA = parseDate(a.activityDate || a.date);
              const dateB = parseDate(b.activityDate || b.date);
              return dateA - dateB;
            });

          // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
          const calendarHTML = generateCalendar(
            currentCalendarYear,
            currentCalendarMonth,
            sorted,
            true, // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
            isFullAdmin(), // íšŒì¥ë‹¨ë§Œ ìˆ˜ì • ê°€ëŠ¥
            true // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ê³¼ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
          );
          accordionContent.innerHTML = calendarHTML;
        }
      };

      function renderHorizontalRoadmap() {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì•„ë¬´ê²ƒë„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ (ë¸”ë¡ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
        if (!currentUser) {
          debugLog("renderHorizontalRoadmap: ë¡œê·¸ì•„ì›ƒ ìƒíƒœ - ë Œë”ë§í•˜ì§€ ì•ŠìŒ");
          return;
        }

        const root = document.getElementById("h-roadmap-list");
        const btn = document.getElementById("h-roadmap-toggle-btn");
        if (!root) {
          debugWarn(
            "renderHorizontalRoadmap: h-roadmap-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          );
          return;
        }

        debugLog("renderHorizontalRoadmap: roadmapData =", roadmapData);
        debugLog("roadmapData ê¸¸ì´:", roadmapData?.length || 0);
        debugLog("roadmapData íƒ€ì…:", typeof roadmapData);

        // ë°ì´í„° ìƒì„¸ ë¶„ì„
        if (roadmapData && roadmapData.length > 0) {
          debugLog("roadmapData ìƒì„¸ ë¶„ì„:");
          roadmapData.forEach((item, index) => {
            debugLog(`  [${index}]`, {
              id: item?.id,
              title: item?.title,
              activityName: item?.activityName,
              activityDate: item?.activityDate,
              order: item?.order,
            });
          });
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // order â†’ ë‚ ì§œ ìˆœ (ê¸°ë³¸ì ì¸ ë°ì´í„° ê²€ì¦ë§Œ)
        const validRoadmapData = (roadmapData || []).filter((item) => {
          if (!item || typeof item !== "object" || !item.id) return false;

          // ê´€ë¦¬ì(ìš´ì˜ì§„ í¬í•¨)ëŠ” ëª¨ë“  ì¼ì • í‘œì‹œ
          if (isAdminOrStaff()) {
            return true;
          }

          // ì¼ë°˜ íšŒì›: ìš´ì˜ì§„ ì „ìš© ì¼ì • ì œì™¸
          if (item.isAdminOnly) {
            return false;
          }

          return true;
        });

        // ê°„ë‹¨íˆ ë³´ê¸° ëª¨ë“œì—ì„œëŠ” ë‚ ì§œìˆœìœ¼ë¡œë§Œ ì •ë ¬ (order ë¬´ì‹œ)
        const sorted = [...validRoadmapData].sort((a, b) => {
          const dateA = parseDate(a.activityDate);
          const dateB = parseDate(b.activityDate);
          return dateA - dateB;
        });

        // ì§€ë‚œ ì¼ì •ê³¼ ë‹¤ìŒ ì¼ì • ë¶„ë¦¬
        const pastEvents = sorted.filter((item) => {
          const d = parseDate(item.activityDate);
          return d < today;
        });
        const futureEvents = sorted.filter((item) => {
          const d = parseDate(item.activityDate);
          return d >= today;
        });

        // ê°„ë‹¨íˆ ë³´ê¸° ëª¨ë“œì—ì„œëŠ” ì´ì „ ì¼ì • ì œê±°í•˜ê³  ë‹¤ìŒ ì¼ì •ë§Œ í‘œì‹œ (ëª¨ë°”ì¼ ê³ ë ¤)
        // ë‚ ì§œìˆœìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ë¯¸ë˜ ì¼ì •ì„ ë‹¤ìŒ ì¼ì •ìœ¼ë¡œ í‘œì‹œ
        const upcomingEvents = futureEvents.slice(0, 2); // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ëœ futureEventsì—ì„œ ì²˜ìŒ 2ê°œ

        const displayEvents = upcomingEvents;

        debugLog("ì¼ì • í‘œì‹œ ë¡œì§:", {
          totalEvents: sorted.length,
          pastEvents: pastEvents.length,
          futureEvents: futureEvents.length,
          upcomingEvents: upcomingEvents.length,
          displayEvents: displayEvents.length,
          roadmapShowAll: roadmapShowAll,
          screenWidth: window.innerWidth,
          isMobile: window.innerWidth <= 640,
          today: today.toISOString().split("T")[0],
          sortedEventsDetails: sorted.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
            order: item.order,
          })),
          futureEventsDetails: futureEvents.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
            createdAt: item.createdAt,
          })),
          upcomingEventsDetails: upcomingEvents.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
          })),
        });

        // ì „ì²´ ì¼ì •ë³´ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        if (btn) {
          if (sorted.length > 5) {
            // 5ê°œ ì´ìƒì¼ ë•Œ ë²„íŠ¼ í‘œì‹œ
            btn.classList.remove("hidden");
            const textElement = btn.querySelector("#h-roadmap-toggle-text");
            const chevronElement = btn.querySelector("#h-roadmap-chevron");
            if (textElement) {
              textElement.textContent = roadmapShowAll
                ? "ê°„ë‹¨íˆ ë³´ê¸°"
                : "ìº˜ë¦°ë”";
            }
            if (chevronElement) {
              chevronElement.style.transform = roadmapShowAll
                ? "rotate(180deg)"
                : "rotate(0deg)";
            }
          } else {
            btn.classList.add("hidden");
          }
        }

        // ê´€ë¦¬ììš© ìƒˆ ì¼ì • ì¶”ê°€ ë¸”ë¡ - ìš´ì˜ì§„ ì œì™¸, ì„ì›ì§„ë§Œ ê°€ëŠ¥
        const adminPlaceholder = isFullAdmin()
          ? `
                <div class="timeline-item admin-placeholder" data-act="add-roadmap">
                  <div class="timeline-content">
                    <div class="timeline-title">
                      <div class="admin-placeholder-content">
                        <div class="admin-placeholder-icon">
                          <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="admin-placeholder-text">
                          <span class="admin-placeholder-title">ìƒˆ ì¼ì • ì¶”ê°€</span>
                          <span class="admin-placeholder-subtitle">í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ ë¡œë“œë§µ ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `
          : "";

        // ë‹¤ìŒ ì¼ì • ì°¾ê¸° (ê°€ì¥ ê°€ê¹Œìš´ ë¯¸ë˜ ì¼ì •)
        const nextSchedule = futureEvents.length > 0 ? futureEvents[0] : null;

        debugLog("ë‹¤ìŒ ì¼ì • í™•ì¸:", {
          nextSchedule: nextSchedule
            ? {
                id: nextSchedule.id,
                title: nextSchedule.activityName || nextSchedule.title,
                date: nextSchedule.activityDate,
              }
            : null,
          futureEventsCount: futureEvents.length,
          today: today.toISOString().split("T")[0],
        });

        const html =
          adminPlaceholder +
            displayEvents
              .map((item) => {
                // ë‚ ì§œ ì²˜ë¦¬ (ë‚ ì§œê°€ ì—†ëŠ” ê²½ìš° ì˜¤ëŠ˜ë¡œ ì„¤ì •)
                const activityDate = item.activityDate || getTodayString();
                const d = parseDate(activityDate);

                // ìƒíƒœ í´ë˜ìŠ¤ ê²°ì •
                let blockClass = "";
                if (d < today) {
                  blockClass = "completed";
                } else if (item.id === nextSchedule?.id) {
                  blockClass = "next-schedule";
                }

                const formattedDate = d.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });

                // ì œëª© ì²˜ë¦¬ (ì œëª©ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©)
                const title = item.activityName || item.title || "ì¼ì • ì—†ìŒ";

                return `
            <div class="schedule-block ${blockClass}">
              <div class="schedule-block-content">
                <div class="schedule-block-date">${formattedDate}</div>
                <div class="schedule-block-title">${saf(title)}</div>
                ${
                  isFullAdmin()
                    ? `<div class="schedule-block-actions">
                        <button type="button" class="schedule-action-btn schedule-edit-btn" data-act="edit-roadmap" data-id="${item.id}" title="ìˆ˜ì •">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="schedule-action-btn schedule-download-btn" data-act="download-roadmap" data-id="${item.id}" title="ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ">
                          <i class="fas fa-download"></i>
                        </button>
                        <button type="button" class="schedule-action-btn schedule-delete-btn" data-act="delete-roadmap" data-id="${item.id}" title="ì‚­ì œ">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>`
                    : ""
                }
              </div>
            </div>`;
              })
              .join("") ||
          `<div class="text-gray-400 text-center py-8 col-span-full">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

        root.innerHTML = html;

        // ì•„ì½”ë””ì–¸ ì»¨í…ì¸  ì˜ì—­ ì²˜ë¦¬
        const accordionContent = document.getElementById("h-roadmap-full-list");
        if (accordionContent) {
          if (roadmapShowAll && sorted.length > 5) {
            // ì „ì²´ ì¼ì •ì„ ë¸”ë¡ í˜•íƒœë¡œ í‘œì‹œ
            const fullHtml = sorted
              .map((item) => {
                // ë‚ ì§œ ì²˜ë¦¬ (ë‚ ì§œê°€ ì—†ëŠ” ê²½ìš° ì˜¤ëŠ˜ë¡œ ì„¤ì •)
                const activityDate = item.activityDate || getTodayString();
                const d = parseDate(activityDate);

                // ìƒíƒœ í´ë˜ìŠ¤ ê²°ì •
                let blockClass = "";
                if (d < today) {
                  blockClass = "completed";
                } else if (item.id === nextSchedule?.id) {
                  blockClass = "next-schedule";
                }

                const formattedDate = d.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });

                // ì œëª© ì²˜ë¦¬ (ì œëª©ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©)
                const title = item.activityName || item.title || "ì¼ì • ì—†ìŒ";

                return `
                <div class="schedule-block ${blockClass}">
                  <div class="schedule-block-content">
                    <div class="schedule-block-date">${formattedDate}</div>
                    <div class="schedule-block-title">${saf(title)}</div>
                    ${
                      isFullAdmin()
                        ? `<div class="schedule-block-actions">
                            <button type="button" class="schedule-action-btn schedule-edit-btn" data-act="edit-roadmap" data-id="${item.id}" title="ìˆ˜ì •">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="schedule-action-btn schedule-download-btn" data-act="download-roadmap" data-id="${item.id}" title="ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ">
                              <i class="fas fa-download"></i>
                            </button>
                            <button type="button" class="schedule-action-btn schedule-delete-btn" data-act="delete-roadmap" data-id="${item.id}" title="ì‚­ì œ">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>`
                        : ""
                    }
                  </div>
                </div>`;
              })
              .join("");

            // ë‹¬ë ¥ í˜•íƒœë¡œ ì „ì²´ ì¼ì • í‘œì‹œ
            const calendarHTML = generateCalendar(
              currentCalendarYear,
              currentCalendarMonth,
              sorted,
              true, // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
              isFullAdmin(), // ê´€ë¦¬ì ê¶Œí•œ ì „ë‹¬ - ìš´ì˜ì§„ ì œì™¸
              true // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ê³¼ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
            );
            accordionContent.innerHTML = calendarHTML;

            // ì•„ì½”ë””ì–¸ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì—´ê¸°
            setTimeout(() => {
              accordionContent.style.maxHeight =
                accordionContent.scrollHeight + "px";
              accordionContent.style.opacity = "1";
            }, 10);
          } else {
            // ì•„ì½”ë””ì–¸ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‹«ê¸°
            accordionContent.style.maxHeight = "0";
            accordionContent.style.opacity = "0";
          }
        }

        // ë¡œë“œë§µ ìˆ˜ì •/ì‚­ì œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        root.addEventListener("click", (e) => {
          const act = e.target.closest("[data-act]")?.dataset.act;
          const id = e.target.closest("[data-act]")?.dataset.id;

          if (act === "edit-roadmap") {
            openRoadmapEventEditModal(id, 0); // eventIndexëŠ” 0ìœ¼ë¡œ ì„¤ì •
          } else if (act === "delete-roadmap") {
            deleteRoadmapEvent(id);
          } else if (act === "add-roadmap") {
            openRoadmapAddModal();
          }
        });

        // ì•„ì½”ë””ì–¸ ì˜ì—­ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ë‹¬ë ¥ ì´ë²¤íŠ¸ í¬í•¨)
        if (accordionContent) {
          accordionContent.addEventListener("click", (e) => {
            const act = e.target.closest("[data-act]")?.dataset.act;
            const id = e.target.closest("[data-act]")?.dataset.id;
            const eventId =
              e.target.closest(".calendar-event")?.dataset.eventId;

            if (act === "edit-roadmap") {
              openRoadmapEventEditModal(id, 0);
            } else if (act === "delete-roadmap") {
              deleteRoadmapEvent(id);
            } else if (eventId) {
              // ë‹¬ë ¥ ì´ë²¤íŠ¸ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ í‘œì‹œ
              showEventDetails(eventId);
            }
          });
        }
      }

      // ë‹¬ë ¥ ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
      function showEventDetails(eventId) {
        // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ë¨¼ì € ì œê±°
        const existingModal = document.getElementById("event-detail-modal");
        if (existingModal) {
          existingModal.remove();
        }

        const event = roadmapData.find((item) => item.id === eventId);
        if (!event) return;

        const activityDate = event.activityDate || getTodayString();
        const d = parseDate(activityDate);
        const formattedDate = d.toLocaleDateString("ko-KR", {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        });

        const title = event.activityName || event.title || "ì¼ì • ì—†ìŒ";
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let statusText = "";
        let statusClass = "";
        if (d < today) {
          statusText = "ì™„ë£Œëœ ì¼ì •";
          statusClass = "text-red-600";
        } else if (d.getTime() === today.getTime()) {
          statusText = "ì˜¤ëŠ˜ì˜ ì¼ì •";
          statusClass = "text-green-600";
        } else {
          statusText = "ì˜ˆì •ëœ ì¼ì •";
          statusClass = "text-orange-600";
        }

        const modalHTML = `
                <div id="event-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                      <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-gray-800">ì¼ì • ìƒì„¸ ì •ë³´</h3>
                        <button onclick="closeEventDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                          <i class="fas fa-times text-xl"></i>
                        </button>
                      </div>

                      <div class="space-y-4">
                        <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4">
                          <h4 class="font-semibold text-gray-800 mb-2">${saf(
                            title
                          )}</h4>
                          <div class="flex items-center gap-2 text-sm">
                            <i class="fas fa-calendar text-orange-500"></i>
                            <span class="text-gray-600">${formattedDate}</span>
                          </div>
                          <div class="flex items-center gap-2 text-sm mt-2">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span class="${statusClass} font-medium">${statusText}</span>
                          </div>
                        </div>

                        ${
                          event.description
                            ? `
                          <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-700 mb-2">ìƒì„¸ ì„¤ëª…</h5>
                            <p class="text-gray-600 text-sm whitespace-pre-wrap">${saf(
                              event.description
                            )}</p>
                          </div>
                        `
                            : ""
                        }

                        <div class="flex gap-2">
                          ${
                            currentUser &&
                            adminList.includes(currentUser.studentId)
                              ? `
                            <button onclick="openRoadmapEventEditModal('${eventId}', 0); closeEventDetailModal();"
                                    class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                              <i class="fas fa-edit mr-2"></i>ìˆ˜ì •
                            </button>
                            <button onclick="deleteRoadmapEvent('${eventId}'); closeEventDetailModal();"
                                    class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                              <i class="fas fa-trash mr-2"></i>ì‚­ì œ
                            </button>
                          `
                              : ""
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
      }

      // ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
      window.showEventDetails = showEventDetails;

      // ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜ (eventsDataìš©)
      window.showEventDetailModal = function (eventId) {
        const ev = eventsData.find((e) => e.id === eventId);
        if (!ev) {
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ê¸ˆì•¡ í¬ë§·íŒ… í•¨ìˆ˜
        const formatKRW = (n) => {
          const v = Number(n || 0);
          return isNaN(v) ? "" : v.toLocaleString("ko-KR") + "ì›";
        };

        // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ë¨¼ì € ì œê±°
        const existingModal = document.getElementById(
          "event-detail-modal-main"
        );
        if (existingModal) {
          existingModal.remove();
        }

        const eventDate = ev.datetime
          ? new Date(ev.datetime).toLocaleString("ko-KR", {
              year: "numeric",
              month: "long",
              day: "numeric",
              weekday: "long",
              hour: "2-digit",
              minute: "2-digit",
            })
          : "ë¯¸ì •";

        const deadlineDate = ev.deadline
          ? new Date(ev.deadline).toLocaleString("ko-KR", {
              year: "numeric",
              month: "long",
              day: "numeric",
              weekday: "long",
              hour: "2-digit",
              minute: "2-digit",
            })
          : "ë¯¸ì„¤ì •";

        const typeLabel =
          ev.type === "tasting"
            ? "ğŸ½ï¸ ë¯¸ì‹íšŒ"
            : ev.type === "mt"
            ? "ğŸ•ï¸ MT"
            : ev.type === "assembly"
            ? "ğŸ¤ ì´íšŒ"
            : "ğŸ“… ì´ë²¤íŠ¸";

        const formatDateTimeLocal = (value) => {
          if (!value) return "-";
          const date = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(date.getTime())) return "-";
          return date.toLocaleString("ko-KR", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        };

        const sid = currentUser?.studentId;
        let myApplicationHTML = "";

        if (sid) {
          const defaultBadgeClass =
            "inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-semibold";
          const getDisplayName = (entry) => {
            if (!entry) return "ìµëª…";
            return (
              entry.name ||
              entry.displayName ||
              (entry.studentId ? maskStudentIdGlobal(entry.studentId) : "ìµëª…")
            );
          };

          const makeRow = (icon, label, content) => `
                  <div class="flex items-start gap-2 bg-white rounded-lg px-3 py-2 border border-blue-100">
                    <i class="fas ${icon} text-blue-500 mt-0.5"></i>
                    <div>
                      <div class="text-[11px] text-blue-600">${label}</div>
                      <div class="text-sm font-semibold text-gray-800 leading-snug">${content}</div>
                    </div>
                  </div>
                `;

          let myEntry = null;
          let myStatus = "";
          let myStatusClass = `${defaultBadgeClass} bg-blue-100 text-blue-700`;
          let myRestaurant = null;
          let waitPosition = null;
          let companions = [];

          if (ev.type === "tasting") {
            (ev.restaurants || []).some((restaurant) => {
              const reservations = restaurant.reservations || [];
              const waiting = restaurant.waiting || [];
              const reservationIdx = reservations.findIndex(
                (r) => r.studentId === sid
              );
              if (reservationIdx >= 0) {
                myEntry = reservations[reservationIdx];
                myStatus = "ì‹ ì²­ í™•ì •";
                myRestaurant = restaurant;
                companions = reservations
                  .filter((r) => r.studentId !== sid)
                  .map((r) => getDisplayName(r));
                return true;
              }
              const waitingIdx = waiting.findIndex((r) => r.studentId === sid);
              if (waitingIdx >= 0) {
                myEntry = waiting[waitingIdx];
                myStatus = "ëŒ€ê¸°ì¤‘";
                myStatusClass = `${defaultBadgeClass} bg-yellow-100 text-yellow-700`;
                waitPosition = waitingIdx + 1;
                myRestaurant = restaurant;
                companions = waiting
                  .filter((r) => r.studentId !== sid)
                  .map((r) => getDisplayName(r));
                return true;
              }
              return false;
            });
          } else {
            const applicants = ev.applicants || [];
            const waiting = ev.waiting || [];
            const applicantIdx = applicants.findIndex(
              (a) => a.studentId === sid
            );
            if (applicantIdx >= 0) {
              myEntry = applicants[applicantIdx];
              myStatus = "ì‹ ì²­ í™•ì •";
              companions = applicants
                .filter((a) => a.studentId !== sid)
                .map((a) => getDisplayName(a));
            } else {
              const waitingIdx = waiting.findIndex((a) => a.studentId === sid);
              if (waitingIdx >= 0) {
                myEntry = waiting[waitingIdx];
                myStatus = "ëŒ€ê¸°ì¤‘";
                myStatusClass = `${defaultBadgeClass} bg-yellow-100 text-yellow-700`;
                waitPosition = waitingIdx + 1;
                companions = waiting
                  .filter((a) => a.studentId !== sid)
                  .map((a) => getDisplayName(a));
              }
            }
          }

          if (myEntry || myStatus) {
            companions = [...new Set(companions.filter((name) => !!name))];
            const applicantName =
              getDisplayName(myEntry) || currentUser?.name || "ìµëª…";
            const appliedAt =
              myEntry?.appliedAt ||
              myEntry?.applied_at ||
              myEntry?.timestamp ||
              myEntry?.createdAt;

            const infoRows = [];

            infoRows.push(
              makeRow(
                "fa-id-card",
                "ì‹ ì²­ì",
                `${saf(applicantName)} (${saf(sid)})`
              )
            );

            if (myStatus) {
              const statusBadge = `<span class="${myStatusClass}">${saf(
                myStatus
              )}${waitPosition ? ` (${waitPosition}ë²ˆ)` : ""}</span>`;
              infoRows.push(makeRow("fa-flag", "ì‹ ì²­ ìƒíƒœ", statusBadge));
            }

            if (appliedAt) {
              infoRows.push(
                makeRow(
                  "fa-clock",
                  "ì‹ ì²­ ì¼ì‹œ",
                  saf(formatDateTimeLocal(appliedAt))
                )
              );
            }

            if (myRestaurant) {
              const capacity =
                myRestaurant.capacity ??
                ev.limit ??
                myRestaurant.reservations?.length ??
                0;
              const reservedCount = myRestaurant.reservations?.length ?? 0;
              infoRows.push(
                makeRow(
                  "fa-utensils",
                  "ì‹ ì²­ ì‹ë‹¹",
                  `${saf(
                    myRestaurant.name || "ì‹ë‹¹ ë¯¸ì •"
                  )} (${reservedCount}/${capacity}ëª…)`
                )
              );
            }

            if (waitPosition && myStatus === "ëŒ€ê¸°ì¤‘") {
              infoRows.push(
                makeRow("fa-list-ol", "ëŒ€ê¸° ìˆœë²ˆ", `${waitPosition}ë²ˆ`)
              );
            }

            if (companions.length > 0) {
              const companionChips = companions
                .slice(0, 6)
                .map(
                  (name) => `
                          <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-medium">
                            ${saf(name)}
                          </span>
                        `
                )
                .join("");
              const extraCompanions =
                companions.length > 6
                  ? `<span class="px-2 py-1 rounded-full bg-blue-50 text-blue-500 text-xs font-medium">
                            +${companions.length - 6}
                          </span>`
                  : "";

              infoRows.push(`
                      <div class="flex flex-col gap-2 bg-white rounded-lg px-3 py-2 border border-blue-100">
                        <div class="flex items-center gap-2 text-[11px] text-blue-600">
                          <i class="fas fa-users"></i>
                          í•¨ê»˜ ì‹ ì²­í•œ ì¸ì›
                        </div>
                        <div class="flex flex-wrap gap-1">
                          ${companionChips}${extraCompanions}
                        </div>
                      </div>
                    `);
            }

            myApplicationHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                      <h5 class="font-semibold text-blue-900 flex items-center gap-2">
                        <i class="fas fa-user-check text-blue-600"></i>ë‚´ ì‹ ì²­ ì •ë³´
                      </h5>
                      <div class="grid grid-cols-1 gap-2">
                        ${infoRows.join("")}
                      </div>
                    </div>
                  `;
          } else {
            myApplicationHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-700">
                      í˜„ì¬ ê³„ì •ìœ¼ë¡œ ì‹ ì²­í•œ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                  `;
          }
        }

        const modalHTML = `
                <div id="event-detail-modal-main" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                      <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-gray-800">ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´</h3>
                        <button onclick="closeEventDetailModalMain()" class="text-gray-400 hover:text-gray-600 transition-colors">
                          <i class="fas fa-times text-xl"></i>
                        </button>
                      </div>

                      <div class="space-y-4">
                        <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4">
                          <h4 class="font-semibold text-gray-800 mb-3">${saf(
                            ev.title
                          )}</h4>
                          <div class="space-y-2">
                            <div class="flex items-center gap-2 text-sm">
                              <i class="fas fa-tag text-orange-500"></i>
                              <span class="text-gray-700">${typeLabel}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm font-bold text-orange-700">
                              <i class="fas fa-calendar-check text-orange-600"></i>
                              <span>ì‹¤ì‹œì¼: ${eventDate}</span>
                            </div>
                            <div class="flex items-center gap-2 text-sm font-bold text-red-700">
                              <i class="fas fa-clock text-red-600"></i>
                              <span>ë§ˆê°ì¼: ${deadlineDate}</span>
                            </div>
                          </div>
                        </div>

                        ${myApplicationHTML}

                        ${
                          ev.description
                            ? `
                          <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-medium text-gray-700 mb-2">ìƒì„¸ ì„¤ëª…</h5>
                            <p class="text-gray-600 text-sm whitespace-pre-wrap">${saf(
                              ev.description
                            )}</p>
                          </div>
                        `
                            : ""
                        }

                        ${
                          (ev.type === "mt" || ev.type === "assembly") &&
                          ev.payment
                            ? `
                          <div class="bg-amber-50 rounded-lg p-4 border-2 border-amber-200">
                            <h5 class="font-semibold text-amber-900 mb-3 flex items-center">
                              <i class="fas fa-wallet mr-2 text-amber-600"></i>ì…ê¸ˆ ì •ë³´
                            </h5>
                            <div class="space-y-3">
                              ${
                                ev.payment.amount
                                  ? `
                              <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-won-sign text-amber-600"></i>
                                <span class="text-gray-700 font-medium">ì…ê¸ˆ ê¸ˆì•¡:</span>
                                <span class="text-gray-800 font-bold text-lg">${formatKRW(
                                  ev.payment.amount
                                )}</span>
                              </div>
                              `
                                  : ""
                              }
                              ${
                                ev.payment.bank && ev.payment.number
                                  ? `
                              <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-university text-amber-600"></i>
                                <span class="text-gray-700 font-medium">ì…ê¸ˆ ê³„ì¢Œ:</span>
                                <span class="text-gray-800 font-semibold">${saf(
                                  ev.payment.bank
                                )} ${saf(ev.payment.number)}</span>
                                ${
                                  ev.payment.holder
                                    ? `<span class="text-gray-600 text-xs">(ì˜ˆê¸ˆì£¼: ${saf(
                                        ev.payment.holder
                                      )})</span>`
                                    : ""
                                }
                              </div>
                              `
                                  : ""
                              }
                              ${
                                ev.payment.bank && ev.payment.number
                                  ? `
                              <div class="flex justify-end">
                                <button
                                  type="button"
                                  onclick="navigator.clipboard.writeText('${saf(
                                    ev.payment.bank || ""
                                  )} ${saf(
                                      ev.payment.number || ""
                                    )}').then(() => alert('ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'))"
                                  class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-1 rounded text-xs transition-colors"
                                >
                                  <i class="fas fa-copy mr-1"></i>ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬
                                </button>
                              </div>
                              `
                                  : ""
                              }
                              ${
                                ev.payment.note
                                  ? `
                              <div class="text-sm text-amber-800 bg-amber-100 p-2 rounded">
                                <i class="fas fa-info-circle mr-1"></i>${saf(
                                  ev.payment.note
                                )}
                              </div>
                              `
                                  : ""
                              }
                            </div>
                          </div>
                        `
                            : ""
                        }

                        ${
                          ev.type === "tasting" &&
                          ev.restaurants &&
                          ev.restaurants.length > 0
                            ? `
                          <div class="bg-orange-50 rounded-lg p-4 border-2 border-orange-200">
                            <h5 class="font-semibold text-gray-800 mb-3 flex items-center">
                              <i class="fas fa-utensils mr-2 text-orange-600"></i>ì‹ë‹¹ë³„ ì‹ ì²­ í˜„í™©
                            </h5>
                            <div class="space-y-3">
                              ${ev.restaurants
                                .map((restaurant) => {
                                  const reservations =
                                    restaurant.reservations || [];
                                  const waiting = restaurant.waiting || [];
                                  const capacity =
                                    restaurant.capacity || ev.limit || 0;

                                  // ì‹ ì²­í•œ ì‚¬ëŒ ì´ë¦„ ì°¾ê¸°
                                  const participantNames = reservations
                                    .slice()
                                    .reverse()
                                    .map((res) => {
                                      const member = membersData?.find(
                                        (m) => m.studentId === res.studentId
                                      );
                                      return (
                                        member?.name ||
                                        res.name ||
                                        res.studentId ||
                                        "ìµëª…"
                                      );
                                    });

                                  const waitingNames = waiting
                                    .slice()
                                    .reverse()
                                    .map((wait) => {
                                      const member = membersData?.find(
                                        (m) => m.studentId === wait.studentId
                                      );
                                      return (
                                        member?.name ||
                                        wait.name ||
                                        wait.studentId ||
                                        "ìµëª…"
                                      );
                                    });

                                  // í˜„ì¬ ì‚¬ìš©ìê°€ ì‹ ì²­í•œ ì‹ë‹¹ì¸ì§€ í™•ì¸
                                  const isMyRestaurant =
                                    currentUser &&
                                    reservations.some(
                                      (res) =>
                                        res.studentId === currentUser.studentId
                                    );

                                  return `
                                  <div class="bg-white rounded-lg p-3 border ${
                                    isMyRestaurant
                                      ? "border-orange-500 border-2"
                                      : "border-gray-200"
                                  }">
                                    <div class="flex items-center justify-between mb-2">
                                      <h6 class="font-semibold text-gray-800 flex items-center">
                                        ${
                                          isMyRestaurant
                                            ? '<i class="fas fa-check-circle text-orange-600 mr-2"></i>'
                                            : ""
                                        }
                                        ${saf(restaurant.name || "ì‹ë‹¹ëª… ì—†ìŒ")}
                                      </h6>
                                      <span class="text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded-full">
                                        ${reservations.length}/${capacity}ëª…
                                        ${
                                          waiting.length > 0
                                            ? ` (+${waiting.length}ëª… ëŒ€ê¸°)`
                                            : ""
                                        }
                                      </span>
                                    </div>
                                    ${
                                      participantNames.length > 0
                                        ? `
                                      <div class="mt-2">
                                        <p class="text-xs font-semibold text-gray-600 mb-1">ì°¸ê°€ì:</p>
                                        <div class="flex flex-wrap gap-1">
                                          ${participantNames
                                            .map(
                                              (name) => `
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${saf(
                                              name
                                            )}</span>
                                          `
                                            )
                                            .join("")}
                                        </div>
                                      </div>
                                      `
                                        : ""
                                    }
                                    ${
                                      waitingNames.length > 0
                                        ? `
                                      <div class="mt-2">
                                        <p class="text-xs font-semibold text-amber-600 mb-1">ëŒ€ê¸°ì:</p>
                                        <div class="flex flex-wrap gap-1">
                                          ${waitingNames
                                            .map(
                                              (name) => `
                                            <span class="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded-full">${saf(
                                              name
                                            )}</span>
                                          `
                                            )
                                            .join("")}
                                        </div>
                                      </div>
                                      `
                                        : ""
                                    }
                                  </div>
                                `;
                                })
                                .join("")}
                            </div>
                          </div>
                        `
                            : `
                        <div class="bg-gray-50 rounded-lg p-4">
                          <h5 class="font-medium text-gray-700 mb-2">ì‹ ì²­ í˜„í™©</h5>
                          <p class="text-gray-600 text-sm">ì°¸ê°€ì: ${
                            (ev.applicants || []).length
                          }ëª… / ${ev.limit || 0}ëª…</p>
                          ${
                            (ev.waiting || []).length > 0
                              ? `<p class="text-gray-600 text-sm mt-1">ëŒ€ê¸°ì: ${ev.waiting.length}ëª…</p>`
                              : ""
                          }
                          ${
                            ev.applicants && ev.applicants.length > 0
                              ? `
                              <div class="mt-3">
                                <p class="text-xs font-semibold text-gray-600 mb-1">ì°¸ê°€ì ëª©ë¡:</p>
                                <div class="flex flex-wrap gap-1">
                                  ${ev.applicants
                                    .slice()
                                    .reverse()
                                    .map((app) => {
                                      const member = membersData?.find(
                                        (m) => m.studentId === app.studentId
                                      );
                                      const name =
                                        member?.name ||
                                        app.name ||
                                        app.studentId ||
                                        "ìµëª…";
                                      return `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${saf(
                                        name
                                      )}</span>`;
                                    })
                                    .join("")}
                                </div>
                              </div>
                              `
                              : ""
                          }
                        </div>
                        `
                        }
                      </div>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
      };

      window.closeEventDetailModalMain = function () {
        const modal = document.getElementById("event-detail-modal-main");
        if (modal) {
          modal.remove();
        }
      };

      // ì°¸ê°€ì ëª©ë¡ ê³µê°œ ì—¬ë¶€ í† ê¸€ í•¨ìˆ˜ (íšŒì¥ë‹¨ ì „ìš©) - ëª¨ë‘ì—ê²Œ ë³´ì´ê¸°/íšŒì¥ë‹¨ë§Œ
      window.toggleParticipantsPublicVisibility = async function (
        eventId,
        type
      ) {
        if (!isFullAdmin()) return;

        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) {
            showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const fieldName =
            type === "applicants"
              ? "participantsVisibleToAll"
              : "waitingVisibleToAll";
          const currentValue = ev[fieldName] || false;
          const newValue = !currentValue;

          await updateDoc(doc(db, "events", eventId), {
            [fieldName]: newValue,
          });

          showAlert(
            "âœ…",
            newValue
              ? "ëª¨ë‘ì—ê²Œ ë³´ì´ë„ë¡ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
              : "íšŒì¥ë‹¨ë§Œ ë³¼ ìˆ˜ ìˆë„ë¡ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          );
          renderReservationTab(isFullAdmin());
        } catch (error) {
          console.error("ì°¸ê°€ì ê³µê°œ ì„¤ì • ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì„¤ì • ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };

      // ë¯¸ì‹íšŒ ì°¸ê°€ì ëª©ë¡ ê³µê°œ ì—¬ë¶€ í† ê¸€ í•¨ìˆ˜ (íšŒì¥ë‹¨ ì „ìš©) - ëª¨ë‘ì—ê²Œ ë³´ì´ê¸°/íšŒì¥ë‹¨ë§Œ
      window.toggleRestaurantParticipantsPublicVisibility = async function (
        eventId,
        restaurantId,
        type
      ) {
        if (!isFullAdmin()) return;

        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) {
            showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const fieldName =
            type === "reservations"
              ? "participantsVisibleToAll"
              : "waitingVisibleToAll";
          const currentValue = ev[fieldName] || false;
          const newValue = !currentValue;

          await updateDoc(doc(db, "events", eventId), {
            [fieldName]: newValue,
          });

          showAlert(
            "âœ…",
            newValue
              ? "ëª¨ë‘ì—ê²Œ ë³´ì´ë„ë¡ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
              : "íšŒì¥ë‹¨ë§Œ ë³¼ ìˆ˜ ìˆë„ë¡ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          );
          renderReservationTab(isFullAdmin());
        } catch (error) {
          console.error("ì°¸ê°€ì ê³µê°œ ì„¤ì • ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì„¤ì • ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      };

      // ë‹¬ë ¥ ì´ë²¤íŠ¸ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
      window.closeEventDetailModal = function () {
        const modal = document.getElementById("event-detail-modal");
        if (modal) {
          modal.remove();
        }
      };

      // ë¡œë“œë§µ ì¼ì • ì‚­ì œ í•¨ìˆ˜
      window.deleteRoadmapEvent = async function (eventId) {
        if (!confirm("ì •ë§ë¡œ ì´ ë¡œë“œë§µ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        try {
          // ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          const docRef = doc(db, "roadmap", eventId);
          const docSnap = await getDoc(docRef);

          if (!docSnap.exists()) {
            showAlert("ğŸ˜¥", "ì‚­ì œí•˜ë ¤ëŠ” ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          await deleteDoc(docRef);
          showAlert("âœ…", "ë¡œë“œë§µ ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          renderHorizontalRoadmap(); // ë¡œë“œë§µ ë‹¤ì‹œ ë Œë”ë§
        } catch (error) {
          console.error("ë¡œë“œë§µ ì‚­ì œ ì˜¤ë¥˜:", error);
          if (error.code === "not-found") {
            showAlert("ğŸ˜¥", "ì‚­ì œí•˜ë ¤ëŠ” ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          } else {
            showAlert("ğŸ˜¥", "ë¡œë“œë§µ ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      };

      // ë¡œë“œë§µ ì¼ì • ì¶”ê°€ ëª¨ë‹¬ (ìƒˆë¡œìš´ í•¨ìˆ˜)
      function openRoadmapAddModal() {
        const modalHTML = `
                  <div id="roadmap-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                    <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                      <h3 class="text-xl font-bold text-gray-800 mb-4">ìƒˆ ë¡œë“œë§µ ì¼ì • ì¶”ê°€</h3>
                      <div class="space-y-4">
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                          <input id="roadmap-add-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                          <input id="roadmap-add-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                          <textarea id="roadmap-add-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="ì¼ì •ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                      </div>
                      <div class="flex gap-3 mt-6">
                        <button id="roadmap-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                          <i class="fas fa-plus mr-2"></i>ì¶”ê°€
                        </button>
                        <button id="roadmap-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                          ì·¨ì†Œ
                        </button>
                      </div>
                    </div>
                  </div>
                `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById("roadmap-add-modal");
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-add-save")
          .addEventListener("click", async () => {
            const title = document
              .getElementById("roadmap-add-title")
              .value.trim();
            const date = document.getElementById("roadmap-add-date").value;
            const description = document
              .getElementById("roadmap-add-description")
              .value.trim();

            if (!title) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (!date) {
              showAlert("ğŸ˜¥", "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              console.log("ë¡œë“œë§µ ì¶”ê°€ ì‹œë„:", { title, date, description });
              console.log("í˜„ì¬ roadmapData:", roadmapData);

              // ë‹¤ìŒ order ê°’ ê³„ì‚°
              const maxOrder = Math.max(
                ...(roadmapData || []).map((e) => e.order || 0),
                0
              );
              const newOrder = maxOrder + 1;

              console.log("ìƒˆ order ê°’:", newOrder);

              const docRef = await addDoc(collection(db, "roadmap"), {
                activityName: title,
                activityDate: date,
                description: description || "",
                order: newOrder,
                createdAt: new Date().toISOString(),
              });

              console.log("ë¬¸ì„œ ì¶”ê°€ ì™„ë£Œ, ID:", docRef.id);

              showAlert("âœ…", "ìƒˆ ë¡œë“œë§µ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document.getElementById("roadmap-add-modal").remove();

              // ë¡œë“œë§µì€ onSnapshotìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸ë¨
            } catch (error) {
              console.error("ì¼ì • ì¶”ê°€ ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
          });

        document
          .getElementById("roadmap-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-add-modal").remove();
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("roadmap-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-add-modal") {
              document.getElementById("roadmap-add-modal").remove();
            }
          });
      }

      // ë…ë¦½ì ì¸ ì¡°ëª¨ì„ ë°ì´í„° ê´€ë¦¬
      let groupsData = [];

      // ì¡°ëª¨ì„ ë°ì´í„° ë¡œë“œ
      function loadGroupsData() {
        if (!currentUser) return;

        const unsubscribe = onSnapshot(
          collection(db, "groups"),
          (snapshot) => {
            markRealtimeHealthy();
            groupsData = [];
            snapshot.forEach((doc) => {
              groupsData.push({
                id: doc.id,
                ...doc.data(),
              });
            });
            console.log("ì¡°ëª¨ì„ ë°ì´í„° ë¡œë“œë¨:", groupsData);

            // ì¡°ëª¨ì„ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
            const rankModal = document.getElementById("rank-modal");
            if (rankModal && !rankModal.classList.contains("hidden")) {
              renderRankList();
            }

            // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì˜ ì¡°ëª¨ì„ ê´€ë¦¬ íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
            if (
              currentMainTab === "dashboard" &&
              currentDashboardTab === "groups"
            ) {
              const subtabContainer =
                document.getElementById("subtab-container");
              if (subtabContainer) {
                renderGroupsAdmin(subtabContainer);
              }
            }
          },
          (error) => {
            console.error("ì¡°ëª¨ì„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
            handleRealtimeListenerError("groups", error);
          }
        );

        return unsubscribe;
      }

      // ì¡°ëª¨ì„ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
      window.openGroupAddModal = function () {
        const modal = document.getElementById("group-add-modal");
        if (!modal) {
          createGroupAddModal();
        }

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById("group-add-name").value = "";
        document.getElementById("group-add-score").value = "";

        document.getElementById("group-add-modal").classList.remove("hidden");
      };

      // ì¡°ëª¨ì„ ì¶”ê°€ ëª¨ë‹¬ ìƒì„±
      function createGroupAddModal() {
        const modalHTML = `
                <div id="group-add-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white rounded-2xl shadow-xl max-w-md w-full flex flex-col max-h-[90vh]">
                    <div class="p-6 md:p-7 flex-shrink-0">
                      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ… ì¡°ëª¨ì„ ì¶”ê°€</h3>
                      <div class="space-y-4">
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">ì¡°ëª¨ì„ ì´ë¦„</label>
                          <input id="group-add-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì˜ˆ: 1ì¡°, Aì¡°, ê¹€ì¹˜ì¡°">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">ì ìˆ˜</label>
                          <input id="group-add-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0" value="0">
                        </div>
                      </div>
                    </div>
                    <div class="p-6 md:p-7 pt-0 flex-shrink-0 border-t border-gray-100">
                      <div class="flex gap-3">
                        <button id="group-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                          <i class="fas fa-plus mr-2"></i>ì¶”ê°€
                        </button>
                        <button id="group-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                          ì·¨ì†Œ
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("group-add-save")
          .addEventListener("click", async () => {
            const groupName = document
              .getElementById("group-add-name")
              .value.trim();
            const groupScore =
              parseInt(document.getElementById("group-add-score").value) || 0;

            if (!groupName) {
              showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              await addGroup(groupName, groupScore);
              showAlert("âœ…", "ì¡°ëª¨ì„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document
                .getElementById("group-add-modal")
                .classList.add("hidden");
            } catch (error) {
              console.error("ì¡°ëª¨ì„ ì¶”ê°€ ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });

        document
          .getElementById("group-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("group-add-modal").classList.add("hidden");
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("group-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "group-add-modal") {
              document
                .getElementById("group-add-modal")
                .classList.add("hidden");
            }
          });
      }

      function renderRankList() {
        const container = document.getElementById("rank-list");
        if (!container) return;

        // ë…ë¦½ì ì¸ ì¡°ëª¨ì„ ë°ì´í„° ì‚¬ìš©
        console.log("renderRankList: groupsData =", groupsData);

        let rankData = groupsData.filter(
          (group) => group.name && group.score !== undefined
        );

        // ì ìˆ˜ìˆœìœ¼ë¡œ ì •ë ¬
        rankData.sort((a, b) => b.score - a.score);
        rankData = rankData.map((item, index) => ({
          ...item,
          rank: index + 1,
        }));

        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // í˜„ì¬ ì‚¬ìš©ìê°€ ì†í•œ ì¡° ì°¾ê¸°
        let userGroup = null;
        let userGroupRank = null;
        if (currentUser && currentUser.studentId) {
          userGroup = rankData.find((group) => {
            const members = group.members || [];
            return members.some((m) => {
              if (typeof m === "object") {
                return m.studentId === currentUser.studentId;
              }
              return m === currentUser.studentId || m === currentUser.name;
            });
          });
          if (userGroup) {
            userGroupRank = userGroup.rank;
          }
        }

        // ì‚¬ìš©ì ì¡°ì˜ ì•ë’¤ ì¡°ì™€ ì ìˆ˜ ì°¨ì´ ê³„ì‚°
        let prevGroup = null;
        let nextGroup = null;
        let scoreDiffPrev = null;
        let scoreDiffNext = null;

        if (userGroup) {
          // ì• ì¡° (ë” ë†’ì€ ì ìˆ˜, ë‚®ì€ ìˆœìœ„)
          if (userGroupRank > 1) {
            prevGroup = rankData.find((g) => g.rank === userGroupRank - 1);
            if (prevGroup) {
              scoreDiffPrev = prevGroup.score - userGroup.score;
            }
          }

          // ë’¤ ì¡° (ë” ë‚®ì€ ì ìˆ˜, ë†’ì€ ìˆœìœ„)
          if (userGroupRank < rankData.length) {
            nextGroup = rankData.find((g) => g.rank === userGroupRank + 1);
            if (nextGroup) {
              scoreDiffNext = userGroup.score - nextGroup.score;
            }
          }
        }

        // ì‚¬ìš©ì ì¡° ê°•ì¡° í‘œì‹œ (ìƒë‹¨)
        let userGroupHTML = "";
        if (userGroup) {
          userGroupHTML = `
                  <div class="mb-6 pb-6 border-b-4 border-orange-400">
                    <div class="bg-gradient-to-br from-orange-400 to-orange-600 rounded-2xl p-6 shadow-xl">
                      <div class="text-center mb-4">
                        <div class="text-5xl font-black text-white mb-2">${userGroupRank}ìœ„</div>
                        <div class="text-3xl font-bold text-white mb-4">${saf(
                          userGroup.name
                        )}</div>
                        <div class="text-4xl font-black text-yellow-200">${
                          userGroup.score
                        }ì </div>
                      </div>

                      <div class="grid grid-cols-2 gap-4 mt-4">
                        ${
                          prevGroup
                            ? `
                            <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 text-center">
                              <div class="text-xs text-orange-100 mb-1">${
                                prevGroup.rank
                              }ìœ„</div>
                              <div class="text-lg font-bold text-white mb-1">${saf(
                                prevGroup.name
                              )}</div>
                              <div class="text-2xl font-black text-yellow-200">${
                                prevGroup.score
                              }ì </div>
                              ${
                                scoreDiffPrev !== null
                                  ? `<div class="text-sm mt-2 ${
                                      scoreDiffPrev > 0
                                        ? "text-red-200"
                                        : "text-green-200"
                                    }">
                                    <i class="fas ${
                                      scoreDiffPrev > 0
                                        ? "fa-arrow-up"
                                        : "fa-equals"
                                    } mr-1"></i>
                                    ${
                                      scoreDiffPrev > 0
                                        ? `${scoreDiffPrev}ì  ì°¨ì´`
                                        : "ë™ì "
                                    }
                                  </div>`
                                  : ""
                              }
                            </div>
                          `
                            : `<div class="bg-white/10 rounded-xl p-4 text-center">
                              <div class="text-sm text-orange-100">ìœ„ì¹˜ ì—†ìŒ</div>
                            </div>`
                        }

                        ${
                          nextGroup
                            ? `
                            <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4 text-center">
                              <div class="text-xs text-orange-100 mb-1">${
                                nextGroup.rank
                              }ìœ„</div>
                              <div class="text-lg font-bold text-white mb-1">${saf(
                                nextGroup.name
                              )}</div>
                              <div class="text-2xl font-black text-yellow-200">${
                                nextGroup.score
                              }ì </div>
                              ${
                                scoreDiffNext !== null
                                  ? `<div class="text-sm mt-2 text-green-200">
                                    <i class="fas fa-arrow-down mr-1"></i>
                                    ${scoreDiffNext}ì  ì•ì„œìˆìŒ
                                  </div>`
                                  : ""
                              }
                            </div>
                          `
                            : `<div class="bg-white/10 rounded-xl p-4 text-center">
                              <div class="text-sm text-orange-100">ìœ„ì¹˜ ì—†ìŒ</div>
                            </div>`
                        }
                      </div>
                    </div>
                  </div>
                `;
        }

        // ì „ì²´ ìˆœìœ„ ëª©ë¡ (ì•„ë˜ ìŠ¤í¬ë¡¤ ì˜ì—­) - ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€
        const allRanksHTML = `
                <div class="mt-6">
                  <button
                    id="toggle-all-ranks-btn"
                    type="button"
                    class="w-full bg-orange-100 hover:bg-orange-200 text-orange-800 font-semibold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 mb-3"
                  >
                    <i class="fas fa-list-ol"></i>
                    <span id="toggle-all-ranks-text">ì „ì²´ ìˆœìœ„ ë³´ê¸°</span>
                    <i class="fas fa-chevron-down transition-transform" id="toggle-all-ranks-icon"></i>
                  </button>
                  <div id="all-ranks-list" class="hidden space-y-2">
                    ${rankData
                      .map(
                        (item, index) => `
                      <div class="p-3 rounded-lg relative ${
                        userGroup && item.id === userGroup.id
                          ? "bg-orange-100 border-2 border-orange-400"
                          : "bg-gray-50 border border-gray-200"
                      }">
                        <div class="flex items-center justify-between mb-2">
                          <div class="flex items-center gap-3">
                            <div class="text-2xl font-bold ${
                              userGroup && item.id === userGroup.id
                                ? "text-orange-600"
                                : "text-gray-600"
                            }">${item.rank}ìœ„</div>
                            <div class="font-bold ${
                              userGroup && item.id === userGroup.id
                                ? "text-orange-800"
                                : "text-gray-800"
                            }">${item.name}</div>
                            ${
                              userGroup && item.id === userGroup.id
                                ? '<span class="px-2 py-0.5 bg-orange-500 text-white text-xs font-bold rounded">ë‚´ ì¡°</span>'
                                : ""
                            }
                          </div>
                          <div class="text-xl font-bold ${
                            userGroup && item.id === userGroup.id
                              ? "text-orange-600"
                              : "text-gray-600"
                          }">${item.score}ì </div>
                        </div>
                        ${
                          item.members &&
                          item.members.length > 0 &&
                          currentUser &&
                          adminList.includes(currentUser.studentId)
                            ? `<div class="text-sm text-gray-600 mb-2">${
                                typeof item.members[0] === "object"
                                  ? item.members
                                      .map((m) => m.name || m.studentId)
                                      .join(", ")
                                  : item.members.join(", ")
                              }</div>`
                            : ""
                        }
                        ${
                          isAdmin
                            ? `
                          <div class="flex gap-1 justify-start">
                            <button class="edit-group-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors"
                                    data-group-id="${
                                      item.id
                                    }" data-group-name="${saf(
                                item.name
                              )}" data-group-score="${item.score}" title="ìˆ˜ì •">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-group-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors"
                                    data-group-id="${
                                      item.id
                                    }" data-group-name="${saf(
                                item.name
                              )}" title="ì‚­ì œ">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        `
                            : ""
                        }
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>
              `;

        const adminControls = document.getElementById("rank-admin-controls");
        const adminActions = document.getElementById("rank-admin-actions");

        if (isAdmin) {
          adminControls?.classList.remove("hidden");
          adminActions?.classList.remove("hidden");
        } else {
          adminControls?.classList.add("hidden");
          adminActions?.classList.add("hidden");
        }

        container.innerHTML =
          userGroupHTML + allRanksHTML ||
          `<div class="text-center text-gray-400 py-4">
                  <i class="fas fa-info-circle text-2xl mb-2"></i>
                  <p>ì¡°ëª¨ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                  <p class="text-sm mt-1">ê´€ë¦¬ìê°€ ì¡°ëª¨ì„ì„ ì¶”ê°€í•˜ë©´ ìˆœìœ„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>`;

        // ì „ì²´ ìˆœìœ„ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€ (innerHTML ì„¤ì • í›„)
        const toggleAllRanksBtn = container.querySelector(
          "#toggle-all-ranks-btn"
        );
        const allRanksList = container.querySelector("#all-ranks-list");
        const toggleAllRanksText = container.querySelector(
          "#toggle-all-ranks-text"
        );
        const toggleAllRanksIcon = container.querySelector(
          "#toggle-all-ranks-icon"
        );

        if (
          toggleAllRanksBtn &&
          allRanksList &&
          toggleAllRanksText &&
          toggleAllRanksIcon
        ) {
          toggleAllRanksBtn.addEventListener("click", () => {
            const isHidden = allRanksList.classList.contains("hidden");
            if (isHidden) {
              allRanksList.classList.remove("hidden");
              toggleAllRanksText.textContent = "ì „ì²´ ìˆœìœ„ ìˆ¨ê¸°ê¸°";
              toggleAllRanksIcon.style.transform = "rotate(180deg)";
            } else {
              allRanksList.classList.add("hidden");
              toggleAllRanksText.textContent = "ì „ì²´ ìˆœìœ„ ë³´ê¸°";
              toggleAllRanksIcon.style.transform = "rotate(0deg)";
            }
          });
        }

        // ì¡°ëª¨ì„ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (isAdmin) {
          container.querySelectorAll(".edit-group-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const groupId = btn.dataset.groupId;
              const groupName = btn.dataset.groupName;
              const groupScore = btn.dataset.groupScore;
              openGroupEditModal(groupId, groupName, groupScore);
            });
          });

          container.querySelectorAll(".delete-group-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const groupId = btn.dataset.groupId;
              const groupName = btn.dataset.groupName;

              if (confirm(`ì •ë§ë¡œ "${groupName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                  await deleteGroup(groupId);
                  showAlert("âœ…", "ì¡°ëª¨ì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (error) {
                  console.error("ì¡°ëª¨ì„ ì‚­ì œ ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });
          });
        }

        // íšŒì¥ë‹¨ì´ë©´ ìë™ìœ¼ë¡œ ì ìˆ˜ ë³€ê²½ ê¸°ë¡ í‘œì‹œ
        const isPresidentOrVice =
          currentUser &&
          (currentUser.position === "íšŒì¥" ||
            currentUser.position === "ë¶€íšŒì¥");

        const historySection = document.getElementById("rank-history-section");
        if (isPresidentOrVice && historySection) {
          historySection.classList.remove("hidden");
          loadGroupScoreHistory();
        } else if (historySection) {
          historySection.classList.add("hidden");
        }
      }

      // ì ìˆ˜ ë³€ê²½ ê¸°ë¡ ë¡œë“œ (íšŒì¥/ë¶€íšŒì¥ë§Œ)
      function loadGroupScoreHistory() {
        const isUserAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!currentUser || !isUserAdmin) return;

        const unsubscribe = onSnapshot(
          collection(db, "groupScoreHistory"),
          (snapshot) => {
            markRealtimeHealthy();
            const history = [];
            snapshot.forEach((doc) => {
              history.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            history.sort((a, b) => b.timestamp - a.timestamp);

            // ì¡°ëª¨ì„ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
            const rankModal = document.getElementById("rank-modal");
            if (rankModal && !rankModal.classList.contains("hidden")) {
              renderRankHistory(history);
            }
          },
          (error) => {
            console.error("ì ìˆ˜ ë³€ê²½ ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
            handleRealtimeListenerError("groupScoreHistory", error);
          }
        );

        return unsubscribe;
      }

      // ì ìˆ˜ ë³€ê²½ ê¸°ë¡ ë Œë”ë§
      function renderRankHistory(history) {
        const container = document.getElementById("rank-history-list");
        if (!container) return;

        if (history.length === 0) {
          container.innerHTML =
            '<p class="text-gray-400 text-center py-4">ë³€ê²½ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        container.innerHTML = history
          .map((record) => {
            const actionText =
              record.action === "added"
                ? "ì¶”ê°€"
                : record.action === "deleted"
                ? "ì‚­ì œ"
                : "ìˆ˜ì •";
            const actionIcon =
              record.action === "added"
                ? "â•"
                : record.action === "deleted"
                ? "ğŸ—‘ï¸"
                : "âœï¸";

            return `
                  <div class="flex items-center justify-between p-2 bg-white rounded border">
                    <div class="flex items-center gap-2">
                      <span class="text-lg">${actionIcon}</span>
                      <div>
                        <div class="font-medium text-gray-800">${saf(
                          record.groupName
                        )}</div>
                              <div class="text-xs text-gray-500">${
                                record.changedBy
                              }</div>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="text-sm font-semibold">
                        ${
                          record.action === "added"
                            ? `+${record.newScore}`
                            : record.action === "deleted"
                            ? `-${record.oldScore}`
                            : `${record.oldScore} â†’ ${record.newScore}`
                        }
                      </div>
                      <div class="text-xs text-gray-500">
                        ${new Date(record.timestamp).toLocaleString()}
                      </div>
                    </div>
                  </div>
                `;
          })
          .join("");
      }

      // ì¡°ëª¨ì„ ìˆœìœ„ ì €ì¥ í•¨ìˆ˜
      async function saveGroupRankings() {
        try {
          console.log("=== ì¡°ëª¨ì„ ìˆœìœ„ ì €ì¥ ì‹œì‘ ===");
          console.log("í˜„ì¬ groupsData:", groupsData);

          // í˜„ì¬ groupsDataë¥¼ ì ìˆ˜ìˆœìœ¼ë¡œ ì •ë ¬
          const sortedGroups = [...groupsData].sort(
            (a, b) => (b.score || 0) - (a.score || 0)
          );

          console.log("ì •ë ¬ëœ groups:", sortedGroups);

          // Firebaseì— ê° ê·¸ë£¹ì˜ ìˆœìœ„ ì—…ë°ì´íŠ¸
          const batch = writeBatch(db);

          sortedGroups.forEach((group, index) => {
            const groupRef = doc(db, "groups", group.id);
            batch.update(groupRef, {
              order: index + 1,
              lastUpdated: new Date(),
            });
          });

          await batch.commit();

          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");
          showAlert("âœ…", "ì¡°ëª¨ì„ ìˆœìœ„ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

          // ì¡°ëª¨ì„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          renderRankList();
        } catch (error) {
          console.error("ì¡°ëª¨ì„ ìˆœìœ„ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ìˆœìœ„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì¡°ëª¨ì„ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
      window.openGroupEditModal = function (groupId, groupName, groupScore) {
        const modal = document.getElementById("group-edit-modal");
        if (!modal) {
          createGroupEditModal();
        }

        // ì…ë ¥ í•„ë“œì— ê¸°ì¡´ ê°’ ì„¤ì •
        document.getElementById("group-edit-id").value = groupId;
        document.getElementById("group-edit-name").value = groupName;
        document.getElementById("group-edit-score").value = groupScore;

        document.getElementById("group-edit-modal").classList.remove("hidden");
      };

      // ì¡°ëª¨ì„ ìˆ˜ì • ëª¨ë‹¬ ìƒì„±
      function createGroupEditModal() {
        const modalHTML = `
                <div id="group-edit-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white rounded-2xl shadow-xl max-w-md w-full flex flex-col max-h-[90vh]">
                    <div class="p-6 md:p-7 flex-shrink-0">
                      <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ… ì¡°ëª¨ì„ ìˆ˜ì •</h3>
                      <div class="space-y-4">
                        <input id="group-edit-id" type="hidden">
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">ì¡°ëª¨ì„ ì´ë¦„</label>
                          <input id="group-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì˜ˆ: 1ì¡°, Aì¡°, ê¹€ì¹˜ì¡°">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">ì ìˆ˜</label>
                          <input id="group-edit-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0">
                        </div>
                      </div>
                    </div>
                    <div class="p-6 md:p-7 pt-0 flex-shrink-0 border-t border-gray-100">
                      <div class="flex gap-3">
                        <button id="group-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                          <i class="fas fa-save mr-2"></i>ìˆ˜ì •
                        </button>
                        <button id="group-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                          ì·¨ì†Œ
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("group-edit-save")
          .addEventListener("click", async () => {
            const groupId = document.getElementById("group-edit-id").value;
            const groupName = document
              .getElementById("group-edit-name")
              .value.trim();
            const groupScore =
              parseInt(document.getElementById("group-edit-score").value) || 0;

            if (!groupName) {
              showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              await updateGroup(groupId, groupName, groupScore);
              showAlert("âœ…", "ì¡°ëª¨ì„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document
                .getElementById("group-edit-modal")
                .classList.add("hidden");
            } catch (error) {
              console.error("ì¡°ëª¨ì„ ìˆ˜ì • ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });

        document
          .getElementById("group-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("group-edit-modal").classList.add("hidden");
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("group-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "group-edit-modal") {
              document
                .getElementById("group-edit-modal")
                .classList.add("hidden");
            }
          });
      }

      // ì¡°ëª¨ì„ ìˆ˜ì • í•¨ìˆ˜
      async function updateGroup(groupId, name, score) {
        // ìˆ˜ì • ì „ ì¡°ëª¨ì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const groupToUpdate = groupsData.find((g) => g.id === groupId);
        const oldScore = groupToUpdate ? groupToUpdate.score || 0 : 0;

        const groupRef = doc(db, "groups", groupId);
        await updateDoc(groupRef, {
          name: name,
          score: score,
          lastUpdated: new Date().toISOString(),
        });

        // ì¡°ëª¨ì„ ìˆ˜ì • ê¸°ë¡ ì €ì¥ (íšŒì¥/ë¶€íšŒì¥ë§Œ ë³¼ ìˆ˜ ìˆìŒ)
        if (groupToUpdate && oldScore !== score) {
          await addDoc(collection(db, "groupScoreHistory"), {
            groupId: groupId,
            groupName: name,
            oldScore: oldScore,
            newScore: score,
            changedBy: currentUser.name,
            changedByStudentId: currentUser.studentId,
            timestamp: new Date(),
            date: new Date().toISOString().split("T")[0],
            action: "updated",
          });
        }
      }

      // ì¡°ëª¨ì„ ì‚­ì œ í•¨ìˆ˜
      async function deleteGroup(groupId) {
        // ì‚­ì œ ì „ ì¡°ëª¨ì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const groupToDelete = groupsData.find((g) => g.id === groupId);

        const groupRef = doc(db, "groups", groupId);
        await deleteDoc(groupRef);

        // ì¡°ëª¨ì„ ì‚­ì œ ê¸°ë¡ ì €ì¥ (íšŒì¥/ë¶€íšŒì¥ë§Œ ë³¼ ìˆ˜ ìˆìŒ)
        if (groupToDelete) {
          await addDoc(collection(db, "groupScoreHistory"), {
            groupId: groupId,
            groupName: groupToDelete.name,
            oldScore: groupToDelete.score || 0,
            newScore: 0,
            changedBy: currentUser.name,
            changedByStudentId: currentUser.studentId,
            timestamp: new Date(),
            date: new Date().toISOString().split("T")[0],
            action: "deleted",
          });
        }
      }

      // ì¡°ëª¨ì„ ì¶”ê°€ í•¨ìˆ˜
      async function addGroup(name, score) {
        const docRef = await addDoc(collection(db, "groups"), {
          name: name,
          score: score || 0,
          members: [],
          lastUpdated: new Date().toISOString(),
        });

        // ì¡°ëª¨ì„ ì¶”ê°€ ê¸°ë¡ ì €ì¥ (íšŒì¥/ë¶€íšŒì¥ë§Œ ë³¼ ìˆ˜ ìˆìŒ)
        await addDoc(collection(db, "groupScoreHistory"), {
          groupId: docRef.id,
          groupName: name,
          oldScore: 0,
          newScore: score || 0,
          changedBy: currentUser.name,
          changedByStudentId: currentUser.studentId,
          timestamp: new Date(),
          date: new Date().toISOString().split("T")[0],
          action: "added",
        });
      }

      // íŒ€ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
      function openTeamEditModal(teamIndex, teamName, teamScore) {
        const modal = document.getElementById("team-edit-modal");
        if (!modal) {
          // íŒ€ ìˆ˜ì • ëª¨ë‹¬ì´ ì—†ìœ¼ë©´ ìƒì„±
          createTeamEditModal();
        }

        // ê¸°ì¡´ ê°’ ì„¤ì •
        document.getElementById("team-edit-name").value = teamName;
        document.getElementById("team-edit-score").value = teamScore;
        document.getElementById("team-edit-index").value = teamIndex;

        modal.classList.remove("hidden");
      }

      // íŒ€ ìˆ˜ì • ëª¨ë‹¬ ìƒì„±
      function createTeamEditModal() {
        const modalHTML = `
                <div id="team-edit-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
                  <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">íŒ€ ì •ë³´ ìˆ˜ì •</h3>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">íŒ€ ì´ë¦„</label>
                        <input id="team-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="íŒ€ ì´ë¦„">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì ìˆ˜</label>
                        <input id="team-edit-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì ìˆ˜">
                      </div>
                      <input id="team-edit-index" type="hidden">
                    </div>
                    <div class="flex gap-3 mt-6">
                      <button id="team-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                      </button>
                      <button id="team-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                </div>
              `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("team-edit-save")
          .addEventListener("click", async () => {
            const teamIndex = parseInt(
              document.getElementById("team-edit-index").value
            );
            const teamName = document
              .getElementById("team-edit-name")
              .value.trim();
            const teamScore =
              parseInt(document.getElementById("team-edit-score").value) || 0;

            if (!teamName) {
              showAlert("ğŸ˜¥", "íŒ€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            await updateTeamInScoreBlock(teamIndex, teamName, teamScore);
            showAlert("âœ…", "íŒ€ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("team-edit-modal").classList.add("hidden");
            renderRankList(); // ìˆœìœ„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          });

        document
          .getElementById("team-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("team-edit-modal").classList.add("hidden");
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("team-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "team-edit-modal") {
              document
                .getElementById("team-edit-modal")
                .classList.add("hidden");
            }
          });
      }

      // ì ìˆ˜íŒ ë¸”ë¡ì—ì„œ íŒ€ ì‚­ì œ
      async function deleteTeamFromScoreBlock(teamIndex) {
        const scoreBlocks =
          blocksData?.filter((b) => b.type === "scores") || [];
        if (scoreBlocks.length === 0) return;

        const scoreBlock = scoreBlocks[0];
        const teams = scoreBlock.payload?.teams || [];

        if (teamIndex >= 0 && teamIndex < teams.length) {
          teams.splice(teamIndex, 1);

          // Firebase ì—…ë°ì´íŠ¸
          const blockRef = doc(db, "homepageBlocks", scoreBlock.id);
          await updateDoc(blockRef, {
            payload: { teams: teams },
          });
        }
      }

      // ì ìˆ˜íŒ ë¸”ë¡ì—ì„œ íŒ€ ìˆ˜ì •
      async function updateTeamInScoreBlock(teamIndex, teamName, teamScore) {
        const scoreBlocks =
          blocksData?.filter((b) => b.type === "scores") || [];
        if (scoreBlocks.length === 0) return;

        const scoreBlock = scoreBlocks[0];
        const teams = scoreBlock.payload?.teams || [];

        if (teamIndex >= 0 && teamIndex < teams.length) {
          teams[teamIndex] = {
            name: teamName,
            score: teamScore,
          };

          // Firebase ì—…ë°ì´íŠ¸
          const blockRef = doc(db, "homepageBlocks", scoreBlock.id);
          await updateDoc(blockRef, {
            payload: { teams: teams },
          });
        }
      }

      /* ===== ìë™ ë¡œê·¸ì¸ ===== */
      const AUTO_LOGIN_KEY = "foodie_auto_login";
      const KEYCHAIN_SERVICE = "foodie_web_service";

      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
      function saveAutoLogin(studentId, password) {
        try {
          const loginData = {
            studentId: studentId,
            password: password,
            timestamp: Date.now(),
          };

          // localStorageì— ì €ì¥
          localStorage.setItem(AUTO_LOGIN_KEY, JSON.stringify(loginData));

          // Apple Keychain ì§€ì› (iOS Safari)
          if (window.CredentialManager && window.CredentialManager.store) {
            window.CredentialManager.store({
              service: KEYCHAIN_SERVICE,
              username: studentId,
              password: password,
            }).catch((err) => console.log("Keychain ì €ì¥ ì‹¤íŒ¨:", err));
          }

          console.log("ìë™ ë¡œê·¸ì¸ ì •ë³´ ì €ì¥ë¨");
        } catch (error) {
          console.error("ìë™ ë¡œê·¸ì¸ ì €ì¥ ì˜¤ë¥˜:", error);
        }
      }

      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadAutoLogin() {
        try {
          // localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
          const saved = localStorage.getItem(AUTO_LOGIN_KEY);
          if (saved) {
            const loginData = JSON.parse(saved);
            // ì˜êµ¬ ì €ì¥ (ê¸°ê°„ ì œí•œ ì—†ìŒ)
            return loginData;
          }

          // Apple Keychainì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (iOS Safari)
          if (window.CredentialManager && window.CredentialManager.get) {
            return window.CredentialManager.get({
              service: KEYCHAIN_SERVICE,
            })
              .then((credential) => {
                if (credential) {
                  return {
                    studentId: credential.username,
                    password: credential.password,
                    timestamp: Date.now(),
                  };
                }
                return null;
              })
              .catch((err) => {
                console.log("Keychain ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                return null;
              });
          }

          return null;
        } catch (error) {
          console.error("ìë™ ë¡œê·¸ì¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
          return null;
        }
      }

      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
      function clearAutoLogin() {
        try {
          localStorage.removeItem(AUTO_LOGIN_KEY);

          if (window.CredentialManager && window.CredentialManager.delete) {
            window.CredentialManager.delete({
              service: KEYCHAIN_SERVICE,
            }).catch((err) => console.log("Keychain ì‚­ì œ ì‹¤íŒ¨:", err));
          }

          console.log("ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œë¨");
        } catch (error) {
          console.error("ìë™ ë¡œê·¸ì¸ ì‚­ì œ ì˜¤ë¥˜:", error);
        }
      }

      // ìë™ ë¡œê·¸ì¸ ì‹œë„
      async function attemptAutoLogin() {
        try {
          const loginData = await loadAutoLogin();
          if (!loginData) return false;

          // ë¡œê·¸ì¸ í¼ì— ê°’ ì„¤ì •
          const studentIdInput = document.getElementById("studentId");
          const studentNameInput = document.getElementById("studentName");

          if (studentIdInput && studentNameInput) {
            studentIdInput.value = loginData.studentId;
            studentNameInput.value = loginData.password; // ì´ë¦„ì´ íŒ¨ìŠ¤ì›Œë“œ ì—­í• 

            // ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ ì²´í¬
            const autoLoginCheckbox = document.getElementById(
              "auto-login-checkbox"
            );
            if (autoLoginCheckbox) {
              autoLoginCheckbox.checked = true;
            }

            // ìë™ ë¡œê·¸ì¸ ì‹œë„
            await login();
            return true;
          }

          return false;
        } catch (error) {
          console.error("ìë™ ë¡œê·¸ì¸ ì‹œë„ ì˜¤ë¥˜:", error);
          return false;
        }
      }

      /* ===== ë­ë¨¹ì§€? ë©”ë‰´ ì¶”ì²œ ===== */

      // ë©”ë‰´ ë°ì´í„°ë² ì´ìŠ¤ (í•œì‹Â·ì¼ì‹Â·ì¤‘ì‹Â·ì–‘ì‹ + ë””ì €íŠ¸)
      // ì´ 480ê°œ ë©”ë‰´ (ì•„ì¹¨ 120ê°œ, ì ì‹¬ 120ê°œ, ì €ë… 120ê°œ, ë””ì €íŠ¸ 30ê°œ)
      // ìŒì‹ ì¹´í…Œê³ ë¦¬ ì •ì˜ (ë¯¸ì‹íšŒ ì¹´í…Œê³ ë¦¬ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
      const foodCategories = [
        {
          id: "korean",
          name: "í•œì‹",
          emoji: "ğŸš",
          color: "from-red-500 to-orange-500",
        },
        {
          id: "japanese",
          name: "ì¼ì‹",
          emoji: "ğŸ£",
          color: "from-pink-500 to-red-500",
        },
        {
          id: "chinese",
          name: "ì¤‘ì‹",
          emoji: "ğŸ¥Ÿ",
          color: "from-yellow-500 to-red-600",
        },
        {
          id: "western",
          name: "ì–‘ì‹",
          emoji: "ğŸ",
          color: "from-orange-500 to-yellow-500",
        },
        {
          id: "asian",
          name: "ì•„ì‹œì•ˆ",
          emoji: "ğŸœ",
          color: "from-green-500 to-teal-500",
        },
        {
          id: "snack",
          name: "ë¶„ì‹",
          emoji: "ğŸ¥˜",
          color: "from-orange-400 to-red-400",
        },
        {
          id: "dessert",
          name: "ë””ì €íŠ¸",
          emoji: "ğŸ°",
          color: "from-purple-500 to-pink-500",
        },
        {
          id: "cafe",
          name: "ì¹´í˜",
          emoji: "â˜•",
          color: "from-amber-600 to-orange-600",
        },
        {
          id: "fastfood",
          name: "íŒ¨ìŠ¤íŠ¸í‘¸ë“œ",
          emoji: "ğŸ”",
          color: "from-yellow-600 to-red-600",
        },
      ];

      // ë­ë¨¹ì§€ ë©”ë‰´ ë°ì´í„° (Firebaseì—ì„œ ë¡œë“œ)
      let foodMenusData = [];
      let selectedCategory = "all";
      let excludedTodayMenus = []; // ì˜¤ëŠ˜ ì œì™¸ëœ ë©”ë‰´ë“¤
      let isRouletteSpinning = false;
      let rouletteHistory = []; // ì¶”ì²œëœ ë©”ë‰´ íˆìŠ¤í† ë¦¬

      // ë©”ë‰´ ì¶”ì²œ ëª¨ë‹¬ ì—´ê¸°
      function openFoodRecommendModal() {
        const modal = document.getElementById("food-recommend-modal");
        if (!modal) return;

        modal.classList.remove("hidden");
        // ë¯¸ì‹íšŒ ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ë©”ë‰´ ë¡œë“œ
        if (eventsData && eventsData.length > 0) {
          loadFoodMenus();
        } else {
          // eventsDataê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
          foodMenusData = [];
          console.log(
            "ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
          );
        }
        updateCategoryFilter();

        // íšŒì¥ë‹¨ ê¶Œí•œ í™•ì¸
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // ë¹ ë¥¸ ë©”ë‰´ ì¶”ê°€ì™€ ë©”ë‰´ ê´€ë¦¬ ë²„íŠ¼ ìˆ¨ê¹€ (ë¯¸ì‹íšŒ ë¦¬ë·°ì—ì„œ ìë™ìœ¼ë¡œ ë¡œë“œ)
        const quickAddSection = document.getElementById("quick-add-section");
        const menuManageBtn = document.getElementById("menu-manage-btn");
        if (quickAddSection) quickAddSection.classList.add("hidden");
        if (menuManageBtn) menuManageBtn.classList.add("hidden");

        // ë£°ë › ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹
        const rouletteEmoji = document.getElementById("roulette-emoji");
        const rouletteText = document.getElementById("roulette-text");
        if (rouletteEmoji) rouletteEmoji.textContent = "ğŸ½ï¸";
        if (rouletteText) {
          if (foodMenusData.length > 0) {
            rouletteText.textContent = "ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”!";
          } else {
            rouletteText.textContent = "ë¯¸ì‹íšŒì— ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.";
          }
        }

        // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
        updateRouletteHistory();
      }

      // ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ IDë¡œ ë³€í™˜
      function getCategoryId(categoryName) {
        const categoryMap = {
          í•œì‹: "korean",
          ì¼ì‹: "japanese",
          ì¤‘ì‹: "chinese",
          ì–‘ì‹: "western",
          ì•„ì‹œì•ˆ: "asian",
          ë¶„ì‹: "snack",
          ë””ì €íŠ¸: "dessert",
          ì¹´í˜: "cafe",
          íŒ¨ìŠ¤íŠ¸í‘¸ë“œ: "fastfood",
          ê¸°íƒ€: "etc",
        };
        return categoryMap[categoryName] || "etc";
      }

      // ë¯¸ì‹íšŒ ë¦¬ë·°ì—ì„œ ë©”ë‰´ ë¡œë“œ
      function loadFoodMenus() {
        try {
          foodMenusData = [];

          // ë¯¸ì‹íšŒ ì´ë²¤íŠ¸ì—ì„œ ë©”ë‰´ ì¶”ì¶œ
          if (eventsData && Array.isArray(eventsData)) {
            eventsData.forEach((event) => {
              if (
                event.type === "tasting" &&
                event.restaurants &&
                Array.isArray(event.restaurants)
              ) {
                event.restaurants.forEach((restaurant) => {
                  if (restaurant.name && restaurant.info) {
                    // ëŒ€í‘œ ë©”ë‰´ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬
                    const menus = restaurant.info
                      .split("\n")
                      .filter((m) => m.trim());

                    menus.forEach((menu) => {
                      if (menu.trim()) {
                        const categoryName =
                          restaurant.restaurantCategory || "ê¸°íƒ€";
                        // ì‹ë‹¹ ì´ë¦„ - ë©”ë‰´ í˜•ì‹ìœ¼ë¡œ ì €ì¥
                        foodMenusData.push({
                          id: `tasting_${event.id}_${
                            restaurant.name
                          }_${menu.trim()}`,
                          name: `${restaurant.name} - ${menu.trim()}`,
                          category: getCategoryId(categoryName), // ì¹´í…Œê³ ë¦¬ IDë¡œ ë³€í™˜
                          categoryName: categoryName, // ì›ë³¸ ì¹´í…Œê³ ë¦¬ ì´ë¦„ë„ ì €ì¥
                          restaurantName: restaurant.name,
                          menuName: menu.trim(),
                          source: "tasting",
                        });
                      }
                    });
                  }
                });
              }
            });
          }

          console.log("ë¯¸ì‹íšŒ ë©”ë‰´ ë¡œë“œë¨:", foodMenusData.length, "ê°œ");
        } catch (error) {
          console.error("ë©”ë‰´ ë¡œë“œ ì˜¤ë¥˜:", error);
        }
      }

      // ì¹´í…Œê³ ë¦¬ í•„í„° ì—…ë°ì´íŠ¸
      function updateCategoryFilter() {
        const filterBtns = document.querySelectorAll(".category-filter-btn");
        filterBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            filterBtns.forEach((b) => {
              b.classList.remove("active", "bg-orange-500", "text-white");
              b.classList.add("bg-gray-200", "text-gray-700");
            });
            btn.classList.add("active", "bg-orange-500", "text-white");
            btn.classList.remove("bg-gray-200", "text-gray-700");

            selectedCategory = btn.dataset.category;
          });
        });
      }

      // ë£°ë › ëŒë¦¬ê¸°
      async function spinRoulette() {
        if (isRouletteSpinning) return;

        // í•„í„°ë§ëœ ë©”ë‰´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        let availableMenus = foodMenusData.filter((menu) => {
          // ì¹´í…Œê³ ë¦¬ í•„í„°
          if (
            selectedCategory !== "all" &&
            menu.category !== selectedCategory
          ) {
            return false;
          }
          // ì˜¤ëŠ˜ ì œì™¸ í•„í„°
          if (excludedTodayMenus.includes(menu.id)) {
            return false;
          }
          return true;
        });

        if (availableMenus.length === 0) {
          showAlert(
            "ğŸ˜¥",
            "ì„ íƒí•  ìˆ˜ ìˆëŠ” ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤!\në¯¸ì‹íšŒì— ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ê±°ë‚˜ í•„í„°ì— í•´ë‹¹í•˜ëŠ” ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤."
          );
          return;
        }

        isRouletteSpinning = true;
        const spinBtn = document.getElementById("spin-roulette-btn");
        const rouletteEmoji = document.getElementById("roulette-emoji");
        const rouletteText = document.getElementById("roulette-text");
        const resultActions = document.getElementById("result-actions");

        // ë²„íŠ¼ ë¹„í™œì„±í™”
        if (spinBtn) {
          spinBtn.disabled = true;
          spinBtn.querySelector("span").innerHTML =
            '<i class="fas fa-spinner fa-spin text-2xl"></i><span class="text-lg">ëŒë¦¬ëŠ” ì¤‘...</span>';
        }

        // ë©”ë‰´ ì´ë¦„/ì‹ë‹¹ ì´ë¦„ì„ ë¶„ë¦¬í•´ì„œ í‘œì‹œí•˜ëŠ” í—¬í¼
        const getDisplayText = (menu) => {
          if (menu.restaurantName && menu.menuName) {
            return `${menu.restaurantName} Â· ${menu.menuName}`;
          }
          if (menu.name && menu.name.includes(" - ")) {
            const [rest, m] = menu.name.split(" - ");
            return `${rest} Â· ${m}`;
          }
          return menu.name || "ë©”ë‰´";
        };

        // ë£°ë › ì• ë‹ˆë©”ì´ì…˜ (2ì´ˆê°„ ë¹ ë¥´ê²Œ ë©”ë‰´ ë³€ê²½)
        const animationDuration = 2000;
        const intervalTime = 100;
        let animationInterval;

        animationInterval = setInterval(() => {
          const randomMenu =
            availableMenus[Math.floor(Math.random() * availableMenus.length)];
          const emoji = getCategoryEmoji(randomMenu.category);
          if (rouletteEmoji) {
            rouletteEmoji.textContent = emoji;
            rouletteEmoji.style.animation = "pulse 0.1s ease";
          }
          if (rouletteText) {
            rouletteText.textContent = getDisplayText(randomMenu);
          }
        }, intervalTime);

        // ìµœì¢… ë©”ë‰´ ì„ íƒ
        setTimeout(() => {
          clearInterval(animationInterval);

          const finalMenu =
            availableMenus[Math.floor(Math.random() * availableMenus.length)];
          const emoji = getCategoryEmoji(finalMenu.category);

          if (rouletteEmoji) {
            rouletteEmoji.textContent = emoji;
            rouletteEmoji.style.animation = "bounce 0.6s ease";
            setTimeout(() => (rouletteEmoji.style.animation = ""), 600);
          }
          if (rouletteText) {
            rouletteText.textContent = getDisplayText(finalMenu);
            rouletteText.style.animation = "pulse 0.6s ease";
            setTimeout(() => (rouletteText.style.animation = ""), 600);
          }

          // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
          addToRouletteHistory(finalMenu);

          // ë²„íŠ¼ ë³µì›
          if (spinBtn) {
            spinBtn.disabled = false;
            spinBtn.querySelector("span").innerHTML =
              '<i class="fas fa-dice text-2xl"></i><span class="text-lg">ë©”ë‰´ ë½‘ê¸°</span>';
          }

          isRouletteSpinning = false;
        }, animationDuration);
      }

      // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€ ë°˜í™˜
      function getCategoryEmoji(category) {
        const emojiMap = {
          korean: "ğŸš",
          japanese: "ğŸ£",
          chinese: "ğŸ¥Ÿ",
          western: "ğŸ",
          asian: "ğŸœ",
          snack: "ğŸ¥˜",
          dessert: "ğŸ°",
          cafe: "â˜•",
          etc: "ğŸ½ï¸",
        };
        return emojiMap[category] || "ğŸ½ï¸";
      }

      // íˆìŠ¤í† ë¦¬ì— ë©”ë‰´ ì¶”ê°€
      function addToRouletteHistory(menu) {
        rouletteHistory.unshift({
          ...menu,
          timestamp: new Date().toISOString(),
        });

        // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ ìœ ì§€
        if (rouletteHistory.length > 10) {
          rouletteHistory = rouletteHistory.slice(0, 10);
        }

        updateRouletteHistory();
      }

      // íˆìŠ¤í† ë¦¬ UI ì—…ë°ì´íŠ¸
      function updateRouletteHistory() {
        const historySection = document.getElementById("menu-history-section");
        const historyContainer = document.getElementById("roulette-history");

        if (!historySection || !historyContainer) return;

        if (rouletteHistory.length === 0) {
          historySection.classList.add("hidden");
          return;
        }

        historySection.classList.remove("hidden");

        historyContainer.innerHTML = rouletteHistory
          .map((menu, index) => {
            const emoji = getCategoryEmoji(menu.category);
            const time = new Date(menu.timestamp);
            const timeStr = `${time
              .getHours()
              .toString()
              .padStart(2, "0")}:${time
              .getMinutes()
              .toString()
              .padStart(2, "0")}`;

            // ì‹ë‹¹ ì´ë¦„ê³¼ ë©”ë‰´ë¥¼ ë¶„ë¦¬í•´ì„œ í‘œì‹œ
            const displayName =
              menu.restaurantName && menu.menuName
                ? `<div class="flex flex-col items-start">
                     <span class="font-semibold text-gray-900">${saf(
                       menu.restaurantName
                     )}</span>
                     <span class="text-xs text-gray-600">${saf(
                       menu.menuName
                     )}</span>
                   </div>`
                : menu.name && menu.name.includes(" - ")
                ? (() => {
                    const [restName, menuText] = menu.name.split(" - ");
                    return `<div class="flex flex-col items-start">
                      <span class="font-semibold text-gray-900">${saf(
                        restName
                      )}</span>
                      <span class="text-xs text-gray-600">${saf(
                        menuText
                      )}</span>
                    </div>`;
                  })()
                : `<span class="font-medium text-gray-900">${saf(
                    menu.name || "ë©”ë‰´"
                  )}</span>`;

            return `
                  <div class="inline-flex items-center gap-2 bg-white px-3 py-2 rounded-lg border-2 border-orange-200 text-sm shadow-sm">
                    <span class="text-lg">${emoji}</span>
                    ${displayName}
                    <span class="text-xs text-gray-400">${timeStr}</span>
                  </div>
                `;
          })
          .join("");
      }

      // ë©”ë‰´ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
      function openMenuManageModal() {
        const modal = document.getElementById("menu-manage-modal");
        if (!modal) return;

        modal.classList.remove("hidden");
        loadFoodMenus().then(() => {
          renderMenuList();
        });
      }

      // ë©”ë‰´ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
      function closeMenuManageModal() {
        const modal = document.getElementById("menu-manage-modal");
        if (modal) modal.classList.add("hidden");
      }

      // ë©”ë‰´ ëª©ë¡ ë Œë”ë§
      function renderMenuList() {
        const container = document.getElementById("menu-list-container");
        const countBadge = document.getElementById("menu-count-badge");

        if (!container) return;

        if (countBadge) countBadge.textContent = `(${foodMenusData.length}ê°œ)`;

        if (foodMenusData.length === 0) {
          container.innerHTML = `
                  <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-utensils text-4xl mb-3"></i>
                    <p>ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p class="text-sm">ìœ„ì—ì„œ ë©”ë‰´ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                  </div>
                `;
          return;
        }

        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
        const groupedMenus = {};
        foodMenusData.forEach((menu) => {
          if (!groupedMenus[menu.category]) {
            groupedMenus[menu.category] = [];
          }
          groupedMenus[menu.category].push(menu);
        });

        const categoryNames = {
          korean: "í•œì‹",
          japanese: "ì¼ì‹",
          chinese: "ì¤‘ì‹",
          western: "ì–‘ì‹",
          asian: "ì•„ì‹œì•ˆ",
          snack: "ë¶„ì‹",
          dessert: "ë””ì €íŠ¸",
          cafe: "ì¹´í˜",
          etc: "ê¸°íƒ€",
        };

        let html = "";
        Object.keys(groupedMenus).forEach((category) => {
          const emoji = getCategoryEmoji(category);
          const categoryName = categoryNames[category] || category;
          const menus = groupedMenus[category];

          html += `
                  <div class="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
                    <h5 class="font-bold text-gray-800 mb-3">
                      ${emoji} ${categoryName} <span class="text-sm text-gray-500">(${
            menus.length
          }ê°œ)</span>
                    </h5>
                    <div class="flex flex-wrap gap-2">
                      ${menus
                        .map((menu) => {
                          // ì‹ë‹¹ ì´ë¦„ê³¼ ë©”ë‰´ë¥¼ ë¶„ë¦¬í•˜ì—¬ í‘œì‹œ
                          const displayName =
                            menu.restaurantName && menu.menuName
                              ? `<div class="flex flex-col">
                                  <span class="font-semibold text-gray-800">${saf(
                                    menu.restaurantName
                                  )}</span>
                                  <span class="text-gray-600 text-xs">${saf(
                                    menu.menuName
                                  )}</span>
                                </div>`
                              : menu.name
                              ? `<div class="flex flex-col">
                                  ${
                                    menu.name.includes(" - ")
                                      ? menu.name
                                          .split(" - ")
                                          .map((part, idx) =>
                                            idx === 0
                                              ? `<span class="font-semibold text-gray-800">${saf(
                                                  part
                                                )}</span>`
                                              : `<span class="text-gray-600 text-xs">${saf(
                                                  part
                                                )}</span>`
                                          )
                                          .join("")
                                      : `<span>${saf(menu.name)}</span>`
                                  }
                                </div>`
                              : `<span>ë©”ë‰´ ì´ë¦„ ì—†ìŒ</span>`;

                          return `
                        <span class="inline-flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-gray-300 text-sm">
                          ${displayName}
                          <button
                            class="delete-menu-btn text-red-500 hover:text-red-700 transition-colors"
                            data-id="${menu.id}"
                            data-name="${
                              menu.name ||
                              (menu.restaurantName && menu.menuName
                                ? `${menu.restaurantName} - ${menu.menuName}`
                                : "")
                            }"
                          >
                            <i class="fas fa-times"></i>
                          </button>
                        </span>
                      `;
                        })
                        .join("")}
                    </div>
                  </div>
                `;
        });

        container.innerHTML = html;

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        container.querySelectorAll(".delete-menu-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const name = btn.dataset.name;

            if (confirm(`'${name}' ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              try {
                await deleteDoc(doc(db, "foodMenus", id));
                showAlert("âœ…", "ë©”ë‰´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                // onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ loadFoodMenus() ë¶ˆí•„ìš”
                renderMenuList();
              } catch (error) {
                console.error("ë©”ë‰´ ì‚­ì œ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "ë©”ë‰´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            }
          });
        });
      }

      // ëŒ€ëŸ‰ ë©”ë‰´ ì¶”ê°€
      async function bulkAddMenus() {
        const textarea = document.getElementById("bulk-menu-input");
        const categorySelect = document.getElementById("menu-category-select");

        if (!textarea || !categorySelect) return;

        const text = textarea.value.trim();
        if (!text) {
          showAlert("ğŸ˜¥", "ë©”ë‰´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const menuLines = text.split("\n").filter((line) => line.trim());
        const category = categorySelect.value;

        if (menuLines.length === 0) {
          showAlert("ğŸ˜¥", "ìœ íš¨í•œ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        try {
          const batch = writeBatch(db);
          menuLines.forEach((menuName) => {
            const docRef = doc(collection(db, "foodMenus"));
            batch.set(docRef, {
              name: menuName.trim(),
              category: category,
              createdAt: new Date().toISOString(),
              createdBy: currentUser?.studentId || "unknown",
            });
          });

          await batch.commit();
          showAlert("âœ…", `${menuLines.length}ê°œì˜ ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          textarea.value = "";
          // onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ loadFoodMenus() ë¶ˆí•„ìš”
          renderMenuList();
        } catch (error) {
          console.error("ë©”ë‰´ ì¶”ê°€ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë©”ë‰´ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë¹ ë¥¸ ë©”ë‰´ ì¶”ê°€
      async function quickAddMenu() {
        const input = document.getElementById("quick-menu-input");
        if (!input) return;

        const menuName = input.value.trim();
        if (!menuName) return;

        try {
          await addDoc(collection(db, "foodMenus"), {
            name: menuName,
            category: "etc", // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬: ê¸°íƒ€
            createdAt: new Date().toISOString(),
            createdBy: currentUser?.studentId || "unknown",
          });

          input.value = "";
          // onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ loadFoodMenus() ë¶ˆí•„ìš”
          showAlert("âœ…", `'${menuName}' ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        } catch (error) {
          console.error("ë¹ ë¥¸ ë©”ë‰´ ì¶”ê°€ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë©”ë‰´ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì „ì²´ ë©”ë‰´ ì‚­ì œ
      async function deleteAllMenus() {
        if (
          !confirm(
            "ì •ë§ë¡œ ëª¨ë“  ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          )
        ) {
          return;
        }

        try {
          const snapshot = await getDocs(collection(db, "foodMenus"));
          const batch = writeBatch(db);

          snapshot.forEach((docSnap) => {
            batch.delete(docSnap.ref);
          });

          await batch.commit();
          showAlert("âœ…", "ëª¨ë“  ë©”ë‰´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          // onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ loadFoodMenus() ë¶ˆí•„ìš”
          renderMenuList();
        } catch (error) {
          console.error("ì „ì²´ ì‚­ì œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ë­ë¨¹ì§€ ê¸°ëŠ¥)
      document.addEventListener("DOMContentLoaded", () => {
        // ë£°ë › ë²„íŠ¼
        document
          .getElementById("spin-roulette-btn")
          ?.addEventListener("click", spinRoulette);

        // ë©”ë‰´ ê´€ë¦¬ ë²„íŠ¼
        document
          .getElementById("menu-manage-btn")
          ?.addEventListener("click", openMenuManageModal);
        document
          .getElementById("menu-manage-close")
          ?.addEventListener("click", closeMenuManageModal);

        // ëŒ€ëŸ‰ ì¶”ê°€ ë²„íŠ¼
        document
          .getElementById("bulk-add-menu-btn")
          ?.addEventListener("click", bulkAddMenus);

        // ë¹ ë¥¸ ì¶”ê°€ ë²„íŠ¼
        document
          .getElementById("quick-add-btn")
          ?.addEventListener("click", quickAddMenu);

        // Enter í‚¤ë¡œ ë¹ ë¥¸ ì¶”ê°€
        document
          .getElementById("quick-menu-input")
          ?.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              quickAddMenu();
            }
          });

        // ì „ì²´ ì‚­ì œ ë²„íŠ¼
        document
          .getElementById("delete-all-menus-btn")
          ?.addEventListener("click", deleteAllMenus);
      });

      // 24ì‹œê°„ë§ˆë‹¤ ì œì™¸ ëª©ë¡ ì´ˆê¸°í™”
      setInterval(() => {
        excludedTodayMenus = [];
        console.log("ì˜¤ëŠ˜ ì œì™¸ ëª©ë¡ ì´ˆê¸°í™”ë¨");
      }, 24 * 60 * 60 * 1000);

      // ë„¤íŠ¸ì›Œí¬ ì¬ì—°ê²° ê°ì§€
      window.addEventListener("online", () => {
        console.log("ë„¤íŠ¸ì›Œí¬ ì¬ì—°ê²°ë¨, ë°ì´í„° ìƒˆë¡œê³ ì¹¨");
        if (currentUser) {
          // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
          setTimeout(() => {
            renderAll();
          }, 1000);
        }
      });

      window.addEventListener("offline", () => {
        console.warn("ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€");
        showAlert(
          "âš ï¸",
          "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.\nì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        );
      });

      // ê¸°ì¡´ ìŠ¬ë¡¯ë¨¸ì‹  ê´€ë ¨ í•¨ìˆ˜ë“¤ ì‚­ì œë¨

      /* ===== ë¬¸ì˜í•˜ê¸° íƒ­ (DEPRECATED - ìƒˆ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´ë¨) ===== */

      /* ===== ë¬¸ì˜ ëª¨ë‹¬ (DEPRECATED) ===== */
      function openInquiryModal_DEPRECATED() {
        const modal = document.getElementById("inquiry-modal");
        modal.classList.remove("hidden");
        renderInquiryList_DEPRECATED();
        setupInquirySubmit();
      }

      function renderInquiryList_DEPRECATED() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        const listContainer = document.getElementById("modal-suggestions-list");

        const list = (suggestionsData || [])
          .map(
            (s) => `
                <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow">
                  <div class="text-sm text-gray-500 flex items-center justify-between mb-2">
                    <span class="font-medium">
                      <i class="fas fa-user-circle mr-1 text-orange-500"></i>
                      ${saf(s.name || "ìµëª…")} Â· ${
              s.timestamp?.toDate
                ? s.timestamp.toDate().toLocaleDateString()
                : ""
            }
                    </span>
                    ${
                      isAdmin
                        ? `<button class="delete-suggestion px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" data-id="${s.id}">ì‚­ì œ</button>`
                        : ""
                    }
                  </div>
                  <p class="text-gray-800">${saf(s.content || "")}</p>
                </div>
              `
          )
          .join("");

        listContainer.innerHTML =
          list ||
          '<p class="text-gray-400 text-center py-4">ì•„ì§ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (isAdmin) {
          document.querySelectorAll(".delete-suggestion").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.dataset.id;
              if (!id) return;
              if (!confirm("ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
              try {
                await deleteDoc(doc(db, "suggestions", id));
                showAlert("âœ…", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderInquiryList();
              } catch (err) {
                console.warn(err);
                showAlert("ğŸ˜¥", "ì‚­ì œ ì‹¤íŒ¨");
              }
            });
          });
        }
      }

      function setupInquirySubmit() {
        const submitBtn = document.getElementById("modal-sug-submit");
        const titleInput = document.getElementById("modal-sug-title");
        const textInput = document.getElementById("modal-sug-text");

        // ì´ì „ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ë³µì œ
        const newSubmitBtn = submitBtn.cloneNode(true);
        submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);

        newSubmitBtn.onclick = async () => {
          const title = titleInput.value.trim();
          const text = textInput.value.trim();

          if (!text) return showAlert("ğŸ˜¥", "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

          try {
            await addDoc(collection(db, "suggestions"), {
              studentId: currentUser?.studentId || "",
              name: currentUser?.name || "ìµëª…",
              title,
              text,
              timestamp: serverTimestamp(),
            });

            titleInput.value = "";
            textInput.value = "";
            showAlert("âœ…", "ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê³ ë§ˆì›Œìš”!");
            renderInquiryList(); // ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ë“±ë¡ ì‹¤íŒ¨");
          }
        };
      }

      function renderSuggestionsTab(isAdmin) {
        const c = document.getElementById("suggestions-tab");
        if (!c) return;

        // suggestions íƒ­ì€ ì´ì œ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹„ì›Œë‘ 
        c.innerHTML = `
                <div class="section text-center py-12">
                  <div class="mb-4">
                    <i class="fas fa-question-circle text-6xl text-orange-500 mb-4"></i>
                  </div>
                  <h3 class="text-2xl font-bold text-gray-800 mb-3">ë¬¸ì˜í•˜ê¸°</h3>
                  <p class="text-gray-600 mb-6">ìƒë‹¨ì˜ ë¬¸ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¬¸ì˜ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>
                  <button
                    onclick="openInquiryModal()"
                    class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                    <i class="fas fa-paper-plane mr-2"></i>ë¬¸ì˜í•˜ê¸°
                  </button>
                </div>
              `;
      }

      /* ===== ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ëª¨ë‹¬ ===== */
      function openCategoryManagementModal() {
        const modalHTML = `
                <div id="category-management-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                  <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <!-- í—¤ë” -->
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4 flex items-center justify-between">
                      <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-tags"></i>
                        ì¹´í…Œê³ ë¦¬ ê´€ë¦¬
                      </h3>
                      <button id="close-category-modal" class="text-white hover:bg-white/20 rounded-full p-2 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                      </button>
                    </div>

                    <!-- ë‚´ìš© -->
                    <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                      <!-- ì¹´í…Œê³ ë¦¬ ì¶”ê°€ -->
                      <div class="mb-6 bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4 border-2 border-orange-200">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                          <i class="fas fa-plus-circle text-orange-600"></i>
                          ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
                        </h4>
                        <div class="flex gap-2">
                          <input
                            id="modal-category-name"
                            type="text"
                            placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ (ì˜ˆ: ë¶„ì‹)"
                            class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all"
                          />
                          <input
                            id="modal-category-emoji"
                            type="text"
                            placeholder="ğŸ¢"
                            class="w-20 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-center text-xl"
                            maxlength="2"
                          />
                          <button
                            id="modal-add-category-btn"
                            class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg whitespace-nowrap">
                            <i class="fas fa-plus mr-1"></i>ì¶”ê°€
                          </button>
                        </div>
                      </div>

                      <!-- í˜„ì¬ ì¹´í…Œê³ ë¦¬ ëª©ë¡ -->
                      <div>
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                          <i class="fas fa-list text-gray-600"></i>
                          í˜„ì¬ ì¹´í…Œê³ ë¦¬ ëª©ë¡
                          <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs ml-2">
                            ${restaurantCategories.length}ê°œ
                          </span>
                        </h4>
                        <div id="modal-categories-list" class="space-y-2">
                          ${restaurantCategories
                            .map(
                              (cat, index) => `
                            <div class="category-item bg-white border-2 border-gray-200 rounded-lg p-4 flex items-center justify-between hover:border-orange-300 transition-all group" data-index="${index}">
                              <div class="flex items-center gap-3 flex-1">
                                <span class="text-3xl">${cat.emoji}</span>
                                <span class="font-semibold text-gray-800">${
                                  cat.name
                                }</span>
                              </div>
                              <div class="flex items-center gap-2">
                                <button
                                  class="move-category-up px-2 py-1 bg-gray-400 hover:bg-gray-500 text-white rounded text-sm font-semibold transition-colors ${
                                    index === 0
                                      ? "opacity-30 cursor-not-allowed"
                                      : ""
                                  }"
                                  data-index="${index}"
                                  ${index === 0 ? "disabled" : ""}>
                                  <i class="fas fa-chevron-up"></i>
                                </button>
                                <button
                                  class="move-category-down px-2 py-1 bg-gray-400 hover:bg-gray-500 text-white rounded text-sm font-semibold transition-colors ${
                                    index === restaurantCategories.length - 1
                                      ? "opacity-30 cursor-not-allowed"
                                      : ""
                                  }"
                                  data-index="${index}"
                                  ${
                                    index === restaurantCategories.length - 1
                                      ? "disabled"
                                      : ""
                                  }>
                                  <i class="fas fa-chevron-down"></i>
                                </button>
                                <button
                                  class="modal-delete-category-btn px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm font-semibold transition-colors"
                                  data-index="${index}"
                                  data-name="${cat.name}">
                                  <i class="fas fa-trash"></i>
                                </button>
                              </div>
                            </div>
                          `
                            )
                            .join("")}
                        </div>
                      </div>

                      <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-800">
                          <i class="fas fa-info-circle mr-2"></i>
                          <strong>ì•ˆë‚´:</strong> ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•´ë„ ê¸°ì¡´ ì‹ë‹¹ì˜ ì¹´í…Œê³ ë¦¬ ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              `;

        // ëª¨ë‹¬ ì¶”ê°€
        document.body.insertAdjacentHTML("beforeend", modalHTML);

        const modal = document.getElementById("category-management-modal");
        const closeBtn = document.getElementById("close-category-modal");
        const addBtn = document.getElementById("modal-add-category-btn");
        const nameInput = document.getElementById("modal-category-name");
        const emojiInput = document.getElementById("modal-category-emoji");

        // ë‹«ê¸° ë²„íŠ¼
        closeBtn.addEventListener("click", () => {
          modal.remove();
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });

        // ESC í‚¤ë¡œ ë‹«ê¸°
        const escHandler = (e) => {
          if (e.key === "Escape") {
            modal.remove();
            document.removeEventListener("keydown", escHandler);
          }
        };
        document.addEventListener("keydown", escHandler);

        // ì¹´í…Œê³ ë¦¬ ì¶”ê°€
        addBtn.addEventListener("click", async () => {
          const name = nameInput.value.trim();
          const emoji = emojiInput.value.trim();

          if (!name) {
            showAlert("ğŸ˜¥", "ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          if (!emoji) {
            showAlert("ğŸ˜¥", "ì´ëª¨ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
          }

          if (restaurantCategories.some((cat) => cat.name === name)) {
            showAlert("ğŸ˜¥", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.");
            return;
          }

          try {
            const newCategories = [...restaurantCategories, { name, emoji }];
            await setDoc(doc(db, "settings", "restaurantCategories"), {
              categories: newCategories,
            });
            showAlert("âœ…", `${emoji} ${name} ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            modal.remove();
          } catch (error) {
            console.error("ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì˜¤ë¥˜:", error);
            showAlert("ğŸ˜¥", "ì¹´í…Œê³ ë¦¬ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        });

        // ì¹´í…Œê³ ë¦¬ ì‚­ì œ
        modal.addEventListener("click", async (e) => {
          const btn = e.target.closest(".modal-delete-category-btn");
          if (!btn) return;

          const index = parseInt(btn.dataset.index);
          const name = btn.dataset.name;

          if (
            !confirm(
              `"${name}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì¡´ ì‹ë‹¹ì˜ ì¹´í…Œê³ ë¦¬ ì •ë³´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.`
            )
          ) {
            return;
          }

          try {
            const newCategories = restaurantCategories.filter(
              (_, i) => i !== index
            );

            if (newCategories.length === 0) {
              showAlert("ğŸ˜¥", "ìµœì†Œ 1ê°œì˜ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìš”í•©ë‹ˆë‹¤.");
              return;
            }

            await setDoc(doc(db, "settings", "restaurantCategories"), {
              categories: newCategories,
            });
            showAlert("âœ…", `"${name}" ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            modal.remove();
          } catch (error) {
            console.error("ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì˜¤ë¥˜:", error);
            showAlert("ğŸ˜¥", "ì¹´í…Œê³ ë¦¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        });

        // ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ë²„íŠ¼ ì´ë²¤íŠ¸
        modal.addEventListener("click", async (e) => {
          // ìœ„ë¡œ ì´ë™
          const upBtn = e.target.closest(".move-category-up");
          if (upBtn && !upBtn.disabled) {
            const index = parseInt(upBtn.dataset.index);
            if (index > 0) {
              const newCategories = [...restaurantCategories];
              [newCategories[index - 1], newCategories[index]] = [
                newCategories[index],
                newCategories[index - 1],
              ];

              try {
                await setDoc(doc(db, "settings", "restaurantCategories"), {
                  categories: newCategories,
                });
                showAlert("âœ…", "ì¹´í…Œê³ ë¦¬ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                modal.remove();
              } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            }
          }

          // ì•„ë˜ë¡œ ì´ë™
          const downBtn = e.target.closest(".move-category-down");
          if (downBtn && !downBtn.disabled) {
            const index = parseInt(downBtn.dataset.index);
            if (index < restaurantCategories.length - 1) {
              const newCategories = [...restaurantCategories];
              [newCategories[index], newCategories[index + 1]] = [
                newCategories[index + 1],
                newCategories[index],
              ];

              try {
                await setDoc(doc(db, "settings", "restaurantCategories"), {
                  categories: newCategories,
                });
                showAlert("âœ…", "ì¹´í…Œê³ ë¦¬ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                modal.remove();
              } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "ì¹´í…Œê³ ë¦¬ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            }
          }
        });
      }

      /* ===== ë¡œë“œë§µ íƒ­ ===== */
      function renderRoadmapTab(isAdmin) {
        const c = document.getElementById("roadmap-tab");
        if (!c) return;

        // ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œë”© í‘œì‹œ
        if (eventsData === null || eventsData === undefined) {
          c.innerHTML = `<div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-orange-500 border-t-transparent mb-3"></div>
            <p class="text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>`;
          return;
        }

        // ë§ˆê°ëœ ì´ë²¤íŠ¸ë§Œ ê°€ì ¸ì˜¤ê¸° (ì‚­ì œëœ ì´ë²¤íŠ¸ ì œì™¸)
        const closedEvents = eventsData.filter(
          (ev) =>
            (ev.status === "closed" || ev.status === "archived") &&
            ev.status !== "deleted" &&
            ev.status !== "cancelled"
        );

        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë¶„ë¥˜
        const mtEvents = closedEvents.filter((ev) => ev.type === "mt");
        const generalEvents = closedEvents.filter(
          (ev) => ev.type === "general" || ev.type === "assembly"
        );
        const tastingEvents = closedEvents.filter(
          (ev) => ev.type === "tasting"
        );

        // ë¯¸ì‹íšŒì˜ ê²½ìš° ì‹ë‹¹ ì •ë³´ ì¶”ì¶œ (ë¦¬ë·°ê°€ ìˆëŠ” ì‹ë‹¹ë§Œ)
        const tastingRestaurants = [];
        tastingEvents.forEach((ev) => {
          if (ev.restaurants && ev.restaurants.length > 0) {
            ev.restaurants.forEach((restaurant) => {
              // ì´ ì‹ë‹¹ì„ ì‹ ì²­í•œ ì‚¬ëŒë“¤ì˜ studentId ëª©ë¡
              const participantIds = (restaurant.reservations || []).map(
                (r) => r.studentId
              );

              // ì´ ì‹ë‹¹ì„ ì‹ ì²­í•œ ì‚¬ëŒë“¤ì˜ ë¦¬ë·°ë§Œ í•„í„°ë§
              const restaurantReviews = (ev.reviews || []).filter((review) =>
                participantIds.includes(review.studentId)
              );

              // ë¦¬ë·°ê°€ ì—†ëŠ” ì‹ë‹¹ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
              if (restaurantReviews.length === 0) {
                return;
              }

              // ì¹´í…Œê³ ë¦¬ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ "ê¸°íƒ€"ë¡œ ì„¤ì •
              let restaurantCategory = restaurant.category || "ê¸°íƒ€";
              // restaurantCategoriesì— ì¡´ì¬í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì¸ì§€ í™•ì¸
              const categoryExists = restaurantCategories.some(
                (cat) => cat.name === restaurantCategory
              );
              if (!categoryExists) {
                restaurantCategory = "ê¸°íƒ€";
              }

              tastingRestaurants.push({
                eventId: ev.id,
                eventTitle: ev.title,
                eventDate: ev.datetime,
                restaurantName: restaurant.name,
                restaurantInfo: restaurant.info,
                restaurantImage: restaurant.imageUrl,
                restaurantCategory: restaurantCategory,
                capacity: restaurant.capacity ?? ev.limit ?? null,
                reservationsCount: (restaurant.reservations || []).length,
                waitingCount: (restaurant.waiting || []).length,
                participantCount: participantIds.length,
                reviews: restaurantReviews,
              });
            });
          }
        });

        // ë¯¸ì‹íšŒ ì‹ë‹¹ ì¹´ë“œ ë…¸ì¶œ ê°œìˆ˜ (ì´ˆê¸° 2ê°œ, ë”ë³´ê¸° í´ë¦­ ì‹œ 3ê°œì”© ì¶”ê°€)
        const DEFAULT_TASTING_VISIBLE_COUNT = 2;
        if (typeof window !== "undefined") {
          if (
            typeof window.tastingRestaurantsVisibleCount !== "number" ||
            window.tastingRestaurantsVisibleCount <= 0
          ) {
            window.tastingRestaurantsVisibleCount =
              DEFAULT_TASTING_VISIBLE_COUNT;
          }
        }
        const currentVisibleCount =
          typeof window !== "undefined" &&
          typeof window.tastingRestaurantsVisibleCount === "number"
            ? window.tastingRestaurantsVisibleCount
            : DEFAULT_TASTING_VISIBLE_COUNT;
        const clampedVisibleCount = Math.min(
          currentVisibleCount,
          tastingRestaurants.length
        );
        const visibleTastingRestaurants = tastingRestaurants.slice(
          0,
          clampedVisibleCount
        );

        // í‰ê·  ë³„ì  ê³„ì‚° í•¨ìˆ˜
        const calculateAverageRating = (reviews) => {
          if (!reviews || reviews.length === 0) return 0;
          const sum = reviews.reduce((acc, r) => acc + (r.rating || 0), 0);
          return (sum / reviews.length).toFixed(1);
        };

        // ë³„ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
        const renderStars = (rating) => {
          const fullStars = Math.floor(rating);
          const hasHalfStar = rating % 1 >= 0.5;
          let stars = "";
          for (let i = 0; i < fullStars; i++) {
            stars +=
              '<i class="fas fa-star text-yellow-400 text-base sm:text-lg"></i>';
          }
          if (hasHalfStar) {
            stars +=
              '<i class="fas fa-star-half-alt text-yellow-400 text-base sm:text-lg"></i>';
          }
          const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
          for (let i = 0; i < emptyStars; i++) {
            stars +=
              '<i class="far fa-star text-gray-300 text-base sm:text-lg"></i>';
          }
          return stars;
        };

        // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨í‹°ì½˜ ë°˜í™˜ í•¨ìˆ˜ (ë™ì ìœ¼ë¡œ ì²˜ë¦¬)
        const getCategoryEmoji = (category) => {
          const cat = restaurantCategories.find((c) => c.name === category);
          return cat ? cat.emoji : "ğŸ½ï¸";
        };

        // ì‹ë‹¹ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (ë¯¸ì‹íšŒìš©)
        const createRestaurantCard = (
          restaurant,
          index = 0,
          showScrollHint = false
        ) => {
          const avgRating = calculateAverageRating(restaurant.reviews);
          const reviewCount = restaurant.reviews.length;
          const categoryEmoji = getCategoryEmoji(restaurant.restaurantCategory);
          const rawCapacity =
            restaurant.capacity ??
            restaurant.limit ??
            restaurant.maxCapacity ??
            null;
          const parsedCapacity =
            rawCapacity != null ? Number(rawCapacity) : null;
          const capacity =
            parsedCapacity != null &&
            Number.isFinite(parsedCapacity) &&
            parsedCapacity > 0
              ? parsedCapacity
              : null;
          const reservationsCount = Number(
            restaurant.reservationsCount ?? restaurant.participantCount ?? 0
          );
          const spotsRemaining =
            capacity != null ? Math.max(capacity - reservationsCount, 0) : null;
          const isNearlyFull = spotsRemaining !== null && spotsRemaining === 1;
          const restaurantEventDate = toDateSafe(
            restaurant.eventDate || restaurant.eventDateTime
          );
          const restaurantEventDateLabel = restaurantEventDate
            ? restaurantEventDate.toLocaleDateString("ko-KR", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            : "ì¼ì‹œ ë¯¸ì •";

          return `
                  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 group" data-restaurant-id="${
                    restaurant.eventId
                  }">
                    ${
                      restaurant.restaurantImage
                        ? `
                      <div class="w-full h-48 overflow-hidden relative">
                        <img
                          src="${saf(restaurant.restaurantImage)}"
                          alt="${saf(restaurant.restaurantName)}"
                          class="w-full h-full object-cover"
                          onerror="this.parentElement.style.display='none'"
                        >
                        ${
                          isAdmin
                            ? `
                          <button
                            class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold shadow-lg transition-colors"
                            data-action="delete-restaurant"
                            data-event-id="${restaurant.eventId}"
                                  data-restaurant-name="${saf(
                                    restaurant.restaurantName
                                  )}"
                            title="ì‹ë‹¹ ì‚­ì œ">
                            <i class="fas fa-trash mr-1"></i>ì‹ë‹¹ ì‚­ì œ
                          </button>
                        `
                            : ""
                        }
                      </div>
                    `
                        : ""
                    }

                    <div class="p-4 sm:p-6">
                      <div class="mb-3 sm:mb-4">
                        <div class="flex items-start justify-between mb-3">
                          <div class="flex-1">
                            <div class="mb-2">
                              <div class="flex items-center gap-2 mb-2">
                                <i class="fas fa-store text-orange-600 text-sm"></i>
                                <span class="text-xs sm:text-sm font-semibold text-orange-700 uppercase tracking-wide">ì‹ë‹¹ ì´ë¦„</span>
                              </div>
                              <div class="flex flex-wrap items-start gap-3 w-full">
                                <div class="flex items-center gap-2 min-w-0 flex-1">
                                  <span class="text-2xl sm:text-3xl flex-shrink-0">${categoryEmoji}</span>
                                  <h4 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-2 truncate">
                                    ${saf(
                                      restaurant.restaurantName ||
                                        "(ì‹ë‹¹ ì´ë¦„ ì—†ìŒ)"
                                    )}
                                    ${
                                      isNearlyFull
                                        ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 text-[11px] font-semibold rounded-full bg-red-500/10 text-red-600 border border-red-200">
                                            <i class="fas fa-fire text-red-500"></i>ë§ˆê° ì„ë°•!
                                          </span>`
                                        : ""
                                    }
                                  </h4>
                                </div>
                                <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-white/80 border border-orange-200 rounded-xl text-xs sm:text-sm text-gray-600 shadow-sm w-full sm:w-auto min-w-[9rem]">
                                  <i class="fas fa-calendar text-orange-500"></i>
                                  ${restaurantEventDateLabel}
                                </span>
                              </div>
                            </div>
                          ${
                            restaurant.restaurantCategory
                              ? `<span class="inline-flex items-center gap-2 bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-semibold">
                                  <i class="fas fa-tags text-orange-500"></i>${restaurant.restaurantCategory}
                                </span>`
                              : ""
                          }
                          </div>
                          ${
                            isAdmin && !restaurant.restaurantImage
                              ? `
                            <button
                              class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold shadow transition-colors ml-2"
                              data-action="delete-restaurant"
                              data-event-id="${restaurant.eventId}"
                                    data-restaurant-name="${saf(
                                      restaurant.restaurantName
                                    )}"
                              title="ì‹ë‹¹ ì‚­ì œ">
                              <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                            </button>
                          `
                              : ""
                          }
                        </div>
                        ${
                          restaurant.restaurantInfo
                            ? `<div class="mb-4 mt-3 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-xl p-4 sm:p-5 border-2 border-orange-300 shadow-md">
                                <div class="flex items-center justify-between mb-3">
                                  <div class="flex items-center gap-2">
                                    <i class="fas fa-utensils text-orange-600 text-lg"></i>
                                    <span class="text-sm sm:text-base font-bold text-orange-900">ëŒ€í‘œ ë©”ë‰´</span>
                                  </div>
                                  ${
                                    isAdmin
                                      ? `<button
                                          class="text-xs sm:text-sm text-orange-700 hover:text-orange-800 transition-colors bg-white px-2 py-1 rounded-lg border border-orange-300"
                                          onclick="openRestaurantEditModal('${
                                            restaurant.eventId
                                          }', '${saf(
                                          restaurant.restaurantName
                                        )}', '${saf(
                                          restaurant.restaurantInfo
                                        ).replace(/'/g, "\\'")}')"
                                          title="ëŒ€í‘œ ë©”ë‰´ ìˆ˜ì •">
                                          <i class="fas fa-edit mr-1"></i>ìˆ˜ì •
                                        </button>`
                                      : ""
                                  }
                                </div>
                                <p class="text-base sm:text-lg text-gray-900 leading-relaxed font-bold">${saf(
                                  restaurant.restaurantInfo
                                )}</p>
                              </div>`
                            : ""
                        }

                        ${
                          isAdmin
                            ? `
                        <!-- ì¹´í…Œê³ ë¦¬ í‘œì‹œ (ê´€ë¦¬ì ì „ìš©) -->
                        <div class="mt-2 flex items-center gap-2">
                          <span class="text-xs sm:text-sm text-gray-500 flex items-center">
                            <i class="fas fa-tags mr-1"></i>ì¹´í…Œê³ ë¦¬:
                          </span>
                            <select
                              class="text-xs px-2 py-1 border border-gray-300 rounded-lg focus:border-orange-400 focus:outline-none bg-white"
                              data-action="update-category"
                              data-event-id="${restaurant.eventId}"
                              data-restaurant-name="${saf(
                                restaurant.restaurantName
                              )}">
                              ${restaurantCategories
                                .map(
                                  (cat) => `
                                <option value="${cat.name}" ${
                                    restaurant.restaurantCategory === cat.name
                                      ? "selected"
                                      : ""
                                  }>${cat.emoji} ${cat.name}</option>
                              `
                                )
                                .join("")}
                            </select>
                        </div>
                          `
                            : ""
                        }
                      </div>

                      ${
                        reviewCount > 0
                          ? `
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 sm:p-5 mb-4 border-2 border-orange-200 shadow-sm">
                          <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                              <div class="flex items-center gap-1">
                                ${renderStars(parseFloat(avgRating))}
                              </div>
                              <span class="text-xl sm:text-2xl font-bold text-gray-800">${avgRating}</span>
                            </div>
                            <span class="text-sm sm:text-base text-gray-700 font-semibold bg-white px-3 py-1.5 rounded-full shadow-sm">${reviewCount}ëª… í‰ê°€</span>
                          </div>

                          ${
                            restaurant.reviews.length > 0
                              ? `
                            <div class="mt-3 space-y-3">
                              <div class="mb-3">
                                <p class="text-sm sm:text-base font-bold text-gray-800 flex items-center">
                                  <i class="fas fa-comment-dots mr-2 text-orange-500"></i>í›„ê¸°
                                </p>
                              </div>
                              <div class="review-list-container relative">
                                <div class="review-list pb-4" data-event-id="${
                                  restaurant.eventId
                                }" data-restaurant-name="${saf(
                                  restaurant.restaurantName
                                )}" data-show-all="false" style="scrollbar-width: thin; scrollbar-color: #f97316 #fef3e2;">
                                ${restaurant.reviews
                                  .filter((r) => r.comment && r.comment.trim())
                                  .slice(0, 1)
                                  .map(
                                    (r) => `
                                  <div class="bg-white rounded-xl p-4 sm:p-5 border-2 border-orange-100 shadow-md hover:shadow-lg transition-shadow relative review-item mb-3">
                                    <div class="flex items-center justify-between mb-3">
                                      <span class="text-sm sm:text-base font-bold text-gray-800 flex items-center">
                                        <i class="fas fa-user-circle mr-2 text-orange-500 text-lg sm:text-xl"></i>
                                        ìµëª…
                                      </span>
                                      <div class="flex items-center gap-2">
                                        <div class="flex items-center gap-1">
                                          ${renderStars(r.rating || 0)}
                                        </div>
                                        ${
                                          isAdmin
                                            ? `
                                          <button
                                            class="text-red-500 hover:text-red-700 transition-colors p-1"
                                            data-action="delete-review"
                                            data-event-id="${restaurant.eventId}"
                                            data-student-id="${r.studentId}"
                                            title="í›„ê¸° ì‚­ì œ">
                                            <i class="fas fa-trash text-sm"></i>
                                          </button>
                                        `
                                            : ""
                                        }
                                      </div>
                                    </div>
                                    <p class="text-sm sm:text-base text-gray-700 leading-relaxed whitespace-pre-wrap">${saf(
                                      r.comment
                                    )}</p>
                                  </div>
                                `
                                  )
                                  .join("")}
                                </div>
                              </div>
                              ${
                                restaurant.reviews.filter(
                                  (r) => r.comment && r.comment.trim()
                                ).length > 1
                                  ? `<button
                                      class="w-full text-sm sm:text-base text-orange-600 hover:text-orange-700 font-bold text-center mt-3 py-3 sm:py-2 bg-orange-50 hover:bg-orange-100 rounded-xl transition-colors border-2 border-orange-200 shadow-sm"
                                      data-action="toggle-reviews"
                                      data-event-id="${restaurant.eventId}"
                                      data-restaurant-name="${saf(
                                        restaurant.restaurantName
                                      )}">
                                      <i class="fas fa-chevron-down mr-2"></i>
                                      ì™¸ ${
                                        restaurant.reviews.filter(
                                          (r) => r.comment && r.comment.trim()
                                        ).length - 1
                                      }ê°œ í›„ê¸° ë” ë³´ê¸°
                                    </button>`
                                  : ""
                              }
                            </div>
                          `
                              : ""
                          }
                        </div>
                      `
                          : `
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                          <p class="text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            ì•„ì§ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤
                          </p>
                        </div>
                      `
                      }
                    </div>
                  </div>
                `;
        };

        // ì´ë²¤íŠ¸ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (MT, ì¼ë°˜ ì´ë²¤íŠ¸ìš©)
        const createEventCard = (ev) => {
          const avgRating = calculateAverageRating(ev.reviews || []);
          const reviewCount = ev.reviews ? ev.reviews.length : 0;

          return `
                  <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-all">
                    <div class="flex items-start justify-between mb-3">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeBadgeClass(
                            ev.type
                          )}">
                            ${typeLabel(ev.type)}
                          </span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-1">${saf(
                          ev.title || "(ì œëª© ì—†ìŒ)"
                        )}</h4>
                        <p class="text-sm text-gray-600">
                          <i class="fas fa-calendar mr-1"></i>
                          ${new Date(ev.datetime).toLocaleDateString("ko-KR", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                          })}
                        </p>
                      </div>
                    </div>

                    ${
                      ev.type === "tasting" && reviewCount > 0
                        ? `
                      <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-3 mb-3">
                        <div class="flex items-center justify-between mb-2">
                          <div class="flex items-center gap-2">
                            <div class="flex items-center gap-1">
                              ${renderStars(parseFloat(avgRating))}
                            </div>
                            <span class="text-base sm:text-lg font-bold text-gray-800">${avgRating}</span>
                            <span class="text-sm text-gray-600">(${reviewCount}ëª… í‰ê°€)</span>
                          </div>
                        </div>

                        ${
                          ev.reviews && ev.reviews.length > 0
                            ? `
                          <div class="mt-4 space-y-3">
                            <p class="text-sm sm:text-base font-bold text-gray-800 mb-3 flex items-center">
                              <i class="fas fa-comment-dots mr-2 text-orange-500"></i>í›„ê¸°
                            </p>
                            ${ev.reviews
                              .filter((r) => r.comment && r.comment.trim())
                              .slice(0, 2)
                              .map(
                                (r) => `
                              <div class="bg-white rounded-xl p-4 sm:p-5 border-2 border-orange-100 shadow-md hover:shadow-lg transition-shadow mb-3">
                                <div class="flex items-center justify-between mb-3">
                                  <span class="text-sm sm:text-base font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-user-circle mr-2 text-orange-500 text-lg sm:text-xl"></i>
                                    ${saf(r.name || "ìµëª…")}
                                  </span>
                                  <div class="flex items-center gap-1">
                                    ${renderStars(r.rating || 0)}
                                  </div>
                                </div>
                                <p class="text-sm sm:text-base text-gray-700 leading-relaxed whitespace-pre-wrap">${saf(
                                  r.comment
                                )}</p>
                              </div>
                            `
                              )
                              .join("")}
                            ${
                              ev.reviews.filter(
                                (r) => r.comment && r.comment.trim()
                              ).length > 2
                                ? `<button class="w-full text-sm sm:text-base text-orange-600 hover:text-orange-700 font-bold text-center mt-3 py-3 sm:py-2 bg-orange-50 hover:bg-orange-100 rounded-xl transition-colors border-2 border-orange-200 shadow-sm">
                                    <i class="fas fa-chevron-down mr-2"></i>
                                    ì™¸ ${
                                      ev.reviews.filter(
                                        (r) => r.comment && r.comment.trim()
                                      ).length - 2
                                    }ê°œ í›„ê¸° ë” ë³´ê¸°
                                  </button>`
                                : ""
                            }
                          </div>
                        `
                            : ""
                        }
                      </div>
                    `
                        : ""
                    }

                    ${
                      ev.type !== "tasting" && reviewCount > 0
                        ? `
                      <div class="bg-gray-50 rounded-lg p-3 mb-3">
                        <p class="text-sm text-gray-600">
                          <i class="fas fa-users mr-1"></i>
                          ${reviewCount}ëª…ì´ í‰ê°€í–ˆìŠµë‹ˆë‹¤
                        </p>
                      </div>
                    `
                        : ""
                    }

                    ${
                      reviewCount === 0
                        ? `
                      <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-sm text-gray-500 text-center">
                          <i class="fas fa-info-circle mr-1"></i>
                          ì•„ì§ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤
                        </p>
                      </div>
                    `
                        : ""
                    }
                  </div>
                `;
        };

        c.innerHTML = `
                <div class="section">
                  <div class="mb-4">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-2">
                      <i class="fas fa-utensils mr-2 text-orange-600"></i>
                      ë¯¸ì‹íšŒ í›„ê¸°
                    </h3>
                    <p class="text-sm sm:text-base text-gray-600 mb-3">
                      <i class="fas fa-heart mr-1 text-orange-500"></i>
                      Foodie íšŒì›ë“¤ê³¼ í•¨ê»˜í–ˆë˜ ë¯¸ì‹íšŒ
                    </p>
                    <div class="text-sm sm:text-base text-gray-600 bg-orange-50 border border-orange-200 rounded-lg px-3 py-2 inline-block">
                      ì´ <span class="font-bold text-orange-600">${
                        tastingRestaurants.length
                      }</span>ê°œ ì‹ë‹¹
                    </div>
                  </div>
                  ${
                    tastingRestaurants.length > 0
                      ? `
                  <!-- ì¹´í…Œê³ ë¦¬ í•„í„° (ë™ì  ìƒì„±) -->
                  <div class="mb-4">
                    <div class="flex flex-wrap items-center gap-2">
                      <button
                        class="category-filter-btn bg-orange-500 text-white rounded-full px-3 py-2 sm:py-1 hover:bg-orange-600 transition-colors font-medium text-sm"
                        data-category="all">
                        <span class="category-emoji" aria-hidden="true">ğŸ </span>
                        <span class="category-label">ì „ì²´ (${
                          tastingRestaurants.length
                        })</span>
                      </button>
                      ${restaurantCategories
                        .map(
                          (cat) => `
                        <button
                          class="category-filter-btn bg-gray-200 text-gray-700 rounded-full px-3 py-2 sm:py-1 hover:bg-orange-500 hover:text-white transition-colors font-medium text-sm"
                          data-category="${cat.name}">
                          <span class="category-emoji" aria-hidden="true">${
                            cat.emoji
                          }</span>
                          <span class="category-label">${cat.name} (${
                            tastingRestaurants.filter(
                              (r) => r.restaurantCategory === cat.name
                            ).length
                          })</span>
                        </button>
                      `
                        )
                        .join("")}
                      ${
                        isAdmin
                          ? `
                      <button
                        id="manage-categories-btn"
                        class="bg-orange-100 text-orange-600 rounded-full px-3 py-1 hover:bg-orange-500 hover:text-white transition-colors font-medium text-sm flex items-center gap-1">
                        <i class="fas fa-plus"></i> ì¶”ê°€
                      </button>
                      `
                          : ""
                      }
                    </div>
                  </div>

                  <!-- ê²€ìƒ‰ì°½ -->
                  <div class="mb-4">
                    <div class="relative">
                      <input
                        type="text"
                        id="restaurant-search-input"
                        placeholder="ë¬´ì—‡ì´ë“  ì…ë ¥í•´ë³´ì„¸ìš”! ì‹ë‹¹ ì´ë¦„, ë©”ë‰´, ë¦¬ë·° ë‚´ìš© ë“±..."
                        class="w-full px-4 py-3 sm:py-2 pl-12 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors text-gray-900 placeholder-gray-400 text-base"
                      />
                      <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                      <button
                        id="clear-search-btn"
                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors hidden"
                        title="ê²€ìƒ‰ ì´ˆê¸°í™”">
                        <i class="fas fa-times-circle"></i>
                      </button>
                    </div>
                    <div id="search-result-count" class="mt-2 text-sm text-gray-600"></div>
                  </div>
                  `
                      : ""
                  }

                  <!-- ë¯¸ì‹íšŒ ì‹ë‹¹ ëª©ë¡ (í˜ì´ì§€ ì „ì²´ ìŠ¤í¬ë¡¤ ì‚¬ìš©) -->
                  <div id="restaurant-list-container">
                    ${
                      tastingRestaurants.length > 0
                        ? `<div id="restaurant-cards-container">
                            <div class="grid grid-cols-1 gap-4 sm:gap-6" id="restaurant-cards">${visibleTastingRestaurants
                              .map((restaurant, index) =>
                                createRestaurantCard(restaurant, index, false)
                              )
                              .join("")}</div>
                            ${
                              tastingRestaurants.length > clampedVisibleCount
                                ? `<div class="mt-4 flex justify-center">
                                    <button
                                      id="load-more-restaurants-btn"
                                      class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-orange-300 text-orange-700 bg-white hover:bg-orange-50 text-sm font-semibold shadow-sm"
                                    >
                                      <i class="fas fa-plus"></i>
                                      ë”ë³´ê¸° (ì‹ë‹¹ í›„ê¸° 3ê°œ ë” ë³´ê¸°)
                                    </button>
                                  </div>`
                                : ""
                            }
                          </div>`
                        : `<div class="text-center py-12 text-gray-400">
                            <i class="fas fa-utensils text-4xl mb-3"></i>
                            <p>ì•„ì§ ì§„í–‰ëœ ë¯¸ì‹íšŒê°€ ì—†ìŠµë‹ˆë‹¤</p>
                          </div>`
                    }
                  </div>
                </div>
              `;

        // ê²€ìƒ‰ ë° í•„í„° ê¸°ëŠ¥
        const searchInput = document.getElementById("restaurant-search-input");
        const clearSearchBtn = document.getElementById("clear-search-btn");
        const searchResultCount = document.getElementById(
          "search-result-count"
        );
        const restaurantCardsContainer =
          document.getElementById("restaurant-cards");
        const categoryFilterBtns = document.querySelectorAll(
          ".category-filter-btn"
        );

        let currentCategory = "all"; // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬

        // ë”ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ (ê²€ìƒ‰/í•„í„° ì´ì „ ê¸°ë³¸ ëª©ë¡ìš©)
        const loadMoreBtn = document.getElementById(
          "load-more-restaurants-btn"
        );
        if (loadMoreBtn && tastingRestaurants.length > 0) {
          loadMoreBtn.addEventListener("click", () => {
            const INCREMENT = 3;
            if (typeof window !== "undefined") {
              const prev =
                typeof window.tastingRestaurantsVisibleCount === "number"
                  ? window.tastingRestaurantsVisibleCount
                  : DEFAULT_TASTING_VISIBLE_COUNT;
              const next = Math.min(
                prev + INCREMENT,
                tastingRestaurants.length
              );
              window.tastingRestaurantsVisibleCount = next;
            }
            // ë”ë³´ê¸° í´ë¦­ ì‹œ ê²€ìƒ‰/í•„í„° ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ê³  ë‹¤ì‹œ ë Œë”ë§
            renderRoadmapTab(isAdmin);
          });
        }

        if (searchInput && tastingRestaurants.length > 0) {
          // ê²€ìƒ‰ í•¨ìˆ˜: ë„ì–´ì“°ê¸° ì œê±°í•˜ê³  ì†Œë¬¸ìë¡œ ë³€í™˜
          const normalizeSearchText = (text) => {
            return (text || "").toLowerCase().replace(/\s+/g, "");
          };

          const performSearch = () => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            const normalizedSearchTerm = normalizeSearchText(searchTerm);

            // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™” ë²„íŠ¼ í‘œì‹œ
            if (searchTerm) {
              clearSearchBtn.classList.remove("hidden");
            } else {
              clearSearchBtn.classList.add("hidden");
            }

            // ì¹´í…Œê³ ë¦¬ í•„í„°ë§
            let filtered = tastingRestaurants;
            if (currentCategory !== "all") {
              filtered = filtered.filter(
                (r) => r.restaurantCategory === currentCategory
              );
            }

            // ê²€ìƒ‰ í•„í„°ë§: ì‹ë‹¹ ì´ë¦„, ëŒ€í‘œ ë©”ë‰´, ë¦¬ë·° ë‚´ìš© ëª¨ë‘ ê²€ìƒ‰
            const filteredRestaurants = searchTerm
              ? filtered.filter((r) => {
                  // ì‹ë‹¹ ì´ë¦„ ê²€ìƒ‰
                  const nameMatch = normalizedSearchTerm
                    ? normalizeSearchText(r.restaurantName).includes(
                        normalizedSearchTerm
                      )
                    : false;

                  // ëŒ€í‘œ ë©”ë‰´ ê²€ìƒ‰
                  const menuMatch =
                    normalizedSearchTerm && r.restaurantInfo
                      ? normalizeSearchText(r.restaurantInfo).includes(
                          normalizedSearchTerm
                        )
                      : false;

                  // ë¦¬ë·° ë‚´ìš© ê²€ìƒ‰
                  const reviewMatch =
                    normalizedSearchTerm && r.reviews && r.reviews.length > 0
                      ? r.reviews.some(
                          (review) =>
                            review.comment &&
                            normalizeSearchText(review.comment).includes(
                              normalizedSearchTerm
                            )
                        )
                      : false;

                  return nameMatch || menuMatch || reviewMatch;
                })
              : filtered;

            // ê²€ìƒ‰ ê²°ê³¼ ì¹´ìš´íŠ¸ í‘œì‹œ
            if (searchTerm) {
              searchResultCount.innerHTML = `
                      <i class="fas fa-search mr-1"></i>
                      ê²€ìƒ‰ ê²°ê³¼: <span class="font-bold text-orange-600">${
                        filteredRestaurants.length
                      }</span>ê°œ ì‹ë‹¹
                      ${
                        filteredRestaurants.length === 0
                          ? '<span class="text-red-500 ml-2">(ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤)</span>'
                          : ""
                      }
                    `;
            } else {
              searchResultCount.innerHTML = "";
            }

            // ê²°ê³¼ ë Œë”ë§
            if (filteredRestaurants.length > 0) {
              restaurantCardsContainer.innerHTML = filteredRestaurants
                .map((restaurant, index) =>
                  createRestaurantCard(restaurant, index)
                )
                .join("");
            } else if (searchTerm) {
              restaurantCardsContainer.innerHTML = `
                      <div class="col-span-2 text-center py-12 text-gray-400">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p class="text-lg font-semibold mb-2">"${saf(
                          searchTerm
                        )}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-sm">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš” (ì‹ë‹¹ ì´ë¦„, ëŒ€í‘œ ë©”ë‰´, ë¦¬ë·° ë‚´ìš©)</p>
                      </div>
                    `;
            } else if (currentCategory !== "all") {
              // ì¹´í…Œê³ ë¦¬ë§Œ ì„ íƒë˜ê³  ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•Œ ë¹ˆ ê²°ê³¼ í‘œì‹œ
              // restaurantCategoriesì—ì„œ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì°¾ê¸°
              const categoryInfo = restaurantCategories.find(
                (cat) => cat.name === currentCategory
              );
              const categoryName = categoryInfo
                ? `${categoryInfo.emoji} ${categoryInfo.name}`
                : "ğŸ½ï¸ ê¸°íƒ€";
              restaurantCardsContainer.innerHTML = `
                      <div class="col-span-2 text-center py-12 text-gray-400">
                        <i class="fas fa-utensils text-4xl mb-3"></i>
                        <p class="text-lg font-semibold mb-2">${categoryName} ì¹´í…Œê³ ë¦¬ì— ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-sm">ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”</p>
                      </div>
                    `;
            } else {
              // ê¸°ë³¸ ìƒíƒœ (ì „ì²´ í‘œì‹œ)
              restaurantCardsContainer.innerHTML = filteredRestaurants
                .map((restaurant, index) =>
                  createRestaurantCard(restaurant, index)
                )
                .join("");
            }
          };

          // ì‹¤ì‹œê°„ ê²€ìƒ‰
          searchInput.addEventListener("input", performSearch);

          // ê²€ìƒ‰ ì´ˆê¸°í™” ë²„íŠ¼
          clearSearchBtn.addEventListener("click", () => {
            searchInput.value = "";
            performSearch();
            searchInput.focus();
          });

          // Enter í‚¤ë¡œ ê²€ìƒ‰
          searchInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              performSearch();
            }
          });

          // ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ (ê´€ë¦¬ì ì „ìš©)
          const manageCategoriesBtn = document.getElementById(
            "manage-categories-btn"
          );
          if (manageCategoriesBtn) {
            manageCategoriesBtn.addEventListener("click", () => {
              openCategoryManagementModal();
            });
          }

          // ì¹´í…Œê³ ë¦¬ í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
          categoryFilterBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
              const category = btn.dataset.category;
              currentCategory = category;

              // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ì¡°ëª¨ì„ ìŠ¤íƒ€ì¼)
              categoryFilterBtns.forEach((b) => {
                b.classList.remove("bg-orange-500", "text-white");
                b.classList.add("bg-gray-200", "text-gray-700");
              });

              btn.classList.remove("bg-gray-200", "text-gray-700");
              btn.classList.add("bg-orange-500", "text-white");

              // ê²€ìƒ‰ ì¬ì‹¤í–‰
              performSearch();
            });
          });
        }

        // ê´€ë¦¬ì ì „ìš©: ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (isAdmin) {
          c.addEventListener("click", async (e) => {
            const deleteReviewBtn = e.target.closest(
              "[data-action='delete-review']"
            );
            const deleteRestaurantBtn = e.target.closest(
              "[data-action='delete-restaurant']"
            );

            // í›„ê¸° ì‚­ì œ
            if (deleteReviewBtn) {
              const eventId = deleteReviewBtn.dataset.eventId;
              const studentId = deleteReviewBtn.dataset.studentId;

              if (
                !confirm(
                  "ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ í›„ê¸°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                )
              )
                return;

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(
                  db,
                  async (transaction) => {
                    const eventDoc = await transaction.get(eventRef);
                    if (!eventDoc.exists())
                      throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                    const eventData = eventDoc.data();
                    const reviews = eventData.reviews || [];

                    // í•´ë‹¹ studentIdì˜ ë¦¬ë·° ì œê±°
                    const updatedReviews = reviews.filter(
                      (r) => r.studentId !== studentId
                    );

                    transaction.update(eventRef, { reviews: updatedReviews });
                  },
                  TRANSACTION_OPTIONS
                );

                showAlert("âœ…", "í›„ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderRoadmapTab(isAdmin); // ë‹¤ì‹œ ë Œë”ë§
              } catch (error) {
                console.error("í›„ê¸° ì‚­ì œ ì˜¤ë¥˜:", error);
                if (error?.code === "resource-exhausted")
                  showAlert(
                    "ğŸ˜¥",
                    "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
                  );
                else showAlert("ğŸ˜¥", "í›„ê¸° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            }

            // ì‹ë‹¹ ì‚­ì œ
            if (deleteRestaurantBtn) {
              const eventId = deleteRestaurantBtn.dataset.eventId;
              const restaurantName = deleteRestaurantBtn.dataset.restaurantName;

              if (
                !confirm(
                  `"${restaurantName}" ì‹ë‹¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‹ë‹¹ì˜ ì˜ˆì•½ ì •ë³´ì™€ ê´€ë ¨ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
                )
              )
                return;

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(
                  db,
                  async (transaction) => {
                    const eventDoc = await transaction.get(eventRef);
                    if (!eventDoc.exists())
                      throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                    const eventData = eventDoc.data();
                    const restaurants = eventData.restaurants || [];

                    // í•´ë‹¹ ì‹ë‹¹ ì œê±°
                    const updatedRestaurants = restaurants.filter(
                      (r) => r.name !== restaurantName
                    );

                    transaction.update(eventRef, {
                      restaurants: updatedRestaurants,
                    });
                  },
                  TRANSACTION_OPTIONS
                );

                showAlert("âœ…", "ì‹ë‹¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderRoadmapTab(isAdmin); // ë‹¤ì‹œ ë Œë”ë§
              } catch (error) {
                console.error("ì‹ë‹¹ ì‚­ì œ ì˜¤ë¥˜:", error);
                if (error?.code === "resource-exhausted")
                  showAlert(
                    "ğŸ˜¥",
                    "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
                  );
                else showAlert("ğŸ˜¥", "ì‹ë‹¹ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            }
          });

          // ì¹´í…Œê³ ë¦¬ ë“œë¡­ë‹¤ìš´ change ì´ë²¤íŠ¸
          c.addEventListener("change", async (e) => {
            const updateCategorySelect = e.target.closest(
              "[data-action='update-category']"
            );
            if (updateCategorySelect) {
              const eventId = updateCategorySelect.dataset.eventId;
              const restaurantName =
                updateCategorySelect.dataset.restaurantName;
              const newCategory = updateCategorySelect.value;

              if (
                !confirm(
                  `"${restaurantName}" ì‹ë‹¹ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ "${newCategory}"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                )
              ) {
                // ì·¨ì†Œ ì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¼
                const event = eventsData.find((e) => e.id === eventId);
                if (event && event.restaurants) {
                  const restaurant = event.restaurants.find(
                    (r) => r.name === restaurantName
                  );
                  if (restaurant) {
                    updateCategorySelect.value = restaurant.category || "ê¸°íƒ€";
                  }
                }
                return;
              }

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(
                  db,
                  async (transaction) => {
                    const eventDoc = await transaction.get(eventRef);
                    if (!eventDoc.exists())
                      throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                    const eventData = eventDoc.data();
                    const restaurants = eventData.restaurants || [];

                    // í•´ë‹¹ ì‹ë‹¹ì˜ ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸
                    const updatedRestaurants = restaurants.map((r) => {
                      if (r.name === restaurantName) {
                        return { ...r, category: newCategory };
                      }
                      return r;
                    });

                    transaction.update(eventRef, {
                      restaurants: updatedRestaurants,
                    });
                  },
                  TRANSACTION_OPTIONS
                );

                showAlert("âœ…", "ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderRoadmapTab(isAdmin); // ë‹¤ì‹œ ë Œë”ë§
              } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì˜¤ë¥˜:", error);
                if (error?.code === "resource-exhausted")
                  showAlert(
                    "ğŸ˜¥",
                    "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
                  );
                else showAlert("ğŸ˜¥", "ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            }
          });
        }

        // í›„ê¸° ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        c.addEventListener("click", (e) => {
          const toggleBtn = e.target.closest("[data-action='toggle-reviews']");
          if (toggleBtn) {
            const eventId = toggleBtn.dataset.eventId;
            const restaurantName = toggleBtn.dataset.restaurantName;

            // data ì†ì„±ìœ¼ë¡œ ì§ì ‘ ì°¾ê¸°
            const reviewList = c.querySelector(
              `.review-list[data-event-id="${eventId}"][data-restaurant-name="${restaurantName}"]`
            );

            if (!reviewList) return;

            const isShowingAll = reviewList.dataset.showAll === "true";

            // í•´ë‹¹ ì‹ë‹¹ì˜ ëª¨ë“  í›„ê¸° ê°€ì ¸ì˜¤ê¸°
            const restaurant = tastingRestaurants.find(
              (r) =>
                r.eventId === eventId && r.restaurantName === restaurantName
            );

            if (!restaurant) return;

            const allReviews = restaurant.reviews.filter(
              (r) => r.comment && r.comment.trim()
            );

            if (isShowingAll) {
              // ì ‘ê¸° - 1ê°œë§Œ ë³´ì—¬ì£¼ê¸°
              reviewList.innerHTML = allReviews
                .slice(0, 1)
                .map(
                  (r) => `
                        <div class="bg-white rounded-xl p-4 sm:p-5 border-2 border-orange-100 shadow-md hover:shadow-lg transition-shadow relative review-item mb-3">
                          <div class="flex items-center justify-between mb-3">
                            <span class="text-sm sm:text-base font-bold text-gray-800 flex items-center">
                              <i class="fas fa-user-circle mr-2 text-orange-500 text-lg sm:text-xl"></i>
                              ìµëª…
                            </span>
                            <div class="flex items-center gap-2">
                              <div class="flex items-center gap-1">
                                ${renderStars(r.rating || 0)}
                              </div>
                              ${
                                isAdmin
                                  ? `
                                <button
                                  class="text-red-500 hover:text-red-700 transition-colors p-1"
                                  data-action="delete-review"
                                  data-event-id="${restaurant.eventId}"
                                  data-student-id="${r.studentId}"
                                  title="í›„ê¸° ì‚­ì œ">
                                  <i class="fas fa-trash text-sm"></i>
                                </button>
                              `
                                  : ""
                              }
                            </div>
                          </div>
                          <p class="text-sm sm:text-base text-gray-700 leading-relaxed whitespace-pre-wrap">${saf(
                            r.comment
                          )}</p>
                        </div>
                      `
                )
                .join("");
              reviewList.dataset.showAll = "false";
              toggleBtn.innerHTML = `<i class="fas fa-chevron-down mr-2"></i>ì™¸ ${
                allReviews.length - 1
              }ê°œ í›„ê¸° ë” ë³´ê¸°`;
            } else {
              // í¼ì¹˜ê¸° - ëª¨ë“  í›„ê¸° ë³´ì—¬ì£¼ê¸°
              reviewList.innerHTML = allReviews
                .map(
                  (r) => `
                        <div class="bg-white rounded-xl p-4 sm:p-5 border-2 border-orange-100 shadow-md hover:shadow-lg transition-shadow relative review-item mb-3">
                          <div class="flex items-center justify-between mb-3">
                            <span class="text-sm sm:text-base font-bold text-gray-800 flex items-center">
                              <i class="fas fa-user-circle mr-2 text-orange-500 text-lg sm:text-xl"></i>
                              ìµëª…
                            </span>
                            <div class="flex items-center gap-2">
                              <div class="flex items-center gap-1">
                                ${renderStars(r.rating || 0)}
                              </div>
                              ${
                                isAdmin
                                  ? `
                                <button
                                  class="text-red-500 hover:text-red-700 transition-colors p-1"
                                  data-action="delete-review"
                                  data-event-id="${restaurant.eventId}"
                                  data-student-id="${r.studentId}"
                                  title="í›„ê¸° ì‚­ì œ">
                                  <i class="fas fa-trash text-sm"></i>
                                </button>
                              `
                                  : ""
                              }
                            </div>
                          </div>
                          <p class="text-sm sm:text-base text-gray-700 leading-relaxed whitespace-pre-wrap">${saf(
                            r.comment
                          )}</p>
                        </div>
                      `
                )
                .join("");
              reviewList.dataset.showAll = "true";
              toggleBtn.innerHTML = `<i class="fas fa-chevron-up mr-2"></i>í›„ê¸° ì ‘ê¸°`;
            }
          }
        });
      }

      /* ===== ëª…ì˜ˆì˜ ì „ë‹¹ ê´€ë¦¬ì ===== */
      function renderHOFAdmin(container) {
        const cards = (historyData || [])
          .map(
            (h) => `
                <div class="border rounded p-3 bg-white flex items-start gap-3">
                  ${
                    h.imageUrl
                      ? `<img src="${saf(
                          h.imageUrl
                        )}" class="w-24 h-24 object-cover rounded" onerror="this.style.display='none'">`
                      : ""
                  }
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <div class="truncate font-semibold">${saf(
                        h.title || "(ì œëª© ì—†ìŒ)"
                      )}</div>
                      <div class="text-sm text-gray-500">${
                        h.date ? saf(h.date) : "-"
                      }</div>
                    </div>
                    ${
                      h.subtitle
                        ? `<div class="text-sm text-orange-700">${saf(
                            h.subtitle
                          )}</div>`
                        : ""
                    }
                    ${
                      h.description
                        ? `<div class="text-sm text-gray-700 mt-1 line-clamp-2">${saf(
                            h.description
                          )}</div>`
                        : ""
                    }
                    <div class="mt-2 space-x-2">
                      <button class="text-blue-600 text-sm" data-act="edit-hof" data-id="${
                        h.id
                      }"><i class="fas fa-pen"></i> ìˆ˜ì •</button>
                      <button class="text-red-600 text-sm" data-act="del-hof" data-id="${
                        h.id
                      }"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    </div>
                  </div>
                </div>
              `
          )
          .join("");

        container.innerHTML = `
                <div class="grid grid-cols-1 gap-4">
                  <div class="section">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ëª…ì˜ˆì˜ ì „ë‹¹ ë“±ë¡</h3>
                    <div class="space-y-3">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
                        <input id="hof-title" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <input id="hof-date" type="date" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë¶€ì œ (ì„ íƒ)</label>
                        <input id="hof-subtitle" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ë¶€ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
                        <input id="hof-image" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                        <textarea id="hof-desc" rows="4" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                      </div>
                    </div>
                    <div class="mt-2 space-x-2">
                      <button id="hof-add" class="px-4 py-2 bg-orange-500 text-white rounded">ì¶”ê°€</button>
                      <button id="hof-reset" class="px-3 py-2 bg-gray-200 rounded">ë¦¬ì…‹</button>
                    </div>
                  </div>

                  <div class="section">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">ë“±ë¡ëœ í•­ëª©</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${
                      cards || `<div class="text-gray-400">í•­ëª© ì—†ìŒ</div>`
                    }</div>
                  </div>
                </div>
              `;

        container.onclick = async (e) => {
          const b = e.target.closest("button[data-act]");
          if (!b) return;
          const id = b.dataset.id;
          if (b.dataset.act === "del-hof") {
            if (!confirm("ì‚­ì œí•˜ì‹œê² ì–´ìš”?")) return;
            try {
              await deleteDoc(doc(db, "history", id));
              showAlert("ğŸ—‘ï¸", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
              console.warn(err);
              showAlert("ğŸ˜¥", "ì‚­ì œ ì‹¤íŒ¨");
            }
          }
          if (b.dataset.act === "edit-hof") {
            const item = historyData.find((x) => x.id === id) || {};
            el.blockEditorTitle.textContent = "ëª…ì˜ˆì˜ ì „ë‹¹ ìˆ˜ì •";
            el.blockEditorBody.innerHTML = `
                    <div class="space-y-3">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
                        <input id="eh-title" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="${saf(
                          item.title || ""
                        )}">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <input id="eh-date" type="date" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" value="${saf(
                          item.date || ""
                        )}">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë¶€ì œ</label>
                        <input id="eh-subtitle" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ë¶€ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="${saf(
                          item.subtitle || ""
                        )}">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¯¸ì§€ URL</label>
                        <input id="eh-image" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”" value="${saf(
                          item.imageUrl || ""
                        )}">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                        <textarea id="eh-desc" rows="4" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">${saf(
                          item.description || ""
                        )}</textarea>
                      </div>
                    </div>`;
            el.blockEditor.classList.remove("hidden");
            el.blockEditorSave.onclick = async () => {
              try {
                await updateDoc(doc(db, "history", id), {
                  title: document.getElementById("eh-title").value.trim(),
                  date: document.getElementById("eh-date").value,
                  subtitle: document.getElementById("eh-subtitle").value.trim(),
                  imageUrl: document.getElementById("eh-image").value.trim(),
                  description: document.getElementById("eh-desc").value.trim(),
                });
                el.blockEditor.classList.add("hidden");
                showAlert("âœ…", "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              } catch (e) {
                console.warn(e);
                showAlert("ğŸ˜¥", "ìˆ˜ì • ì‹¤íŒ¨");
              }
            };
            el.blockEditorCancel.onclick = () =>
              el.blockEditor.classList.add("hidden");
          }
        };

        container.querySelector("#hof-add").onclick = async () => {
          const title = container.querySelector("#hof-title").value.trim();
          const date = container.querySelector("#hof-date").value;
          const subtitle = container
            .querySelector("#hof-subtitle")
            .value.trim();
          const imageUrl = container.querySelector("#hof-image").value.trim();
          const description = container.querySelector("#hof-desc").value.trim();
          if (!title || !date)
            return showAlert("ğŸ˜¥", "ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          try {
            await addDoc(collection(db, "history"), {
              title,
              date,
              subtitle,
              imageUrl,
              description,
              createdAt: serverTimestamp(),
            });
            [
              "hof-title",
              "hof-date",
              "hof-subtitle",
              "hof-image",
              "hof-desc",
            ].forEach((id) => (container.querySelector("#" + id).value = ""));
            showAlert("ğŸ‰", "ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ë“±ë¡ ì‹¤íŒ¨");
          }
        };
        container.querySelector("#hof-reset").onclick = () => {
          [
            "hof-title",
            "hof-date",
            "hof-subtitle",
            "hof-image",
            "hof-desc",
          ].forEach((id) => (container.querySelector("#" + id).value = ""));
        };
      }

      /* ===== íšŒë¹„ ê´€ë¦¬ (ì‹œìŠ¤í…œ ì„¤ì •) ===== */
      function renderSystemAdmin(container) {
        const signup = signupSettings || { open: false };
        const dues = duesSettings || {
          enabled: false,
          bank: "",
          number: "",
          holder: "",
          amount: "",
          note: "",
        };
        const admins = adminList || [];

        container.innerHTML = `
                <div class="grid grid-cols-1 gap-6">
                  <!-- íšŒë¹„/ê³„ì¢Œ ì„¤ì • -->
                  <div class="section">
                    <div class="flex items-center gap-3 mb-3">
                      <i class="fas fa-credit-card text-2xl text-orange-500"></i>
                      <div>
                        <h3 class="text-xl font-bold text-gray-800">íšŒë¹„ ê³„ì¢Œ ì„¤ì •</h3>
                        <p class="text-sm text-gray-600">ì´ë²¤íŠ¸ ì‹ ì²­ ì‹œ íšŒì›ë“¤ì—ê²Œ í‘œì‹œë  íšŒë¹„ ì…ê¸ˆ ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤</p>
                      </div>
                    </div>
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                      <div class="flex">
                        <div class="flex-shrink-0">
                          <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                          <p class="text-sm text-blue-700">
                            <strong>ìš©ë„:</strong> ì´ë²¤íŠ¸ ì°¸ê°€ë¹„ ë˜ëŠ” ë™ì•„ë¦¬ íšŒë¹„ë¥¼ ìˆ˜ë‚©í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤<br>
                            <strong>í‘œì‹œ ìœ„ì¹˜:</strong> ì´ë²¤íŠ¸ ì‹ ì²­ í™”ë©´ì—ì„œ ìë™ìœ¼ë¡œ ê³„ì¢Œ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤<br>
                            <strong>ì•ˆë‚´ ë¬¸êµ¬:</strong> ì…ê¸ˆ ê´€ë ¨ ì¶”ê°€ ì•ˆë‚´ì‚¬í•­ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: "ì…ê¸ˆìëª…ì€ ë³¸ì¸ ì´ë¦„ìœ¼ë¡œ í•´ì£¼ì„¸ìš”")
                          </p>
                        </div>
                      </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                          <i class="fas fa-toggle-on mr-1 text-orange-500"></i>ì‚¬ìš© ì—¬ë¶€
                        </label>
                        <select id="set-dues-enabled" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
                          <option value="false" ${
                            dues.enabled ? "" : "selected"
                          }>ì‚¬ìš© ì•ˆ í•¨</option>
                          <option value="true" ${
                            dues.enabled ? "selected" : ""
                          }>ì‚¬ìš©</option>
                        </select>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                          <i class="fas fa-university mr-1 text-orange-500"></i>ì€í–‰ëª…
                        </label>
                        <input id="set-dues-bank" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="ì˜ˆ: ì¹´ì¹´ì˜¤ë±…í¬" value="${saf(
                          dues.bank || ""
                        )}">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                          <i class="fas fa-hashtag mr-1 text-orange-500"></i>ê³„ì¢Œë²ˆí˜¸
                        </label>
                        <input id="set-dues-number" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="ì˜ˆ: 3333-12-1234567" value="${saf(
                          dues.number || ""
                        )}">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                          <i class="fas fa-user mr-1 text-orange-500"></i>ì˜ˆê¸ˆì£¼
                        </label>
                        <input id="set-dues-holder" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="ì˜ˆ: í™ê¸¸ë™" value="${saf(
                          dues.holder || ""
                        )}">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                          <i class="fas fa-won-sign mr-1 text-orange-500"></i>ê¸ˆì•¡ (ì„ íƒ)
                        </label>
                        <input id="set-dues-amount" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="ì˜ˆ: 10000" value="${saf(
                          dues.amount || ""
                        )}">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                          <i class="fas fa-comment-dots mr-1 text-orange-500"></i>ì•ˆë‚´ ë¬¸êµ¬ (ì„ íƒ)
                        </label>
                        <input id="set-dues-note" class="w-full px-3 py-2 border-2 rounded-lg bg-white text-gray-900 border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="ì˜ˆ: ì…ê¸ˆìëª…ì€ ë³¸ì¸ ì´ë¦„ìœ¼ë¡œ" value="${saf(
                          dues.note || ""
                        )}">
                      </div>
                    </div>
                    <button id="set-dues-save" class="mt-4 w-full md:w-auto px-6 py-3 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition-colors shadow-md">
                      <i class="fas fa-save mr-2"></i>íšŒë¹„ ì •ë³´ ì €ì¥
                    </button>
                  </div>
                </div>
              `;

        // íšŒë¹„ ì„¤ì • ì €ì¥ í•¸ë“¤ëŸ¬
        container.querySelector("#set-dues-save").onclick = async () => {
          const enabled =
            container.querySelector("#set-dues-enabled").value === "true";
          const bank = container.querySelector("#set-dues-bank").value.trim();
          const number = container
            .querySelector("#set-dues-number")
            .value.trim();
          const holder = container
            .querySelector("#set-dues-holder")
            .value.trim();
          const amount = container
            .querySelector("#set-dues-amount")
            .value.trim();
          const note = container.querySelector("#set-dues-note").value.trim();
          try {
            await setDoc(
              doc(db, "settings", "dues"),
              { enabled, bank, number, holder, amount, note },
              { merge: true }
            );
            showAlert("âœ…", "íšŒë¹„/ê³„ì¢Œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ì €ì¥ ì‹¤íŒ¨");
          }
        };
      }

      /* ===== ë¹„ìƒ ê´€ë¦¬ì ì„ëª… ===== */
      async function addEmergencyAdmin() {
        const sid = document.getElementById("new-admin-id").value.trim();
        if (!sid) return showAlert("ğŸ˜¥", "í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
        try {
          await runTransaction(
            db,
            async (tx) => {
              const ref = doc(db, "admins", "list");
              const snap = await tx.get(ref);
              const arr = snap.exists() ? snap.data().studentIds || [] : [];
              if (!arr.includes(sid)) arr.push(sid);
              tx.set(ref, { studentIds: arr }, { merge: true });
            },
            TRANSACTION_OPTIONS
          );
          closeEmergencyModal();
          showAlert("âœ…", `ê´€ë¦¬ìì— ${saf(sid)}ë¥¼(ì„) ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
        } catch (e) {
          console.warn(e);
          if (e?.code === "resource-exhausted")
            showAlert(
              "ğŸ˜¥",
              "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ê´€ë¦¬ì ì„ëª… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /* ===== ì „ì—­: ì—ë””í„° ëª¨ë‹¬ ë°– í´ë¦­ ì‹œ ë‹«í˜ ë°©ì§€(ëª…ì‹œ ë²„íŠ¼ë§Œ) ===== */
      // ì´ë¯¸ ê° ì‚¬ìš©ì²˜ì—ì„œ cancelê³¼ save í•¸ë“¤ëŸ¬ë¥¼ ì§€ì •í•¨

      // ë¡œë”© ì§„í–‰ë¥  ê´€ë¦¬
      let loadingProgress = 0;
      const totalLoadingSteps = 2; // ì´ ë¡œë”© ë‹¨ê³„ ìˆ˜ (ê°„ì†Œí™”)

      // ì‹ ë²„ì „ ë¡œë”© í™”ë©´: CSS ì• ë‹ˆë©”ì´ì…˜ë§Œ ì‚¬ìš©
      let loadingAnimationComplete = false;

      // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (ì‹ ë²„ì „: ë‹¨ìˆœíˆ ì• ë‹ˆë©”ì´ì…˜ë§Œ ì‹œì‘)
      function startLoadingAnimation() {
        loadingAnimationComplete = false;
        // ì‹ ë²„ì „ ë¡œë”© í™”ë©´ì€ CSS ì• ë‹ˆë©”ì´ì…˜ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”
      }

      // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ
      function stopLoadingAnimation() {
        loadingAnimationComplete = true;
      }

      function updateLoadingProgress(step, text) {
        // ì‹ ë²„ì „ ë¡œë”© í™”ë©´ì€ CSS ì• ë‹ˆë©”ì´ì…˜ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”
        // stepì´ 2ë©´ ì™„ë£Œë¡œ ê°„ì£¼
        if (step === 2 || step >= 100) {
          loadingProgress = 100;
          setTimeout(() => {
            stopLoadingAnimation();
          }, 500);
        } else {
          loadingProgress = Math.min(90, step * 30);
        }

        debugLog(`ë¡œë”© ì§„í–‰ë¥ : ${loadingProgress}% - ${text || ""}`);
      }

      // ìˆœì°¨ ë¡œë”© ì™„ë£Œ í”Œë˜ê·¸
      let sequentialLoadingComplete = false;

      // ìˆœì°¨ ë¡œë”© ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì • í•¨ìˆ˜
      window.setSequentialLoadingComplete = (value) => {
        sequentialLoadingComplete = value;
      };

      // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
      function hideLoadingScreen() {
        // ìˆœì°¨ ë¡œë”©ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œë”© í™”ë©´ì„ ë‹«ì§€ ì•ŠìŒ
        if (!sequentialLoadingComplete) {
          debugLog("â³ ìˆœì°¨ ë¡œë”©ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ë¡œë”© í™”ë©´ì„ ìœ ì§€í•©ë‹ˆë‹¤.");
          return;
        }

        const loadingScreen = document.getElementById("loading-screen");
        if (loadingScreen) {
          // ìˆœì°¨ ë¡œë”©ì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ê°•ì œë¡œ ìˆ¨ê¸°ê¸°
          debugLog("âœ… ë¡œë”© í™”ë©´ ìˆ¨ê¹€ (ìˆœì°¨ ë¡œë”© ì™„ë£Œ)");
          loadingScreen.style.display = "none";
          loadingScreen.style.visibility = "hidden";
          loadingScreen.style.opacity = "0";
          loadingScreen.style.pointerEvents = "none";
          loadingScreen.style.zIndex = "-1";
          loadingScreen.classList.add("hidden");
          resetAutoReloadState();
        }
      }

      // window ê°ì²´ì— ë…¸ì¶œ
      window.hideLoadingScreen = hideLoadingScreen;

      // ===================== ì´ˆê¸°í™” =====================
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", function () {
        // 1ë‹¨ê³„: ì´ˆê¸° ë Œë”ë§
        updateLoadingProgress(1, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
        applyHomeLayoutOrder();
        renderRoadmap();
        renderBlocks();

        // ì¤‘ë³µ íƒ€ì„ì•„ì›ƒ ë¡œì§ ì œê±°: verifyAllDataLoadedì™€ checkLoadingCompleteì—ì„œ ì²˜ë¦¬
        // 90ì´ˆ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ í†µì¼í•˜ì—¬ ì¡°ê¸° ì¬ì ‘ì† ë°©ì§€

        // ì˜ˆì•½ëœ ê¸€ë“¤ í™•ì¸
        setTimeout(() => {
          checkScheduledPosts();
        }, 2000); // 2ì´ˆ í›„ ì‹¤í–‰ (ë¡œê·¸ì¸ ì™„ë£Œ í›„)

        // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì¼ì • ë‹¤ì‹œ ë Œë”ë§
        let resizeTimeout;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (typeof renderHorizontalRoadmap === "function") {
              renderHorizontalRoadmap();
            }
          }, 250);
        });
        updateSignupUI();

        // 2ë‹¨ê³„: ì‚¬ìš©ì ì •ë³´ í™•ì¸
        updateLoadingProgress(2, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
        const savedUser = localStorage.getItem("foodieUser");
        if (savedUser) {
          try {
            currentUser = JSON.parse(savedUser);
            // 3ë‹¨ê³„: ë°ì´í„° ë¡œë”©
            updateLoadingProgress(3, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
            setTimeout(() => {
              renderAll();
            }, 1200); // ë¡œë“œë§µ ë¡œë”© ì‹œê°„ ê³ ë ¤í•˜ì—¬ ì—°ì¥
          } catch (e) {
            debugWarn("ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:", e);
            updateLoadingProgress(3, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
            setTimeout(() => {
              renderAll();
            }, 1200); // ë¡œë“œë§µ ë¡œë”© ì‹œê°„ ê³ ë ¤í•˜ì—¬ ì—°ì¥
          }
        } else {
          // ìë™ ë¡œê·¸ì¸ ì‹œë„
          updateLoadingProgress(3, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
          attemptAutoLogin().then((success) => {
            updateLoadingProgress(4, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
            setTimeout(() => {
              renderAll();
            }, 1200); // ë¡œë“œë§µ ë¡œë”© ì‹œê°„ ê³ ë ¤í•˜ì—¬ ì—°ì¥
          });
        }
      });

      // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ë Œë”ë§ ë³´ì¥
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden && currentUser) {
          setTimeout(() => {
            renderAll();
          }, 100);
        }
      });

      // ìœˆë„ìš° í¬ì»¤ìŠ¤ ì‹œ ë Œë”ë§ ë³´ì¥
      window.addEventListener("focus", () => {
        if (currentUser) {
          setTimeout(() => {
            renderAll();
          }, 100);
        }
      });

      // ===================== ë¯¸ì‹íšŒ ëª¨ë‹¬ ê´€ë¦¬ =====================
      function openTastingModal(mode = "create", eventId = null) {
        const modal = document.getElementById("tasting-modal");
        const title = document.getElementById("tasting-modal-title");
        const content = document.getElementById("tasting-modal-content");

        if (mode === "create") {
          // ìƒì„± ëª¨ë“œ: editingEventId ì´ˆê¸°í™”
          if (typeof editingEventId !== "undefined") {
            editingEventId = null;
          }
          title.textContent = "ğŸ½ï¸ ë¯¸ì‹íšŒ ë§Œë“¤ê¸°";
          content.innerHTML = createTastingFormHTML();
          modal.classList.remove("hidden");
          bindTastingForm();
        } else if (mode === "edit" && eventId) {
          // ìˆ˜ì • ëª¨ë“œ: editingEventId ì„¤ì •
          if (typeof editingEventId !== "undefined") {
            editingEventId = eventId;
          }
          title.textContent = "ğŸ½ï¸ ë¯¸ì‹íšŒ ìˆ˜ì •";
          content.innerHTML = createTastingFormHTML();
          modal.classList.remove("hidden");
          bindTastingForm();
          // DOMì´ ë Œë”ë§ëœ í›„ í¼ ë¡œë“œ
          setTimeout(() => {
            loadTastingToForm(eventId);
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì • ëª¨ë“œë¡œ ë³€ê²½
            const saveBtn = document.getElementById("save-tasting-btn");
            if (saveBtn) {
              saveBtn.innerHTML =
                '<i class="fas fa-edit mr-2"></i>ë¯¸ì‹íšŒ ìˆ˜ì •í•˜ê¸°';
            }
          }, 0);
        }
      }

      function closeTastingModal() {
        const modal = document.getElementById("tasting-modal");
        modal.classList.add("hidden");
        resetTastingForm();
      }

      // ===================== ë¯¸ì‹íšŒ í¼ ë°ì´í„° ë¡œë“œ =====================
      function loadTastingToForm(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) {
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ê¸°ë³¸ ì •ë³´ ë¡œë“œ
        const titleInput = document.getElementById("tasting-title");
        if (titleInput) titleInput.value = event.title || "";

        const datetimeInput = document.getElementById("tasting-datetime");
        if (datetimeInput) {
          datetimeInput.value = formatDateTimeForInput(event.datetime);
        }

        const registrationStartInput = document.getElementById(
          "tasting-registration-start"
        );
        if (registrationStartInput) {
          registrationStartInput.value = formatDateTimeForInput(
            event.registrationStart
          );
        }

        const deadlineInput = document.getElementById("tasting-deadline");
        if (deadlineInput) {
          deadlineInput.value = formatDateTimeForInput(event.deadline);
        }

        const limitInput = document.getElementById("tasting-limit");
        if (limitInput) limitInput.value = event.limit || "";

        // ì‹ë‹¹ ì •ë³´ ë¡œë“œ
        const container = document.getElementById("tasting-restaurants-wrap");
        if (container && event.restaurants && event.restaurants.length > 0) {
          container.innerHTML = event.restaurants
            .map((restaurant) =>
              createRestaurantFieldHTML(
                restaurant.name || "",
                restaurant.info || "",
                restaurant.capacity || "",
                restaurant.category || "ê¸°íƒ€",
                restaurant.id || null
              )
            )
            .join("");
        } else if (container) {
          container.innerHTML = createRestaurantFieldHTML();
        }
      }

      // ===================== ì´ë²¤íŠ¸ ëª¨ë‹¬ ê´€ë¦¬ =====================
      function openEventModal(mode = "create", eventId = null) {
        const modal = document.getElementById("event-modal");
        const title = document.getElementById("event-modal-title");
        const content = document.getElementById("event-modal-content");

        if (mode === "create") {
          // ìƒì„± ëª¨ë“œ: editingEventId ì´ˆê¸°í™”
          if (typeof editingEventId !== "undefined") {
            editingEventId = null;
          }
          title.textContent = "ğŸ“… ì´ë²¤íŠ¸ ë§Œë“¤ê¸°";
          content.innerHTML = createEventFormHTML();
          modal.classList.remove("hidden");
          bindEventForm();
        } else if (mode === "edit" && eventId) {
          // ìˆ˜ì • ëª¨ë“œ: editingEventId ì„¤ì •
          if (typeof editingEventId !== "undefined") {
            editingEventId = eventId;
          }
          title.textContent = "ğŸ“… ì´ë²¤íŠ¸ ìˆ˜ì •";
          content.innerHTML = createEventFormHTML();
          modal.classList.remove("hidden");
          bindEventForm();
          // DOMì´ ë Œë”ë§ëœ í›„ í¼ ë¡œë“œ
          setTimeout(() => {
            loadEventToForm(eventId);
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì • ëª¨ë“œë¡œ ë³€ê²½
            const saveBtn = document.getElementById("save-event-btn");
            if (saveBtn) {
              saveBtn.innerHTML =
                '<i class="fas fa-edit mr-2"></i>ì´ë²¤íŠ¸ ìˆ˜ì •í•˜ê¸°';
            }
          }, 0);
        }
      }

      function closeEventModal() {
        const modal = document.getElementById("event-modal");
        modal.classList.add("hidden");
        resetEventForm();
      }

      // ===================== ë¯¸ì‹íšŒ í¼ HTML ìƒì„± =====================
      function createTastingFormHTML() {
        return `
                <div class="space-y-6">
                  <!-- ë¯¸ì‹íšŒ ê¸°ë³¸ ì •ë³´ -->
                  <div class="bg-gradient-to-r from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl p-6">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-utensils text-white text-lg"></i>
                      </div>
                      <h4 class="text-xl font-bold text-gray-800">ë¯¸ì‹íšŒ ê¸°ë³¸ ì •ë³´</h4>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-heading text-orange-500 mr-2"></i>
                          ë¯¸ì‹íšŒ ì œëª© <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="tasting-title"
                          type="text"
                          placeholder="ì˜ˆ: í‘¸ë”” ê°€ì„ ë¯¸ì‹íšŒ, ì‹ ì´Œ ë§›ì§‘ íˆ¬ì–´"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-calendar-alt text-orange-500 mr-2"></i>
                          ë¯¸ì‹íšŒ ë‚ ì§œ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="tasting-datetime"
                          type="datetime-local"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-play text-orange-500 mr-2"></i>
                          ì‹ ì²­ ì‹œì‘ì¼
                        </label>
                        <input
                          id="tasting-registration-start"
                          type="datetime-local"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base"
                        >
                        <p class="text-xs text-gray-500 mt-1">ğŸš€ ì´ ì‹œê°„ë¶€í„° ì‹ ì²­ì´ ì‹œì‘ë©ë‹ˆë‹¤ (ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ ì‹ ì²­ ê°€ëŠ¥)</p>
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-clock text-orange-500 mr-2"></i>
                          ì‹ ì²­ ë§ˆê°ì¼ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="tasting-deadline"
                          type="datetime-local"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-users text-orange-500 mr-2"></i>
                          ì „ì²´ ì •ì› <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="tasting-limit"
                          type="number"
                          min="1"
                          placeholder="ì˜ˆ: 30"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base"
                          required
                        >
                        <p class="text-xs text-gray-500 mt-1">ì „ì²´ ì°¸ê°€ ê°€ëŠ¥ ì¸ì›ì„ ì…ë ¥í•˜ì„¸ìš”</p>
                      </div>
                    </div>
                  </div>

                  <!-- ì‹ë‹¹ ì¶”ê°€ ì„¹ì…˜ -->
                  <div class="bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-200 rounded-xl p-6">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-store text-white text-lg"></i>
                      </div>
                      <h4 class="text-xl font-bold text-gray-800">ì‹ë‹¹ ì¶”ê°€í•˜ê¸°</h4>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                      <p class="text-sm text-green-800 flex items-center gap-2">
                        <i class="fas fa-lightbulb"></i>
                        ë¯¸ì‹íšŒëŠ” ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‹ë‹¹ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. ê° ì‹ë‹¹ë³„ë¡œ ì •ì›ì„ ì„¤ì •í•  ìˆ˜ ìˆì–´ìš”!
                      </p>
                    </div>

                    <div id="tasting-restaurants-wrap" class="space-y-4 mb-4">
                      ${createRestaurantFieldHTML()}
                    </div>

                    <button
                      id="add-restaurant-btn"
                      type="button"
                      class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
                    >
                      <i class="fas fa-plus-circle text-lg"></i>
                      <span>ì‹ë‹¹ ì¶”ê°€í•˜ê¸°</span>
                    </button>
                  </div>

                  <!-- ì €ì¥ ë²„íŠ¼ -->
                  <div class="flex gap-4">
                    <button
                      id="save-tasting-btn"
                      type="button"
                      class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-4 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl text-lg"
                    >
                      <i class="fas fa-save mr-2"></i>
                      ë¯¸ì‹íšŒ ë§Œë“¤ê¸°
                    </button>
                    <button
                      id="reset-tasting-btn"
                      type="button"
                      class="px-6 py-4 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg transition-all"
                    >
                      <i class="fas fa-undo mr-2"></i>
                      ì´ˆê¸°í™”
                    </button>
                  </div>
                </div>
              `;
      }

      // ===================== ì´ë²¤íŠ¸ í¼ HTML ìƒì„± =====================
      function createEventFormHTML() {
        return `
                <div class="space-y-6">
                  <!-- ì´ë²¤íŠ¸ ê¸°ë³¸ ì •ë³´ -->
                  <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-6">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-calendar text-white text-lg"></i>
                      </div>
                      <h4 class="text-xl font-bold text-gray-800">ì´ë²¤íŠ¸ ê¸°ë³¸ ì •ë³´</h4>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-tag text-blue-500 mr-2"></i>
                          ì´ë²¤íŠ¸ ì¢…ë¥˜ <span class="text-red-500">*</span>
                        </label>
                        <select
                          id="event-type"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base bg-white"
                          required
                        >
                          <option value="general">ì¼ë°˜ ì´ë²¤íŠ¸</option>
                          <option value="mt">MT (Membership Training)</option>
                          <option value="assembly">ì´íšŒ</option>
                        </select>
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-heading text-blue-500 mr-2"></i>
                          ì´ë²¤íŠ¸ ì œëª© <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="event-title"
                          type="text"
                          placeholder="ì˜ˆ: í‘¸ë”” ê°€ì„ MT, ì •ê¸° ì´íšŒ"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                          ì´ë²¤íŠ¸ ë‚ ì§œ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="event-datetime"
                          type="datetime-local"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-play text-blue-500 mr-2"></i>
                          ì‹ ì²­ ì‹œì‘ì¼
                        </label>
                        <input
                          id="event-registration-start"
                          type="datetime-local"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                        >
                        <p class="text-xs text-gray-500 mt-1">ğŸš€ ì´ ì‹œê°„ë¶€í„° ì‹ ì²­ì´ ì‹œì‘ë©ë‹ˆë‹¤ (ë¹„ì›Œë‘ë©´ ì¦‰ì‹œ ì‹ ì²­ ê°€ëŠ¥)</p>
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-clock text-blue-500 mr-2"></i>
                          ì‹ ì²­ ë§ˆê°ì¼ <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="event-deadline"
                          type="datetime-local"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-users text-blue-500 mr-2"></i>
                          ì°¸ê°€ ì •ì› <span class="text-red-500">*</span>
                        </label>
                        <input
                          id="event-limit"
                          type="number"
                          min="1"
                          placeholder="ì˜ˆ: 20"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base"
                          required
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-eye text-blue-500 mr-2"></i>
                          ê³µê°œ ì„¤ì •
                        </label>
                        <select
                          id="event-status"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all text-base bg-white"
                        >
                          <option value="open">ê³µê°œ</option>
                          <option value="archived">ìˆ¨ê¹€</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ìˆ¨ê¹€ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì‚¬ìš©ìì—ê²Œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                      </div>
                    </div>
                  </div>

                  <!-- íšŒë¹„ ì •ë³´ (MT/ì´íšŒë§Œ) -->
                  <div id="payment-section" class="bg-gradient-to-r from-purple-50 to-purple-100 border-2 border-purple-200 rounded-xl p-6 hidden">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-credit-card text-white text-lg"></i>
                      </div>
                      <h4 class="text-xl font-bold text-gray-800">íšŒë¹„ ì…ê¸ˆ ì •ë³´</h4>
                    </div>

                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4">
                      <p class="text-sm text-purple-800 flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        ì‹œìŠ¤í…œ ì„¤ì •ì˜ ê³„ì¢Œ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ì •í•˜ì„¸ìš”.
                      </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-university text-purple-500 mr-2"></i>
                          ì€í–‰ëª…
                        </label>
                        <input
                          id="pay-bank"
                          type="text"
                          placeholder="ì˜ˆ: êµ­ë¯¼ì€í–‰"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-hashtag text-purple-500 mr-2"></i>
                          ê³„ì¢Œë²ˆí˜¸
                        </label>
                        <input
                          id="pay-number"
                          type="text"
                          placeholder="ì˜ˆ: 123-456-789012"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-user text-purple-500 mr-2"></i>
                          ì˜ˆê¸ˆì£¼
                        </label>
                        <input
                          id="pay-holder"
                          type="text"
                          placeholder="ì˜ˆ: í™ê¸¸ë™"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                        >
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-won-sign text-purple-500 mr-2"></i>
                          íšŒë¹„ ê¸ˆì•¡
                        </label>
                        <input
                          id="pay-amount"
                          type="number"
                          placeholder="ì˜ˆ: 50000"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                        >
                        <p class="text-xs text-gray-500 mt-1">ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 50000)</p>
                      </div>

                      <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-comment-dots text-purple-500 mr-2"></i>
                          ì…ê¸ˆ ì•ˆë‚´ (ì„ íƒì‚¬í•­)
                        </label>
                        <input
                          id="pay-note"
                          type="text"
                          placeholder="ì˜ˆ: ì…ê¸ˆ ì‹œ ì´ë¦„ ê¼­ ì ì–´ì£¼ì„¸ìš”"
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all text-base"
                        >
                      </div>
                    </div>
                  </div>

                  <!-- ì €ì¥ ë²„íŠ¼ -->
                  <div class="flex gap-4">
                    <button
                      id="save-event-btn"
                      type="button"
                      class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl text-lg"
                    >
                      <i class="fas fa-save mr-2"></i>
                      ì´ë²¤íŠ¸ ë§Œë“¤ê¸°
                    </button>
                    <button
                      id="reset-event-btn"
                      type="button"
                      class="px-6 py-4 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg transition-all"
                    >
                      <i class="fas fa-undo mr-2"></i>
                      ì´ˆê¸°í™”
                    </button>
                  </div>
                </div>
              `;
      }

      // ëª¨ë‹¬ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      document.addEventListener("click", (e) => {
        // ë¯¸ì‹íšŒ ë§Œë“¤ê¸° ë¸”ë¡ í´ë¦­
        if (e.target.closest("#create-tasting-block")) {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ë¯¸ì‹íšŒë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          openTastingModal("create");
        }
        // ì´ë²¤íŠ¸ ë§Œë“¤ê¸° ë¸”ë¡ í´ë¦­
        else if (e.target.closest("#create-event-block")) {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          openEventModal("create");
        }
        // ìë™ ë§ˆê° ë²„íŠ¼
        else if (e.target.id === "auto-close-btn") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ìë™ ë§ˆê°ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          autoCloseExpiredEvents();
        }
        // ë¯¸ì‹íšŒ ëª¨ë‹¬ ë‹«ê¸°
        else if (
          e.target.id === "tasting-modal-close" ||
          e.target.closest("#tasting-modal-close")
        ) {
          closeTastingModal();
        } else if (e.target.closest("#tasting-modal")) {
          if (e.target.id === "tasting-modal") {
            closeTastingModal();
          }
        }
        // ì´ë²¤íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
        else if (
          e.target.id === "event-modal-close" ||
          e.target.closest("#event-modal-close")
        ) {
          closeEventModal();
        } else if (e.target.closest("#event-modal")) {
          if (e.target.id === "event-modal") {
            closeEventModal();
          }
        }
      });

      // ===================== ë¯¸ì‹íšŒ í¼ ë°”ì¸ë”© =====================
      function bindTastingForm() {
        // ì‹ë‹¹ ì¶”ê°€ ë²„íŠ¼
        document
          .getElementById("add-restaurant-btn")
          ?.addEventListener("click", () => {
            const container = document.getElementById(
              "tasting-restaurants-wrap"
            );
            if (container) {
              container.insertAdjacentHTML(
                "beforeend",
                createRestaurantFieldHTML()
              );
            }
          });

        // ì‹ë‹¹ ì‚­ì œ ë²„íŠ¼
        document.addEventListener("click", (e) => {
          if (e.target.closest(".remove-restaurant")) {
            e.target.closest(".restaurant-row")?.remove();
          }
        });

        // ë¯¸ì‹íšŒ ì €ì¥ ë²„íŠ¼
        document
          .getElementById("save-tasting-btn")
          ?.addEventListener("click", async () => {
            await saveTastingEvent();
          });

        // ë¯¸ì‹íšŒ ì´ˆê¸°í™” ë²„íŠ¼
        document
          .getElementById("reset-tasting-btn")
          ?.addEventListener("click", () => {
            resetTastingForm();
          });
      }

      // ===================== ì´ë²¤íŠ¸ í¼ ë°”ì¸ë”© =====================
      function bindEventForm() {
        // ì´ë²¤íŠ¸ ì¢…ë¥˜ ë³€ê²½ ì‹œ íšŒë¹„ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ ë° ê³„ì¢Œ ì •ë³´ ìë™ ë¡œë“œ
        document
          .getElementById("event-type")
          ?.addEventListener("change", (e) => {
            const paymentSection = document.getElementById("payment-section");
            if (paymentSection) {
              if (e.target.value === "mt" || e.target.value === "assembly") {
                paymentSection.classList.remove("hidden");
                // ê³„ì¢Œ ì •ë³´ ìë™ ë¡œë“œ
                loadDefaultPaymentInfo();
              } else {
                paymentSection.classList.add("hidden");
              }
            }
          });

        // ì´ë²¤íŠ¸ ì €ì¥ ë²„íŠ¼
        document
          .getElementById("save-event-btn")
          ?.addEventListener("click", async () => {
            await saveEvent();
          });

        // ì´ë²¤íŠ¸ ì´ˆê¸°í™” ë²„íŠ¼
        document
          .getElementById("reset-event-btn")
          ?.addEventListener("click", () => {
            resetEventForm();
          });
      }

      // ê¸°ë³¸ íšŒë¹„ ì •ë³´ ë¡œë“œ í•¨ìˆ˜
      function loadDefaultPaymentInfo() {
        const d = duesSettings || {};
        const payBank = document.getElementById("pay-bank");
        const payNumber = document.getElementById("pay-number");
        const payHolder = document.getElementById("pay-holder");
        const payAmount = document.getElementById("pay-amount");
        const payNote = document.getElementById("pay-note");

        // ê¸°ì¡´ ê°’ì´ ì—†ì„ ë•Œë§Œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì±„ì›€
        if (payBank && !payBank.value) payBank.value = d.bank || "";
        if (payNumber && !payNumber.value) payNumber.value = d.number || "";
        if (payHolder && !payHolder.value) payHolder.value = d.holder || "";
        if (payAmount && !payAmount.value) payAmount.value = d.amount || "";
        if (payNote && !payNote.value) {
          payNote.value =
            (d.amount ? `íšŒë¹„ ${formatKRW(d.amount)} ` : "") + (d.note || "");
        }
      }

      // ===================== ë¯¸ì‹íšŒ ì €ì¥ í•¨ìˆ˜ =====================
      async function saveTastingEvent() {
        const title = document.getElementById("tasting-title")?.value.trim();
        const datetime = document.getElementById("tasting-datetime")?.value;
        const registrationStart = document.getElementById(
          "tasting-registration-start"
        )?.value;
        const deadline = document.getElementById("tasting-deadline")?.value;
        const limit = parseInt(
          document.getElementById("tasting-limit")?.value || "0",
          10
        );

        if (!title || !datetime || !deadline || !limit) {
          showAlert("ğŸ˜¥", "ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (
          registrationStart &&
          new Date(registrationStart) >= new Date(deadline)
        ) {
          showAlert("ğŸ˜¥", "ì‹ ì²­ ì‹œì‘ì¼ì€ ì‹ ì²­ ë§ˆê°ì¼ë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        if (new Date(deadline) >= new Date(datetime)) {
          showAlert("ğŸ˜¥", "ì‹ ì²­ ë§ˆê°ì¼ì€ ì´ë²¤íŠ¸ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        // ì‹ë‹¹ ì •ë³´ ìˆ˜ì§‘
        const restaurantRows = document.querySelectorAll(
          "#tasting-restaurants-wrap .restaurant-row"
        );
        const restaurants = [];

        // ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸ (editingEventIdê°€ ìˆëŠ”ì§€ í™•ì¸)
        const isEditMode =
          typeof editingEventId !== "undefined" && editingEventId;

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ)
        let existingEvent = null;
        if (isEditMode) {
          existingEvent = eventsData.find((e) => e.id === editingEventId);
        }

        for (const row of restaurantRows) {
          const name = row.querySelector("[data-field='name']")?.value.trim();
          const info = row.querySelector("[data-field='info']")?.value.trim();
          const capacity = parseInt(
            row.querySelector("[data-field='capacity']")?.value || "0",
            10
          );
          const category =
            row.querySelector("[data-field='category']")?.value || "ê¸°íƒ€";
          const restaurantId = row.getAttribute("data-id");

          if (name && capacity > 0) {
            let reservations = [];
            let waiting = [];

            // ìˆ˜ì • ëª¨ë“œì¼ ë•ŒëŠ” ê¸°ì¡´ ì‹ë‹¹ì˜ ì˜ˆì•½ ì •ë³´ë¥¼ ë³´ì¡´í•˜ê³  ì •ì›ì— ë§ì¶° ì¬ë°°ì¹˜
            if (isEditMode && existingEvent && existingEvent.restaurants) {
              const existingRestaurant = existingEvent.restaurants.find(
                (r) => r.id === restaurantId
              );

              if (existingRestaurant) {
                // ê¸°ì¡´ ì˜ˆì•½ìì™€ ëŒ€ê¸°ìë¥¼ ëª¨ë‘ í•©ì¹¨
                const allParticipants = [
                  ...(existingRestaurant.reservations || []),
                  ...(existingRestaurant.waiting || []),
                ];

                // ì‹ ì²­ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (appliedAt ë˜ëŠ” timestamp ê¸°ì¤€)
                allParticipants.sort((a, b) => {
                  const timeA =
                    a.appliedAt || a.timestamp
                      ? new Date(a.appliedAt || a.timestamp).getTime()
                      : 0;
                  const timeB =
                    b.appliedAt || b.timestamp
                      ? new Date(b.appliedAt || b.timestamp).getTime()
                      : 0;
                  return timeA - timeB;
                });

                // ì •ì›ì— ë§ì¶° ì˜ˆì•½ìì™€ ëŒ€ê¸°ì ë¶„ë¦¬
                reservations = allParticipants.slice(0, capacity);
                waiting = allParticipants.slice(capacity);
              }
            }

            restaurants.push({
              id: restaurantId,
              name,
              info,
              capacity,
              category,
              reservations,
              waiting,
            });
          }
        }

        if (restaurants.length === 0) {
          showAlert("ğŸ˜¥", "ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‹ë‹¹ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          if (isEditMode) {
            // ìˆ˜ì • ëª¨ë“œ
            await updateDoc(doc(db, "events", editingEventId), {
              title,
              datetime,
              registrationStart: registrationStart || null,
              deadline,
              limit,
              restaurants,
            });
            showAlert("ğŸ‰", "ë¯¸ì‹íšŒê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
          } else {
            // ìƒì„± ëª¨ë“œ
            await addDoc(collection(db, "events"), {
              type: "tasting",
              title,
              datetime,
              registrationStart: registrationStart || null,
              deadline,
              limit,
              status: "open",
              restaurants,
            });
            showAlert("ğŸ‰", "ë¯¸ì‹íšŒê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
          }

          closeTastingModal();
          renderAll();
        } catch (error) {
          console.error("ë¯¸ì‹íšŒ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert(
            "ğŸ˜¥",
            isEditMode
              ? "ë¯¸ì‹íšŒ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              : "ë¯¸ì‹íšŒ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        }
      }

      // ===================== ì´ë²¤íŠ¸ ì €ì¥ í•¨ìˆ˜ =====================
      async function saveEvent() {
        const type = document.getElementById("event-type")?.value;
        const title = document.getElementById("event-title")?.value.trim();
        const datetime = document.getElementById("event-datetime")?.value;
        const registrationStart = document.getElementById(
          "event-registration-start"
        )?.value;
        const deadline = document.getElementById("event-deadline")?.value;
        const limit = parseInt(
          document.getElementById("event-limit")?.value || "0",
          10
        );
        const status = document.getElementById("event-status")?.value || "open";

        if (!type || !title || !datetime || !deadline || !limit) {
          showAlert("ğŸ˜¥", "ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (
          registrationStart &&
          new Date(registrationStart) >= new Date(deadline)
        ) {
          showAlert("ğŸ˜¥", "ì‹ ì²­ ì‹œì‘ì¼ì€ ì‹ ì²­ ë§ˆê°ì¼ë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        if (new Date(deadline) >= new Date(datetime)) {
          showAlert("ğŸ˜¥", "ì‹ ì²­ ë§ˆê°ì¼ì€ ì´ë²¤íŠ¸ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        // ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸ (editingEventIdê°€ ìˆëŠ”ì§€ í™•ì¸)
        const isEditMode =
          typeof editingEventId !== "undefined" && editingEventId;

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì • ëª¨ë“œì¼ ë•Œë§Œ)
        let existingEvent = null;
        if (isEditMode) {
          existingEvent = eventsData.find((e) => e.id === editingEventId);
        }

        let applicants = [];
        let waiting = [];

        if (isEditMode && existingEvent) {
          // ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ì°¸ê°€ìì™€ ëŒ€ê¸°ìë¥¼ ëª¨ë‘ í•©ì¹¨
          const allParticipants = [
            ...(existingEvent.applicants || []),
            ...(existingEvent.waiting || []),
          ];

          // ì‹ ì²­ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (appliedAt ë˜ëŠ” timestamp ê¸°ì¤€)
          allParticipants.sort((a, b) => {
            const timeA =
              a.appliedAt || a.timestamp
                ? new Date(a.appliedAt || a.timestamp).getTime()
                : 0;
            const timeB =
              b.appliedAt || b.timestamp
                ? new Date(b.appliedAt || b.timestamp).getTime()
                : 0;
            return timeA - timeB;
          });

          // ì •ì›ì— ë§ì¶° ì°¸ê°€ìì™€ ëŒ€ê¸°ì ë¶„ë¦¬
          applicants = allParticipants.slice(0, limit);
          waiting = allParticipants.slice(limit);
        }

        const eventData = {
          type,
          title,
          datetime,
          registrationStart: registrationStart || null,
          deadline,
          limit,
          status,
          applicants,
          waiting,
        };

        // MT/ì´íšŒì¸ ê²½ìš° íšŒë¹„ ì •ë³´ ì¶”ê°€
        if (type === "mt" || type === "assembly") {
          const bank = document.getElementById("pay-bank")?.value.trim();
          const number = document.getElementById("pay-number")?.value.trim();
          const holder = document.getElementById("pay-holder")?.value.trim();
          const amount = document.getElementById("pay-amount")?.value.trim();
          const note = document.getElementById("pay-note")?.value.trim();

          if (bank || number || holder || amount || note) {
            eventData.payment = {
              bank,
              number,
              holder,
              amount: amount ? parseInt(amount) : null,
              note,
            };
          }
        }

        try {
          if (isEditMode) {
            // ìˆ˜ì • ëª¨ë“œ
            await updateDoc(doc(db, "events", editingEventId), eventData);
            showAlert("ğŸ‰", "ì´ë²¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
          } else {
            // ìƒì„± ëª¨ë“œ
            await addDoc(collection(db, "events"), eventData);
            showAlert("ğŸ‰", "ì´ë²¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
          }

          closeEventModal();
          renderAll();
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert(
            "ğŸ˜¥",
            isEditMode
              ? "ì´ë²¤íŠ¸ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
              : "ì´ë²¤íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          );
        }
      }

      // ===================== í¼ ì´ˆê¸°í™” í•¨ìˆ˜ =====================
      function resetTastingForm() {
        // editingEventId ì´ˆê¸°í™”
        if (typeof editingEventId !== "undefined") {
          editingEventId = null;
        }

        const titleInput = document.getElementById("tasting-title");
        if (titleInput) titleInput.value = "";

        const datetimeInput = document.getElementById("tasting-datetime");
        if (datetimeInput) datetimeInput.value = "";

        const registrationStartInput = document.getElementById(
          "tasting-registration-start"
        );
        if (registrationStartInput) registrationStartInput.value = "";

        const deadlineInput = document.getElementById("tasting-deadline");
        if (deadlineInput) deadlineInput.value = "";

        const limitInput = document.getElementById("tasting-limit");
        if (limitInput) limitInput.value = "";

        const container = document.getElementById("tasting-restaurants-wrap");
        if (container) {
          container.innerHTML = createRestaurantFieldHTML();
        }
      }

      function resetEventForm() {
        // ê¸°ì¡´ ì½”ë“œì™€ì˜ í˜¸í™˜ì„±ì„ ìœ„í•´ editingEventId ì´ˆê¸°í™”
        if (typeof editingEventId !== "undefined") {
          editingEventId = null;
        }

        // ì´ë²¤íŠ¸ ê¸°ë³¸ ì •ë³´ ì´ˆê¸°í™”
        const eventType = document.getElementById("event-type");
        if (eventType) eventType.value = "general";

        const eventTitle = document.getElementById("event-title");
        if (eventTitle) eventTitle.value = "";

        const eventDatetime = document.getElementById("event-datetime");
        if (eventDatetime) eventDatetime.value = "";

        const eventRegistrationStart = document.getElementById(
          "event-registration-start"
        );
        if (eventRegistrationStart) eventRegistrationStart.value = "";

        const eventDeadline = document.getElementById("event-deadline");
        if (eventDeadline) eventDeadline.value = "";

        const eventLimit = document.getElementById("event-limit");
        if (eventLimit) eventLimit.value = "";

        const eventStatus = document.getElementById("event-status");
        if (eventStatus) eventStatus.value = "open";

        // íšŒë¹„ ì •ë³´ ì´ˆê¸°í™”
        const payBank = document.getElementById("pay-bank");
        if (payBank) payBank.value = "";

        const payNumber = document.getElementById("pay-number");
        if (payNumber) payNumber.value = "";

        const payHolder = document.getElementById("pay-holder");
        if (payHolder) payHolder.value = "";

        const payAmount = document.getElementById("pay-amount");
        if (payAmount) payAmount.value = "";

        const payNote = document.getElementById("pay-note");
        if (payNote) payNote.value = "";

        // íšŒë¹„ ì„¹ì…˜ ìˆ¨ê¹€
        const paymentSection = document.getElementById("payment-section");
        if (paymentSection) paymentSection.classList.add("hidden");

        // ê¸°ì¡´ êµ¬ì¡°ì™€ì˜ í˜¸í™˜ì„±ì„ ìœ„í•œ ì¶”ê°€ ì´ˆê¸°í™”
        const tastingFields = document.getElementById("tasting-fields");
        if (tastingFields) tastingFields.classList.remove("hidden");

        const paymentFields = document.getElementById("payment-fields");
        if (paymentFields) paymentFields.classList.add("hidden");

        const eventRestaurantsWrap = document.getElementById(
          "event-restaurants-wrap"
        );
        if (eventRestaurantsWrap) {
          // ìƒˆë¡œìš´ createRestaurantFieldHTML í•¨ìˆ˜ ì‚¬ìš©
          if (typeof createRestaurantFieldHTML === "function") {
            eventRestaurantsWrap.innerHTML = createRestaurantFieldHTML();
          }
        }
      }

      // ===================== ì‹ë‹¹ í•„ë“œ HTML ìƒì„± =====================
      function createRestaurantFieldHTML(
        n = "",
        i = "",
        c = "",
        category = "ê¸°íƒ€",
        existingId = null
      ) {
        const rid =
          (existingId && typeof existingId === "string" && existingId.trim()) ||
          `res_${Math.random().toString(36).slice(2, 9)}`;
        return `
                <div class="restaurant-row bg-gradient-to-br from-white to-green-50 border-2 border-green-300 rounded-xl p-5 relative" data-id="${rid}">
                  <!-- ì‚­ì œ ë²„íŠ¼ -->
                  <button type="button" class="remove-restaurant absolute top-3 right-3 bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full transition-all shadow-md hover:shadow-lg flex items-center justify-center" title="ì´ ì‹ë‹¹ ì‚­ì œ">
                    <i class="fas fa-trash text-sm"></i>
                  </button>

                  <div class="space-y-4">
                    <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-tags text-green-500 mr-2"></i>
                        ìŒì‹ ì¢…ë¥˜ <span class="text-red-500">*</span>
                      </label>
                      <select data-field="category" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base bg-white" required>
                        ${restaurantCategories
                          .map(
                            (cat) => `
                          <option value="${cat.name}" ${
                              category === cat.name ? "selected" : ""
                            }>${cat.emoji} ${cat.name}</option>
                        `
                          )
                          .join("")}
                      </select>
                    </div>

                    <!-- ì…ë ¥ í•„ë“œë“¤ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-utensils text-green-500 mr-2"></i>
                          ì‹ë‹¹ ì´ë¦„ <span class="text-red-500">*</span>
                        </label>
                        <input data-field="name" type="text" value="${saf(
                          n
                        )}" placeholder="ì˜ˆ: ë§›ìˆëŠ” íŒŒìŠ¤íƒ€ì§‘" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base" required>
                      </div>

                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          <i class="fas fa-users text-green-500 mr-2"></i>
                          ì •ì› <span class="text-red-500">*</span>
                        </label>
                        <input data-field="capacity" type="number" min="1" value="${saf(
                          c
                        )}" placeholder="ì˜ˆ: 10" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base" required>
                      </div>
                    </div>

                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-utensils text-green-500 mr-2"></i>
                        ëŒ€í‘œ ë©”ë‰´ <span class="text-red-500">*</span>
                      </label>
                      <textarea data-field="info" rows="3" placeholder="ì´ ì‹ë‹¹ì˜ ëŒ€í‘œ ë©”ë‰´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”&#10;ì˜ˆ: í† ë§ˆí†  íŒŒìŠ¤íƒ€, í¬ë¦¼ ë¦¬ì¡°ë˜, ë§ˆë¥´ê²Œë¦¬íƒ€ í”¼ì" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all text-base resize-none" required>${saf(
                        i
                      )}</textarea>
                      <p class="text-xs text-gray-500 mt-1">ğŸ½ï¸ ì´ ì‹ë‹¹ì—ì„œ ê¼­ ë¨¹ì–´ë´ì•¼ í•  ë©”ë‰´ë¥¼ ì ì–´ì£¼ì„¸ìš”</p>
                    </div>
                  </div>
                </div>
              `;
      }

      // ì´ë²¤íŠ¸ ì•¡ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬
      document.addEventListener("click", (e) => {
        const actionButton = e.target.closest("[data-act]");
        if (!actionButton) return;

        const act = actionButton.dataset.act;
        const id = actionButton.dataset.id;
        const rid = actionButton.dataset.rid;

        onEventActionClick(act, id, rid);
      });

      document.addEventListener("click", (e) => {
        const toggleButton = e.target.closest("[data-review-toggle]");
        if (!toggleButton) return;
        const toggleId = toggleButton.dataset.reviewToggle;
        const hiddenContainer = document.getElementById(`${toggleId}-hidden`);
        if (!hiddenContainer) return;
        const isHidden = hiddenContainer.classList.toggle("hidden");
        const count = Number(toggleButton.dataset.reviewCount || "0");
        toggleButton.innerHTML = isHidden
          ? `<i class="fas fa-chevron-down"></i>ì™¸ ${count}ê°œ ë¦¬ë·° ë³´ê¸°`
          : '<i class="fas fa-chevron-up"></i>ë¦¬ë·° ì ‘ê¸°';
      });

      function onEventActionClick(act, id, rid) {
        if (act === "reserve-general") return reserveGeneral(id);
        if (act === "cancel-general") return cancelGeneral(id);
        if (act === "cancel-wait-general") return cancelWaitGeneral(id);
        if (act === "reserve-tasting") return reserveTasting(id, rid);
        if (act === "cancel-tasting") return cancelTasting(id, rid);
        if (act === "cancel-wait-tasting") return cancelWaitTasting(id, rid);
        if (act === "admin-cancel") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return cancelEventForAdmin(id);
        }
        if (act === "admin-edit") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          // ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ì˜¬ë°”ë¥¸ ëª¨ë‹¬ ì—´ê¸°
          const event = eventsData.find((e) => e.id === id);
          if (event && event.type === "tasting") {
            return openTastingModal("edit", id);
          } else {
            return openEventModal("edit", id);
          }
        }
        if (act === "admin-close") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return closeEvent(id);
        }
        if (act === "admin-reopen") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return reopenEvent(id);
        }
        if (act === "admin-archive") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return archiveEvent(id);
        }
        if (act === "admin-unpost") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return unpostEvent(id);
        }
        if (act === "group-maker") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return openGroupMakerModal(id);
        }
        if (act === "admin-delete") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return deleteEvent(id);
        }
        if (act === "export-xlsx") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ëª…ë‹¨ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return exportApplicantsXLSX(id);
        }
        if (act === "write-review") {
          const event = eventsData.find((e) => e.id === id);
          if (event && (event.type === "mt" || event.type === "assembly")) {
            showAlert("â„¹ï¸", "MTì™€ ì´íšŒëŠ” í›„ê¸° ì‘ì„±ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
          }
          return openReviewModal(id);
        }
        if (act === "admin-confirm-activity") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ í™œë™ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return confirmActivity(id);
        }
        if (act === "admin-cancel-activity") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ í™œë™ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return cancelActivity(id);
        }
      }

      // ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("click", (e) => {
        if (e.target.closest('[data-act="move-event-up"]')) {
          const eventId = e.target.closest('[data-act="move-event-up"]').dataset
            .id;
          moveEventUp(eventId);
        }

        if (e.target.closest('[data-act="move-event-down"]')) {
          const eventId = e.target.closest('[data-act="move-event-down"]')
            .dataset.id;
          moveEventDown(eventId);
        }
      });

      // ì´ë²¤íŠ¸ ë°ì´í„°ë¥¼ í¼ì— ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
      function loadEventToForm(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) return;

        editingEventId = eventId;

        // null ì²´í¬ ì¶”ê°€
        const eventType = document.getElementById("event-type");
        const eventTitle = document.getElementById("event-title");
        const eventDatetime = document.getElementById("event-datetime");
        const eventRegistrationStart = document.getElementById(
          "event-registration-start"
        );
        const eventDeadline = document.getElementById("event-deadline");
        const eventLimit = document.getElementById("event-limit");
        const eventStatus = document.getElementById("event-status");

        if (eventType) eventType.value = event.type || "tasting";
        if (eventTitle) eventTitle.value = event.title || "";
        if (eventDatetime) {
          eventDatetime.value = formatDateTimeForInput(event.datetime);
        }
        if (eventRegistrationStart) {
          eventRegistrationStart.value = formatDateTimeForInput(
            event.registrationStart
          );
        }
        if (eventDeadline) {
          eventDeadline.value = formatDateTimeForInput(event.deadline);
        }
        if (eventLimit) eventLimit.value = event.limit || "";
        if (eventStatus) eventStatus.value = event.status || "open";

        // íšŒë¹„ ì •ë³´ ë¡œë“œ (MT/ì´íšŒì¸ ê²½ìš°)
        const p = event.payment || {};
        const payBank = document.getElementById("pay-bank");
        const payNumber = document.getElementById("pay-number");
        const payHolder = document.getElementById("pay-holder");
        const payAmount = document.getElementById("pay-amount");
        const payNote = document.getElementById("pay-note");

        if (payBank) payBank.value = p.bank || "";
        if (payNumber) payNumber.value = p.number || "";
        if (payHolder) payHolder.value = p.holder || "";
        if (payAmount) payAmount.value = p.amount || "";
        if (payNote) payNote.value = p.note || "";

        // íšŒë¹„ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
        const paymentSection = document.getElementById("payment-section");
        if (paymentSection) {
          if (event.type === "mt" || event.type === "assembly") {
            paymentSection.classList.remove("hidden");
          } else {
            paymentSection.classList.add("hidden");
          }
        }

        // ì‹ë‹¹ ì •ë³´ ë¡œë“œ
        const wrap = document.getElementById("event-restaurants-wrap");
        if (wrap) {
          if (event.type === "tasting" && event.restaurants) {
            wrap.innerHTML =
              event.restaurants
                .map((r) =>
                  createRestaurantFieldHTML(
                    r.name || "",
                    r.info || "",
                    r.capacity || "",
                    r.category || "ê¸°íƒ€",
                    r.id || null
                  )
                )
                .join("") || createRestaurantFieldHTML();
          } else {
            wrap.innerHTML = createRestaurantFieldHTML();
          }
        }
      }

      /* ===== í‰ê°€ ì‘ì„± ê¸°ëŠ¥ ===== */
      function openReviewModal(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) return;

        // MTì™€ ì´íšŒëŠ” í›„ê¸° ì‘ì„± ë¶ˆê°€
        if (event.type === "mt" || event.type === "assembly") {
          showAlert("â„¹ï¸", "MTì™€ ì´íšŒëŠ” í›„ê¸° ì‘ì„±ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }

        const existingReview = event.reviews?.find(
          (r) => r.studentId === currentUser.studentId
        );

        const formatReviewDateTime = (value) => {
          const date = toDateSafe(value);
          if (!date) return "ì¼ì‹œ ë¯¸ì •";
          const weekday = date.toLocaleDateString("ko-KR", {
            weekday: "short",
          });
          return `${date.toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })} (${weekday}) ${date.toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit",
          })}`;
        };

        const participation = getParticipationDetails(event);
        const typeLabelText = typeLabel(event.type) || "ì´ë²¤íŠ¸";
        const eventDateDisplay = formatReviewDateTime(event.datetime);
        const highlightTitle =
          event.type === "tasting" && participation.restaurantName
            ? participation.restaurantName
            : event.title || "ì´ë²¤íŠ¸";
        const highlightSubtitle =
          event.type === "tasting" && participation.restaurantName
            ? event.title || ""
            : "";
        const selectedRestaurant =
          event.type === "tasting" && Array.isArray(event.restaurants)
            ? event.restaurants.find((restaurant) => {
                const rid =
                  restaurant.id ||
                  restaurant.rid ||
                  restaurant.restaurantId ||
                  restaurant.name ||
                  "";
                if (participation.restaurantId) {
                  return participation.restaurantId === rid;
                }
                return (restaurant.name || "") === participation.restaurantName;
              }) || null
            : null;
        const highlightMenu = selectedRestaurant?.info || "";
        const highlightStats =
          event.type === "tasting" && participation.restaurantInfo
            ? `
                      <div class="mt-3 flex flex-wrap justify-center gap-2 text-[11px] md:text-xs text-orange-700">
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-white/70 rounded-full border border-orange-200">
                          <i class="fas fa-users"></i>ì •ì› ${
                            participation.restaurantInfo.capacity ?? "-"
                          }ëª…
                        </span>
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-white/70 rounded-full border border-orange-200">
                          <i class="fas fa-user-check"></i>ì‹ ì²­ ${
                            participation.restaurantInfo.reservations ?? 0
                          }ëª…
                        </span>
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-white/70 rounded-full border border-orange-200">
                          <i class="fas fa-user-clock"></i>ëŒ€ê¸° ${
                            participation.restaurantInfo.waiting ?? 0
                          }ëª…
                        </span>
                      </div>
                    `
            : "";
        const highlightSection = `
                <div class="rounded-3xl bg-gradient-to-br from-orange-100 via-white to-orange-50 border border-orange-200 shadow-sm px-4 py-5 text-center space-y-2">
                  <div class="inline-flex items-center justify-center gap-2 text-[11px] md:text-xs font-semibold uppercase tracking-wider text-orange-600">
                    <i class="fas fa-pen-nib"></i>${saf(typeLabelText)} í›„ê¸°
                  </div>
                  <div class="text-2xl md:text-3xl font-black text-orange-900 leading-tight">
                    ${saf(highlightTitle)}
                  </div>
                  <div class="text-sm md:text-base font-semibold text-gray-800 tracking-tight">
                    ${saf(eventDateDisplay)}
                  </div>
                  ${
                    highlightSubtitle
                      ? `<div class="text-[12px] md:text-sm text-gray-500">${saf(
                          highlightSubtitle
                        )}</div>`
                      : ""
                  }
                  ${
                    highlightMenu
                      ? `<div class="mt-3 inline-flex items-start gap-2 rounded-2xl bg-white/80 px-3 py-2 text-left text-xs md:text-sm text-gray-700 border border-orange-200 shadow-inner">
                          <span class="text-orange-500 font-semibold flex items-center gap-1">
                            <i class="fas fa-utensils"></i>ëŒ€í‘œ ë©”ë‰´
                          </span>
                          <span class="font-medium leading-snug">${saf(
                            highlightMenu
                          )}</span>
                        </div>`
                      : ""
                  }
                  ${highlightStats}
                </div>
              `;

        document.getElementById(
          "review-modal-title"
        ).textContent = `${event.title} í‰ê°€`;
        document.getElementById("review-modal-content").innerHTML = `
                <div class="space-y-4 md:space-y-5">
                  ${highlightSection}

                  <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1 md:mb-2">í‰ì </label>
                    <div class="flex gap-0.5 md:gap-1 mb-1 md:mb-2 items-center justify-center" id="rating-stars">
                      ${Array.from({ length: 5 }, (_, i) => {
                        const rating = i + 1;
                        const currentRating = existingReview?.rating || 0;
                        const isSelected = rating <= currentRating;

                        return `<button type="button" class="star-rating-btn text-2xl md:text-3xl transition-all hover:scale-110 active:scale-95" data-rating="${rating}">
                          <i class="fas fa-star ${
                            isSelected ? "text-yellow-400" : "text-gray-300"
                          }"></i>
                        </button>`;
                      }).join("")}
                    </div>
                    <p class="text-xs text-gray-500 text-center hidden md:block">
                      1ì  ë‹¨ìœ„ë¡œ í‰ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë³„ì„ í´ë¦­í•˜ì„¸ìš”)
                    </p>
                    <div class="text-center mt-1 md:mt-2">
                      <span class="text-xl md:text-2xl font-bold text-orange-600" id="current-rating-display">${
                        existingReview?.rating || 0
                      }</span>
                      <span class="text-xs md:text-sm text-gray-600">ì </span>
                    </div>
                  </div>

                  <div>
                    <label for="review-comment" class="block text-xs md:text-sm font-medium text-gray-700 mb-1 md:mb-2">
                      í›„ê¸° <span class="text-gray-500 font-normal">(ì„ íƒì‚¬í•­)</span>
                    </label>
                    <textarea
                      id="review-comment"
                      rows="3"
                      class="md:rows-4 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-sm"
                      placeholder="ì´ë²¤íŠ¸ì— ëŒ€í•œ ì†Œê°ì´ë‚˜ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”... (ë³„ì ë§Œ ì„ íƒí•´ë„ ì €ì¥ë©ë‹ˆë‹¤)"
                      autocomplete="off"
                      spellcheck="false"
                      data-no-autocomplete="true"
                      data-lpignore="true"
                      data-form-type="other">${
                        existingReview?.comment || ""
                      }</textarea>
                  </div>

                  <div class="flex gap-2 md:gap-3 pt-2 md:pt-4">
                    <button type="button" id="save-review" class="flex-1 bg-orange-500 text-white py-2 px-3 md:px-4 rounded-lg hover:bg-orange-600 transition-colors text-sm">
                      <i class="fas fa-save mr-1 md:mr-2"></i>
                      ${existingReview ? "ìˆ˜ì •í•˜ê¸°" : "ì €ì¥í•˜ê¸°"}
                    </button>
                    <button type="button" id="cancel-review" class="flex-1 bg-gray-500 text-white py-2 px-3 md:px-4 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                      ì·¨ì†Œ
                    </button>
                  </div>
                </div>
              `;

        // ë³„ì  í´ë¦­ ì´ë²¤íŠ¸ (0.5ì  ë‹¨ìœ„)
        let selectedRating = existingReview?.rating || 0;

        const updateStarDisplay = (rating) => {
          document.querySelectorAll(".star-rating-btn").forEach((btn) => {
            const btnRating = parseFloat(btn.dataset.rating);
            const star = btn.querySelector("i");

            // star ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (star) {
              // ëª¨ë“  ìƒ‰ìƒ í´ë˜ìŠ¤ì™€ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
              star.classList.remove(
                "text-gray-300",
                "text-yellow-300",
                "text-yellow-400"
              );
              star.style.opacity = "";

              // ì„ íƒëœ ë³„ì ì— ë”°ë¼ ìƒ‰ìƒ ì ìš©
              if (btnRating <= rating && rating > 0) {
                star.classList.add("text-yellow-400");
                star.style.opacity = "1";
              } else {
                star.classList.add("text-gray-300");
                star.style.opacity = "1";
              }

              star.style.transition = "color 0.2s ease, opacity 0.2s ease";
            }
          });

          // í˜„ì¬ ì ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
          const ratingDisplay = document.getElementById(
            "current-rating-display"
          );
          if (ratingDisplay) {
            ratingDisplay.textContent = rating || 0;
            ratingDisplay.style.transition = "all 0.2s ease";
            if (rating > 0) {
              ratingDisplay.style.transform = "scale(1.1)";
              setTimeout(() => {
                ratingDisplay.style.transform = "scale(1)";
              }, 200);
            }
          }
        };

        // ì´ˆê¸° ë³„ì  í‘œì‹œ ì—…ë°ì´íŠ¸
        updateStarDisplay(selectedRating);

        // ë³„ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll(".star-rating-btn").forEach((btn) => {
          // í˜¸ë²„ íš¨ê³¼: ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ë¯¸ë¦¬ë³´ê¸°
          btn.addEventListener("mouseenter", () => {
            const hoverRating = parseFloat(btn.dataset.rating);
            document.querySelectorAll(".star-rating-btn").forEach((b) => {
              const bRating = parseFloat(b.dataset.rating);
              const star = b.querySelector("i");
              if (star) {
                // í˜¸ë²„ ì‹œì—ë§Œ ë¯¸ë¦¬ë³´ê¸° (ì—°í•œ ë…¸ë€ìƒ‰)
                if (bRating <= hoverRating) {
                  star.classList.remove("text-gray-300", "text-yellow-400");
                  star.classList.add("text-yellow-300");
                  star.style.opacity = "0.8";
                } else {
                  star.classList.remove("text-yellow-300", "text-yellow-400");
                  star.classList.add("text-gray-300");
                  star.style.opacity = "0.5";
                }
              }
            });
          });

          // í˜¸ë²„ ì•„ì›ƒ: ì‹¤ì œ ì„ íƒëœ ë³„ì ìœ¼ë¡œ ë³µì›
          btn.addEventListener("mouseleave", () => {
            updateStarDisplay(selectedRating);
          });

          // í´ë¦­ ì´ë²¤íŠ¸ - ì¦‰ì‹œ ìƒ‰ìƒ ë°˜ì˜
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();

            selectedRating = parseFloat(btn.dataset.rating);

            // ì¦‰ì‹œ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            updateStarDisplay(selectedRating);

            // í´ë¦­ í”¼ë“œë°± ì• ë‹ˆë©”ì´ì…˜
            btn.style.transform = "scale(0.9)";
            setTimeout(() => {
              btn.style.transform = "scale(1)";
            }, 150);

            // í˜¸ë²„ ì´ë²¤íŠ¸ ì œê±° í›„ ë‹¤ì‹œ ì¶”ê°€ (í™•ì‹¤í•œ ìƒíƒœ ë³µì›)
            setTimeout(() => {
              updateStarDisplay(selectedRating);
            }, 200);
          });
        });

        // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        document
          .getElementById("save-review")
          .addEventListener("click", async () => {
            const comment = document
              .getElementById("review-comment")
              .value.trim();

            // ë³„ì ë§Œ ìˆì–´ë„ ì €ì¥ ê°€ëŠ¥ (ë³„ì  í•„ìˆ˜, í…ìŠ¤íŠ¸ëŠ” ì„ íƒì‚¬í•­)
            if (selectedRating === 0) {
              showAlert("âš ï¸", "í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              // ë³„ì ë§Œ ìˆì–´ë„ ë¦¬ë·° ì €ì¥ (commentëŠ” ë¹ˆ ë¬¸ìì—´ì´ì–´ë„ ë¨)
              await saveEventReview(eventId, selectedRating, comment || "");
              closeReviewModal();
              renderHistoryTab(isAdmin);
              const message = comment
                ? "í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
                : "ë³„ì  í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
              showAlert("âœ…", message);
            } catch (error) {
              showAlert("ğŸ˜¥", "í‰ê°€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          });

        // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document
          .getElementById("cancel-review")
          .addEventListener("click", closeReviewModal);

        document.getElementById("review-modal").classList.remove("hidden");
      }

      async function saveEventReview(eventId, rating, comment) {
        const eventRef = doc(db, "events", eventId);

        await runTransaction(
          db,
          async (transaction) => {
            const eventDoc = await transaction.get(eventRef);
            if (!eventDoc.exists())
              throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const eventData = eventDoc.data();
            const reviews = eventData.reviews || [];

            // ê¸°ì¡´ í‰ê°€ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€
            const existingIndex = reviews.findIndex(
              (r) => r.studentId === currentUser.studentId
            );
            const review = {
              studentId: currentUser.studentId,
              studentName: currentUser.name,
              name: currentUser.name, // ë¦¬ë·° í™”ë©´ì—ì„œ ì‚¬ìš©í•˜ëŠ” í•„ë“œ
              rating: rating,
              comment: comment || "", // í…ìŠ¤íŠ¸ëŠ” ì„ íƒì‚¬í•­ (ë¹ˆ ë¬¸ìì—´ í—ˆìš©)
              timestamp: new Date().toISOString(),
              createdAt:
                existingIndex >= 0
                  ? reviews[existingIndex].createdAt
                  : new Date().toISOString(),
              updatedAt: new Date().toISOString(),
            };

            if (existingIndex >= 0) {
              reviews[existingIndex] = review;
            } else {
              reviews.push(review);
            }

            transaction.update(eventRef, { reviews: reviews });
          },
          TRANSACTION_OPTIONS
        );

        // eventsData ì—…ë°ì´íŠ¸
        const eventIndex = eventsData.findIndex((e) => e.id === eventId);
        let updatedEventData = null;
        if (eventIndex >= 0) {
          const eventDoc = await getDoc(eventRef);
          if (eventDoc.exists()) {
            updatedEventData = { id: eventDoc.id, ...eventDoc.data() };
            eventsData[eventIndex] = updatedEventData;
            // ë¦¬ë·° íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë‹¤ì‹œ ë Œë”ë§
            if (currentMainTab === "roadmap") {
              scheduleRender();
            }
          }
        }

        // ë¯¸ì‹íšŒì¸ ê²½ìš° ë¯¸ì‹íšŒ í›„ê¸° í™”ë©´ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë„ë¡ ë³´ì¥
        if (updatedEventData && updatedEventData.type === "tasting") {
          // ë¯¸ì‹íšŒ í›„ê¸° í™”ë©´ì„ ë‹¤ì‹œ ë Œë”ë§í•˜ê¸° ìœ„í•´ roadmap íƒ­ì„ ë‹¤ì‹œ ë Œë”ë§
          setTimeout(() => {
            if (currentMainTab === "roadmap") {
              renderRoadmapTab(isAdmin());
            }
          }, 100);
        }
      }

      function closeReviewModal() {
        document.getElementById("review-modal").classList.add("hidden");
      }

      // í‰ê°€ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("click", (e) => {
        if (
          e.target.id === "review-modal-close" ||
          e.target.closest("#review-modal-close")
        ) {
          closeReviewModal();
        }
        if (e.target.id === "review-modal" && !e.target.closest(".bg-white")) {
          closeReviewModal();
        }
      });

      /* ===== ë¸”ë¡ ê´€ë¦¬ ëª¨ë‹¬ ê¸°ëŠ¥ ===== */
      function openBlockModal(
        blockType = null,
        blockId = null,
        position = null
      ) {
        const modal = document.getElementById("block-management-modal");
        const title = document.getElementById("block-modal-title");
        const content = document.getElementById("block-modal-content");

        if (blockType && blockId) {
          // í¸ì§‘ ëª¨ë“œ
          console.log("=== ë¸”ë¡ ìˆ˜ì • ëª¨ë“œ ===");
          console.log("blockType:", blockType);
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          const block = blocksData.find((b) => b.id === blockId);
          console.log("ì°¾ì€ ë¸”ë¡:", block);

          if (!block) {
            console.error("ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
            return;
          }

          title.textContent = `${getBlockTypeName(blockType)} ë¸”ë¡ ìˆ˜ì •`;
          content.innerHTML = generateBlockForm(blockType, block);

          // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ (í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ)
          setTimeout(() => {
            const loadExistingData = () => {
              console.log("=== loadExistingData í˜¸ì¶œë¨ (í¸ì§‘ ëª¨ë“œ) ===");
              console.log("blockType:", blockType);
              console.log("block:", block);

              if (blockType === "scores") {
                if (block?.payload?.teams) {
                  console.log("ê¸°ì¡´ íŒ€ ë°ì´í„° ë¡œë“œ ì¤‘...", block.payload.teams);
                  block.payload.teams.forEach((team) => {
                    console.log("íŒ€ ì¶”ê°€:", team);
                    addModalScoreRow(team.name || "", team.score || 0);
                  });
                } else {
                  console.log("ìƒˆ ë¸”ë¡ ìƒì„± - ê¸°ë³¸ í–‰ ì¶”ê°€");
                  addModalScoreRow("", 0);
                }
              } else if (blockType === "qa") {
                if (block?.payload?.items) {
                  block.payload.items.forEach((item) => {
                    addModalQAItem(item.q || "", item.a || "");
                  });
                } else {
                  addModalQAItem("", "");
                }
              }
            };
            loadExistingData();
          }, 100);
        } else {
          // ìƒì„± ëª¨ë“œ
          title.textContent = "ìƒˆ ê³µì§€ ì¶”ê°€";
          content.innerHTML = generateBlockTypeSelector();
        }

        modal.classList.remove("hidden");
      }

      function closeBlockModal() {
        document
          .getElementById("block-management-modal")
          .classList.add("hidden");
      }

      // Make functions globally accessible for onclick handlers
      window.closeBlockModal = closeBlockModal;
      window.addModalScoreRow = addModalScoreRow;
      window.addModalQAItem = addModalQAItem;

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.resetAllPositions = resetAllPositions;
      window.removePositionFromCategory = removePositionFromCategory;

      // íŠ¹ì • ì§ì±…ì„ ê°•ì œë¡œ ì™„ì „ ì œê±°í•˜ëŠ” í•¨ìˆ˜
      async function forceRemovePosition(position) {
        console.log("=== ê°•ì œ ì§ì±… ì œê±° í•¨ìˆ˜ í˜¸ì¶œ ===");
        console.log("ì œê±°í•  ì§ì±…:", position);

        try {
          // ì–‘ìª½ì—ì„œ ëª¨ë‘ ì œê±°
          const newPresidentPositions = presidentPositions.filter(
            (p) => p !== position
          );
          const newRegularPositions = regularPositions.filter(
            (p) => p !== position
          );

          console.log("ì œê±° í›„ íšŒì¥ë‹¨:", newPresidentPositions);
          console.log("ì œê±° í›„ ì¼ë°˜ ì„ì›:", newRegularPositions);

          // Firebaseì— ë™ì‹œ ì €ì¥
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: newPresidentPositions,
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: newRegularPositions,
            }),
          ]);

          // í•´ë‹¹ ì§ì±…ì„ ê°€ì§„ ëª¨ë“  ê´€ë¦¬ìì—ì„œ ì œê±°
          const newAdminPositions = { ...adminPositions };
          Object.keys(newAdminPositions).forEach((studentId) => {
            if (newAdminPositions[studentId] === position) {
              delete newAdminPositions[studentId];
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: newAdminPositions,
          });

          presidentPositions = newPresidentPositions;
          regularPositions = newRegularPositions;

          showAlert("âœ…", `"${position}" ì§ì±…ì´ ì™„ì „íˆ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          console.log("ê°•ì œ ì œê±° ì™„ë£Œ");
          location.reload();
        } catch (e) {
          console.error(e);
          showAlert("ğŸ˜¥", "ê°•ì œ ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.forceRemovePosition = forceRemovePosition;

      // Firebase ë°ì´í„°ë¥¼ ì§ì ‘ í™•ì¸í•˜ê³  ì •ë¦¬í•˜ëŠ” í•¨ìˆ˜
      async function debugAndFixPositions() {
        console.log("=== Firebase ë°ì´í„° ì§„ë‹¨ ì‹œì‘ ===");

        try {
          // Firebaseì—ì„œ ì§ì ‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          const [presidentSnap, regularSnap] = await Promise.all([
            getDoc(doc(db, "settings", "presidentPositions")),
            getDoc(doc(db, "settings", "regularPositions")),
          ]);

          const firebasePresidentPositions = presidentSnap.exists()
            ? presidentSnap.data().positions
            : [];
          const firebaseRegularPositions = regularSnap.exists()
            ? regularSnap.data().positions
            : [];

          console.log("Firebase íšŒì¥ë‹¨:", firebasePresidentPositions);
          console.log("Firebase ì¼ë°˜ ì„ì›:", firebaseRegularPositions);
          console.log("ë¡œì»¬ íšŒì¥ë‹¨:", presidentPositions);
          console.log("ë¡œì»¬ ì¼ë°˜ ì„ì›:", regularPositions);

          // ì¤‘ë³µëœ ì§ì±… ì°¾ê¸°
          const duplicates = firebasePresidentPositions.filter((pos) =>
            firebaseRegularPositions.includes(pos)
          );

          if (duplicates.length > 0) {
            console.log("ì¤‘ë³µëœ ì§ì±… ë°œê²¬:", duplicates);

            // ì¤‘ë³µ ì œê±°: ì¼ë°˜ ì„ì›ì—ì„œë§Œ ìœ ì§€
            const cleanPresidentPositions = firebasePresidentPositions.filter(
              (pos) => !firebaseRegularPositions.includes(pos)
            );

            console.log("ì •ë¦¬ëœ íšŒì¥ë‹¨:", cleanPresidentPositions);

            // Firebaseì— ì €ì¥
            await setDoc(doc(db, "settings", "presidentPositions"), {
              positions: cleanPresidentPositions,
            });

            console.log("ì¤‘ë³µ ì œê±° ì™„ë£Œ!");
            showAlert("âœ…", "ì¤‘ë³µëœ ì§ì±…ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
          } else {
            console.log("ì¤‘ë³µëœ ì§ì±…ì´ ì—†ìŠµë‹ˆë‹¤.");
            showAlert("â„¹ï¸", "ì¤‘ë³µëœ ì§ì±…ì´ ì—†ìŠµë‹ˆë‹¤.");
          }
        } catch (e) {
          console.error("ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜:", e);
          showAlert("ğŸ˜¥", "ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.debugAndFixPositions = debugAndFixPositions;

      // ì™„ì „íˆ ê¹¨ë—í•˜ê²Œ ì •ë¦¬í•˜ëŠ” í•¨ìˆ˜
      async function cleanAllPositions() {
        console.log("=== ì™„ì „ ì •ë¦¬ ì‹œì‘ ===");

        try {
          // íšŒì¥ë‹¨: íšŒì¥, ë¶€íšŒì¥ë§Œ
          const cleanPresidentPositions = ["íšŒì¥", "ë¶€íšŒì¥"];

          // ì¼ë°˜ ì„ì›: ìš´ì˜ì§„ë§Œ
          const cleanRegularPositions = ["ìš´ì˜ì§„"];

          console.log("ì •ë¦¬í•  íšŒì¥ë‹¨:", cleanPresidentPositions);
          console.log("ì •ë¦¬í•  ì¼ë°˜ ì„ì›:", cleanRegularPositions);

          // Firebaseì— ë™ì‹œ ì €ì¥
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: cleanPresidentPositions,
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: cleanRegularPositions,
            }),
          ]);

          // ëª¨ë“  ê´€ë¦¬ìì—ì„œ ê°œë°œì ì§ì±… ì œê±°
          const newAdminPositions = { ...adminPositions };
          Object.keys(newAdminPositions).forEach((studentId) => {
            if (newAdminPositions[studentId] === "ê°œë°œì") {
              delete newAdminPositions[studentId];
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: newAdminPositions,
          });

          console.log("ì™„ì „ ì •ë¦¬ ì™„ë£Œ!");
          showAlert("âœ…", "ëª¨ë“  ì§ì±…ì´ ê¸°ë³¸ ìƒíƒœë¡œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
          location.reload();
        } catch (e) {
          console.error("ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", e);
          showAlert("ğŸ˜¥", "ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.cleanAllPositions = cleanAllPositions;

      // Firebase ë°ì´í„°ë¥¼ ê°•ì œë¡œ ë®ì–´ì“°ëŠ” í•¨ìˆ˜
      async function forceOverwritePositions() {
        console.log("=== ê°•ì œ ë®ì–´ì“°ê¸° ì‹œì‘ ===");

        try {
          // 1ë‹¨ê³„: Firebase ë°ì´í„° ê°•ì œ ë®ì–´ì“°ê¸°
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: ["íšŒì¥", "ë¶€íšŒì¥"],
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: ["ìš´ì˜ì§„"],
            }),
          ]);

          console.log("Firebase ë°ì´í„° ë®ì–´ì“°ê¸° ì™„ë£Œ");

          // 2ë‹¨ê³„: ëª¨ë“  ê´€ë¦¬ìì—ì„œ ê°œë°œì ì§ì±… ì œê±°
          const newAdminPositions = {};
          Object.keys(adminPositions).forEach((studentId) => {
            const position = adminPositions[studentId];
            if (position && position !== "ê°œë°œì") {
              newAdminPositions[studentId] = position;
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: newAdminPositions,
          });

          console.log("ê´€ë¦¬ì ì§ì±… ì •ë¦¬ ì™„ë£Œ");

          // 3ë‹¨ê³„: ë¡œì»¬ ë³€ìˆ˜ëŠ” Firebase onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ìˆ˜ë™ ì—…ë°ì´íŠ¸ ì œê±°
          // (ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì§ì±…ì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œ ë°©ì§€)

          console.log("ë¡œì»¬ ë³€ìˆ˜ëŠ” Firebase ë¦¬ìŠ¤ë„ˆê°€ ìë™ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.");

          // 4ë‹¨ê³„: 2ì´ˆ í›„ ìƒˆë¡œê³ ì¹¨ (Firebase ë™ê¸°í™” ì‹œê°„ í™•ë³´)
          setTimeout(() => {
            showAlert("âœ…", "ê°•ì œ ì •ë¦¬ ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
            location.reload();
          }, 2000);
        } catch (e) {
          console.error("ê°•ì œ ë®ì–´ì“°ê¸° ì¤‘ ì˜¤ë¥˜:", e);
          showAlert("ğŸ˜¥", "ê°•ì œ ë®ì–´ì“°ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.forceOverwritePositions = forceOverwritePositions;

      // ë¦¬ìŠ¤ë„ˆë¥¼ ì¤‘ë‹¨í•˜ê³  ê°•ì œë¡œ ì •ë¦¬í•˜ëŠ” í•¨ìˆ˜
      async function nuclearCleanPositions() {
        console.log("=== í•µ ì •ë¦¬ ì‹œì‘ ===");

        try {
          // 1ë‹¨ê³„: Firebase ë¦¬ìŠ¤ë„ˆ ì¤‘ë‹¨
          if (unsubPublic.presidentPositions) {
            unsubPublic.presidentPositions();
            unsubPublic.presidentPositions = null;
            console.log("íšŒì¥ë‹¨ ë¦¬ìŠ¤ë„ˆ ì¤‘ë‹¨");
          }

          if (unsubPublic.regularPositions) {
            unsubPublic.regularPositions();
            unsubPublic.regularPositions = null;
            console.log("ì¼ë°˜ ì„ì› ë¦¬ìŠ¤ë„ˆ ì¤‘ë‹¨");
          }

          // 2ë‹¨ê³„: Firebase ë°ì´í„° ê°•ì œ ë®ì–´ì“°ê¸° (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
          for (let i = 0; i < 3; i++) {
            await Promise.all([
              setDoc(doc(db, "settings", "presidentPositions"), {
                positions: ["íšŒì¥", "ë¶€íšŒì¥"],
              }),
              setDoc(doc(db, "settings", "regularPositions"), {
                positions: ["ìš´ì˜ì§„"],
              }),
            ]);
            console.log(`Firebase ë®ì–´ì“°ê¸° ${i + 1}íšŒ ì™„ë£Œ`);
            await new Promise((resolve) => setTimeout(resolve, 500)); // 0.5ì´ˆ ëŒ€ê¸°
          }

          // 3ë‹¨ê³„: ê´€ë¦¬ì ë°ì´í„° ì •ë¦¬
          const cleanAdminPositions = {};
          Object.keys(adminPositions).forEach((studentId) => {
            const position = adminPositions[studentId];
            if (position && position !== "ê°œë°œì") {
              cleanAdminPositions[studentId] = position;
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: cleanAdminPositions,
          });

          // 4ë‹¨ê³„: ë¡œì»¬ ë³€ìˆ˜ëŠ” Firebase onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ìˆ˜ë™ ì—…ë°ì´íŠ¸ ì œê±°
          // (ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì§ì±…ì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œ ë°©ì§€)

          console.log("í•µ ì •ë¦¬ ì™„ë£Œ!");
          showAlert("âœ…", "í•µ ì •ë¦¬ ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");

          // 5ë‹¨ê³„: ë¦¬ìŠ¤ë„ˆ ì¬ì‹œì‘ì„ ìœ„í•´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            location.reload();
          }, 1000);
        } catch (e) {
          console.error("í•µ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:", e);
          showAlert("ğŸ˜¥", "í•µ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.nuclearCleanPositions = nuclearCleanPositions;

      // ìµœì¢… í•´ê²° í•¨ìˆ˜ - ëª¨ë“  ê²ƒì„ ì™„ì „íˆ ì •ë¦¬
      async function finalSolution() {
        console.log("=== ìµœì¢… í•´ê²° ì‹œì‘ ===");

        try {
          // 1ë‹¨ê³„: ëª¨ë“  Firebase ë¦¬ìŠ¤ë„ˆ ì¤‘ë‹¨
          if (unsubPublic.presidentPositions) {
            unsubPublic.presidentPositions();
            unsubPublic.presidentPositions = null;
          }
          if (unsubPublic.regularPositions) {
            unsubPublic.regularPositions();
            unsubPublic.regularPositions = null;
          }
          console.log("ëª¨ë“  ë¦¬ìŠ¤ë„ˆ ì¤‘ë‹¨ ì™„ë£Œ");

          // 2ë‹¨ê³„: Firebase ë°ì´í„° ì™„ì „ ì‚­ì œ í›„ ì¬ìƒì„±
          await deleteDoc(doc(db, "settings", "presidentPositions"));
          await deleteDoc(doc(db, "settings", "regularPositions"));
          console.log("ê¸°ì¡´ ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ");

          // 3ë‹¨ê³„: ìƒˆë¡œìš´ ê¹¨ë—í•œ ë°ì´í„° ìƒì„±
          await Promise.all([
            setDoc(doc(db, "settings", "presidentPositions"), {
              positions: ["íšŒì¥", "ë¶€íšŒì¥"],
            }),
            setDoc(doc(db, "settings", "regularPositions"), {
              positions: ["ìš´ì˜ì§„"],
            }),
          ]);
          console.log("ìƒˆë¡œìš´ ë°ì´í„° ìƒì„± ì™„ë£Œ");

          // 4ë‹¨ê³„: ê´€ë¦¬ì ë°ì´í„°ì—ì„œ ê°œë°œì ì™„ì „ ì œê±°
          const cleanAdminPositions = {};
          Object.keys(adminPositions).forEach((studentId) => {
            const position = adminPositions[studentId];
            if (position && position !== "ê°œë°œì") {
              cleanAdminPositions[studentId] = position;
            }
          });

          await setDoc(doc(db, "admins", "list"), {
            studentIds: adminList,
            positions: cleanAdminPositions,
          });
          console.log("ê´€ë¦¬ì ë°ì´í„° ì •ë¦¬ ì™„ë£Œ");

          // 5ë‹¨ê³„: ë¡œì»¬ ë³€ìˆ˜ëŠ” Firebase onSnapshotì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ìˆ˜ë™ ì—…ë°ì´íŠ¸ ì œê±°
          // (ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ì§ì±…ì´ ì‚¬ë¼ì§€ëŠ” ë¬¸ì œ ë°©ì§€)

          console.log("ìµœì¢… í•´ê²° ì™„ë£Œ!");
          showAlert("ğŸ‰", "ìµœì¢… í•´ê²° ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");

          // 6ë‹¨ê³„: ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            location.reload();
          }, 2000);
        } catch (e) {
          console.error("ìµœì¢… í•´ê²° ì¤‘ ì˜¤ë¥˜:", e);
          showAlert("ğŸ˜¥", "ìµœì¢… í•´ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.finalSolution = finalSolution;

      function getBlockTypeName(type) {
        const names = {
          notice: "ê³µì§€",
          qa: "Q&A",
          scores: "ì»¤ìŠ¤í…€ ì ìˆ˜íŒ",
          roadmap: "ë¡œë“œë§µ",
        };
        return names[type] || type;
      }

      function generateBlockTypeSelector() {
        return `
                <div class="space-y-4">
                  <h4 class="text-lg font-semibold text-gray-700">ë¸”ë¡ íƒ€ì… ì„ íƒ</h4>
                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button type="button" class="p-4 border-2 border-orange-200 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition-colors" onclick="selectBlockType('notice')">
                      <div class="text-center">
                        <i class="fas fa-bullhorn text-2xl text-orange-500 mb-2"></i>
                        <h5 class="font-semibold text-gray-800">ê³µì§€ ë¸”ë¡</h5>
                        <p class="text-sm text-gray-600">ì¤‘ìš”í•œ ê³µì§€ì‚¬í•­ì„ í‘œì‹œí•©ë‹ˆë‹¤</p>
                      </div>
                    </button>
                    <button type="button" class="p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors" onclick="selectBlockType('qa')">
                      <div class="text-center">
                        <i class="fas fa-question-circle text-2xl text-blue-500 mb-2"></i>
                        <h5 class="font-semibold text-gray-800">Q&A ë¸”ë¡</h5>
                        <p class="text-sm text-gray-600">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ê³¼ ë‹µë³€</p>
                      </div>
                    </button>
                    <button type="button" class="p-4 border-2 border-green-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-colors" onclick="selectBlockType('scores')">
                      <div class="text-center">
                        <i class="fas fa-trophy text-2xl text-green-500 mb-2"></i>
                        <h5 class="font-semibold text-gray-800">ì ìˆ˜íŒ ë¸”ë¡</h5>
                        <p class="text-sm text-gray-600">íŒ€ë³„ ì ìˆ˜ì™€ ìˆœìœ„ í‘œì‹œ</p>
                      </div>
                    </button>
                      </div>
                    </button>
                  </div>
                </div>
              `;
      }

      function selectBlockType(type) {
        const content = document.getElementById("block-modal-content");
        const title = document.getElementById("block-modal-title");

        title.textContent = `${getBlockTypeName(type)} ë¸”ë¡ ìƒì„±`;
        content.innerHTML = generateBlockForm(type);
      }

      // Make selectBlockType function globally accessible for onclick handlers
      window.selectBlockType = selectBlockType;

      function generateBlockForm(type, existingBlock = null) {
        const isEdit = !!existingBlock;

        if (type === "notice") {
          return `
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <input id="modal-notice-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì œëª©" value="${
                        existingBlock?.title || ""
                      }">
                      <select id="modal-notice-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                        <option value="true" ${
                          existingBlock?.visible !== false ? "selected" : ""
                        }>ë…¸ì¶œ</option>
                        <option value="false" ${
                          existingBlock?.visible === false ? "selected" : ""
                        }>ìˆ¨ê¹€</option>
                      </select>
                      <select id="modal-notice-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                        <option value="" ${
                          !existingBlock?.showWhen ? "selected" : ""
                        }>í•­ìƒ í‘œì‹œ</option>
                        <option value="login" ${
                          existingBlock?.showWhen === "login" ? "selected" : ""
                        }>ë¡œê·¸ì¸ì‹œë§Œ</option>
                        <option value="logout" ${
                          existingBlock?.showWhen === "logout" ? "selected" : ""
                        }>ë¡œê·¸ì•„ì›ƒì‹œë§Œ</option>
                      </select>
                    </div>
                    <textarea id="modal-notice-html" rows="6" class="w-full px-3 py-2 border rounded" placeholder="ë‚´ìš©(HTML/í…ìŠ¤íŠ¸)">${
                      existingBlock?.payload?.html || ""
                    }</textarea>
                    <div class="flex gap-3">
                      <button type="button" onclick="saveBlock('notice', '${
                        existingBlock?.id || ""
                      }')" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                              <i class="fas fa-save mr-2"></i>${
                                isEdit ? "ìˆ˜ì •" : "ìƒì„±"
                              }
                      </button>
                      <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                `;
          loadExistingData();
        }

        if (type === "qa") {
          return `
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <input id="modal-qa-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì œëª©" value="${
                        existingBlock?.title || ""
                      }">
                      <select id="modal-qa-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                        <option value="true" ${
                          existingBlock?.visible !== false ? "selected" : ""
                        }>ë…¸ì¶œ</option>
                        <option value="false" ${
                          existingBlock?.visible === false ? "selected" : ""
                        }>ìˆ¨ê¹€</option>
                      </select>
                      <select id="modal-qa-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                        <option value="" ${
                          !existingBlock?.showWhen ? "selected" : ""
                        }>í•­ìƒ í‘œì‹œ</option>
                        <option value="login" ${
                          existingBlock?.showWhen === "login" ? "selected" : ""
                        }>ë¡œê·¸ì¸ì‹œë§Œ</option>
                        <option value="logout" ${
                          existingBlock?.showWhen === "logout" ? "selected" : ""
                        }>ë¡œê·¸ì•„ì›ƒì‹œë§Œ</option>
                      </select>
                    </div>
                    <div id="modal-qa-items" class="space-y-2"></div>
                    <button type="button" onclick="addModalQAItem()" class="text-sm bg-blue-100 text-blue-700 border border-blue-300 px-3 py-1 rounded hover:bg-blue-200 transition-colors">
                      <i class="fas fa-plus mr-1"></i>ì§ˆë¬¸ ì¶”ê°€
                    </button>
                    <div class="flex gap-3">
                      <button type="button" onclick="saveBlock('qa', '${
                        existingBlock?.id || ""
                      }')" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                              <i class="fas fa-save mr-2"></i>${
                                isEdit ? "ìˆ˜ì •" : "ìƒì„±"
                              }
                      </button>
                      <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                `;
          loadExistingData();
        }

        if (type === "scores") {
          return `
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <input id="modal-scores-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ë¸”ë¡ ì´ë¦„(ì œëª©)" value="${
                        existingBlock?.title || ""
                      }">
                      <select id="modal-scores-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                        <option value="true" ${
                          existingBlock?.visible !== false ? "selected" : ""
                        }>ë…¸ì¶œ</option>
                        <option value="false" ${
                          existingBlock?.visible === false ? "selected" : ""
                        }>ìˆ¨ê¹€</option>
                      </select>
                      <select id="modal-scores-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                        <option value="" ${
                          !existingBlock?.showWhen ? "selected" : ""
                        }>í•­ìƒ í‘œì‹œ</option>
                        <option value="login" ${
                          existingBlock?.showWhen === "login" ? "selected" : ""
                        }>ë¡œê·¸ì¸ì‹œë§Œ</option>
                        <option value="logout" ${
                          existingBlock?.showWhen === "logout" ? "selected" : ""
                        }>ë¡œê·¸ì•„ì›ƒì‹œë§Œ</option>
                      </select>
                    </div>
                    <div id="modal-scores-rows" class="space-y-2"></div>
                    <button type="button" onclick="addModalScoreRow()" class="text-sm bg-green-100 text-green-700 border border-green-300 px-3 py-1 rounded hover:bg-green-200 transition-colors">
                      <i class="fas fa-plus mr-1"></i>íŒ€ ì¶”ê°€
                    </button>
                    <div class="flex gap-3">
                      <button type="button" onclick="saveBlock('scores', '${
                        existingBlock?.id || ""
                      }')" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                              <i class="fas fa-save mr-2"></i>${
                                isEdit ? "ìˆ˜ì •" : "ìƒì„±"
                              }
                      </button>
                      <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                `;
        }

        if (type === "roadmap") {
          return `
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <input id="modal-roadmap-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="í™œë™ ì´ë¦„" value="${
                        existingBlock?.title || ""
                      }">
                      <input id="modal-roadmap-date" type="date" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" value="${
                        existingBlock?.payload?.date || ""
                      }">
                      <select id="modal-roadmap-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                        <option value="true" ${
                          existingBlock?.visible !== false ? "selected" : ""
                        }>ë…¸ì¶œ</option>
                        <option value="false" ${
                          existingBlock?.visible === false ? "selected" : ""
                        }>ìˆ¨ê¹€</option>
                      </select>
                    </div>
                    <div class="space-y-3">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">í‘œì‹œ ì¡°ê±´</label>
                        <select id="modal-roadmap-showWhen" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                        <option value="" ${
                          !existingBlock?.showWhen ? "selected" : ""
                        }>í•­ìƒ í‘œì‹œ</option>
                        <option value="login" ${
                          existingBlock?.showWhen === "login" ? "selected" : ""
                        }>ë¡œê·¸ì¸ì‹œë§Œ</option>
                        <option value="logout" ${
                          existingBlock?.showWhen === "logout" ? "selected" : ""
                        }>ë¡œê·¸ì•„ì›ƒì‹œë§Œ</option>
                      </select>
                      <input id="modal-roadmap-order" type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ìˆœì„œ (ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ì•ì— í‘œì‹œ)" value="${
                        existingBlock?.order || ""
                      }">
                    </div>
                    <textarea id="modal-roadmap-description" rows="3" class="w-full px-3 py-2 border rounded" placeholder="í™œë™ ì„¤ëª… (ì„ íƒì‚¬í•­)">${
                      existingBlock?.payload?.description || ""
                    }</textarea>
                    <div class="flex gap-2">
                      <button type="button" onclick="saveBlock('roadmap', '${
                        existingBlock?.id || ""
                      }')" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                              <i class="fas fa-save mr-2"></i>${
                                isEdit ? "ìˆ˜ì •" : "ìƒì„±"
                              }
                      </button>
                      <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ì·¨ì†Œ
                      </button>
                    </div>
                  </div>
                `;
          loadExistingData();
        }

        return '<p class="text-gray-500">ì•Œ ìˆ˜ ì—†ëŠ” ë¸”ë¡ íƒ€ì…ì…ë‹ˆë‹¤.</p>';
      }

      // ë¸”ë¡ ì €ì¥ í•¨ìˆ˜
      async function saveBlock(type, blockId = null) {
        try {
          const isEdit = !!blockId;

          if (type === "notice") {
            const title = document
              .getElementById("modal-notice-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-notice-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-notice-showWhen")?.value || "";
            const html =
              document.getElementById("modal-notice-html")?.value || "";

            if (!title) {
              showAlert("ğŸ˜¥", "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "notice",
                title,
                visible,
                showWhen,
                payload: { html },
              });
              showAlert("âœ…", "ê³µì§€ ë¸”ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "notice",
                title,
                visible,
                showWhen,
                payload: { html },
                order: ord,
              });
              showAlert("ğŸ‰", "ê³µì§€ ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          }

          if (type === "qa") {
            const title = document
              .getElementById("modal-qa-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-qa-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-qa-showWhen")?.value || "";
            const items = getModalQAItems();

            if (!title) {
              showAlert("ğŸ˜¥", "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }
            if (items.length === 0) {
              showAlert("ğŸ˜¥", "ì§ˆë¬¸/ë‹µë³€ì„ 1ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");
              return;
            }

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "qa",
                title,
                visible,
                showWhen,
                payload: { items },
              });
              showAlert("âœ…", "Q&A ë¸”ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "qa",
                title,
                visible,
                showWhen,
                payload: { items },
                order: ord,
              });
              showAlert("ğŸ‰", "Q&A ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          }

          if (type === "scores") {
            const title = document
              .getElementById("modal-scores-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-scores-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-scores-showWhen")?.value || "";
            const teams = getModalScoreTeams();

            if (!title) {
              showAlert("ğŸ˜¥", "ë¸”ë¡ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }
            if (teams.length === 0) {
              showAlert("ğŸ˜¥", "ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¡°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
              return;
            }

            const payload = { teams };

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "scores",
                title,
                visible,
                showWhen,
                payload,
              });
              showAlert("âœ…", "ì ìˆ˜íŒ ë¸”ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "scores",
                title,
                visible,
                showWhen,
                payload,
                order: ord,
              });
              showAlert("ğŸ‰", "ì ìˆ˜íŒ ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          }

          if (type === "roadmap") {
            const title = document
              .getElementById("modal-roadmap-title")
              ?.value.trim();
            const date = document.getElementById("modal-roadmap-date")?.value;
            const visible =
              document.getElementById("modal-roadmap-visible")?.value ===
              "true";
            const showWhen =
              document.getElementById("modal-roadmap-showWhen")?.value || "";
            const order =
              parseInt(document.getElementById("modal-roadmap-order")?.value) ||
              0;
            const description =
              document
                .getElementById("modal-roadmap-description")
                ?.value.trim() || "";

            if (!title) {
              showAlert("ğŸ˜¥", "í™œë™ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }
            if (!date) {
              showAlert("ğŸ˜¥", "í™œë™ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            const payload = { date, description };

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "roadmap",
                title,
                visible,
                showWhen,
                order,
                payload,
              });
              showAlert("âœ…", "ë¡œë“œë§µ ë¸”ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "roadmap",
                title,
                visible,
                showWhen,
                order: order || ord,
                payload,
              });
              showAlert("ğŸ‰", "ë¡œë“œë§µ ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          }

          closeBlockModal();
          // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          if (document.getElementById("subtab-container")) {
            renderHomeBlocksAdmin(document.getElementById("subtab-container"));
          }
        } catch (error) {
          console.error("ë¸”ë¡ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // Make saveBlock function globally accessible for onclick handlers
      window.saveBlock = saveBlock;

      // ëª¨ë‹¬ Q&A ì•„ì´í…œ ìˆ˜ì§‘
      function getModalQAItems() {
        const rows = [...document.querySelectorAll("#modal-qa-items .qa-row")];
        return rows
          .map((row) => ({
            q: row.querySelector("[data-q]")?.value.trim() || "",
            a: row.querySelector("[data-a]")?.value.trim() || "",
          }))
          .filter((item) => item.q && item.a);
      }

      // ëª¨ë‹¬ ì ìˆ˜ íŒ€ ìˆ˜ì§‘
      function getModalScoreTeams() {
        const rows = [
          ...document.querySelectorAll("#modal-scores-rows .score-row"),
        ];
        return rows
          .map((row) => ({
            name: row.querySelector("[data-name]")?.value.trim() || "",
            score: Number(row.querySelector("[data-score]")?.value || 0),
          }))
          .filter((team) => team.name);
      }

      // ëª¨ë‹¬ Q&A ì•„ì´í…œ ì¶”ê°€
      function addModalQAItem(q = "", a = "") {
        const container = document.getElementById("modal-qa-items");
        if (!container) return;

        container.insertAdjacentHTML(
          "beforeend",
          `
                <div class="qa-row border rounded-lg p-4 bg-gray-50 mb-3">
                  <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì§ˆë¬¸</label>
                    <textarea data-q class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 min-h-[80px] resize-y" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì¤„ë°”ê¿ˆ(Enter)ìœ¼ë¡œ ë¬¸ë‹¨ì„ ë‚˜ëˆŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤">${saf(
                      q
                    )}</textarea>
                  </div>
                  <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‹µë³€</label>
                    <textarea data-a class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 min-h-[120px] resize-y" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì¤„ë°”ê¿ˆ(Enter)ìœ¼ë¡œ ë¬¸ë‹¨ì„ ë‚˜ëˆŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤">${saf(
                      a
                    )}</textarea>
                  </div>
                  <div class="flex justify-end">
                    <button type="button" class="remove-qa bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors" onclick="this.closest('.qa-row').remove()">
                      <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                    </button>
                  </div>
                </div>
              `
        );
      }

      // ëª¨ë‹¬ ì ìˆ˜ í–‰ ì¶”ê°€
      function addModalScoreRow(name = "", score = 0) {
        console.log("=== addModalScoreRow í˜¸ì¶œ ===");
        console.log("name:", name, "score:", score);

        const container = document.getElementById("modal-scores-rows");
        console.log("container:", container);

        if (!container) {
          console.error("modal-scores-rows ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        // ì¤‘ë³µ íŒ€ ì´ë¦„ ì²´í¬ (ë¹ˆ ì´ë¦„ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
        if (name.trim()) {
          const existingRows = container.querySelectorAll(".score-row");
          for (const row of existingRows) {
            const existingName = row.querySelector("[data-name]")?.value.trim();
            if (existingName && existingName === name.trim()) {
              showAlert("ğŸ˜¥", `"${name}" íŒ€ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
              return;
            }
          }
        }

        container.insertAdjacentHTML(
          "beforeend",
          `
                <div class="score-row grid grid-cols-12 gap-2">
                  <input data-name class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-7" placeholder="ì¡° ì´ë¦„" value="${saf(
                    name
                  )}">
                  <input data-score type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-4" placeholder="ì ìˆ˜" value="${saf(
                    score
                  )}">
                  <button type="button" class="remove-score-row text-red-600 col-span-1" onclick="this.closest('.score-row').remove()">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `
        );
        console.log("ì ìˆ˜ í–‰ ì¶”ê°€ ì™„ë£Œ");
      }

      // ë¸”ë¡ ê´€ë¦¬ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("click", (e) => {
        if (
          e.target.id === "block-modal-close" ||
          e.target.closest("#block-modal-close")
        ) {
          closeBlockModal();
        }
        if (
          e.target.id === "block-management-modal" &&
          !e.target.closest(".bg-white")
        ) {
          closeBlockModal();
        }
      });

      // ===================== (ë) =====================
    </script>

    <!-- ë¸”ë¡ ê´€ë¦¬ ëª¨ë‹¬ -->
    <div
      id="block-management-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9996]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="block-modal-title" class="text-2xl font-bold text-gray-800">
            ë¸”ë¡ ê´€ë¦¬
          </h3>
          <button
            id="block-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="block-modal-content">
          <!-- ë¸”ë¡ ê´€ë¦¬ í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <!-- í‰ê°€ ì‘ì„± ëª¨ë‹¬ -->
    <div
      id="review-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9997]"
    >
      <div class="bg-white p-4 md:p-8 rounded-2xl shadow-xl max-w-md w-full">
        <div class="flex justify-between items-center mb-4 md:mb-6">
          <h3
            id="review-modal-title"
            class="text-lg md:text-xl font-bold text-gray-800"
          >
            ì´ë²¤íŠ¸ í‰ê°€
          </h3>
          <button
            id="review-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="review-modal-content">
          <!-- í‰ê°€ í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <!-- ì´ë²¤íŠ¸ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <!-- ë¯¸ì‹íšŒ ìƒì„± ëª¨ë‹¬ -->
    <div
      id="tasting-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9998]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="tasting-modal-title" class="text-2xl font-bold text-gray-800">
            ğŸ½ï¸ ë¯¸ì‹íšŒ ë§Œë“¤ê¸°
          </h3>
          <button
            id="tasting-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
            title="ë‹«ê¸°"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="tasting-modal-content">
          <!-- ë¯¸ì‹íšŒ ìƒì„± í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <!-- ì´ë²¤íŠ¸ ìƒì„± ëª¨ë‹¬ -->
    <div
      id="event-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9998]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="event-modal-title" class="text-2xl font-bold text-gray-800">
            ğŸ“… ì´ë²¤íŠ¸ ë§Œë“¤ê¸°
          </h3>
          <button
            id="event-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
            title="ë‹«ê¸°"
            aria-label="ëª¨ë‹¬ ë‹«ê¸°"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="event-modal-content">
          <!-- ì´ë²¤íŠ¸ ìƒì„± í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <script>
      // ì„ì‹œ: íšŒì¥ë‹¨ì— ê¸°ì¡´ ì§ì±…ë“¤ ë³µì›í•˜ëŠ” í•¨ìˆ˜
      async function restorePresidentPositions() {
        try {
          const positionsToAdd = ["ì´ë¬´", "ê¸°íšë¶€ì¥", "í™ë³´ë¶€ì¥"];
          const currentPositions = [...presidentPositions];

          // ì´ë¯¸ ìˆëŠ” ì§ì±…ì€ ì œì™¸í•˜ê³  ì¶”ê°€
          const newPositions = [...currentPositions];
          positionsToAdd.forEach((pos) => {
            if (!newPositions.includes(pos)) {
              newPositions.push(pos);
            }
          });

          await setDoc(doc(db, "settings", "presidentPositions"), {
            positions: newPositions,
          });

          showAlert("âœ…", "íšŒì¥ë‹¨ì— ê¸°ì¡´ ì§ì±…ë“¤ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.");
          console.log("ë³µì›ëœ íšŒì¥ë‹¨ ì§ì±…:", newPositions);
        } catch (e) {
          console.error(e);
          showAlert("ğŸ˜¥", "ì§ì±… ë³µì›ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
      window.restorePresidentPositions = restorePresidentPositions;

      // ëª¨ë“  ì§ì±…ì„ ê¸°ë³¸ ìƒíƒœë¡œ ë¦¬ì…‹í•˜ëŠ” í•¨ìˆ˜
      async function resetAllPositions() {
        try {
          // íšŒì¥ë‹¨: íšŒì¥, ë¶€íšŒì¥ë§Œ
          const presidentPositions = ["íšŒì¥", "ë¶€íšŒì¥"];
          await setDoc(doc(db, "settings", "presidentPositions"), {
            positions: presidentPositions,
          });

          // ì¼ë°˜ ì„ì›: ìš´ì˜ì§„ë§Œ
          const regularPositions = ["ìš´ì˜ì§„"];
          await setDoc(doc(db, "settings", "regularPositions"), {
            positions: regularPositions,
          });

          showAlert("âœ…", "ëª¨ë“  ì§ì±…ì´ ê¸°ë³¸ ìƒíƒœë¡œ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.");
          console.log("ë¦¬ì…‹ëœ íšŒì¥ë‹¨:", presidentPositions);
          console.log("ë¦¬ì…‹ëœ ì¼ë°˜ ì„ì›:", regularPositions);

          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          location.reload();
        } catch (e) {
          console.error(e);
          showAlert("ğŸ˜¥", "ì§ì±… ë¦¬ì…‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }
    </script>
  </body>
</html>
