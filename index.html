<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="theme-color" content="#6366f1" />
    <title>Foodie</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Foodie" />
    <meta property="og:description" content="Foodie ë™ì•„ë¦¬ ì›¹ ì„œë¹„ìŠ¤" />
    <meta property="og:image" content="./icons/icon-512-new.png" />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta property="og:url" content="" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:title" content="Foodie" />
    <meta property="twitter:description" content="Foodie ë™ì•„ë¦¬ ì›¹ ì„œë¹„ìŠ¤" />
    <meta property="twitter:image" content="./icons/icon-512-new.png" />

    <!-- ì¼ë°˜ ë©”íƒ€ -->
    <meta name="description" content="Foodie ë™ì•„ë¦¬ ì›¹ ì„œë¹„ìŠ¤" />

    <!-- ì•± ì•„ì´ì½˜ -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./icons/favicon-32.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="./icons/apple-touch-icon-180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="./icons/icon-192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="./icons/icon-512.png"
    />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTML2Canvas for calendar download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Loading Animation -->
    <style>
      @keyframes dot-pulse {
        0%,
        100% {
          transform: scale(0.5);
          opacity: 0.3;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      /* ëª¨ë°”ì¼ í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ */
      * {
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
      }

      /* ëª¨ë°”ì¼ì—ì„œ í…ìŠ¤íŠ¸ í¬ê¸° ìµœì í™” */
      @media (max-width: 768px) {
        .text-sm {
          font-size: 0.875rem !important;
        }
        .text-base {
          font-size: 1rem !important;
        }
        .text-lg {
          font-size: 1.125rem !important;
        }
        .text-xl {
          font-size: 1.25rem !important;
        }
        .text-2xl {
          font-size: 1.5rem !important;
        }

        /* ê¸´ í…ìŠ¤íŠ¸ ìë™ ì¤„ë°”ê¿ˆ */
        .truncate {
          white-space: normal !important;
          overflow: visible !important;
          text-overflow: unset !important;
        }

        /* ëª¨ë°”ì¼ í™•ëŒ€ ë°©ì§€ ë° ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        body {
          -webkit-text-size-adjust: 100%;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          touch-action: manipulation;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        ::-webkit-scrollbar {
          width: 0px;
          background: transparent;
        }

        ::-webkit-scrollbar-track {
          background: transparent;
        }

        ::-webkit-scrollbar-thumb {
          background: transparent;
        }

        /* Firefoxìš© ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        html {
          scrollbar-width: none;
        }

        /* ì „ì²´ í™”ë©´ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        body {
          overflow-x: hidden;
        }

        /* ëª¨ë°”ì¼ì—ì„œ í™•ëŒ€ ë°©ì§€ */
        @media (max-width: 768px) {
          html {
            -webkit-text-size-adjust: none;
            -ms-text-size-adjust: none;
          }

          input,
          textarea,
          select {
            font-size: 16px !important;
          }
        }

        /* ë¸”ë¡ ì œëª© ìµœì í™” */
        .block-title {
          word-break: keep-all;
          line-height: 1.4;
          hyphens: auto;
        }

        /* ì¹´ë“œ ë‚´ í…ìŠ¤íŠ¸ ìµœì í™” */
        .card-text {
          word-break: keep-all;
          line-height: 1.5;
          overflow-wrap: break-word;
        }

        /* ë²„íŠ¼ í…ìŠ¤íŠ¸ ìµœì í™” */
        .btn-text {
          white-space: normal;
          word-break: keep-all;
        }

        /* ëª¨ë°”ì¼ì—ì„œ íŒ¨ë”© ì¡°ì • */
        .mobile-padding {
          padding-left: 0.75rem;
          padding-right: 0.75rem;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë§ˆì§„ ì¡°ì • */
        .mobile-margin {
          margin-left: 0.5rem;
          margin-right: 0.5rem;
        }
      }
    </style>
    <script>
      tailwind.config = {
        future: {
          hoverOnlyWhenSupported: true,
        },
        experimental: {
          optimizeUniversalDefaults: true,
        },
        // CDN ì‚¬ìš© ê²½ê³  ë¬´ì‹œ
        theme: {
          extend: {},
        },
      };
    </script>

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- FontAwesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>

    <!-- XLSX -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- DOMPurify (XSS ë°©ì§€) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

    <style>
      :root {
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Noto Sans KR", sans-serif;
        padding-top: var(--safe-top);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .card-hover {
        transition: 0.3s;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .foodie-loader {
        width: 200px;
        height: 8px;
        background-color: #f3f3f3;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }

      .loading-bar {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .bar-container {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #f97316, #ea580c, #dc2626);
        border-radius: 4px;
        position: absolute;
        top: 0;
        left: 0;
        width: 0%;
        transition: width 0.5s ease-in-out;
      }

      .bar-fill.loading {
        animation: loading-pulse 2s ease-in-out infinite;
      }

      @keyframes loading-pulse {
        0% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.6;
        }
      }
      .tab-btn {
        position: relative;
        overflow: hidden;
      }
      .tab-btn.active {
        color: #fff;
        background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
        box-shadow: 0 6px 12px rgba(249, 115, 22, 0.3),
          0 2px 4px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      .tab-btn:not(.active) {
        background: #ffffff;
        border: 2px solid #e5e7eb;
      }
      .tab-btn:not(.active):hover {
        background: #fff7ed;
        border-color: #fdba74;
        box-shadow: 0 2px 8px rgba(249, 115, 22, 0.15);
        transform: translateY(-1px);
      }
      .roadmap-subtab.active {
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          padding 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 0;
        opacity: 0;
        will-change: max-height, padding, opacity;
      }

      .accordion-item.active .accordion-content {
        max-height: 2000px;
        padding: 0;
        opacity: 1;
      }

      .accordion-item.active .accordion-icon {
        transform: rotate(180deg);
      }
      .accordion-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: background-color;
      }
      .accordion-header:hover {
        background-color: rgba(0, 0, 0, 0.02);
      }
      .accordion-header .fa-chevron-down,
      .accordion-icon {
        flex: 0 0 auto;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
      }
      .accordion-item.active .accordion-header .fa-chevron-down,
      .accordion-item.active .accordion-icon {
        transform: rotate(180deg);
      }

      /* 120Hz ë””ìŠ¤í”Œë ˆì´ ì§€ì› */
      @media (min-resolution: 120dpi) {
        .accordion-content {
          transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            padding 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-header {
          transition: background-color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-header .fa-chevron-down,
        .accordion-icon {
          transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* ë¡œë“œë§µ ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ */
      .roadmap-accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        will-change: max-height, opacity;
      }

      .roadmap-accordion-content.expanded {
        max-height: 2000px;
        opacity: 1;
        padding-top: 1rem;
      }

      .roadmap-accordion-content.expanded .roadmap-timeline {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
      }

      /* 120Hz ë””ìŠ¤í”Œë ˆì´ ì§€ì› */
      @media (min-resolution: 120dpi) {
        .roadmap-accordion-content {
          transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
      }

      /* ì¼ì • ë¸”ë¡ ìŠ¤íƒ€ì¼ */
      .schedule-blocks-container {
        display: grid;
        gap: 1rem;
        margin-top: 1rem;
      }

      /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
      .schedule-blocks-container {
        grid-template-columns: 1fr;
      }

      /* ëª¨ë°”ì¼: 2ê°œì”© (320px ~ 640px) */
      @media (max-width: 640px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
          gap: 0.75rem;
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* ì‘ì€ íƒœë¸”ë¦¿: 2ê°œì”© (641px ~ 768px) */
      @media (min-width: 641px) and (max-width: 768px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* íƒœë¸”ë¦¿: 2ê°œì”© (769px ~ 1024px) */
      @media (min-width: 769px) and (max-width: 1024px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(2, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 3) {
          display: none;
        }
      }

      /* ë°ìŠ¤í¬í†±: 3ê°œì”© (1025px ~ 1280px) */
      @media (min-width: 1025px) and (max-width: 1280px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(3, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 4) {
          display: none;
        }
      }

      /* ëŒ€í˜• ë°ìŠ¤í¬í†±: 4ê°œì”© (1281px ~ 1440px) */
      @media (min-width: 1281px) and (max-width: 1440px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(4, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 5) {
          display: none;
        }
      }

      /* ì´ˆëŒ€í˜• í™”ë©´: 4ê°œì”© (1441px+) */
      @media (min-width: 1441px) {
        .schedule-blocks-container {
          grid-template-columns: repeat(4, 1fr);
        }
        .schedule-blocks-container .schedule-block:nth-child(n + 5) {
          display: none;
        }
      }

      /* ì¼ì • ë¸”ë¡ ì¹´ë“œ */
      .schedule-block {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .schedule-block:hover {
        border-color: #f97316;
        box-shadow: 0 8px 25px rgba(249, 115, 22, 0.15);
        transform: translateY(-2px);
      }

      /* ë‹¤ìŒ ì¼ì • ê°•ì¡° */
      .schedule-block.next-schedule {
        border-color: #f97316;
        background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
        box-shadow: 0 4px 20px rgba(249, 115, 22, 0.2);
      }

      .schedule-block.next-schedule::before {
        content: "ë‹¤ìŒ ì¼ì •";
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
      }

      /* ì™„ë£Œëœ ì¼ì • */
      .schedule-block.completed {
        opacity: 0.7;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-color: #d1d5db;
      }

      .schedule-block.completed::before {
        content: "ì™„ë£Œ";
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: #ef4444;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      }

      /* ë¸”ë¡ ë‚´ìš© */
      .schedule-block-content {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .schedule-block-date {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .schedule-block-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        line-height: 1.4;
        flex-grow: 1;
      }

      .schedule-block-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: auto;
      }

      .schedule-action-btn {
        padding: 0.5rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
      }

      .schedule-edit-btn {
        background: #3b82f6;
        color: white;
      }

      .schedule-edit-btn:hover {
        background: #2563eb;
        transform: scale(1.05);
      }

      .schedule-delete-btn {
        background: #ef4444;
        color: white;
      }

      .schedule-delete-btn:hover {
        background: #dc2626;
        transform: scale(1.05);
      }

      .schedule-download-btn {
        background: #10b981;
        color: white;
      }

      .schedule-download-btn:hover {
        background: #059669;
        transform: scale(1.05);
      }

      /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
      .calendar-container {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        padding: 1.5rem;
        margin-top: 1rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        min-height: 500px;
        width: 100%;
        max-width: 100%;
        overflow: visible;
      }

      .calendar-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f97316;
      }

      .calendar-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .calendar-nav-prev {
        order: 1;
      }

      .calendar-month-year {
        order: 2;
        flex: 1;
        text-align: center;
      }

      .calendar-nav-next {
        order: 3;
      }

      .calendar-nav-btn {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.375rem 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        min-width: 2rem;
        height: 2rem;
      }

      .calendar-nav-btn:hover {
        background: linear-gradient(135deg, #ea580c, #dc2626);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      }

      .calendar-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        text-align: center;
      }

      .calendar-nav-btn {
        background: #f97316;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }

      .calendar-nav-btn:hover {
        background: #ea580c;
        transform: scale(1.05);
      }

      .calendar-nav-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
      }

      .calendar-month-year {
        font-size: 1.125rem;
        font-weight: 600;
        color: #374151;
        min-width: 150px;
        text-align: center;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        min-height: 400px;
        width: 100%;
        table-layout: fixed;
      }

      .calendar-day-header {
        background: linear-gradient(135deg, #f97316, #ea580c);
        color: white;
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.875rem;
      }

      .calendar-day {
        background: white;
        min-height: 100px;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .calendar-day:hover {
        background: #fef3c7;
      }

      .calendar-day.other-month {
        background: #f9fafb;
        color: #9ca3af;
      }

      .calendar-day.today {
        background: linear-gradient(135deg, #fff7ed, #fed7aa);
        border: 2px solid #f97316;
      }

      .calendar-day-number {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }

      .calendar-event {
        background: #f97316;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: visible;
        white-space: normal;
        line-height: 1.3;
        margin-bottom: 0.125rem;
        width: 100%;
        max-width: 100%;
        min-width: 0;
        flex-shrink: 0;
        box-sizing: border-box;
        /* ê¸€ì í¬ê¸° ìë™ ì¡°ì •ì„ ìœ„í•œ ì„¤ì • */
        font-size: clamp(0.625rem, 2.5vw, 0.75rem);
        transform-origin: center;
        text-align: center;
      }

      .calendar-event:hover {
        background: #ea580c;
        transform: scale(1.05);
      }

      .calendar-event.completed {
        background: #ef4444;
      }

      .calendar-event.completed:hover {
        background: #dc2626;
      }

      .calendar-event.next {
        background: #10b981;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      }

      .calendar-event.next:hover {
        background: #059669;
      }

      /* ë‹¬ë ¥ ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ í¬ê¸° í´ë˜ìŠ¤ */
      .calendar-event.text-xs {
        font-size: 0.625rem;
      }

      .calendar-event.text-sm {
        font-size: 0.6875rem;
      }

      /* ìš´ì˜ì§„ ì „ìš© ì¼ì • ìŠ¤íƒ€ì¼ (íŒŒë€ìƒ‰) */
      .calendar-event.admin-only {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
        color: white !important;
        border: 1px solid #1e40af !important;
        font-weight: 500;
      }

      .calendar-event.admin-only:hover {
        background: linear-gradient(135deg, #2563eb, #1e40af) !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      }

      /* ë‹¬ë ¥ ë°˜ì‘í˜• */
      @media (max-width: 768px) {
        .calendar-container {
          padding: 0.75rem;
          margin-top: 0.5rem;
          border-radius: 12px;
          width: 100%;
          max-width: 100%;
          overflow: visible;
        }

        .calendar-header {
          flex-direction: column;
          gap: 0.75rem;
          text-align: center;
          margin-bottom: 1rem;
          padding-bottom: 0.75rem;
        }

        .calendar-nav-btn {
          padding: 0.25rem 0.5rem;
          font-size: 0.75rem;
          min-width: 1.75rem;
          height: 1.75rem;
        }

        .calendar-title {
          font-size: 1.25rem;
        }

        .calendar-nav-btn {
          width: 36px;
          height: 36px;
          padding: 0.375rem;
        }

        .calendar-month-year {
          font-size: 1rem;
          min-width: 120px;
        }

        .calendar-grid {
          min-height: 350px;
          grid-template-columns: repeat(7, 1fr);
          width: 100%;
          table-layout: fixed;
        }

        .calendar-day {
          min-height: 70px;
          padding: 0.25rem;
          overflow: hidden;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }

        .calendar-day-number {
          font-size: 0.75rem;
          margin-bottom: 0.125rem;
        }

        .calendar-event {
          font-size: clamp(0.5rem, 2vw, 0.625rem);
          padding: 0.1875rem 0.375rem;
          border-radius: 8px;
          white-space: nowrap;
          overflow: hidden;
          line-height: 1.1;
          width: 100%;
          max-width: 100%;
          flex-shrink: 0;
          box-sizing: border-box;
          transform-origin: center;
        }

        .calendar-day-header {
          padding: 0.5rem 0.25rem;
          font-size: 0.75rem;
        }

        /* ëª¨ë°”ì¼ ë‹¬ë ¥ ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ í¬ê¸° í´ë˜ìŠ¤ */
        .calendar-event.text-xs {
          font-size: 0.5rem;
        }

        .calendar-event.text-sm {
          font-size: 0.5625rem;
        }

        /* ëª¨ë°”ì¼ ìš´ì˜ì§„ ì „ìš© ì¼ì • ìŠ¤íƒ€ì¼ */
        .calendar-event.admin-only {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
          color: white !important;
          border: 1px solid #1e40af !important;
          font-weight: 500;
        }
      }

      /* í™”ë©´ ê¹œë¹¡ê±°ë¦¼ ë°©ì§€ë¥¼ ìœ„í•œ ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
      .smooth-transition {
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      }

      .content-loading {
        opacity: 0.7;
        pointer-events: none;
      }

      .content-loaded {
        opacity: 1;
        pointer-events: auto;
      }

      /* ê´€ë¦¬ì íŒ¨ë„ ë° íŠ¹ì • ì˜ì—­ì—ì„œ í…ìŠ¤íŠ¸ ë³µì‚¬ í—ˆìš© */
      #dashboard-overlay,
      #dashboard-overlay *,
      .admin-panel,
      .admin-panel *,
      #subtab-container,
      #subtab-container *,
      .member-card,
      .member-card *,
      .footer-selectable,
      .footer-selectable *,
      input,
      textarea,
      select {
        -webkit-user-select: text !important;
        -khtml-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
      }

      /* ë²„íŠ¼ê³¼ ì•„ì´ì½˜ì€ ì—¬ì „íˆ ì„ íƒ ë¶ˆê°€ */
      button,
      button *,
      .fa,
      .fas,
      .far,
      .fab {
        -webkit-user-select: none !important;
        -khtml-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
      }

      /* ë¡œê³  ì´ë¯¸ì§€ ë°°ê²½ìƒ‰ ë³€ê²½ */
      .logo-image {
        background: linear-gradient(135deg, #f97316, #ea580c);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(249, 115, 22, 0.2);
        transition: all 0.3s ease;
      }

      .logo-image:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(249, 115, 22, 0.3);
      }

      /* ë¡œê³  ì´ë¯¸ì§€ ë‚´ë¶€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ë§ */
      .logo-image img {
        border-radius: 8px;
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
      }

      /* ëª¨ë°”ì¼ ì¼ì • ë¸”ë¡ ìµœì í™” */
      @media (max-width: 640px) {
        .schedule-blocks-container {
          gap: 0.75rem;
          margin-top: 0.75rem;
        }

        .schedule-block {
          padding: 0.875rem;
          border-radius: 10px;
          min-height: 120px;
        }

        .schedule-block-title {
          font-size: 0.9375rem;
          margin-bottom: 0.5rem;
          line-height: 1.3;
        }

        .schedule-block-date {
          font-size: 0.75rem;
          margin-bottom: 0.25rem;
        }

        .schedule-action-btn {
          padding: 0.25rem;
          font-size: 0.6875rem;
          min-height: 28px;
        }

        .schedule-block.next-schedule::before,
        .schedule-block.completed::before {
          font-size: 0.5625rem;
          padding: 0.125rem 0.375rem;
          top: 0.375rem;
          right: 0.375rem;
        }
      }

      /* ë§¤ìš° ì‘ì€ ëª¨ë°”ì¼ í™”ë©´ */
      @media (max-width: 480px) {
        .schedule-blocks-container {
          gap: 0.5rem;
          margin-top: 0.5rem;
        }

        .schedule-block {
          padding: 0.75rem;
          border-radius: 8px;
          min-height: 100px;
        }

        .schedule-block-title {
          font-size: 0.875rem;
          margin-bottom: 0.375rem;
          line-height: 1.2;
        }

        .schedule-block-date {
          font-size: 0.6875rem;
          margin-bottom: 0.25rem;
        }

        .schedule-action-btn {
          padding: 0.1875rem;
          font-size: 0.625rem;
          min-height: 24px;
        }

        .schedule-block.next-schedule::before,
        .schedule-block.completed::before {
          font-size: 0.5rem;
          padding: 0.125rem 0.25rem;
          top: 0.25rem;
          right: 0.25rem;
        }
      }

      .roadmap-item {
        position: relative;
        padding-left: 30px;
        padding-bottom: 1.25rem;
      }
      .roadmap-item:not(:last-child) {
        padding-bottom: 2rem;
      }
      .roadmap-item:not(:last-child)::before {
        content: "";
        position: absolute;
        left: 7px;
        top: 16px;
        width: 2px;
        height: 100%;
        background: #e2e8f0;
      }
      .roadmap-item.completed:not(:last-child)::before {
        background: #6366f1;
      }
      .roadmap-item::after {
        content: "";
        position: absolute;
        left: 0;
        top: 4px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #e2e8f0;
      }
      .roadmap-item.completed::after {
        border-color: #6366f1;
        background: #6366f1;
      }
      .roadmap-item.today::after {
        border-color: #f59e0b;
        background: #f59e0b;
      }
      .table-sticky th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 1;
      }
      input,
      select,
      textarea {
        font-size: 16px !important;
      }
      .btn-lg {
        padding: 0.8rem 1rem;
        border-radius: 0.65rem;
        font-weight: 700;
      }
      .input-lg {
        padding: 0.85rem 1rem;
        border-radius: 0.65rem;
      }
      .section {
        background: #fff;
        border-radius: 1.25rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04),
          0 8px 24px rgba(0, 0, 0, 0.06);
        padding: 1rem;
      }
      @media (min-width: 768px) {
        .section {
          padding: 1.5rem;
        }
      }
      .thumb {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
      }
      .dz {
        width: 64px;
        height: 64px;
        border: 2px dashed #c7d2fe;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #4f46e5;
        cursor: pointer;
        background: #eef2ff;
      }
      .dz.drag {
        border-color: #6366f1;
        background: #e0e7ff;
      }
      .dz-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border-radius: 0.5rem;
      }
      #presence-pop {
        position: absolute;
        transform: translateY(8px);
      }
      .subtab-btn.active {
        background: #111827;
        color: #fff;
      }
      .sortable li {
        user-select: none;
      }
      .dragging {
        opacity: 0.5;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
      }
      /* íƒ€ì…ë³„ ì¹´ë“œ ìƒë‹¨ ë³´ë”(ì§ê´€ì  ìƒ‰ìƒ) */
      .accent-tasting {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-general {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-mt {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      .accent-assembly {
        border-top: 4px solid #f97316;
      } /* orange-500 */
      body {
        background: #f3f4f6;
        color: #111827;
      }
      .section {
        background: #ffffff;
      }
      #presence-pop,
      .accordion-content,
      .prose {
        color: #111827;
      }

      /* ==== ìˆ˜í‰ ë¡œë“œë§µ (ë¡œê·¸ì¸ í›„) ==== */
      .h-roadmap {
        display: flex;
        flex-direction: row;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 8px;
        scroll-snap-type: x mandatory;
        scrollbar-width: thin;
      }
      .h-item {
        min-width: 220px;
        scroll-snap-align: start;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 12px;
        padding: 12px;
        position: relative;
        transition: transform 0.2s;
      }
      .h-item:hover {
        transform: translateY(-2px);
      }
      .h-item.completed {
        opacity: 0.65;
        filter: grayscale(0.15);
      }
      .h-item.today::after {
        content: "ì˜¤ëŠ˜";
        position: absolute;
        top: 8px;
        right: 10px;
        font-size: 11px;
        color: #f59e0b;
        font-weight: 700;
      }
      .v-item {
        width: 100%;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        position: relative;
        transition: transform 0.2s;
      }
      .v-item:hover {
        transform: translateY(-2px);
      }
      .v-item.completed {
        opacity: 0.65;
        filter: grayscale(0.15);
      }
      .v-item.today::after {
        content: "ì˜¤ëŠ˜";
        position: absolute;
        top: 8px;
        right: 10px;
        font-size: 11px;
        color: #f59e0b;
        font-weight: 700;
      }

      /* ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
      #auto-login-checkbox:checked {
        background-color: #ea580c;
        border-color: #ea580c;
      }

      #auto-login-checkbox:checked ~ label {
        color: #c2410c;
        font-weight: 600;
      }
      .h-pulse {
        animation: hblink 1.6s ease-out infinite;
      }

      /* ==== ì»´íŒ©íŠ¸ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë¡œë“œë§µ (ë¡œê·¸ì¸ í™”ë©´ìš©) ==== */
      .roadmap-timeline {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        overflow-x: auto;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }

      .roadmap-timeline::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      .timeline-item {
        flex: 0 0 180px;
        min-width: 180px;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .timeline-content {
        background: white;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        border: 1px solid #f3f4f6;
        height: 100%;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 100px;
      }

      .timeline-content:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        border-color: #fb923c;
      }

      .timeline-admin-buttons {
        display: flex;
        gap: 4px;
        margin-left: 8px;
      }

      .timeline-edit-btn,
      .timeline-delete-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
      }

      .timeline-edit-btn {
        background: #3b82f6;
        color: white;
      }

      .timeline-edit-btn:hover {
        background: #2563eb;
        transform: scale(1.1);
      }

      .timeline-delete-btn {
        background: #ef4444;
        color: white;
      }

      .timeline-delete-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      .timeline-item.completed .timeline-content {
        opacity: 0.8;
        background: #fef7ed;
        border-color: #fed7aa;
      }

      /* ê´€ë¦¬ììš© ìƒˆ ì¼ì • ì¶”ê°€ ë¸”ë¡ ìŠ¤íƒ€ì¼ */
      .timeline-item.admin-placeholder .timeline-content {
        background: #f9fafb;
        border: 2px dashed #d1d5db;
        opacity: 0.8;
        transition: all 0.3s ease;
      }

      .timeline-item.admin-placeholder .timeline-content:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        opacity: 1;
      }

      .admin-placeholder-content {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
      }

      .admin-placeholder-icon {
        color: #6b7280;
        font-size: 20px;
      }

      .admin-placeholder-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .admin-placeholder-title {
        font-weight: 600;
        color: #374151;
        font-size: 13px;
      }

      .admin-placeholder-subtitle {
        font-size: 11px;
        color: #6b7280;
        line-height: 1.3;
      }

      .timeline-add-btn {
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .timeline-add-btn:hover {
        background: #4b5563;
        transform: scale(1.1);
      }

      .timeline-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 6px;
        font-size: 13px;
        line-height: 1.3;
        min-height: auto;
        display: flex;
        align-items: flex-start;
        flex-wrap: wrap;
        word-break: keep-all;
        overflow-wrap: break-word;
      }

      .timeline-date {
        font-size: 11px;
        color: #6b7280;
        font-weight: 500;
        margin-top: auto;
        padding-top: 6px;
        border-top: 1px solid #f3f4f6;
      }

      .timeline-today-badge {
        display: inline-block;
        background: #fed7aa;
        color: #ea580c;
        padding: 1px 6px;
        border-radius: 8px;
        font-size: 9px;
        font-weight: 600;
        margin-left: 6px;
        margin-top: 1px;
      }

      /* ëª¨ë°”ì¼ ìµœì í™” */
      @media (max-width: 768px) {
        .roadmap-timeline {
          gap: 8px;
          padding: 8px 0;
        }

        .timeline-item {
          flex: 0 0 140px;
          min-width: 140px;
        }

        .timeline-content {
          padding: 8px;
          min-height: 85px;
        }

        .timeline-title {
          font-size: 11px;
          min-height: 2.2em;
        }

        .timeline-date {
          font-size: 9px;
        }
      }
      @keyframes hblink {
        0% {
          box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.45);
        }
        70% {
          box-shadow: 0 0 0 14px rgba(99, 102, 241, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
        }
      }

      /* ==== ì°¸ê°€ì ì¹´ë“œí˜• ë¦¬ìŠ¤íŠ¸ (í…ìŠ¤íŠ¸ ì„ íƒ ê°€ëŠ¥ ìœ ì§€) ==== */
      .participants-wrap {
        display: grid;
        gap: 6px;
      }
      .participant-chip {
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: 10px;
        padding: 6px 8px;
      }
      .participant-chip .avatar {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--accent);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* ==== ëª¨ë“  í™”ë©´ì—ì„œ ë²„íŠ¼ ë°©ì‹ ìˆœì„œë³€ê²½ ==== */
      .mobile-reorder {
        display: flex;
        gap: 6px;
      }
      .mobile-reorder button {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 4px 8px;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
      }
      .mobile-reorder button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
      }
      .mobile-reorder button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .grip {
        display: none !important;
      } /* ëª¨ë“  í™”ë©´ì—ì„œ ë“œë˜ê·¸ í•¸ë“¤ ìˆ¨ê¹€ */
      .sortable [draggable="true"] {
        cursor: default;
      }

      /* ë‹¤í¬ëª¨ë“œì—ì„œ ì•½ê°„ ë” ëŒ€ë¹„ */
      [data-theme="dark"] .accordion-item.active .accordion-content {
        background: #0f1422;
        border-radius: 12px;
      }
      [data-theme="dark"] .dz {
        background: #0f1422;
        border-color: #233055;
        color: #a5b4fc;
      }

      /* ëª¨ë°”ì¼ ìµœì í™” - ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
      @media (max-width: 768px) {
        .block-admin-controls {
          position: absolute !important;
          top: 0.5rem !important;
          right: 0.5rem !important;
          bottom: auto !important;
        }

        .accordion-header {
          padding: 1rem !important;
        }

        .accordion-header h3 {
          font-size: 1rem !important;
          line-height: 1.4 !important;
        }

        .section {
          margin-bottom: 1rem !important;
        }

        .participant-chip {
          flex-direction: column !important;
          align-items: flex-start !important;
          gap: 0.5rem !important;
        }

        .event-card {
          padding: 1rem !important;
        }

        .event-card h3 {
          font-size: 1rem !important;
          margin-bottom: 0.5rem !important;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 flex flex-col min-h-screen">
    <!-- Loading -->
    <div
      id="loading-screen"
      class="fixed inset-0 bg-white flex flex-col justify-center items-center z-40"
    >
      <div class="foodie-loader">
        <div class="loading-bar">
          <div class="bar-container">
            <div id="progress-bar" class="bar-fill loading"></div>
          </div>
        </div>
      </div>
      <p id="loading-text" class="mt-3 text-gray-600">Foodie Webì— ì ‘ì†ì¤‘...</p>
    </div>

    <div
      class="container mx-auto px-3 sm:px-4 md:px-6 py-4 md:py-8 flex-grow max-w-6xl"
    >
      <header class="text-center mb-6 md:mb-10 relative">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div class="flex items-center gap-2 mx-auto md:mx-0">
            <!-- ë¡œê³  ì œê±°ë¨ -->
          </div>

          <div class="flex items-center gap-2 mx-auto md:mx-0">
            <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ ì œê±°ë¨ -->
          </div>

          <!-- ì ‘ì†ì ëª…ë‹¨ê³¼ ì¡°ëª¨ì„ ìˆœìœ„ - ëª¨ë“  í™”ë©´ì—ì„œ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ë°€ì°© -->
          <div
            id="game-buttons-container"
            class="flex items-center gap-2 ml-auto mr-0"
          >
            <!-- ì ‘ì†ì(ëª¨ë‘ ë³´ì„) -->
            <button
              id="presence-badge"
              class="text-sm md:text-base bg-gray-800 text-white rounded-full px-3 py-1 hover:bg-gray-700"
            >
              ğŸ‘¥ ì ‘ì† <b id="presence-count">0</b>ëª…
            </button>
            <!-- ë¯¸ë‹ˆê²Œì„ ë²„íŠ¼ -->
            <button
              id="minigame-button"
              class="text-sm md:text-base bg-purple-500 text-white rounded-full px-3 py-1 hover:bg-purple-600"
            >
              ğŸ® ë¯¸ë‹ˆê²Œì„
            </button>
            <!-- ì¡°ëª¨ì„ ìˆœìœ„(ëª¨ë‘ ë³´ì„) -->
            <button
              id="rank-button"
              class="text-sm md:text-base bg-orange-500 text-white rounded-full px-3 py-1 hover:bg-orange-600"
            >
              ğŸ… ì¡°ëª¨ì„
            </button>
          </div>
        </div>

        <!-- ì ‘ì†ì íŒì˜¤ë²„(ê´€ë¦¬ì) -->
        <div
          id="presence-pop"
          class="hidden right-0 left-0 mx-auto md:left-auto md:right-10 md:mx-0 w-full max-w-xs bg-white border rounded-xl shadow-xl p-3 z-30"
        >
          <div class="text-sm font-semibold text-gray-700 mb-2">
            í˜„ì¬ ì ‘ì†ì
          </div>
          <div id="presence-list" class="max-h-64 overflow-auto text-sm"></div>
        </div>
      </header>

      <main id="app" class="space-y-6 md:space-y-8">
        <div id="app-wrapper">
          <!-- ===== ë¡œê·¸ì¸ ì „ ===== -->
          <div id="pre-login-info" class="space-y-6 md:space-y-8">
            <!-- ë¡œê·¸ì¸ -->
            <div id="login-section" class="section max-w-lg mx-auto">
              <h2 class="text-2xl font-bold mb-4 text-center text-gray-700">
                Foodie íšŒì› ì¸ì¦
              </h2>
              <div class="space-y-3 md:space-y-4">
                <input
                  id="studentId"
                  type="text"
                  placeholder="í•™ë²ˆ"
                  class="w-full input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
                />
                <input
                  id="studentName"
                  type="text"
                  placeholder="ì´ë¦„"
                  class="w-full input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
                />
                <p class="text-xs text-center text-red-500 px-2">
                  í•™ë²ˆê³¼ ì´ë¦„ì„ ì •í™•í•˜ê²Œ ê¸°ì…í•´ì£¼ì„¸ìš”!<br />
                </p>

                <!-- ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ -->
                <div
                  class="flex items-center justify-center space-x-2 bg-orange-50 border border-orange-200 rounded-lg p-3"
                >
                  <div class="relative">
                    <input
                      id="auto-login-checkbox"
                      type="checkbox"
                      class="w-5 h-5 text-orange-600 bg-white border-2 border-orange-300 rounded-md focus:ring-orange-500 focus:ring-2 transition-all duration-200 hover:border-orange-400"
                    />
                    <div
                      class="absolute inset-0 rounded-md bg-gradient-to-r from-orange-400 to-orange-500 opacity-0 transition-opacity duration-200 pointer-events-none"
                    ></div>
                  </div>
                  <label
                    for="auto-login-checkbox"
                    class="text-sm font-medium text-orange-700 cursor-pointer hover:text-orange-800 transition-colors duration-200"
                  >
                    <i class="fas fa-magic-wand-sparkles mr-1"></i>ìë™ ë¡œê·¸ì¸
                    (ì˜êµ¬ ì €ì¥)
                  </label>
                </div>

                <button
                  id="login-button"
                  type="button"
                  class="w-full bg-orange-500 text-white btn-lg hover:bg-orange-600 transition-colors"
                >
                  <i class="fas fa-right-to-bracket mr-2"></i>ë¡œê·¸ì¸
                </button>
                <button
                  id="signup-button"
                  type="button"
                  class="w-full bg-white text-orange-700 border border-orange-300 btn-lg hover:bg-orange-50 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i class="fas fa-user-plus mr-2"></i>íšŒì›ê°€ì…
                </button>
                <div
                  id="signup-banner"
                  class="hidden text-center text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg p-2 mt-2"
                >
                  ì§€ê¸ˆì€ <b>íšŒì›ê°€ì… ê¸°ê°„</b>ì…ë‹ˆë‹¤. ë¯¸íšŒì›ì€
                  <b>íšŒì›ê°€ì…</b> ë²„íŠ¼ìœ¼ë¡œ ê°€ì…í•˜ì„¸ìš”.
                </div>
              </div>
            </div>

            <!-- ë¡œë“œë§µ (ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ í‘œì‹œ) -->
            <div class="section hidden" id="roadmap-section">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-gray-700">
                  <i class="fas fa-map-signs mr-2 text-orange-500"></i>Foodie
                  í™œë™ ë¡œë“œë§µ
                </h3>
                <div id="roadmap-admin-controls" class="hidden">
                  <button
                    id="add-roadmap-event"
                    class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"
                  >
                    <i class="fas fa-plus mr-1"></i>ì¼ì • ì¶”ê°€
                  </button>
                </div>
              </div>
              <div id="roadmap-container" class="space-y-3"></div>
              <div class="text-center mt-3">
                <button
                  id="roadmap-toggle-btn"
                  type="button"
                  class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-medium py-1.5 px-3 rounded-md transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5 text-sm hidden"
                >
                  <i class="fas fa-calendar-alt text-xs"></i>
                  <span id="roadmap-toggle-text">ë‹¬ë ¥ ë³´ê¸°</span>
                </button>
              </div>
            </div>

            <!-- í™ˆ í™”ë©´ ë¸”ë¡ -->
            <div id="dynamic-blocks" class="space-y-4 md:space-y-6"></div>
          </div>

          <!-- ===== ë¡œê·¸ì¸ í›„ ë©”ì¸ ===== -->
          <div id="main-content" class="hidden">
            <!-- ë¡œê·¸ì¸ í›„ ë©”ì¸ í™”ë©´ì€ renderAll()ì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </main>
    </div>

    <div id="logout-container" class="text-center py-2"></div>

    <footer class="text-center py-4 text-gray-500 text-sm footer-selectable">
      <p>ê°œë°œìğŸ§‘ğŸ»â€ğŸ’»: Foodie 2025 íšŒì¥ ì´ëŒ€í˜„</p>
      <p>ì—°ë½ì²˜ğŸ“¨: leedaehyun11@naver.com</p>
    </footer>

    <!-- Alert Modal -->

    <!-- Inquiry/Suggestions Modal -->
    <div
      id="inquiry-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div
        class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold text-orange-600">
            <i class="fas fa-question-circle mr-2"></i>ë¬¸ì˜í•˜ê¸°
          </h3>
          <button
            id="inquiry-close"
            class="text-gray-400 hover:text-gray-600 transition-colors"
            title="ë‹«ê¸°"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <!-- ë¬¸ì˜ ì‘ì„± í¼ -->
        <div class="mb-6 bg-orange-50 p-4 rounded-lg border border-orange-200">
          <div class="mb-3">
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >ì œëª© (ì„ íƒ)</label
            >
            <input
              id="modal-sug-title"
              type="text"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors"
              placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)"
            />
          </div>
          <div class="mb-3">
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >ë‚´ìš© *</label
            >
            <textarea
              id="modal-sug-text"
              rows="4"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors resize-none"
              placeholder="ê¶ê¸ˆí•œ ì ì´ë‚˜ ë¬¸ì˜ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”."
            ></textarea>
          </div>
          <button
            id="modal-sug-submit"
            class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg"
          >
            <i class="fas fa-paper-plane mr-2"></i>ë¬¸ì˜ ë³´ë‚´ê¸°
          </button>
        </div>

        <!-- ê¸°ì¡´ ë¬¸ì˜ ëª©ë¡ -->
        <div class="border-t pt-4">
          <h4 class="text-lg font-bold text-gray-800 mb-3">
            <i class="fas fa-list mr-2"></i>ë¬¸ì˜ ë‚´ì—­
          </h4>
          <div id="modal-suggestions-list" class="space-y-3">
            <!-- ë¬¸ì˜ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
    </div>

    <!-- Rank Modal -->
    <div
      id="rank-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div
        class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-2xl font-bold text-orange-700">ğŸ… ì¡°ëª¨ì„</h3>
          <div id="rank-admin-controls" class="hidden">
            <button
              id="rank-add-team"
              class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors"
            >
              <i class="fas fa-plus mr-1"></i>ì¡°ëª¨ì„ ì¶”ê°€
            </button>
          </div>
        </div>
        <div id="rank-list" class="space-y-2"></div>
        <div class="mt-4 flex justify-between">
          <div id="rank-admin-actions" class="hidden space-x-2">
            <button
              id="rank-save-changes"
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors"
            >
              <i class="fas fa-save mr-1"></i>ë³€ê²½ì‚¬í•­ ì €ì¥
            </button>
          </div>
          <button
            id="rank-close"
            class="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300"
          >
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- Minigame Modal -->
    <div
      id="minigame-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div
        class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto"
      >
        <h3 class="text-2xl font-bold text-purple-700 text-center mb-4">
          ğŸ® ë¯¸ë‹ˆê²Œì„
        </h3>

        <!-- ê²Œì„ íƒ­ -->
        <div class="flex border-b border-gray-200 mb-4">
          <button
            id="games-tab-btn"
            class="flex-1 py-2 px-4 text-center font-medium text-purple-600 border-b-2 border-purple-600"
          >
            ê²Œì„í•˜ê¸°
          </button>
          <button
            id="ranking-tab-btn"
            class="flex-1 py-2 px-4 text-center font-medium text-gray-500 hover:text-gray-700"
          >
            ğŸ† ë­í‚¹
          </button>
        </div>

        <!-- ê²Œì„ ì„ íƒ -->
        <div id="game-selection" class="space-y-3">
          <button
            id="number-guess-btn"
            class="w-full p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            ğŸ”¢ ìˆ«ì ë§ì¶”ê¸°
          </button>
          <button
            id="color-memory-btn"
            class="w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
          >
            ğŸ¨ ìƒ‰ê¹” ê¸°ì–µí•˜ê¸°
          </button>
          <button
            id="car-racing-btn"
            class="w-full p-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
          >
            ğŸš— ìë™ì°¨ ë ˆì´ì‹±
          </button>
          <button
            id="ball-bounce-btn"
            class="w-full p-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
          >
            âš½ ê³µ íŠ€ê¸°ê¸°
          </button>
        </div>

        <!-- ë­í‚¹ í™”ë©´ -->
        <div id="ranking-screen" class="hidden">
          <div id="ranking-content" class="space-y-4">
            <!-- ë­í‚¹ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
          </div>
        </div>

        <!-- ê²Œì„ í™”ë©´ -->
        <div id="game-screen" class="hidden">
          <div id="game-content" class="text-center min-h-[500px] flex flex-col justify-center"></div>
          <div class="mt-4 flex gap-2 justify-center">
            <button
              id="game-back-btn"
              class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
            >
              ë’¤ë¡œ
            </button>
            <button
              id="game-restart-btn"
              class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              ë‹¤ì‹œí•˜ê¸°
            </button>
          </div>
        </div>

        <div class="mt-4 text-right">
          <button
            id="minigame-close"
            class="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300"
          >
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>

    <div
      id="alert-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9999]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl text-center max-w-sm w-full"
      >
        <div id="modal-icon" class="text-4xl md:text-5xl mb-3 md:mb-4"></div>
        <p
          id="alert-message"
          class="text-base md:text-lg font-medium text-gray-700"
        ></p>
        <button
          id="modal-close-button"
          type="button"
          class="mt-5 md:mt-6 bg-gray-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700"
        >
          í™•ì¸
        </button>
      </div>
    </div>

    <!-- Emergency Modal -->
    <div
      id="emergency-modal"
      class="hidden fixed inset-0 bg-black/70 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-sm w-full">
        <h3 class="text-2xl font-bold text-red-600 mb-4 text-center">
          <i class="fas fa-exclamation-triangle mr-2"></i>ë¹„ìƒ ë³µêµ¬ ëª¨ë“œ
        </h3>
        <p class="text-center text-gray-600 mb-4 md:mb-6">
          ìƒˆë¡œìš´ ê´€ë¦¬ìë¥¼ ì„ëª…í•˜ì—¬ ì‹œìŠ¤í…œ ì ‘ê·¼ ê¶Œí•œì„ ë³µêµ¬í•©ë‹ˆë‹¤.
        </p>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
          <p class="text-sm text-yellow-800">
            <i class="fas fa-info-circle mr-1"></i>
            <strong>ì§ì ‘ ë¡œê·¸ì¸:</strong> í•™ë²ˆì—
            <code>foodie_emergency_2024!</code> ì…ë ¥ í›„ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ
            ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.
          </p>
        </div>
        <input
          type="text"
          id="new-admin-id"
          placeholder="ìƒˆ ê´€ë¦¬ìì˜ í•™ë²ˆì„ ì…ë ¥"
          class="w-full input-lg border border-gray-300"
        />
        <div class="flex space-x-2 mt-4">
          <button
            id="emergency-add-button"
            type="button"
            class="flex-1 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600"
          >
            ê´€ë¦¬ì ì„ëª…
          </button>
          <button
            id="emergency-cancel-button"
            type="button"
            class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400"
          >
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <!-- Signup Modal -->
    <div
      id="signup-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-lg w-full">
        <h3 class="text-2xl font-bold text-orange-700 text-center mb-3 md:mb-4">
          <i class="fas fa-user-plus mr-2"></i>Foodie íšŒì›ê°€ì…
        </h3>
        <p class="text-sm text-gray-600 text-center">
          íšŒì›ê°€ì…ì€ ìš´ì˜ì§„ì´ ì„¤ì •í•œ ê¸°ê°„ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </p>

        <div
          id="dues-box"
          class="hidden mt-4 bg-amber-50 border border-amber-200 rounded-lg p-3 text-amber-800"
        >
          <div class="font-bold mb-1">ğŸ’¸ íšŒë¹„/ê³„ì¢Œ ì•ˆë‚´</div>
          <div id="dues-box-content" class="text-sm"></div>
        </div>

        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input
            id="signupName"
            type="text"
            placeholder="ì´ë¦„"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <select
            id="signupGender"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          >
            <option value="">ì„±ë³„</option>
            <option value="ë‚¨">ë‚¨</option>
            <option value="ì—¬">ì—¬</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <select
            id="signupYear"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          >
            <option value="">í•™ë…„</option>
            <option value="1í•™ë…„">1í•™ë…„</option>
            <option value="2í•™ë…„">2í•™ë…„</option>
            <option value="3í•™ë…„">3í•™ë…„</option>
            <option value="4í•™ë…„">4í•™ë…„</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <input
            id="signupCollege"
            type="text"
            placeholder="ë‹¨ê³¼ëŒ€"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupDept"
            type="text"
            placeholder="í•™ê³¼"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupId"
            type="text"
            placeholder="í•™ë²ˆ"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-orange-400"
          />
          <input
            id="signupPhone"
            type="text"
            placeholder="000-0000-0000"
            maxlength="13"
            class="input-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 sm:col-span-2"
          />
        </div>
        <div class="flex gap-2 mt-5">
          <button
            id="signup-confirm-button"
            type="button"
            class="flex-1 bg-orange-500 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-orange-600"
          >
            ê°€ì… ì‹ ì²­
          </button>
          <button
            id="signup-cancel-button"
            type="button"
            class="flex-1 bg-gray-300 text-gray-800 font-bold py-2.5 px-4 rounded-lg hover:bg-gray-400"
          >
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>

    <!-- íšŒë¹„ í™•ì¸ ëª¨ë‹¬ -->
    <div
      id="dues-modal"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full">
        <h3 class="text-xl font-bold text-amber-700 text-center mb-3">
          ì ê¹! íšŒë¹„ëŠ” ë‚©ë¶€í•˜ì…¨ë‚˜ìš”?
        </h3>
        <div id="dues-modal-body" class="text-sm text-gray-700 space-y-1"></div>
        <div class="flex gap-2 mt-5">
          <button
            id="dues-copy-button"
            type="button"
            class="flex-1 bg-gray-200 text-gray-800 font-semibold py-2 rounded hover:bg-gray-300"
          >
            ê³„ì¢Œ ë³µì‚¬
          </button>
          <button
            id="dues-proceed-button"
            type="button"
            class="flex-1 bg-orange-500 text-white font-bold py-2 rounded hover:bg-orange-600"
          >
            ë‚©ë¶€ ì™„ë£Œ, ê°€ì…
          </button>
        </div>
        <button
          id="dues-cancel-button"
          type="button"
          class="mt-3 w-full bg-gray-100 text-gray-600 py-2 rounded hover:bg-gray-200"
        >
          ì·¨ì†Œ
        </button>
      </div>
    </div>

    <!-- ê³µìš©(ë¬¸ë‹¨) ì—ë””í„° ëª¨ë‹¬ -->
    <div
      id="block-editor"
      class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50"
    >
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-5">
        <h3
          class="text-xl font-bold text-gray-800 mb-3"
          id="block-editor-title"
        >
          ë¸”ë¡ í¸ì§‘
        </h3>
        <div id="block-editor-body" class="space-y-3"></div>
        <div class="flex gap-2 justify-end mt-4">
          <button
            id="block-editor-cancel"
            class="px-4 py-2 rounded bg-gray-200"
          >
            ì·¨ì†Œ
          </button>
          <button
            id="block-editor-save"
            class="px-4 py-2 rounded bg-orange-500 text-white"
          >
            ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- App Script -->
    <script type="module">
      /* ==== ê³µìš©: ë°ìŠ¤í¬í†± DnD + ëª¨ë°”ì¼ í™”ì‚´í‘œ ìˆœì„œ ë³€ê²½ ==== */
      // ì „ì—­ ìœ í‹¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰ë¼ë„ ì•ˆì „)
      window.FoodieUtils = window.FoodieUtils || {};
      FoodieUtils.enableSimpleDnd =
        FoodieUtils.enableSimpleDnd ||
        function (ul) {
          if (!ul) return;

          // ëª¨ë°”ì¼ í™”ì‚´í‘œ ì œê±° (ìˆœì„œë³€ê²½ ë²„íŠ¼ ì œê±°)
          ul.addEventListener("click", (e) => {
            const li = e.target.closest("li");
            if (!li) return;
            if (e.target.closest(".move-up")) {
              li.previousElementSibling &&
                ul.insertBefore(li, li.previousElementSibling);
            }
            if (e.target.closest(".move-down")) {
              li.nextElementSibling &&
                ul.insertBefore(li.nextElementSibling, li);
            }
          });

          // 2) ë°ìŠ¤í¬í†± DnD
          let dragEl = null;
          ul.addEventListener("dragstart", (e) => {
            dragEl = e.target.closest("li[draggable='true']");
            if (dragEl) dragEl.classList.add("dragging");
          });
          ul.addEventListener(
            "dragend",
            () => dragEl && dragEl.classList.remove("dragging")
          );
          ul.addEventListener("dragover", (e) => {
            e.preventDefault();
            const after = [
              ...ul.querySelectorAll("li[draggable='true']:not(.dragging)"),
            ].find((el) => {
              const box = el.getBoundingClientRect();
              return e.clientY <= box.top + box.height / 2;
            });
            if (dragEl) ul.insertBefore(dragEl, after || null);
          });
        };
      /* ==== ë¡œê³  ê²½ë¡œ & ë‹¤í¬ëª¨ë“œ ==== */
      const LOGO_SRC = "./assets/foodie-logo.png"; // <- ì‹¤ì œ ê²½ë¡œë¡œ ë°”ê¾¸ì„¸ìš”
      function applyLogo() {
        const img = document.getElementById("site-logo");
        if (img && LOGO_SRC) img.src = LOGO_SRC;
      }
      // ë‹¤í¬ëª¨ë“œ ê´€ë ¨ ì½”ë“œ ì œê±°ë¨
      applyLogo();

      /* ==== í™ˆ ë ˆì´ì•„ì›ƒ ìˆœì„œ(load & apply) ==== */
      let homeLayout = []; // ["login","roadmap","dynamic"]

      function applyHomeLayoutOrder() {
        const host = document.getElementById("pre-login-info");
        if (!host) return;
        const map = {
          login: document.getElementById("login-section"),
          roadmap: document.getElementById("roadmap-section"),
          dynamic: document.getElementById("dynamic-blocks"),
        };

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” roadmap ì„¹ì…˜ì„ ì œì™¸
        const defaultOrder = currentUser
          ? ["login", "roadmap", "dynamic"]
          : ["login", "dynamic"]; // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” roadmap ì œì™¸

        const order =
          Array.isArray(homeLayout) && homeLayout.length
            ? homeLayout
            : defaultOrder;

        order.forEach((key) => {
          const elx = map[key];
          if (elx) {
            // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” roadmap ì„¹ì…˜ì„ ìˆ¨ê¹€
            if (key === "roadmap") {
              if (!currentUser) {
                elx.style.display = "none";
                elx.classList.add("hidden");
              } else {
                elx.style.display = "";
                elx.classList.remove("hidden");
              }
            } else {
              elx.style.display = "";
            }
            host.appendChild(elx);
          }
        });
      }
      /* ===== Firebase ===== */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        runTransaction,
        collection,
        query,
        orderBy,
        addDoc,
        serverTimestamp,
        writeBatch,
        getDocs,
        where,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import {
        getStorage,
        ref as sRef,
        uploadBytesResumable,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDdrnlSQZa-GD006G9fvgYDL0V_ib3_pcE",
        authDomain: "foodie-club-694ba.firebaseapp.com",
        projectId: "foodie-club-694ba",
        storageBucket: "foodie-club-694ba.appspot.com",
        messagingSenderId: "563737208880",
        appId: "1:563737208880:web:d82b4ea6dd06754eb7e5f5",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const storage = getStorage(app);

      const IS_FILE = location.protocol === "file:";
      const USE_DEMO_OFFLINE = false; // í•­ìƒ Firebase ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½

      /* ===== ìƒíƒœ ===== */
      let currentUser = null;
      let adminList = [];
      let adminPositions = {};
      let customDefaultPositions = [];
      let deletedDefaultPositions = [];
      const MASTER_CODE = "foodie_emergency_2024!";

      // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í˜„ì¬ íƒ­ ìƒíƒœ ì €ì¥
      let currentDashboardTab = "members"; // ê¸°ë³¸ê°’: íšŒì› íƒ­
      let currentMainTab = "reservation"; // ë©”ì¸ íƒ­ ìƒíƒœ ì €ì¥

      // settings
      let signupSettings = { open: false, start: "", end: "" };
      let duesSettings = {
        enabled: false,
        bank: "",
        number: "",
        holder: "",
        amount: "",
        note: "",
      };

      // data
      let roadmapData = [],
        suggestionsData = [];
      let historyData = [],
        eventsData = [];
      let membersData = [];
      let blocksData = [];
      let presenceData = [];
      let onlineUsers = [];
      let memberSearchTerm = "";
      let editingEventId = null;
      let roadmapShowAll = false;
      let presenceTimer = null;

      // í™ˆë¸”ë¡ í¼ í¸ì§‘ ìƒíƒœ
      let editingBlockId_notice = null;
      let editingBlockId_qa = null;
      let editingBlockId_scores = null;

      /* ===== ê¶Œí•œ ê´€ë¦¬ í•¨ìˆ˜ ===== */
      function isAdmin() {
        return currentUser && adminList.includes(currentUser.studentId);
      }

      function isStaff() {
        if (!currentUser) return false;
        const position = adminPositions[currentUser.studentId];
        return position === "ìš´ì˜ì§„";
      }

      function isFullAdmin() {
        if (!currentUser) return false;
        const position = adminPositions[currentUser.studentId];
        return (
          position &&
          ["íšŒì¥", "ë¶€íšŒì¥", "ì´ë¬´", "ê¸°íšë¶€ì¥", "í™ë³´ë¶€ì¥", "ê°œë°œì"].includes(
            position
          )
        );
      }

      function isAdminOrStaff() {
        return isAdmin() || isStaff();
      }

      /* ===== DOM refs & helpers ===== */
      const el = {
        loading: document.getElementById("loading-screen"),
        pre: document.getElementById("pre-login-info"),
        main: document.getElementById("main-content"),
        id: document.getElementById("studentId"),
        name: document.getElementById("studentName"),
        alert: document.getElementById("alert-modal"),
        alertIcon: document.getElementById("modal-icon"),
        alertMsg: document.getElementById("alert-message"),
        emerg: document.getElementById("emergency-modal"),
        signupBanner: document.getElementById("signup-banner"),
        signupBtn: document.getElementById("signup-button"),
        signupModal: document.getElementById("signup-modal"),
        duesBox: document.getElementById("dues-box"),
        duesBoxContent: document.getElementById("dues-box-content"),
        duesModal: document.getElementById("dues-modal"),
        duesModalBody: document.getElementById("dues-modal-body"),
        presenceBadge: document.getElementById("presence-badge"),
        presenceCount: document.getElementById("presence-count"),
        presencePop: document.getElementById("presence-pop"),
        presenceList: document.getElementById("presence-list"),
        blockEditor: document.getElementById("block-editor"),
        blockEditorTitle: document.getElementById("block-editor-title"),
        blockEditorBody: document.getElementById("block-editor-body"),
        blockEditorSave: document.getElementById("block-editor-save"),
        blockEditorCancel: document.getElementById("block-editor-cancel"),
      };
      const showAlert = (icon, msg) => {
        el.alertIcon.innerHTML = icon || "â„¹ï¸";
        el.alertMsg.innerHTML = msg || "";
        el.alert.classList.remove("hidden");
      };
      const closeModal = () => el.alert.classList.add("hidden");
      const closeEmergencyModal = () => el.emerg.classList.add("hidden");
      const mask = (sid) => (sid ? `${String(sid).slice(0, 4)}****` : "");
      const isWithin = (d, s, e) => {
        const x = new Date(d);
        x.setHours(0, 0, 0, 0);
        const S = s ? new Date(s) : null,
          E = e ? new Date(e) : null;
        if (S) S.setHours(0, 0, 0, 0);
        if (E) E.setHours(23, 59, 59, 999);
        return (!S || x >= S) && (!E || x <= E);
      };
      const isSignupOpen = () => {
        if (signupSettings.open) return true;
        const hasStart = !!(
          signupSettings.start && signupSettings.start.trim()
        );
        const hasEnd = !!(signupSettings.end && signupSettings.end.trim());
        if (!hasStart && !hasEnd) return false;
        const today = new Date().toISOString().slice(0, 10);
        return isWithin(
          today,
          hasStart ? signupSettings.start : null,
          hasEnd ? signupSettings.end : null
        );
      };
      const isUserIn = (arr = []) =>
        arr?.some((p) => p.studentId === currentUser?.studentId);
      const formatKRW = (n) => {
        const v = Number(n || 0);
        return isNaN(v) ? "" : v.toLocaleString("ko-KR") + "ì›";
      };
      const timeAgo = (ms) => {
        const diff = (Date.now() - ms) / 1000;
        if (diff < 60) return `${Math.max(0, Math.floor(diff))}ì´ˆ ì „`;
        const m = diff / 60;
        if (m < 60) return `${Math.floor(m)}ë¶„ ì „`;
        return `${Math.floor(m / 60)}ì‹œê°„ ì „`;
      };
      const typeLabel = (t) =>
        ({
          tasting: "ë¯¸ì‹íšŒ",
          general: "ì¼ë°˜",
          mt: "MT",
          assembly: "ì´íšŒ",
        }[t] || t);
      const typeBadgeClass = (t) =>
        t === "tasting"
          ? "bg-orange-100 text-orange-700"
          : t === "mt"
          ? "bg-orange-100 text-orange-700"
          : t === "assembly"
          ? "bg-pink-100 text-pink-700"
          : "bg-emerald-100 text-emerald-700"; /* general */
      const typeAccentClass = (t) =>
        t === "tasting"
          ? "accent-tasting"
          : t === "mt"
          ? "accent-mt"
          : t === "assembly"
          ? "accent-assembly"
          : "accent-general"; /* general */
      const statusLabel = (s) =>
        ({ open: "ê³µê°œ", archived: "ìˆ¨ê¹€", closed: "ë§ˆê°ë¨" }[s] || s);
      const saf = (x) =>
        window.DOMPurify
          ? DOMPurify.sanitize(String(x ?? ""))
          : String(x ?? "");

      const getPositionSuffix = () => {
        if (!currentUser) return "";

        // ê´€ë¦¬ìì¸ ê²½ìš°
        if (adminList.includes(currentUser.studentId)) {
          const position = adminPositions[currentUser.studentId];
          return position ? ` ${position}` : "";
        }

        // ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš° íšŒì›ìœ¼ë¡œ í‘œì‹œ
        return " íšŒì›";
      };
      let __renderQueued = false;
      let __isInitialLoading = true;
      let __loadingDataCount = 0;
      const __expectedDataSources = 7; // blocks, roadmap, events, members, suggestions, history, positions

      const scheduleRender = () => {
        if (__renderQueued) return;
        __renderQueued = true;
        requestAnimationFrame(() => {
          __renderQueued = false;

          // í˜„ì¬ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œê°€ ì—´ë ¤ìˆëŠ” ê²½ìš°, í•´ë‹¹ íƒ­ë§Œ ì—…ë°ì´íŠ¸
          if (
            currentMainTab === "dashboard" &&
            currentUser &&
            adminList.includes(currentUser.studentId)
          ) {
            const subtabContainer = document.getElementById("subtab-container");
            if (subtabContainer && currentDashboardTab) {
              // í˜„ì¬ ì—´ë ¤ìˆëŠ” ëŒ€ì‹œë³´ë“œ ì„œë¸Œíƒ­ë§Œ ë‹¤ì‹œ ë Œë”ë§
              if (currentDashboardTab === "members") {
                renderMembersAdmin(subtabContainer);
              } else {
                // ë‹¤ë¥¸ íƒ­ë“¤ì€ ì „ì²´ ë Œë”ë§ í•„ìš”
                renderAll();
              }
            } else {
              renderAll();
            }
          } else {
            renderAll();
          }
        });
      };

      const checkLoadingComplete = () => {
        console.log(
          `ë¡œë”© ì™„ë£Œ ì²´í¬: ${__loadingDataCount}/${__expectedDataSources}, ì´ˆê¸°ë¡œë”©: ${__isInitialLoading}`
        );

        // ìˆœì°¨ì ì¸ ë¡œë”© ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        if (__isInitialLoading) {
          const progressPercentage = Math.min(
            (__loadingDataCount / __expectedDataSources) * 90,
            90
          );

          // ëª¨ë“  ë‹¨ê³„ì—ì„œ "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!" ë©”ì‹œì§€ í‘œì‹œ
          let loadingMessage = "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!";

          updateLoadingProgress(1, loadingMessage);

          if (__loadingDataCount >= __expectedDataSources) {
            __isInitialLoading = false;
            console.log("ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ! ë¡œë”© í™”ë©´ ìˆ¨ê¹€");
            updateLoadingProgress(2, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");

            // "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ë¥¼ 3ì´ˆê°„ í‘œì‹œ
            setTimeout(() => {
              hideLoadingScreen();
              // ì»¨í…ì¸  ë¡œë“œ ìƒíƒœ í™•ì¸
              checkContentLoaded();
            }, 3000);
          }
        }
      };

      // ì»¨í…ì¸ ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
      const checkContentLoaded = () => {
        console.log("=== ì»¨í…ì¸  ë¡œë“œ ìƒíƒœ í™•ì¸ ===");

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
        const isOnline = navigator.onLine;
        console.log("ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:", isOnline ? "ì˜¨ë¼ì¸" : "ì˜¤í”„ë¼ì¸");

        // ìš°ì„ ìˆœìœ„ ë°ì´í„° í™•ì¸ (ê°€ì¥ ì¤‘ìš”í•œ ë°ì´í„°ë¶€í„°)
        const hasValidRoadmapData =
          roadmapData &&
          roadmapData.length > 0 &&
          roadmapData.some(
            (item) => item && item.id // IDë§Œ ìˆìœ¼ë©´ ìœ íš¨í•œ ë°ì´í„°ë¡œ ê°„ì£¼
          );
        const hasValidEventsData = eventsData && eventsData.length > 0;
        const hasValidBlocksData = blocksData && blocksData.length > 0;
        const hasValidMembersData = membersData && membersData.length > 0;

        console.log("ìš°ì„ ìˆœìœ„ ë°ì´í„° ê²€ì‚¬:");
        console.log(
          "- roadmapData (ìµœìš°ì„ ):",
          hasValidRoadmapData,
          roadmapData?.length || 0
        );
        console.log(
          "- eventsData:",
          hasValidEventsData,
          eventsData?.length || 0
        );
        console.log(
          "- blocksData:",
          hasValidBlocksData,
          blocksData?.length || 0
        );
        console.log(
          "- membersData:",
          hasValidMembersData,
          membersData?.length || 0
        );

        // DOM ìš”ì†Œ í™•ì¸
        const mainContentEl = document.getElementById("main-content");
        const preContentEl = document.getElementById("pre-content");
        const loadingScreenEl = document.getElementById("loading-screen");

        const hasMainContent =
          mainContentEl && !mainContentEl.classList.contains("hidden");
        const hasPreContent =
          preContentEl && !preContentEl.classList.contains("hidden");
        const isLoadingScreenVisible =
          loadingScreenEl &&
          loadingScreenEl.style.display !== "none" &&
          !loadingScreenEl.classList.contains("hidden");

        console.log("hasMainContent:", hasMainContent);
        console.log("hasPreContent:", hasPreContent);
        console.log("isLoadingScreenVisible:", isLoadingScreenVisible);

        // í˜ì´ì§€ ë¡œë“œ ì‹œê°„ í™•ì¸ (ë„ˆë¬´ ë¹¨ë¦¬ ì²´í¬í•˜ì§€ ì•Šë„ë¡)
        const pageLoadTime =
          Date.now() -
          (window.performance?.timing?.navigationStart || Date.now());
        console.log("í˜ì´ì§€ ë¡œë“œ ì‹œê°„:", pageLoadTime + "ms");

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ í™•ì¸
        const isLoggedOut = !currentUser;

        // ë¹ ë¥¸ ì¬ì ‘ì† ì¡°ê±´ (ìš°ì„ ìˆœìœ„ ê¸°ë°˜) - ë” ì •í™•í•˜ê³  ë¹ ë¥¸ ê°ì§€
        const criticalDataMissing =
          !hasValidRoadmapData && !hasValidEventsData && !hasValidBlocksData;

        // UI ê°€ì‹œì„± í™•ì¸ ê°œì„ 
        const uiNotVisible = !hasMainContent && !hasPreContent;
        const stillLoading = isLoadingScreenVisible && pageLoadTime > 6000; // 6ì´ˆë¡œ ë‹¨ì¶•
        const networkIssues = !isOnline && pageLoadTime > 3000; // 3ì´ˆë¡œ ë‹¨ì¶•

        // ì»¨í…ì¸ ê°€ ì‹¤ì œë¡œ í‘œì‹œë˜ì§€ ì•ŠëŠ” ê²½ìš° ê°ì§€
        const noContentDisplayed =
          (!hasMainContent && !hasPreContent) ||
          (hasMainContent && mainContentEl.innerHTML.trim() === "") ||
          (hasPreContent && preContentEl.innerHTML.trim() === "");

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ë°ì´í„°ê°€ ì—†ì–´ë„ ì •ìƒìœ¼ë¡œ ì²˜ë¦¬
        const needsQuickReconnect =
          !isLoggedOut &&
          (criticalDataMissing ||
            (uiNotVisible && pageLoadTime > 2000) || // 2ì´ˆë¡œ ë” ë‹¨ì¶•
            (noContentDisplayed && pageLoadTime > 4000) || // ìƒˆë¡œ ì¶”ê°€ëœ ì¡°ê±´
            stillLoading ||
            networkIssues);

        console.log("ë¹ ë¥¸ ì¬ì ‘ì† ì¡°ê±´:");
        console.log("- í•µì‹¬ ë°ì´í„° ì—†ìŒ:", criticalDataMissing);
        console.log("- UI ìˆ¨ê¹€:", uiNotVisible && pageLoadTime > 2000);
        console.log(
          "- ì»¨í…ì¸  ë¯¸í‘œì‹œ:",
          noContentDisplayed && pageLoadTime > 4000
        );
        console.log("- ë¡œë”© ì§€ì—°:", stillLoading);
        console.log("- ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ:", networkIssues);
        console.log("- ìµœì¢… íŒë‹¨:", needsQuickReconnect);

        if (needsQuickReconnect) {
          console.warn("âš ï¸ í•µì‹¬ ì»¨í…ì¸  ë¡œë“œ ì‹¤íŒ¨! ì¦‰ì‹œ ì¬ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤.");

          // ì¦‰ì‹œ ìë™ ì¬ì ‘ì† (ì•Œë¦¼ ì°½ ì—†ì´)
          console.log("ğŸ”„ ë¹ ë¥¸ ì¬ì ‘ì† ì‹¤í–‰");
          location.reload();
        } else {
          console.log("âœ… ëª¨ë“  ì»¨í…ì¸ ê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
      };

      /* ===== ì¸ì¦ & ê¶Œí•œ ===== */
      async function login() {
        const sid = el.id.value.trim();
        const nm = el.name.value.trim();

        // ë¹„ìƒë³µêµ¬ëª¨ë“œ: ë§ˆìŠ¤í„° ì½”ë“œ ì…ë ¥ ì‹œ ì´ë¦„ ì—†ì´ë„ ì ‘ê·¼ ê°€ëŠ¥
        if (sid === MASTER_CODE) {
          if (nm === "") {
            return el.emerg.classList.remove("hidden");
          } else {
            // ì´ë¦„ì´ ì…ë ¥ëœ ê²½ìš° ë¹„ìƒë³µêµ¬ëª¨ë“œë¡œ ë¡œê·¸ì¸
            localStorage.setItem(
              "foodieUser",
              JSON.stringify({ studentId: sid, name: nm })
            );
            currentUser = { studentId: sid, name: nm };

            // ë¹„ìƒë³µêµ¬ëª¨ë“œì—ì„œëŠ” ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬
            adminList = [sid];
            adminPositions = { [sid]: "ë¹„ìƒë³µêµ¬ê´€ë¦¬ì" };
            currentUser.position = "ë¹„ìƒë³µêµ¬ê´€ë¦¬ì";

            console.log("=== ë¹„ìƒë³µêµ¬ëª¨ë“œ ë¡œê·¸ì¸ ===");
            console.log("currentUser:", currentUser);
            console.log("adminList:", adminList);

            ensureAdminOptionals();
            renderAll();
            return;
          }
        }

        if (!sid || !nm)
          return showAlert("ğŸ˜¥", "í•™ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        try {
          console.log("=== ë¡œê·¸ì¸ ì‹œë„ ===");
          console.log("ì…ë ¥ í•™ë²ˆ:", sid);
          console.log("ì…ë ¥ ì´ë¦„:", nm);

          const mref = doc(db, "members", sid);
          const ms = await getDoc(mref);

          console.log("Firebase ì¡°íšŒ ê²°ê³¼:", {
            exists: ms.exists(),
            data: ms.exists() ? ms.data() : null,
          });

          if (!ms.exists())
            return showAlert(
              "â›”",
              "ë“±ë¡ëœ íšŒì›ì´ ì•„ë‹™ë‹ˆë‹¤. íšŒì›ê°€ì… ê¸°ê°„ì— <b>íšŒì›ê°€ì…</b> ë²„íŠ¼ìœ¼ë¡œ ê°€ì…í•´ì£¼ì„¸ìš”."
            );
          const data = ms.data() || {};

          console.log("íšŒì› ë°ì´í„°:", data);
          console.log("ì´ë¦„ ë¹„êµ:", {
            ì…ë ¥ì´ë¦„: nm,
            ì €ì¥ëœì´ë¦„: (data.name || "").trim(),
            ì¼ì¹˜ì—¬ë¶€: (data.name || "").trim() === nm,
          });

          if ((data.name || "").trim() !== nm)
            return showAlert(
              "ğŸ™…â€â™‚ï¸",
              "ì…ë ¥í•œ ì´ë¦„ì´ íšŒì› ì •ë³´ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìš´ì˜ì§„ì—ê²Œ ìˆ˜ì • ìš”ì²­í•´ì£¼ì„¸ìš”."
            );
          const status = data.status || "active";
          // ê°œë°œìš©: pending ìƒíƒœë„ í—ˆìš©í•˜ê³  ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬
          if (status === "pending") {
            console.log("âš ï¸ ê°œë°œ ëª¨ë“œ: pending ìƒíƒœ ì‚¬ìš©ìë„ ë¡œê·¸ì¸ í—ˆìš©");
          }
          if (status === "rejected")
            return showAlert(
              "â›”",
              "ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤. ìš´ì˜ì§„ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”."
            );
          if (status === "blocked")
            return showAlert(
              "â›”",
              "ì ‘ê·¼ì´ ì œí•œëœ íšŒì›ì…ë‹ˆë‹¤. ìš´ì˜ì§„ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”."
            );

          localStorage.setItem(
            "foodieUser",
            JSON.stringify({ studentId: sid, name: nm })
          );
          currentUser = { studentId: sid, name: nm };

          // ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ëœ ê²½ìš° ì •ë³´ ì €ì¥
          const autoLoginCheckbox = document.getElementById(
            "auto-login-checkbox"
          );
          if (autoLoginCheckbox && autoLoginCheckbox.checked) {
            saveAutoLogin(sid, nm);
          }
          startPresence();
          try {
            const a = await getDoc(doc(db, "admins", "list"));
            adminList = a.exists() ? a.data().studentIds || [] : [];
            adminPositions = a.exists() ? a.data().positions || {} : {};

            // ê´€ë¦¬ìì¸ ê²½ìš° currentUser.position ì„¤ì •
            if (currentUser && adminList.includes(currentUser.studentId)) {
              currentUser.position =
                adminPositions[currentUser.studentId] || "ì¼ë°˜ íšŒì›";
              console.log("=== ì‚¬ìš©ì ì§ì±… ì„¤ì • ===");
              console.log("currentUser.studentId:", currentUser.studentId);
              console.log("adminPositions:", adminPositions);
              console.log("ì„¤ì •ëœ ì§ì±…:", currentUser.position);
            }
          } catch {}
          ensureAdminOptionals();

          // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
          updateGameButtonsVisibility();

          renderAll();
        } catch (e) {
          console.warn(e);
          showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }
      const logout = async () => {
        try {
          stopPresence();
          localStorage.removeItem("foodieUser");
          currentUser = null;
          clearAdmin();
          clearAutoLogin(); // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
          await signOut(auth);

          // ë¡œê·¸ì•„ì›ƒ ì‹œ ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
          updateGameButtonsVisibility();

          // ë¡œë”© í™”ë©´ í‘œì‹œ ë° "ì˜ ë¨¹ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€
          const loadingScreen = document.getElementById("loading-screen");
          if (loadingScreen) {
            loadingScreen.classList.remove("hidden");
          }

          // ë¡œë”©ë°”ì—ì„œ "ì˜ ë¨¹ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í‘œì‹œ
          updateLoadingProgress(2, "ì˜ ë¨¹ì—ˆìŠµë‹ˆë‹¤!");

          // 2ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            location.reload();
          }, 2000);
        } catch (e) {
          console.warn(e);
          location.reload();
        }
      };
      async function verifyAutoLogin(saved) {
        try {
          const mref = doc(db, "members", saved.studentId);
          const ms = await getDoc(mref);
          if (!ms.exists()) return logout();
          const d = ms.data() || {};
          if ((d.name || "").trim() !== saved.name) return logout();
          // ê°œë°œìš©: pending ìƒíƒœë„ í—ˆìš©
          const status = d.status || "active";
          if (status === "rejected" || status === "blocked") return logout();
          try {
            const a = await getDoc(doc(db, "admins", "list"));
            adminList = a.exists() ? a.data().studentIds || [] : [];
            adminPositions = a.exists() ? a.data().positions || {} : {};

            // ê´€ë¦¬ìì¸ ê²½ìš° currentUser.position ì„¤ì •
            if (currentUser && adminList.includes(currentUser.studentId)) {
              currentUser.position =
                adminPositions[currentUser.studentId] || "ì¼ë°˜ íšŒì›";
              console.log("=== ìë™ ë¡œê·¸ì¸ ì‚¬ìš©ì ì§ì±… ì„¤ì • ===");
              console.log("currentUser.studentId:", currentUser.studentId);
              console.log("adminPositions:", adminPositions);
              console.log("ì„¤ì •ëœ ì§ì±…:", currentUser.position);
            }
          } catch {}
          ensureAdminOptionals();

          // ìë™ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
          updateGameButtonsVisibility();
        } catch {}
      }

      /* ===== Presence ===== */
      function startPresence() {
        if (!currentUser) return;
        try {
          const ref = doc(db, "presence", currentUser.studentId);
          const ping = () =>
            setDoc(
              ref,
              {
                studentId: currentUser.studentId,
                name: currentUser.name,
                ua: navigator.userAgent,
                lastActiveMs: Date.now(),
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            );
          ping();
          if (presenceTimer) clearInterval(presenceTimer);
          presenceTimer = setInterval(ping, 25000);
          const end = () => ping();
          window.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") end();
            else ping();
          });
          window.addEventListener("pagehide", end);
          window.addEventListener("beforeunload", end);
        } catch (e) {
          console.warn("presence start err", e);
        }
      }
      function stopPresence() {
        if (presenceTimer) {
          clearInterval(presenceTimer);
          presenceTimer = null;
        }
      }
      function computeOnline() {
        const threshold = Date.now() - 60 * 1000;
        onlineUsers = presenceData
          .filter((p) => (p.lastActiveMs || 0) >= threshold)
          .sort((a, b) => b.lastActiveMs - a.lastActiveMs);
      }
      function renderPresenceUI() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin) {
          el.presenceBadge.classList.add("hidden");
          el.presencePop.classList.add("hidden");
          return;
        }
        el.presenceBadge.classList.remove("hidden");
        el.presenceCount.textContent = onlineUsers.length;
        el.presenceList.innerHTML = onlineUsers.length
          ? onlineUsers
              .map(
                (u) =>
                  `<div class="flex items-center justify-between py-1"><div class="truncate"><b>${saf(
                    u.name || ""
                  )}</b> <span class="text-xs text-gray-500 font-mono">${mask(
                    u.studentId
                  )}</span></div><div class="text-xs text-gray-500 ml-2">${timeAgo(
                    u.lastActiveMs || 0
                  )}</div></div>`
              )
              .join("")
          : `<div class="text-gray-400">ì§€ê¸ˆì€ ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      }

      function updateGameButtonsVisibility() {
        const gameButtonsContainer = document.getElementById(
          "game-buttons-container"
        );
        if (!gameButtonsContainer) return;

        // currentUserê°€ ìˆìœ¼ë©´ ë¡œê·¸ì¸ ìƒíƒœ, ì—†ìœ¼ë©´ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
        if (currentUser) {
          // ë¡œê·¸ì¸ ìƒíƒœ: ë²„íŠ¼ í‘œì‹œ
          gameButtonsContainer.classList.remove("hidden");
        } else {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ: ë²„íŠ¼ ìˆ¨ê¹€
          gameButtonsContainer.classList.add("hidden");
        }
      }
      document.addEventListener("click", (e) => {
        if (
          !e.target.closest("#presence-badge") &&
          !e.target.closest("#presence-pop")
        )
          el.presencePop.classList.add("hidden");
      });
      document
        .getElementById("presence-badge")
        .addEventListener("click", () =>
          el.presencePop.classList.toggle("hidden")
        );

      /* ===== ë¦¬ìŠ¤ë„ˆ ===== */
      const unsubPublic = {
        admins: null,
        signup: null,
        dues: null,
        blocks: null,
        customPositions: null,
        roadmap: null,
        events: null,
      };
      const unsubAdmin = {
        suggestions: null,
        history: null,
        members: null,
        presence: null,
      };
      const clearPublic = () =>
        Object.keys(unsubPublic).forEach((k) => {
          if (unsubPublic[k]) {
            unsubPublic[k]();
            unsubPublic[k] = null;
          }
        });
      const clearAdmin = () =>
        Object.keys(unsubAdmin).forEach((k) => {
          if (unsubAdmin[k]) {
            unsubAdmin[k]();
            unsubAdmin[k] = null;
          }
        });

      const DEMO = {
        roadmap: [
          {
            id: "r1",
            activityName: "Foodie ê°œê°•ì´íšŒ ğŸ»",
            activityDate: "2025-09-16",
            order: 0,
          },
          {
            id: "r2",
            activityName: "ğŸ™‹ğŸ»â€â™‚ï¸Foodie ì¡°ëª¨ì„ ì‹œì‘ !",
            activityDate: "2025-09-22",
            order: 1,
          },
          {
            id: "r3",
            activityName: "ğŸ‘¨ğŸ»â€ğŸ³Foodie ë¯¸ì‹íšŒ (í“¨ì „ìš”ë¦¬)",
            activityDate: "2025-09-24",
            order: 2,
          },
          {
            id: "r4",
            activityName: "ğŸ¥© Foodie ë¯¸ì‹íšŒ (ì–‘ì‹)ğŸ",
            activityDate: "2025-10-14",
            order: 3,
          },
          {
            id: "r5",
            activityName: "âœ¨ Foodie ë¯¸ì‹íšŒ (ë¯¸ì •)âœ¨",
            activityDate: "2025-11-05",
            order: 4,
          },
          {
            id: "r6",
            activityName: "Foodie MT ë– ë‚˜ìš”ğŸš—",
            activityDate: "2025-11-08",
            order: 5,
          },
          {
            id: "r7",
            activityName: "âœ¨ Foodie ë¯¸ì‹íšŒ (ë¯¸ì •)âœ¨",
            activityDate: "2025-11-12",
            order: 6,
          },
          {
            id: "r8",
            activityName: "âœ¨ Foodie ë¯¸ì‹íšŒ (ë¯¸ì •)âœ¨",
            activityDate: "2025-11-19",
            order: 7,
          },
          {
            id: "r9",
            activityName: "ğŸ™‹ğŸ»â€â™‚ï¸Foodie ì¡°ëª¨ì„ ì¢…ë£ŒğŸ‘‹",
            activityDate: "2025-11-25",
            order: 8,
          },
          {
            id: "r10",
            activityName: "ğŸ˜¢ì•„ì‰¬ìš´ ì¢…ê°•ì´íšŒğŸ˜¢",
            activityDate: "2025-12-05",
            order: 9,
          },
        ],
      };

      function startPublicListeners() {
        if (!unsubPublic.homelayout) {
          unsubPublic.homelayout = onSnapshot(
            doc(db, "settings", "homeLayout"),
            (snap) => {
              homeLayout = snap.exists() ? snap.data().order || [] : [];
              applyHomeLayoutOrder();
            }
          );
        }
        if (!unsubPublic.admins) {
          unsubPublic.admins = onSnapshot(doc(db, "admins", "list"), (snap) => {
            adminList = snap.exists() ? snap.data().studentIds || [] : [];
            adminPositions = snap.exists() ? snap.data().positions || {} : {};

            // ê´€ë¦¬ìì¸ ê²½ìš° currentUser.position ì—…ë°ì´íŠ¸
            if (currentUser && adminList.includes(currentUser.studentId)) {
              currentUser.position =
                adminPositions[currentUser.studentId] || "ì¼ë°˜ íšŒì›";
              console.log("=== Firebase ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©ì ì§ì±… ì—…ë°ì´íŠ¸ ===");
              console.log("currentUser.studentId:", currentUser.studentId);
              console.log("adminPositions:", adminPositions);
              console.log("ì—…ë°ì´íŠ¸ëœ ì§ì±…:", currentUser.position);
            }

            ensureAdminOptionals();
            scheduleRender();
          });
        }
        if (!unsubPublic.signup) {
          unsubPublic.signup = onSnapshot(
            doc(db, "settings", "signup"),
            (snap) => {
              signupSettings = snap.exists()
                ? snap.data()
                : { open: false, start: "", end: "" };
              updateSignupUI();
              scheduleRender();
            }
          );
        }
        if (!unsubPublic.dues) {
          unsubPublic.dues = onSnapshot(doc(db, "settings", "dues"), (snap) => {
            duesSettings = snap.exists()
              ? snap.data()
              : {
                  enabled: false,
                  bank: "",
                  number: "",
                  holder: "",
                  amount: "",
                  note: "",
                };
            updateSignupUI();
            scheduleRender();
          });
        }
        if (!unsubPublic.blocks) {
          unsubPublic.blocks = onSnapshot(
            query(collection(db, "homepageBlocks"), orderBy("order", "asc")),
            (snap) => {
              blocksData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("blocks:", err?.message)
          );
        }
        if (!unsubPublic.customPositions) {
          unsubPublic.customPositions = onSnapshot(
            doc(db, "settings", "customPositions"),
            (snap) => {
              customDefaultPositions = snap.exists()
                ? snap.data().positions || []
                : [];
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("customPositions:", err?.message)
          );
        }
        if (!unsubPublic.deletedPositions) {
          unsubPublic.deletedPositions = onSnapshot(
            doc(db, "settings", "deletedPositions"),
            (snap) => {
              deletedDefaultPositions = snap.exists()
                ? snap.data().positions || []
                : [];
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("deletedPositions:", err?.message)
          );
        }
        if (!unsubPublic.roadmap) {
          // ë¡œë“œë§µ: order í•„ë“œë¥¼ ê´€ë¦¬í•˜ë¯€ë¡œ ì •ë ¬ì€ ë Œë”ë§ ì‹œì ì—ì„œ ì²˜ë¦¬
          console.log(
            "ë¡œë“œë§µ ë°ì´í„° ë¡œë”© ì‹œì‘, USE_DEMO_OFFLINE:",
            USE_DEMO_OFFLINE
          );

          if (USE_DEMO_OFFLINE) {
            // ë¡œì»¬ íŒŒì¼ ëª¨ë“œì—ì„œëŠ” ë°ëª¨ ë°ì´í„° ì‚¬ìš©
            roadmapData = DEMO.roadmap;
            console.log("DEMO ë¡œë“œë§µ ë°ì´í„° ì‚¬ìš©:", roadmapData);
            if (__isInitialLoading) {
              __loadingDataCount++;
              checkLoadingComplete();
            }
            scheduleRender();
          } else {
            console.log("Firebaseì—ì„œ ë¡œë“œë§µ ë°ì´í„° ë¡œë”© ì¤‘...");
            unsubPublic.roadmap = onSnapshot(
              collection(db, "roadmap"),
              (snap) => {
                roadmapData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
                console.log("Firebase ë¡œë“œë§µ ë°ì´í„° ì—…ë°ì´íŠ¸:", roadmapData);
                console.log("ë¬¸ì„œ ê°œìˆ˜:", snap.docs.length);
                console.log(
                  "ë³€ê²½ëœ ë¬¸ì„œë“¤:",
                  snap.docChanges().map((change) => ({
                    type: change.type,
                    docId: change.doc.id,
                    data: change.doc.data(),
                  }))
                );
                if (__isInitialLoading) {
                  __loadingDataCount++;
                  checkLoadingComplete();
                }
                scheduleRender();
              },
              (err) => {
                console.warn("roadmap ë¡œë”© ì˜¤ë¥˜:", err?.message);
                roadmapData = DEMO.roadmap;
                console.log("ì˜¤ë¥˜ë¡œ ì¸í•´ DEMO ë°ì´í„° ì‚¬ìš©:", roadmapData);
                if (__isInitialLoading) {
                  __loadingDataCount++;
                  checkLoadingComplete();
                }
                scheduleRender();
              }
            );
          }
        }
        if (!unsubPublic.events) {
          unsubPublic.events = onSnapshot(
            query(collection(db, "events")),
            (snap) => {
              eventsData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

              // order í•„ë“œê°€ ì—†ëŠ” ì´ë²¤íŠ¸ë“¤ì— ê¸°ë³¸ê°’ ì„¤ì •
              eventsData.forEach((event, index) => {
                if (event.order === undefined || event.order === null) {
                  event.order = index;
                }
              });

              // order í•„ë“œë¡œ ì •ë ¬
              eventsData.sort((a, b) => (a.order || 0) - (b.order || 0));

              console.log("=== Firebaseì—ì„œ ì´ë²¤íŠ¸ ë¡œë“œ ===");
              console.log(
                "ë¡œë“œëœ ì´ë²¤íŠ¸ ìˆœì„œ:",
                eventsData.map((ev) => ({
                  id: ev.id,
                  order: ev.order,
                  title: ev.title,
                }))
              );
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("events:", err?.message)
          );
        }
      }
      function startAdminListeners() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin) return;
        if (!unsubAdmin.suggestions) {
          unsubAdmin.suggestions = onSnapshot(
            query(collection(db, "suggestions"), orderBy("timestamp", "desc")),
            (snap) => {
              suggestionsData = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
              }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("suggestions:", err?.message)
          );
        }
        if (!unsubAdmin.history) {
          unsubAdmin.history = onSnapshot(
            query(collection(db, "history"), orderBy("createdAt", "desc")),
            (snap) => {
              historyData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("history:", err?.message)
          );
        }
        if (!unsubAdmin.members) {
          unsubAdmin.members = onSnapshot(
            query(collection(db, "members"), orderBy("name", "asc")),
            (snap) => {
              membersData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              if (__isInitialLoading) {
                __loadingDataCount++;
                checkLoadingComplete();
              }
              scheduleRender();
            },
            (err) => console.warn("members:", err?.message)
          );
        }
        if (!unsubAdmin.presence) {
          unsubAdmin.presence = onSnapshot(
            collection(db, "presence"),
            (snap) => {
              presenceData = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
              computeOnline();
              renderPresenceUI();
            },
            (err) => console.warn("presence:", err?.message)
          );
        }
      }
      function ensureAdminOptionals() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (isAdmin) startAdminListeners();
        else {
          clearAdmin();
          renderPresenceUI();
        }

        // ê²Œì„ ì ìˆ˜ ë°ì´í„° ë¡œë“œ (ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ì)
        if (currentUser) {
          loadGameScores();
          loadGroupsData();
        }
      }

      async function main() {
        try {
          await signInAnonymously(auth);
        } catch (e) {
          console.warn("auth fail:", e?.message || e);
        } finally {
          startPublicListeners();
          const saved = JSON.parse(
            localStorage.getItem("foodieUser") || "null"
          );
          if (saved) {
            currentUser = saved;
            verifyAutoLogin(saved).catch(() => {});
            startPresence();
          }
          setTimeout(() => el.loading.classList.add("hidden"), 2000);
          document
            .getElementById("login-button")
            .addEventListener("click", login);
          document
            .getElementById("signup-button")
            .addEventListener("click", openSignupModal);
          document
            .getElementById("modal-close-button")
            .addEventListener("click", closeModal);
          document
            .getElementById("signup-cancel-button")
            .addEventListener("click", () =>
              el.signupModal.classList.add("hidden")
            );
          // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·
          document
            .getElementById("signupPhone")
            .addEventListener("input", (e) => {
              let value = e.target.value.replace(/[^0-9]/g, ""); // ìˆ«ìë§Œ ì¶”ì¶œ
              if (value.length > 11) value = value.slice(0, 11); // ìµœëŒ€ 11ìë¦¬

              // 000-0000-0000 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
              if (value.length > 7) {
                e.target.value = `${value.slice(0, 3)}-${value.slice(
                  3,
                  7
                )}-${value.slice(7)}`;
              } else if (value.length > 3) {
                e.target.value = `${value.slice(0, 3)}-${value.slice(3)}`;
              } else {
                e.target.value = value;
              }
            });

          document
            .getElementById("signup-confirm-button")
            .addEventListener("click", () => confirmSignup(false));
          document
            .getElementById("dues-proceed-button")
            .addEventListener("click", () => {
              el.duesModal.classList.add("hidden");
              confirmSignup(true);
            });
          document
            .getElementById("dues-cancel-button")
            .addEventListener("click", () =>
              el.duesModal.classList.add("hidden")
            );
          document
            .getElementById("dues-copy-button")
            .addEventListener("click", () => {
              const d = duesSettings || {};
              const text = [d.bank, d.number].filter(Boolean).join(" ");
              navigator.clipboard
                ?.writeText(text)
                .then(() => showAlert("âœ…", "ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."));
            });
          document
            .getElementById("emergency-cancel-button")
            .addEventListener("click", closeEmergencyModal);
          document
            .getElementById("emergency-add-button")
            .addEventListener("click", addEmergencyAdmin);
          renderAll();
        }
      }
      main();

      /* ===== UI ì—…ë°ì´íŠ¸ ===== */
      function updateSignupUI() {
        const openNow = isSignupOpen();
        if (el.signupBanner)
          el.signupBanner.classList.toggle("hidden", !openNow);
        if (el.signupBtn) {
          el.signupBtn.disabled = !openNow;
          el.signupBtn.title = openNow
            ? "íšŒì›ê°€ì… ê°€ëŠ¥"
            : "í˜„ì¬ëŠ” íšŒì›ê°€ì… ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.";
        }
        renderDuesInfoBox();
      }

      function renderAll() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (currentUser) {
          el.pre.classList.add("hidden");
          el.main.innerHTML = `
            <div class="mb-4 md:mb-6">
              <div class="flex items-center justify-between mb-4">
                <p class="text-gray-700 text-lg md:text-xl font-medium"><span class="text-orange-600 font-bold text-4xl md:text-5xl">Foodie</span> <b id="userNameDisplay">${saf(
                  currentUser.name
                )}</b>${getPositionSuffix()}ë‹˜</p>
                <button 
                  type="button" 
                  id="inquiry-button" 
                  class="text-sm md:text-base bg-orange-500 text-white rounded-full px-3 py-1 hover:bg-orange-600 transition-colors">
                  <i class="fas fa-question-circle mr-1"></i>
                  <span>ë¬¸ì˜</span>
                </button>
              </div>
              
              <!-- ë¡œê·¸ì¸ í›„ ë¸”ë¡ í‘œì‹œ ì˜ì—­ (ë¡œë“œë§µ ìœ„) -->
              <div id="main-dynamic-blocks" class="space-y-4 md:space-y-6 mb-6"></div>
              
              <div id="dashboard-roadmap" class="section mb-4">
                <div class="mb-2 roadmap-accordion">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg md:text-xl font-bold">FğŸ‘€die ì¼ì •</h3>
                    <button
                      id="h-roadmap-toggle-btn"
                      type="button"
                      class="text-sm md:text-base bg-orange-500 text-white rounded-full px-3 py-1 hover:bg-orange-600 transition-colors flex items-center gap-1.5"
                    >
                        <i class="fas fa-calendar-alt"></i>
                        <span id="h-roadmap-toggle-text">ìº˜ë¦°ë”</span>
                        <i class="fas fa-chevron-down text-xs transition-transform duration-200" id="h-roadmap-chevron"></i>
                    </button>
                  </div>
                  <div class="schedule-blocks-container" id="h-roadmap-list"></div>
                  <div class="roadmap-accordion-content" id="h-roadmap-full-list" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out; opacity: 0;">
                    <!-- ì „ì²´ ì¼ì •ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                  </div>
                </div>
              </div>
            </div>
            <div class="mb-6 md:mb-8 bg-gradient-to-r from-gray-100 to-gray-50 rounded-2xl p-2 flex flex-nowrap justify-center gap-2 shadow-inner" id="tab-buttons">
              <button type="button" data-tab="reservation" class="tab-btn flex-1 py-3 sm:py-4 px-3 sm:px-4 md:px-6 rounded-xl font-bold active transition-all duration-300 ease-out whitespace-nowrap">
                <i class="fas fa-check mr-1 sm:mr-2 text-sm sm:text-base md:text-lg"></i>
                <span class="text-sm sm:text-base md:text-lg">ì‹ ì²­</span>
              </button>
              <button type="button" data-tab="history" class="tab-btn flex-1 py-3 sm:py-4 px-3 sm:px-4 md:px-6 rounded-xl font-bold transition-all duration-300 ease-out whitespace-nowrap">
                <i class="fas fa-history mr-1 sm:mr-2 text-sm sm:text-base md:text-lg"></i>
                <span class="text-sm sm:text-base md:text-lg">ë‚´ í™œë™</span>
              </button>
              <button type="button" data-tab="roadmap" class="tab-btn flex-1 py-3 sm:py-4 px-3 sm:px-4 md:px-6 rounded-xl font-bold transition-all duration-300 ease-out whitespace-nowrap">
                <i class="fas fa-utensils mr-1 sm:mr-2 text-sm sm:text-base md:text-lg"></i>
                <span class="text-sm sm:text-base md:text-lg">ë¯¸ì‹íšŒ</span>
              </button>
              <button type="button" data-tab="dashboard" class="tab-btn flex-1 py-3 sm:py-4 px-3 sm:px-4 md:px-6 rounded-xl font-bold transition-all duration-300 ease-out whitespace-nowrap ${
                isFullAdmin() ? "" : "hidden"
              }">
                <i class="fas fa-crown mr-1 sm:mr-2 text-sm sm:text-base md:text-lg"></i>
                <span class="text-sm sm:text-base md:text-lg">ê´€ë¦¬ì</span>
              </button>
            </div>
            <div id="tab-content-container">
              <div id="reservation-tab" class="tab-content active"></div>
              <div id="history-tab" class="tab-content"></div>
              <div id="roadmap-tab" class="tab-content"></div>
              <div id="suggestions-tab" class="tab-content"></div>
              <div id="dashboard-tab" class="tab-content"></div>
            </div>`;
          el.main.classList.remove("hidden");

          // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ í˜ì´ì§€ ë§¨ ì•„ë˜ì— ì¶”ê°€
          const logoutContainer = document.getElementById("logout-container");
          if (logoutContainer && currentUser) {
            logoutContainer.innerHTML = `
              <button id="logout-button" type="button" class="text-sm md:text-base text-gray-500 hover:text-red-500 bg-white px-4 py-2 rounded-full border shadow-sm transition-all duration-200 hover:shadow-md">
                ë¡œê·¸ì•„ì›ƒ
              </button>
            `;
            document
              .getElementById("logout-button")
              .addEventListener("click", logout);
          }
          document
            .getElementById("tab-buttons")
            .addEventListener("click", (e) => {
              const btn = e.target.closest(".tab-btn");
              if (btn) showTab(btn.dataset.tab);
            });

          // ë¬¸ì˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ - ëª¨ë‹¬ ì—´ê¸°
          const inquiryButton = document.getElementById("inquiry-button");
          if (inquiryButton) {
            inquiryButton.addEventListener("click", () => {
              openInquiryModal();
            });
          }

          // ìƒë‹¨ ì¡°ëª¨ì„/ë¯¸ë‹ˆê²Œì„ ë²„íŠ¼ ì´ë²¤íŠ¸
          const rankBtnDup = document.getElementById("rank-button-duplicate");
          if (rankBtnDup) {
            rankBtnDup.addEventListener("click", () => {
              document.getElementById("rank-modal").classList.remove("hidden");
              renderRankList();
            });
          }
          const minigameBtnDup = document.getElementById(
            "minigame-button-duplicate"
          );
          if (minigameBtnDup) {
            minigameBtnDup.addEventListener("click", () => {
              document
                .getElementById("minigame-modal")
                .classList.remove("hidden");
              showGameSelection();
            });
          }

          // ë¬¸ì˜ ëª¨ë‹¬ ë‹«ê¸°
          document
            .getElementById("inquiry-close")
            .addEventListener("click", () => {
              document.getElementById("inquiry-modal").classList.add("hidden");
            });
          // ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ ì¡°ëª¨ì„ ìˆœìœ„ì™€ ë¯¸ë‹ˆê²Œì„ ë²„íŠ¼ ì‘ë™
          if (currentUser) {
            document
              .getElementById("rank-button")
              .addEventListener("click", () => {
                document
                  .getElementById("rank-modal")
                  .classList.remove("hidden");
                renderRankList();
              });
            document
              .getElementById("minigame-button")
              .addEventListener("click", () => {
                document
                  .getElementById("minigame-modal")
                  .classList.remove("hidden");
                showGameSelection();
              });
          }
          document
            .getElementById("rank-close")
            .addEventListener("click", () => {
              document.getElementById("rank-modal").classList.add("hidden");
            });

          // ì¡°ëª¨ì„ ìˆœìœ„ ê´€ë¦¬ì ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          document
            .getElementById("rank-add-team")
            ?.addEventListener("click", () => {
              // ì¡°ëª¨ì„ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
              openGroupAddModal();
            });

          document
            .getElementById("rank-save-changes")
            ?.addEventListener("click", () => {
              // ì¡°ëª¨ì„ ìˆœìœ„ ë³€ê²½ì‚¬í•­ ì €ì¥
              saveGroupRankings();
            });

          document
            .getElementById("minigame-close")
            .addEventListener("click", () => {
              document.getElementById("minigame-modal").classList.add("hidden");
            });
          document
            .getElementById("h-roadmap-toggle-btn")
            .addEventListener("click", () => {
              roadmapShowAll = !roadmapShowAll;

              // ì…°ë¸Œë¡  ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜
              const chevron = document.getElementById("h-roadmap-chevron");
              if (chevron) {
                chevron.style.transform = roadmapShowAll
                  ? "rotate(180deg)"
                  : "rotate(0deg)";
              }

              smoothRender("h-roadmap-list", renderHorizontalRoadmap);
            });

          // ë¡œë“œë§µ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          const roadmapAddBtn = document.getElementById("h-roadmap-add-btn");
          if (roadmapAddBtn) {
            roadmapAddBtn.addEventListener("click", () => {
              openRoadmapAddModal();
            });
          }

          renderReservationTab(isAdmin); // ì‹ ì²­í•˜ê¸° íƒ­
          renderHistoryTab(isAdmin);
          renderRoadmapTab(isAdmin);
          renderSuggestionsTab(isAdmin);
          if (isFullAdmin()) renderDashboardTab(); // ìš´ì˜ì§„ ì œì™¸, ì„ì›ì§„ë§Œ ì ‘ê·¼ ê°€ëŠ¥

          // ì €ì¥ëœ íƒ­ìœ¼ë¡œ ë³µì›
          if (currentMainTab && currentMainTab !== "reservation") {
            setTimeout(() => {
              showTab(currentMainTab);
            }, 50);
          }

          // DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ë¡œë“œë§µ ë Œë”ë§
          setTimeout(() => {
            updateLoadingProgress(4, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
            renderHorizontalRoadmap();
            renderBlocks(); // ë¡œê·¸ì¸ ìƒíƒœì—ì„œë„ ë¸”ë¡ ë Œë”ë§
          }, 100);
          computeOnline();
          renderPresenceUI();
        } else {
          el.pre.classList.remove("hidden");
          el.main.classList.add("hidden");

          // ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìˆ¨ê¹€
          const logoutContainer = document.getElementById("logout-container");
          if (logoutContainer) {
            logoutContainer.innerHTML = "";
          }

          updateLoadingProgress(4, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” renderRoadmap() í˜¸ì¶œí•˜ì§€ ì•ŠìŒ (ë¸”ë¡ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
          renderBlocks();
          updateSignupUI();
          updateGameButtonsVisibility();
          // ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ ì¡°ëª¨ì„ ìˆœìœ„ì™€ ë¯¸ë‹ˆê²Œì„ ë²„íŠ¼ ì‘ë™
          if (currentUser) {
            document
              .getElementById("rank-button")
              .addEventListener("click", () => {
                document
                  .getElementById("rank-modal")
                  .classList.remove("hidden");
                renderRankList();
              });
            document
              .getElementById("minigame-button")
              .addEventListener("click", () => {
                document
                  .getElementById("minigame-modal")
                  .classList.remove("hidden");
                showGameSelection();
              });
          }
          document
            .getElementById("rank-close")
            .addEventListener("click", () => {
              document.getElementById("rank-modal").classList.add("hidden");
            });
          document
            .getElementById("minigame-close")
            .addEventListener("click", () => {
              document.getElementById("minigame-modal").classList.add("hidden");
            });
        }
      }
      const showTab = (name) => {
        currentMainTab = name; // í˜„ì¬ íƒ­ ì €ì¥
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`${name}-tab`)?.classList.add("active");
        document
          .querySelector(`.tab-btn[data-tab='${name}']`)
          ?.classList.add("active");
      };

      /* ===== íšŒì›ê°€ì… + íšŒë¹„ ì•ˆë‚´ ===== */
      function renderDuesInfoBox() {
        const d = duesSettings || {};
        const enabled = !!d.enabled;
        el.duesBox.classList.toggle("hidden", !enabled);
        if (!enabled) {
          el.duesBoxContent.innerHTML = "";
          return;
        }
        const lines = [];
        if (d.bank || d.number)
          lines.push(
            `<b>${saf(d.bank || "")} ${saf(d.number || "")}</b>${
              d.holder ? ` (ì˜ˆê¸ˆì£¼ ${saf(d.holder)})` : ""
            }`
          );
        if (d.amount) lines.push(`íšŒë¹„: <b>${formatKRW(d.amount)}</b>`);
        if (d.note)
          lines.push(
            `<span class="text-amber-700">${saf(d.note || "")}</span>`
          );
        el.duesBoxContent.innerHTML = lines.join("<br/>");
      }
      function openSignupModal() {
        if (!isSignupOpen())
          return showAlert("â›”", "í˜„ì¬ëŠ” íšŒì›ê°€ì… ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
        el.signupModal.classList.remove("hidden");
        document.getElementById("signupId").value = el.id.value.trim();
        document.getElementById("signupName").value = el.name.value.trim();
        renderDuesInfoBox();
      }
      const closeSignupModal = () => el.signupModal.classList.add("hidden");
      function openDuesModal() {
        const d = duesSettings || {};
        const body = [];
        if (d.amount)
          body.push(`<div>íšŒë¹„ ê¸ˆì•¡: <b>${formatKRW(d.amount)}</b></div>`);
        if (d.bank || d.number)
          body.push(
            `<div>ì…ê¸ˆ ê³„ì¢Œ: <b>${saf(d.bank || "")} ${saf(
              d.number || ""
            )}</b>${d.holder ? ` (ì˜ˆê¸ˆì£¼ ${saf(d.holder)})` : ""}</div>`
          );
        if (d.note)
          body.push(`<div class="text-gray-600">${saf(d.note)}</div>`);
        if (body.length === 0)
          body.push(
            `<div class="text-red-600">ê´€ë¦¬ìê°€ íšŒë¹„ ì •ë³´ë¥¼ ì•„ì§ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>`
          );
        el.duesModalBody.innerHTML = body.join("");
        el.duesModal.classList.remove("hidden");
      }
      async function confirmSignup(skipConfirm) {
        const sid = document.getElementById("signupId").value.trim();
        const nm = document.getElementById("signupName").value.trim();
        const gender = document.getElementById("signupGender").value.trim();
        const year = document.getElementById("signupYear").value.trim();
        const college = document.getElementById("signupCollege").value.trim();
        const dept = document.getElementById("signupDept").value.trim();
        const phone = document.getElementById("signupPhone").value.trim();
        if (!sid || !nm || !gender || !year || !college || !dept || !phone)
          return showAlert("ğŸ˜¥", "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if (!skipConfirm && duesSettings?.enabled) {
          openDuesModal();
          return;
        }
        if (!isSignupOpen())
          return showAlert("â›”", "í˜„ì¬ëŠ” íšŒì›ê°€ì… ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
        try {
          const mref = doc(db, "members", sid);
          const ms = await getDoc(mref);
          if (ms.exists()) {
            showAlert("â„¹ï¸", "ì´ë¯¸ ê°€ì…ëœ í•™ë²ˆì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
            closeSignupModal();
            el.id.value = sid;
            el.name.value = ms.data().name || nm;
            return;
          }
          await setDoc(mref, {
            studentId: sid,
            name: nm,
            gender,
            year,
            college,
            department: dept,
            phone,
            status: "pending",
            requestedAt: serverTimestamp(),
          });
          closeSignupModal();
          showAlert(
            "â³",
            "ê°€ì… ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤! <b>ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸°ì¤‘</b>ì…ë‹ˆë‹¤."
          );
          el.id.value = sid;
          el.name.value = nm;
        } catch (e) {
          console.warn(e);
          showAlert("ğŸ˜¥", "íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /* ===================== í™ˆ(ë¡œê·¸ì¸ ì „) ===================== */
      function attachAccordionHandlers(root) {
        root.querySelectorAll(".accordion-header").forEach((h) => {
          h.addEventListener("click", () => toggleAccordion(h));
        });
      }
      function toggleAccordion(header) {
        const item = header.closest(".accordion-item");
        item.classList.toggle("active");
      }

      // ê´€ë¦¬ììš© ë¸”ë¡ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìƒì„±
      function getBlockAdminButtons(block) {
        // ìš´ì˜ì§„ì€ ë¸”ë¡ ê´€ë¦¬ ë¶ˆê°€
        if (!isFullAdmin()) return "";

        // ê³µì§€ ë¸”ë¡ê³¼ Q&A ë¸”ë¡ì€ í•­ìƒ ë²„íŠ¼ í‘œì‹œ (ëª¨ë°”ì¼ ëŒ€ì‘)
        const opacityClass =
          block.type === "notice" || block.type === "qa"
            ? "opacity-100"
            : "opacity-0 group-hover:opacity-100";

        return `
          <div class="block-admin-controls absolute top-2 right-2 flex gap-1 ${opacityClass} transition-opacity z-10">
            <button class="move-block-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                    data-block-id="${block.id}" title="ìœ„ë¡œ ì´ë™">
              <i class="fas fa-arrow-up"></i>
            </button>
            <button class="move-block-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                    data-block-id="${block.id}" title="ì•„ë˜ë¡œ ì´ë™">
              <i class="fas fa-arrow-down"></i>
            </button>
            <button class="edit-block-inline bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                    data-id="${block.id}" data-type="${block.type}" title="ìˆ˜ì •">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-block-inline bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                    data-id="${block.id}" data-type="${block.type}" title="ì‚­ì œ">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      }

      function renderBlocks() {
        const isLoggedIn = !!currentUser;
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì ì ˆí•œ ì»¨í…Œì´ë„ˆ ì„ íƒ
        const wrap = isLoggedIn
          ? document.getElementById("main-dynamic-blocks")
          : document.getElementById("dynamic-blocks");

        if (!wrap) return;

        // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ë¸”ë¡ í•„í„°ë§
        const visible = (blocksData || []).filter((b) => {
          if (b.visible === false) return false;

          // showWhen ì„¤ì •ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì¡°ê±´ í™•ì¸
          if (b.showWhen) {
            if (b.showWhen === "login" && !isLoggedIn) return false;
            if (b.showWhen === "logout" && isLoggedIn) return false;
          }

          return true;
        });

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ìë™ìœ¼ë¡œ ì¼ì • ë¸”ë¡ ì¶”ê°€
        if (!isLoggedIn && roadmapData && roadmapData.length > 0) {
          const scheduleBlock = {
            id: "auto-schedule-block",
            type: "schedule",
            title: "FğŸ‘€die ì¼ì •",
            visible: true,
            showWhen: "logout",
            order: 1,
            isAuto: true,
          };
          visible.unshift(scheduleBlock);
        }
        const snippets = visible.map((b) => {
          if (b.type === "announcement") {
            // ê³µì§€ì‚¬í•­ ë¸”ë¡ í‘œì‹œ
            return `
              <div class="border rounded-lg p-3 md:p-4 bg-gradient-to-r from-blue-50 to-indigo-50 shadow-sm hover:shadow-md transition-shadow relative">
                <div class="flex flex-col sm:flex-row items-start gap-3">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                      <i class="fas fa-bullhorn text-white"></i>
                    </div>
                  </div>
                  <div class="flex-1 min-w-0 w-full">
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                      <h3 class="font-bold text-base md:text-lg text-blue-800 break-words">${saf(
                        b.title
                      )}</h3>
                      ${
                        b.isAuto
                          ? '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs flex-shrink-0">ìë™</span>'
                          : ""
                      }
                    </div>
                    <div class="text-sm md:text-base text-gray-700 whitespace-pre-wrap break-words">${saf(
                      b.content
                    )}</div>
                    <div class="text-xs text-gray-500 mt-2">
                      ${new Date(b.createdAt).toLocaleString("ko-KR")}
                    </div>
                  </div>
                </div>
              </div>
            `;
          } else if (b.type === "schedule") {
            // ì¼ì • ë¸”ë¡ í‘œì‹œ (ë¡œê·¸ì•„ì›ƒ ì „ìš©)
            if (!isLoggedIn && roadmapData && roadmapData.length > 0) {
              // ìš´ì˜ì§„ ì „ìš© ì¼ì • í•„í„°ë§ í›„ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
              const filteredData = roadmapData.filter((item) => {
                if (!item || typeof item !== "object" || !item.id) return false;
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ìš´ì˜ì§„ ì „ìš© ì¼ì • ìˆ¨ê¹€
                if (item.isAdminOnly) return false;
                return true;
              });

              const sorted = [...filteredData].sort((a, b) => {
                const dateA = parseDate(a.activityDate);
                const dateB = parseDate(b.activityDate);
                return dateA - dateB;
              });

              // ë‹¬ë ¥ í˜•íƒœë¡œ ë Œë”ë§ (ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì—†ìŒ)
              const calendarHTML = generateCalendar(
                new Date().getFullYear(),
                new Date().getMonth(),
                sorted,
                false, // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                false // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ
              );

              return `
                <div class="border rounded-lg p-3 md:p-4 bg-white shadow-sm hover:shadow-md transition-shadow relative">
                  <div class="flex flex-wrap items-center gap-2 mb-3">
                    <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
                      <i class="fas fa-calendar-alt text-white text-sm"></i>
                    </div>
                    <h3 class="font-bold text-base md:text-lg text-gray-800 break-words flex-1 min-w-0">${saf(
                      b.title
                    )}</h3>
                    ${
                      b.isAuto
                        ? '<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs flex-shrink-0">ìë™</span>'
                        : ""
                    }
                  </div>
                  <div class="schedule-content">
                    ${calendarHTML}
                  </div>
                </div>
              `;
            }
            return ""; // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
          } else if (b.type === "scores") {
            // ì ìˆ˜íŒ ë¸”ë¡ í‘œì‹œ
            const teams = b.payload?.teams || [];
            const sortedTeams = teams.sort(
              (a, b) => (b.score || 0) - (a.score || 0)
            );

            const teamsHTML = sortedTeams
              .map(
                (team, index) => `
              <div class="flex items-center justify-between p-2 md:p-3 bg-gradient-to-r from-orange-50 to-orange-100 border border-orange-200 rounded-lg">
                <div class="flex items-center gap-2 md:gap-3 flex-1 min-w-0">
                  <div class="flex items-center justify-center w-7 h-7 md:w-8 md:h-8 rounded-full text-white font-bold text-xs md:text-sm flex-shrink-0 ${
                    index === 0
                      ? "bg-yellow-500"
                      : index === 1
                      ? "bg-gray-400"
                      : index === 2
                      ? "bg-amber-600"
                      : "bg-orange-500"
                  }">
                    ${index + 1}
                  </div>
                  <div class="flex-1 min-w-0">
                    <span class="font-bold text-base md:text-lg text-gray-800 break-words block">${saf(
                      team.name
                    )}</span>
                    <div class="text-xs md:text-sm text-gray-600">${
                      team.score || 0
                    }ì </div>
                  </div>
                </div>
              </div>
            `
              )
              .join("");

            // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ - ìš´ì˜ì§„ ì œì™¸
            const isAdminForBlocks = isFullAdmin();

            return `
              <div class="border rounded-lg p-3 md:p-4 bg-white shadow-sm hover:shadow-md transition-shadow relative">
                ${
                  isAdminForBlocks
                    ? `
                  <div class="absolute top-2 right-2 flex gap-1 flex-wrap">
                    <button class="move-block-up score-block-move-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                            data-block-id="${b.id}" title="ìœ„ë¡œ ì´ë™">
                      <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="move-block-down score-block-move-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                            data-block-id="${b.id}" title="ì•„ë˜ë¡œ ì´ë™">
                      <i class="fas fa-arrow-down"></i>
                    </button>
                    <button class="edit-score-block-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                            data-block-id="${b.id}" title="ìˆ˜ì •">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-score-block-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                            data-block-id="${b.id}" title="ì‚­ì œ">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                `
                    : ""
                }
                <div class="flex justify-between items-start mb-3 pr-0 md:pr-0">
                  <h3 class="font-bold text-base md:text-lg text-gray-800 break-words pr-20">${saf(
                    b.title
                  )}</h3>
                </div>
                <div class="space-y-2">
                  ${
                    teamsHTML ||
                    '<p class="text-gray-400 text-center py-4 text-sm">íŒ€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                  }
                </div>
              </div>
            `;
          } else if (b.type === "qa") {
            const items = b.payload?.items || [];
            const html = items.length
              ? items
                  .map(
                    (it) =>
                      `<div class="border rounded p-3 md:p-4 bg-white hover:bg-gray-50 transition-colors">
                        <div class="font-semibold text-sm md:text-base text-gray-800 mb-2 whitespace-pre-wrap break-words">Q. ${saf(
                          it.q || "-"
                        )}</div>
                        <div class="text-sm md:text-base text-gray-600 mt-2 pl-3 md:pl-4 whitespace-pre-wrap leading-relaxed break-words">A. ${saf(
                          it.a || "-"
                        )}</div>
                      </div>`
                  )
                  .join("")
              : `<div class="text-gray-400 text-sm">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
            return `<div class="accordion-item section relative" data-block="${
              b.id
            }">
                      ${getBlockAdminButtons(b)}
                      <div class="accordion-header cursor-pointer p-3 md:p-4 lg:p-6">
                        <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 break-words pr-8"><i class="fas fa-question-circle mr-2 text-orange-500"></i>${saf(
                          b.title || "Q&A"
                        )}</h3>
                        <i class="fas fa-chevron-down text-gray-500"></i>
                      </div>
                      <div class="accordion-content"><div class="space-y-2">${html}</div></div>
                    </div>`;
          } else if (b.type === "notice") {
            const content = b.payload?.html || b.payload?.text || "";
            return `<div class="section accordion-item relative" data-block="${
              b.id
            }">
                      ${getBlockAdminButtons(b)}
                      <div class="accordion-header cursor-pointer flex items-center justify-between py-3 px-2 md:px-3 hover:bg-gray-50 transition-colors">
                        <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 flex items-center break-words flex-1 min-w-0 pr-2">
                          <i class="fas fa-bullhorn mr-2 text-orange-500 flex-shrink-0"></i><span class="break-words">${saf(
                            b.title || "ê³µì§€"
                          )}</span>
                        </h3>
                        <i class="fas fa-chevron-down accordion-icon transition-transform duration-300 text-gray-400 flex-shrink-0"></i>
                      </div>
                      <div class="accordion-content">
                        <div class="prose prose-sm max-w-none text-sm md:text-base text-gray-700 whitespace-pre-wrap break-words px-2 md:px-3 pb-3">${
                          content || "ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."
                        }</div>
                      </div>
                    </div>`;
          } else if (b.type === "roadmap") {
            // ë¡œë“œë§µ ë¸”ë¡ì˜ ì¼ì • ë°ì´í„° ì²˜ë¦¬
            const roadmapItems = b.payload?.items || [];
            const description = b.payload?.description || "";

            // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • ì§€ì› (í•˜ìœ„ í˜¸í™˜ì„±)
            if (!roadmapItems.length && b.payload?.date) {
              roadmapItems.push({
                title: b.title || "ì¼ì •",
                date: b.payload.date,
                description: b.payload.description || "",
              });
            }

            // ë¡œë“œë§µ ë¸”ë¡ ë‚´ì—ì„œ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
            const isAdminForRoadmap = currentUser; // ì„ì‹œë¡œ ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œ ë²„íŠ¼ í‘œì‹œ

            // ë””ë²„ê¹…ì„ ìœ„í•œ ì½˜ì†” ë¡œê·¸
            console.log("ë¡œë“œë§µ ë¸”ë¡ ê¶Œí•œ í™•ì¸:", {
              currentUser: currentUser?.name,
              position: currentUser?.position,
              studentId: currentUser?.studentId,
              isAdminList: adminList.includes(currentUser?.studentId),
              isAdminForRoadmap,
              roadmapItemsCount: roadmapItems.length,
              adminList: adminList,
            });

            return `<div class="accordion-item section relative" data-block="${
              b.id
            }">
                      ${getBlockAdminButtons(b)}
                      <div class="accordion-header cursor-pointer p-3 md:p-4 lg:p-6">
                        <div class="flex flex-col gap-2">
                          <div class="flex items-center justify-between w-full">
                            <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-700 break-words flex-1 min-w-0 pr-2"><i class="fas fa-map-signs mr-2 text-orange-500 flex-shrink-0"></i><span class="break-words">${saf(
                              b.title || "ë¡œë“œë§µ"
                            )}</span></h3>
                            <i class="fas fa-chevron-down text-gray-500 flex-shrink-0"></i>
                          </div>
                          ${
                            isAdminForRoadmap
                              ? `
                            <div class="flex gap-1 justify-start flex-wrap">
                              <button class="add-roadmap-item bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition-colors" 
                                      data-block-id="${b.id}" title="ìƒˆ ì¼ì • ì¶”ê°€">
                                <i class="fas fa-plus mr-1"></i>ì¼ì • ì¶”ê°€
                              </button>
                            </div>
                          `
                              : ""
                          }
                        </div>
                      </div>
                      <div class="accordion-content">
                        <div class="space-y-3">
                          ${
                            roadmapItems.length > 0
                              ? roadmapItems
                                  .map((item, index) => {
                                    const formattedDate = item.date
                                      ? new Date(item.date).toLocaleDateString(
                                          "ko-KR",
                                          {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                          }
                                        )
                                      : "ë‚ ì§œ ë¯¸ì •";

                                    return `
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 md:p-4">
                                      <div class="flex items-center justify-between mb-2 gap-2">
                                        <div class="flex items-center">
                                          <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                                          <span class="font-semibold text-blue-800">${saf(
                                            item.title || "ì¼ì •"
                                          )}</span>
                                        </div>
                                        ${
                                          isAdminForRoadmap
                                            ? `
                                          <div class="flex gap-1">
                                            <button class="edit-roadmap-item bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                                                    data-block-id="${b.id}" data-item-index="${index}" title="ì¼ì • ìˆ˜ì •">
                                              <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="delete-roadmap-item bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                                                    data-block-id="${b.id}" data-item-index="${index}" title="ì¼ì • ì‚­ì œ">
                                              <i class="fas fa-trash"></i>
                                            </button>
                                          </div>
                                        `
                                            : ""
                                        }
                                      </div>
                                      <p class="text-blue-700">${formattedDate}</p>
                                      ${
                                        item.description
                                          ? `<p class="text-blue-600 text-sm mt-2">${saf(
                                              item.description
                                            )}</p>`
                                          : ""
                                      }
                                    </div>
                                  `;
                                  })
                                  .join("")
                              : `
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center text-gray-500">
                                  <i class="fas fa-calendar-plus text-2xl mb-2"></i>
                                  <p>ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                  ${
                                    isAdminForRoadmap
                                      ? `<p class="text-sm mt-1">ì¼ì • ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>`
                                      : ""
                                  }
                                </div>
                              `
                          }
                          ${
                            description
                              ? `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                              <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                  <i class="fas fa-info-circle text-gray-500 mr-2"></i>
                                  <span class="font-semibold text-gray-800">ì„¤ëª…</span>
                                </div>
                                ${
                                  isAdminForRoadmap
                                    ? `
                                  <div class="flex gap-1">
                                    <button class="edit-roadmap-description bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                                            data-block-id="${b.id}" title="ì„¤ëª… ìˆ˜ì •">
                                      <i class="fas fa-edit"></i>
                                    </button>
                                  </div>
                                `
                                    : ""
                                }
                              </div>
                              <p class="text-gray-700 whitespace-pre-wrap">${saf(
                                description
                              )}</p>
                            </div>
                          `
                              : ""
                          }
                          ${
                            isAdminForRoadmap
                              ? `
                            <div class="text-center pt-2">
                              <button class="add-roadmap-item bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors" 
                                      data-block-id="${b.id}" title="ìƒˆ ì¼ì • ì¶”ê°€">
                                <i class="fas fa-plus mr-1"></i>ìƒˆ ì¼ì • ì¶”ê°€
                              </button>
                            </div>
                          `
                              : ""
                          }
                        </div>
                      </div>
                    </div>`;
          } else {
            const content = saf(b.payload?.html || b.payload?.text || "");
            return `<div class="section accordion-item" data-block="${b.id}">
                      <div class="accordion-header cursor-pointer flex items-center justify-between py-3 px-1 hover:bg-gray-50 transition-colors">
                        <h3 class="text-lg md:text-xl font-bold text-gray-700 flex items-center">
                          <i class="fas fa-info-circle mr-2 text-orange-500"></i>${saf(
                            b.title || "ë¸”ë¡"
                          )}
                        </h3>
                        <i class="fas fa-chevron-down accordion-icon transition-transform duration-300 text-gray-400"></i>
                      </div>
                      <div class="accordion-content">
                        <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap px-1 pb-3">${
                          content || "ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."
                        }</div>
                      </div>
                    </div>`;
          }
        });

        // ê´€ë¦¬ììš© ìƒˆ ë¸”ë¡ ìƒì„± ë²„íŠ¼ ì¶”ê°€
        let finalSnippets = snippets;
        // ìš´ì˜ì§„ì€ ë¸”ë¡ ì¶”ê°€ ë¶ˆê°€, ì„ì›ì§„ë§Œ ê°€ëŠ¥
        if (isFullAdmin()) {
          // ìƒˆ ê³µì§€ ì¶”ê°€ ë°•ìŠ¤ë¥¼ ë§¨ ì•ì— ë°°ì¹˜
          const addBlockPlaceholder = `
            <div class="add-block-placeholder border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-orange-400 hover:bg-orange-50 transition-colors cursor-pointer group" 
                 data-position="1" data-act="add-new-block">
              <div class="flex flex-col items-center justify-center space-y-2">
                <i class="fas fa-plus-circle text-2xl text-gray-400 group-hover:text-orange-500"></i>
                <span class="text-sm text-gray-500 group-hover:text-orange-600">ìƒˆ ê³µì§€ ì¶”ê°€</span>
              </div>
            </div>
          `;

          if (snippets.length > 0) {
            // ê¸°ì¡´ ë¸”ë¡ì´ ìˆìœ¼ë©´ ìƒˆ ê³µì§€ ì¶”ê°€ ë°•ìŠ¤ë¥¼ ë§¨ ì•ì— ë°°ì¹˜
            finalSnippets = [addBlockPlaceholder, ...snippets];
          } else {
            // ë¸”ë¡ì´ ì—†ì„ ë•Œ ì²« ë²ˆì§¸ ë¸”ë¡ ìƒì„± ë²„íŠ¼
            finalSnippets = [
              `
              <div class="add-block-placeholder border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-orange-400 hover:bg-orange-50 transition-colors cursor-pointer group" 
                   data-position="1" data-act="add-new-block">
                <div class="flex flex-col items-center justify-center space-y-4">
                  <i class="fas fa-plus-circle text-4xl text-gray-400 group-hover:text-orange-500"></i>
                  <span class="text-lg text-gray-500 group-hover:text-orange-600">ì²« ë²ˆì§¸ ê³µì§€ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</span>
                </div>
              </div>
              `,
            ];
          }
        }

        wrap.innerHTML = finalSnippets.length
          ? finalSnippets.join("")
          : `<div class="section text-center text-gray-400">í‘œì‹œí•  ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        attachAccordionHandlers(wrap);

        // ìƒˆ ë¸”ë¡ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (isAdmin) {
          // íšŒìƒ‰ ì ì„  ë¸”ë¡ ì „ì²´ í´ë¦­ ì´ë²¤íŠ¸
          wrap
            .querySelectorAll(".add-block-placeholder")
            .forEach((placeholder) => {
              placeholder.addEventListener("click", (e) => {
                e.stopPropagation();
                const position = parseInt(placeholder.dataset.position) || 1;
                // ë¸”ë¡ íƒ€ì… ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
                openBlockModal(null, null, position);
              });
            });

          wrap.querySelectorAll(".add-block-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const position = parseInt(btn.dataset.position);
              // ë¸”ë¡ íƒ€ì… ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
              openBlockModal(null, null, position);
            });
          });

          // ì¸ë¼ì¸ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          wrap.querySelectorAll(".edit-block-inline").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.id;
              const blockType = btn.dataset.type;
              openBlockModal(blockType, blockId);
            });
          });

          wrap.querySelectorAll(".delete-block-inline").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.id;
              const blockType = btn.dataset.type;

              if (
                confirm(
                  `${getBlockTypeName(blockType)} ë¸”ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                )
              ) {
                try {
                  await deleteDoc(doc(db, "homepageBlocks", blockId));
                  showAlert("âœ…", "ë¸”ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                  console.error("ë¸”ë¡ ì‚­ì œ ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ë¸”ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });
          });

          // ì ìˆ˜íŒ ë¸”ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          wrap.querySelectorAll(".edit-score-block-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openBlockModal("scores", blockId);
            });
          });

          // ì ìˆ˜íŒ ë¸”ë¡ ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          wrap.querySelectorAll(".score-block-move-up").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              console.log("ì ìˆ˜íŒ ë¸”ë¡ ìœ„ë¡œ ì´ë™ ë²„íŠ¼ í´ë¦­:", blockId);
              await moveBlockUp(blockId);
            });
          });

          wrap.querySelectorAll(".score-block-move-down").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              console.log("ì ìˆ˜íŒ ë¸”ë¡ ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼ í´ë¦­:", blockId);
              await moveBlockDown(blockId);
            });
          });

          wrap.querySelectorAll(".delete-score-block-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              if (!confirm("ì ìˆ˜íŒ ë¸”ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

              try {
                await deleteDoc(doc(db, "homepageBlocks", blockId));
                showAlert("âœ…", "ì ìˆ˜íŒ ë¸”ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              } catch (error) {
                console.error("ì ìˆ˜íŒ ë¸”ë¡ ì‚­ì œ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "ì ìˆ˜íŒ ë¸”ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            });
          });

          // ì¼ë°˜ ë¸”ë¡(ê³µì§€, Q&A ë“±) ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          wrap
            .querySelectorAll(".move-block-up:not(.score-block-move-up)")
            .forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                e.stopPropagation();
                const blockId = btn.dataset.blockId;
                console.log("ì¼ë°˜ ë¸”ë¡ ìœ„ë¡œ ì´ë™ ë²„íŠ¼ í´ë¦­:", blockId);
                await moveBlockUp(blockId);
              });
            });

          wrap
            .querySelectorAll(".move-block-down:not(.score-block-move-down)")
            .forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                e.stopPropagation();
                const blockId = btn.dataset.blockId;
                console.log("ì¼ë°˜ ë¸”ë¡ ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼ í´ë¦­:", blockId);
                await moveBlockDown(blockId);
              });
            });

          // ë¡œë“œë§µ ë¸”ë¡ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í—¤ë”ì™€ ì½˜í…ì¸  ëª¨ë‘)
          wrap.querySelectorAll(".edit-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              const itemIndex = parseInt(btn.dataset.itemIndex);
              openRoadmapItemEditModal(blockId, itemIndex);
            });
          });

          wrap.querySelectorAll(".delete-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              const itemIndex = parseInt(btn.dataset.itemIndex);

              if (confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteRoadmapItem(blockId, itemIndex);
                showAlert("âœ…", "ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderBlocks(); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              }
            });
          });

          wrap.querySelectorAll(".edit-roadmap-description").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openRoadmapDescriptionEditModal(blockId);
            });
          });

          wrap.querySelectorAll(".add-roadmap-item").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const blockId = btn.dataset.blockId;
              openRoadmapItemAddModal(blockId);
            });
          });
        }
      }

      // ë¡œë“œë§µ ì¼ì • ìˆ˜ì • ëª¨ë‹¬
      function openRoadmapItemEditModal(blockId, itemIndex) {
        const block = blocksData.find((b) => b.id === blockId);
        if (!block) return;

        // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ì—ì„œ í•´ë‹¹ ì¼ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const items = block.payload?.items || [];
        let itemData = null;

        if (items.length > 0 && itemIndex >= 0 && itemIndex < items.length) {
          // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°
          itemData = items[itemIndex];
        } else if (block.payload?.date) {
          // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • êµ¬ì¡°
          itemData = {
            title: block.title || "",
            date: block.payload.date,
            description: block.payload.description || "",
          };
        }

        if (!itemData) {
          showAlert("ğŸ˜¥", "ì¼ì • ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const modalHTML = `
          <div id="roadmap-item-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">ë¡œë“œë§µ ì¼ì • ìˆ˜ì •</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                  <input id="roadmap-item-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${saf(
                    itemData.title || ""
                  )}" placeholder="ì¼ì • ì œëª©">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                  <input id="roadmap-item-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${
                    itemData.date || ""
                  }">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                  <textarea id="roadmap-item-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="ì„¤ëª…">${saf(
                    itemData.description || ""
                  )}</textarea>
                </div>
                <input id="roadmap-item-block-id" type="hidden" value="${blockId}">
                <input id="roadmap-item-index" type="hidden" value="${itemIndex}">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-item-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>ì €ì¥
                </button>
                <button id="roadmap-item-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          </div>
        `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById(
          "roadmap-item-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-item-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-item-block-id"
            ).value;
            const itemIndex = parseInt(
              document.getElementById("roadmap-item-index").value
            );
            const title = document
              .getElementById("roadmap-item-title")
              .value.trim();
            const date = document.getElementById("roadmap-item-date").value;
            const description = document
              .getElementById("roadmap-item-description")
              .value.trim();

            if (!title) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            await updateRoadmapItem(
              blockId,
              itemIndex,
              title,
              date,
              description
            );
            showAlert("âœ…", "ë¡œë“œë§µ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("roadmap-item-edit-modal").remove();
            smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          });

        document
          .getElementById("roadmap-item-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-item-edit-modal").remove();
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("roadmap-item-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-item-edit-modal") {
              document.getElementById("roadmap-item-edit-modal").remove();
            }
          });
      }

      // ë¡œë“œë§µ ì„¤ëª… ìˆ˜ì • ëª¨ë‹¬
      function openRoadmapDescriptionEditModal(blockId) {
        const block = blocksData.find((b) => b.id === blockId);
        if (!block) return;

        const description = block.payload?.description || "";

        const modalHTML = `
          <div id="roadmap-description-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">ë¡œë“œë§µ ì„¤ëª… ìˆ˜ì •</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                  <textarea id="roadmap-description-text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="4" placeholder="ì„¤ëª…">${saf(
                    description
                  )}</textarea>
                </div>
                <input id="roadmap-description-block-id" type="hidden" value="${blockId}">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-description-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>ì €ì¥
                </button>
                <button id="roadmap-description-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          </div>
        `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById(
          "roadmap-description-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-description-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-description-block-id"
            ).value;
            const description = document
              .getElementById("roadmap-description-text")
              .value.trim();

            await updateRoadmapDescription(blockId, description);
            showAlert("âœ…", "ë¡œë“œë§µ ì„¤ëª…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("roadmap-description-edit-modal").remove();
            renderBlocks(); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          });

        document
          .getElementById("roadmap-description-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-description-edit-modal").remove();
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("roadmap-description-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-description-edit-modal") {
              document
                .getElementById("roadmap-description-edit-modal")
                .remove();
            }
          });
      }

      // ë¡œë“œë§µ ì¼ì • ì¶”ê°€ ëª¨ë‹¬
      function openRoadmapItemAddModal(blockId) {
        const modalHTML = `
          <div id="roadmap-item-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">ìƒˆ ë¡œë“œë§µ ì¼ì • ì¶”ê°€</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                  <input id="roadmap-add-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì¼ì • ì œëª©">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                  <input id="roadmap-add-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                  <textarea id="roadmap-add-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="ì„¤ëª…"></textarea>
                </div>
                <input id="roadmap-add-block-id" type="hidden" value="${blockId}">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-plus mr-2"></i>ì¶”ê°€
                </button>
                <button id="roadmap-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          </div>
        `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById("roadmap-item-add-modal");
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-add-save")
          .addEventListener("click", async () => {
            const blockId = document.getElementById(
              "roadmap-add-block-id"
            ).value;
            const title = document
              .getElementById("roadmap-add-title")
              .value.trim();
            const date = document.getElementById("roadmap-add-date").value;
            const description = document
              .getElementById("roadmap-add-description")
              .value.trim();

            if (!title) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (!date) {
              showAlert("ğŸ˜¥", "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            await addRoadmapItem(blockId, title, date, description);
            showAlert("âœ…", "ìƒˆ ë¡œë“œë§µ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("roadmap-item-add-modal").remove();
            renderBlocks(); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          });

        document
          .getElementById("roadmap-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-item-add-modal").remove();
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("roadmap-item-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-item-add-modal") {
              document.getElementById("roadmap-item-add-modal").remove();
            }
          });
      }

      // ë¡œë“œë§µ ë¸”ë¡ ì—…ë°ì´íŠ¸
      async function updateRoadmapBlock(blockId, title, date, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        await updateDoc(blockRef, {
          title: title,
          payload: {
            date: date,
            description: description,
          },
        });
      }

      // ë¡œë“œë§µ ì„¤ëª… ì—…ë°ì´íŠ¸
      async function updateRoadmapDescription(blockId, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const block = blocksData.find((b) => b.id === blockId);
        await updateDoc(blockRef, {
          payload: {
            ...block.payload,
            description: description,
          },
        });
      }

      // ë¡œë“œë§µ ì¼ì • ì‚­ì œ (ë‹¤ì¤‘ ì¼ì • ì§€ì›)
      async function deleteRoadmapItem(blockId, itemIndex) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • êµ¬ì¡°ì¸ ê²½ìš° ì „ì²´ ë¸”ë¡ ì‚­ì œ
        if (items.length === 0 && blockData.payload?.date) {
          await deleteDoc(blockRef);
          return;
        }

        // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ì¸ ê²½ìš° í•´ë‹¹ ì¼ì •ë§Œ ì‚­ì œ
        if (itemIndex >= 0 && itemIndex < items.length) {
          items.splice(itemIndex, 1);

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: items,
            },
          });
        }
      }

      // ë¡œë“œë§µ ì¼ì • ì¶”ê°€ (ë‹¤ì¤‘ ì¼ì • ì§€ì›)
      async function addRoadmapItem(blockId, title, date, description) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • êµ¬ì¡°ë¥¼ ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ë¡œ ë³€í™˜
        if (items.length === 0 && blockData.payload?.date) {
          const existingItem = {
            title: blockData.title || "ê¸°ì¡´ ì¼ì •",
            date: blockData.payload.date,
            description: blockData.payload.description || "",
          };

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: [
                existingItem,
                {
                  title: title,
                  date: date,
                  description: description,
                },
              ],
            },
          });
        } else {
          // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ì— ìƒˆ ì¼ì • ì¶”ê°€
          const newItem = {
            title: title,
            date: date,
            description: description,
          };

          await updateDoc(blockRef, {
            payload: {
              ...blockData.payload,
              items: [...items, newItem],
            },
          });
        }
      }

      // ë¡œë“œë§µ ì¼ì • ìˆ˜ì • (ë‹¤ì¤‘ ì¼ì • ì§€ì›)
      async function updateRoadmapItem(
        blockId,
        itemIndex,
        title,
        date,
        description
      ) {
        const blockRef = doc(db, "homepageBlocks", blockId);
        const blockDoc = await getDoc(blockRef);

        if (!blockDoc.exists()) {
          throw new Error("ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const blockData = blockDoc.data();
        const items = blockData.payload?.items || [];

        // ê¸°ì¡´ ë‹¨ì¼ ì¼ì • êµ¬ì¡°ì¸ ê²½ìš°
        if (items.length === 0 && blockData.payload?.date) {
          await updateDoc(blockRef, {
            title: title,
            payload: {
              ...blockData.payload,
              date: date,
              description: description,
            },
          });
        } else {
          // ë‹¤ì¤‘ ì¼ì • êµ¬ì¡°ì¸ ê²½ìš°
          if (itemIndex >= 0 && itemIndex < items.length) {
            items[itemIndex] = {
              title: title,
              date: date,
              description: description,
            };

            await updateDoc(blockRef, {
              payload: {
                ...blockData.payload,
                items: items,
              },
            });
          }
        }
      }

      function renderRoadmap() {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì•„ë¬´ê²ƒë„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ (ë¸”ë¡ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
        if (!currentUser) {
          console.log("renderRoadmap: ë¡œê·¸ì•„ì›ƒ ìƒíƒœ - ë Œë”ë§í•˜ì§€ ì•ŠìŒ");
          return;
        }

        const c = document.getElementById("roadmap-container");
        const btn = document.getElementById("roadmap-toggle-btn");
        if (!c) return;
        const total = roadmapData.length;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // order ìš°ì„  â†’ ë‚ ì§œ(ì˜¤ë¦„ì°¨ìˆœ)
        const sorted = [...roadmapData].sort((a, b) => {
          const ao = a.order ?? 999999,
            bo = b.order ?? 999999;
          if (ao !== bo) return ao - bo;
          return (a.activityDate || "").localeCompare(b.activityDate || "");
        });

        const enriched = sorted.map((item) => {
          const d = parseDate(item.activityDate);
          let status = "upcoming";
          if (d < today) status = "completed";
          else if (d.toDateString() === today.toDateString()) status = "today";
          return { ...item, _date: d, _status: status };
        });
        let itemsToShow = enriched;
        if (!roadmapShowAll) {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ: ëë‚œ ì¼ì • 1ê°œ + ì•ìœ¼ë¡œ ìˆì„ ì¼ì • 3ê°œ
          if (!currentUser) {
            const completed = enriched.filter((x) => x._status === "completed");
            const upcoming = enriched.filter((x) => x._status !== "completed");

            // ì™„ë£Œëœ ì¼ì •ì„ ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ ìµœê·¼ ê²ƒ ì„ íƒ
            const sortedCompleted = completed.sort((a, b) => b._date - a._date);
            const latestCompleted =
              sortedCompleted.length > 0 ? [sortedCompleted[0]] : [];

            // ì•ìœ¼ë¡œ ìˆì„ ì¼ì • ì¤‘ ìµœëŒ€ 3ê°œë§Œ ì„ íƒ
            const upcomingLimited = upcoming.slice(0, 3);

            itemsToShow = [...latestCompleted, ...upcomingLimited];
          } else {
            // ë¡œê·¸ì¸ ìƒíƒœ: ìµœê·¼ ëë‚œ ì¼ì • 1ê°œ + ì•ìœ¼ë¡œ ì˜¬ ì¼ì •ë“¤ë§Œ í‘œì‹œ
            const completed = enriched.filter((x) => x._status === "completed");
            const upcoming = enriched.filter((x) => x._status !== "completed");

            // ì™„ë£Œëœ ì¼ì •ì„ ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ ìµœê·¼ ê²ƒ ì„ íƒ
            const sortedCompleted = completed.sort((a, b) => b._date - a._date);
            const latestCompleted =
              sortedCompleted.length > 0 ? [sortedCompleted[0]] : [];

            itemsToShow = [...latestCompleted, ...upcoming];
          }
        }
        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ - ìš´ì˜ì§„ ì œì™¸, ì„ì›ì§„ë§Œ ê°€ëŠ¥
        const isAdminForRoadmap = isFullAdmin();

        console.log("ë¡œë“œë§µ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸:", {
          currentUser: currentUser?.name,
          isAdminForRoadmap,
          roadmapDataLength: roadmapData.length,
        });

        // ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ í‘œì‹œ/ìˆ¨ê¹€
        const adminControls = document.getElementById("roadmap-admin-controls");
        console.log("ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ ìš”ì†Œ:", adminControls);

        if (adminControls) {
          if (isAdminForRoadmap) {
            adminControls.classList.remove("hidden");
            console.log("ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ í‘œì‹œë¨");
          } else {
            adminControls.classList.add("hidden");
            console.log("ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ë¨");
          }
        } else {
          console.error("roadmap-admin-controls ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        }

        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ë¡œë“œë§µì„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ (ë¸”ë¡ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
        if (!currentUser) {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì•„ë¬´ê²ƒë„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
          c.innerHTML = "";
        } else {
          // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ í˜•íƒœ ìœ ì§€
          c.innerHTML =
            total === 0
              ? `<p class="text-gray-400 text-center py-4">ì˜ˆì •ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤. íšŒì¥ë‹˜ì´ ê³§ ì¼ì •ì„ ì¶”ê°€í•  ê±°ì˜ˆìš”!</p>`
              : itemsToShow
                  .map(
                    (item, index) => `<div class="v-item ${
                      item._status
                    } relative">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="font-bold text-gray-800">${saf(
                      item.activityName
                    )}</div>
                    <div class="text-sm text-gray-500">${item._date.toLocaleDateString(
                      "ko-KR"
                    )}</div>
                  </div>
                  ${
                    isAdminForRoadmap
                      ? `
                    <div class="flex gap-1 ml-2">
                      <button class="edit-roadmap-event bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                              data-event-id="${item.id}" data-event-index="${index}" title="ì¼ì • ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="delete-roadmap-event bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                              data-event-id="${item.id}" data-event-index="${index}" title="ì¼ì • ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  `
                      : ""
                  }
                </div>
              </div>`
                  )
                  .join("");
        }
        if (btn) {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” í•­ìƒ ë²„íŠ¼ ìˆ¨ê¹€ (ì´ë¯¸ ë‹¬ë ¥ í˜•íƒœë¡œ í‘œì‹œë˜ë¯€ë¡œ)
          if (!currentUser) {
            btn.classList.add("hidden");
          } else {
            // ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€
            const shouldShowButton = total > 4;
            if (shouldShowButton) {
              btn.classList.remove("hidden");
              const textElement = btn.querySelector("#roadmap-toggle-text");
              if (textElement) {
                textElement.textContent = roadmapShowAll
                  ? "ê°„ë‹¨íˆ ë³´ê¸°"
                  : "ìº˜ë¦°ë”";
              }
              btn.onclick = () => {
                roadmapShowAll = !roadmapShowAll;
                renderRoadmap();
              };
            } else {
              btn.classList.add("hidden");
            }
          }
        }

        // ë¡œë“œë§µ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (isAdminForRoadmap) {
          // ì¼ì • ì¶”ê°€ ë²„íŠ¼
          const addBtn = document.getElementById("add-roadmap-event");
          if (addBtn) {
            addBtn.onclick = () => {
              openRoadmapEventAddModal();
            };
          }

          // ì¼ì • ìˆ˜ì • ë²„íŠ¼ë“¤
          document.querySelectorAll(".edit-roadmap-event").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const eventId = btn.dataset.eventId;
              const eventIndex = parseInt(btn.dataset.eventIndex);
              openRoadmapEventEditModal(eventId, eventIndex);
            });
          });

          // ì¼ì • ì‚­ì œ ë²„íŠ¼ë“¤
          document.querySelectorAll(".delete-roadmap-event").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const eventId = btn.dataset.eventId;
              const eventIndex = parseInt(btn.dataset.eventIndex);

              if (confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                try {
                  await deleteDoc(doc(db, "roadmap", eventId));
                  showAlert("âœ…", "ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  renderRoadmap();
                } catch (error) {
                  console.error("ì¼ì • ì‚­ì œ ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });
          });
        }
      }

      // ë¡œë“œë§µ ì¼ì • ì¶”ê°€ ëª¨ë‹¬
      function openRoadmapEventAddModal() {
        const modalHTML = `
          <div id="roadmap-event-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">ë¡œë“œë§µ ì¼ì • ì¶”ê°€</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                  <input id="roadmap-event-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì¼ì • ì œëª©">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                  <input id="roadmap-event-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-event-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>ì¶”ê°€
                </button>
                <button id="roadmap-event-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          </div>
        `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById(
          "roadmap-event-add-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-event-add-save")
          .addEventListener("click", async () => {
            const name = document
              .getElementById("roadmap-event-name")
              .value.trim();
            const date = document.getElementById("roadmap-event-date").value;

            if (!name) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (!date) {
              showAlert("ğŸ˜¥", "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              const ord = roadmapData?.length || 0;
              await addDoc(collection(db, "roadmap"), {
                activityName: name,
                activityDate: date,
                order: ord,
              });
              showAlert("âœ…", "ë¡œë“œë§µ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document.getElementById("roadmap-event-add-modal").remove();
              renderRoadmap();
            } catch (error) {
              console.error("ì¼ì • ì¶”ê°€ ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });

        document
          .getElementById("roadmap-event-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-event-add-modal").remove();
          });
      }

      // ë¡œë“œë§µ ì¼ì • ìˆ˜ì • ëª¨ë‹¬
      window.openRoadmapEventEditModal = function (eventId, eventIndex) {
        const event = roadmapData.find((e) => e.id === eventId);
        if (!event) return;

        const modalHTML = `
          <div id="roadmap-event-edit-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">ë¡œë“œë§µ ì¼ì • ìˆ˜ì •</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                  <input id="roadmap-event-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${saf(
                    event.activityName
                  )}" placeholder="ì¼ì • ì œëª©">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                  <input id="roadmap-event-edit-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" value="${
                    event.activityDate
                  }">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                  <textarea id="roadmap-event-edit-description" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì¼ì • ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤">${saf(
                    event.description || ""
                  )}</textarea>
                  <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Enter í‚¤ë¡œ ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                </div>
                <input id="roadmap-event-edit-id" type="hidden" value="${eventId}">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="roadmap-event-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>ìˆ˜ì •
                </button>
                <button id="roadmap-event-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          </div>
        `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById(
          "roadmap-event-edit-modal"
        );
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-event-edit-save")
          .addEventListener("click", async () => {
            const eventId = document.getElementById(
              "roadmap-event-edit-id"
            ).value;
            const name = document
              .getElementById("roadmap-event-edit-name")
              .value.trim();
            const date = document.getElementById(
              "roadmap-event-edit-date"
            ).value;
            const description = document.getElementById(
              "roadmap-event-edit-description"
            ).value;

            if (!name) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (!date) {
              showAlert("ğŸ˜¥", "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              console.log("ë¡œë“œë§µ ìˆ˜ì • ì‹œë„:", {
                eventId,
                name,
                date,
                description,
              });
              console.log("í˜„ì¬ roadmapData:", roadmapData);
              console.log(
                "ì°¾ìœ¼ë ¤ëŠ” ì´ë²¤íŠ¸:",
                roadmapData.find((e) => e.id === eventId)
              );

              // ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
              const docRef = doc(db, "roadmap", eventId);
              const docSnap = await getDoc(docRef);

              console.log("ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€:", docSnap.exists());
              console.log(
                "ë¬¸ì„œ ë°ì´í„°:",
                docSnap.exists() ? docSnap.data() : "ë¬¸ì„œ ì—†ìŒ"
              );

              if (!docSnap.exists()) {
                showAlert("ğŸ˜¥", "ìˆ˜ì •í•˜ë ¤ëŠ” ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
              }

              await updateDoc(docRef, {
                activityName: name,
                activityDate: date,
                description: description,
              });
              showAlert("âœ…", "ë¡œë“œë§µ ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document.getElementById("roadmap-event-edit-modal").remove();
              // ìˆ˜ì • í›„ ë¡œë“œë§µ ìƒˆë¡œê³ ì¹¨ (onSnapshotìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸ë¨)
            } catch (error) {
              console.error("ì¼ì • ìˆ˜ì • ì˜¤ë¥˜:", error);
              if (error.code === "not-found") {
                showAlert("ğŸ˜¥", "ìˆ˜ì •í•˜ë ¤ëŠ” ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              } else {
                showAlert("ğŸ˜¥", "ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            }
          });

        document
          .getElementById("roadmap-event-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-event-edit-modal").remove();
          });
      };

      /* ===================== ì‹ ì²­ íƒ­ ===================== */
      function computeEventStats(ev) {
        const getAll = () => {
          if (ev.type === "tasting") {
            const arr = [];
            (ev.restaurants || []).forEach((r) => {
              arr.push(...(r.reservations || []), ...(r.waiting || []));
            });
            return arr;
          }
          return [...(ev.applicants || []), ...(ev.waiting || [])];
        };
        const all = getAll();
        const stats = all.map((p) => ({
          gender: p.gender || "ë¯¸ìƒ",
          college: p.college || "ë¯¸ìƒ",
        }));
        const total = stats.length;
        const genderCount = { ë‚¨: 0, ì—¬: 0, ê¸°íƒ€: 0, ë¯¸ìƒ: 0 };
        stats.forEach((s) => {
          if (genderCount[s.gender] == null) genderCount["ë¯¸ìƒ"]++;
          else genderCount[s.gender]++;
        });
        const genderPct = Object.fromEntries(
          Object.entries(genderCount).map(([k, v]) => [
            k,
            total ? Math.round((v / total) * 1000) / 10 : 0,
          ])
        );
        const collegeMap = new Map();
        stats.forEach((s) => {
          const key = s.college || "ë¯¸ìƒ";
          collegeMap.set(key, (collegeMap.get(key) || 0) + 1);
        });
        const colleges = [...collegeMap.entries()]
          .map(([name, cnt]) => ({
            name,
            cnt,
            pct: total ? Math.round((cnt / total) * 1000) / 10 : 0,
          }))
          .sort((a, b) => b.cnt - a.cnt);
        return { total, genderPct, colleges };
      }
      function adminStatsHTML(ev) {
        if (!isFullAdmin()) return "";
        const st = computeEventStats(ev);
        const gLine =
          st.total > 0
            ? `ë‚¨ ${st.genderPct.ë‚¨}% Â· ì—¬ ${st.genderPct.ì—¬}%${
                st.genderPct.ê¸°íƒ€ ? ` Â· ê¸°íƒ€ ${st.genderPct.ê¸°íƒ€}%` : ""
              }`
            : "ìë£Œ ì—†ìŒ";
        const colleges =
          st.colleges
            .slice(0, 5)
            .map((c) => `${saf(c.name)} ${c.pct}%`)
            .join(" Â· ") || "ìë£Œ ì—†ìŒ";
        return `<div class="mt-3 text-xs bg-gray-50 border rounded p-2">
                 <div class="font-semibold text-gray-700">ê´€ë¦¬ììš© ì‹ ì²­ì í†µê³„ <span class="text-[11px] text-gray-500">(ì‹ ì²­+ëŒ€ê¸° í¬í•¨)</span></div>
                 <div class="mt-1 text-gray-700">ì„±ë³„: ${gLine}</div>
                 <div class="mt-1 text-gray-700">ë‹¨ê³¼ëŒ€ ìƒìœ„: ${colleges}</div>
               </div>`;
      }
      const adminInline = (ev) => {
        if (!isFullAdmin()) return "";
        return `<div class="mt-3 flex gap-2 flex-wrap">
                  <button type="button" class="text-blue-600 hover:text-blue-800 text-sm" data-act="admin-edit" data-id="${ev.id}"><i class="fas fa-pen"></i> ìˆ˜ì •</button>
                  <button type="button" class="text-red-600 hover:text-red-800 text-sm font-semibold" data-act="admin-close" data-id="${ev.id}"><i class="fas fa-door-closed"></i> ì‹ ì²­ ë§ˆê°</button>
                  <button type="button" class="text-purple-600 hover:text-purple-800 text-sm" data-act="group-maker" data-id="${ev.id}"><i class="fas fa-users"></i> ì¡°ì§œê¸°</button>
                  <button type="button" class="text-orange-700 hover:text-orange-900 text-sm" data-act="export-xlsx" data-id="${ev.id}"><i class="fas fa-file-excel"></i> ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ</button>
                  <button type="button" class="text-red-600 hover:text-red-800 text-sm" data-act="admin-delete" data-id="${ev.id}"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                </div>
                <div class="absolute top-2 right-2 flex gap-1">
                  <button type="button" class="move-event-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                          data-act="move-event-up" data-id="${ev.id}" title="ìœ„ë¡œ ì´ë™">
                    <i class="fas fa-arrow-up"></i>
                  </button>
                  <button type="button" class="move-event-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                          data-act="move-event-down" data-id="${ev.id}" title="ì•„ë˜ë¡œ ì´ë™">
                    <i class="fas fa-arrow-down"></i>
                  </button>
                </div>`;
      };
      function paymentInfoHTML(ev) {
        if (!(ev.type === "mt" || ev.type === "assembly")) return "";
        const p = ev.payment || {};
        if (!p.bank && !p.number && !p.holder && !p.note) return "";
        const line = [p.bank, p.number].filter(Boolean).map(saf).join(" ");
        return `<div class="mt-2 text-sm bg-orange-50 border border-orange-200 rounded p-2">
                  <div class="font-semibold text-orange-800">ğŸ’¸ íšŒë¹„ ì…ê¸ˆ ì •ë³´</div>
                  <div class="text-orange-700">${line || ""}${
          p.holder ? ` (ì˜ˆê¸ˆì£¼ ${saf(p.holder)})` : ""
        }</div>
                  ${
                    p.note
                      ? `<div class="text-orange-700">${saf(p.note)}</div>`
                      : ""
                  }
                </div>`;
      }

      // ì‹ ì²­ ì·¨ì†Œ ì•ˆë‚´ ë¬¸êµ¬ (ê³µí†µ)
      const getCancelNotice = () => `
        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-start gap-2">
            <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
            <div class="text-xs text-blue-800">
              <p class="font-semibold mb-1">ğŸ“Œ ì·¨ì†Œ ì•ˆë‚´</p>
              <p>â€¢ ì‹ ì²­ ì·¨ì†Œë¥¼ ì›í•˜ì‹œë©´ <strong>ë§ˆê° ì‹œê°„ ì „</strong>ì— ì‹ ì²­ ì·¨ì†Œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
              <p class="mt-1">â€¢ ë§ˆê° ì´í›„ ì·¨ì†Œë¥¼ ì›í•˜ì‹œë©´ <strong>ìš´ì˜ì§„ì—ê²Œ ë¬¸ì˜</strong>í•´ì£¼ì„¸ìš”.</p>
            </div>
          </div>
        </div>
      `;

      function generalCardHTML(ev) {
        const count = (ev.applicants || []).length,
          lim = ev.limit || 0;
        const my = isUserIn(ev.applicants)
          ? "apply"
          : isUserIn(ev.waiting)
          ? "wait"
          : "none";

        // ë””ë²„ê¹…: ì‚¬ìš©ì ìƒíƒœ í™•ì¸
        console.log(`Event ${ev.id}: currentUser =`, currentUser);
        console.log(
          `Event ${ev.id}: my = ${my}, count = ${count}, lim = ${lim}`
        );

        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì—ê²Œë§Œ ë²„íŠ¼ í‘œì‹œ
        let btn;
        if (currentUser) {
          if (my === "apply") {
            btn = `<button type="button" class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer" data-act="cancel-general" data-id="${ev.id}">ì‹ ì²­ ì·¨ì†Œ</button>`;
          } else if (my === "wait") {
            btn = `<button type="button" class="w-full mt-3 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer" data-act="cancel-wait-general" data-id="${ev.id}">ëŒ€ê¸° ì·¨ì†Œ</button>`;
          } else {
            btn = `<button type="button" class="w-full mt-3 ${
              count < lim
                ? "bg-orange-600 hover:bg-orange-700"
                : "bg-red-600 hover:bg-red-700"
            } text-white font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer flex items-center justify-center gap-2" data-act="reserve-general" data-id="${
              ev.id
            }">
              ${
                count < lim
                  ? '<i class="fas fa-check"></i><span>ì‹ ì²­í•˜ê¸°</span>'
                  : '<i class="fas fa-clock"></i><span>ì‹ ì²­ ë§ˆê° / ëŒ€ê¸°í•˜ê¸°</span>'
              }
            </button>`;
          }
        } else {
          btn = `<div class="w-full mt-3 bg-gray-100 text-gray-500 font-bold py-2 rounded text-center">ë¡œê·¸ì¸ í›„ ì‹ ì²­ ê°€ëŠ¥</div>`;
        }

        // í•™ë²ˆ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
        const maskStudentId = (studentId) => {
          if (!studentId) return "";
          if (studentId.length <= 4) return studentId;
          return studentId.substring(0, 4) + "*".repeat(studentId.length - 4);
        };

        const namesList = (ev.applicants || [])
          .map(
            (a) =>
              `<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs flex items-center gap-1">
              <span class="text-xs">${saf(a.name)}</span>
              <span class="text-orange-600 font-mono text-xs">(${maskStudentId(
                a.studentId
              )})</span>
            </span>`
          )
          .join("");
        const waitingList = (ev.waiting || [])
          .map(
            (a) =>
              `<span class="bg-orange-200 text-orange-900 px-2 py-1 rounded-full text-xs flex items-center gap-1">
              <span class="text-xs">${saf(a.name)}</span>
              <span class="text-orange-700 font-mono text-xs">(${maskStudentId(
                a.studentId
              )})</span>
            </span>`
          )
          .join("");
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        return `<div class="section card-hover ${typeAccentClass(
          ev.type
        )}" data-event-id="${
          ev.id
        }" style="position: relative; z-index: 1; margin-bottom: 1.5rem; height: auto; overflow: visible; clear: both;">
                  <h3 class="text-xl font-bold text-gray-800">${saf(
                    ev.title
                  )}</h3>
                  <div class="mt-2 space-y-1">
                    <div class="flex items-center gap-2">
                      <div class="bg-orange-100 text-orange-800 px-3 py-1.5 rounded-lg flex items-center gap-2 flex-1">
                        <i class="fas fa-calendar-check text-orange-600"></i>
                        <span class="text-sm font-medium">ì´ë²¤íŠ¸ ì‹¤ì‹œì¼</span>
                      </div>
                      <p class="text-gray-700 font-semibold text-sm flex-1">${
                        ev.datetime
                          ? new Date(ev.datetime).toLocaleString("ko-KR", {
                              month: "long",
                              day: "numeric",
                              hour: "2-digit",
                              minute: "2-digit",
                            })
                          : "-"
                      }</p>
                    </div>
                    <div class="flex items-center gap-2">
                      <div class="bg-red-100 text-red-800 px-3 py-1.5 rounded-lg flex items-center gap-2 flex-1">
                        <i class="fas fa-clock text-red-600"></i>
                        <span class="text-sm font-medium">ì‹ ì²­ ë§ˆê°ì¼</span>
                      </div>
                      <p class="text-red-700 font-semibold text-sm flex-1">${
                        ev.deadline
                          ? new Date(ev.deadline).toLocaleString("ko-KR", {
                              month: "long",
                              day: "numeric",
                              hour: "2-digit",
                              minute: "2-digit",
                            })
                          : "ë¯¸ì„¤ì •"
                      }</p>
                    </div>
                  </div>
                  ${paymentInfoHTML(ev)}
                  ${
                    isFullAdmin()
                      ? `
                  <div class="mt-3">
                    <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-orange-500 h-4 rounded-full" style="width:${
                      lim ? Math.min(100, Math.round((count / lim) * 100)) : 0
                    }%"></div></div>
                    <p class="text-right text-sm mt-1 text-gray-600">ì‹ ì²­: ${count} / ${lim} ëª…</p>
                  </div>
                  `
                      : ""
                  }
                  ${adminStatsHTML(ev)}
                  ${btn}
                  ${getCancelNotice()}
                  ${
                    currentUser
                      ? `
                  <div class="mt-3">
                    ${
                      (ev.applicants || []).length > 0
                        ? `<div class="mt-2 text-xs text-gray-600">
                          <div class="font-medium mb-1 text-xs">ì°¸ê°€ì (${
                            (ev.applicants || []).length
                          }ëª…)</div>
                          <div class="flex flex-wrap gap-1">
                            ${namesList}
                  </div>
                        </div>`
                        : ""
                    }
                    ${
                      (ev.waiting || []).length > 0
                        ? `<div class="mt-2 text-xs text-gray-600">
                          <div class="font-medium mb-1 text-xs">ëŒ€ê¸°ì (${
                            (ev.waiting || []).length
                          }ëª…)</div>
                          <div class="flex flex-wrap gap-1">
                            ${waitingList}
                  </div>
                        </div>`
                        : ""
                    }
                  </div>
                  `
                      : ""
                  }
                  <div class="text-[11px] text-gray-400 mt-2">ìƒíƒœ: ${statusLabel(
                    ev.status || "open"
                  )}</div>
                  <div class="flex gap-2 mt-2 text-sm text-gray-600">
                    <span class="px-2 py-0.5 rounded ${typeBadgeClass(
                      ev.type
                    )}">${typeLabel(ev.type)}</span>
                  </div>
                  ${adminFullTableHTML(ev)}
                  ${adminInline(ev)}
                </div>`;
      }
      function tastingCardHTML(ev) {
        const list = (ev.restaurants || [])
          .map((r) => {
            const cap = r.capacity ?? ev.limit ?? 0;
            const cnt = (r.reservations || []).length;
            const mine = (r.reservations || [])
              .concat(r.waiting || [])
              .some((p) => p.studentId === currentUser?.studentId);
            const isInReservations = (r.reservations || []).some(
              (p) => p.studentId === currentUser?.studentId
            );
            const isInWaiting = (r.waiting || []).some(
              (p) => p.studentId === currentUser?.studentId
            );
            const btn = currentUser
              ? isInReservations
                ? `<button type="button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="cancel-tasting" data-id="${ev.id}" data-rid="${r.id}">
                    <i class="fas fa-times"></i>
                    <span>ì‹ ì²­ ì·¨ì†Œ</span>
                  </button>`
                : isInWaiting
                ? `<button type="button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="cancel-wait-tasting" data-id="${ev.id}" data-rid="${r.id}">
                    <i class="fas fa-hourglass-half"></i>
                    <span>ëŒ€ê¸° ì·¨ì†Œ</span>
                  </button>`
                : `<button type="button" class="w-full ${
                    cnt < cap
                      ? "bg-orange-600 hover:bg-orange-700 shadow-orange-200"
                      : "bg-red-600 hover:bg-red-700 shadow-red-200"
                  } text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2" data-act="reserve-tasting" data-id="${
                    ev.id
                  }" data-rid="${r.id}">
                    <i class="fas ${cnt < cap ? "fa-check" : "fa-clock"}"></i>
                    <span>${
                      cnt < cap ? "ì‹ ì²­í•˜ê¸°" : "ì‹ ì²­ ë§ˆê° / ëŒ€ê¸°í•˜ê¸°"
                    }</span>
                  </button>`
              : `<div class="w-full bg-gray-100 text-gray-500 font-bold py-2 px-4 rounded-lg text-center flex items-center justify-center gap-2">
                  <i class="fas fa-lock"></i>
                  <span>ë¡œê·¸ì¸ í•„ìš”</span>
                </div>`;
            // í•™ë²ˆ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
            const maskStudentId = (studentId) => {
              if (!studentId) return "";
              if (studentId.length <= 4) return studentId;
              return (
                studentId.substring(0, 4) + "*".repeat(studentId.length - 4)
              );
            };

            const namesList =
              (r.reservations || []).length > 0
                ? `<div class="mt-2 text-xs text-gray-600">
                  <div class="font-medium mb-1 text-xs">ì°¸ê°€ì (${
                    (r.reservations || []).length
                  }ëª…)</div>
                  <div class="flex flex-wrap gap-1">
                    ${(r.reservations || [])
                      .map(
                        (a) =>
                          `<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs flex items-center gap-1">
                            <span class="text-xs">${saf(a.name)}</span>
                            <span class="text-orange-600 font-mono text-xs">(${maskStudentId(
                              a.studentId
                            )})</span>
                          </span>`
                      )
                      .join("")}
                    </div>
                  </div>`
                : "";
            const waitingList =
              (r.waiting || []).length > 0
                ? `<div class="mt-2 text-xs text-gray-600">
                  <div class="font-medium mb-1 text-xs">ëŒ€ê¸°ì (${
                    (r.waiting || []).length
                  }ëª…)</div>
                  <div class="flex flex-wrap gap-1">
                    ${(r.waiting || [])
                      .map(
                        (a) =>
                          `<span class="bg-orange-200 text-orange-900 px-2 py-1 rounded-full text-xs flex items-center gap-1">
                            <span class="text-xs">${saf(a.name)}</span>
                            <span class="text-orange-700 font-mono text-xs">(${maskStudentId(
                              a.studentId
                            )})</span>
                          </span>`
                      )
                      .join("")}
                  </div>
                </div>`
                : "";
            return `<div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-start gap-4 mb-3">
                    ${
                      r.imageUrl
                        ? `<div class="flex-shrink-0">
                              <img src="${saf(r.imageUrl)}" alt="${saf(
                            r.name
                          )}" class="w-16 h-16 object-cover rounded-lg" onerror="this.style.display='none'">
                            </div>`
                        : ""
                    }
                      
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-2">
                          <h4 class="font-bold text-base text-gray-800">${saf(
                            r.name
                          )}</h4>
                          ${
                            currentUser &&
                            adminList.includes(currentUser.studentId)
                              ? `
                          <span class="text-xs text-gray-600 bg-white px-2 py-1 rounded-full">
                            ${cnt}/${cap}ëª…
                          </span>
                          `
                              : ""
                          }
                        </div>
                        <p class="text-xs text-gray-600">${saf(
                          r.info || ""
                        )}</p>
                    </div>
                    </div>
                    
                    ${
                      currentUser
                        ? `
                    ${namesList}
                    ${waitingList}
                    `
                        : ""
                    }
                    
                    ${
                      currentUser && adminList.includes(currentUser.studentId)
                        ? `
                    <div class="mb-3">
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full transition-all duration-300" style="width:${
                          cap ? Math.min(100, Math.round((cnt / cap) * 100)) : 0
                        }%"></div>
                      </div>
                    </div>
                    `
                        : ""
                    }
                    
                    <div class="w-full">
                    ${btn}
                    ${getCancelNotice()}
                    </div>
                  </div>`;
          })
          .join("");
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        return `<div class="section card-hover ${typeAccentClass(
          ev.type
        )}" data-event-id="${
          ev.id
        }" style="position: relative; z-index: 1; margin-bottom: 2rem; height: auto; overflow: visible; clear: both;">
                  <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                      <div class="flex justify-between items-center mb-2">
                  <h3 class="text-xl font-bold text-gray-800">${saf(
                    ev.title
                  )}</h3>
                        <span class="px-3 py-1.5 rounded-full text-sm font-medium ${typeBadgeClass(
                          ev.type
                        )} min-h-[32px] flex items-center justify-center">
                          ${typeLabel(ev.type)}
                        </span>
                      </div>
                      <div class="space-y-1">
                        <div class="flex items-center gap-2">
                          <div class="bg-orange-100 text-orange-800 px-3 py-1.5 rounded-lg flex items-center gap-2 flex-1">
                            <i class="fas fa-calendar-check text-orange-600"></i>
                            <span class="text-sm font-medium">ì´ë²¤íŠ¸ ì‹¤ì‹œì¼</span>
                          </div>
                          <p class="text-gray-700 font-semibold text-sm flex-1">${
                            ev.datetime
                              ? new Date(ev.datetime).toLocaleString("ko-KR", {
                                  month: "long",
                                  day: "numeric",
                                  hour: "2-digit",
                                  minute: "2-digit",
                                })
                              : "-"
                          }</p>
                        </div>
                        <div class="flex items-center gap-2">
                          <div class="bg-red-100 text-red-800 px-3 py-1.5 rounded-lg flex items-center gap-2 flex-1">
                            <i class="fas fa-clock text-red-600"></i>
                            <span class="text-sm font-medium">ì‹ ì²­ ë§ˆê°ì¼</span>
                          </div>
                          <p class="text-red-700 font-semibold text-sm flex-1">${
                            ev.deadline
                              ? new Date(ev.deadline).toLocaleString("ko-KR", {
                                  month: "long",
                                  day: "numeric",
                                  hour: "2-digit",
                                  minute: "2-digit",
                                })
                              : "ë¯¸ì„¤ì •"
                          }</p>
                        </div>
                      </div>
                  ${adminStatsHTML(ev)}
                    </div>
                    
                    <div class="p-4">
                      <div class="space-y-2">${list}</div>
                      
                      <div class="mt-4 pt-3 border-t border-gray-100">
                        <div class="flex justify-between items-center">
                          <div class="text-xs text-gray-500">
                            ìƒíƒœ: ${statusLabel(ev.status || "open")}
                  </div>
                  ${adminInline(ev)}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>`;
      }
      function eventCardHTML(ev) {
        return ev.type === "tasting"
          ? tastingCardHTML(ev)
          : generalCardHTML(ev);
      }

      function adminFullTableHTML(ev) {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (!isAdmin || !(ev.type === "mt" || ev.type === "assembly"))
          return "";
        const header = `<thead class="text-gray-700 table-sticky"><tr>
            <th class="px-2 py-1 text-left">ì´ë¦„</th><th class="px-2 py-1 text-left">í•™ë²ˆ</th><th class="px-2 py-1 text-left">ì„±ë³„</th>
            <th class="px-2 py-1 text-left">í•™ë…„</th><th class="px-2 py-1 text-left">ë‹¨ê³¼ëŒ€</th><th class="px-2 py-1 text-left">í•™ê³¼</th><th class="px-2 py-1 text-left">ì „í™”ë²ˆí˜¸</th>
          </tr></thead>`;
        const rows = (ev.applicants || [])
          .slice()
          .sort((a, b) => (a.name || "").localeCompare(b.name || "")) // ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
          .map(
            (m, index) => `<tr class="border-t">
            <td class="px-2 py-1 max-w-0 truncate" title="${saf(
              m.name || ""
            )}">${saf(m.name || "")}</td>
            <td class="px-2 py-1 font-mono">${saf(m.studentId || "")}</td>
            <td class="px-2 py-1">${saf(m.gender || "")}</td>
            <td class="px-2 py-1">${saf(m.year || "")}</td>
            <td class="px-2 py-1">${saf(m.college || "")}</td>
            <td class="px-2 py-1">${saf(m.department || "")}</td>
            <td class="px-2 py-1">${saf(m.phone || "")}</td>
          </tr>`
          )
          .join("");
        const body =
          rows ||
          `<tr><td class="px-2 py-6 text-center text-gray-400" colspan="7">ì‹ ì²­ì ì—†ìŒ</td></tr>`;
        const toolbar = `<div class="flex items-center justify-between mb-2">
            <div class="text-xs font-semibold text-gray-700">ê´€ë¦¬ì ì „ìš© â€¢ ì°¸ê°€ì ìƒì„¸</div>
            <button type="button" class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded" data-act="export-xlsx" data-id="${ev.id}">
              <i class="fas fa-file-excel mr-1"></i>ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ
            </button>
          </div>`;
        return `<div class="mt-4 border-t pt-3">${toolbar}<div class="overflow-auto max-h-60 border rounded">
            <table class="min-w-full text-xs">${header}<tbody>${body}</tbody></table></div></div>`;
      }

      function renderReservationTab(isAdmin) {
        const c = document.getElementById("reservation-tab");
        if (!c) return;

        const activeEvents = eventsData.filter(
          (e) => e.status !== "archived" && e.status !== "closed"
        );
        const listHTML =
          activeEvents.length === 0
            ? `<div class="text-center py-12"><i class="fas fa-calendar-xmark text-4xl text-gray-300"></i><p class="mt-3 text-gray-500">ì§„í–‰ ì¤‘ì¸ ì´ë²¤íŠ¸/ë¯¸ì‹íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`
            : `<div id="events-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="position: relative; z-index: 1; min-height: 200px;">
                ${activeEvents
                  .sort((a, b) => (a.order || 999) - (b.order || 999))
                  .map(eventCardHTML)
                  .join("")}
               </div>`;

        // ê´€ë¦¬ìì—ê²ŒëŠ” ì´ë²¤íŠ¸ ìƒì„± ë²„íŠ¼ë§Œ í‘œì‹œ
        c.innerHTML =
          (isAdmin
            ? `
            <div class="section mb-6">
              <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                  <h2 class="text-2xl font-bold mb-1 text-gray-800">ì§„í–‰ ì¤‘ ëª©ë¡</h2>
                  <p class="text-xs text-gray-500">í˜„ì¬ ì‹ ì²­ ê°€ëŠ¥í•œ ì´ë²¤íŠ¸/ë¯¸ì‹íšŒì…ë‹ˆë‹¤.</p>
                </div>
                ${
                  isFullAdmin()
                    ? `
                <div class="flex flex-col sm:flex-row gap-2">
                  <button id="create-event-btn" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors shadow-md">
                    <i class="fas fa-cog mr-2"></i>ì´ë²¤íŠ¸ ê´€ë¦¬
                  </button>
                  <button id="auto-close-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors shadow-md">
                    <i class="fas fa-clock mr-2"></i>ìë™ ë§ˆê° ì‹¤í–‰
                  </button>
                </div>
                `
                    : ""
                }
              </div>
            </div>
          `
            : `
            <div class="section mb-6">
              <h2 class="text-2xl font-bold mb-1 text-gray-800">ì§„í–‰ ì¤‘ ëª©ë¡</h2>
              <p class="text-xs text-gray-500 mb-3">í˜„ì¬ ì‹ ì²­ ê°€ëŠ¥í•œ ì´ë²¤íŠ¸/ë¯¸ì‹íšŒì…ë‹ˆë‹¤.</p>
            </div>
          `) +
          `<div class="section">
             ${listHTML}
           </div>`;

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        c.removeEventListener("click", handleReservationTabClick);

        // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        c.addEventListener("click", handleReservationTabClick);

        // bindAdminEventsPanelì€ ëª¨ë‹¬ ë‚´ë¶€ì—ì„œë§Œ í˜¸ì¶œë¨
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë¥¼ ë³„ë„ë¡œ ë¶„ë¦¬
      async function handleReservationTabClick(e) {
        const b = e.target.closest("button[data-act]");
        if (!b) return;
        const act = b.dataset.act,
          id = b.dataset.id,
          rid = b.dataset.rid;
        if (act === "reserve-general") return reserveGeneral(id);
        if (act === "cancel-general") return cancelGeneral(id);
        if (act === "cancel-wait-general") return cancelWaitGeneral(id);
        if (act === "reserve-tasting") return reserveTasting(id, rid);
        if (act === "cancel-tasting") return cancelTasting(id, rid);
        if (act === "cancel-wait-tasting") return cancelWaitTasting(id, rid);
        if (act === "admin-edit") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return openEventModal("edit", id);
        }
        if (act === "admin-close") return closeEvent(id);
        if (act === "admin-reopen") return reopenEvent(id);
        if (act === "admin-archive") return archiveEvent(id);
        if (act === "admin-unpost") return unpostEvent(id);
        if (act === "group-maker") return openGroupMakerModal(id);
        if (act === "admin-delete") return deleteEvent(id);
        if (act === "export-xlsx") return exportApplicantsXLSX(id);
      }

      /* ===== ì´ë²¤íŠ¸ ê´€ë¦¬ì íŒ¨ë„ (ëŒ€ì‹œë³´ë“œì—ì„œ ì œê±°, ì‹ ì²­í•˜ê¸° íƒ­ ìƒë‹¨ìœ¼ë¡œ ì´ë™) ===== */
      function adminEventsPanelHTML() {
        return `<div class="section">
          <!-- í—¤ë” -->
          <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-4 mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
              <i class="fas fa-calendar-plus text-orange-600"></i>
              ìƒˆ ì´ë²¤íŠ¸ ë§Œë“¤ê¸°
            </h3>
            <p class="text-sm text-gray-600">
              <i class="fas fa-info-circle text-orange-500 mr-1"></i>
              ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì‹œë©´ ì‰½ê²Œ ì´ë²¤íŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”!
            </p>
          </div>

          <!-- Step 1: ì´ë²¤íŠ¸ ìœ í˜• -->
          <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
            <div class="flex items-center gap-2 mb-3">
              <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">1</span>
              <h4 class="text-lg font-bold text-gray-800">ì–´ë–¤ ì¢…ë¥˜ì˜ ì´ë²¤íŠ¸ì¸ê°€ìš”?</h4>
            </div>
            <select id="event-type" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-white text-gray-900 hover:border-orange-400 focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base font-medium">
              <option value="tasting">ğŸ½ï¸ ë¯¸ì‹íšŒ (ì—¬ëŸ¬ ì‹ë‹¹ ì¤‘ ì„ íƒ)</option>
              <option value="general">ğŸ“Œ ì¼ë°˜ ì´ë²¤íŠ¸ (ë‹¨ì¼ í™œë™)</option>
              <option value="mt">ğŸ•ï¸ MT (íšŒë¹„ ì…ê¸ˆ í•„ìš”)</option>
              <option value="assembly">ğŸ‘¥ ì´íšŒ (íšŒë¹„ ì…ê¸ˆ í•„ìš”)</option>
            </select>
            <p class="text-xs text-gray-500 mt-2 pl-10">ğŸ’¡ ë¯¸ì‹íšŒëŠ” ì—¬ëŸ¬ ì‹ë‹¹ì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”</p>
          </div>

          <!-- Step 2: ê¸°ë³¸ ì •ë³´ -->
          <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
            <div class="flex items-center gap-2 mb-4">
              <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">2</span>
              <h4 class="text-lg font-bold text-gray-800">ì´ë²¤íŠ¸ ê¸°ë³¸ ì •ë³´</h4>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-heading text-orange-500"></i>
                  ì´ë²¤íŠ¸ ì œëª© <span class="text-red-500">*</span>
                </label>
                <input id="event-title" type="text" placeholder="ì˜ˆ: í‘¸ë”” ê°€ì„ ë¯¸ì‹íšŒ, ê°€ì„ MT" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-calendar-alt text-orange-500"></i>
                  ì´ë²¤íŠ¸ ì‹¤ì‹œì¼ (ì–¸ì œ ì§„í–‰í•˜ë‚˜ìš”?) <span class="text-red-500">*</span>
                </label>
                <input id="event-datetime" type="datetime-local" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ“… ì´ë²¤íŠ¸ê°€ ì‹¤ì œë¡œ ì§„í–‰ë˜ëŠ” ë‚ ì§œì™€ ì‹œê°„</p>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-clock text-orange-500"></i>
                  ì‹ ì²­ ë§ˆê°ì¼ (ì–¸ì œê¹Œì§€ ì‹ ì²­ë°›ë‚˜ìš”?) <span class="text-red-500">*</span>
                </label>
                <input id="event-deadline" type="datetime-local" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                <p class="text-xs text-gray-500 mt-1 pl-6">â° ì´ ì‹œê°„ ì´í›„ë¡œëŠ” ì‹ ì²­í•  ìˆ˜ ì—†ì–´ìš”</p>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-users text-orange-500"></i>
                  ìµœëŒ€ ëª‡ ëª…ê¹Œì§€ ì°¸ê°€í•  ìˆ˜ ìˆë‚˜ìš”? <span class="text-red-500">*</span>
                </label>
                <input id="event-limit" type="number" min="1" placeholder="ì˜ˆ: 30" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ‘¥ ì •ì›ì„ ì´ˆê³¼í•˜ë©´ ëŒ€ê¸° ì‹ ì²­ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤</p>
              </div>
            </div>
          </div>

          <!-- Step 3: ê³µê°œ ì„¤ì • ë° ì•Œë¦¼ -->
          <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
            <div class="flex items-center gap-2 mb-4">
              <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">3</span>
              <h4 class="text-lg font-bold text-gray-800">ê³µê°œ ì„¤ì • ë° ì•Œë¦¼</h4>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-eye text-orange-500"></i>
                  íšŒì›ë“¤ì—ê²Œ ë³´ì—¬ì¤„ê¹Œìš”?
                </label>
                <div class="flex bg-gray-100 rounded-lg p-1.5 w-fit gap-1">
                  <button type="button" id="status-open" class="px-4 py-2 text-sm font-bold rounded-lg transition-all bg-white text-orange-600 shadow-sm flex items-center gap-2">
                    <i class="fas fa-globe"></i>ê³µê°œ
                  </button>
                  <button type="button" id="status-hidden" class="px-4 py-2 text-sm font-bold rounded-lg transition-all text-gray-600 hover:text-gray-800 hover:bg-white/50 flex items-center gap-2">
                    <i class="fas fa-eye-slash"></i>ìˆ¨ê¹€
                  </button>
                </div>
                <input type="hidden" id="event-status" value="open">
                <p class="text-xs text-gray-500 mt-2 pl-6">ğŸ”’ "ìˆ¨ê¹€"ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
              </div>
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-bell text-orange-500"></i>
                  ìë™ ì•Œë¦¼ ì„¤ì •
                </label>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                  <div class="flex items-start gap-2">
                    <input type="checkbox" id="enable-auto-post" class="mt-1 w-4 h-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500" checked>
                    <label for="enable-auto-post" class="text-sm font-medium text-gray-700 flex-1">
                      ìë™ìœ¼ë¡œ ì•Œë¦¼ ê¸€ ì˜¬ë¦¬ê¸°
                      <p class="text-xs text-gray-500 font-normal mt-1">ì´ë²¤íŠ¸ í•˜ë£¨ ì „ì— íšŒì›ë“¤ì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚´ìš”</p>
                    </label>
                  </div>
                </div>
                <div id="post-time-container" class="space-y-3 pl-6">
                  <div class="flex items-center gap-3">
                    <input type="radio" id="post-time-auto" name="post-time-type" value="auto" class="w-4 h-4 text-orange-600 focus:ring-orange-500" checked>
                    <label for="post-time-auto" class="text-sm text-gray-700 flex items-center gap-2">
                      <i class="fas fa-clock text-gray-400"></i>
                      <span>ì´ë²¤íŠ¸ 24ì‹œê°„ ì „ ìë™</span>
                      <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-semibold">ì¶”ì²œ</span>
                    </label>
                  </div>
                  <div class="flex items-center gap-3">
                    <input type="radio" id="post-time-custom" name="post-time-type" value="custom" class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                    <label for="post-time-custom" class="text-sm text-gray-700 flex items-center gap-2">
                      <i class="fas fa-calendar-check text-gray-400"></i>
                      <span>ì§ì ‘ ì§€ì •í•˜ê¸°</span>
                    </label>
                  </div>
                  <div class="pl-8">
                    <input id="post-datetime" type="datetime-local" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-200" disabled>
                  </div>
                </div>
                <button type="button" id="test-announcement-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-medium">
                  <i class="fas fa-flask"></i>
                  í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë¯¸ë¦¬ë³´ê¸°
                </button>
              </div>
            </div>
          </div>

          <!-- Step 4: íšŒë¹„ ì…ê¸ˆ ì •ë³´ (MT/ì´íšŒë§Œ) -->
          <div id="payment-fields" class="hidden">
            <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
              <div class="flex items-center gap-2 mb-4">
                <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">4</span>
                <h4 class="text-lg font-bold text-gray-800">ğŸ’° íšŒë¹„ ì…ê¸ˆ ì •ë³´</h4>
              </div>
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <p class="text-xs text-yellow-800 flex items-center gap-2">
                  <i class="fas fa-lightbulb"></i>
                  ì‹œìŠ¤í…œ ì„¤ì •ì˜ ê³„ì¢Œ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì§‘ë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ì •í•˜ì„¸ìš”.
                </p>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-landmark text-orange-500"></i>
                    ì€í–‰ëª…
                  </label>
                  <input id="pay-bank" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="ì˜ˆ: êµ­ë¯¼ì€í–‰, ì‹ í•œì€í–‰">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-credit-card text-orange-500"></i>
                    ê³„ì¢Œë²ˆí˜¸
                  </label>
                  <input id="pay-number" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="000-000-000000">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-user text-orange-500"></i>
                    ì˜ˆê¸ˆì£¼
                  </label>
                  <input id="pay-holder" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="í™ê¸¸ë™">
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fas fa-comment-dots text-orange-500"></i>
                    ì…ê¸ˆ ì•ˆë‚´ (ì„ íƒì‚¬í•­)
                  </label>
                  <input id="pay-note" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" placeholder="ì˜ˆ: ì…ê¸ˆ ì‹œ ì´ë¦„ ê¼­ ì ì–´ì£¼ì„¸ìš”">
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4/5: ì‹ë‹¹ ê´€ë¦¬ (ë¯¸ì‹íšŒë§Œ) -->
          <div id="tasting-fields">
            <div class="bg-white border-2 border-orange-200 rounded-xl p-5 mb-4">
              <div class="flex items-center gap-2 mb-4">
                <span class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">4</span>
                <h4 class="text-lg font-bold text-gray-800">ğŸ½ï¸ ì‹ë‹¹ ì¶”ê°€í•˜ê¸°</h4>
              </div>
              <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                <p class="text-xs text-green-800 flex items-center gap-2">
                  <i class="fas fa-check-circle"></i>
                  ë¯¸ì‹íšŒëŠ” ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‹ë‹¹ì„ ì¶”ê°€í•´ì•¼ í•´ìš”!
                </p>
              </div>
              <div id="event-restaurants-wrap" class="space-y-3 mb-4">${restaurantFieldHTML()}</div>
              <button id="add-restaurant-btn" type="button" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-plus-circle text-lg"></i>
                <span>ì‹ë‹¹ ì¶”ê°€í•˜ê¸°</span>
              </button>
            </div>
          </div>

          <!-- ì €ì¥ ë²„íŠ¼ -->
          <div class="flex gap-3 mt-6">
            <button id="save-event-btn" type="button" class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-4 px-6 rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-3 text-lg">
              <i class="fas fa-check-circle text-xl"></i>
              <span>ì´ë²¤íŠ¸ ë§Œë“¤ê¸° ì™„ë£Œ!</span>
            </button>
            <button id="reset-event-btn" type="button" class="flex-none bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-4 px-6 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
              <i class="fas fa-redo"></i>
              <span>ë‹¤ì‹œ ì‘ì„±</span>
            </button>
          </div>

          <!-- í˜„ì¬ ì´ë²¤íŠ¸ ëª©ë¡ -->
          <div class="mt-8 pt-6 border-t-2 border-gray-200">
            <div class="flex items-center gap-2 mb-4">
              <i class="fas fa-list text-gray-600 text-xl"></i>
              <h4 class="text-xl font-bold text-gray-800">ìƒì„±ëœ ì´ë²¤íŠ¸ ëª©ë¡</h4>
            </div>
            <p class="text-sm text-gray-600 mb-4">
              <i class="fas fa-info-circle text-blue-500 mr-1"></i>
              ë§Œë“¤ì–´ì§„ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆì–´ìš”
            </p>
            <div class="space-y-3">${adminEventsListHTML()}</div>
          </div>
        </div>`;
      }
      function bindAdminEventsPanel() {
        const wrap = document.getElementById("event-restaurants-wrap");
        const eventType = document.getElementById("event-type");
        const addRestaurantBtn = document.getElementById("add-restaurant-btn");
        const saveEventBtn = document.getElementById("save-event-btn");
        const resetEventBtn = document.getElementById("reset-event-btn");

        // null ì²´í¬
        if (
          !wrap ||
          !eventType ||
          !addRestaurantBtn ||
          !saveEventBtn ||
          !resetEventBtn
        ) {
          console.warn("bindAdminEventsPanel: ì¼ë¶€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        eventType.addEventListener("change", (e) =>
          onTypeChange(e.target.value)
        );
        addRestaurantBtn.addEventListener("click", () => addRestaurantField());

        // ê¸°ì¡´ ì‹ë‹¹ í•„ë“œë“¤ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
        const existingRows = wrap.querySelectorAll(".restaurant-row");
        existingRows.forEach((row) => bindRestaurantFieldEvents(row));

        // ì‹ë‹¹ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        wrap.addEventListener("click", (e) => {
          const row = e.target.closest(".restaurant-row");
          if (!row) return;
          if (e.target.closest(".remove-restaurant")) row.remove();
        });
        saveEventBtn.addEventListener("click", () => createOrSaveEvent());
        resetEventBtn.addEventListener("click", () => resetEventForm());

        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ê²Œì‹œ ë²„íŠ¼
        const testAnnouncementBtn = document.getElementById(
          "test-announcement-btn"
        );
        if (testAnnouncementBtn) {
          testAnnouncementBtn.addEventListener("click", async () => {
            const testContent = `ğŸ§ª í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ğŸ§ª

ğŸ“… ì¼ì‹œ: ${new Date().toLocaleString("ko-KR")}
ğŸ“ ì œëª©: í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸

ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ìš© ì•Œë¦¼ì…ë‹ˆë‹¤.
ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ˜Š

#Foodie #í…ŒìŠ¤íŠ¸`;

            try {
              await postAnnouncement(testContent);
            } catch (error) {
              console.error("í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ê²Œì‹œ ì˜¤ë¥˜:", error);
            }
          });
        }

        // ê²Œì‹œì¼ì‹œ ì„¤ì • ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const enableAutoPost = document.getElementById("enable-auto-post");
        const postTimeAuto = document.getElementById("post-time-auto");
        const postTimeCustom = document.getElementById("post-time-custom");
        const postDatetime = document.getElementById("post-datetime");
        const postTimeContainer = document.getElementById(
          "post-time-container"
        );

        if (
          enableAutoPost &&
          postTimeAuto &&
          postTimeCustom &&
          postDatetime &&
          postTimeContainer
        ) {
          // ìë™ ì•Œë¦¼ ê²Œì‹œ ì‚¬ìš©/í•´ì œ
          enableAutoPost.addEventListener("change", (e) => {
            postTimeContainer.style.opacity = e.target.checked ? "1" : "0.5";
            postTimeContainer.style.pointerEvents = e.target.checked
              ? "auto"
              : "none";
          });

          // ê²Œì‹œ ì‹œê°„ íƒ€ì… ë³€ê²½
          postTimeAuto.addEventListener("change", () => {
            if (postTimeAuto.checked) {
              postDatetime.disabled = true;
            }
          });

          postTimeCustom.addEventListener("change", () => {
            if (postTimeCustom.checked) {
              postDatetime.disabled = false;
              // ì´ë²¤íŠ¸ ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
              const eventDatetime =
                document.getElementById("event-datetime").value;
              if (eventDatetime) {
                const eventTime = new Date(eventDatetime);
                const postTime = new Date(
                  eventTime.getTime() - 24 * 60 * 60 * 1000
                );
                postDatetime.value = postTime.toISOString().slice(0, 16);
              }
            }
          });

          // ì´ë²¤íŠ¸ ì‹œê°„ ë³€ê²½ ì‹œ ìë™ ê²Œì‹œ ì‹œê°„ ì—…ë°ì´íŠ¸
          const eventDatetime = document.getElementById("event-datetime");
          if (eventDatetime) {
            eventDatetime.addEventListener("change", () => {
              if (postTimeAuto.checked) {
                // ìë™ ëª¨ë“œì—ì„œëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ
              } else if (postTimeCustom.checked && !postDatetime.value) {
                // ì»¤ìŠ¤í…€ ëª¨ë“œì—ì„œ ê²Œì‹œ ì‹œê°„ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
                const eventTime = new Date(eventDatetime.value);
                const postTime = new Date(
                  eventTime.getTime() - 24 * 60 * 60 * 1000
                );
                postDatetime.value = postTime.toISOString().slice(0, 16);
              }
            });
          }
        }

        // ê³µê°œ/ìˆ¨ê¹€ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
        const statusOpenBtn = document.getElementById("status-open");
        const statusHiddenBtn = document.getElementById("status-hidden");
        const statusInput = document.getElementById("event-status");

        if (statusOpenBtn && statusHiddenBtn && statusInput) {
          const updateStatusButtons = (status) => {
            if (status === "open") {
              statusOpenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white text-orange-600 shadow-sm";
              statusHiddenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800";
            } else {
              statusOpenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800";
              statusHiddenBtn.className =
                "px-3 py-1 text-sm font-medium rounded-md transition-colors bg-white text-orange-600 shadow-sm";
            }
            statusInput.value = status;
          };

          statusOpenBtn.addEventListener("click", () =>
            updateStatusButtons("open")
          );
          statusHiddenBtn.addEventListener("click", () =>
            updateStatusButtons("archived")
          );

          // ì´ˆê¸° ìƒíƒœ ì„¤ì •
          updateStatusButtons(statusInput.value);
        }

        onTypeChange(eventType.value);
      }
      function restaurantFieldHTML(
        n = "",
        i = "",
        c = "",
        url = "",
        id = "",
        category = "ê¸°íƒ€"
      ) {
        const rid = id || `res_${Math.random().toString(36).slice(2, 9)}`;
        return `<div class="restaurant-row bg-gradient-to-br from-white to-orange-50 border-2 border-orange-300 rounded-xl p-5 relative" data-id="${rid}">
          <!-- ì‚­ì œ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨) -->
          <button type="button" class="remove-restaurant absolute top-3 right-3 bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full transition-all shadow-md hover:shadow-lg flex items-center justify-center" title="ì´ ì‹ë‹¹ ì‚­ì œ">
            <i class="fas fa-trash text-sm"></i>
          </button>

          <div class="space-y-4">
            <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-tags text-orange-500"></i>
                ìŒì‹ ì¢…ë¥˜ <span class="text-red-500">*</span>
              </label>
              <select data-field="category" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base bg-white" required>
                <option value="í•œì‹" ${
                  category === "í•œì‹" ? "selected" : ""
                }>ğŸš í•œì‹</option>
                <option value="ì¼ì‹" ${
                  category === "ì¼ì‹" ? "selected" : ""
                }>ğŸ£ ì¼ì‹</option>
                <option value="ì¤‘ì‹" ${
                  category === "ì¤‘ì‹" ? "selected" : ""
                }>ğŸ¥Ÿ ì¤‘ì‹</option>
                <option value="ì–‘ì‹" ${
                  category === "ì–‘ì‹" ? "selected" : ""
                }>ğŸ ì–‘ì‹</option>
                <option value="ë””ì €íŠ¸" ${
                  category === "ë””ì €íŠ¸" ? "selected" : ""
                }>ğŸ° ë””ì €íŠ¸</option>
                <option value="ê¸°íƒ€" ${
                  category === "ê¸°íƒ€" ? "selected" : ""
                }>ğŸ½ï¸ ê¸°íƒ€</option>
              </select>
              <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ·ï¸ ì‹ë‹¹ì˜ ìŒì‹ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            </div>

            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ -->
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                <i class="fas fa-camera text-orange-500"></i>
                ì‹ë‹¹ ì‚¬ì§„ (ì„ íƒì‚¬í•­)
              </label>
              <div class="flex justify-center">
                <div class="relative w-40 h-40">
                  <img src="${saf(
                    url || ""
                  )}" class="thumb w-full h-full object-cover rounded-xl border-2 border-orange-200 ${
          url ? "" : "hidden"
        }" data-role="preview" alt="ì‹ë‹¹ ì´ë¯¸ì§€">
                  <div class="dz w-full h-full border-2 border-dashed border-orange-300 rounded-xl flex items-center justify-center text-gray-500 cursor-pointer hover:border-orange-500 hover:bg-orange-50 transition-all ${
                    url ? "hidden" : ""
                  }" data-role="dropzone">
                    <div class="text-center p-4">
                      <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-orange-400"></i>
                      <div class="text-sm font-medium">ì‚¬ì§„ ëŒì–´ë†“ê¸°</div>
                      <div class="text-xs text-gray-400 mt-1">ë˜ëŠ” í´ë¦­í•˜ì—¬ ì„ íƒ</div>
                    </div>
                  </div>
                  <div class="dz-overlay hidden absolute inset-0 bg-black/50 rounded-xl flex items-center justify-center text-white" data-role="uploading">
                    <div class="text-center">
                      <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                      <div class="text-sm">ì—…ë¡œë“œì¤‘â€¦</div>
                    </div>
                  </div>
                  <input type="file" accept="image/*" class="hidden" data-role="file">
                </div>
              </div>
              <div class="flex items-center gap-2 mt-2">
                <button type="button" class="select-image flex-1 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                  <i class="fas fa-folder-open"></i>
                  íŒŒì¼ì—ì„œ ì„ íƒ
                </button>
              </div>
              <div class="mt-2">
                <input data-field="imageUrl" type="text" value="${saf(
                  url
                )}" placeholder="ë˜ëŠ” ì´ë¯¸ì§€ URL ì£¼ì†Œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-200">
              </div>
            </div>
            
            <!-- ì…ë ¥ í•„ë“œë“¤ -->
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-utensils text-orange-500"></i>
                  ì‹ë‹¹ ì´ë¦„ <span class="text-red-500">*</span>
                </label>
                <input data-field="name" type="text" value="${saf(
                  n
                )}" placeholder="ì˜ˆ: ìŠ¤ì‹œ ë§›ì§‘, íŒŒìŠ¤íƒ€ ë ˆìŠ¤í† ë‘" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
              </div>
              
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-users text-orange-500"></i>
                  ì´ ì‹ë‹¹ì˜ ì •ì› <span class="text-red-500">*</span>
                </label>
                <input data-field="capacity" type="number" min="1" value="${saf(
                  c
                )}" placeholder="ì˜ˆ: 10" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base" required>
                <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ‘¥ ì´ ì‹ë‹¹ì— ëª‡ ëª…ê¹Œì§€ ê°ˆ ìˆ˜ ìˆë‚˜ìš”?</p>
              </div>
              
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <i class="fas fa-info-circle text-orange-500"></i>
                  ì‹ë‹¹ ìƒì„¸ ì •ë³´
                </label>
                <textarea data-field="info" rows="4" placeholder="ì‹ë‹¹ì˜ ìœ„ì¹˜, ë©”ë‰´, ê°€ê²©, íŠ¹ì§• ë“±ì„ ì•Œë ¤ì£¼ì„¸ìš”&#10;ì˜ˆ: ì‹ ì´Œì—­ 3ë²ˆ ì¶œêµ¬ &#10;ë©”ë‰´: íŒŒìŠ¤íƒ€, ë¦¬ì¡°ë˜&#10;ê°€ê²©: 1ë§Œì›ëŒ€" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all text-base resize-none">${saf(
                  i
                )}</textarea>
                <p class="text-xs text-gray-500 mt-1 pl-6">ğŸ“ Enter í‚¤ë¡œ ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•´ìš”</p>
              </div>
            </div>
          </div>
        </div>`;
      }
      function onTypeChange(type) {
        const tastingFields = document.getElementById("tasting-fields");
        const paymentFields = document.getElementById("payment-fields");

        if (!tastingFields || !paymentFields) {
          console.warn("onTypeChange: í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        tastingFields.classList.toggle("hidden", type !== "tasting");
        paymentFields.classList.toggle(
          "hidden",
          !(type === "mt" || type === "assembly")
        );

        if (type === "mt" || type === "assembly") {
          const d = duesSettings || {};
          const payBank = document.getElementById("pay-bank");
          const payNumber = document.getElementById("pay-number");
          const payHolder = document.getElementById("pay-holder");
          const payNote = document.getElementById("pay-note");

          if (payBank && !payBank.value) payBank.value = d.bank || "";
          if (payNumber && !payNumber.value) payNumber.value = d.number || "";
          if (payHolder && !payHolder.value) payHolder.value = d.holder || "";
          if (payNote && !payNote.value) {
            payNote.value =
              (d.amount ? `íšŒë¹„ ${formatKRW(d.amount)} ` : "") + (d.note || "");
          }
        }
      }
      function adminEventsListHTML() {
        if (eventsData.length === 0) return `<p class="text-gray-500">ì—†ìŒ</p>`;
        return eventsData
          .map((ev) => {
            const when = ev.datetime
              ? new Date(ev.datetime).toLocaleString("ko-KR")
              : "-";
            const badge = typeBadgeClass(ev.type);
            return `<div class="flex items-center justify-between bg-white p-3 rounded border">
            <div class="min-w-0">
              <span class="text-sm px-2 py-0.5 rounded ${badge}">${typeLabel(
              ev.type
            )}</span>
              <span class="font-semibold ml-2">${saf(
                ev.title || "(ì œëª© ì—†ìŒ)"
              )}</span>
              <span class="text-sm text-gray-500 ml-2">(${when})</span>
              <span class="text-xs ml-2 px-2 py-0.5 rounded ${
                ev.status === "open"
                  ? "bg-green-100 text-green-700"
                  : ev.autoClosedAt
                  ? "bg-orange-100 text-orange-700"
                  : "bg-gray-200 text-gray-700"
              }" ${
              ev.autoClosedAt
                ? `title="ìë™ ë§ˆê°ë¨: ${new Date(
                    ev.autoClosedAt
                  ).toLocaleString("ko-KR")}"`
                : ""
            }>${
              ev.autoClosedAt ? "ìë™ ë§ˆê°" : statusLabel(ev.status || "open")
            }</span>
            </div>
            <div class="flex gap-2">
              <button type="button" class="text-blue-600 hover:text-blue-800" data-act="admin-edit" data-id="${
                ev.id
              }" title="ìˆ˜ì •"><i class="fas fa-pen"></i></button>
              ${
                ev.status === "closed"
                  ? `<button type="button" class="text-green-600 hover:text-green-800 font-semibold" data-act="admin-reopen" data-id="${ev.id}" title="ë‹¤ì‹œ ì—´ê¸°"><i class="fas fa-door-open"></i></button>`
                  : `<button type="button" class="text-red-600 hover:text-red-800" data-act="admin-close" data-id="${ev.id}" title="ì‹ ì²­ ë§ˆê°"><i class="fas fa-door-closed"></i></button>`
              }
              <button type="button" class="text-amber-600 hover:text-amber-800" data-act="admin-archive" data-id="${
                ev.id
              }" title="ë³´ê´€(ìˆ¨ê¹€)"><i class="fas fa-box-archive"></i></button>
              <button type="button" class="text-indigo-600 hover:text-indigo-800" data-act="admin-unpost" data-id="${
                ev.id
              }" title="ê¸€ ë‚´ë¦¬ê¸°"><i class="fas fa-arrow-down"></i></button>
              <button type="button" class="text-purple-600 hover:text-purple-800" data-act="group-maker" data-id="${
                ev.id
              }" title="ì¡°ì§œê¸°"><i class="fas fa-users"></i></button>
              <button type="button" class="text-red-600 hover:text-red-800" data-act="admin-delete" data-id="${
                ev.id
              }" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
            </div>
          </div>`;
          })
          .join("");
      }
      const addRestaurantField = () => {
        const wrap = document.getElementById("event-restaurants-wrap");
        if (!wrap) return;

        wrap.insertAdjacentHTML("beforeend", restaurantFieldHTML());

        // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
        bindRestaurantFieldEvents(wrap.lastElementChild);
      };

      // ì‹ë‹¹ í•„ë“œì— ì´ë²¤íŠ¸ ë°”ì¸ë”©í•˜ëŠ” í•¨ìˆ˜
      function bindRestaurantFieldEvents(row) {
        if (!row) {
          console.error("bindRestaurantFieldEvents: rowê°€ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        console.log("ì‹ë‹¹ í•„ë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹œì‘:", row);

        // íŒŒì¼ ì„ íƒ ë²„íŠ¼ê³¼ ë“œë¡­ì¡´ í´ë¦­ ì´ë²¤íŠ¸
        const selectImageBtn = row.querySelector(".select-image");
        const dropzone = row.querySelector("[data-role='dropzone']");
        const fileInput = row.querySelector("[data-role='file']");

        console.log("DOM ìš”ì†Œ í™•ì¸:", {
          selectImageBtn: !!selectImageBtn,
          dropzone: !!dropzone,
          fileInput: !!fileInput,
        });

        // íŒŒì¼ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸
        if (selectImageBtn && fileInput) {
          // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
          selectImageBtn.removeEventListener("click", handleFileSelect);
          selectImageBtn.addEventListener("click", handleFileSelect);

          function handleFileSelect(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­ë¨");
            fileInput.click();
          }
        }

        // ë“œë¡­ì¡´ í´ë¦­ ì´ë²¤íŠ¸
        if (dropzone && fileInput) {
          dropzone.removeEventListener("click", handleDropzoneClick);
          dropzone.addEventListener("click", handleDropzoneClick);

          function handleDropzoneClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("ë“œë¡­ì¡´ í´ë¦­ë¨");
            fileInput.click();
          }
        }

        // íŒŒì¼ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
        if (fileInput) {
          fileInput.removeEventListener("change", handleFileChange);
          fileInput.addEventListener("change", handleFileChange);

          function handleFileChange(e) {
            console.log("íŒŒì¼ ì„ íƒë¨:", e.target.files);
            const f = e.target.files?.[0];
            e.target.value = "";
            if (f) {
              console.log("íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:", f.name, f.type);
              uploadRestaurantImage(row, f);
            }
          }
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        if (dropzone) {
          ["dragenter", "dragover"].forEach((evt) => {
            dropzone.removeEventListener(evt, handleDragOver);
            dropzone.addEventListener(evt, handleDragOver);

            function handleDragOver(e) {
              e.preventDefault();
              e.stopPropagation();
              dropzone.classList.add("drag");
            }
          });

          ["dragleave", "drop"].forEach((evt) => {
            dropzone.removeEventListener(evt, handleDragLeave);
            dropzone.addEventListener(evt, handleDragLeave);

            function handleDragLeave(e) {
              e.preventDefault();
              e.stopPropagation();
              dropzone.classList.remove("drag");
            }
          });

          dropzone.removeEventListener("drop", handleDrop);
          dropzone.addEventListener("drop", handleDrop);

          function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove("drag");
            const f = e.dataTransfer.files?.[0];
            if (f) {
              console.log("ë“œë˜ê·¸ ì•¤ ë“œë¡­ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:", f.name, f.type);
              uploadRestaurantImage(row, f);
            }
          }
        }

        console.log("ì‹ë‹¹ í•„ë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ");
      }

      /* ===== ì´ë¯¸ì§€ ì—…ë¡œë“œ ===== */
      async function uploadRestaurantImage(row, file) {
        console.log("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘:", file);

        if (IS_FILE) {
          showAlert(
            "â„¹ï¸",
            "ë¡œì»¬ íŒŒì¼ë¡œ ì—¬ì‹  ê²½ìš° ì—…ë¡œë“œê°€ ì œí•œë  ìˆ˜ ìˆì–´ìš”. GitHub Pages/ì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸í•´ ì£¼ì„¸ìš”."
          );
          return;
        }

        if (!currentUser) {
          console.error("í˜„ì¬ ì‚¬ìš©ì ì—†ìŒ");
          return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        if (!file || !file.type.startsWith("image/")) {
          console.error("ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹˜:", file?.type);
          return showAlert("â„¹ï¸", "ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }

        const overlay = row.querySelector("[data-role='uploading']");
        const imageUrlField = row.querySelector("[data-field='imageUrl']");
        const previewImg = row.querySelector("[data-role='preview']");
        const dropzone = row.querySelector("[data-role='dropzone']");

        if (!overlay || !imageUrlField || !previewImg || !dropzone) {
          console.error("í•„ìš”í•œ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", {
            overlay: !!overlay,
            imageUrlField: !!imageUrlField,
            previewImg: !!previewImg,
            dropzone: !!dropzone,
          });
          return showAlert("ğŸ˜¥", "ì´ë¯¸ì§€ ì—…ë¡œë“œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        overlay.classList.remove("hidden");

        try {
          const ext = (file.name.split(".").pop() || "png").toLowerCase();
          const path = `event-images/${
            currentUser.studentId
          }/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;

          console.log("ì—…ë¡œë“œ ê²½ë¡œ:", path);

          const ref = sRef(storage, path);
          const task = uploadBytesResumable(ref, file);

          await new Promise((resolve, reject) => {
            task.on(
              "state_changed",
              (snapshot) => {
                const progress =
                  (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log(`ì—…ë¡œë“œ ì§„í–‰ë¥ : ${progress.toFixed(2)}%`);
              },
              (error) => {
                console.error("ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
                reject(error);
              },
              () => {
                console.log("ì—…ë¡œë“œ ì™„ë£Œ");
                resolve();
              }
            );
          });

          const url = await getDownloadURL(task.snapshot.ref);
          console.log("ë‹¤ìš´ë¡œë“œ URL:", url);

          // DOM ìš”ì†Œ ì—…ë°ì´íŠ¸
          imageUrlField.value = url;
          previewImg.src = url;
          previewImg.classList.remove("hidden");
          dropzone.classList.add("hidden");

          showAlert("âœ…", "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!");
        } catch (err) {
          console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
          let errorMessage = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨. ";

          if (err.code === "storage/unauthorized") {
            errorMessage += "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
          } else if (err.code === "storage/network-request-failed") {
            errorMessage += "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          } else {
            errorMessage += "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          }

          showAlert("ğŸ˜¥", errorMessage);
        } finally {
          overlay.classList.add("hidden");
        }
      }

      /* ===== íšŒì› í”„ë¡œí•„ ì¡°íšŒ(ì‹ ì²­ ì •ë³´ í’ë¶€í™”) ===== */
      async function getCurrentMemberProfile() {
        try {
          if (!currentUser?.studentId) return {};
          const snap = await getDoc(doc(db, "members", currentUser.studentId));
          return snap.exists() ? snap.data() || {} : {};
        } catch {
          return {};
        }
      }
      function pickProfileFields(p = {}) {
        return {
          gender: p.gender || "",
          year: p.year || "",
          college: p.college || "",
          department: p.department || "",
          phone: p.phone || "",
        };
      }

      /* ===== ì‹ ì²­ ë¡œì§ ===== */
      async function reserveGeneral(id) {
        if (!currentUser) return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="reserve-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì‹ ì²­ ì¤‘...';
        }

        const prof = pickProfileFields(await getCurrentMemberProfile());
        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            if (!snap.exists()) throw new Error("not found");
            const ev = snap.data();
            ev.applicants ??= [];
            ev.waiting ??= [];
            if (isUserIn([...ev.applicants, ...ev.waiting])) return;
            const entry = {
              ...currentUser,
              ...prof,
              timestamp: new Date().toISOString(),
            };
            const lim = parseInt(ev.limit || 0, 10) || 0;
            if (lim === 0 || ev.applicants.length < lim)
              ev.applicants.push(entry);
            else ev.waiting.push(entry);
            tx.update(ref, { applicants: ev.applicants, waiting: ev.waiting });
          });
          showAlert("âœ…", "ì‹ ì²­ ì™„ë£Œ!");
        } catch {
          showAlert("ğŸ˜¥", "ì‹ ì²­ ì‹¤íŒ¨");
        } finally {
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelGeneral(id) {
        if (!currentUser) return;

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="cancel-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì·¨ì†Œ ì¤‘...';
        }

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.applicants ??= [];
            ev.waiting ??= [];
            const before = ev.applicants.length;
            ev.applicants = ev.applicants.filter(
              (p) => p.studentId !== currentUser.studentId
            );
            if (ev.applicants.length < before) {
              if (ev.waiting.length > 0) ev.applicants.push(ev.waiting.shift());
            } else
              ev.waiting = ev.waiting.filter(
                (p) => p.studentId !== currentUser.studentId
              );
            tx.update(ref, { applicants: ev.applicants, waiting: ev.waiting });
          });
          showAlert("ğŸ—‘ï¸", "ì‹ ì²­ ì·¨ì†Œë¨");
        } catch {
          showAlert("ğŸ˜¥", "ì·¨ì†Œ ì‹¤íŒ¨");
        } finally {
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelWaitGeneral(id) {
        if (!currentUser) return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="cancel-wait-general"][data-id="${id}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì·¨ì†Œ ì¤‘...';
        }

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.waiting ??= [];
            ev.waiting = ev.waiting.filter(
              (p) => p.studentId !== currentUser.studentId
            );
            tx.update(ref, { waiting: ev.waiting });
          });
          showAlert("ğŸ—‘ï¸", "ëŒ€ê¸° ì·¨ì†Œë¨");
        } catch {
          showAlert("ğŸ˜¥", "ì·¨ì†Œ ì‹¤íŒ¨");
        } finally {
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function reserveTasting(id, rid) {
        if (!currentUser) return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="reserve-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì‹ ì²­ ì¤‘...';
        }

        const prof = pickProfileFields(await getCurrentMemberProfile());
        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.restaurants ??= [];
            const already = ev.restaurants.some((r) =>
              (r.reservations || [])
                .concat(r.waiting || [])
                .some((p) => p.studentId === currentUser.studentId)
            );
            if (already) throw new Error("DUP");
            const idx = ev.restaurants.findIndex((r) => r.id === rid);
            if (idx === -1) throw new Error("restaurant not found");
            const r = ev.restaurants[idx];
            r.reservations ??= [];
            r.waiting ??= [];
            const cap = r.capacity ?? ev.limit ?? 0;
            const entry = {
              ...currentUser,
              ...prof,
              timestamp: new Date().toISOString(),
            };
            if (r.reservations.length < cap) r.reservations.push(entry);
            else r.waiting.push(entry);
            ev.restaurants[idx] = r;
            tx.update(ref, { restaurants: ev.restaurants });
          });
          showAlert("âœ…", "ì‹ ì²­ ì™„ë£Œ!");
        } catch (e) {
          if (String(e?.message).includes("DUP"))
            showAlert(
              "ğŸ™‚",
              "ì´ë¯¸ ë‹¤ë¥¸ ì‹ë‹¹ì— ì‹ ì²­(ë˜ëŠ” ëŒ€ê¸°)ë˜ì–´ ìˆì–´ìš”.<br><b>í•œ ë²ˆì— í•œ ì‹ë‹¹ë§Œ</b> ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            );
          else showAlert("ğŸ˜¥", "ì‹ ì²­ ì‹¤íŒ¨");
        } finally {
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelTasting(id, rid) {
        if (!currentUser) return;

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="cancel-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì·¨ì†Œ ì¤‘...';
        }

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.restaurants ??= [];
            const idx = ev.restaurants.findIndex((r) => r.id === rid);
            if (idx === -1) throw new Error("restaurant not found");
            const r = ev.restaurants[idx];
            r.reservations ??= [];
            r.waiting ??= [];
            const before = r.reservations.length;
            r.reservations = r.reservations.filter(
              (p) => p.studentId !== currentUser.studentId
            );
            if (r.reservations.length < before) {
              if (r.waiting.length > 0) r.reservations.push(r.waiting.shift());
            } else
              r.waiting = r.waiting.filter(
                (p) => p.studentId !== currentUser.studentId
              );
            ev.restaurants[idx] = r;
            tx.update(ref, { restaurants: ev.restaurants });
          });
          showAlert("ğŸ—‘ï¸", "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ì·¨ì†Œ ì‹¤íŒ¨");
        } finally {
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }
      async function cancelWaitTasting(id, rid) {
        if (!currentUser) return showAlert("ğŸ˜¥", "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        const button = document.querySelector(
          `button[data-act="cancel-wait-tasting"][data-id="${id}"][data-rid="${rid}"]`
        );
        const originalText = button ? button.innerHTML : "";
        if (button) {
          button.disabled = true;
          button.innerHTML =
            '<i class="fas fa-spinner fa-spin mr-2"></i>ì·¨ì†Œ ì¤‘...';
        }

        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "events", id);
            const snap = await tx.get(ref);
            const ev = snap.data();
            ev.restaurants ??= [];
            const idx = ev.restaurants.findIndex((r) => r.id === rid);
            if (idx === -1) throw new Error("restaurant not found");
            const r = ev.restaurants[idx];
            r.waiting ??= [];
            r.waiting = r.waiting.filter(
              (p) => p.studentId !== currentUser.studentId
            );
            ev.restaurants[idx] = r;
            tx.update(ref, { restaurants: ev.restaurants });
          });
          showAlert("ğŸ—‘ï¸", "ëŒ€ê¸° ì·¨ì†Œë¨");
        } catch {
          showAlert("ğŸ˜¥", "ì·¨ì†Œ ì‹¤íŒ¨");
        } finally {
          if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
          }
        }
      }

      /* ===== ìë™ ê¸€ ì˜¬ë¦¬ê¸° ê¸°ëŠ¥ ===== */
      async function scheduleAutoPost(
        type,
        title,
        datetime,
        customPostTime = null
      ) {
        try {
          // ê²Œì‹œ ì‹œê°„ ê²°ì •
          let postTime;
          if (customPostTime) {
            // ì‚¬ìš©ìê°€ ì§ì ‘ ì„¤ì •í•œ ì‹œê°„ ì‚¬ìš©
            postTime = new Date(customPostTime);
          } else {
            // ì´ë²¤íŠ¸ ì‹œê°„ 24ì‹œê°„ ì „ì— ì•Œë¦¼ ê¸€ ì˜¬ë¦¬ê¸°
            const eventTime = new Date(datetime);
            postTime = new Date(eventTime.getTime() - 24 * 60 * 60 * 1000); // 24ì‹œê°„ ì „
          }

          const now = new Date();

          // ê²Œì‹œ ì‹œê°„ ê²€ì¦ì€ ì•„ë˜ì—ì„œ ì²˜ë¦¬

          // ê²Œì‹œê¸€ ë‚´ìš© ìƒì„±
          const typeLabel =
            {
              tasting: "ë¯¸ì‹íšŒ",
              general: "ì¼ë°˜ ì´ë²¤íŠ¸",
              mt: "MT",
              assembly: "ì´íšŒ",
            }[type] || type;

          const postContent = `ğŸ½ï¸ ${typeLabel} ì•Œë¦¼ ğŸ½ï¸
 
ğŸ“… ì¼ì‹œ: ${eventTime.toLocaleString("ko-KR")}
ğŸ“ ì œëª©: ${title}
 
ê³§ ì‹ ì²­ì´ ì‹œì‘ë©ë‹ˆë‹¤! 
ë§ì€ ì°¸ì—¬ ë¶€íƒë“œë ¤ìš”~ ğŸ˜Š
 
#Foodie #${typeLabel}`;

          // ìë™ ê¸€ ì˜¬ë¦¬ê¸° ìŠ¤ì¼€ì¤„ ì €ì¥
          await addDoc(collection(db, "scheduledPosts"), {
            eventType: type,
            eventTitle: title,
            eventTime: datetime,
            postTime: postTime.toISOString(),
            content: postContent,
            status: "scheduled", // scheduled, posted, cancelled
            createdAt: new Date(),
            createdBy: currentUser?.studentId || "system",
          });

          // ê²Œì‹œ ì‹œê°„ì´ í˜„ì¬ ì‹œê°„ë³´ë‹¤ ì´ì „ì´ë©´ ì¦‰ì‹œ ê²Œì‹œ
          if (postTime <= now) {
            console.log(
              "ê²Œì‹œ ì‹œê°„ì´ í˜„ì¬ ì‹œê°„ë³´ë‹¤ ì´ì „ì´ë¯€ë¡œ ì¦‰ì‹œ ê²Œì‹œí•©ë‹ˆë‹¤."
            );
            await scheduleActualPost(postTime, postContent);
          } else {
            console.log(
              `ìë™ ê¸€ ì˜¬ë¦¬ê¸°ê°€ ${postTime.toLocaleString(
                "ko-KR"
              )}ì— ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.`
            );

            // ì‹¤ì œ ê¸€ ì˜¬ë¦¬ê¸° ìŠ¤ì¼€ì¤„ë§ (setTimeout ì‚¬ìš©)
            const delay = postTime.getTime() - now.getTime();
            setTimeout(async () => {
              await scheduleActualPost(postTime, postContent);
            }, delay);
          }
        } catch (error) {
          console.error("ìë™ ê¸€ ì˜¬ë¦¬ê¸° ìŠ¤ì¼€ì¤„ë§ ì˜¤ë¥˜:", error);
          // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì´ë²¤íŠ¸ ìƒì„±ì€ ê³„ì† ì§„í–‰
        }
      }

      // ì‹¤ì œ ê¸€ ì˜¬ë¦¬ê¸° í•¨ìˆ˜ (ì¦‰ì‹œ ì‹¤í–‰)
      async function scheduleActualPost(postTime, content) {
        try {
          await postAnnouncement(content);
          console.log("ìë™ ê¸€ ì˜¬ë¦¬ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("ìë™ ê¸€ ì˜¬ë¦¬ê¸° ì‹¤í–‰ ì˜¤ë¥˜:", error);
        }
      }

      // ê³µì§€ì‚¬í•­ ê²Œì‹œ í•¨ìˆ˜
      async function postAnnouncement(content) {
        try {
          // ê³µì§€ì‚¬í•­ ë¸”ë¡ ìƒì„±
          const announcementBlock = {
            type: "announcement",
            title: "ğŸ“¢ ê³µì§€ì‚¬í•­",
            content: content,
            createdAt: new Date(),
            createdBy: currentUser?.studentId || "system",
            isAuto: true, // ìë™ ìƒì„±ëœ ê³µì§€ì‚¬í•­ í‘œì‹œ
            order: 999, // ë§¨ ìœ„ì— í‘œì‹œ
          };

          // Firebaseì— ì €ì¥
          const docRef = await addDoc(
            collection(db, "homeLayout"),
            announcementBlock
          );

          console.log("ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤:", docRef.id);

          // blocksDataì— ì¶”ê°€
          if (!blocksData) blocksData = [];
          blocksData.push(announcementBlock);

          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
          renderAll();

          // ì„±ê³µ ì•Œë¦¼
          showAlert("ğŸ“¢", "ì•Œë¦¼ ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!");
        } catch (error) {
          console.error("ê³µì§€ì‚¬í•­ ê²Œì‹œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ê³µì§€ì‚¬í•­ ê²Œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          throw error;
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜ˆì•½ëœ ê¸€ë“¤ í™•ì¸ ë° ì‹¤í–‰
      function checkScheduledPosts() {
        if (!currentUser || !adminList.includes(currentUser.studentId)) return;

        // í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆì•½ëœ ê¸€ë“¤ í™•ì¸
        const now = new Date();

        // Firebaseì—ì„œ scheduledPosts í™•ì¸ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” onSnapshot ì‚¬ìš©)
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ localStorageë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ˆì‹œ
        const scheduledPosts = JSON.parse(
          localStorage.getItem("scheduledPosts") || "[]"
        );

        scheduledPosts.forEach((post) => {
          const postTime = new Date(post.postTime);
          if (post.status === "scheduled" && postTime <= now) {
            scheduleActualPost(postTime, post.content);
          }
        });
      }

      /* ===== ì´ë²¤íŠ¸ ì €ì¥/ë³´ê´€/ì‚­ì œ/ì¬ê²Œì‹œ ===== */
      async function createOrSaveEvent() {
        const type = document.getElementById("event-type").value;
        const title = document.getElementById("event-title").value.trim();
        const datetime = document.getElementById("event-datetime").value;
        const deadline = document.getElementById("event-deadline").value;
        const limit =
          parseInt(document.getElementById("event-limit").value, 10) || 0;
        const status = document.getElementById("event-status").value;
        if (!type || !title || !datetime || !deadline || !limit)
          return showAlert(
            "ğŸ˜¥",
            "íƒ€ì…/ì œëª©/ì‹¤ì‹œì¼/ë§ˆê°ì¼/ì •ì›ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."
          );

        let payment = null;
        if (type === "mt" || type === "assembly") {
          const b = document.getElementById("pay-bank").value.trim();
          const n = document.getElementById("pay-number").value.trim();
          const h = document.getElementById("pay-holder").value.trim();
          const note = document.getElementById("pay-note").value.trim();
          const d = duesSettings || {};
          payment = {
            bank: b || d.bank || "",
            number: n || d.number || "",
            holder: h || d.holder || "",
            note:
              note ||
              (d.amount ? `íšŒë¹„ ${formatKRW(d.amount)} ` : "") + (d.note || ""),
          };
        }
        try {
          if (!editingEventId) {
            if (type === "tasting") {
              const rows = [
                ...document.querySelectorAll(
                  "#event-restaurants-wrap .restaurant-row"
                ),
              ];
              const restaurants = rows
                .map((row) => ({
                  id: row.getAttribute("data-id"),
                  name: row.querySelector("[data-field='name']").value.trim(),
                  info: row.querySelector("[data-field='info']").value.trim(),
                  imageUrl:
                    row
                      .querySelector("[data-field='imageUrl']")
                      ?.value.trim() || "",
                  capacity:
                    parseInt(
                      row.querySelector("[data-field='capacity']").value,
                      10
                    ) || limit,
                  category:
                    row.querySelector("[data-field='category']")?.value ||
                    "ê¸°íƒ€",
                  reservations: [],
                  waiting: [],
                }))
                .filter((r) => r.name && r.capacity > 0);
              if (restaurants.length === 0)
                return showAlert("ğŸ˜¥", "ì‹ë‹¹ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
              await addDoc(collection(db, "events"), {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                restaurants,
              });
            } else {
              const base = {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                applicants: [],
                waiting: [],
              };
              if (payment) base.payment = payment;
              await addDoc(collection(db, "events"), base);
            }
            showAlert("ğŸ‰", "ì´ë²¤íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // ìë™ ê¸€ ì˜¬ë¦¬ê¸° ê¸°ëŠ¥
            const enableAutoPost =
              document.getElementById("enable-auto-post")?.checked;
            if (enableAutoPost) {
              const postTimeType = document.querySelector(
                'input[name="post-time-type"]:checked'
              )?.value;
              let customPostTime = null;

              if (postTimeType === "custom") {
                const postDatetime =
                  document.getElementById("post-datetime")?.value;
                if (postDatetime) {
                  customPostTime = postDatetime;
                }
              }

              await scheduleAutoPost(type, title, datetime, customPostTime);
            }

            closeEventModal();
            // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì „ì²´ í˜ì´ì§€ ë Œë”ë§)
            renderAll();
          } else {
            const ref = doc(db, "events", editingEventId);
            const snap = await getDoc(ref);
            if (!snap.exists()) throw new Error("not found");
            const prev = snap.data();
            if (type === "tasting") {
              const map = new Map(
                (prev.restaurants || []).map((r) => [r.id, r])
              );
              const rows = [
                ...document.querySelectorAll(
                  "#event-restaurants-wrap .restaurant-row"
                ),
              ];
              const restaurants = rows
                .map((row) => {
                  const idAttr = row.getAttribute("data-id");
                  const old = map.get(idAttr);
                  return {
                    id: idAttr,
                    name: row.querySelector("[data-field='name']").value.trim(),
                    info: row.querySelector("[data-field='info']").value.trim(),
                    imageUrl:
                      row
                        .querySelector("[data-field='imageUrl']")
                        ?.value.trim() || "",
                    capacity:
                      parseInt(
                        row.querySelector("[data-field='capacity']").value,
                        10
                      ) || limit,
                    reservations: old?.reservations || [],
                    waiting: old?.waiting || [],
                  };
                })
                .filter((r) => r.name && r.capacity > 0);
              await updateDoc(ref, {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
                restaurants,
              });
            } else {
              const payload = {
                type,
                title,
                datetime,
                deadline,
                limit,
                status,
              };
              if (payment) payload.payment = payment;
              await updateDoc(ref, payload);
            }
            showAlert("âœ…", "ì´ë²¤íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeEventModal();
            // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì „ì²´ í˜ì´ì§€ ë Œë”ë§)
            renderAll();
          }
          resetEventForm();
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", `ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
      }
      function resetEventForm() {
        editingEventId = null;
        const t = document.getElementById("event-type");
        if (t) t.value = "tasting";
        [
          "event-title",
          "event-datetime",
          "event-deadline",
          "event-limit",
          "pay-bank",
          "pay-number",
          "pay-holder",
          "pay-note",
        ].forEach((i) => {
          const x = document.getElementById(i);
          if (x) x.value = "";
        });
        const st = document.getElementById("event-status");
        if (st) st.value = "open";
        document.getElementById("tasting-fields").classList.remove("hidden");
        document.getElementById("payment-fields").classList.add("hidden");
        const wrap = document.getElementById("event-restaurants-wrap");
        if (wrap) wrap.innerHTML = restaurantFieldHTML();
      }
      async function closeEvent(id) {
        if (
          !confirm(
            "ì´ë²¤íŠ¸ ì‹ ì²­ì„ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në§ˆê°ëœ ì´ë²¤íŠ¸ëŠ”:\nâ€¢ ì‹ ì²­ íƒ­ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤\nâ€¢ í™œë™ íƒ­ì—ì„œ ì°¸ê°€ìë“¤ì´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤\nâ€¢ í‰ì ì„ ë§¤ê¸¸ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            status: "closed",
            deadline: null, // ë§ˆê°ì¼ ì •ë³´ ì´ˆê¸°í™”
            closedAt: new Date().toISOString(),
          });
          showAlert(
            "âœ…",
            "ì´ë²¤íŠ¸ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. í™œë™ íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          );
        } catch {
          showAlert("ğŸ˜¥", "ë§ˆê° ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      }
      async function reopenEvent(id) {
        if (
          !confirm(
            "ë§ˆê°ëœ ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ì—´ì–´ ì‹ ì²­ì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì‹ ì²­ íƒ­ì— ë‹¤ì‹œ í‘œì‹œë©ë‹ˆë‹¤\nâ€¢ íšŒì›ë“¤ì´ ë‹¤ì‹œ ì‹ ì²­í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            status: "open",
            reopenedAt: new Date().toISOString(),
          });
          showAlert(
            "âœ…",
            "ì´ë²¤íŠ¸ê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤. ì‹ ì²­ íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          );
        } catch {
          showAlert("ğŸ˜¥", "ë‹¤ì‹œ ì—´ê¸° ì‹¤íŒ¨");
        }
      }

      async function unpostEvent(id) {
        if (
          !confirm(
            "ì´ ì´ë²¤íŠ¸ì˜ ê³µì§€ì‚¬í•­ì„ ë‚´ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ê´€ë ¨ ê³µì§€ì‚¬í•­ì´ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤\nâ€¢ íšŒì›ë“¤ì´ ê³µì§€ì‚¬í•­ì„ ë³¼ ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          // ì´ë²¤íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const eventDoc = await getDoc(doc(db, "events", id));
          if (!eventDoc.exists()) {
            showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const eventData = eventDoc.data();
          const eventTitle = eventData.title;
          let foundAnnouncement = false;

          // 1. scheduledPosts ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì™€ ê´€ë ¨ëœ ì˜ˆì•½ëœ ê¸€ ì°¾ê¸°
          const scheduledPostsSnapshot = await getDocs(
            collection(db, "scheduledPosts")
          );
          for (const postDoc of scheduledPostsSnapshot.docs) {
            const postData = postDoc.data();
            if (
              postData.eventTitle === eventTitle &&
              postData.status !== "cancelled"
            ) {
              // ì˜ˆì•½ëœ ê¸€ì„ ì·¨ì†Œ ìƒíƒœë¡œ ë³€ê²½
              await updateDoc(doc(db, "scheduledPosts", postDoc.id), {
                status: "cancelled",
                cancelledAt: new Date().toISOString(),
                cancelledBy: currentUser?.studentId || "unknown",
              });
              foundAnnouncement = true;
            }
          }

          // 2. ê³µì§€ì‚¬í•­ ë¸”ë¡ì—ì„œ í•´ë‹¹ ì´ë²¤íŠ¸ì™€ ê´€ë ¨ëœ ê³µì§€ì‚¬í•­ ì°¾ê¸°
          const blocksSnapshot = await getDocs(collection(db, "blocks"));
          for (const blockDoc of blocksSnapshot.docs) {
            const blockData = blockDoc.data();
            if (
              blockData.type === "announcement" &&
              blockData.payload &&
              blockData.payload.content &&
              blockData.payload.content.includes(eventTitle) &&
              blockData.visible !== false
            ) {
              // ê³µì§€ì‚¬í•­ ë¸”ë¡ì„ ìˆ¨ê¹€ ì²˜ë¦¬
              await updateDoc(doc(db, "blocks", blockDoc.id), {
                visible: false,
                unpostedAt: new Date().toISOString(),
                unpostedBy: currentUser?.studentId || "unknown",
              });
              foundAnnouncement = true;
            }
          }

          if (foundAnnouncement) {
            showAlert("âœ…", "ê³µì§€ì‚¬í•­ì´ ë‚´ë ¤ì¡ŒìŠµë‹ˆë‹¤.");
          } else {
            showAlert("â„¹ï¸", "ì´ ì´ë²¤íŠ¸ì™€ ê´€ë ¨ëœ ê³µì§€ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("ê¸€ ë‚´ë¦¬ê¸° ì‹¤íŒ¨:", error);
          showAlert("ğŸ˜¥", "ê¸€ ë‚´ë¦¬ê¸° ì‹¤íŒ¨");
        }
      }
      async function archiveEvent(id) {
        try {
          await updateDoc(doc(db, "events", id), { status: "archived" });
          showAlert("ğŸ“¦", "ë³´ê´€(ìˆ¨ê¹€) ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ë³´ê´€ ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      }

      async function confirmActivity(id) {
        if (
          !confirm(
            "ì´ í™œë™ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì°¸ê°€ìë“¤ì—ê²Œ í™•ì • ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤\nâ€¢ í™œë™ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œëœ ê²ƒìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            activityStatus: "confirmed",
            confirmedAt: new Date().toISOString(),
            confirmedBy: currentUser?.studentId || "unknown",
          });
          showAlert("âœ…", "í™œë™ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("í™œë™ í™•ì • ì‹¤íŒ¨:", error);
          showAlert("ğŸ˜¥", "í™œë™ í™•ì • ì‹¤íŒ¨");
        }
      }

      async function cancelActivity(id) {
        if (
          !confirm(
            "ì´ í™œë™ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ì°¸ê°€ìë“¤ì—ê²Œ ì·¨ì†Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤\nâ€¢ í™˜ë¶ˆ ë“±ì˜ í›„ì† ì¡°ì¹˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
          )
        ) {
          return;
        }
        try {
          await updateDoc(doc(db, "events", id), {
            activityStatus: "cancelled",
            cancelledAt: new Date().toISOString(),
            cancelledBy: currentUser?.studentId || "unknown",
          });
          showAlert("âŒ", "í™œë™ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("í™œë™ ì·¨ì†Œ ì‹¤íŒ¨:", error);
          showAlert("ğŸ˜¥", "í™œë™ ì·¨ì†Œ ì‹¤íŒ¨");
        }
      }

      // ìë™ ì‹ ì²­ ë§ˆê° ê¸°ëŠ¥
      async function autoCloseExpiredEvents() {
        try {
          const now = new Date();
          const eventsSnapshot = await getDocs(collection(db, "events"));

          const expiredEvents = [];

          for (const eventDoc of eventsSnapshot.docs) {
            const eventData = eventDoc.data();

            // ì´ë¯¸ ë§ˆê°ëœ ì´ë²¤íŠ¸ëŠ” ì œì™¸
            if (
              eventData.status === "closed" ||
              eventData.status === "archived"
            ) {
              continue;
            }

            // ë§ˆê°ì¼ì´ ì„¤ì •ë˜ì–´ ìˆê³ , í˜„ì¬ ì‹œê°„ì´ ë§ˆê°ì¼ì„ ì§€ë‚¬ìœ¼ë©´ ë§ˆê° ì²˜ë¦¬
            if (eventData.deadline) {
              const deadline = new Date(eventData.deadline);
              if (deadline < now) {
                expiredEvents.push({
                  id: eventDoc.id,
                  title: eventData.title,
                  deadline: eventData.deadline,
                });
              }
            }
          }

          // ë§ˆê°ì¼ì´ ì§€ë‚œ ì´ë²¤íŠ¸ë“¤ì„ ìë™ ë§ˆê° ì²˜ë¦¬
          for (const event of expiredEvents) {
            await updateDoc(doc(db, "events", event.id), {
              status: "closed",
              deadline: null, // ë§ˆê°ì¼ ì •ë³´ ì´ˆê¸°í™”
              autoClosedAt: new Date().toISOString(),
              autoClosedReason: "deadline_expired",
            });

            console.log(
              `ìë™ ë§ˆê° ì²˜ë¦¬: ${event.title} (ë§ˆê°ì¼: ${new Date(
                event.deadline
              ).toLocaleString("ko-KR")})`
            );
          }

          if (expiredEvents.length > 0) {
            console.log(
              `ì´ ${expiredEvents.length}ê°œì˜ ì´ë²¤íŠ¸ê°€ ìë™ ë§ˆê° ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`
            );
            // ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            if (isFullAdmin()) {
              showAlert(
                "â°",
                `${expiredEvents.length}ê°œì˜ ì´ë²¤íŠ¸ê°€ ë§ˆê°ì¼ ë„ê³¼ë¡œ ìë™ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.`
              );
            }
          }
        } catch (error) {
          console.error("ìë™ ë§ˆê° ì²˜ë¦¬ ì‹¤íŒ¨:", error);
        }
      }

      // ìë™ ë§ˆê° ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •
      function setupAutoCloseScheduler() {
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
        autoCloseExpiredEvents();

        // 1ë¶„ë§ˆë‹¤ ì²´í¬ (ì‹¤ì‹œê°„ì„± í™•ë³´)
        setInterval(autoCloseExpiredEvents, 60 * 1000);

        // ë§¤ ì‹œê°„ ì •ê°ì— ì²´í¬ (ì •í™•ì„± í™•ë³´)
        const now = new Date();
        const minutesUntilNextHour = 60 - now.getMinutes();
        const secondsUntilNextHour =
          minutesUntilNextHour * 60 - now.getSeconds();

        setTimeout(() => {
          autoCloseExpiredEvents();
          // ì´í›„ ë§¤ ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
          setInterval(autoCloseExpiredEvents, 60 * 60 * 1000);
        }, secondsUntilNextHour * 1000);

        console.log("ìë™ ì‹ ì²­ ë§ˆê° ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
      async function deleteEvent(id) {
        if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ì–´ìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."))
          return;
        try {
          await deleteDoc(doc(db, "events", id));
          showAlert("ğŸ—‘ï¸", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ì „ì²´ í˜ì´ì§€ ë Œë”ë§)
          renderAll();
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ì‚­ì œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", `ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
      }
      // ì¡°ì§œê¸° ëª¨ë‹¬ ì—´ê¸°
      async function openGroupMakerModal(eventId) {
        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) return showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          // ì°¸ê°€ì ë°ì´í„° ìˆ˜ì§‘
          let participants = [];
          if (ev.type === "tasting") {
            (ev.restaurants || []).forEach((r) => {
              (r.reservations || []).forEach((p) => {
                participants.push({
                  name: p.name || "",
                  studentId: p.studentId || "",
                  gender: p.gender || "",
                  year: p.year || "",
                  college: p.college || "",
                  department: p.department || "",
                  phone: p.phone || "",
                });
              });
            });
          } else {
            (ev.applicants || []).forEach((p) => {
              participants.push({
                name: p.name || "",
                studentId: p.studentId || "",
                gender: p.gender || "",
                year: p.year || "",
                college: p.college || "",
                department: p.department || "",
                phone: p.phone || "",
              });
            });
          }

          if (participants.length === 0) {
            return showAlert("ğŸ˜¥", "ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.");
          }

          // ì¡°ì§œê¸° ëª¨ë‹¬ ìƒì„±
          const modalHTML = `
            <div id="group-maker-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-bold text-gray-800">ì¡°ì§œê¸° ì„¤ì •</h3>
                  <button type="button" id="group-maker-close" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
                
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                  <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    ì´ <strong>${
                      participants.length
                    }ëª…</strong>ì˜ ì°¸ê°€ìê°€ ìˆìŠµë‹ˆë‹¤.
                  </p>
                </div>

                <div class="space-y-4">
                  <!-- ì¡° ê°œìˆ˜ ì„¤ì • -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-layer-group mr-2 text-blue-600"></i>ì¡° ê°œìˆ˜
                    </label>
                    <div class="relative">
                      <input type="number" id="group-count" min="1" max="${
                        participants.length
                      }" value="1" 
                             class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-lg font-semibold">
                      <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                        <span class="text-gray-500 text-sm">ê°œ</span>
                      </div>
                    </div>
                  </div>

                  <!-- ë‚¨ë…€ë¹„ìœ¨ ì„¤ì • -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-venus-mars mr-2 text-pink-600"></i>ë‚¨ë…€ë¹„ìœ¨
                    </label>
                    <div class="grid grid-cols-1 gap-3">
                      <label class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors cursor-pointer">
                        <input type="radio" name="gender-ratio" value="balanced" checked class="mr-3 text-green-600 focus:ring-green-500">
                        <i class="fas fa-balance-scale mr-2 text-green-600"></i>
                        <span class="font-medium">ê· ë“± ë°°ë¶„</span>
                        <span class="ml-auto text-xs text-green-600">ë‚¨ë…€ ë¹„ìœ¨ì„ ê³ ë ¤í•´ì„œ ì¡°ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤</span>
                      </label>
                      <label class="flex items-center p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors cursor-pointer">
                        <input type="radio" name="gender-ratio" value="mixed" class="mr-3 text-blue-600 focus:ring-blue-500">
                        <i class="fas fa-random mr-2 text-blue-600"></i>
                        <span class="font-medium">ë¬´ì‘ìœ„ ì„ê¸°</span>
                        <span class="ml-auto text-xs text-blue-600">ì„±ë³„ì„ ë¬´ì‘ìœ„ë¡œ ì„ì–´ì„œ ë°°ì •í•©ë‹ˆë‹¤</span>
                      </label>
                      <label class="flex items-center p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
                        <input type="radio" name="gender-ratio" value="ignore" class="mr-3 text-gray-600 focus:ring-gray-500">
                        <i class="fas fa-users mr-2 text-gray-600"></i>
                        <span class="font-medium">ì„±ë³„ ë¬´ê´€</span>
                        <span class="ml-auto text-xs text-gray-600">ì„±ë³„ì„ ê³ ë ¤í•˜ì§€ ì•Šê³  ë°°ì •í•©ë‹ˆë‹¤</span>
                      </label>
                    </div>
                  </div>

                  <!-- ë‹¨ê³¼ëŒ€ë³„ ì„ê¸° ì„¤ì • -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-university mr-2 text-purple-600"></i>ë‹¨ê³¼ëŒ€ë³„ ë¶„ë°°
                    </label>
                    <div class="grid grid-cols-1 gap-3">
                      <label class="flex items-center p-3 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors cursor-pointer">
                        <input type="radio" name="college-mix" value="mixed" checked class="mr-3 text-purple-600 focus:ring-purple-500">
                        <i class="fas fa-shuffle mr-2 text-purple-600"></i>
                        <span class="font-medium">ë‹¨ê³¼ëŒ€ë³„ë¡œ ê³ ë¥´ê²Œ ë¶„ë°°</span>
                        <span class="ml-auto text-xs text-purple-600">ê° ë‹¨ê³¼ëŒ€ê°€ ê³¨ê³ ë£¨ ì„ì´ë„ë¡ ë°°ì •í•©ë‹ˆë‹¤</span>
                      </label>
                      <label class="flex items-center p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
                        <input type="radio" name="college-mix" value="ignore" class="mr-3 text-gray-600 focus:ring-gray-500">
                        <i class="fas fa-random mr-2 text-gray-600"></i>
                        <span class="font-medium">ë‹¨ê³¼ëŒ€ ìƒê´€ì—†ì´ ë¬´ì‘ìœ„</span>
                        <span class="ml-auto text-xs text-gray-600">ë‹¨ê³¼ëŒ€ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šê³  ë¬´ì‘ìœ„ë¡œ ë°°ì •í•©ë‹ˆë‹¤</span>
                      </label>
                    </div>
                  </div>

                  <!-- ì¡°ì¥ ì„¤ì • (ê´€ë¦¬ìë§Œ) -->
                  ${
                    currentUser && adminList.includes(currentUser.studentId)
                      ? `
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-crown mr-2 text-yellow-600"></i>ì¡°ì¥ ì„¤ì •
                    </label>
                    <div class="space-y-3">
                      <div class="grid grid-cols-1 gap-3">
                        <label class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg hover:bg-yellow-100 transition-colors cursor-pointer">
                          <input type="radio" name="leader-setting" value="manual" checked class="mr-3 text-yellow-600 focus:ring-yellow-500">
                          <i class="fas fa-hand-pointer mr-2 text-yellow-600"></i>
                          <span class="font-medium">ìˆ˜ë™ ì„ íƒ</span>
                          <span class="ml-auto text-xs text-yellow-600">ê° ì¡°ì˜ ì¡°ì¥ì„ ì§ì ‘ ì„ íƒí•©ë‹ˆë‹¤</span>
                        </label>
                        <label class="flex items-center p-3 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 transition-colors cursor-pointer">
                          <input type="radio" name="leader-setting" value="auto" class="mr-3 text-orange-600 focus:ring-orange-500">
                          <i class="fas fa-magic mr-2 text-orange-600"></i>
                          <span class="font-medium">ìë™ ì„¤ì •</span>
                          <span class="ml-auto text-xs text-orange-600">í•™ë…„ì´ ë†’ì€ ìˆœìœ¼ë¡œ ìë™ ë°°ì •í•©ë‹ˆë‹¤</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer">
                          <input type="radio" name="leader-setting" value="none" class="mr-3 text-gray-600 focus:ring-gray-500">
                          <i class="fas fa-users mr-2 text-gray-600"></i>
                          <span class="font-medium">ì¡°ì¥ ì—†ìŒ</span>
                          <span class="ml-auto text-xs text-gray-600">ì¡°ì¥ì„ ì„¤ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span>
                        </label>
                      </div>
                      <div id="manual-leader-selection" class="space-y-3 mt-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                          <p class="text-sm text-blue-800 font-medium mb-2">
                            <i class="fas fa-info-circle mr-2"></i>ê° ì¡°ì˜ ì¡°ì¥ì„ ì„ íƒí•˜ì„¸ìš”
                          </p>
                          <div id="leader-selectors" class="space-y-2">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì¡°ì¥ ì„ íƒê¸°ë“¤ -->
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  `
                      : ""
                  }

                  <!-- ì°¸ê°€ì ë¯¸ë¦¬ë³´ê¸° (ê´€ë¦¬ìë§Œ) -->
                  ${
                    currentUser && adminList.includes(currentUser.studentId)
                      ? `
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì°¸ê°€ì ëª©ë¡</label>
                    <div class="max-h-32 overflow-y-auto border rounded-lg p-2 bg-gray-50">
                      <div class="grid grid-cols-2 gap-1 text-xs">
                        ${participants
                          .map(
                            (p) => `
                          <div class="flex justify-between">
                            <span>${p.name} (${p.studentId})</span>
                            <span class="text-gray-500">${p.gender}/${p.college}</span>
                          </div>
                        `
                          )
                          .join("")}
                      </div>
                    </div>
                  </div>
                  `
                      : ""
                  }
                </div>

                <div class="flex gap-3 mt-8">
                  <button type="button" id="group-maker-generate" 
                          class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 text-white py-3 px-6 rounded-xl hover:from-purple-700 hover:to-purple-800 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-2 font-bold">
                    <i class="fas fa-magic"></i>
                    <span>ì¡°ì§œê¸° ì‹œì‘!</span>
                  </button>
                  <button type="button" id="group-maker-cancel" 
                          class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 font-medium">
                    <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                  </button>
                </div>
              </div>
            </div>
          `;

          // ëª¨ë‹¬ ì¶”ê°€
          document.body.insertAdjacentHTML("beforeend", modalHTML);

          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          document
            .getElementById("group-maker-close")
            .addEventListener("click", closeGroupMakerModal);
          document
            .getElementById("group-maker-cancel")
            .addEventListener("click", closeGroupMakerModal);
          document
            .getElementById("group-maker-generate")
            .addEventListener("click", () => {
              generateGroups(eventId, participants);
            });

          // ì¡° ê°œìˆ˜ ë³€ê²½ ì‹œ ì¡°ì¥ ì„ íƒê¸° ì—…ë°ì´íŠ¸
          document
            .getElementById("group-count")
            .addEventListener("input", () => {
              updateLeaderSelectors(participants);
            });

          // ì¡°ì¥ ì„¤ì • ë°©ì‹ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
          document
            .querySelectorAll('input[name="leader-setting"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                updateLeaderSelectionVisibility();
              });
            });

          // ì´ˆê¸° ì¡°ì¥ ì„ íƒê¸° ìƒì„±
          updateLeaderSelectors(participants);
          updateLeaderSelectionVisibility();
        } catch (error) {
          console.error("ì¡°ì§œê¸° ëª¨ë‹¬ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì¡°ì§œê¸° ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
      }

      // ì¡°ì¥ ì„ íƒê¸° ì—…ë°ì´íŠ¸
      function updateLeaderSelectors(participants) {
        const groupCount =
          parseInt(document.getElementById("group-count").value) || 3;
        const container = document.getElementById("leader-selectors");

        container.innerHTML = "";

        for (let i = 1; i <= groupCount; i++) {
          const selectorHTML = `
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-gray-700 min-w-[40px]">${i}ì¡°:</label>
              <select class="leader-select flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-group="${i}">
                <option value="">ì¡°ì¥ ì„ íƒ</option>
                ${participants
                  .map(
                    (p) => `
                  <option value="${p.studentId}">${p.name} (${p.studentId}) - ${p.gender}/${p.college}</option>
                `
                  )
                  .join("")}
              </select>
            </div>
          `;
          container.insertAdjacentHTML("beforeend", selectorHTML);
        }
      }

      // ì¡°ì¥ ì„ íƒ UI í‘œì‹œ/ìˆ¨ê¹€
      function updateLeaderSelectionVisibility() {
        const leaderSetting = document.querySelector(
          'input[name="leader-setting"]:checked'
        ).value;
        const manualSelection = document.getElementById(
          "manual-leader-selection"
        );

        if (leaderSetting === "manual") {
          manualSelection.style.display = "block";
        } else {
          manualSelection.style.display = "none";
        }
      }

      // ì¡°ì§œê¸° ëª¨ë‹¬ ë‹«ê¸°
      function closeGroupMakerModal() {
        const modal = document.getElementById("group-maker-modal");
        if (modal) {
          modal.remove();
        }
      }

      // ì¡° ìƒì„±í•˜ê¸°
      async function generateGroups(eventId, participants) {
        try {
          const groupCount = parseInt(
            document.getElementById("group-count").value
          );
          const genderRatio = document.querySelector(
            'input[name="gender-ratio"]:checked'
          ).value;
          const collegeMix = document.querySelector(
            'input[name="college-mix"]:checked'
          ).value;
          const leaderSetting = document.querySelector(
            'input[name="leader-setting"]:checked'
          ).value;

          if (groupCount < 1 || groupCount > participants.length) {
            return showAlert("ğŸ˜¥", "ì¡° ê°œìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
          }

          // ìˆ˜ë™ ì¡°ì¥ ì„ íƒ ì •ë³´ ìˆ˜ì§‘
          let manualLeaders = {};
          if (leaderSetting === "manual") {
            document.querySelectorAll(".leader-select").forEach((select) => {
              const groupNum = parseInt(select.dataset.group);
              const studentId = select.value;
              if (studentId) {
                manualLeaders[groupNum] = studentId;
              }
            });
          }

          // ì¡° ìƒì„± ì•Œê³ ë¦¬ì¦˜
          const groups = createGroups(
            participants,
            groupCount,
            genderRatio,
            collegeMix,
            leaderSetting,
            manualLeaders
          );

          // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
          showGroupResults(eventId, groups, participants);
        } catch (error) {
          console.error("ì¡° ìƒì„± ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì¡° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì¡° ìƒì„± ì•Œê³ ë¦¬ì¦˜ - ê· í˜• ì¡íŒ ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
      function createGroups(
        participants,
        groupCount,
        genderRatio,
        collegeMix,
        leaderSetting,
        manualLeaders = {}
      ) {
        let groups = Array.from({ length: groupCount }, () => []);

        // ìˆ˜ë™ ì¡°ì¥ ì •ë³´ ë¯¸ë¦¬ ì„¤ì •
        if (leaderSetting === "manual") {
          Object.keys(manualLeaders).forEach((groupIndex) => {
            const leaderStudentId = manualLeaders[groupIndex];
            const leader = participants.find(
              (p) => p.studentId === leaderStudentId
            );
            if (leader) {
              leader.isLeader = true;
              leader.targetGroup = parseInt(groupIndex) - 1; // 0-based index
            }
          });
        }

        // ëª¨ë“  ì°¸ê°€ìë¥¼ ì¡°ê±´ì— í¬í•¨í•˜ì—¬ ê· í˜• ë°°ë¶„
        if (genderRatio === "balanced" && collegeMix === "mixed") {
          // ì„±ë³„ê³¼ ë‹¨ê³¼ëŒ€ë¥¼ ëª¨ë‘ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
          groups = balanceGroupsByAllFactorsWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else if (genderRatio === "balanced") {
          // ì„±ë³„ë§Œ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
          groups = balanceGroupsByGenderWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else if (collegeMix === "mixed") {
          // ë‹¨ê³¼ëŒ€ë§Œ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
          groups = balanceGroupsByCollegeWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        } else {
          // ë¬´ì‘ìœ„ ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
          groups = randomDistributionWithLeaders(
            participants,
            groups,
            groupCount,
            manualLeaders
          );
        }

        // ìë™ ì¡°ì¥ ì„¤ì •
        if (leaderSetting === "auto") {
          groups.forEach((group) => {
            if (group.length > 0 && !group.some((member) => member.isLeader)) {
              // í•™ë…„ì´ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì²« ë²ˆì§¸ë¥¼ ì¡°ì¥ìœ¼ë¡œ ì„¤ì •
              group.sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                return yearB - yearA;
              });
              group[0].isLeader = true;
            }
          });
        }

        // ì¡°ì¥ì„ ê° ì¡°ì˜ ë§¨ ì•ìœ¼ë¡œ ì´ë™
        groups.forEach((group) => {
          const leader = group.find((member) => member.isLeader);
          if (leader) {
            const leaderIndex = group.indexOf(leader);
            group.splice(leaderIndex, 1);
            group.unshift(leader);
          }
        });

        return groups;
      }

      // ì„±ë³„ê³¼ ë‹¨ê³¼ëŒ€ë¥¼ ëª¨ë‘ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
      function balanceGroupsByAllFactorsWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        // ì°¸ê°€ìë“¤ì„ ì„±ë³„ê³¼ ë‹¨ê³¼ëŒ€ë¡œ ë¶„ë¥˜ (ì¡°ì¥ í¬í•¨)
        const categorizedParticipants = {
          male: {},
          female: {},
          other: {},
        };

        participants.forEach((p) => {
          const gender =
            p.gender === "ë‚¨ì„±"
              ? "male"
              : p.gender === "ì—¬ì„±"
              ? "female"
              : "other";
          const college = p.college || "ê¸°íƒ€";

          if (!categorizedParticipants[gender][college]) {
            categorizedParticipants[gender][college] = [];
          }
          categorizedParticipants[gender][college].push(p);
        });

        // ê° ì„±ë³„-ë‹¨ê³¼ëŒ€ ì¡°í•©ì„ ìˆœí™˜í•˜ë©° ë°°ì¹˜
        let currentGroup = 0;
        const allCategories = [];

        // ëª¨ë“  ì„±ë³„-ë‹¨ê³¼ëŒ€ ì¡°í•©ì„ ìˆ˜ì§‘
        Object.keys(categorizedParticipants).forEach((gender) => {
          Object.keys(categorizedParticipants[gender]).forEach((college) => {
            const members = categorizedParticipants[gender][college];
            allCategories.push(...members.sort(() => Math.random() - 0.5));
          });
        });

        // ì „ì²´ë¥¼ ì„ê³  ìˆœí™˜ ë°°ì¹˜
        allCategories.sort(() => Math.random() - 0.5);
        allCategories.forEach((participant) => {
          // ì¡°ì¥ì€ ì§€ì •ëœ ì¡°ì— ë°°ì¹˜
          if (participant.isLeader && participant.targetGroup !== undefined) {
            groups[participant.targetGroup].push(participant);
          } else {
            groups[currentGroup].push(participant);
            currentGroup = (currentGroup + 1) % groupCount;
          }
        });

        return groups;
      }

      // ì„±ë³„ê³¼ ë‹¨ê³¼ëŒ€ë¥¼ ëª¨ë‘ ê³ ë ¤í•œ ê· í˜• ë°°ë¶„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
      function balanceGroupsByAllFactors(participants, groups, groupCount) {
        return balanceGroupsByAllFactorsWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // ì„±ë³„ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨) - ê°œì„ ëœ ì•Œê³ ë¦¬ì¦˜
      function balanceGroupsByGenderWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        // 1ë‹¨ê³„: ì¡°ì¥ë“¤ì˜ ì„±ë³„ ì •ë³´ë¥¼ ë¨¼ì € íŒŒì•…
        const leaderGenderInfo = {};
        participants.forEach((p) => {
          if (p.isLeader && p.targetGroup !== undefined) {
            const groupNum = p.targetGroup;
            if (!leaderGenderInfo[groupNum]) {
              leaderGenderInfo[groupNum] = { male: 0, female: 0, other: 0 };
            }
            if (p.gender === "ë‚¨ì„±") leaderGenderInfo[groupNum].male++;
            else if (p.gender === "ì—¬ì„±") leaderGenderInfo[groupNum].female++;
            else leaderGenderInfo[groupNum].other++;

            // ì¡°ì¥ì„ í•´ë‹¹ ì¡°ì— ë°°ì¹˜
            groups[groupNum].push(p);
          }
        });

        // 2ë‹¨ê³„: ë‚¨ì€ ì°¸ê°€ìë“¤ì„ ì„±ë³„ë³„ë¡œ ë¶„ë¥˜
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const males = remainingParticipants
          .filter((p) => p.gender === "ë‚¨ì„±")
          .sort(() => Math.random() - 0.5);
        const females = remainingParticipants
          .filter((p) => p.gender === "ì—¬ì„±")
          .sort(() => Math.random() - 0.5);
        const others = remainingParticipants
          .filter((p) => p.gender !== "ë‚¨ì„±" && p.gender !== "ì—¬ì„±")
          .sort(() => Math.random() - 0.5);

        // 3ë‹¨ê³„: ê° ì¡°ì˜ í˜„ì¬ ì„±ë³„ êµ¬ì„± í™•ì¸
        const getGroupGenderBalance = (groupIndex) => {
          const info = leaderGenderInfo[groupIndex] || {
            male: 0,
            female: 0,
            other: 0,
          };
          const currentMale = groups[groupIndex].filter(
            (p) => p.gender === "ë‚¨ì„±"
          ).length;
          const currentFemale = groups[groupIndex].filter(
            (p) => p.gender === "ì—¬ì„±"
          ).length;
          return { male: currentMale, female: currentFemale };
        };

        // 4ë‹¨ê³„: ê· í˜•ì„ ë§ì¶”ê¸° ìœ„í•´ ì°¸ê°€ì ë°°ì¹˜
        let maleIndex = 0,
          femaleIndex = 0,
          otherIndex = 0;

        // ë‚¨ì„±ê³¼ ì—¬ì„±ì„ ë²ˆê°ˆì•„ê°€ë©° ë°°ì¹˜í•˜ë˜, ê° ì¡°ì˜ ê· í˜•ì„ ê³ ë ¤
        while (maleIndex < males.length || femaleIndex < females.length) {
          // ë‹¤ìŒì— ë°°ì¹˜í•  ì¡° ì„ íƒ (ê°€ì¥ ê· í˜•ì´ ë§ì§€ ì•Šì€ ì¡°)
          let targetGroup = 0;
          let minBalance = Infinity;

          for (let i = 0; i < groupCount; i++) {
            const balance = getGroupGenderBalance(i);
            const balanceDiff = Math.abs(balance.male - balance.female);
            if (balanceDiff < minBalance) {
              minBalance = balanceDiff;
              targetGroup = i;
            }
          }

          // ë‚¨ì„±ê³¼ ì—¬ì„±ì„ ë²ˆê°ˆì•„ê°€ë©° ë°°ì¹˜
          if (maleIndex < males.length && femaleIndex < females.length) {
            // ë‘˜ ë‹¤ ìˆìœ¼ë©´ ë²ˆê°ˆì•„ê°€ë©° ë°°ì¹˜
            if (maleIndex <= femaleIndex) {
              groups[targetGroup].push(males[maleIndex]);
              maleIndex++;
            } else {
              groups[targetGroup].push(females[femaleIndex]);
              femaleIndex++;
            }
          } else if (maleIndex < males.length) {
            // ë‚¨ì„±ë§Œ ë‚¨ìŒ
            groups[targetGroup].push(males[maleIndex]);
            maleIndex++;
          } else if (femaleIndex < females.length) {
            // ì—¬ì„±ë§Œ ë‚¨ìŒ
            groups[targetGroup].push(females[femaleIndex]);
            femaleIndex++;
          }
        }

        // 5ë‹¨ê³„: ê¸°íƒ€ ì„±ë³„ ì²˜ë¦¬
        while (otherIndex < others.length) {
          // ê°€ì¥ ì¸ì›ì´ ì ì€ ì¡°ì— ë°°ì¹˜
          let targetGroup = 0;
          let minSize = groups[0].length;
          for (let i = 1; i < groupCount; i++) {
            if (groups[i].length < minSize) {
              minSize = groups[i].length;
              targetGroup = i;
            }
          }
          groups[targetGroup].push(others[otherIndex]);
          otherIndex++;
        }

        return groups;
      }

      // ì„±ë³„ ê· í˜• ë°°ë¶„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
      function balanceGroupsByGender(participants, groups, groupCount) {
        return balanceGroupsByGenderWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // ë‹¨ê³¼ëŒ€ ê· í˜• ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
      function balanceGroupsByCollegeWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        // ì¡°ì¥ë“¤ì„ ë¨¼ì € ë°°ì¹˜
        participants.forEach((p) => {
          if (p.isLeader && p.targetGroup !== undefined) {
            groups[p.targetGroup].push(p);
          }
        });

        // ë‚¨ì€ ì°¸ê°€ìë“¤ì„ ë‹¨ê³¼ëŒ€ë³„ë¡œ ë¶„ë¥˜
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const collegeGroups = {};
        remainingParticipants.forEach((p) => {
          const college = p.college || "ê¸°íƒ€";
          if (!collegeGroups[college]) collegeGroups[college] = [];
          collegeGroups[college].push(p);
        });

        let currentGroup = 0;
        const allColleges = Object.keys(collegeGroups);

        // ê° ë‹¨ê³¼ëŒ€ì˜ ì°¸ê°€ìë“¤ì„ ì„ê³  ìˆœí™˜ ë°°ì¹˜
        allColleges.forEach((college) => {
          const members = collegeGroups[college].sort(
            () => Math.random() - 0.5
          );
          members.forEach((member) => {
            groups[currentGroup].push(member);
            currentGroup = (currentGroup + 1) % groupCount;
          });
        });

        return groups;
      }

      // ë‹¨ê³¼ëŒ€ ê· í˜• ë°°ë¶„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
      function balanceGroupsByCollege(participants, groups, groupCount) {
        return balanceGroupsByCollegeWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // ë¬´ì‘ìœ„ ë°°ë¶„ (ì¡°ì¥ í¬í•¨)
      function randomDistributionWithLeaders(
        participants,
        groups,
        groupCount,
        manualLeaders
      ) {
        // ì¡°ì¥ë“¤ì„ ë¨¼ì € ë°°ì¹˜
        participants.forEach((p) => {
          if (p.isLeader && p.targetGroup !== undefined) {
            groups[p.targetGroup].push(p);
          }
        });

        // ë‚¨ì€ ì°¸ê°€ìë“¤ì„ ë¬´ì‘ìœ„ë¡œ ë°°ì¹˜
        const remainingParticipants = participants.filter((p) => !p.isLeader);
        const shuffled = [...remainingParticipants].sort(
          () => Math.random() - 0.5
        );
        shuffled.forEach((participant, index) => {
          groups[index % groupCount].push(participant);
        });
        return groups;
      }

      // ë¬´ì‘ìœ„ ë°°ë¶„ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
      function randomDistribution(participants, groups, groupCount) {
        return randomDistributionWithLeaders(
          participants,
          groups,
          groupCount,
          {}
        );
      }

      // ì¡° ê²°ê³¼ í‘œì‹œ ëª¨ë‹¬
      function showGroupResults(eventId, groups, participants) {
        closeGroupMakerModal();

        const modalHTML = `
          <div id="group-results-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">ì¡° êµ¬ì„± ê²°ê³¼</h3>
                <button type="button" id="group-results-close" class="text-gray-500 hover:text-gray-700">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
              
              <div class="mb-4 p-3 bg-green-50 rounded-lg">
                <p class="text-sm text-green-800">
                  <i class="fas fa-check-circle mr-2"></i>
                  ì´ <strong>${participants.length}ëª…</strong>ì„ <strong>${
          groups.length
        }ê°œ ì¡°</strong>ë¡œ ë‚˜ëˆ„ì—ˆìŠµë‹ˆë‹¤.
                </p>
              </div>

              <div class="space-y-4 mb-6">
                ${groups
                  .map(
                    (group, index) => `
                  <div class="border rounded-lg p-4">
                    <h4 class="font-semibold text-lg mb-3 text-blue-600">${
                      index + 1
                    }ì¡° (${group.length}ëª…)</h4>
                    ${group
                      .map(
                        (member, memberIndex) => `
                      <div class="flex justify-between items-center py-1 ${
                        member.isLeader
                          ? "bg-blue-100 font-semibold text-blue-800 rounded px-2"
                          : ""
                      }">
                        <span>${memberIndex + 1}. ${member.name} (${
                          member.studentId
                        })</span>
                        <span class="text-xs text-gray-500">${member.gender}/${
                          member.college
                        }</span>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                `
                  )
                  .join("")}
              </div>

              <div class="flex gap-3">
                <button type="button" id="group-export-excel" 
                        class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                  <i class="fas fa-file-excel mr-2"></i>ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                </button>
                <button type="button" id="group-export-csv" 
                        class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                  <i class="fas fa-file-csv mr-2"></i>CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                </button>
                <button type="button" id="group-results-cancel" 
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                  ë‹«ê¸°
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("group-results-close")
          .addEventListener("click", closeGroupResultsModal);
        document
          .getElementById("group-results-cancel")
          .addEventListener("click", closeGroupResultsModal);
        document
          .getElementById("group-export-excel")
          .addEventListener("click", () => {
            exportGroupsToExcel(eventId, groups, participants);
          });
        document
          .getElementById("group-export-csv")
          .addEventListener("click", () => {
            exportGroupsToCSV(eventId, groups, participants);
          });
      }

      // ì¡° ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
      function closeGroupResultsModal() {
        const modal = document.getElementById("group-results-modal");
        if (modal) {
          modal.remove();
        }
      }

      // ì—‘ì…€ íŒŒì¼ë¡œ ì¡° ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      async function exportGroupsToExcel(eventId, groups, participants) {
        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) return showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          // XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
          if (typeof XLSX === "undefined") {
            return showAlert("ğŸ˜¥", "ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          // ì›Œí¬ë¶ ìƒì„±
          const wb = XLSX.utils.book_new();

          // ê°„ë‹¨í•œ í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ìƒì„± (ì—´: ì¡°, í–‰: ì´ë¦„)
          const maxGroupSize = Math.max(...groups.map((group) => group.length));
          const simpleData = [];

          // í—¤ë” ìƒì„± (1ì¡°, 2ì¡°, 3ì¡°...)
          const headers = [];
          for (let i = 1; i <= groups.length; i++) {
            headers.push(`${i}ì¡°`);
          }
          simpleData.push(headers);

          // ê° í–‰ì— ì¡°ì› ì´ë¦„ë“¤ ì¶”ê°€
          for (let row = 0; row < maxGroupSize; row++) {
            const rowData = [];
            groups.forEach((group, groupIndex) => {
              const member = group[row];
              if (member) {
                // ì¡°ì¥ì€ ì´ë¦„ ë’¤ì— (ì¡°ì¥) í‘œì‹œ
                const name = member.isLeader
                  ? `${member.name} (ì¡°ì¥)`
                  : member.name;
                rowData.push(name);
              } else {
                rowData.push(""); // ë¹ˆ ì…€
              }
            });
            simpleData.push(rowData);
          }

          // ì›Œí¬ì‹œíŠ¸ ìƒì„±
          const ws = XLSX.utils.aoa_to_sheet(simpleData);

          // ì—´ ë„ˆë¹„ ì„¤ì •
          ws["!cols"] = groups.map(() => ({ wch: 15 })); // ê° ì¡°ì—´ì˜ ë„ˆë¹„

          // ì‹œíŠ¸ ì¶”ê°€
          XLSX.utils.book_append_sheet(wb, ws, "ì¡°êµ¬ì„±");

          // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          const fileName = `${
            ev.title || "ì´ë²¤íŠ¸"
          }_ì¡°êµ¬ì„±_${getTodayString()}.xlsx`;
          XLSX.writeFile(wb, fileName);

          showAlert("âœ…", "ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
          closeGroupResultsModal();
        } catch (error) {
          console.error("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // CSV íŒŒì¼ë¡œ ì¡° ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      async function exportGroupsToCSV(eventId, groups, participants) {
        try {
          const ev = eventsData.find((e) => e.id === eventId);
          if (!ev) return showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          let csvContent = "";

          // ê°„ë‹¨í•œ í˜•ì‹ìœ¼ë¡œ CSV ìƒì„± (ì—´: ì¡°, í–‰: ì´ë¦„)
          const maxGroupSize = Math.max(...groups.map((group) => group.length));

          // í—¤ë” ìƒì„± (1ì¡°, 2ì¡°, 3ì¡°...)
          const headers = [];
          for (let i = 1; i <= groups.length; i++) {
            headers.push(`${i}ì¡°`);
          }
          csvContent += headers.join(",") + "\n";

          // ê° í–‰ì— ì¡°ì› ì´ë¦„ë“¤ ì¶”ê°€
          for (let row = 0; row < maxGroupSize; row++) {
            const rowData = [];
            groups.forEach((group, groupIndex) => {
              const member = group[row];
              if (member) {
                // ì¡°ì¥ì€ ì´ë¦„ ë’¤ì— (ì¡°ì¥) í‘œì‹œ
                const name = member.isLeader
                  ? `${member.name} (ì¡°ì¥)`
                  : member.name;
                rowData.push(name);
              } else {
                rowData.push(""); // ë¹ˆ ì…€
              }
            });
            csvContent += rowData.join(",") + "\n";
          }

          // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);

          const fileName = `${
            ev.title || "ì´ë²¤íŠ¸"
          }_ì¡°êµ¬ì„±_${getTodayString()}.csv`;
          link.setAttribute("download", fileName);
          link.style.visibility = "hidden";

          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          URL.revokeObjectURL(url);

          showAlert("âœ…", "CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
          closeGroupResultsModal();
        } catch (error) {
          console.error("CSV ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function exportApplicantsXLSX(id) {
        try {
          const ev = eventsData.find((e) => e.id === id);
          if (!ev) return showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          let rows = [],
            header = [];

          if (ev.type === "tasting") {
            header = [
              "êµ¬ë¶„",
              "ì‹ë‹¹",
              "ì´ë¦„",
              "í•™ë²ˆ",
              "ì„±ë³„",
              "í•™ë…„",
              "ë‹¨ê³¼ëŒ€",
              "í•™ê³¼",
              "ì „í™”ë²ˆí˜¸",
              "ë¹„ê³ ",
            ];
            (ev.restaurants || []).forEach((r) => {
              (r.reservations || []).forEach((p) =>
                rows.push({
                  êµ¬ë¶„: "ì°¸ê°€",
                  ì‹ë‹¹: r.name || "",
                  ì´ë¦„: p.name || "",
                  í•™ë²ˆ: p.studentId || "",
                  ì„±ë³„: p.gender || "",
                  í•™ë…„: p.year || "",
                  ë‹¨ê³¼ëŒ€: p.college || "",
                  í•™ê³¼: p.department || "",
                  ì „í™”ë²ˆí˜¸: p.phone || "",
                  ë¹„ê³ : "",
                })
              );
              (r.waiting || []).forEach((p) =>
                rows.push({
                  êµ¬ë¶„: "ëŒ€ê¸°",
                  ì‹ë‹¹: r.name || "",
                  ì´ë¦„: p.name || "",
                  í•™ë²ˆ: p.studentId || "",
                  ì„±ë³„: p.gender || "",
                  í•™ë…„: p.year || "",
                  ë‹¨ê³¼ëŒ€: p.college || "",
                  í•™ê³¼: p.department || "",
                  ì „í™”ë²ˆí˜¸: p.phone || "",
                  ë¹„ê³ : "",
                })
              );
            });
          } else if (ev.type === "mt" || ev.type === "assembly") {
            header = [
              "êµ¬ë¶„",
              "ì´ë¦„",
              "í•™ë²ˆ",
              "ì„±ë³„",
              "í•™ë…„",
              "ë‹¨ê³¼ëŒ€",
              "í•™ê³¼",
              "ì „í™”ë²ˆí˜¸",
              "ë¹„ê³ ",
            ];
            (ev.applicants || []).forEach((p) =>
              rows.push({
                êµ¬ë¶„: "ì°¸ê°€",
                ì´ë¦„: p.name || "",
                í•™ë²ˆ: p.studentId || "",
                ì„±ë³„: p.gender || "",
                í•™ë…„: p.year || "",
                ë‹¨ê³¼ëŒ€: p.college || "",
                í•™ê³¼: p.department || "",
                ì „í™”ë²ˆí˜¸: p.phone || "",
                ë¹„ê³ : "",
              })
            );
            (ev.waiting || []).forEach((p) =>
              rows.push({
                êµ¬ë¶„: "ëŒ€ê¸°",
                ì´ë¦„: p.name || "",
                í•™ë²ˆ: p.studentId || "",
                ì„±ë³„: p.gender || "",
                í•™ë…„: p.year || "",
                ë‹¨ê³¼ëŒ€: p.college || "",
                í•™ê³¼: p.department || "",
                ì „í™”ë²ˆí˜¸: p.phone || "",
                ë¹„ê³ : "",
              })
            );
          } else {
            header = [
              "êµ¬ë¶„",
              "ì´ë¦„",
              "í•™ë²ˆ",
              "ì„±ë³„",
              "í•™ë…„",
              "ë‹¨ê³¼ëŒ€",
              "í•™ê³¼",
              "ì „í™”ë²ˆí˜¸",
              "ë¹„ê³ ",
            ];
            (ev.applicants || []).forEach((p) =>
              rows.push({
                êµ¬ë¶„: "ì°¸ê°€",
                ì´ë¦„: p.name || "",
                í•™ë²ˆ: p.studentId || "",
                ì„±ë³„: p.gender || "",
                í•™ë…„: p.year || "",
                ë‹¨ê³¼ëŒ€: p.college || "",
                í•™ê³¼: p.department || "",
                ì „í™”ë²ˆí˜¸: p.phone || "",
                ë¹„ê³ : "",
              })
            );
            (ev.waiting || []).forEach((p) =>
              rows.push({
                êµ¬ë¶„: "ëŒ€ê¸°",
                ì´ë¦„: p.name || "",
                í•™ë²ˆ: p.studentId || "",
                ì„±ë³„: p.gender || "",
                í•™ë…„: p.year || "",
                ë‹¨ê³¼ëŒ€: p.college || "",
                í•™ê³¼: p.department || "",
                ì „í™”ë²ˆí˜¸: p.phone || "",
                ë¹„ê³ : "",
              })
            );
          }
          if (rows.length === 0)
            rows = [
              {
                êµ¬ë¶„: "-",
                ì´ë¦„: "-",
                í•™ë²ˆ: "-",
                ì„±ë³„: "-",
                í•™ë…„: "-",
                ë‹¨ê³¼ëŒ€: "-",
                í•™ê³¼: "-",
                ì „í™”ë²ˆí˜¸: "-",
                ë¹„ê³ : "",
              },
            ];

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(rows, { header });
          XLSX.utils.book_append_sheet(wb, ws, "ëª…ë‹¨");
          const fname = `${ev.title || "event"}_ëª…ë‹¨.xlsx`;
          XLSX.writeFile(wb, fname);
        } catch (e) {
          console.warn(e);
          showAlert("ğŸ˜¥", "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
        }
      }

      /* ===== ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ë° íšŒì› ê´€ë¦¬ ===== */

      // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("click", (e) => {
        if (e.target.id === "excel-upload-btn") {
          document.getElementById("excel-upload").click();
        }

        if (e.target.id === "download-template") {
          downloadExcelTemplate();
        }

        if (e.target.closest("#file-drop-zone")) {
          document.getElementById("excel-upload").click();
        }
      });

      document.addEventListener("change", (e) => {
        if (e.target.id === "excel-upload") {
          const file = e.target.files[0];
          if (file) {
            handleFileUpload(file);
          }
        }
      });

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("dragover", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.add("border-green-400", "bg-green-50");
        }
      });

      document.addEventListener("dragleave", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.remove("border-green-400", "bg-green-50");
        }
      });

      document.addEventListener("drop", (e) => {
        if (e.target.closest("#file-drop-zone")) {
          e.preventDefault();
          e.target
            .closest("#file-drop-zone")
            .classList.remove("border-green-400", "bg-green-50");

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFileUpload(files[0]);
          }
        }
      });

      // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
      function downloadExcelTemplate() {
        try {
          const templateData = [
            [
              "ì´ë¦„",
              "í•™ë²ˆ",
              "ì„±ë³„",
              "í•™ë…„",
              "ë‹¨ê³¼ëŒ€",
              "í•™ê³¼",
              "ì „í™”ë²ˆí˜¸",
              "ìƒíƒœ",
            ],
            [
              "í™ê¸¸ë™",
              "20241234",
              "ë‚¨",
              "1",
              "ê³µê³¼ëŒ€í•™",
              "ì»´í“¨í„°ê³µí•™ê³¼",
              "010-1234-5678",
              "ìŠ¹ì¸",
            ],
            [
              "ê¹€ì˜í¬",
              "20245678",
              "ì—¬",
              "2",
              "ì¸ë¬¸ëŒ€í•™",
              "ì˜ì–´ì˜ë¬¸í•™ê³¼",
              "010-9876-5432",
              "ëŒ€ê¸°",
            ],
          ];

          const ws = XLSX.utils.aoa_to_sheet(templateData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "íšŒì›ì •ë³´");

          XLSX.writeFile(wb, "íšŒì›ì •ë³´_í…œí”Œë¦¿.xlsx");
          showAlert("âœ…", "ì—‘ì…€ í…œí”Œë¦¿ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // íŒŒì¼ ì²˜ë¦¬ (Excel/CSV)
      async function handleFileUpload(file) {
        const progressDiv = document.getElementById("upload-progress");
        const resultDiv = document.getElementById("upload-result");

        try {
          // íŒŒì¼ í¬ê¸° ê²€ì¦ (10MB ì œí•œ)
          if (file.size > 10 * 1024 * 1024) {
            throw new Error("íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€ 10MB)");
          }

          // íŒŒì¼ í˜•ì‹ ê²€ì¦
          const fileName = file.name.toLowerCase();
          if (
            !fileName.endsWith(".xlsx") &&
            !fileName.endsWith(".xls") &&
            !fileName.endsWith(".csv")
          ) {
            throw new Error(
              "ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (.xlsx, .xls, .csvë§Œ ì§€ì›)"
            );
          }

          // ì§„í–‰ ìƒíƒœ í‘œì‹œ
          progressDiv.classList.remove("hidden");
          resultDiv.classList.add("hidden");

          // íŒŒì¼ ì½ê¸°
          const data = await readFile(file);
          console.log("íŒŒì¼ ë°ì´í„°:", data);

          if (!data || data.length < 2) {
            throw new Error("íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          }

          // ë°ì´í„° ê²€ì¦ ë° ì²˜ë¦¬ (ìœ ì—°í•œ íŒŒì‹±)
          const validationResult = validateFileData(data);
          console.log("ê²€ì¦ ê²°ê³¼:", validationResult);

          if (!validationResult.isValid) {
            throw new Error(
              `ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨: ${validationResult.errors.join(", ")}`
            );
          }

          // íšŒì› ì •ë³´ ì²˜ë¦¬
          const processResult = await processMemberData(data);

          // ê²°ê³¼ í‘œì‹œ
          showUploadResult(processResult);
        } catch (error) {
          console.error("íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);

          // ì§„í–‰ ìƒíƒœ ìˆ¨ê¸°ê¸°
          progressDiv.classList.add("hidden");

          // ì˜¤ë¥˜ ê²°ê³¼ í‘œì‹œ
          const errorResult = {
            success: false,
            updatedCount: 0,
            newCount: 0,
            errorCount: 1,
            errors: [error.message],
          };
          showUploadResult(errorResult);

          // ì˜¤ë¥˜ ì•Œë¦¼
          showAlert("ğŸ˜¥", `íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        } finally {
          // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
          const fileInput = document.getElementById("excel-upload");
          if (fileInput) {
            fileInput.value = "";
          }
        }
      }

      // íŒŒì¼ ì½ê¸° (Excel/CSV)
      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const fileName = file.name.toLowerCase();

              if (fileName.endsWith(".csv")) {
                // CSV íŒŒì¼ ì²˜ë¦¬
                const csvText = e.target.result;
                const lines = csvText.split("\n");
                const data = lines.map((line) => {
                  // CSV íŒŒì‹± (ì‰¼í‘œ êµ¬ë¶„, ë”°ì˜´í‘œ ì²˜ë¦¬)
                  const result = [];
                  let current = "";
                  let inQuotes = false;

                  for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                      inQuotes = !inQuotes;
                    } else if (char === "," && !inQuotes) {
                      result.push(current.trim());
                      current = "";
                    } else {
                      current += char;
                    }
                  }
                  result.push(current.trim());
                  return result;
                });
                resolve(data);
              } else {
                // Excel íŒŒì¼ ì²˜ë¦¬
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                  header: 1,
                });
                resolve(jsonData);
              }
            } catch (error) {
              reject(new Error("íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
            }
          };
          reader.onerror = () => reject(new Error("íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));

          if (file.name.toLowerCase().endsWith(".csv")) {
            reader.readAsText(file, "UTF-8");
          } else {
            reader.readAsArrayBuffer(file);
          }
        });
      }

      // íŒŒì¼ ë°ì´í„° ê²€ì¦ (ìœ ì—°í•œ íŒŒì‹±)
      function validateFileData(data) {
        const warnings = [];
        const errors = [];

        if (!data || data.length < 2) {
          errors.push("íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return { isValid: false, errors, warnings };
        }

        // í—¤ë” ë§¤í•‘ (ìœ ì—°í•œ ì»¬ëŸ¼ ì¸ì‹)
        const headers = data[0];
        const headerMapping = findHeaderMapping(headers);

        if (headerMapping.name === -1 || headerMapping.studentId === -1) {
          errors.push("ì´ë¦„ê³¼ í•™ë²ˆ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // ê²½ê³  ë©”ì‹œì§€ ì¶”ê°€
        if (headerMapping.gender === -1)
          warnings.push("ì„±ë³„ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.year === -1)
          warnings.push("í•™ë…„ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.college === -1)
          warnings.push("ë‹¨ê³¼ëŒ€ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.department === -1)
          warnings.push("í•™ê³¼ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.phone === -1)
          warnings.push("ì „í™”ë²ˆí˜¸ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (headerMapping.status === -1)
          warnings.push("ìƒíƒœ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        return {
          isValid: errors.length === 0,
          errors,
          warnings,
          headerMapping,
        };
      }

      // í—¤ë” ë§¤í•‘ ì°¾ê¸° (ìœ ì—°í•œ ì»¬ëŸ¼ ì¸ì‹)
      function findHeaderMapping(headers) {
        const mapping = {
          name: -1,
          studentId: -1,
          gender: -1,
          year: -1,
          college: -1,
          department: -1,
          phone: -1,
          status: -1,
        };

        headers.forEach((header, index) => {
          const headerLower = header?.toString().toLowerCase().trim();

          if (headerLower?.includes("ì´ë¦„") || headerLower?.includes("name")) {
            mapping.name = index;
          } else if (
            headerLower?.includes("í•™ë²ˆ") ||
            headerLower?.includes("student") ||
            headerLower?.includes("id")
          ) {
            mapping.studentId = index;
          } else if (
            headerLower?.includes("ì„±ë³„") ||
            headerLower?.includes("gender")
          ) {
            mapping.gender = index;
          } else if (
            headerLower?.includes("í•™ë…„") ||
            headerLower?.includes("year") ||
            headerLower?.includes("grade")
          ) {
            mapping.year = index;
          } else if (
            headerLower?.includes("ë‹¨ê³¼ëŒ€") ||
            headerLower?.includes("college")
          ) {
            mapping.college = index;
          } else if (
            headerLower?.includes("í•™ê³¼") ||
            headerLower?.includes("department") ||
            headerLower?.includes("major")
          ) {
            mapping.department = index;
          } else if (
            headerLower?.includes("ì „í™”") ||
            headerLower?.includes("phone") ||
            headerLower?.includes("ì—°ë½ì²˜")
          ) {
            mapping.phone = index;
          } else if (
            headerLower?.includes("ìƒíƒœ") ||
            headerLower?.includes("status")
          ) {
            mapping.status = index;
          }
        });

        return mapping;
      }

      // íšŒì› ë°ì´í„° ì²˜ë¦¬ (ìœ ì—°í•œ í—¤ë” ë§¤í•‘)
      async function processMemberData(data) {
        const headers = data[0];
        const rows = data.slice(1);
        const headerMapping = findHeaderMapping(headers);

        let updatedCount = 0;
        let newCount = 0;
        let errorCount = 0;
        const errors = [];

        const batch = writeBatch(db);

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          try {
            // ìœ ì—°í•œ ë°ì´í„° ì¶”ì¶œ
            const memberData = {
              name:
                headerMapping.name !== -1
                  ? row[headerMapping.name]?.toString().trim()
                  : "",
              studentId:
                headerMapping.studentId !== -1
                  ? row[headerMapping.studentId]?.toString().trim()
                  : "",
              gender:
                headerMapping.gender !== -1
                  ? row[headerMapping.gender]?.toString().trim()
                  : "",
              year:
                headerMapping.year !== -1
                  ? row[headerMapping.year]?.toString().trim()
                  : "",
              college:
                headerMapping.college !== -1
                  ? row[headerMapping.college]?.toString().trim()
                  : "",
              department:
                headerMapping.department !== -1
                  ? row[headerMapping.department]?.toString().trim()
                  : "",
              phone:
                headerMapping.phone !== -1
                  ? row[headerMapping.phone]?.toString().trim()
                  : "",
              status:
                headerMapping.status !== -1
                  ? row[headerMapping.status]?.toString().trim()
                  : "",
              lastUpdated: new Date().toISOString(),
            };

            // í•„ìˆ˜ í•„ë“œ í™•ì¸
            if (!memberData.name || !memberData.studentId) {
              errors.push(`${i + 2}ë²ˆì§¸ í–‰: ì´ë¦„ê³¼ í•™ë²ˆì€ í•„ìˆ˜ì…ë‹ˆë‹¤.`);
              errorCount++;
              continue;
            }

            // ìƒíƒœê°’ ë³€í™˜ (í•œêµ­ì–´ â†’ ì˜ì–´)
            memberData.status =
              convertStatusToEnglish(memberData.status) || "pending";

            // ê¸°ì¡´ íšŒì› í™•ì¸
            const existingMember = membersData.find(
              (m) => m.studentId === memberData.studentId
            );

            if (existingMember) {
              // ê¸°ì¡´ íšŒì› ì—…ë°ì´íŠ¸ (ë¹ˆ ê°’ì´ ì•„ë‹Œ ê²½ìš°ë§Œ ì—…ë°ì´íŠ¸)
              const updateData = { lastUpdated: memberData.lastUpdated };

              if (memberData.name) updateData.name = memberData.name;
              if (memberData.gender) updateData.gender = memberData.gender;
              if (memberData.year) updateData.year = memberData.year;
              if (memberData.college) updateData.college = memberData.college;
              if (memberData.department)
                updateData.department = memberData.department;
              if (memberData.phone) updateData.phone = memberData.phone;
              if (memberData.status) updateData.status = memberData.status;

              const memberRef = doc(db, "members", existingMember.id);
              batch.update(memberRef, updateData);
              updatedCount++;
            } else {
              // ìƒˆ íšŒì› ì¶”ê°€
              const memberRef = doc(collection(db, "members"));
              batch.set(memberRef, {
                ...memberData,
                status: "pending", // ìƒˆ íšŒì›ì€ í•­ìƒ ëŒ€ê¸° ìƒíƒœ
                createdAt: new Date().toISOString(),
              });
              newCount++;
            }
          } catch (error) {
            errors.push(`${i + 2}ë²ˆì§¸ í–‰ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`);
            errorCount++;
          }
        }

        try {
          await batch.commit();
          return {
            success: true,
            updatedCount,
            newCount,
            errorCount,
            errors,
          };
        } catch (error) {
          console.error("ë°°ì¹˜ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
          throw new Error(`ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹¤íŒ¨: ${error.message}`);
        }
      }

      // ìƒíƒœê°’ ë³€í™˜ (í•œêµ­ì–´ â†’ ì˜ì–´)
      function convertStatusToEnglish(status) {
        if (!status) return null;

        const statusLower = status.toLowerCase().trim();

        if (statusLower.includes("ìŠ¹ì¸") || statusLower === "active") {
          return "active";
        } else if (statusLower.includes("ëŒ€ê¸°") || statusLower === "pending") {
          return "pending";
        } else if (statusLower.includes("ê±°ì ˆ") || statusLower === "rejected") {
          return "rejected";
        } else if (statusLower.includes("ì°¨ë‹¨") || statusLower === "blocked") {
          return "blocked";
        }

        return null;
      }

      // ì—…ë¡œë“œ ê²°ê³¼ í‘œì‹œ
      function showUploadResult(result) {
        const resultDiv = document.getElementById("upload-result");

        let resultHTML = `
          <div class="bg-green-100 border border-green-300 rounded p-4">
            <h5 class="font-semibold text-green-800 mb-2">
              <i class="fas fa-check-circle mr-2"></i>ì—‘ì…€ ì—…ë¡œë“œ ì™„ë£Œ
            </h5>
            <div class="text-sm text-green-700 space-y-1">
              <p>âœ… ì—…ë°ì´íŠ¸ëœ íšŒì›: ${result.updatedCount}ëª…</p>
              <p>ğŸ†• ìƒˆë¡œ ì¶”ê°€ëœ íšŒì›: ${result.newCount}ëª…</p>
              ${
                result.errorCount > 0
                  ? `<p>âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${result.errorCount}ê±´</p>`
                  : ""
              }
            </div>
        `;

        if (result.errors && result.errors.length > 0) {
          resultHTML += `
            <details class="mt-3">
              <summary class="cursor-pointer text-sm font-medium text-green-800">ì˜¤ë¥˜ ìƒì„¸ ë³´ê¸°</summary>
              <div class="mt-2 text-xs text-green-600 bg-green-50 p-2 rounded">
                ${result.errors
                  .map((error) => `<div>â€¢ ${error}</div>`)
                  .join("")}
              </div>
            </details>
          `;
        }

        resultHTML += `</div>`;
        resultDiv.innerHTML = resultHTML;
        resultDiv.classList.remove("hidden");

        // íšŒì› ëª©ë¡ ì—…ë°ì´íŠ¸ (Firebase ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™œìš©)
        setTimeout(() => {
          try {
            // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œê°€ ì—´ë ¤ìˆê³  íšŒì› ê´€ë¦¬ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
            const dashboardTab = document.getElementById("dashboard-tab");
            const subtabContainer = document.getElementById("subtab-container");

            if (
              dashboardTab &&
              subtabContainer &&
              dashboardTab.innerHTML.includes("íšŒì› ê´€ë¦¬")
            ) {
              // í˜„ì¬ í™œì„±í™”ëœ íƒ­ì´ íšŒì› ê´€ë¦¬ì¸ì§€ í™•ì¸
              const activeTab = document.querySelector(
                ".subtab-btn.bg-gray-800"
              );
              if (activeTab && activeTab.dataset.sub === "members") {
                renderMembersAdmin(subtabContainer);
              }
            }
          } catch (error) {
            console.error("íšŒì› ëª©ë¡ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë§Œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            location.reload();
          }
        }, 2000);
      }

      /* ===================== ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ===================== */
      function renderDashboardTab() {
        const c = document.getElementById("dashboard-tab");
        c.innerHTML = `<div class="section">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
          <div class="flex flex-wrap gap-2 mb-4">
            <!-- ì´ë²¤íŠ¸ íƒ­ ì œê±°(ìš”ì²­ì‚¬í•­ 4) -->
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="members">
              <i class="fas fa-users mr-1"></i>íšŒì›
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="positions">
              <i class="fas fa-user-tie mr-1"></i>ì„ì› ê´€ë¦¬
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="homeblocks">
              <i class="fas fa-house-chimney mr-1"></i>í™ˆ ë¸”ë¡Â·ë¡œë“œë§µ
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="hof">
              <i class="fas fa-trophy mr-1"></i>ëª…ì˜ˆì˜ ì „ë‹¹
            </button>
            <button class="subtab-btn px-3 py-1.5 rounded bg-gray-200" data-sub="system">
              <i class="fas fa-gear mr-1"></i>ì‹œìŠ¤í…œ
            </button>
          </div>
          <div id="subtab-container"></div>
        </div>`;
        const bWrap = c.querySelector(".flex.flex-wrap");
        bWrap.addEventListener("click", (e) => {
          const b = e.target.closest(".subtab-btn");
          if (!b) return;
          c.querySelectorAll(".subtab-btn").forEach((x) =>
            x.classList.remove("bg-gray-800", "text-white")
          );
          b.classList.add("bg-gray-800", "text-white");
          currentDashboardTab = b.dataset.sub; // í˜„ì¬ íƒ­ ì €ì¥
          showSubtab(b.dataset.sub);
        });

        // ì €ì¥ëœ íƒ­ìœ¼ë¡œ ë³µì›, ê¸°ë³¸ê°’ì€ "íšŒì›" íƒ­
        const initialTab = currentDashboardTab || "members";
        const initialBtn = c.querySelector(
          `.subtab-btn[data-sub="${initialTab}"]`
        );
        if (initialBtn) {
          initialBtn.classList.add("bg-gray-800", "text-white");
        }
        showSubtab(initialTab);
      }
      function showSubtab(name) {
        const cont = document.getElementById("subtab-container");
        if (name === "homeblocks") {
          renderHomeBlocksAdmin(cont);
          return;
        }
        if (name === "members") {
          renderMembersAdmin(cont);
          return;
        }
        if (name === "positions") {
          renderPositionsAdmin(cont);
          return;
        }
        if (name === "hof") {
          renderHOFAdmin(cont);
          return;
        }
        if (name === "system") {
          renderSystemAdmin(cont);
          return;
        }
      }

      /* ===== ì§ì±… ê´€ë¦¬ ===== */
      function renderPositionsAdmin(container) {
        // íšŒì¥, ë¶€íšŒì¥ ê¶Œí•œ í™•ì¸ (ê´€ë¦¬ì ëª©ë¡ê³¼ ì§ì±… ëª¨ë‘ í™•ì¸)
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        const isPresidentOrVice =
          currentUser &&
          (currentUser.position === "íšŒì¥" ||
            currentUser.position === "ë¶€íšŒì¥");

        console.log("=== ì§ì±… ê´€ë¦¬ ê¶Œí•œ í™•ì¸ ===");
        console.log("currentUser:", currentUser);
        console.log("adminList:", adminList);
        console.log("isAdmin:", isAdmin);
        console.log("isPresidentOrVice:", isPresidentOrVice);
        console.log("currentUser.position:", currentUser?.position);

        if (!isAdmin || !isPresidentOrVice) {
          container.innerHTML = `
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì ì§ì±… ê´€ë¦¬</h3>
              <div class="p-8 text-center">
                <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-2">ì„ì› ê´€ë¦¬ëŠ” íšŒì¥ê³¼ ë¶€íšŒì¥ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                <p class="text-sm text-gray-500">í˜„ì¬ ê¶Œí•œ: ${
                  currentUser?.position || "ì¼ë°˜ íšŒì›"
                }</p>
                <p class="text-xs text-gray-400 mt-2">ê´€ë¦¬ì ì—¬ë¶€: ${
                  isAdmin ? "ê´€ë¦¬ì" : "ì¼ë°˜ íšŒì›"
                }</p>
              </div>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="section">
            <h3 class="text-xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì ì§ì±… ê´€ë¦¬</h3>
            <p class="text-xs text-gray-600 mb-4">ê´€ë¦¬ìë“¤ì—ê²Œ ì§ì±…ì„ ë¶€ì—¬í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            
            <div class="mb-4">
              <h4 class="font-semibold text-gray-700 mb-2">í˜„ì¬ ê´€ë¦¬ì ëª©ë¡ <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs ml-2">${
                adminList.length
              }ëª…</span></h4>
              <div id="admin-positions-list" class="space-y-2">
                ${renderAdminPositionsList()}
              </div>
              
              <!-- ê´€ë¦¬ì ì¶”ê°€ ì•ˆë‚´ -->
              <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h5 class="font-medium text-blue-800 mb-2">ê´€ë¦¬ì ì¶”ê°€</h5>
                <p class="text-sm text-blue-700 mb-2">
                  ê´€ë¦¬ì ì¶”ê°€ëŠ” <strong>ì‹œìŠ¤í…œ</strong> íƒ­ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </p>
                <div class="text-xs text-blue-600 bg-blue-100 p-2 rounded">
                  <strong>ë¹„ìƒì‹œ:</strong> ë¡œê·¸ì¸ í™”ë©´ì—ì„œ í•™ë²ˆì— <code>foodie_emergency_2024!</code> ì…ë ¥ í›„ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.
                </div>
              </div>
            </div>
            
            <div class="border-t pt-4">
              <h4 class="font-semibold text-gray-700 mb-2">ê¸°ë³¸ ì§ì±… ê´€ë¦¬</h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ê¸°ë³¸ ì§ì±… ì¶”ê°€</label>
                  <div class="flex flex-col sm:flex-row gap-2">
                    <input id="new-position" type="text" placeholder="ì˜ˆ: ì´ë¬´, ê¸°íšë¶€ì¥" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="add-position-btn" type="button" 
                            class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">
                      <i class="fas fa-plus mr-1"></i>ì¶”ê°€
                    </button>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ê¸°ë³¸ ì§ì±… ëª©ë¡</label>
                  <div id="default-positions-list" class="space-y-1">
                    ${renderDefaultPositions()}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document
          .getElementById("add-position-btn")
          .addEventListener("click", addDefaultPosition);
        document
          .getElementById("new-position")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") addDefaultPosition();
          });

        // ê´€ë¦¬ì ì¶”ê°€ ê¸°ëŠ¥ì€ ì‹œìŠ¤í…œ íƒ­ì—ì„œ ì²˜ë¦¬

        // ê´€ë¦¬ì ì§ì±… ë³€ê²½ ì´ë²¤íŠ¸
        container.addEventListener("change", (e) => {
          if (e.target.matches("select[data-admin-id]")) {
            updateAdminPosition(e.target.dataset.adminId, e.target.value);
          }
        });

        // ê´€ë¦¬ì ì œê±° ë° ê¸°ë³¸ ì§ì±… ì‚­ì œ ì´ë²¤íŠ¸
        container.addEventListener("click", (e) => {
          if (e.target.matches(".remove-admin-btn")) {
            removeAdmin(e.target.dataset.adminId);
          }
          if (e.target.matches(".remove-position-btn")) {
            removeDefaultPosition(e.target.dataset.position);
          }
        });
      }

      // ê´€ë¦¬ì ì¶”ê°€ ê¸°ëŠ¥ì€ ì‹œìŠ¤í…œ íƒ­ì—ì„œ ì²˜ë¦¬ë¨

      function renderAdminPositionsList() {
        if (!adminList.length)
          return '<p class="text-gray-500 text-center py-4">ë“±ë¡ëœ ê´€ë¦¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';

        return adminList
          .map((studentId) => {
            const member = membersData?.find((m) => m.studentId === studentId);
            const currentPosition = adminPositions[studentId] || "";
            const memberName = member?.name || "ì•Œ ìˆ˜ ì—†ìŒ";

            return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <div class="font-medium text-gray-800">${saf(memberName)}</div>
                <div class="text-sm text-gray-500">${studentId}</div>
              </div>
              <div class="flex items-center gap-2">
                <select data-admin-id="${studentId}" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                  <option value="">ì§ì±… ì—†ìŒ</option>
                  ${renderPositionOptions(currentPosition)}
                </select>
                <button class="remove-admin-btn text-red-500 hover:text-red-700 p-1" data-admin-id="${studentId}" title="ê´€ë¦¬ì ì œê±°">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function renderPositionOptions(selectedPosition = "") {
        const defaultPositions = [
          "íšŒì¥",
          "ë¶€íšŒì¥",
          "ì´ë¬´",
          "ê¸°íšë¶€ì¥",
          "í™ë³´ë¶€ì¥",
          "ìš´ì˜ì§„",
        ];
        const allPositions = [
          ...defaultPositions,
          ...customDefaultPositions,
          ...Object.values(adminPositions).filter(
            (p) =>
              !defaultPositions.includes(p) &&
              !customDefaultPositions.includes(p)
          ),
        ];
        const uniquePositions = [...new Set(allPositions)];

        return uniquePositions
          .map(
            (pos) =>
              `<option value="${pos}" ${
                pos === selectedPosition ? "selected" : ""
              }>${pos}</option>`
          )
          .join("");
      }

      function renderDefaultPositions() {
        const defaultPositions = [
          "íšŒì¥",
          "ë¶€íšŒì¥",
          "ì´ë¬´",
          "ê¸°íšë¶€ì¥",
          "í™ë³´ë¶€ì¥",
          "ìš´ì˜ì§„",
        ];

        // ì‚­ì œ ë¶ˆê°€ëŠ¥í•œ ì§ì±…ë“¤ (íšŒì¥, ë¶€íšŒì¥, ìš´ì˜ì§„)
        const undeletablePositions = ["íšŒì¥", "ë¶€íšŒì¥", "ìš´ì˜ì§„"];

        // ì‚­ì œëœ ê¸°ë³¸ ì§ì±…ë“¤ì„ ì œì™¸í•œ ê¸°ë³¸ ì§ì±…ë“¤
        const activeDefaultPositions = defaultPositions.filter(
          (pos) => !deletedDefaultPositions.includes(pos)
        );

        // í™œì„± ê¸°ë³¸ ì§ì±…ê³¼ ì»¤ìŠ¤í…€ ì§ì±…ì„ í•©ì³ì„œ í‘œì‹œ
        const allPositions = [
          ...activeDefaultPositions,
          ...customDefaultPositions,
        ];

        return allPositions
          .map((pos) => {
            const isUndeletable = undeletablePositions.includes(pos);
            return `
          <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
            <span class="text-sm ${
              isUndeletable ? "text-gray-600" : ""
            }">${pos}${
              isUndeletable
                ? ' <span class="text-xs text-gray-400">(ì‚­ì œ ë¶ˆê°€)</span>'
                : ""
            }</span>
            ${
              isUndeletable
                ? '<span class="text-xs text-gray-400">ì‚­ì œ ë¶ˆê°€</span>'
                : `<button class="remove-position-btn text-red-500 hover:text-red-700" data-position="${pos}" onclick="removeDefaultPosition('${pos}')">
                <i class="fas fa-times"></i>
              </button>`
            }
          </div>
        `;
          })
          .join("");
      }

      async function updateAdminPosition(studentId, position) {
        try {
          const newPositions = { ...adminPositions };
          if (position) {
            newPositions[studentId] = position;
          } else {
            delete newPositions[studentId];
          }

          await setDoc(
            doc(db, "admins", "list"),
            {
              studentIds: adminList,
              positions: newPositions,
            },
            { merge: true }
          );

          showAlert("âœ…", "ì§ì±…ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
          console.error(e);
          showAlert("ğŸ˜¥", "ì§ì±… ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function addDefaultPosition() {
        const input = document.getElementById("new-position");
        const position = input.value.trim();
        if (!position) {
          showAlert("ğŸ˜¥", "ì§ì±…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        // ì¤‘ë³µ ì²´í¬
        const defaultPositions = [
          "íšŒì¥",
          "ë¶€íšŒì¥",
          "ì´ë¬´",
          "ê¸°íšë¶€ì¥",
          "í™ë³´ë¶€ì¥",
          "ìš´ì˜ì§„",
        ];
        const allPositions = [...defaultPositions, ...customDefaultPositions];

        if (allPositions.includes(position)) {
          showAlert("âš ï¸", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì§ì±…ì…ë‹ˆë‹¤.");
          return;
        }

        try {
          // Firebaseì— ì €ì¥
          const newCustomPositions = [...customDefaultPositions, position];
          await setDoc(
            doc(db, "settings", "customPositions"),
            { positions: newCustomPositions },
            { merge: true }
          );

          // ë¡œì»¬ ë°°ì—´ ì—…ë°ì´íŠ¸
          customDefaultPositions = newCustomPositions;

          input.value = "";
          showAlert("âœ…", `"${position}" ì§ì±…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);

          // ê¸°ë³¸ ì§ì±… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          const defaultPositionsList = document.getElementById(
            "default-positions-list"
          );
          if (defaultPositionsList) {
            defaultPositionsList.innerHTML = renderDefaultPositions();
          }

          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          console.error(e);
          showAlert("ğŸ˜¥", "ì§ì±… ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // Make addDefaultPosition function globally accessible
      window.addDefaultPosition = addDefaultPosition;

      async function removeDefaultPosition(position) {
        try {
          // ì‚­ì œ ë¶ˆê°€ëŠ¥í•œ ì§ì±…ë“¤
          const undeletablePositions = ["íšŒì¥", "ë¶€íšŒì¥"];

          if (undeletablePositions.includes(position)) {
            showAlert("ğŸ˜¥", "íšŒì¥ê³¼ ë¶€íšŒì¥ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // ê¸°ë³¸ ì§ì±…ê³¼ ì»¤ìŠ¤í…€ ì§ì±… ëª¨ë‘ì—ì„œ ì œê±°
          const defaultPositions = [
            "íšŒì¥",
            "ë¶€íšŒì¥",
            "ì´ë¬´",
            "ê¸°íšë¶€ì¥",
            "í™ë³´ë¶€ì¥",
          ];

          // í™•ì¸ ëŒ€í™”ìƒì
          if (!confirm(`"${position}" ì§ì±…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
          }

          // ê¸°ë³¸ ì§ì±…ì¸ì§€ í™•ì¸
          const isDefaultPosition = defaultPositions.includes(position);

          if (isDefaultPosition) {
            // ê¸°ë³¸ ì§ì±…ì¸ ê²½ìš°, ì‚­ì œëœ ì§ì±… ëª©ë¡ì— ì¶”ê°€
            const newDeletedPositions = [...deletedDefaultPositions, position];

            await setDoc(
              doc(db, "settings", "deletedPositions"),
              { positions: newDeletedPositions },
              { merge: true }
            );

            deletedDefaultPositions = newDeletedPositions;
          } else {
            // ì»¤ìŠ¤í…€ ì§ì±…ì¸ ê²½ìš°, ì»¤ìŠ¤í…€ ëª©ë¡ì—ì„œ ì œê±°
            const newCustomPositions = customDefaultPositions.filter(
              (p) => p !== position
            );

            await setDoc(
              doc(db, "settings", "customPositions"),
              { positions: newCustomPositions },
              { merge: true }
            );

            customDefaultPositions = newCustomPositions;
          }

          // í•´ë‹¹ ì§ì±…ì„ ê°€ì§„ ëª¨ë“  ê´€ë¦¬ìì—ì„œ ì œê±°
          const newPositions = { ...adminPositions };
          Object.keys(newPositions).forEach((studentId) => {
            if (newPositions[studentId] === position) {
              delete newPositions[studentId];
            }
          });

          await setDoc(
            doc(db, "admins", "list"),
            {
              studentIds: adminList,
              positions: newPositions,
            },
            { merge: true }
          );

          showAlert("âœ…", `"${position}" ì§ì±…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

          // UI ìƒˆë¡œê³ ì¹¨
          const defaultPositionsList = document.getElementById(
            "default-positions-list"
          );
          if (defaultPositionsList) {
            defaultPositionsList.innerHTML = renderDefaultPositions();
          }

          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          console.error(e);
          showAlert("ğŸ˜¥", "ì§ì±… ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // Make removeDefaultPosition function globally accessible
      window.removeDefaultPosition = removeDefaultPosition;

      // addAdmin í•¨ìˆ˜ ì œê±°ë¨

      async function removeAdmin(studentId) {
        if (!confirm(`${studentId} ê´€ë¦¬ì ê¶Œí•œì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }

        try {
          const newAdminList = adminList.filter((id) => id !== studentId);
          const newPositions = { ...adminPositions };
          delete newPositions[studentId];

          await setDoc(
            doc(db, "admins", "list"),
            {
              studentIds: newAdminList,
              positions: newPositions,
            },
            { merge: true }
          );

          showAlert("âœ…", `${studentId} ê´€ë¦¬ì ê¶Œí•œì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          renderPositionsAdmin(document.getElementById("subtab-container"));
        } catch (e) {
          console.error(e);
          showAlert("ğŸ˜¥", "ê´€ë¦¬ì ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë¸”ë¡ ìˆœì„œ ë³€ê²½ í•¨ìˆ˜ë“¤
      async function moveBlockUp(blockId) {
        try {
          console.log("=== ë¸”ë¡ ìœ„ë¡œ ì´ë™ ì‹œì‘ ===");
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          // ìë™ ì¼ì • ë¸”ë¡ ì²˜ë¦¬ - ì‹¤ì œë¡œëŠ” ìˆœì„œ ë³€ê²½ í—ˆìš©
          if (blockId === "auto-schedule-block") {
            console.log("ìë™ ì¼ì • ë¸”ë¡ì˜ ìˆœì„œ ë³€ê²½ ìš”ì²­");
            // ìë™ ì¼ì • ë¸”ë¡ì€ ì‹¤ì œë¡œëŠ” ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ì§€ë§Œ,
            // UIì—ì„œëŠ” ë‹¤ë¥¸ ë¡œê·¸ì•„ì›ƒ ë¸”ë¡ë“¤ê³¼ í•¨ê»˜ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
            showAlert("â„¹ï¸", "ìë™ ì¼ì • ë¸”ë¡ì˜ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ë‹¤ì‹œ ë Œë”ë§
            return;
          }

          // order í•„ë“œë¡œ ì •ë ¬ëœ ìƒíƒœì—ì„œ ì°¾ê¸°
          const sortedBlocks = [...blocksData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedBlocks:", sortedBlocks);

          const currentBlock = sortedBlocks.find((b) => b.id === blockId);
          console.log("currentBlock:", currentBlock);

          if (!currentBlock) {
            console.log("í˜„ì¬ ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const currentIndex = sortedBlocks.indexOf(currentBlock);
          console.log("currentIndex:", currentIndex);

          if (currentIndex <= 0) {
            console.log("ì´ë¯¸ ë§¨ ìœ„ì— ìˆìŠµë‹ˆë‹¤.");
            return; // ì´ë¯¸ ë§¨ ìœ„
          }

          const targetBlock = sortedBlocks[currentIndex - 1];
          console.log("targetBlock:", targetBlock);

          // order ê°’ êµí™˜ - ë” ëª…í™•í•œ ë°©ì‹ìœ¼ë¡œ
          const currentOrder = currentBlock.order ?? currentIndex;
          const targetOrder = targetBlock.order ?? currentIndex - 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          // ê°™ì€ order ê°’ì´ë©´ ì‹¤ì œë¡œ êµí™˜í•˜ì§€ ì•ŠìŒ
          if (currentOrder === targetOrder) {
            console.log(
              "ê°™ì€ order ê°’ì„ ê°€ì§„ ë¸”ë¡ë“¤ì…ë‹ˆë‹¤. ì‹¤ì œ order ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );

            // ì‹¤ì œ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ order ê°’ ì„¤ì •
            const newCurrentOrder = currentIndex - 1;
            const newTargetOrder = currentIndex;

            console.log(
              "ìƒˆë¡œìš´ order ê°’ - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: newTargetOrder,
            });
          } else {
            // Firebase ì—…ë°ì´íŠ¸
            console.log("Firebase ì—…ë°ì´íŠ¸ ì‹œì‘...");
            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");

          showAlert("âœ…", "ë¸”ë¡ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
          console.error("ë¸”ë¡ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë¸”ë¡ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function moveBlockDown(blockId) {
        try {
          console.log("=== ë¸”ë¡ ì•„ë˜ë¡œ ì´ë™ ì‹œì‘ ===");
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          // ìë™ ì¼ì • ë¸”ë¡ ì²˜ë¦¬ - ì‹¤ì œë¡œëŠ” ìˆœì„œ ë³€ê²½ í—ˆìš©
          if (blockId === "auto-schedule-block") {
            console.log("ìë™ ì¼ì • ë¸”ë¡ì˜ ìˆœì„œ ë³€ê²½ ìš”ì²­");
            // ìë™ ì¼ì • ë¸”ë¡ì€ ì‹¤ì œë¡œëŠ” ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ì§€ë§Œ,
            // UIì—ì„œëŠ” ë‹¤ë¥¸ ë¡œê·¸ì•„ì›ƒ ë¸”ë¡ë“¤ê³¼ í•¨ê»˜ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
            showAlert("â„¹ï¸", "ìë™ ì¼ì • ë¸”ë¡ì˜ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ë‹¤ì‹œ ë Œë”ë§
            return;
          }

          // order í•„ë“œë¡œ ì •ë ¬ëœ ìƒíƒœì—ì„œ ì°¾ê¸°
          const sortedBlocks = [...blocksData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedBlocks:", sortedBlocks);

          const currentBlock = sortedBlocks.find((b) => b.id === blockId);
          console.log("currentBlock:", currentBlock);

          if (!currentBlock) {
            console.log("í˜„ì¬ ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const currentIndex = sortedBlocks.indexOf(currentBlock);
          console.log("currentIndex:", currentIndex);

          if (currentIndex >= sortedBlocks.length - 1) {
            console.log("ì´ë¯¸ ë§¨ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤.");
            return; // ì´ë¯¸ ë§¨ ì•„ë˜
          }

          const targetBlock = sortedBlocks[currentIndex + 1];
          console.log("targetBlock:", targetBlock);

          // order ê°’ êµí™˜ - ë” ëª…í™•í•œ ë°©ì‹ìœ¼ë¡œ
          const currentOrder = currentBlock.order ?? currentIndex;
          const targetOrder = targetBlock.order ?? currentIndex + 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          // ê°™ì€ order ê°’ì´ë©´ ì‹¤ì œë¡œ êµí™˜í•˜ì§€ ì•ŠìŒ
          if (currentOrder === targetOrder) {
            console.log(
              "ê°™ì€ order ê°’ì„ ê°€ì§„ ë¸”ë¡ë“¤ì…ë‹ˆë‹¤. ì‹¤ì œ order ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );

            // ì‹¤ì œ ì¸ë±ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ order ê°’ ì„¤ì •
            const newCurrentOrder = currentIndex + 1;
            const newTargetOrder = currentIndex;

            console.log(
              "ìƒˆë¡œìš´ order ê°’ - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: newTargetOrder,
            });
          } else {
            // Firebase ì—…ë°ì´íŠ¸
            console.log("Firebase ì—…ë°ì´íŠ¸ ì‹œì‘...");
            await updateDoc(doc(db, "homepageBlocks", blockId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "homepageBlocks", targetBlock.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");

          showAlert("âœ…", "ë¸”ë¡ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          smoothRender("dynamic-blocks", renderBlocks); // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
          console.error("ë¸”ë¡ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë¸”ë¡ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ í•¨ìˆ˜ë“¤
      async function moveEventUp(eventId) {
        try {
          console.log("=== ì´ë²¤íŠ¸ ìœ„ë¡œ ì´ë™ ì‹œì‘ ===");
          console.log("eventId:", eventId);
          console.log("eventsData:", eventsData);

          // order í•„ë“œë¡œ ì •ë ¬ëœ ìƒíƒœì—ì„œ ì°¾ê¸°
          const sortedEvents = [...eventsData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedEvents:", sortedEvents);

          const currentEvent = sortedEvents.find((e) => e.id === eventId);
          console.log("currentEvent:", currentEvent);

          if (!currentEvent) {
            console.log("í˜„ì¬ ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const currentIndex = sortedEvents.indexOf(currentEvent);
          console.log("currentIndex:", currentIndex);

          if (currentIndex <= 0) {
            console.log("ì´ë¯¸ ë§¨ ìœ„ì— ìˆìŠµë‹ˆë‹¤.");
            return;
          }

          const targetEvent = sortedEvents[currentIndex - 1];
          console.log("targetEvent:", targetEvent);

          // order ê°’ êµí™˜
          const currentOrder = currentEvent.order ?? currentIndex;
          const targetOrder = targetEvent.order ?? currentIndex - 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          if (currentOrder === targetOrder) {
            console.log(
              "ê°™ì€ order ê°’ì„ ê°€ì§„ ì´ë²¤íŠ¸ë“¤ì…ë‹ˆë‹¤. ì‹¤ì œ order ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );

            const newCurrentOrder = currentIndex - 1;
            const newTargetOrder = currentIndex;

            console.log(
              "ìƒˆë¡œìš´ order ê°’ - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "events", eventId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: newTargetOrder,
            });
          } else {
            console.log("Firebase ì—…ë°ì´íŠ¸ ì‹œì‘...");
            await updateDoc(doc(db, "events", eventId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");

          showAlert("âœ…", "ì´ë²¤íŠ¸ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          smoothRender("main-content", renderAll);
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function moveEventDown(eventId) {
        try {
          console.log("=== ì´ë²¤íŠ¸ ì•„ë˜ë¡œ ì´ë™ ì‹œì‘ ===");
          console.log("eventId:", eventId);
          console.log("eventsData:", eventsData);

          // order í•„ë“œë¡œ ì •ë ¬ëœ ìƒíƒœì—ì„œ ì°¾ê¸°
          const sortedEvents = [...eventsData].sort(
            (a, b) => (a.order || 0) - (b.order || 0)
          );
          console.log("sortedEvents:", sortedEvents);

          const currentEvent = sortedEvents.find((e) => e.id === eventId);
          console.log("currentEvent:", currentEvent);

          if (!currentEvent) {
            console.log("í˜„ì¬ ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const currentIndex = sortedEvents.indexOf(currentEvent);
          console.log("currentIndex:", currentIndex);

          if (currentIndex >= sortedEvents.length - 1) {
            console.log("ì´ë¯¸ ë§¨ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤.");
            return;
          }

          const targetEvent = sortedEvents[currentIndex + 1];
          console.log("targetEvent:", targetEvent);

          // order ê°’ êµí™˜
          const currentOrder = currentEvent.order ?? currentIndex;
          const targetOrder = targetEvent.order ?? currentIndex + 1;

          console.log("currentOrder:", currentOrder);
          console.log("targetOrder:", targetOrder);

          if (currentOrder === targetOrder) {
            console.log(
              "ê°™ì€ order ê°’ì„ ê°€ì§„ ì´ë²¤íŠ¸ë“¤ì…ë‹ˆë‹¤. ì‹¤ì œ order ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
            );

            const newCurrentOrder = currentIndex + 1;
            const newTargetOrder = currentIndex;

            console.log(
              "ìƒˆë¡œìš´ order ê°’ - current:",
              newCurrentOrder,
              "target:",
              newTargetOrder
            );

            await updateDoc(doc(db, "events", eventId), {
              order: newCurrentOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: newTargetOrder,
            });
          } else {
            console.log("Firebase ì—…ë°ì´íŠ¸ ì‹œì‘...");
            await updateDoc(doc(db, "events", eventId), {
              order: targetOrder,
            });
            await updateDoc(doc(db, "events", targetEvent.id), {
              order: currentOrder,
            });
          }
          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");

          showAlert("âœ…", "ì´ë²¤íŠ¸ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
          // ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          smoothRender("main-content", renderAll);
        } catch (error) {
          console.error("ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /* ===== í™ˆ ë¸”ë¡ + ë¡œë“œë§µ ê´€ë¦¬ ===== */
      function renderBlockListItem(block) {
        return `
          <li class="flex flex-col sm:flex-row sm:items-start sm:justify-between p-3 bg-gray-50 rounded-lg border block-item gap-3" data-block-id="${
            block.id
          }">
            <div class="flex items-start gap-3 flex-1 min-w-0">
              <span class="text-xs px-2 py-1 rounded flex-shrink-0 ${
                block.type === "scores"
                  ? "bg-green-100 text-green-700"
                  : block.type === "qa"
                  ? "bg-blue-100 text-blue-700"
                  : block.type === "roadmap"
                  ? "bg-purple-100 text-purple-700"
                  : "bg-orange-100 text-orange-700"
              }">${
          block.type === "notice"
            ? "ê³µì§€"
            : block.type === "qa"
            ? "Q&A"
            : block.type === "roadmap"
            ? "ë¡œë“œë§µ"
            : "ì ìˆ˜íŒ"
        }</span>
              <div class="flex-1 min-w-0">
                <span class="font-medium block-title text-gray-800 break-words">${saf(
                  block.title || "(ì œëª© ì—†ìŒ)"
                )}</span>
                <span class="text-xs ${
                  block.visible !== false ? "text-green-600" : "text-gray-400"
                }">
                  <i class="fas ${
                    block.visible !== false ? "fa-eye" : "fa-eye-slash"
                  } mr-1"></i>
                  ${block.visible !== false ? "ë…¸ì¶œ" : "ìˆ¨ê¹€"}
                </span>
              </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0 sm:ml-2">
              <button class="edit-block-btn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors" 
                      data-id="${block.id}" data-type="${block.type}">
                <i class="fas fa-edit mr-1"></i>ìˆ˜ì •
              </button>
              <button class="delete-block-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors" 
                      data-id="${block.id}">
                <i class="fas fa-trash mr-1"></i>ì‚­ì œ
              </button>
            </div>
          </li>
        `;
      }

      // ë¸”ë¡ ìˆœì„œ ì €ì¥ í•¨ìˆ˜
      async function saveBlockOrder() {
        try {
          const sortableLists = document.querySelectorAll(".block-sortable");
          const updates = [];

          sortableLists.forEach((list) => {
            const showWhen = list.dataset.showWhen;
            const items = list.querySelectorAll(".block-item");

            items.forEach((item, index) => {
              const blockId = item.dataset.blockId;
              updates.push({
                id: blockId,
                order: index,
                showWhen: showWhen || "",
              });
            });
          });

          const batch = writeBatch(db);
          updates.forEach((update) => {
            const blockRef = doc(db, "homepageBlocks", update.id);
            batch.update(blockRef, {
              order: update.order,
              showWhen: update.showWhen,
            });
          });

          await batch.commit();
          showAlert("âœ…", "ë¸”ë¡ ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("ë¸”ë¡ ìˆœì„œ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ë¸”ë¡ ìˆœì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ë¸”ë¡ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ (ì„¹ì…˜ ê°„ ì´ë™ ê°€ëŠ¥)
      function enableBlockDragAndDrop(list) {
        let draggedElement = null;

        list.addEventListener("dragstart", (e) => {
          if (e.target.classList.contains("block-item")) {
            draggedElement = e.target;
            e.target.style.opacity = "0.5";
            e.dataTransfer.effectAllowed = "move";
          }
        });

        list.addEventListener("dragend", (e) => {
          if (e.target.classList.contains("block-item")) {
            e.target.style.opacity = "";
            draggedElement = null;
          }
        });

        list.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        list.addEventListener("drop", (e) => {
          e.preventDefault();
          if (draggedElement) {
            if (e.target.closest(".block-item")) {
              // ê°™ì€ ì„¹ì…˜ ë‚´ì—ì„œ ì´ë™
              const targetElement = e.target.closest(".block-item");
              const rect = targetElement.getBoundingClientRect();
              const next =
                (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
              list.insertBefore(
                draggedElement,
                next ? targetElement.nextSibling : targetElement
              );
            } else {
              // ë‹¤ë¥¸ ì„¹ì…˜ìœ¼ë¡œ ì´ë™
              list.appendChild(draggedElement);
            }
          }
        });
      }

      // ëª¨ë“  ë¸”ë¡ ì„¹ì…˜ì— ë²„íŠ¼ ë°©ì‹ ìˆœì„œ ë³€ê²½ í™œì„±í™”
      function enableAllBlockDragAndDrop() {
        const allSortableLists = document.querySelectorAll(".block-sortable");
        allSortableLists.forEach((list) => {
          enableBlockButtonReorder(list);
        });
      }

      // ë¸”ë¡ ë²„íŠ¼ ë°©ì‹ ìˆœì„œ ë³€ê²½ í™œì„±í™”
      function enableBlockButtonReorder(list) {
        list.addEventListener("click", (e) => {
          const blockItem = e.target.closest(".block-item");
          if (!blockItem) return;

          if (e.target.classList.contains("move-up")) {
            const prev = blockItem.previousElementSibling;
            if (prev && prev.classList.contains("block-item")) {
              list.insertBefore(blockItem, prev);
              updateBlockButtonStates(list);
            }
          } else if (e.target.classList.contains("move-down")) {
            const next = blockItem.nextElementSibling;
            if (next && next.classList.contains("block-item")) {
              list.insertBefore(next, blockItem);
              updateBlockButtonStates(list);
            }
          }
        });

        // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        updateBlockButtonStates(list);
      }

      // ë¸”ë¡ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateBlockButtonStates(list) {
        const items = list.querySelectorAll(".block-item");
        items.forEach((item, index) => {
          const upBtn = item.querySelector(".move-up");
          const downBtn = item.querySelector(".move-down");

          if (upBtn) upBtn.disabled = index === 0;
          if (downBtn) downBtn.disabled = index === items.length - 1;
        });
      }

      // ë¡œë“œë§µ ë¸”ë¡ ìƒì„± ê¸°ëŠ¥ ì œê±°ë¨

      function renderHomeBlocksAdmin(container) {
        // í™ˆ ë ˆì´ì•„ì›ƒ ìˆœì„œ ê´€ë¦¬
        const homeOrderSec = `
  <div class="section">
    <h3 class="text-xl font-bold text-gray-800 mb-2">í™ˆ ì£¼ìš” ë¸”ë¡ ìˆœì„œ (ë¡œê·¸ì¸ ê³ ì •)</h3>
    <p class="text-xs text-gray-600  mb-2">ë¡œê·¸ì¸ ë¸”ë¡ì€ í•­ìƒ ë§¨ ìœ„ì— ê³ ì •ë©ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ìˆœì„œë¥¼ ë³€ê²½í•˜ì„¸ìš”.</p>
    <ul id="home-layout-sortable" class="sortable divide-y rounded border bg-white">
      <li class="flex items-center justify-between px-3 py-2 opacity-60 select-none">
        <div class="flex items-center gap-2"><i class="fas fa-lock text-gray-400"></i><span>ë¡œê·¸ì¸ (ê³ ì •)</span></div>
      </li>
      <li draggable="true" data-key="roadmap" class="flex items-center justify-between px-3 py-2">
        <div class="flex items-center gap-2 min-w-0">
          <i class="fas fa-grip-vertical text-gray-400 grip"></i><span class="truncate">FğŸ‘€die ì¼ì •</span>
        </div>
      </li>
      <li draggable="true" data-key="dynamic" class="flex items-center justify-between px-3 py-2">
        <div class="flex items-center gap-2 min-w-0">
          <i class="fas fa-grip-vertical text-gray-400 grip"></i><span class="truncate">í™ˆ í™”ë©´ ë¸”ë¡</span>
        </div>
      </li>
    </ul>
    <div class="mt-3">
      <button id="home-layout-save" class="px-3 py-2 bg-gray-800 text-white rounded">ìˆœì„œ ì €ì¥</button>
    </div>
  </div>`;
        container.insertAdjacentHTML("afterbegin", homeOrderSec);

        // ë²„íŠ¼ ë°©ì‹ ìˆœì„œ ë³€ê²½ í™œì„±í™”
        const hlUl = container.querySelector("#home-layout-sortable");

        // ì´ˆê¸°ê°’ ë°˜ì˜
        const cur =
          Array.isArray(homeLayout) && homeLayout.length
            ? homeLayout
            : ["login", "roadmap", "dynamic"];
        const orderNow = cur.filter((k) => k !== "login"); // ë‘ ê°œë§Œ
        if (orderNow[0] === "dynamic") {
          const liRoadmap = hlUl.querySelector("li[data-key='roadmap']");
          const liDynamic = hlUl.querySelector("li[data-key='dynamic']");
          liDynamic && hlUl.insertBefore(liDynamic, liRoadmap);
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        hlUl.addEventListener("click", (e) => {
          const li = e.target.closest("li[data-key]");
          if (!li) return;

          if (e.target.classList.contains("move-up")) {
            const prev = li.previousElementSibling;
            if (prev && prev.dataset.key) {
              hlUl.insertBefore(li, prev);
              updateButtonStates(hlUl);
            }
          } else if (e.target.classList.contains("move-down")) {
            const next = li.nextElementSibling;
            if (next && next.dataset.key) {
              hlUl.insertBefore(next, li);
              updateButtonStates(hlUl);
            }
          }
        });

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateButtonStates(ul) {
          const items = ul.querySelectorAll("li[data-key]");
          items.forEach((item, index) => {
            const upBtn = item.querySelector(".move-up");
            const downBtn = item.querySelector(".move-down");

            if (upBtn) upBtn.disabled = index === 0;
            if (downBtn) downBtn.disabled = index === items.length - 1;
          });
        }

        // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        updateButtonStates(hlUl);

        // ì €ì¥
        container.querySelector("#home-layout-save").onclick = async () => {
          const keys = [...hlUl.querySelectorAll("li[data-key]")].map(
            (li) => li.dataset.key
          );
          try {
            await setDoc(
              doc(db, "settings", "homeLayout"),
              { order: ["login", ...keys] },
              { merge: true }
            );
            showAlert("âœ…", "í™ˆ ë ˆì´ì•„ì›ƒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ì €ì¥ ì‹¤íŒ¨: " + e.message);
          }
        };

        // ìš´ì˜ì§„ì€ ë¸”ë¡ ê´€ë¦¬ íŒ¨ë„ ì ‘ê·¼ ë¶ˆê°€
        if (!isFullAdmin()) {
          container.innerHTML = `
            <div class="section">
              <div class="p-8 text-center">
                <i class="fas fa-lock text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-2">ë¸”ë¡ ê´€ë¦¬ëŠ” ì„ì›ì§„ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                <p class="text-sm text-gray-500">í˜„ì¬ ê¶Œí•œ: ${
                  currentUser?.position || "ì¼ë°˜ íšŒì›"
                }</p>
              </div>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="grid grid-cols-1 gap-4">
            <!-- ë¸”ë¡ ê´€ë¦¬ -->
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">ë¸”ë¡ ê´€ë¦¬</h3>
              <p class="text-xs text-gray-600 mb-2">ê³µì§€, Q&A, ì ìˆ˜íŒ, ë¡œë“œë§µ ë¸”ë¡ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              
              <div class="flex flex-col sm:flex-row gap-3 mb-4">
                <button id="add-new-block" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors btn-text">
                  <i class="fas fa-plus mr-2"></i>ìƒˆ ê³µì§€ ì¶”ê°€
                </button>
              </div>
              
              <!-- ë¸”ë¡ ì„¹ì…˜ë³„ ê´€ë¦¬ -->
              <div class="space-y-4">
                <!-- í•­ìƒ í‘œì‹œ ë¸”ë¡ -->
                <div class="border rounded-lg p-4">
                  <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-eye mr-2 text-green-500"></i>í•­ìƒ í‘œì‹œ ë¸”ë¡
                    <span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded">${
                      blocksData.filter((b) => !b.showWhen || b.showWhen === "")
                        .length
                    }ê°œ</span>
                  </h4>
                  <ul class="space-y-2 block-sortable" data-show-when="">
                    ${blocksData
                      .filter((b) => !b.showWhen || b.showWhen === "")
                      .sort((a, b) => (a.order || 0) - (b.order || 0))
                      .map((b) => renderBlockListItem(b))
                      .join("")}
                  </ul>
                </div>

                <!-- ë¡œê·¸ì¸ì‹œë§Œ í‘œì‹œ ë¸”ë¡ -->
                <div class="border rounded-lg p-4">
                  <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-sign-in-alt mr-2 text-blue-500"></i>ë¡œê·¸ì¸ì‹œë§Œ í‘œì‹œ ë¸”ë¡
                    <span class="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">${
                      blocksData.filter((b) => b.showWhen === "login").length
                    }ê°œ</span>
                  </h4>
                  <ul class="space-y-2 block-sortable" data-show-when="login">
                    ${blocksData
                      .filter((b) => b.showWhen === "login")
                      .sort((a, b) => (a.order || 0) - (b.order || 0))
                      .map((b) => renderBlockListItem(b))
                      .join("")}
                  </ul>
                </div>

                <!-- ë¡œê·¸ì•„ì›ƒì‹œë§Œ í‘œì‹œ ë¸”ë¡ -->
                <div class="border rounded-lg p-4">
                  <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-sign-out-alt mr-2 text-purple-500"></i>ë¡œê·¸ì•„ì›ƒì‹œë§Œ í‘œì‹œ ë¸”ë¡
                    <span class="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">${
                      blocksData.filter((b) => b.showWhen === "logout").length +
                      (roadmapData && roadmapData.length > 0 ? 1 : 0)
                    }ê°œ</span>
                  </h4>
                  <ul class="space-y-2 block-sortable" data-show-when="logout">
                    ${
                      roadmapData && roadmapData.length > 0
                        ? `
                      <li class="flex items-center justify-between px-3 py-2 bg-orange-50 border border-orange-200 rounded">
                        <div class="flex items-center gap-2 min-w-0">
                          <i class="fas fa-grip-vertical text-gray-400 grip"></i>
                          <i class="fas fa-calendar-alt text-orange-500"></i>
                          <span class="truncate font-medium">FğŸ‘€die ì¼ì •</span>
                          <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">ìë™</span>
                        </div>
                        <div class="flex gap-1">
                          <button class="move-block-up bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                                  data-block-id="auto-schedule-block" title="ìœ„ë¡œ ì´ë™">
                            <i class="fas fa-arrow-up"></i>
                          </button>
                          <button class="move-block-down bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors" 
                                  data-block-id="auto-schedule-block" title="ì•„ë˜ë¡œ ì´ë™">
                            <i class="fas fa-arrow-down"></i>
                          </button>
                        </div>
                      </li>
                    `
                        : ""
                    }
                    ${blocksData
                      .filter((b) => b.showWhen === "logout")
                      .sort((a, b) => (a.order || 0) - (b.order || 0))
                      .map((b) => renderBlockListItem(b))
                      .join("")}
                  </ul>
                </div>
              </div>
              
              <div class="mt-4 flex flex-col sm:flex-row gap-2">
                <button id="save-block-order" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors btn-text">
                  <i class="fas fa-save mr-2"></i>ë¸”ë¡ ìˆœì„œ ì €ì¥
                </button>
              </div>
            </div>

            <!-- ë¡œë“œë§µ ê´€ë¦¬ - ë¸”ë¡ ê´€ë¦¬ ì‹œìŠ¤í…œìœ¼ë¡œ í†µí•©ë¨ -->
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">FğŸ‘€die ì¼ì • ê´€ë¦¬</h3>
              <p class="text-xs text-gray-600 mb-2">
                ì´ì œ ë¸”ë¡ ê´€ë¦¬ ì‹œìŠ¤í…œì—ì„œ ë¡œë“œë§µì„ ê´€ë¦¬í•©ë‹ˆë‹¤. 
                <a href="#blocks" class="text-blue-600 hover:underline">ë¸”ë¡ ê´€ë¦¬</a> íƒ­ì—ì„œ ë¡œë“œë§µ ë¸”ë¡ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.
              </p>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center">
                  <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                  <div>
                    <h4 class="font-medium text-blue-800">ë¡œë“œë§µì´ ë¸”ë¡ ê´€ë¦¬ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤</h4>
                    <p class="text-sm text-blue-600 mt-1">
                      ë¡œë“œë§µ í•­ëª©ë“¤ì„ ê°œë³„ ë¸”ë¡ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                      ë¸”ë¡ ê´€ë¦¬ íƒ­ì—ì„œ "ë¡œë“œë§µ" íƒ€ì…ì˜ ë¸”ë¡ì„ ìƒì„±í•˜ê³  ìˆœì„œë¥¼ ì¡°ì •í•˜ì„¸ìš”.
                    </p>
                  </div>
                </div>
              </div>
            </div>

          </div>`;

        // ë¸”ë¡ ìˆœì„œ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        const saveOrderBtn = container.querySelector("#save-block-order");
        if (saveOrderBtn) {
          saveOrderBtn.addEventListener("click", async () => {
            await saveBlockOrder();
          });
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í™œì„±í™”
        setTimeout(() => {
          enableAllBlockDragAndDrop();
        }, 100);

        // ìƒˆë¡œìš´ í†µí•© ë¸”ë¡ ê´€ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        container.addEventListener("click", async (e) => {
          // ìƒˆ ë¸”ë¡ ìƒì„± ë²„íŠ¼
          if (
            e.target.closest("#add-new-block") ||
            e.target.closest(".add-block-placeholder")
          ) {
            openBlockModal();
            return;
          }

          // ë¡œë“œë§µ ë¸”ë¡ ìƒì„± ê¸°ëŠ¥ ì œê±°ë¨

          // ë¸”ë¡ ìˆ˜ì • ë²„íŠ¼
          if (e.target.closest(".edit-block-btn")) {
            const btn = e.target.closest(".edit-block-btn");
            const blockId = btn.dataset.id;
            const blockType = btn.dataset.type;
            openBlockModal(blockType, blockId);
            return;
          }

          // ë¸”ë¡ ì‚­ì œ ë²„íŠ¼
          if (e.target.closest(".delete-block-btn")) {
            const btn = e.target.closest(".delete-block-btn");
            const blockId = btn.dataset.id;
            if (!confirm("ë¸”ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

            try {
              await deleteDoc(doc(db, "homepageBlocks", blockId));
              showAlert("âœ…", "ë¸”ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
              renderHomeBlocksAdmin(container);
            } catch (error) {
              showAlert("ğŸ˜¥", "ë¸”ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
            return;
          }
        });

        // ë¡œë“œë§µ ê´€ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const rmUl = container.querySelector("#roadmap-sortable");
        if (rmUl) {
          enableSimpleDnd(rmUl);
        }

        // ë¡œë“œë§µ ê´€ë¦¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const rmAddBtn = container.querySelector("#rm-add");
        if (rmAddBtn) {
          rmAddBtn.addEventListener("click", async () => {
            const name = container.querySelector("#rm-name")?.value.trim();
            const date = container.querySelector("#rm-date")?.value;
            if (!name || !date) {
              showAlert("ğŸ˜¥", "í™œë™ ì´ë¦„ê³¼ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
              return;
            }
            try {
              await addDoc(collection(db, "roadmap"), {
                activityName: name,
                activityDate: date,
                order: roadmapData?.length || 0,
              });
              showAlert("âœ…", "ë¡œë“œë§µ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              container.querySelector("#rm-name").value = "";
              container.querySelector("#rm-date").value = "";
            } catch (err) {
              showAlert("ğŸ˜¥", "ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          });
        }

        const rmSaveBtn = container.querySelector("#save-roadmap-order");
        if (rmSaveBtn) {
          rmSaveBtn.addEventListener("click", async () => {
            const lis = [
              ...container.querySelectorAll("#roadmap-sortable li[data-id]"),
            ];
            if (!lis.length) return showAlert("â„¹ï¸", "ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

            try {
              const batch = writeBatch(db);
              lis.forEach((li, idx) => {
                const id = li.dataset.id;
                batch.set(
                  doc(db, "roadmap", id),
                  { order: idx },
                  { merge: true }
                );
              });
              await batch.commit();
              showAlert("âœ…", "ë¡œë“œë§µ ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
              showAlert("ğŸ˜¥", "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          });
        }

        if (rmUl) {
          rmUl.addEventListener("click", async (e) => {
            const li = e.target.closest("li[data-id]");
            if (!li) return;
            const id = li.dataset.id;

            if (e.target.closest(".rm-edit")) {
              const name = prompt(
                "í™œë™ ì´ë¦„:",
                li.querySelector("b").textContent
              );
              const date = prompt(
                "ë‚ ì§œ (YYYY-MM-DD):",
                li.querySelector(".text-sm").textContent
              );
              if (name && date) {
                try {
                  await updateDoc(doc(db, "roadmap", id), {
                    activityName: name,
                    activityDate: date,
                  });
                  showAlert("âœ…", "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (err) {
                  showAlert("ğŸ˜¥", "ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
              }
              return;
            }
            if (e.target.closest(".rm-delete")) {
              if (!confirm("í•´ë‹¹ ë¡œë“œë§µ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?")) return;
              await deleteDoc(doc(db, "roadmap", id));
              showAlert("ğŸ—‘ï¸", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          });
        }
      }

      function renderRoadmapAdminList() {
        if (!roadmapData?.length)
          return `<li class="px-3 py-2 text-gray-400">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
        const sorted = [...roadmapData].sort((a, b) => {
          const ao = a.order ?? 999999,
            bo = b.order ?? 999999;
          if (ao !== bo) return ao - bo;
          return (a.activityDate || "").localeCompare(b.activityDate || "");
        });
        return sorted
          .map(
            (r) => `<li draggable="true" data-id="${
              r.id
            }" class="flex items-center justify-between px-3 py-2">
            <div class="flex items-center gap-2 min-w-0">
              <i class="fas fa-grip-vertical text-gray-400"></i>
              <span class="truncate"><b>${saf(
                r.activityName || ""
              )}</b> <span class="text-sm text-gray-500 ml-1">${saf(
              r.activityDate || "-"
            )}</span></span>
            </div>
            <div class="flex items-center gap-2">
              <button class="rm-edit text-blue-600" title="ìˆ˜ì •"><i class="fas fa-pen"></i></button>
              <button class="rm-delete text-red-600" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>
            </div>
          </li>`
          )
          .join("");
      }

      function addQAItem(host, q = "", a = "") {
        host.insertAdjacentHTML(
          "beforeend",
          `<div class="qa-row grid grid-cols-1 md:grid-cols-5 gap-2">
            <input data-q class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 md:col-span-2" placeholder="ì§ˆë¬¸" value="${saf(
              q
            )}">
            <input data-a class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 md:col-span-3" placeholder="ë‹µë³€" value="${saf(
              a
            )}">
            <button type="button" class="remove-qa text-red-600 text-sm"><i class="fas fa-trash"></i></button>
          </div>`
        );
      }

      function addScoreRow(host, name = "", score = 0) {
        host.insertAdjacentHTML(
          "beforeend",
          `<div class="score-row grid grid-cols-12 gap-2">
            <input data-name class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-7" placeholder="ì¡° ì´ë¦„" value="${saf(
              name
            )}">
            <input data-score type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-4" placeholder="ì ìˆ˜" value="${saf(
              score
            )}">
            <button type="button" class="remove-score-row text-red-600 col-span-1"><i class="fas fa-trash"></i></button>
          </div>`
        );
      }

      function enableSimpleDnd(ul) {
        let dragging = null;
        ul.addEventListener("dragstart", (e) => {
          dragging = e.target.closest("li");
          if (dragging) dragging.classList.add("dragging");
        });
        ul.addEventListener("dragend", () => {
          if (dragging) dragging.classList.remove("dragging");
          dragging = null;
        });
        ul.addEventListener("dragover", (e) => {
          e.preventDefault();
          const after = [...ul.querySelectorAll("li:not(.dragging)")].find(
            (li) => {
              const rect = li.getBoundingClientRect();
              return e.clientY <= rect.top + rect.height / 2;
            }
          );
          if (!dragging) return;
          if (after) ul.insertBefore(dragging, after);
          else ul.appendChild(dragging);
        });
      }

      /* ===== íšŒì› ê´€ë¦¬ íƒ­ (ìš”ì²­ì‚¬í•­ 2, 7: ë²„íŠ¼ ë‹¨ìˆœí™”/ê·¸ë£¹ ë¶„ë¦¬) ===== */
      function renderMembersAdmin(container) {
        const pendingSet = (membersData || []).filter(
          (m) => (m.status || "pending") !== "active"
        );
        const activeSet = (membersData || []).filter(
          (m) => (m.status || "pending") === "active"
        );

        container.innerHTML = `<div class="section">
          <h3 class="text-xl font-bold text-gray-800 mb-2">íšŒì› ê´€ë¦¬</h3>

          <div class="flex flex-wrap items-center gap-2 mb-3">
            <input id="member-search" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  flex-1 min-w-[200px]" placeholder="ì´ë¦„/í•™ë²ˆ/í•™ê³¼ ê²€ìƒ‰">
            <button id="members-bulk-approve" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
              <i class="fas fa-check-circle mr-1"></i>ëŒ€ê¸° íšŒì› ì¼ê´„ ìŠ¹ì¸
            </button>
            <button id="members-export" class="px-3 py-2 bg-blue-600 text-white rounded"><i class="fas fa-file-csv mr-1"></i>CSV ë‹¤ìš´ë¡œë“œ(í•œê¸€)</button>
            <button id="members-delete-all" class="px-3 py-2 bg-red-600 text-white rounded"><i class="fas fa-trash mr-1"></i>íšŒì› ì „ì²´ ì‚­ì œ</button>
          </div>

          <!-- ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
            <h4 class="text-lg font-semibold text-gray-800 mb-3">
              <i class="fas fa-file-excel mr-2 text-green-600"></i>ì—‘ì…€ íŒŒì¼ë¡œ íšŒì› ì¼ê´„ ê´€ë¦¬
            </h4>
            <div class="space-y-3">
              <div class="text-sm text-gray-600">
                <p class="mb-2">ğŸ“‹ <strong>íŒŒì¼ ì–‘ì‹:</strong> ì´ë¦„, í•™ë²ˆ, ì„±ë³„, í•™ë…„, ë‹¨ê³¼ëŒ€, í•™ê³¼, ì „í™”ë²ˆí˜¸, ìƒíƒœ</p>
                <p class="mb-2">ğŸ“ <strong>ìƒíƒœ ê°’:</strong> ìŠ¹ì¸, ëŒ€ê¸°, ê±°ì ˆ, ì°¨ë‹¨</p>
                <p class="text-xs text-gray-500">â€¢ ì§€ì› í˜•ì‹: Excel (.xlsx, .xls), CSV (.csv)</p>
                <p class="text-xs text-gray-500">â€¢ ì¤‘ë³µ íšŒì›(í•™ë²ˆ ê¸°ì¤€)ì€ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</p>
                <p class="text-xs text-gray-500">â€¢ ìƒˆë¡œìš´ íšŒì›ì€ ìë™ìœ¼ë¡œ 'ëŒ€ê¸°' ìƒíƒœë¡œ ë“±ë¡ë©ë‹ˆë‹¤</p>
                <p class="text-xs text-blue-600">â€¢ ì–‘ì‹ì— ë§ì§€ ì•Šì•„ë„ ì¸ì‹ëœ ì •ë³´ë§Œìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤</p>
              </div>
              
              <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
              <div id="file-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-400 transition-colors cursor-pointer">
                <div class="space-y-2">
                  <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                  <p class="text-gray-600 font-medium">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                  <p class="text-xs text-gray-500">Excel (.xlsx, .xls) ë˜ëŠ” CSV (.csv) íŒŒì¼</p>
                </div>
              </div>
              
              <div class="flex items-center gap-3">
                <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv" class="hidden">
                <button id="excel-upload-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                  <i class="fas fa-upload mr-2"></i>íŒŒì¼ ì„ íƒ
                </button>
                <button id="download-template" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                  <i class="fas fa-download mr-2"></i>ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                </button>
              </div>
              <div id="upload-progress" class="hidden">
                <div class="bg-blue-100 border border-blue-300 rounded p-3">
                  <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                    <span class="text-sm text-blue-700">ì—‘ì…€ íŒŒì¼ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</span>
                  </div>
                </div>
              </div>
              <div id="upload-result" class="hidden">
                <!-- ì—…ë¡œë“œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div>
              <h4 class="font-semibold text-amber-700 mb-2">ìŠ¹ì¸ í•„ìš”(ëŒ€ê¸°/ê±°ì ˆ/ì°¨ë‹¨) <span class="bg-amber-100 text-amber-800 px-2 py-1 rounded-full text-xs ml-2">${
                pendingSet.length
              }ëª…</span></h4>
              <div class="overflow-auto border rounded">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-3 py-2 text-left">ì´ë¦„</th>
                      <th class="px-3 py-2 text-left">í•™ë²ˆ</th>
                      <th class="px-3 py-2 text-left">ì„±ë³„</th>
                      <th class="px-3 py-2 text-left">í•™ë…„</th>
                      <th class="px-3 py-2 text-left">ë‹¨ê³¼ëŒ€</th>
                      <th class="px-3 py-2 text-left">í•™ê³¼</th>
                      <th class="px-3 py-2 text-left">ì „í™”ë²ˆí˜¸</th>
                      <th class="px-3 py-2 text-left">ìƒíƒœ</th>
                      <th class="px-3 py-2 text-left">ê´€ë¦¬</th>
                    </tr>
                  </thead>
                  <tbody id="members-tbody-pending">${membersRowsHTMLGrouped(
                    pendingSet,
                    true,
                    memberSearchTerm
                  )}</tbody>
                </table>
              </div>
            </div>

            <div>
              <h4 class="font-semibold text-emerald-700 mb-2">í™œë™ì¤‘(ìŠ¹ì¸ë¨) <span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded-full text-xs ml-2">${
                activeSet.length
              }ëª…</span></h4>
              <div class="overflow-auto border rounded">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-3 py-2 text-left">ì´ë¦„</th>
                      <th class="px-3 py-2 text-left">í•™ë²ˆ</th>
                      <th class="px-3 py-2 text-left">ì„±ë³„</th>
                      <th class="px-3 py-2 text-left">í•™ë…„</th>
                      <th class="px-3 py-2 text-left">ë‹¨ê³¼ëŒ€</th>
                      <th class="px-3 py-2 text-left">í•™ê³¼</th>
                      <th class="px-3 py-2 text-left">ì „í™”ë²ˆí˜¸</th>
                      <th class="px-3 py-2 text-left">ê´€ë¦¬</th>
                    </tr>
                  </thead>
                  <tbody id="members-tbody-active">${membersRowsHTMLGrouped(
                    activeSet,
                    false,
                    memberSearchTerm
                  )}</tbody>
                </table>
              </div>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-2">* CSVëŠ” UTF-8(BOM)ìœ¼ë¡œ ì €ì¥ë˜ì–´ ì—‘ì…€ì—ì„œ í•œê¸€ì´ ê¹¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>`;

        // ê²€ìƒ‰
        const searchInput = container.querySelector("#member-search");
        searchInput.value = memberSearchTerm;
        searchInput.addEventListener("input", (e) => {
          memberSearchTerm = e.target.value;
          const pendingSetNow = (membersData || []).filter(
            (m) => (m.status || "pending") !== "active"
          );
          const activeSetNow = (membersData || []).filter(
            (m) => (m.status || "pending") === "active"
          );
          container.querySelector("#members-tbody-pending").innerHTML =
            membersRowsHTMLGrouped(pendingSetNow, true, memberSearchTerm);
          container.querySelector("#members-tbody-active").innerHTML =
            membersRowsHTMLGrouped(activeSetNow, false, memberSearchTerm);
        });

        // ë²„íŠ¼ë“¤
        container
          .querySelector("#members-export")
          .addEventListener("click", exportMembersCSV);
        container
          .querySelector("#members-bulk-approve")
          .addEventListener("click", bulkApproveMembers);
        container
          .querySelector("#members-delete-all")
          .addEventListener("click", deleteAllMembers);

        container.addEventListener("click", onMembersTableClick);
      }
      function membersRowsHTMLGrouped(list, isPendingGroup, keyword) {
        const kw = (keyword || "").toLowerCase();
        const filtered = (list || []).filter((m) => {
          const s = [m.name, m.studentId, m.department, m.college, m.phone].map(
            (x) => String(x || "").toLowerCase()
          );
          return kw ? s.some((v) => v.includes(kw)) : true;
        });
        if (filtered.length === 0)
          return `<tr><td colspan="${
            isPendingGroup ? 9 : 8
          }" class="px-3 py-4 text-center text-gray-400">í•´ë‹¹ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;

        const mapStatus = (s) =>
          ({
            active: "í™œë™ì¤‘",
            pending: "ìŠ¹ì¸ëŒ€ê¸°",
            rejected: "ê±°ì ˆ",
            blocked: "ì°¨ë‹¨",
          }[s] ||
          s ||
          "-");

        return filtered
          .map((m) => {
            // ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
            const isAdmin = adminList.includes(m.studentId);
            const adminBtn = isAdmin
              ? `<span class="text-xs text-purple-600 font-semibold"><i class="fas fa-crown mr-1"></i>ê´€ë¦¬ì</span>`
              : `<button class="text-purple-700 hover:text-purple-900 text-xs" data-act="make-admin" data-id="${m.studentId}"><i class="fas fa-user-shield mr-1"></i>ê´€ë¦¬ì ì¶”ê°€</button>`;

            const actionBtns = isPendingGroup
              ? `<button class="text-emerald-700 hover:text-emerald-900 text-xs" data-act="approve" data-id="${m.studentId}"><i class="fas fa-check mr-1"></i>ìŠ¹ì¸</button>
               <button class="text-amber-700 hover:text-amber-900 text-xs" data-act="reject" data-id="${m.studentId}"><i class="fas fa-xmark mr-1"></i>ê±°ì ˆ</button>
               <button class="text-gray-700 hover:text-black text-xs" data-act="block" data-id="${m.studentId}"><i class="fas fa-ban mr-1"></i>ì°¨ë‹¨</button>
               <button class="text-blue-700 hover:text-blue-900 text-xs" data-act="edit" data-id="${m.studentId}"><i class="fas fa-pen mr-1"></i>ìˆ˜ì •</button>
               <button class="text-red-700 hover:text-red-900 text-xs" data-act="delete" data-id="${m.studentId}"><i class="fas fa-trash mr-1"></i>ì‚­ì œ</button>
               ${adminBtn}`
              : `<button class="text-gray-700 hover:text-black text-xs" data-act="block" data-id="${m.studentId}"><i class="fas fa-ban mr-1"></i>ì°¨ë‹¨</button>
               <button class="text-blue-700 hover:text-blue-900 text-xs" data-act="edit" data-id="${m.studentId}"><i class="fas fa-pen mr-1"></i>ìˆ˜ì •</button>
               <button class="text-red-700 hover:text-red-900 text-xs" data-act="delete" data-id="${m.studentId}"><i class="fas fa-trash mr-1"></i>ì‚­ì œ</button>
               ${adminBtn}`;

            return `<tr class="border-t">
            <td class="px-3 py-2 whitespace-nowrap">${saf(m.name || "")}</td>
            <td class="px-3 py-2 font-mono whitespace-nowrap">${saf(
              m.studentId || ""
            )}</td>
            <td class="px-3 py-2 whitespace-nowrap">${saf(m.gender || "")}</td>
            <td class="px-3 py-2 whitespace-nowrap">${saf(m.year || "")}</td>
            <td class="px-3 py-2 whitespace-nowrap">${saf(m.college || "")}</td>
            <td class="px-3 py-2 whitespace-nowrap">${saf(
              m.department || ""
            )}</td>
            <td class="px-3 py-2 whitespace-nowrap">${saf(m.phone || "")}</td>
            ${
              isPendingGroup
                ? `<td class="px-3 py-2">${mapStatus(m.status)}</td>`
                : ""
            }
            <td class="px-3 py-2 space-x-2 whitespace-nowrap">${actionBtns}</td>
          </tr>`;
          })
          .join("");
      }
      function onMembersTableClick(e) {
        const btn = e.target.closest("button[data-act]");
        if (!btn) return;
        const act = btn.dataset.act;
        const sid = btn.dataset.id;
        if (act === "approve") return approveMember(sid);
        if (act === "reject") return updateMemberStatus(sid, "rejected");
        if (act === "block") return updateMemberStatus(sid, "blocked");
        if (act === "delete") return deleteMember(sid);
        if (act === "edit") return openMemberEditModal(sid);
        if (act === "make-admin") return makeAdminFromMember(sid);
      }
      async function approveMember(sid) {
        try {
          await updateDoc(doc(db, "members", sid), { status: "active" });
          showAlert("âœ…", "ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      }
      async function updateMemberStatus(sid, status) {
        try {
          await updateDoc(doc(db, "members", sid), { status });
          showAlert("âœ…", "ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      }
      async function deleteMember(sid) {
        if (!confirm("í•´ë‹¹ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?")) return;
        try {
          await deleteDoc(doc(db, "members", sid));
          showAlert("ğŸ—‘ï¸", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ì‚­ì œ ì‹¤íŒ¨");
        }
      }

      async function makeAdminFromMember(sid) {
        // íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const member = membersData.find((m) => m.studentId === sid);
        if (!member) {
          showAlert("ğŸ˜¥", "íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ì´ë¯¸ ê´€ë¦¬ìì¸ ê²½ìš°
        if (adminList.includes(sid)) {
          showAlert("â„¹ï¸", "ì´ë¯¸ ê´€ë¦¬ìì…ë‹ˆë‹¤.");
          return;
        }

        // ì§ì±… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const defaultPositions = [
          "íšŒì¥",
          "ë¶€íšŒì¥",
          "ì´ë¬´",
          "ê¸°íšë¶€ì¥",
          "í™ë³´ë¶€ì¥",
          "ìš´ì˜ì§„",
        ];
        const allPositions = [
          ...defaultPositions,
          ...customDefaultPositions,
        ].filter((pos) => !deletedDefaultPositions.includes(pos));

        // ì§ì±… ì„ íƒ ëª¨ë‹¬ ìƒì„±
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-800">
                <i class="fas fa-user-shield mr-2 text-purple-600"></i>ê´€ë¦¬ìë¡œ ì¶”ê°€
              </h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="mb-4">
              <p class="text-sm text-gray-600 mb-2">
                <strong>${
                  member.name
                }</strong> (${sid}) ë‹˜ì„ ê´€ë¦¬ìë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
              </p>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">ì§ì±… ì„ íƒ</label>
              <select id="admin-position-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="">ì§ì±…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                ${allPositions
                  .map((pos) => `<option value="${pos}">${pos}</option>`)
                  .join("")}
              </select>
            </div>
            
            <div class="flex gap-2 justify-end">
              <button 
                onclick="this.closest('.fixed').remove()" 
                class="px-4 py-2 text-gray-600 hover:text-gray-800"
              >
                ì·¨ì†Œ
              </button>
              <button 
                id="confirm-make-admin" 
                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
              >
                <i class="fas fa-user-shield mr-2"></i>ê´€ë¦¬ì ì¶”ê°€
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // í™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
        modal
          .querySelector("#confirm-make-admin")
          .addEventListener("click", async () => {
            const position = modal.querySelector(
              "#admin-position-select"
            ).value;

            if (!position) {
              showAlert("ğŸ˜¥", "ì§ì±…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              // ê´€ë¦¬ì ëª©ë¡ì— ì¶”ê°€
              const newAdminList = [...adminList, sid];
              const newAdminPositions = { ...adminPositions, [sid]: position };

              await setDoc(doc(db, "admins", "list"), {
                studentIds: newAdminList,
                positions: newAdminPositions,
              });

              showAlert(
                "âœ…",
                `${member.name} ë‹˜ì´ ${position} ê´€ë¦¬ìë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`
              );
              modal.remove();

              // íšŒì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              const subtabContainer =
                document.getElementById("subtab-container");
              if (subtabContainer) {
                renderMembersAdmin(subtabContainer);
              }
            } catch (error) {
              console.error("ê´€ë¦¬ì ì¶”ê°€ ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ê´€ë¦¬ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });
      }
      function openMemberEditModal(sid) {
        const m = membersData.find((x) => (x.studentId || x.id) === sid) || {};
        el.blockEditorTitle.textContent = `íšŒì› ì •ë³´ ìˆ˜ì • â€” ${saf(
          m.name || ""
        )}`;
        el.blockEditorBody.innerHTML = `<div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
              <input id="mem-name" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value="${saf(
                m.name || ""
              )}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">í•™ë²ˆ</label>
              <input id="mem-id" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 bg-gray-50" disabled placeholder="í•™ë²ˆ" value="${saf(
                m.studentId || ""
              )}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ì„±ë³„</label>
              <select id="mem-gender" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
              <option value="ë‚¨" ${
                m.gender === "ë‚¨" ? "selected" : ""
              }>ë‚¨</option>
              <option value="ì—¬" ${
                m.gender === "ì—¬" ? "selected" : ""
              }>ì—¬</option>
              <option value="ê¸°íƒ€" ${
                m.gender === "ê¸°íƒ€" ? "selected" : ""
              }>ê¸°íƒ€</option>
            </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">í•™ë…„</label>
              <select id="mem-year" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
              <option value="1í•™ë…„" ${
                m.year === "1í•™ë…„" ? "selected" : ""
              }>1í•™ë…„</option>
              <option value="2í•™ë…„" ${
                m.year === "2í•™ë…„" ? "selected" : ""
              }>2í•™ë…„</option>
              <option value="3í•™ë…„" ${
                m.year === "3í•™ë…„" ? "selected" : ""
              }>3í•™ë…„</option>
              <option value="4í•™ë…„" ${
                m.year === "4í•™ë…„" ? "selected" : ""
              }>4í•™ë…„</option>
              <option value="ê¸°íƒ€" ${
                m.year === "ê¸°íƒ€" ? "selected" : ""
              }>ê¸°íƒ€</option>
            </select>
            <input id="mem-college" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="ë‹¨ê³¼ëŒ€" value="${saf(
              m.college || ""
            )}">
            <input id="mem-dept" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="í•™ê³¼" value="${saf(
              m.department || ""
            )}">
            <input id="mem-phone" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="ì „í™”ë²ˆí˜¸" value="${saf(
              m.phone || ""
            )}">
            <select id="mem-status" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
              <option value="active" ${
                m.status === "active" ? "selected" : ""
              }>í™œë™ì¤‘</option>
              <option value="pending" ${
                m.status === "pending" ? "selected" : ""
              }>ìŠ¹ì¸ëŒ€ê¸°</option>
              <option value="rejected" ${
                m.status === "rejected" ? "selected" : ""
              }>ê±°ì ˆ</option>
              <option value="blocked" ${
                m.status === "blocked" ? "selected" : ""
              }>ì°¨ë‹¨</option>
            </select>
          </div>`;
        el.blockEditor.classList.remove("hidden");
        el.blockEditorSave.onclick = async () => {
          try {
            await updateDoc(doc(db, "members", sid), {
              name: document.getElementById("mem-name").value.trim(),
              gender: document.getElementById("mem-gender").value,
              year: document.getElementById("mem-year").value,
              college: document.getElementById("mem-college").value.trim(),
              department: document.getElementById("mem-dept").value.trim(),
              phone: document.getElementById("mem-phone").value.trim(),
              status: document.getElementById("mem-status").value,
            });
            el.blockEditor.classList.add("hidden");
            showAlert("âœ…", "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch {
            showAlert("ğŸ˜¥", "ìˆ˜ì • ì‹¤íŒ¨");
          }
        };
        el.blockEditorCancel.onclick = () =>
          el.blockEditor.classList.add("hidden");
      }
      function exportMembersCSV() {
        const mapStatus = (s) =>
          ({
            active: "í™œë™ì¤‘",
            pending: "ìŠ¹ì¸ëŒ€ê¸°",
            rejected: "ê±°ì ˆ",
            blocked: "ì°¨ë‹¨",
          }[s] ||
          s ||
          "-");
        const rows = (membersData || []).map((m) => [
          m.name || "",
          m.studentId || "",
          m.gender || "",
          m.year || "",
          m.college || "",
          m.department || "",
          m.phone || "",
          mapStatus(m.status),
        ]);
        const header = [
          "ì´ë¦„",
          "í•™ë²ˆ",
          "ì„±ë³„",
          "í•™ë…„",
          "ë‹¨ê³¼ëŒ€",
          "í•™ê³¼",
          "ì „í™”ë²ˆí˜¸",
          "ìƒíƒœ",
        ];
        const escape = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
        const lines = [
          header.map(escape).join(","),
          ...rows.map((r) => r.map(escape).join(",")),
        ].join("\r\n");
        const bom = "\uFEFF";
        const blob = new Blob([bom + lines], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `members_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      async function bulkApproveMembers() {
        // ëŒ€ê¸° ì¤‘ì¸ íšŒì›ë“¤ í•„í„°ë§
        const pendingMembers = (membersData || []).filter(
          (m) => (m.status || "pending") === "pending"
        );

        if (pendingMembers.length === 0) {
          showAlert("â„¹ï¸", "ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const confirmMessage = `ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íšŒì› ${
          pendingMembers.length
        }ëª…ì„ ëª¨ë‘ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìŠ¹ì¸ë  íšŒì›:\n${pendingMembers
          .map((m) => `â€¢ ${m.name} (${m.studentId})`)
          .join("\n")}`;

        if (!confirm(confirmMessage)) return;

        try {
          const batch = writeBatch(db);

          // ëª¨ë“  ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì„ activeë¡œ ë³€ê²½
          pendingMembers.forEach((member) => {
            const memberRef = doc(db, "members", member.id || member.studentId);
            batch.update(memberRef, {
              status: "active",
              lastUpdated: new Date().toISOString(),
            });
          });

          await batch.commit();
          showAlert(
            "âœ…",
            `${pendingMembers.length}ëª…ì˜ íšŒì›ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );

          // íšŒì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            const subtabContainer = document.getElementById("subtab-container");
            if (subtabContainer) {
              renderMembersAdmin(subtabContainer);
            }
          }, 1000);
        } catch (error) {
          console.error("ì¼ê´„ ìŠ¹ì¸ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì¼ê´„ ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function deleteAllMembers() {
        if (
          !confirm(
            "ì •ë§ë¡œ ëª¨ë“  íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          )
        )
          return;
        try {
          const snap = await getDocs(collection(db, "members"));
          const batch = writeBatch(db);
          snap.forEach((d) => batch.delete(doc(db, "members", d.id)));
          await batch.commit();
          showAlert("ğŸ—‘ï¸", "ì „ì²´ ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          showAlert("ğŸ˜¥", "ì „ì²´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /* ===== ëª…ì˜ˆì˜ ì „ë‹¹(ë³´ê´€) ì‚¬ìš©ì íƒ­ ===== */
      function renderHistoryTab(isAdmin) {
        const c = document.getElementById("history-tab");
        if (!c) return;

        // ì°¸ê°€í•œ ì´ë²¤íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ë§ˆê°ëœ ì´ë²¤íŠ¸ ë˜ëŠ” ì™„ë£Œëœ ì´ë²¤íŠ¸)
        const participatedEvents = eventsData.filter((ev) => {
          if (!currentUser) return false;

          // ì‹ ì²­ì ëª©ë¡ì—ì„œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
          const isApplicant = ev.applicants?.some(
            (a) => a.studentId === currentUser.studentId
          );

          // ë¯¸ì‹íšŒì˜ ê²½ìš° ê° ì‹ë‹¹ë³„ ì˜ˆì•½ì í™•ì¸
          let isRestaurantApplicant = false;
          if (ev.type === "tasting" && ev.restaurants) {
            isRestaurantApplicant = ev.restaurants.some((r) =>
              r.reservations?.some(
                (res) => res.studentId === currentUser.studentId
              )
            );
          }

          const isParticipant = isApplicant || isRestaurantApplicant;

          // ë§ˆê°ëœ ì´ë²¤íŠ¸ ë˜ëŠ” ì´ë¯¸ ì§€ë‚œ ì´ë²¤íŠ¸
          const isClosed = ev.status === "closed";
          const eventDate = new Date(ev.datetime);
          const today = new Date();
          const isPastEvent = eventDate < today;

          return isParticipant && (isClosed || isPastEvent);
        });

        if (participatedEvents.length === 0) {
          c.innerHTML = `<div class="section text-center py-12">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-orange-100 mb-4">
              <i class="fas fa-calendar-check text-4xl text-orange-400"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">ì•„ì§ ì°¸ê°€í•œ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-500 mb-4">ì´ë²¤íŠ¸ì— ì°¸ê°€í•˜ê³  ì¦ê±°ìš´ ê²½í—˜ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
            <button onclick="switchMainTab('reservation')" class="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition-colors font-medium">
              <i class="fas fa-plus mr-2"></i>ì´ë²¤íŠ¸ ë‘˜ëŸ¬ë³´ê¸°
            </button>
          </div>`;
          return;
        }

        // ê´€ë¦¬ì ë° ìš´ì˜ì§„ ì—¬ë¶€ í™•ì¸
        const isUserAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        // í•™ë²ˆ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜
        const maskStudentId = (studentId) => {
          if (!studentId) return "";
          if (studentId.length <= 4) return studentId;
          return studentId.substring(0, 4) + "****";
        };

        const eventCards = participatedEvents
          .map((ev) => {
            const eventDate = new Date(ev.datetime).toLocaleDateString("ko-KR");
            const hasReview = ev.reviews?.find(
              (r) => r.studentId === currentUser.studentId
            );

            // ì´ë²¤íŠ¸ ìƒíƒœ í™•ì¸
            const isClosed = ev.status === "closed";
            const eventDateTime = new Date(ev.datetime);
            const today = new Date();
            const isPastEvent = eventDateTime < today;

            // ë¯¸ì‹íšŒì¸ ê²½ìš° ì‹ ì²­í•œ ì‹ë‹¹ ì´ë¦„ê³¼ ì¸ì›ìˆ˜ ì°¾ê¸°
            let restaurantName = "";
            let restaurantParticipants = 0;
            if (ev.type === "tasting" && ev.restaurants && currentUser) {
              for (const restaurant of ev.restaurants) {
                if (
                  restaurant.reservations?.some(
                    (res) => res.studentId === currentUser.studentId
                  )
                ) {
                  restaurantName = restaurant.name;
                  restaurantParticipants = restaurant.reservations?.length || 0;
                  break;
                }
              }
            }

            // ì‚¬ìš©ìê°€ ì‹ ì²­í•œ ì •ë³´ ì°¾ê¸°
            const userApplicant = ev.applicants?.find(
              (a) => a.studentId === currentUser.studentId
            );
            const userRestaurantReservation = ev.restaurants
              ?.find((r) =>
                r.reservations?.some(
                  (res) => res.studentId === currentUser.studentId
                )
              )
              ?.reservations?.find(
                (res) => res.studentId === currentUser.studentId
              );

            // ì°¸ê°€ ì¸ì› ê³„ì‚° (ë¯¸ì‹íšŒëŠ” ì‹ë‹¹ ì¸ì›, ì¼ë°˜ ì´ë²¤íŠ¸ëŠ” ì „ì²´ ì¸ì›)
            const participantCount =
              ev.type === "tasting" && restaurantName
                ? restaurantParticipants
                : ev.applicants?.length || 0;

            return `<div class="section relative overflow-hidden" style="border-top: 4px solid #f97316;">
            <!-- í—¤ë” -->
            <div class="flex items-start justify-between mb-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeBadgeClass(
                    ev.type
                  )}">
                    ${typeLabel(ev.type)}
                  </span>
                  ${
                    isClosed
                      ? '<span class="bg-green-100 text-green-800 px-2.5 py-0.5 rounded-full text-xs font-medium"><i class="fas fa-check-circle mr-1"></i>í™•ì •</span>'
                      : ""
                  }
                  ${
                    ev.activityStatus === "confirmed"
                      ? '<span class="bg-emerald-100 text-emerald-800 px-2.5 py-0.5 rounded-full text-xs font-medium"><i class="fas fa-thumbs-up mr-1"></i>í™œë™ ì™„ë£Œ</span>'
                      : ""
                  }
                  ${
                    ev.activityStatus === "cancelled"
                      ? '<span class="bg-red-100 text-red-800 px-2.5 py-0.5 rounded-full text-xs font-medium"><i class="fas fa-ban mr-1"></i>í™œë™ ì·¨ì†Œ</span>'
                      : ""
                  }
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-1">${saf(
                  ev.title || "(ì œëª© ì—†ìŒ)"
                )}</h3>
              </div>
            </div>
            
            <!-- ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
              <div class="flex items-center gap-2 text-sm">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-orange-100">
                  <i class="fas fa-calendar text-orange-600"></i>
                </div>
                <div>
                  <p class="text-xs text-gray-500">ì´ë²¤íŠ¸ ì¼ì‹œ</p>
                  <p class="font-semibold text-gray-800">${new Date(
                    ev.datetime
                  ).toLocaleString("ko-KR", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                  })}</p>
                </div>
              </div>
              
              <div class="flex items-center gap-2 text-sm">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100">
                  <i class="fas fa-users text-blue-600"></i>
                </div>
                <div>
                  <p class="text-xs text-gray-500">${
                    ev.type === "tasting" && restaurantName
                      ? "ì‹ ì²­ ì‹ë‹¹ ì¸ì›"
                      : "ì°¸ê°€ ì¸ì›"
                  }</p>
                  <p class="font-semibold text-gray-800">${participantCount}ëª…</p>
                </div>
              </div>
            </div>
            
            <!-- ë‚´ ì‹ ì²­ ì •ë³´ (ê°•ì¡°) -->
            ${
              userApplicant || restaurantName
                ? `
            <div class="bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl p-4 mb-4">
              <div class="flex items-center gap-2 mb-3">
                <i class="fas fa-user-check text-orange-600"></i>
                <h4 class="font-bold text-gray-800">ë‚´ ì‹ ì²­ ì •ë³´</h4>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                ${
                  restaurantName
                    ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-utensils text-orange-500 w-4"></i>
                  <span class="text-gray-600">ì‹ ì²­ ì‹ë‹¹:</span>
                  <span class="font-bold text-orange-700">${saf(
                    restaurantName
                  )}</span>
                </div>
                `
                    : ""
                }
                ${
                  userApplicant
                    ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-clock text-orange-500 w-4"></i>
                  <span class="text-gray-600">ì‹ ì²­ì¼:</span>
                  <span class="font-semibold text-gray-700">${new Date(
                    userApplicant.timestamp
                  ).toLocaleDateString("ko-KR")}</span>
                </div>
                `
                    : ""
                }
                ${
                  userRestaurantReservation
                    ? `
                <div class="flex items-center gap-2">
                  <i class="fas fa-clock text-orange-500 w-4"></i>
                  <span class="text-gray-600">ì‹ ì²­ì¼:</span>
                  <span class="font-semibold text-gray-700">${new Date(
                    userRestaurantReservation.timestamp
                  ).toLocaleDateString("ko-KR")}</span>
                </div>
                `
                    : ""
                }
              </div>
            </div>
            `
                : ""
            }
            
            <!-- ê´€ë¦¬ììš© ì‹ ì²­ì ëª©ë¡ -->
            ${
              isUserAdmin
                ? `
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-center gap-2 mb-3">
                <i class="fas fa-list-ul text-blue-600"></i>
                <h4 class="font-bold text-gray-800">ì‹ ì²­ì ëª…ë‹¨</h4>
                <span class="text-xs text-blue-600">(ê´€ë¦¬ìÂ·ìš´ì˜ì§„ ì „ìš©)</span>
              </div>
              ${
                ev.type === "tasting" && restaurantName
                  ? `
                <!-- ë¯¸ì‹íšŒ: ì‹ ì²­í•œ ì‹ë‹¹ì˜ ì˜ˆì•½ì ëª©ë¡ -->
                <div class="space-y-1">
                  ${
                    ev.restaurants
                      ?.find((r) => r.name === restaurantName)
                      ?.reservations?.map(
                        (res, idx) => `
                    <div class="flex items-center justify-between bg-white rounded px-3 py-2 text-sm">
                      <div class="flex items-center gap-2">
                        <span class="text-gray-500">${idx + 1}.</span>
                        <span class="font-medium text-gray-800">${saf(
                          res.name
                        )}</span>
                      </div>
                      <span class="font-mono text-xs text-gray-600">${maskStudentId(
                        res.studentId
                      )}</span>
                    </div>
                  `
                      )
                      .join("") ||
                    '<p class="text-sm text-gray-500">ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                  }
                </div>
              `
                  : `
                <!-- ì¼ë°˜ ì´ë²¤íŠ¸: ì „ì²´ ì‹ ì²­ì ëª©ë¡ -->
                <div class="space-y-1">
                  ${
                    ev.applicants
                      ?.map(
                        (app, idx) => `
                    <div class="flex items-center justify-between bg-white rounded px-3 py-2 text-sm">
                      <div class="flex items-center gap-2">
                        <span class="text-gray-500">${idx + 1}.</span>
                        <span class="font-medium text-gray-800">${saf(
                          app.name
                        )}</span>
                      </div>
                      <span class="font-mono text-xs text-gray-600">${maskStudentId(
                        app.studentId
                      )}</span>
                    </div>
                  `
                      )
                      .join("") ||
                    '<p class="text-sm text-gray-500">ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                  }
                </div>
              `
              }
            </div>
            `
                : ""
            }
            
            <!-- í‰ê°€ ì„¹ì…˜ -->
            ${
              hasReview
                ? `
              <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span class="font-bold text-gray-800">ë‚´ í‰ê°€</span>
                  </div>
                  <div class="flex items-center gap-1">
                    ${Array.from(
                      { length: 5 },
                      (_, i) =>
                        `<i class="fas fa-star ${
                          i < hasReview.rating
                            ? "text-yellow-400"
                            : "text-gray-300"
                        }"></i>`
                    ).join("")}
                    <span class="ml-2 font-bold text-gray-700">${
                      hasReview.rating
                    }.0</span>
                  </div>
                </div>
                ${
                  hasReview.comment
                    ? `
                <div class="bg-white/50 rounded-lg p-3 border border-green-100">
                  <p class="text-sm text-gray-700 leading-relaxed">${saf(
                    hasReview.comment
                  )}</p>
                </div>
                `
                    : ""
                }
                <div class="mt-3 text-xs text-gray-500 flex items-center gap-1">
                  <i class="fas fa-clock"></i>
                  <span>${new Date(hasReview.timestamp).toLocaleString(
                    "ko-KR"
                  )}</span>
                </div>
              </div>
            `
                : ""
            }
            
            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="flex gap-2">
              ${
                isPastEvent || isClosed
                  ? `
              <button type="button" class="flex-1 ${
                hasReview
                  ? "bg-gray-600 hover:bg-gray-700"
                  : "bg-orange-500 hover:bg-orange-600"
              } text-white py-3 px-4 rounded-lg transition-colors font-medium shadow-md" 
                      data-act="write-review" data-id="${ev.id}">
                <i class="fas ${
                  hasReview ? "fa-edit" : "fa-pen-to-square"
                } mr-2"></i>
                ${hasReview ? "í‰ê°€ ìˆ˜ì •" : "í‰ê°€ ì‘ì„±"}
              </button>
              `
                  : `
              <div class="flex-1 bg-gray-100 text-gray-500 py-3 px-4 rounded-lg text-center font-medium">
                <i class="fas fa-lock mr-2"></i>
                í™œë™ ì¢…ë£Œ í›„ í‰ê°€ ê°€ëŠ¥
              </div>
              `
              }
            </div>
            
            ${
              isFullAdmin()
                ? `
            <div class="mt-3 pt-3 border-t border-gray-200">
              <div class="flex gap-2 flex-wrap">
                <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-edit" data-id="${
                          ev.id
                        }" title="ì´ë²¤íŠ¸ ìˆ˜ì •">
                  <i class="fas fa-pen mr-1"></i>ìˆ˜ì •
                </button>
                ${
                  isClosed
                    ? `
                <button type="button" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-reopen" data-id="${ev.id}" title="ë‹¤ì‹œ ì—´ê¸°">
                  <i class="fas fa-door-open mr-1"></i>ë‹¤ì‹œ ì—´ê¸°
                </button>
                `
                    : `
                <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-close" data-id="${ev.id}" title="ì‹ ì²­ ë§ˆê°">
                  <i class="fas fa-door-closed mr-1"></i>ì‹ ì²­ ë§ˆê°
                </button>
                `
                }
                <button type="button" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-unpost" data-id="${
                          ev.id
                        }" title="ê¸€ ë‚´ë¦¬ê¸°">
                  <i class="fas fa-arrow-down mr-1"></i>ê¸€ ë‚´ë¦¬ê¸°
                </button>
                <button type="button" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="group-maker" data-id="${
                          ev.id
                        }" title="ì¡°ì§œê¸°">
                  <i class="fas fa-users mr-1"></i>ì¡°ì§œê¸°
                </button>
                <button type="button" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="export-xlsx" data-id="${
                          ev.id
                        }" title="ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ">
                  <i class="fas fa-file-excel mr-1"></i>ëª…ë‹¨
                </button>
                ${
                  isPastEvent || isClosed
                    ? `
                <button type="button" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-confirm-activity" data-id="${ev.id}" title="í™œë™ í™•ì •">
                  <i class="fas fa-check-circle mr-1"></i>í™œë™ í™•ì •
                </button>
                <button type="button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm transition-colors" 
                        data-act="admin-cancel-activity" data-id="${ev.id}" title="í™œë™ ì·¨ì†Œ">
                  <i class="fas fa-times-circle mr-1"></i>í™œë™ ì·¨ì†Œ
                </button>
                `
                    : ""
                }
              </div>
            </div>
            `
                : ""
            }
          </div>`;
          })
          .join("");

        c.innerHTML = `
          <div class="section mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div class="flex-1">
                <h2 class="text-2xl font-bold mb-2 text-gray-800 flex items-center gap-2">
                  <i class="fas fa-history text-orange-500"></i>
                  í™œë™ ê¸°ë¡
                </h2>
                <p class="text-sm text-gray-600">ì°¸ê°€í•œ ì´ë²¤íŠ¸ ${participatedEvents.length}ê°œ â€¢ í‰ê°€ë¥¼ ë‚¨ê²¨ ë™ì•„ë¦¬ í™œë™ì„ ë”ìš± í’ì„±í•˜ê²Œ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
              </div>
              <div class="flex-shrink-0">
                <div class="inline-flex items-center gap-2 bg-orange-50 px-4 py-2 rounded-lg">
                  <i class="fas fa-trophy text-orange-500"></i>
                  <span class="font-bold text-orange-700">${participatedEvents.length}ê°œ ì°¸ì—¬</span>
                </div>
              </div>
            </div>
          </div>
          <div class="space-y-4">${eventCards}</div>
        `;

        // í‰ê°€ ì‘ì„± ì´ë²¤íŠ¸ ë°”ì¸ë”©
        c.addEventListener("click", async (e) => {
          if (e.target.closest('[data-act="write-review"]')) {
            const eventId = e.target.closest('[data-act="write-review"]')
              .dataset.id;
            openReviewModal(eventId);
          }
        });
      }

      // ë‚ ì§œ íŒŒì‹± í—¬í¼ í•¨ìˆ˜ (ì‹œê°„ëŒ€ ë¬¸ì œ í•´ê²°)
      function parseDate(dateString) {
        if (!dateString) return new Date();

        // YYYY-MM-DD í˜•ì‹ì˜ ë‚ ì§œ ë¬¸ìì—´ì„ ë¡œì»¬ ì‹œê°„ëŒ€ë¡œ íŒŒì‹±
        const parts = dateString.split("-");
        if (parts.length === 3) {
          const year = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1; // JavaScript DateëŠ” 0ë¶€í„° ì‹œì‘
          const day = parseInt(parts[2], 10);
          return new Date(year, month, day);
        }

        return new Date(dateString);
      }

      // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë°˜í™˜ (ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€)
      function getTodayString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // ê¹œë¹¡ê±°ë¦¼ ë°©ì§€ë¥¼ ìœ„í•œ ë¶€ë“œëŸ¬ìš´ ë Œë”ë§ í•¨ìˆ˜
      function smoothRender(
        containerId,
        renderFunction,
        loadingText = "ë¡œë”© ì¤‘..."
      ) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // 1. ë¡œë”© ìƒíƒœ í‘œì‹œ
        container.classList.add("content-loading", "smooth-transition");

        // 2. requestAnimationFrameì„ ì‚¬ìš©í•˜ì—¬ ë¶€ë“œëŸ¬ìš´ ì „í™˜
        requestAnimationFrame(() => {
          // 3. ìƒˆë¡œìš´ ì½˜í…ì¸  ë Œë”ë§
          renderFunction();

          // 4. ì§§ì€ ì§€ì—° í›„ ë¡œë”© ìƒíƒœ í•´ì œ
          setTimeout(() => {
            container.classList.remove("content-loading");
            container.classList.add("content-loaded");

            // 5. ì „í™˜ ì™„ë£Œ í›„ í´ë˜ìŠ¤ ì •ë¦¬
            setTimeout(() => {
              container.classList.remove("smooth-transition", "content-loaded");
            }, 200);
          }, 50);
        });
      }

      // ë‹¬ë ¥ ìƒì„± í•¨ìˆ˜

      function generateCalendar(
        year,
        month,
        events = [],
        showDownloadButtons = true,
        isAdmin = false
      ) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const endDate = new Date(lastDay);
        endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const weekDays = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
        const monthNames = [
          "1ì›”",
          "2ì›”",
          "3ì›”",
          "4ì›”",
          "5ì›”",
          "6ì›”",
          "7ì›”",
          "8ì›”",
          "9ì›”",
          "10ì›”",
          "11ì›”",
          "12ì›”",
        ];

        let calendarHTML = `
          <div class="calendar-container">
            <div class="calendar-header">
              <h3 class="calendar-title">FğŸ‘€die ë‹¬ë ¥</h3>
              <div class="calendar-nav">
                <button class="calendar-nav-btn calendar-nav-prev" onclick="changeCalendarMonth(-1)">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <div class="calendar-month-year">${year}ë…„ ${monthNames[month]}</div>
                <button class="calendar-nav-btn calendar-nav-next" onclick="changeCalendarMonth(1)">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
            <div class="calendar-grid">
        `;

        // ìš”ì¼ í—¤ë”
        weekDays.forEach((day) => {
          calendarHTML += `<div class="calendar-day-header">${day}</div>`;
        });

        // ë‹¬ë ¥ ë‚ ì§œë“¤
        const currentDate = new Date(startDate);
        while (currentDate <= endDate) {
          const isCurrentMonth = currentDate.getMonth() === month;
          const isToday = currentDate.getTime() === today.getTime();
          // ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (UTC ë³€í™˜ ë°©ì§€)
          const currentYear = currentDate.getFullYear();
          const currentMonth = String(currentDate.getMonth() + 1).padStart(
            2,
            "0"
          );
          const currentDay = String(currentDate.getDate()).padStart(2, "0");
          const dateStr = `${currentYear}-${currentMonth}-${currentDay}`;

          // í•´ë‹¹ ë‚ ì§œì˜ ì´ë²¤íŠ¸ë“¤ ì°¾ê¸° (ê¶Œí•œì— ë”°ë¼ í•„í„°ë§)
          const dayEvents = events.filter((event) => {
            const eventDate = event.activityDate;
            if (!eventDate) return false;
            if (eventDate !== dateStr) return false;

            // ìš´ì˜ì§„ ì „ìš© ì¼ì •ì¸ ê²½ìš° ê¶Œí•œ ì²´í¬
            if (event.isAdminOnly && !isAdminOrStaff()) {
              return false;
            }

            return true;
          });

          let dayClass = "calendar-day";
          if (!isCurrentMonth) dayClass += " other-month";
          if (isToday) dayClass += " today";

          // ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (UTC ë³€í™˜ ë°©ì§€)
          const yearForModal = currentDate.getFullYear();
          const monthForModal = String(currentDate.getMonth() + 1).padStart(
            2,
            "0"
          );
          const dayForModal = String(currentDate.getDate()).padStart(2, "0");
          const dateString = `${yearForModal}-${monthForModal}-${dayForModal}`;

          calendarHTML += `<div class="${dayClass}" onclick="openAddEventModal('${dateString}')">`;
          calendarHTML += `<div class="calendar-day-number">${currentDate.getDate()}</div>`;

          // ì´ë²¤íŠ¸ë“¤ ì¶”ê°€
          dayEvents.forEach((event) => {
            const eventDate = parseDate(event.activityDate);
            let eventClass = "calendar-event";

            // ìš´ì˜ì§„ ì „ìš© ì¼ì •ì¸ ê²½ìš° íŒŒë€ìƒ‰ í´ë˜ìŠ¤ ì¶”ê°€
            if (event.isAdminOnly) {
              eventClass += " admin-only";
            }

            if (eventDate < today) {
              eventClass += " completed";
            } else if (eventDate.getTime() === today.getTime()) {
              eventClass += " next";
            }

            const title = event.activityName || event.title || "ì¼ì • ì—†ìŒ";

            // 4ê¸€ìë§ˆë‹¤ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ (ì´ëª¨í‹°ì½˜ í¬í•¨)
            const wrappedTitle = title.match(/.{1,4}/g)?.join("<br>") || title;

            // HTML ì—”í‹°í‹° ë³€í™˜ (XSS ë°©ì§€)
            const escapedTitle = title.replace(
              /[&<>"']/g,
              (m) =>
                ({
                  "&": "&amp;",
                  "<": "&lt;",
                  ">": "&gt;",
                  '"': "&quot;",
                  "'": "&#39;",
                }[m])
            );

            calendarHTML += `<div class="${eventClass}" title="${escapedTitle}" data-event-id="${event.id}">${wrappedTitle}</div>`;
          });

          calendarHTML += "</div>";
          currentDate.setDate(currentDate.getDate() + 1);
        }

        calendarHTML += `
            </div>
            
            <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
            <div class="text-center mt-3 px-4 space-y-1">
              <p class="text-xs text-gray-500">
                <i class="fas fa-hand-point-right mr-1"></i>
                ë‹¬ë ¥ì„ ë„˜ê²¨ ì¼ì •ì„ í™•ì¸í•´ë³´ì„¸ìš”
              </p>
              <p class="text-xs text-gray-500">
                <i class="fas fa-mouse-pointer mr-1"></i>
                ì¼ì •ì„ í´ë¦­í•˜ì—¬ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•´ë³´ì„¸ìš”
              </p>
            </div>
          </div>
          
          ${
            showDownloadButtons && isAdmin
              ? `
          <!-- ë‹¬ë ¥ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ê´€ë¦¬ì ì „ìš©) -->
          <div class="download-buttons flex justify-center gap-3 mt-4">
            <button 
              onclick="downloadCalendar('png')" 
              class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200"
            >
              <i class="fas fa-download"></i>
              PNG ë‹¤ìš´ë¡œë“œ
            </button>
            <button 
              onclick="downloadCalendar('jpeg')" 
              class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200"
            >
              <i class="fas fa-download"></i>
              JPEG ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
          `
              : ""
          }
        `;

        return calendarHTML;
      }

      // ë‹¬ë ¥ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
      window.downloadCalendar = function (format) {
        const calendarContainer = document.querySelector(".calendar-container");
        if (!calendarContainer) {
          showAlert("ğŸ˜¥", "ë‹¬ë ¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ë‹¤ìš´ë¡œë“œ ì‹œì‘ ì•Œë¦¼
        showAlert("ğŸ“¸", "ë‹¬ë ¥ì„ ìº¡ì²˜í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...");

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì„ì‹œ ìˆ¨ê¹€
        const downloadButtons =
          calendarContainer.querySelector(".download-buttons");
        const originalButtonDisplay = downloadButtons
          ? downloadButtons.style.display
          : "";
        if (downloadButtons) {
          downloadButtons.style.display = "none";
        }

        // ë‹¬ë ¥ ê·¸ë¦¬ë“œë§Œ ìº¡ì²˜ (ë²„íŠ¼ ì œì™¸)
        const calendarGrid = calendarContainer.querySelector(".calendar-grid");
        const calendarHeader =
          calendarContainer.querySelector(".calendar-header");

        if (!calendarGrid) {
          showAlert("ğŸ˜¥", "ë‹¬ë ¥ ê·¸ë¦¬ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ë‹¬ë ¥ ì»¨í…Œì´ë„ˆì— ìº¡ì²˜ìš© ìŠ¤íƒ€ì¼ ì„ì‹œ ì ìš©
        const originalOverflow = calendarContainer.style.overflow;
        const originalPosition = calendarContainer.style.position;
        const originalZIndex = calendarContainer.style.zIndex;

        calendarContainer.style.overflow = "visible";
        calendarContainer.style.position = "relative";
        calendarContainer.style.zIndex = "9999";
        calendarContainer.style.backgroundColor = "#ffffff";

        // ì•½ê°„ì˜ ì§€ì—° í›„ ìº¡ì²˜
        setTimeout(() => {
          html2canvas(calendarContainer, {
            backgroundColor: "#ffffff",
            scale: 2,
            useCORS: true,
            allowTaint: false,
            logging: false,
            removeContainer: false,
            foreignObjectRendering: false,
            imageTimeout: 10000,
            width: calendarContainer.offsetWidth,
            height: calendarContainer.offsetHeight,
          })
            .then((canvas) => {
              // ì›ë³¸ ìŠ¤íƒ€ì¼ë¡œ ë³µì›
              calendarContainer.style.overflow = originalOverflow;
              calendarContainer.style.position = originalPosition;
              calendarContainer.style.zIndex = originalZIndex;
              calendarContainer.style.backgroundColor = "";

              // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
              if (downloadButtons) {
                downloadButtons.style.display = originalButtonDisplay;
              }

              // ìº”ë²„ìŠ¤ë¥¼ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
              const mimeType = format === "png" ? "image/png" : "image/jpeg";
              const quality = format === "jpeg" ? 0.9 : undefined;

              canvas.toBlob(
                function (blob) {
                  // íŒŒì¼ëª… ìƒì„±
                  const now = new Date();
                  const dateStr = now.toISOString().split("T")[0];
                  const timeStr = now
                    .toTimeString()
                    .split(" ")[0]
                    .replace(/:/g, "-");
                  const filename = `Fodie_ë‹¬ë ¥_${dateStr}_${timeStr}.${format}`;

                  // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                  const url = URL.createObjectURL(blob);
                  const link = document.createElement("a");
                  link.href = url;
                  link.download = filename;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  URL.revokeObjectURL(url);

                  showAlert(
                    "âœ…",
                    `${format.toUpperCase()} í˜•ì‹ìœ¼ë¡œ ë‹¬ë ¥ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`
                  );
                },
                mimeType,
                quality
              );
            })
            .catch((error) => {
              // ì›ë³¸ ìŠ¤íƒ€ì¼ë¡œ ë³µì›
              calendarContainer.style.overflow = originalOverflow;
              calendarContainer.style.position = originalPosition;
              calendarContainer.style.zIndex = originalZIndex;
              calendarContainer.style.backgroundColor = "";

              // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
              if (downloadButtons) {
                downloadButtons.style.display = originalButtonDisplay;
              }

              console.error("ë‹¬ë ¥ ìº¡ì²˜ ì‹¤íŒ¨:", error);
              showAlert("ğŸ˜¥", "ë‹¬ë ¥ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }, 100); // 100ms ì§€ì—°
      };

      // ë‹¬ë ¥ì—ì„œ ì¼ì • ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
      window.openAddEventModal = function (selectedDate) {
        // í˜„ì¬ ê´€ë¦¬ì ìƒíƒœ í™•ì¸
        const adminPositions = {
          12345678: "ê°œë°œì",
          202013136: "ì´ë¬´",
          202018357: "ê¸°íƒ€",
          202114029: "ë¶€íšŒì¥",
          202327942: "íšŒì¥",
          202416596: "í™ë³´ë¶€ì¥",
          202419743: "ê¸°íšë¶€ì¥",
        };

        const isAdmin = currentUser && adminPositions[currentUser.studentId];

        if (!currentUser || !isAdmin) {
          return; // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ì¡°ìš©íˆ ì¢…ë£Œ
        }

        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.innerHTML = `
          <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-800">ìƒˆ ì¼ì • ì¶”ê°€</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <form id="calendar-add-event-form">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì •ëª…</label>
                <input 
                  id="calendar-event-name" 
                  type="text" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" 
                  placeholder="ì¼ì •ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                  required
                >
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                <input 
                  id="calendar-event-date" 
                  type="date" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                  value="${selectedDate}"
                  required
                >
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea 
                  id="calendar-event-description" 
                  rows="5" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                  placeholder="ì¼ì • ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤"
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Enter í‚¤ë¡œ ì¤„ë°”ê¿ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
              </div>
              
              <div class="mb-4">
                <label class="flex items-center">
                  <input 
                    id="calendar-event-admin-only" 
                    type="checkbox" 
                    class="mr-2 text-blue-600 focus:ring-blue-500"
                  >
                  <span class="text-sm font-medium text-gray-700">ìš´ì˜ì§„ ì „ìš© ì¼ì •</span>
                  <span class="ml-1 text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded">íŒŒë€ìƒ‰ìœ¼ë¡œ í‘œì‹œ</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">ì²´í¬í•˜ë©´ ìš´ì˜ì§„ê³¼ ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆëŠ” ì¼ì •ì´ ë©ë‹ˆë‹¤.</p>
              </div>
              
              <div class="flex gap-2 justify-end">
                <button 
                  type="button" 
                  onclick="this.closest('.fixed').remove()" 
                  class="px-4 py-2 text-gray-600 hover:text-gray-800"
                >
                  ì·¨ì†Œ
                </button>
                <button 
                  type="submit" 
                  class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition-colors"
                >
                  ì¶”ê°€
                </button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(modal);

        // í¼ ì œì¶œ ì²˜ë¦¬
        modal
          .querySelector("#calendar-add-event-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const eventName = modal.querySelector("#calendar-event-name").value;
            const eventDate = modal.querySelector("#calendar-event-date").value;
            const eventDescription = modal.querySelector(
              "#calendar-event-description"
            ).value;
            const isAdminOnly = modal.querySelector(
              "#calendar-event-admin-only"
            ).checked;

            if (!eventName.trim()) {
              showAlert("ğŸ˜¥", "ì¼ì •ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              // ìµœëŒ€ order ê°’ ì°¾ê¸°
              const maxOrder = Math.max(
                ...roadmapData.map((item) => item.order || 0),
                0
              );

              await addDoc(collection(db, "roadmap"), {
                activityName: eventName,
                activityDate: eventDate,
                description: eventDescription || "",
                order: maxOrder + 1,
                createdAt: new Date().toISOString(),
                isAdminOnly: isAdminOnly, // ìš´ì˜ì§„ ì „ìš© ì¼ì • í”Œë˜ê·¸
              });

              showAlert("âœ…", "ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
              modal.remove();
              smoothRender("h-roadmap-list", renderHorizontalRoadmap); // ë‹¬ë ¥ ë‹¤ì‹œ ë Œë”ë§
            } catch (error) {
              console.error("ì¼ì • ì¶”ê°€ ì‹¤íŒ¨:", error);
              showAlert("ğŸ˜¥", "ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });
      };

      // ë‹¬ë ¥ ì›” ë³€ê²½ í•¨ìˆ˜
      let currentCalendarYear = new Date().getFullYear();
      let currentCalendarMonth = new Date().getMonth();

      window.changeCalendarMonth = function (direction) {
        currentCalendarMonth += direction;
        if (currentCalendarMonth < 0) {
          currentCalendarMonth = 11;
          currentCalendarYear--;
        } else if (currentCalendarMonth > 11) {
          currentCalendarMonth = 0;
          currentCalendarYear++;
        }

        // ë‹¬ë ¥ ë‹¤ì‹œ ë Œë”ë§
        const accordionContent = document.getElementById("h-roadmap-full-list");
        if (
          accordionContent &&
          roadmapShowAll &&
          roadmapData &&
          roadmapData.length > 5
        ) {
          // roadmapDataë¥¼ ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (ê°„ë‹¨íˆ ë³´ê¸° ëª¨ë“œì—ì„œëŠ” ë‚ ì§œë§Œ ê³ ë ¤)
          const sorted = roadmapData
            .filter((item) => item && item.id)
            .sort((a, b) => {
              const dateA = parseDate(a.activityDate || a.date);
              const dateB = parseDate(b.activityDate || b.date);
              return dateA - dateB;
            });

          // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
          const adminPositions = {
            12345678: "ê°œë°œì",
            202013136: "ì´ë¬´",
            202018357: "ê¸°íƒ€",
            202114029: "ë¶€íšŒì¥",
            202327942: "íšŒì¥",
            202416596: "í™ë³´ë¶€ì¥",
            202419743: "ê¸°íšë¶€ì¥",
          };
          const isAdmin = currentUser && adminPositions[currentUser.studentId];

          const calendarHTML = generateCalendar(
            currentCalendarYear,
            currentCalendarMonth,
            sorted,
            true, // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
            !!isAdmin // ê´€ë¦¬ì ê¶Œí•œ ì „ë‹¬
          );
          accordionContent.innerHTML = calendarHTML;
        }
      };

      function renderHorizontalRoadmap() {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì•„ë¬´ê²ƒë„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ (ë¸”ë¡ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)
        if (!currentUser) {
          console.log(
            "renderHorizontalRoadmap: ë¡œê·¸ì•„ì›ƒ ìƒíƒœ - ë Œë”ë§í•˜ì§€ ì•ŠìŒ"
          );
          return;
        }

        const root = document.getElementById("h-roadmap-list");
        const btn = document.getElementById("h-roadmap-toggle-btn");
        if (!root) {
          console.warn(
            "renderHorizontalRoadmap: h-roadmap-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          );
          return;
        }

        console.log("renderHorizontalRoadmap: roadmapData =", roadmapData);
        console.log("roadmapData ê¸¸ì´:", roadmapData?.length || 0);
        console.log("roadmapData íƒ€ì…:", typeof roadmapData);

        // ë°ì´í„° ìƒì„¸ ë¶„ì„
        if (roadmapData && roadmapData.length > 0) {
          console.log("roadmapData ìƒì„¸ ë¶„ì„:");
          roadmapData.forEach((item, index) => {
            console.log(`  [${index}]`, {
              id: item?.id,
              title: item?.title,
              activityName: item?.activityName,
              activityDate: item?.activityDate,
              order: item?.order,
            });
          });
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // order â†’ ë‚ ì§œ ìˆœ (ê¸°ë³¸ì ì¸ ë°ì´í„° ê²€ì¦ë§Œ)
        const validRoadmapData = (roadmapData || []).filter((item) => {
          if (!item || typeof item !== "object" || !item.id) return false;

          // ê´€ë¦¬ì(ìš´ì˜ì§„ í¬í•¨)ëŠ” ëª¨ë“  ì¼ì • í‘œì‹œ
          if (isAdminOrStaff()) {
            return true;
          }

          // ì¼ë°˜ íšŒì›: ìš´ì˜ì§„ ì „ìš© ì¼ì • ì œì™¸
          if (item.isAdminOnly) {
            return false;
          }

          return true;
        });

        // ê°„ë‹¨íˆ ë³´ê¸° ëª¨ë“œì—ì„œëŠ” ë‚ ì§œìˆœìœ¼ë¡œë§Œ ì •ë ¬ (order ë¬´ì‹œ)
        const sorted = [...validRoadmapData].sort((a, b) => {
          const dateA = parseDate(a.activityDate);
          const dateB = parseDate(b.activityDate);
          return dateA - dateB;
        });

        // ì§€ë‚œ ì¼ì •ê³¼ ë‹¤ìŒ ì¼ì • ë¶„ë¦¬
        const pastEvents = sorted.filter((item) => {
          const d = parseDate(item.activityDate);
          return d < today;
        });
        const futureEvents = sorted.filter((item) => {
          const d = parseDate(item.activityDate);
          return d >= today;
        });

        // ê°„ë‹¨íˆ ë³´ê¸° ëª¨ë“œì—ì„œëŠ” ì´ì „ ì¼ì • ì œê±°í•˜ê³  ë‹¤ìŒ ì¼ì •ë§Œ í‘œì‹œ (ëª¨ë°”ì¼ ê³ ë ¤)
        // ë‚ ì§œìˆœìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ë¯¸ë˜ ì¼ì •ì„ ë‹¤ìŒ ì¼ì •ìœ¼ë¡œ í‘œì‹œ
        const upcomingEvents = futureEvents.slice(0, 2); // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ëœ futureEventsì—ì„œ ì²˜ìŒ 2ê°œ

        const displayEvents = upcomingEvents;

        console.log("ì¼ì • í‘œì‹œ ë¡œì§:", {
          totalEvents: sorted.length,
          pastEvents: pastEvents.length,
          futureEvents: futureEvents.length,
          upcomingEvents: upcomingEvents.length,
          displayEvents: displayEvents.length,
          roadmapShowAll: roadmapShowAll,
          screenWidth: window.innerWidth,
          isMobile: window.innerWidth <= 640,
          today: today.toISOString().split("T")[0],
          sortedEventsDetails: sorted.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
            order: item.order,
          })),
          futureEventsDetails: futureEvents.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
            createdAt: item.createdAt,
          })),
          upcomingEventsDetails: upcomingEvents.map((item) => ({
            id: item.id,
            title: item.activityName || item.title,
            date: item.activityDate,
          })),
        });

        // ì „ì²´ ì¼ì •ë³´ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        if (btn) {
          if (sorted.length > 5) {
            // 5ê°œ ì´ìƒì¼ ë•Œ ë²„íŠ¼ í‘œì‹œ
            btn.classList.remove("hidden");
            const textElement = btn.querySelector("#h-roadmap-toggle-text");
            const chevronElement = btn.querySelector("#h-roadmap-chevron");
            if (textElement) {
              textElement.textContent = roadmapShowAll
                ? "ê°„ë‹¨íˆ ë³´ê¸°"
                : "ìº˜ë¦°ë”";
            }
            if (chevronElement) {
              chevronElement.style.transform = roadmapShowAll
                ? "rotate(180deg)"
                : "rotate(0deg)";
            }
          } else {
            btn.classList.add("hidden");
          }
        }

        // ê´€ë¦¬ììš© ìƒˆ ì¼ì • ì¶”ê°€ ë¸”ë¡ - ìš´ì˜ì§„ ì œì™¸, ì„ì›ì§„ë§Œ ê°€ëŠ¥
        const adminPlaceholder = isFullAdmin()
          ? `
          <div class="timeline-item admin-placeholder" data-act="add-roadmap">
            <div class="timeline-content">
              <div class="timeline-title">
                <div class="admin-placeholder-content">
                  <div class="admin-placeholder-icon">
                    <i class="fas fa-plus-circle"></i>
                  </div>
                  <div class="admin-placeholder-text">
                    <span class="admin-placeholder-title">ìƒˆ ì¼ì • ì¶”ê°€</span>
                    <span class="admin-placeholder-subtitle">í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ ë¡œë“œë§µ ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `
          : "";

        // ë‹¤ìŒ ì¼ì • ì°¾ê¸° (ê°€ì¥ ê°€ê¹Œìš´ ë¯¸ë˜ ì¼ì •)
        const nextSchedule = futureEvents.length > 0 ? futureEvents[0] : null;

        console.log("ë‹¤ìŒ ì¼ì • í™•ì¸:", {
          nextSchedule: nextSchedule
            ? {
                id: nextSchedule.id,
                title: nextSchedule.activityName || nextSchedule.title,
                date: nextSchedule.activityDate,
              }
            : null,
          futureEventsCount: futureEvents.length,
          today: today.toISOString().split("T")[0],
        });

        const html =
          adminPlaceholder +
            displayEvents
              .map((item) => {
                // ë‚ ì§œ ì²˜ë¦¬ (ë‚ ì§œê°€ ì—†ëŠ” ê²½ìš° ì˜¤ëŠ˜ë¡œ ì„¤ì •)
                const activityDate = item.activityDate || getTodayString();
                const d = parseDate(activityDate);

                // ìƒíƒœ í´ë˜ìŠ¤ ê²°ì •
                let blockClass = "";
                if (d < today) {
                  blockClass = "completed";
                } else if (item.id === nextSchedule?.id) {
                  blockClass = "next-schedule";
                }

                const formattedDate = d.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });

                // ì œëª© ì²˜ë¦¬ (ì œëª©ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©)
                const title = item.activityName || item.title || "ì¼ì • ì—†ìŒ";

                return `
      <div class="schedule-block ${blockClass}">
        <div class="schedule-block-content">
          <div class="schedule-block-date">${formattedDate}</div>
          <div class="schedule-block-title">${saf(title)}</div>
          ${
            isFullAdmin()
              ? `<div class="schedule-block-actions">
                  <button type="button" class="schedule-action-btn schedule-edit-btn" data-act="edit-roadmap" data-id="${item.id}" title="ìˆ˜ì •">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="schedule-action-btn schedule-download-btn" data-act="download-roadmap" data-id="${item.id}" title="ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ">
                    <i class="fas fa-download"></i>
                  </button>
                  <button type="button" class="schedule-action-btn schedule-delete-btn" data-act="delete-roadmap" data-id="${item.id}" title="ì‚­ì œ">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>`
              : ""
          }
        </div>
      </div>`;
              })
              .join("") ||
          `<div class="text-gray-400 text-center py-8 col-span-full">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

        root.innerHTML = html;

        // ì•„ì½”ë””ì–¸ ì»¨í…ì¸  ì˜ì—­ ì²˜ë¦¬
        const accordionContent = document.getElementById("h-roadmap-full-list");
        if (accordionContent) {
          if (roadmapShowAll && sorted.length > 5) {
            // ì „ì²´ ì¼ì •ì„ ë¸”ë¡ í˜•íƒœë¡œ í‘œì‹œ
            const fullHtml = sorted
              .map((item) => {
                // ë‚ ì§œ ì²˜ë¦¬ (ë‚ ì§œê°€ ì—†ëŠ” ê²½ìš° ì˜¤ëŠ˜ë¡œ ì„¤ì •)
                const activityDate = item.activityDate || getTodayString();
                const d = parseDate(activityDate);

                // ìƒíƒœ í´ë˜ìŠ¤ ê²°ì •
                let blockClass = "";
                if (d < today) {
                  blockClass = "completed";
                } else if (item.id === nextSchedule?.id) {
                  blockClass = "next-schedule";
                }

                const formattedDate = d.toLocaleDateString("ko-KR", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });

                // ì œëª© ì²˜ë¦¬ (ì œëª©ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©)
                const title = item.activityName || item.title || "ì¼ì • ì—†ìŒ";

                return `
          <div class="schedule-block ${blockClass}">
            <div class="schedule-block-content">
              <div class="schedule-block-date">${formattedDate}</div>
              <div class="schedule-block-title">${saf(title)}</div>
              ${
                isFullAdmin()
                  ? `<div class="schedule-block-actions">
                      <button type="button" class="schedule-action-btn schedule-edit-btn" data-act="edit-roadmap" data-id="${item.id}" title="ìˆ˜ì •">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button type="button" class="schedule-action-btn schedule-download-btn" data-act="download-roadmap" data-id="${item.id}" title="ëª…ë‹¨ ë‹¤ìš´ë¡œë“œ">
                        <i class="fas fa-download"></i>
                      </button>
                      <button type="button" class="schedule-action-btn schedule-delete-btn" data-act="delete-roadmap" data-id="${item.id}" title="ì‚­ì œ">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>`
                  : ""
              }
            </div>
          </div>`;
              })
              .join("");

            // ë‹¬ë ¥ í˜•íƒœë¡œ ì „ì²´ ì¼ì • í‘œì‹œ
            const calendarHTML = generateCalendar(
              currentCalendarYear,
              currentCalendarMonth,
              sorted,
              true, // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
              isFullAdmin() // ê´€ë¦¬ì ê¶Œí•œ ì „ë‹¬ - ìš´ì˜ì§„ ì œì™¸
            );
            accordionContent.innerHTML = calendarHTML;

            // ì•„ì½”ë””ì–¸ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì—´ê¸°
            setTimeout(() => {
              accordionContent.style.maxHeight =
                accordionContent.scrollHeight + "px";
              accordionContent.style.opacity = "1";
            }, 10);
          } else {
            // ì•„ì½”ë””ì–¸ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‹«ê¸°
            accordionContent.style.maxHeight = "0";
            accordionContent.style.opacity = "0";
          }
        }

        // ë¡œë“œë§µ ìˆ˜ì •/ì‚­ì œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        root.addEventListener("click", (e) => {
          const act = e.target.closest("[data-act]")?.dataset.act;
          const id = e.target.closest("[data-act]")?.dataset.id;

          if (act === "edit-roadmap") {
            openRoadmapEventEditModal(id, 0); // eventIndexëŠ” 0ìœ¼ë¡œ ì„¤ì •
          } else if (act === "delete-roadmap") {
            deleteRoadmapEvent(id);
          } else if (act === "add-roadmap") {
            openRoadmapAddModal();
          }
        });

        // ì•„ì½”ë””ì–¸ ì˜ì—­ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ë‹¬ë ¥ ì´ë²¤íŠ¸ í¬í•¨)
        if (accordionContent) {
          accordionContent.addEventListener("click", (e) => {
            const act = e.target.closest("[data-act]")?.dataset.act;
            const id = e.target.closest("[data-act]")?.dataset.id;
            const eventId =
              e.target.closest(".calendar-event")?.dataset.eventId;

            if (act === "edit-roadmap") {
              openRoadmapEventEditModal(id, 0);
            } else if (act === "delete-roadmap") {
              deleteRoadmapEvent(id);
            } else if (eventId) {
              // ë‹¬ë ¥ ì´ë²¤íŠ¸ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ í‘œì‹œ
              showEventDetails(eventId);
            }
          });
        }
      }

      // ë‹¬ë ¥ ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
      function showEventDetails(eventId) {
        // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ë¨¼ì € ì œê±°
        const existingModal = document.getElementById("event-detail-modal");
        if (existingModal) {
          existingModal.remove();
        }

        const event = roadmapData.find((item) => item.id === eventId);
        if (!event) return;

        const activityDate = event.activityDate || getTodayString();
        const d = parseDate(activityDate);
        const formattedDate = d.toLocaleDateString("ko-KR", {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        });

        const title = event.activityName || event.title || "ì¼ì • ì—†ìŒ";
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let statusText = "";
        let statusClass = "";
        if (d < today) {
          statusText = "ì™„ë£Œëœ ì¼ì •";
          statusClass = "text-red-600";
        } else if (d.getTime() === today.getTime()) {
          statusText = "ì˜¤ëŠ˜ì˜ ì¼ì •";
          statusClass = "text-green-600";
        } else {
          statusText = "ì˜ˆì •ëœ ì¼ì •";
          statusClass = "text-orange-600";
        }

        const modalHTML = `
          <div id="event-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                  <h3 class="text-xl font-bold text-gray-800">ì¼ì • ìƒì„¸ ì •ë³´</h3>
                  <button onclick="closeEventDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                  </button>
                </div>
                
                <div class="space-y-4">
                  <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-2">${saf(
                      title
                    )}</h4>
                    <div class="flex items-center gap-2 text-sm">
                      <i class="fas fa-calendar text-orange-500"></i>
                      <span class="text-gray-600">${formattedDate}</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm mt-2">
                      <i class="fas fa-info-circle text-blue-500"></i>
                      <span class="${statusClass} font-medium">${statusText}</span>
                    </div>
                  </div>
                  
                  ${
                    event.description
                      ? `
                    <div class="bg-gray-50 rounded-lg p-4">
                      <h5 class="font-medium text-gray-700 mb-2">ìƒì„¸ ì„¤ëª…</h5>
                      <p class="text-gray-600 text-sm whitespace-pre-wrap">${saf(
                        event.description
                      )}</p>
                    </div>
                  `
                      : ""
                  }
                  
                  <div class="flex gap-2">
                    ${
                      currentUser && adminList.includes(currentUser.studentId)
                        ? `
                      <button onclick="openRoadmapEventEditModal('${eventId}', 0); closeEventDetailModal();" 
                              class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-edit mr-2"></i>ìˆ˜ì •
                      </button>
                      <button onclick="deleteRoadmapEvent('${eventId}'); closeEventDetailModal();" 
                              class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-trash mr-2"></i>ì‚­ì œ
                      </button>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
      }

      // ë‹¬ë ¥ ì´ë²¤íŠ¸ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
      window.closeEventDetailModal = function () {
        const modal = document.getElementById("event-detail-modal");
        if (modal) {
          modal.remove();
        }
      };

      // ë¡œë“œë§µ ì¼ì • ì‚­ì œ í•¨ìˆ˜
      window.deleteRoadmapEvent = async function (eventId) {
        if (!confirm("ì •ë§ë¡œ ì´ ë¡œë“œë§µ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          return;
        }

        try {
          // ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          const docRef = doc(db, "roadmap", eventId);
          const docSnap = await getDoc(docRef);

          if (!docSnap.exists()) {
            showAlert("ğŸ˜¥", "ì‚­ì œí•˜ë ¤ëŠ” ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          await deleteDoc(docRef);
          showAlert("âœ…", "ë¡œë“œë§µ ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          renderHorizontalRoadmap(); // ë¡œë“œë§µ ë‹¤ì‹œ ë Œë”ë§
        } catch (error) {
          console.error("ë¡œë“œë§µ ì‚­ì œ ì˜¤ë¥˜:", error);
          if (error.code === "not-found") {
            showAlert("ğŸ˜¥", "ì‚­ì œí•˜ë ¤ëŠ” ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          } else {
            showAlert("ğŸ˜¥", "ë¡œë“œë§µ ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      };

      // ë¡œë“œë§µ ì¼ì • ì¶”ê°€ ëª¨ë‹¬ (ìƒˆë¡œìš´ í•¨ìˆ˜)
      function openRoadmapAddModal() {
        const modalHTML = `
            <div id="roadmap-add-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
              <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ìƒˆ ë¡œë“œë§µ ì¼ì • ì¶”ê°€</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¼ì • ì œëª©</label>
                    <input id="roadmap-add-title" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                    <input id="roadmap-add-date" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                    <textarea id="roadmap-add-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" rows="3" placeholder="ì¼ì •ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                  </div>
                </div>
                <div class="flex gap-3 mt-6">
                  <button id="roadmap-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>ì¶”ê°€
                  </button>
                  <button id="roadmap-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                    ì·¨ì†Œ
                  </button>
                </div>
              </div>
            </div>
          `;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById("roadmap-add-modal");
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("roadmap-add-save")
          .addEventListener("click", async () => {
            const title = document
              .getElementById("roadmap-add-title")
              .value.trim();
            const date = document.getElementById("roadmap-add-date").value;
            const description = document
              .getElementById("roadmap-add-description")
              .value.trim();

            if (!title) {
              showAlert("ğŸ˜¥", "ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (!date) {
              showAlert("ğŸ˜¥", "ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              console.log("ë¡œë“œë§µ ì¶”ê°€ ì‹œë„:", { title, date, description });
              console.log("í˜„ì¬ roadmapData:", roadmapData);

              // ë‹¤ìŒ order ê°’ ê³„ì‚°
              const maxOrder = Math.max(
                ...(roadmapData || []).map((e) => e.order || 0),
                0
              );
              const newOrder = maxOrder + 1;

              console.log("ìƒˆ order ê°’:", newOrder);

              const docRef = await addDoc(collection(db, "roadmap"), {
                activityName: title,
                activityDate: date,
                description: description || "",
                order: newOrder,
                createdAt: new Date().toISOString(),
              });

              console.log("ë¬¸ì„œ ì¶”ê°€ ì™„ë£Œ, ID:", docRef.id);

              showAlert("âœ…", "ìƒˆ ë¡œë“œë§µ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document.getElementById("roadmap-add-modal").remove();

              // ë¡œë“œë§µì€ onSnapshotìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸ë¨
            } catch (error) {
              console.error("ì¼ì • ì¶”ê°€ ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
          });

        document
          .getElementById("roadmap-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("roadmap-add-modal").remove();
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("roadmap-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "roadmap-add-modal") {
              document.getElementById("roadmap-add-modal").remove();
            }
          });
      }

      // ë…ë¦½ì ì¸ ì¡°ëª¨ì„ ë°ì´í„° ê´€ë¦¬
      let groupsData = [];

      // ì¡°ëª¨ì„ ë°ì´í„° ë¡œë“œ
      function loadGroupsData() {
        if (!currentUser) return;

        const unsubscribe = onSnapshot(
          collection(db, "groups"),
          (snapshot) => {
            groupsData = [];
            snapshot.forEach((doc) => {
              groupsData.push({
                id: doc.id,
                ...doc.data(),
              });
            });
            console.log("ì¡°ëª¨ì„ ë°ì´í„° ë¡œë“œë¨:", groupsData);

            // ì¡°ëª¨ì„ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
            const rankModal = document.getElementById("rank-modal");
            if (rankModal && !rankModal.classList.contains("hidden")) {
              renderRankList();
            }
          },
          (error) => {
            console.error("ì¡°ëª¨ì„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
          }
        );

        return unsubscribe;
      }

      // ì¡°ëª¨ì„ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
      function openGroupAddModal() {
        const modal = document.getElementById("group-add-modal");
        if (!modal) {
          createGroupAddModal();
        }

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById("group-add-name").value = "";
        document.getElementById("group-add-score").value = "";

        document.getElementById("group-add-modal").classList.remove("hidden");
      }

      // ì¡°ëª¨ì„ ì¶”ê°€ ëª¨ë‹¬ ìƒì„±
      function createGroupAddModal() {
        const modalHTML = `
          <div id="group-add-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full flex flex-col max-h-[90vh]">
              <div class="p-6 md:p-7 flex-shrink-0">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ… ì¡°ëª¨ì„ ì¶”ê°€</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¡°ëª¨ì„ ì´ë¦„</label>
                    <input id="group-add-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì˜ˆ: 1ì¡°, Aì¡°, ê¹€ì¹˜ì¡°">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì ìˆ˜</label>
                    <input id="group-add-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0" value="0">
                  </div>
                </div>
              </div>
              <div class="p-6 md:p-7 pt-0 flex-shrink-0 border-t border-gray-100">
                <div class="flex gap-3">
                  <button id="group-add-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>ì¶”ê°€
                  </button>
                  <button id="group-add-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                    ì·¨ì†Œ
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("group-add-save")
          .addEventListener("click", async () => {
            const groupName = document
              .getElementById("group-add-name")
              .value.trim();
            const groupScore =
              parseInt(document.getElementById("group-add-score").value) || 0;

            if (!groupName) {
              showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              await addGroup(groupName, groupScore);
              showAlert("âœ…", "ì¡°ëª¨ì„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document
                .getElementById("group-add-modal")
                .classList.add("hidden");
            } catch (error) {
              console.error("ì¡°ëª¨ì„ ì¶”ê°€ ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });

        document
          .getElementById("group-add-cancel")
          .addEventListener("click", () => {
            document.getElementById("group-add-modal").classList.add("hidden");
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("group-add-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "group-add-modal") {
              document
                .getElementById("group-add-modal")
                .classList.add("hidden");
            }
          });
      }

      function renderRankList() {
        const container = document.getElementById("rank-list");
        if (!container) return;

        // ë…ë¦½ì ì¸ ì¡°ëª¨ì„ ë°ì´í„° ì‚¬ìš©
        console.log("renderRankList: groupsData =", groupsData);

        let rankData = groupsData.filter(
          (group) => group.name && group.score !== undefined
        );

        // ì ìˆ˜ìˆœìœ¼ë¡œ ì •ë ¬
        rankData.sort((a, b) => b.score - a.score);
        rankData = rankData.map((item, index) => ({
          ...item,
          rank: index + 1,
        }));

        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);

        const html = rankData
          .map(
            (item, index) => `
          <div class="p-3 bg-gray-50 rounded-lg relative">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-3">
                <div class="text-2xl font-bold text-orange-600">${
                  item.rank
                }ìœ„</div>
                <div class="font-bold text-gray-800">${item.name}</div>
              </div>
              <div class="text-xl font-bold text-orange-600">${
                item.score
              }ì </div>
            </div>
            ${
              item.members.length > 0 &&
              currentUser &&
              adminList.includes(currentUser.studentId)
                ? `<div class="text-sm text-gray-600 mb-2">${item.members.join(
                    ", "
                  )}</div>`
                : ""
            }
            ${
              isAdmin
                ? `
              <div class="flex gap-1 justify-start">
                <button class="edit-group-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors" 
                        data-group-id="${item.id}" data-group-name="${item.name}" data-group-score="${item.score}" title="ìˆ˜ì •">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-group-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors" 
                        data-group-id="${item.id}" data-group-name="${item.name}" title="ì‚­ì œ">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            `
                : ""
            }
          </div>
        `
          )
          .join("");

        const adminControls = document.getElementById("rank-admin-controls");
        const adminActions = document.getElementById("rank-admin-actions");

        if (isAdmin) {
          adminControls?.classList.remove("hidden");
          adminActions?.classList.remove("hidden");
        } else {
          adminControls?.classList.add("hidden");
          adminActions?.classList.add("hidden");
        }

        container.innerHTML =
          html ||
          `<div class="text-center text-gray-400 py-4">
            <i class="fas fa-info-circle text-2xl mb-2"></i>
            <p>ì¡°ëª¨ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p class="text-sm mt-1">ê´€ë¦¬ìê°€ ì¡°ëª¨ì„ì„ ì¶”ê°€í•˜ë©´ ìˆœìœ„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
          </div>`;

        // ì¡°ëª¨ì„ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (isAdmin) {
          container.querySelectorAll(".edit-group-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const groupId = btn.dataset.groupId;
              const groupName = btn.dataset.groupName;
              const groupScore = btn.dataset.groupScore;
              openGroupEditModal(groupId, groupName, groupScore);
            });
          });

          container.querySelectorAll(".delete-group-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const groupId = btn.dataset.groupId;
              const groupName = btn.dataset.groupName;

              if (confirm(`ì •ë§ë¡œ "${groupName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                try {
                  await deleteGroup(groupId);
                  showAlert("âœ…", "ì¡°ëª¨ì„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (error) {
                  console.error("ì¡°ëª¨ì„ ì‚­ì œ ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });
          });
        }
      }

      // ì¡°ëª¨ì„ ìˆœìœ„ ì €ì¥ í•¨ìˆ˜
      async function saveGroupRankings() {
        try {
          console.log("=== ì¡°ëª¨ì„ ìˆœìœ„ ì €ì¥ ì‹œì‘ ===");
          console.log("í˜„ì¬ groupsData:", groupsData);

          // í˜„ì¬ groupsDataë¥¼ ì ìˆ˜ìˆœìœ¼ë¡œ ì •ë ¬
          const sortedGroups = [...groupsData].sort(
            (a, b) => (b.score || 0) - (a.score || 0)
          );

          console.log("ì •ë ¬ëœ groups:", sortedGroups);

          // Firebaseì— ê° ê·¸ë£¹ì˜ ìˆœìœ„ ì—…ë°ì´íŠ¸
          const batch = writeBatch(db);

          sortedGroups.forEach((group, index) => {
            const groupRef = doc(db, "groups", group.id);
            batch.update(groupRef, {
              order: index + 1,
              lastUpdated: new Date(),
            });
          });

          await batch.commit();

          console.log("Firebase ì—…ë°ì´íŠ¸ ì™„ë£Œ");
          showAlert("âœ…", "ì¡°ëª¨ì„ ìˆœìœ„ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

          // ì¡°ëª¨ì„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          renderRankList();
        } catch (error) {
          console.error("ì¡°ëª¨ì„ ìˆœìœ„ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ìˆœìœ„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ì¡°ëª¨ì„ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
      function openGroupEditModal(groupId, groupName, groupScore) {
        const modal = document.getElementById("group-edit-modal");
        if (!modal) {
          createGroupEditModal();
        }

        // ì…ë ¥ í•„ë“œì— ê¸°ì¡´ ê°’ ì„¤ì •
        document.getElementById("group-edit-id").value = groupId;
        document.getElementById("group-edit-name").value = groupName;
        document.getElementById("group-edit-score").value = groupScore;

        document.getElementById("group-edit-modal").classList.remove("hidden");
      }

      // ì¡°ëª¨ì„ ìˆ˜ì • ëª¨ë‹¬ ìƒì„±
      function createGroupEditModal() {
        const modalHTML = `
          <div id="group-edit-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full flex flex-col max-h-[90vh]">
              <div class="p-6 md:p-7 flex-shrink-0">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ… ì¡°ëª¨ì„ ìˆ˜ì •</h3>
                <div class="space-y-4">
                  <input id="group-edit-id" type="hidden">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì¡°ëª¨ì„ ì´ë¦„</label>
                    <input id="group-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì˜ˆ: 1ì¡°, Aì¡°, ê¹€ì¹˜ì¡°">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì ìˆ˜</label>
                    <input id="group-edit-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0">
                  </div>
                </div>
              </div>
              <div class="p-6 md:p-7 pt-0 flex-shrink-0 border-t border-gray-100">
                <div class="flex gap-3">
                  <button id="group-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                    <i class="fas fa-save mr-2"></i>ìˆ˜ì •
                  </button>
                  <button id="group-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                    ì·¨ì†Œ
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("group-edit-save")
          .addEventListener("click", async () => {
            const groupId = document.getElementById("group-edit-id").value;
            const groupName = document
              .getElementById("group-edit-name")
              .value.trim();
            const groupScore =
              parseInt(document.getElementById("group-edit-score").value) || 0;

            if (!groupName) {
              showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              await updateGroup(groupId, groupName, groupScore);
              showAlert("âœ…", "ì¡°ëª¨ì„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              document
                .getElementById("group-edit-modal")
                .classList.add("hidden");
            } catch (error) {
              console.error("ì¡°ëª¨ì„ ìˆ˜ì • ì˜¤ë¥˜:", error);
              showAlert("ğŸ˜¥", "ì¡°ëª¨ì„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          });

        document
          .getElementById("group-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("group-edit-modal").classList.add("hidden");
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("group-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "group-edit-modal") {
              document
                .getElementById("group-edit-modal")
                .classList.add("hidden");
            }
          });
      }

      // ì¡°ëª¨ì„ ìˆ˜ì • í•¨ìˆ˜
      async function updateGroup(groupId, name, score) {
        const groupRef = doc(db, "groups", groupId);
        await updateDoc(groupRef, {
          name: name,
          score: score,
          lastUpdated: new Date().toISOString(),
        });
      }

      // ì¡°ëª¨ì„ ì‚­ì œ í•¨ìˆ˜
      async function deleteGroup(groupId) {
        const groupRef = doc(db, "groups", groupId);
        await deleteDoc(groupRef);
      }

      // ì¡°ëª¨ì„ ì¶”ê°€ í•¨ìˆ˜
      async function addGroup(name, score) {
        await addDoc(collection(db, "groups"), {
          name: name,
          score: score || 0,
          members: [],
          lastUpdated: new Date().toISOString(),
        });
      }

      // íŒ€ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
      function openTeamEditModal(teamIndex, teamName, teamScore) {
        const modal = document.getElementById("team-edit-modal");
        if (!modal) {
          // íŒ€ ìˆ˜ì • ëª¨ë‹¬ì´ ì—†ìœ¼ë©´ ìƒì„±
          createTeamEditModal();
        }

        // ê¸°ì¡´ ê°’ ì„¤ì •
        document.getElementById("team-edit-name").value = teamName;
        document.getElementById("team-edit-score").value = teamScore;
        document.getElementById("team-edit-index").value = teamIndex;

        modal.classList.remove("hidden");
      }

      // íŒ€ ìˆ˜ì • ëª¨ë‹¬ ìƒì„±
      function createTeamEditModal() {
        const modalHTML = `
          <div id="team-edit-modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center px-4 z-50">
            <div class="bg-white p-6 md:p-7 rounded-2xl shadow-xl max-w-md w-full">
              <h3 class="text-xl font-bold text-gray-800 mb-4">íŒ€ ì •ë³´ ìˆ˜ì •</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">íŒ€ ì´ë¦„</label>
                  <input id="team-edit-name" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="íŒ€ ì´ë¦„">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì ìˆ˜</label>
                  <input id="team-edit-score" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="ì ìˆ˜">
                </div>
                <input id="team-edit-index" type="hidden">
              </div>
              <div class="flex gap-3 mt-6">
                <button id="team-edit-save" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>ì €ì¥
                </button>
                <button id="team-edit-cancel" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("team-edit-save")
          .addEventListener("click", async () => {
            const teamIndex = parseInt(
              document.getElementById("team-edit-index").value
            );
            const teamName = document
              .getElementById("team-edit-name")
              .value.trim();
            const teamScore =
              parseInt(document.getElementById("team-edit-score").value) || 0;

            if (!teamName) {
              showAlert("ğŸ˜¥", "íŒ€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            await updateTeamInScoreBlock(teamIndex, teamName, teamScore);
            showAlert("âœ…", "íŒ€ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById("team-edit-modal").classList.add("hidden");
            renderRankList(); // ìˆœìœ„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          });

        document
          .getElementById("team-edit-cancel")
          .addEventListener("click", () => {
            document.getElementById("team-edit-modal").classList.add("hidden");
          });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document
          .getElementById("team-edit-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "team-edit-modal") {
              document
                .getElementById("team-edit-modal")
                .classList.add("hidden");
            }
          });
      }

      // ì ìˆ˜íŒ ë¸”ë¡ì—ì„œ íŒ€ ì‚­ì œ
      async function deleteTeamFromScoreBlock(teamIndex) {
        const scoreBlocks =
          blocksData?.filter((b) => b.type === "scores") || [];
        if (scoreBlocks.length === 0) return;

        const scoreBlock = scoreBlocks[0];
        const teams = scoreBlock.payload?.teams || [];

        if (teamIndex >= 0 && teamIndex < teams.length) {
          teams.splice(teamIndex, 1);

          // Firebase ì—…ë°ì´íŠ¸
          const blockRef = doc(db, "homepageBlocks", scoreBlock.id);
          await updateDoc(blockRef, {
            payload: { teams: teams },
          });
        }
      }

      // ì ìˆ˜íŒ ë¸”ë¡ì—ì„œ íŒ€ ìˆ˜ì •
      async function updateTeamInScoreBlock(teamIndex, teamName, teamScore) {
        const scoreBlocks =
          blocksData?.filter((b) => b.type === "scores") || [];
        if (scoreBlocks.length === 0) return;

        const scoreBlock = scoreBlocks[0];
        const teams = scoreBlock.payload?.teams || [];

        if (teamIndex >= 0 && teamIndex < teams.length) {
          teams[teamIndex] = {
            name: teamName,
            score: teamScore,
          };

          // Firebase ì—…ë°ì´íŠ¸
          const blockRef = doc(db, "homepageBlocks", scoreBlock.id);
          await updateDoc(blockRef, {
            payload: { teams: teams },
          });
        }
      }

      /* ===== ìë™ ë¡œê·¸ì¸ ===== */
      const AUTO_LOGIN_KEY = "foodie_auto_login";
      const KEYCHAIN_SERVICE = "foodie_web_service";

      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
      function saveAutoLogin(studentId, password) {
        try {
          const loginData = {
            studentId: studentId,
            password: password,
            timestamp: Date.now(),
          };

          // localStorageì— ì €ì¥
          localStorage.setItem(AUTO_LOGIN_KEY, JSON.stringify(loginData));

          // Apple Keychain ì§€ì› (iOS Safari)
          if (window.CredentialManager && window.CredentialManager.store) {
            window.CredentialManager.store({
              service: KEYCHAIN_SERVICE,
              username: studentId,
              password: password,
            }).catch((err) => console.log("Keychain ì €ì¥ ì‹¤íŒ¨:", err));
          }

          console.log("ìë™ ë¡œê·¸ì¸ ì •ë³´ ì €ì¥ë¨");
        } catch (error) {
          console.error("ìë™ ë¡œê·¸ì¸ ì €ì¥ ì˜¤ë¥˜:", error);
        }
      }

      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadAutoLogin() {
        try {
          // localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
          const saved = localStorage.getItem(AUTO_LOGIN_KEY);
          if (saved) {
            const loginData = JSON.parse(saved);
            // ì˜êµ¬ ì €ì¥ (ê¸°ê°„ ì œí•œ ì—†ìŒ)
            return loginData;
          }

          // Apple Keychainì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (iOS Safari)
          if (window.CredentialManager && window.CredentialManager.get) {
            return window.CredentialManager.get({
              service: KEYCHAIN_SERVICE,
            })
              .then((credential) => {
                if (credential) {
                  return {
                    studentId: credential.username,
                    password: credential.password,
                    timestamp: Date.now(),
                  };
                }
                return null;
              })
              .catch((err) => {
                console.log("Keychain ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                return null;
              });
          }

          return null;
        } catch (error) {
          console.error("ìë™ ë¡œê·¸ì¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
          return null;
        }
      }

      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
      function clearAutoLogin() {
        try {
          localStorage.removeItem(AUTO_LOGIN_KEY);

          if (window.CredentialManager && window.CredentialManager.delete) {
            window.CredentialManager.delete({
              service: KEYCHAIN_SERVICE,
            }).catch((err) => console.log("Keychain ì‚­ì œ ì‹¤íŒ¨:", err));
          }

          console.log("ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œë¨");
        } catch (error) {
          console.error("ìë™ ë¡œê·¸ì¸ ì‚­ì œ ì˜¤ë¥˜:", error);
        }
      }

      // ìë™ ë¡œê·¸ì¸ ì‹œë„
      async function attemptAutoLogin() {
        try {
          const loginData = await loadAutoLogin();
          if (!loginData) return false;

          // ë¡œê·¸ì¸ í¼ì— ê°’ ì„¤ì •
          const studentIdInput = document.getElementById("studentId");
          const studentNameInput = document.getElementById("studentName");

          if (studentIdInput && studentNameInput) {
            studentIdInput.value = loginData.studentId;
            studentNameInput.value = loginData.password; // ì´ë¦„ì´ íŒ¨ìŠ¤ì›Œë“œ ì—­í• 

            // ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ ì²´í¬
            const autoLoginCheckbox = document.getElementById(
              "auto-login-checkbox"
            );
            if (autoLoginCheckbox) {
              autoLoginCheckbox.checked = true;
            }

            // ìë™ ë¡œê·¸ì¸ ì‹œë„
            await login();
            return true;
          }

          return false;
        } catch (error) {
          console.error("ìë™ ë¡œê·¸ì¸ ì‹œë„ ì˜¤ë¥˜:", error);
          return false;
        }
      }

      /* ===== ë¯¸ë‹ˆê²Œì„ ===== */
      let currentGame = null;
      let gameState = {};
      let gameScores = {}; // ê²Œì„ ì ìˆ˜ ë°ì´í„°

      function showGameSelection() {
        document.getElementById("game-selection").classList.remove("hidden");
        document.getElementById("game-screen").classList.add("hidden");
        currentGame = null;
        gameState = {};
      }

      function showGameScreen() {
        document.getElementById("game-selection").classList.add("hidden");
        document.getElementById("game-screen").classList.remove("hidden");
        document.getElementById("ranking-screen").classList.add("hidden");
      }

      function showRankingScreen() {
        document.getElementById("game-selection").classList.add("hidden");
        document.getElementById("game-screen").classList.add("hidden");
        document.getElementById("ranking-screen").classList.remove("hidden");
        renderGameRankings();
      }

      function showGameSelectionFromRanking() {
        document.getElementById("game-selection").classList.remove("hidden");
        document.getElementById("game-screen").classList.add("hidden");
        document.getElementById("ranking-screen").classList.add("hidden");
        currentGame = null;
        gameState = {};
      }

      // ê²Œì„ ì ìˆ˜ ì €ì¥
      async function saveGameScore(gameType, score, details = {}) {
        if (!currentUser) return;

        try {
          // ì´ë¦„ ì¤‘ë³µ í™•ì¸
          const existingScores = gameScores[gameType] || [];
          const duplicateName = existingScores.find(
            (s) => s.name === currentUser.name
          );

          if (duplicateName) {
            // ì¤‘ë³µëœ ì´ë¦„ì´ ìˆëŠ” ê²½ìš° ê¸°ì¡´ ê¸°ë¡ê³¼ ë¹„êµ
            let shouldUpdate = false;

            if (gameType === "color-memory") {
              // ìƒ‰ê¹” ê¸°ì–µí•˜ê¸°: ë” ë†’ì€ ë ˆë²¨ì´ë©´ ì—…ë°ì´íŠ¸
              shouldUpdate =
                (details.level || 0) > (duplicateName.details.level || 0);
            } else if (gameType === "car-racing") {
              // ìë™ì°¨ ë ˆì´ì‹±: ë” ê¸´ ê±°ë¦¬ë©´ ì—…ë°ì´íŠ¸
              shouldUpdate =
                (details.distance || 0) > (duplicateName.details.distance || 0);
            } else if (gameType === "ball-bounce") {
              // ê³µ íŠ€ê¸°ê¸°: ë” ë†’ì€ ì ìˆ˜ë©´ ì—…ë°ì´íŠ¸
              shouldUpdate =
                (details.score || 0) > (duplicateName.details.score || 0);
            } else {
              // ìˆ«ì ë§ì¶”ê¸°: ë” ì ì€ ì‹œë„ íšŸìˆ˜ë©´ ì—…ë°ì´íŠ¸
              shouldUpdate =
                (details.attempts || 999) <
                (duplicateName.details.attempts || 999);
            }

            if (shouldUpdate) {
              // ê¸°ì¡´ ê¸°ë¡ì„ ì—…ë°ì´íŠ¸
              await updateDoc(doc(db, "gameScores", duplicateName.id), {
                score: score,
                details: details,
                timestamp: new Date(),
                date: getTodayString(),
              });
              showAlert("ğŸ‰", "ê¸°ì¡´ ê¸°ë¡ì„ ê°±ì‹ í–ˆìŠµë‹ˆë‹¤!");
            } else {
              return;
            }
          } else {
            // ìƒˆë¡œìš´ ê¸°ë¡ ì €ì¥
            const scoreData = {
              studentId: currentUser.studentId,
              name: currentUser.name,
              gameType: gameType,
              score: score,
              details: details,
              timestamp: new Date(),
              date: new Date().toISOString().split("T")[0], // YYYY-MM-DD í˜•ì‹
            };

            await addDoc(collection(db, "gameScores"), scoreData);
            showAlert("ğŸ‰", "ìƒˆë¡œìš´ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
          }

          // ë¡œì»¬ ë°ì´í„°ëŠ” onSnapshotì—ì„œ ìë™ ì—…ë°ì´íŠ¸ë¨
          console.log(`${gameType} ì ìˆ˜ ì €ì¥ ì™„ë£Œ`);
        } catch (error) {
          console.error("ì ìˆ˜ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì ìˆ˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // ê²Œì„ ë­í‚¹ ë Œë”ë§
      function renderGameRankings() {
        const content = document.getElementById("ranking-content");
        if (!content) return;

        const games = [
          {
            type: "number-guess",
            name: "ğŸ”¢ ìˆ«ì ë§ì¶”ê¸°",
            description: "ìµœì†Œ ì‹œë„ íšŸìˆ˜",
          },
          {
            type: "color-memory",
            name: "ğŸ¨ ìƒ‰ê¹” ê¸°ì–µí•˜ê¸°",
            description: "ìµœê³  ë ˆë²¨",
          },
          {
            type: "car-racing",
            name: "ğŸš— ìë™ì°¨ ë ˆì´ì‹±",
            description: "ìµœê³  ê±°ë¦¬",
          },
          {
            type: "ball-bounce",
            name: "âš½ ê³µ íŠ€ê¸°ê¸°",
            description: "ìµœê³  ì ìˆ˜",
          },
        ];

        let html = '<div class="space-y-6">';

        // ê´€ë¦¬ì ê¸°ëŠ¥ ì¶”ê°€
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        if (isAdmin) {
          html += `
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <h4 class="font-bold text-orange-800 mb-2">ğŸ”§ ê´€ë¦¬ì ê¸°ëŠ¥</h4>
              <div class="flex gap-2">
                <button id="clear-all-scores" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors">
                  ì „ì²´ ì ìˆ˜ ì´ˆê¸°í™”
                </button>
                <button id="clear-game-scores" class="px-3 py-1 bg-orange-500 text-white text-sm rounded hover:bg-orange-600 transition-colors">
                  ê²Œì„ë³„ ì ìˆ˜ ì´ˆê¸°í™”
                </button>
              </div>
            </div>
          `;
        }

        games.forEach((game) => {
          const scores = gameScores[game.type] || [];
          const sortedScores = scores
            .sort((a, b) => {
              if (game.type === "color-memory") {
                return (b.details.level || 0) - (a.details.level || 0);
              } else if (game.type === "car-racing") {
                return (b.details.distance || 0) - (a.details.distance || 0);
              } else if (game.type === "ball-bounce") {
                return (b.details.score || 0) - (a.details.score || 0);
              } else {
                return (
                  (a.details.attempts || 999) - (b.details.attempts || 999)
                );
              }
            })
            .slice(0, 10); // ìƒìœ„ 10ëª…

          html += `
            <div class="border rounded-lg p-4">
              <div class="flex justify-between items-center mb-2">
                <h4 class="font-bold text-lg">${game.name}</h4>
                ${
                  isAdmin
                    ? `<button class="clear-game-btn px-2 py-1 bg-red-400 text-white text-xs rounded hover:bg-red-500 transition-colors" data-game-type="${game.type}">ì´ ê²Œì„ ì ìˆ˜ ì´ˆê¸°í™”</button>`
                    : ""
                }
              </div>
              <p class="text-sm text-gray-600 mb-3">${game.description}</p>
              <div class="space-y-2">
          `;

          if (sortedScores.length === 0) {
            html +=
              '<p class="text-gray-400 text-center py-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          } else {
            sortedScores.forEach((score, index) => {
              const rank = index + 1;
              const rankIcon =
                rank === 1
                  ? "ğŸ¥‡"
                  : rank === 2
                  ? "ğŸ¥ˆ"
                  : rank === 3
                  ? "ğŸ¥‰"
                  : `${rank}.`;
              let displayValue;
              if (game.type === "color-memory") {
                displayValue = `ë ˆë²¨ ${score.details.level || 0}`;
              } else if (game.type === "car-racing") {
                displayValue = `${score.details.distance || 0}m`;
              } else if (game.type === "ball-bounce") {
                displayValue = `${score.details.score || 0}ì `;
              } else {
                displayValue = `${score.details.attempts || 0}ë²ˆ`;
              }

              html += `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                  <div class="flex items-center gap-3">
                    <span class="text-lg">${rankIcon}</span>
                    <span class="font-medium">${saf(score.name)}</span>
                  </div>
                  <div class="text-right">
                    <div class="font-bold text-blue-600">${displayValue}</div>
                    <div class="text-xs text-gray-500">${new Date(
                      score.timestamp
                    ).toLocaleDateString()}</div>
                  </div>
                </div>
              `;
            });
          }

          html += `
              </div>
            </div>
          `;
        });

        html += "</div>";
        content.innerHTML = html;

        // ê´€ë¦¬ì ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (isAdmin) {
          // ì „ì²´ ì ìˆ˜ ì´ˆê¸°í™”
          document
            .getElementById("clear-all-scores")
            ?.addEventListener("click", async () => {
              if (
                confirm(
                  "ì •ë§ë¡œ ëª¨ë“  ê²Œì„ì˜ ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                )
              ) {
                try {
                  const batch = writeBatch(db);
                  const snapshot = await getDocs(collection(db, "gameScores"));
                  snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                  });
                  await batch.commit();
                  showAlert("âœ…", "ëª¨ë“  ê²Œì„ ì ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                  renderGameRankings(); // ë­í‚¹ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                  console.error("ì ìˆ˜ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ì ìˆ˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });

          // ê²Œì„ë³„ ì ìˆ˜ ì´ˆê¸°í™”
          document
            .getElementById("clear-game-scores")
            ?.addEventListener("click", async () => {
              const gameType = prompt(
                "ì´ˆê¸°í™”í•  ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”:\n1. number-guess (ìˆ«ì ë§ì¶”ê¸°)\n2. color-memory (ìƒ‰ê¹” ê¸°ì–µí•˜ê¸°)\n3. car-racing (ìë™ì°¨ ë ˆì´ì‹±)\n4. ball-bounce (ê³µ íŠ€ê¸°ê¸°)\n\nê²Œì„ íƒ€ì…ì„ ì…ë ¥í•˜ì„¸ìš”:"
              );
              if (!gameType) return;

              if (
                confirm(
                  `ì •ë§ë¡œ "${gameType}" ê²Œì„ì˜ ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                )
              ) {
                try {
                  const batch = writeBatch(db);
                  const snapshot = await getDocs(
                    query(
                      collection(db, "gameScores"),
                      where("gameType", "==", gameType)
                    )
                  );
                  snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                  });
                  await batch.commit();
                  showAlert("âœ…", `${gameType} ê²Œì„ ì ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                  renderGameRankings(); // ë­í‚¹ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                  console.error("ê²Œì„ë³„ ì ìˆ˜ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ì ìˆ˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });

          // ê°œë³„ ê²Œì„ ì ìˆ˜ ì´ˆê¸°í™”
          document.querySelectorAll(".clear-game-btn").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const gameType = btn.dataset.gameType;
              const gameNames = {
                "number-guess": "ìˆ«ì ë§ì¶”ê¸°",
                "color-memory": "ìƒ‰ê¹” ê¸°ì–µí•˜ê¸°",
                "car-racing": "ìë™ì°¨ ë ˆì´ì‹±",
                "ball-bounce": "ê³µ íŠ€ê¸°ê¸°",
              };

              if (
                confirm(
                  `ì •ë§ë¡œ "${gameNames[gameType]}" ê²Œì„ì˜ ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                )
              ) {
                try {
                  const batch = writeBatch(db);
                  const snapshot = await getDocs(
                    query(
                      collection(db, "gameScores"),
                      where("gameType", "==", gameType)
                    )
                  );
                  snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                  });
                  await batch.commit();
                  showAlert(
                    "âœ…",
                    `${gameNames[gameType]} ê²Œì„ ì ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`
                  );
                  renderGameRankings(); // ë­í‚¹ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                  console.error("ê²Œì„ë³„ ì ìˆ˜ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                  showAlert("ğŸ˜¥", "ì ìˆ˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
              }
            });
          });
        }
      }

      // ìˆ«ì ë§ì¶”ê¸° ê²Œì„
      function startNumberGuessGame() {
        currentGame = "number-guess";
        gameState = {
          targetNumber: Math.floor(Math.random() * 10000) + 1,
          attempts: 0,
          maxAttempts: 15, // ë²”ìœ„ê°€ ì»¤ì¡Œìœ¼ë¯€ë¡œ ì‹œë„ íšŸìˆ˜ ì¦ê°€
        };

        showGameScreen();
        updateNumberGuessUI();
      }

      function updateNumberGuessUI() {
        const content = document.getElementById("game-content");
        const { targetNumber, attempts, maxAttempts } = gameState;

        content.innerHTML = `
          <div class="mb-4">
            <h4 class="text-lg font-bold text-blue-700 mb-2">ğŸ”¢ ìˆ«ì ë§ì¶”ê¸°</h4>
            <p class="text-sm text-gray-600">1ë¶€í„° 10,000 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ë§ì¶°ë³´ì„¸ìš”!</p>
            <p class="text-sm text-gray-500">ë‚¨ì€ ê¸°íšŒ: ${
              maxAttempts - attempts
            }ë²ˆ</p>
          </div>
          
          <div class="mb-4">
            <input 
              type="number" 
              id="number-input" 
              min="1" 
              max="10000" 
              placeholder="ìˆ«ì ì…ë ¥ (1-10000)"
              class="w-full p-3 border border-gray-300 rounded-lg text-center text-lg"
            >
          </div>
          
          <button 
            id="guess-btn" 
            class="w-full p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
          >
            í™•ì¸
          </button>
          
          <div id="guess-result" class="mt-4 text-center"></div>
        `;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("guess-btn")
          .addEventListener("click", handleNumberGuess);
        document
          .getElementById("number-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleNumberGuess();
          });
      }

      function handleNumberGuess() {
        const input = document.getElementById("number-input");
        const result = document.getElementById("guess-result");
        const guess = parseInt(input.value);

        if (isNaN(guess) || guess < 1 || guess > 10000) {
          result.innerHTML =
            '<p class="text-red-500">1ë¶€í„° 10,000 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!</p>';
          return;
        }

        gameState.attempts++;

        if (guess === gameState.targetNumber) {
          result.innerHTML = `
            <div class="text-green-600">
              <p class="text-xl font-bold">ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!</p>
              <p>${gameState.attempts}ë²ˆ ë§Œì— ë§ì¶”ì…¨ë„¤ìš”!</p>
            </div>
          `;
          document.getElementById("guess-btn").disabled = true;
          input.disabled = true;

          // ì ìˆ˜ ì €ì¥
          saveGameScore("number-guess", gameState.attempts, {
            attempts: gameState.attempts,
            targetNumber: gameState.targetNumber,
          });
        } else if (gameState.attempts >= gameState.maxAttempts) {
          result.innerHTML = `
            <div class="text-red-600">
              <p class="text-xl font-bold">ğŸ˜¢ ê²Œì„ ì¢…ë£Œ!</p>
              <p>ì •ë‹µì€ ${gameState.targetNumber}ì˜€ìŠµë‹ˆë‹¤.</p>
            </div>
          `;
          document.getElementById("guess-btn").disabled = true;
          input.disabled = true;
        } else {
          const hint = guess > gameState.targetNumber ? "ë” ì‘ì€" : "ë” í°";
          result.innerHTML = `<p class="text-orange-500">${hint} ìˆ«ìì…ë‹ˆë‹¤! ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.</p>`;
        }

        input.value = "";
      }

      // ìƒ‰ê¹” ê¸°ì–µí•˜ê¸° ê²Œì„
      function startColorMemoryGame() {
        currentGame = "color-memory";
        gameState = {
          sequence: [],
          playerSequence: [],
          level: 1,
          colors: ["red", "blue", "green", "yellow"],
          isShowing: false,
          maxLevel: 100, // ìµœëŒ€ ë ˆë²¨ 100ìœ¼ë¡œ í™•ì¥
        };

        generateSequence();
        showGameScreen();
        updateColorMemoryUI();
      }

      function generateSequence() {
        gameState.sequence.push(
          gameState.colors[Math.floor(Math.random() * gameState.colors.length)]
        );
      }

      function updateColorMemoryUI() {
        const content = document.getElementById("game-content");

        content.innerHTML = `
          <div class="mb-4">
            <h4 class="text-lg font-bold text-green-700 mb-2">ğŸ¨ ìƒ‰ê¹” ê¸°ì–µí•˜ê¸°</h4>
            <p class="text-sm text-gray-600">ìƒ‰ê¹” ìˆœì„œë¥¼ ê¸°ì–µí•˜ê³  ë”°ë¼í•´ë³´ì„¸ìš”!</p>
            <p class="text-sm text-gray-500">ë ˆë²¨: ${gameState.level}/${gameState.maxLevel}</p>
          </div>
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <button class="color-btn w-20 h-20 rounded-lg bg-red-500 hover:bg-red-600" data-color="red"></button>
            <button class="color-btn w-20 h-20 rounded-lg bg-blue-500 hover:bg-blue-600" data-color="blue"></button>
            <button class="color-btn w-20 h-20 rounded-lg bg-green-500 hover:bg-green-600" data-color="green"></button>
            <button class="color-btn w-20 h-20 rounded-lg bg-yellow-500 hover:bg-yellow-600" data-color="yellow"></button>
          </div>
          
          <button 
            id="start-sequence-btn" 
            class="w-full p-3 bg-green-500 text-white rounded-lg hover:bg-green-600"
          >
            ìˆœì„œ ë³´ê¸°
          </button>
          
          <div id="sequence-result" class="mt-4 text-center"></div>
        `;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("start-sequence-btn")
          .addEventListener("click", showSequence);
        document.querySelectorAll(".color-btn").forEach((btn) => {
          btn.addEventListener("click", () =>
            handleColorClick(btn.dataset.color)
          );
        });
      }

      function showSequence() {
        if (gameState.isShowing) return;

        gameState.isShowing = true;
        document.getElementById("start-sequence-btn").disabled = true;

        let index = 0;
        const interval = setInterval(() => {
          if (index >= gameState.sequence.length) {
            clearInterval(interval);
            gameState.isShowing = false;
            document.getElementById("start-sequence-btn").disabled = false;
            gameState.playerSequence = [];
            return;
          }

          const color = gameState.sequence[index];
          const btn = document.querySelector(`[data-color="${color}"]`);

          btn.style.opacity = "0.3";
          setTimeout(() => {
            btn.style.opacity = "1";
          }, Math.max(100, 500 - (gameState.level - 1) * 40)); // ë ˆë²¨ì´ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë¹¨ë¼ì§

          index++;
        }, Math.max(200, 600 - (gameState.level - 1) * 50)); // ë ˆë²¨ì´ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë¹¨ë¼ì§
      }

      function handleColorClick(color) {
        if (gameState.isShowing) return;

        gameState.playerSequence.push(color);
        const result = document.getElementById("sequence-result");

        if (
          gameState.playerSequence[gameState.playerSequence.length - 1] !==
          gameState.sequence[gameState.playerSequence.length - 1]
        ) {
          result.innerHTML = `
            <div class="text-red-600">
              <p class="text-xl font-bold">ğŸ˜¢ í‹€ë ¸ìŠµë‹ˆë‹¤!</p>
              <p>ë ˆë²¨ ${gameState.level}ì—ì„œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
            </div>
          `;
          return;
        }

        if (gameState.playerSequence.length === gameState.sequence.length) {
          // ìµœëŒ€ ë ˆë²¨ ë‹¬ì„± ì²´í¬
          if (gameState.level >= gameState.maxLevel) {
            result.innerHTML = `
              <div class="text-yellow-600">
                <p class="text-xl font-bold">ğŸ† ìµœëŒ€ ë ˆë²¨ ë‹¬ì„±!</p>
                <p>ë ˆë²¨ ${gameState.level} í´ë¦¬ì–´! ëª¨ë“  ë ˆë²¨ì„ ì™„ì£¼í–ˆìŠµë‹ˆë‹¤!</p>
              </div>
            `;

            // ìµœëŒ€ ë ˆë²¨ ë‹¬ì„± ì ìˆ˜ ì €ì¥
            saveGameScore("color-memory", gameState.level, {
              level: gameState.level,
              completed: true,
              sequence: gameState.sequence,
            });
            return;
          }

          gameState.level++;
          generateSequence();
          result.innerHTML = `
            <div class="text-green-600">
              <p class="text-xl font-bold">ğŸ‰ ë ˆë²¨ ${
                gameState.level - 1
              } í´ë¦¬ì–´!</p>
              <p>ë‹¤ìŒ ë ˆë²¨ë¡œ ì§„í–‰í•©ë‹ˆë‹¤. (${gameState.level}/${
            gameState.maxLevel
          })</p>
            </div>
          `;

          // ì ìˆ˜ ì €ì¥ (ë ˆë²¨ í´ë¦¬ì–´ ì‹œë§ˆë‹¤)
          saveGameScore("color-memory", gameState.level - 1, {
            level: gameState.level - 1,
            sequence: gameState.sequence.slice(0, -1), // ë§ˆì§€ë§‰ì— ì¶”ê°€ëœ ê²ƒ ì œì™¸
          });

          setTimeout(() => {
            updateColorMemoryUI();
          }, 1500);
        }
      }

      // ìë™ì°¨ ë ˆì´ì‹± ê²Œì„
      function startCarRacingGame() {
        currentGame = "car-racing";
        gameState = {
          distance: 0,
          speed: 2,
          carPosition: 1, // 0: ì™¼ìª½, 1: ì¤‘ì•™, 2: ì˜¤ë¥¸ìª½
          obstacles: [],
          gameRunning: false,
          score: 0,
          lastObstacleTime: 0,
        };

        showGameScreen();
        updateCarRacingUI();

        // í‚¤ë³´ë“œì™€ í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener("keydown", handleCarRacingKey);
        document.addEventListener("touchstart", handleCarRacingTouch);
      }

      function updateCarRacingUI() {
        const content = document.getElementById("game-content");
        const { distance, speed, carPosition, gameRunning } = gameState;

        content.innerHTML = `
          <div class="mb-4">
            <h4 class="text-lg font-bold text-red-700 mb-2">ğŸï¸ ìë™ì°¨ ë ˆì´ì‹±</h4>
            <p class="text-sm text-gray-600">í„°ì¹˜í•˜ê±°ë‚˜ ì¢Œìš° í™”ì‚´í‘œë¡œ ì¥ì• ë¬¼ì„ í”¼í•˜ì„¸ìš”!</p>
            <div class="flex justify-between text-sm text-gray-600 mt-2">
              <span>ê±°ë¦¬: ${Math.floor(distance)}m</span>
              <span>ì†ë„: ${speed.toFixed(1)}x</span>
            </div>
          </div>
          
          <div class="relative bg-gray-800 h-64 rounded-lg overflow-hidden border-2 border-gray-600">
            <!-- ë„ë¡œ ë°°ê²½ -->
            <div class="absolute inset-0 bg-gradient-to-b from-gray-700 to-gray-900"></div>
            
            <!-- ë„ë¡œ êµ¬ë¶„ì„  -->
            <div class="absolute left-1/3 w-1 h-full bg-yellow-400 opacity-50"></div>
            <div class="absolute right-1/3 w-1 h-full bg-yellow-400 opacity-50"></div>
            
            <!-- ìë™ì°¨ (ì‹¤ì œ ìë™ì°¨ ëª¨ì–‘) -->
            <div id="car" class="absolute bottom-4 w-10 h-16 transition-all duration-100" 
                 style="left: ${
                   carPosition === 0 ? "25%" : carPosition === 1 ? "50%" : "75%"
                 }; transform: translateX(-50%);">
              <div class="relative w-full h-full">
                <!-- ìë™ì°¨ ë³¸ì²´ -->
                <div class="absolute bottom-0 w-full h-10 bg-gradient-to-t from-red-600 to-red-500 rounded-lg shadow-lg"></div>
                <!-- ìë™ì°¨ ì§€ë¶• -->
                <div class="absolute top-2 left-1 right-1 h-6 bg-gradient-to-t from-red-400 to-red-300 rounded-md"></div>
                <!-- ì•ìœ ë¦¬ -->
                <div class="absolute top-3 left-2 right-2 h-3 bg-blue-200 opacity-60 rounded-sm"></div>
                <!-- í—¤ë“œë¼ì´íŠ¸ -->
                <div class="absolute bottom-8 left-1 w-2 h-2 bg-yellow-300 rounded-full"></div>
                <div class="absolute bottom-8 right-1 w-2 h-2 bg-yellow-300 rounded-full"></div>
                <!-- ë°”í€´ -->
                <div class="absolute bottom-1 left-1 w-2 h-2 bg-gray-800 rounded-full"></div>
                <div class="absolute bottom-1 right-1 w-2 h-2 bg-gray-800 rounded-full"></div>
                <div class="absolute top-6 left-1 w-2 h-2 bg-gray-800 rounded-full"></div>
                <div class="absolute top-6 right-1 w-2 h-2 bg-gray-800 rounded-full"></div>
              </div>
            </div>
            
            <!-- ì¥ì• ë¬¼ë“¤ -->
            <div id="obstacles-container"></div>
            
            ${
              !gameRunning
                ? `
              <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
                <div class="text-center text-white">
                  <div class="text-2xl mb-2">ğŸï¸</div>
                  <p class="text-lg font-bold mb-2">ì¤€ë¹„ë˜ë©´ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!</p>
                  <p class="text-sm opacity-75">í„°ì¹˜í•˜ê±°ë‚˜ ì¢Œìš° í™”ì‚´í‘œë¡œ ì¡°ì‘</p>
                </div>
              </div>
            `
                : ""
            }
          </div>
          
          <!-- í„°ì¹˜ ì»¨íŠ¸ë¡¤ -->
          <div class="mt-4 flex justify-center gap-4">
            <button id="left-btn" class="w-16 h-16 bg-blue-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-blue-600 active:bg-blue-700 transition-colors touch-manipulation">
              â†
            </button>
            <button id="start-race-btn" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 active:bg-green-700 transition-colors touch-manipulation">
              ${gameRunning ? "ê²Œì„ ì¤‘..." : "ì‹œì‘!"}
            </button>
            <button id="right-btn" class="w-16 h-16 bg-blue-500 text-white rounded-full flex items-center justify-center text-2xl hover:bg-blue-600 active:bg-blue-700 transition-colors touch-manipulation">
              â†’
            </button>
          </div>
        `;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("start-race-btn")
          ?.addEventListener("click", startCarRace);

        // í„°ì¹˜ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document
          .getElementById("left-btn")
          ?.addEventListener("click", () => moveCarLeft());

        document
          .getElementById("right-btn")
          ?.addEventListener("click", () => moveCarRight());

        updateObstaclesDisplay();
      }

      function startCarRace() {
        if (gameState.gameRunning) return;

        gameState.gameRunning = true;
        gameState.distance = 0;
        gameState.speed = 3; // ì´ˆê¸° ì†ë„ë¥¼ ë¹ ë¥´ê²Œ ì„¤ì •
        gameState.obstacles = [];
        gameState.lastObstacleTime = Date.now();

        updateCarRacingUI();
        gameState.gameLoop = setInterval(gameLoop, 50); // 50msë§ˆë‹¤ ì—…ë°ì´íŠ¸ (ë¹ ë¥¸ ê²Œì„)
      }

      function gameLoop() {
        if (!gameState.gameRunning) return;

        // ê±°ë¦¬ ì¦ê°€ (ì†ë„ì— ë¹„ë¡€)
        gameState.distance += gameState.speed * 0.5;

        // ì†ë„ ì¦ê°€ (ê±°ë¦¬ì— ë”°ë¼ ì ì  ë¹¨ë¼ì§)
        gameState.speed = Math.min(3 + (gameState.distance / 100) * 0.5, 8);

        // ì¥ì• ë¬¼ ìƒì„± (ê±°ë¦¬ì— ë”°ë¼ ë¹¨ë¼ì§)
        const now = Date.now();
        const obstacleInterval = Math.max(300, 1200 - (gameState.distance / 50) * 100); // ìµœì†Œ 0.3ì´ˆ, ìµœëŒ€ 1.2ì´ˆ
        if (now - gameState.lastObstacleTime > obstacleInterval) {
          createObstacle();
          gameState.lastObstacleTime = now;
        }

        // ì¥ì• ë¬¼ ì´ë™
        moveObstacles();

        // ì¶©ëŒ ê²€ì‚¬
        if (checkCollision()) {
          endCarRace();
          return;
        }

        // UI ì—…ë°ì´íŠ¸
        updateCarRacingUI();
      }

      function createObstacle() {
        const positions = [0, 1, 2];
        const randomPos =
          positions[Math.floor(Math.random() * positions.length)];

        gameState.obstacles.push({
          x: randomPos,
          y: -30,
          width: 30,
          height: 30,
        });
      }

      function moveObstacles() {
        gameState.obstacles = gameState.obstacles.filter((obstacle) => {
          obstacle.y += gameState.speed * 2.5; // ë” ë¹ ë¥¸ ì´ë™
          return obstacle.y < 350; // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
        });
      }

      function checkCollision() {
        const carX = gameState.carPosition;
        const carY = 200; // ìë™ì°¨ y ìœ„ì¹˜
        const carWidth = 60; // ìë™ì°¨ í­
        const carHeight = 48; // ìë™ì°¨ ë†’ì´

        return gameState.obstacles.some((obstacle) => {
          // ë” ì •êµí•œ ì¶©ëŒ ê°ì§€ (ì¤‘ì‹¬ì  ê¸°ì¤€)
          const carCenterX = carX * 100 + 50; // ì°¨ì„  ì¤‘ì•™
          const obstacleCenterX = obstacle.x * 100 + 50;
          
          return (
            Math.abs(carCenterX - obstacleCenterX) < (carWidth + obstacle.width) / 2 &&
            obstacle.y + obstacle.height >= carY &&
            obstacle.y <= carY + carHeight
          );
        });
      }

      function endCarRace() {
        gameState.gameRunning = false;
        clearInterval(gameState.gameLoop);

        // í‚¤ë³´ë“œì™€ í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        document.removeEventListener("keydown", handleCarRacingKey);
        document.removeEventListener("touchstart", handleCarRacingTouch);

        // ì ìˆ˜ ì €ì¥
        saveGameScore("car-racing", gameState.distance, {
          distance: Math.floor(gameState.distance),
          maxSpeed: gameState.speed.toFixed(1),
        });

        // ê²°ê³¼ í™”ë©´ í‘œì‹œ
        const content = document.getElementById("game-content");
        content.innerHTML = `
          <div class="text-center py-8">
            <div class="text-6xl mb-4">ğŸ’¥</div>
            <h4 class="text-xl font-bold text-red-700 mb-2">ê²Œì„ ì¢…ë£Œ!</h4>
            <p class="text-lg text-gray-700 mb-2">ìµœì¢… ê±°ë¦¬: <span class="font-bold text-blue-600">${Math.floor(
              gameState.distance
            )}m</span></p>
            <p class="text-sm text-gray-600 mb-4">ìµœê³  ì†ë„: ${gameState.speed.toFixed(
              1
            )}x</p>
            <button id="restart-car-race" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
              ë‹¤ì‹œ í”Œë ˆì´
            </button>
          </div>
        `;

        document
          .getElementById("restart-car-race")
          ?.addEventListener("click", () => {
            startCarRacingGame();
          });
      }

      function updateObstaclesDisplay() {
        const container = document.getElementById("obstacles-container");
        if (!container) return;

        container.innerHTML = gameState.obstacles
          .map(
            (obstacle, index) => `
          <div class="absolute w-8 h-8 bg-orange-600 rounded" 
               style="left: ${
                 obstacle.x === 0 ? "25%" : obstacle.x === 1 ? "50%" : "75%"
               }; 
                      top: ${obstacle.y}px; 
                      transform: translateX(-50%);">
            <div class="w-full h-full bg-orange-700 rounded flex items-center justify-center text-white text-xs">ğŸš§</div>
          </div>
        `
          )
          .join("");
      }

      function handleCarRacingKey(e) {
        if (!gameState.gameRunning) return;

        if (e.key === "ArrowLeft" && gameState.carPosition > 0) {
          gameState.carPosition--;
        } else if (e.key === "ArrowRight" && gameState.carPosition < 2) {
          gameState.carPosition++;
        }
      }

      // í„°ì¹˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      function handleCarRacingTouch(e) {
        if (!gameState.gameRunning) return;

        e.preventDefault();

        const touch = e.touches[0];
        const gameArea = document.querySelector(".relative.bg-gray-800");
        if (!gameArea) return;

        const rect = gameArea.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;
        const gameWidth = rect.width;

        // í™”ë©´ì„ 3ë“±ë¶„í•˜ì—¬ í„°ì¹˜ ìœ„ì¹˜ì— ë”°ë¼ ìë™ì°¨ ì´ë™
        if (touchX < gameWidth / 3 && gameState.carPosition > 0) {
          gameState.carPosition--;
        } else if (touchX > (gameWidth * 2) / 3 && gameState.carPosition < 2) {
          gameState.carPosition++;
        }
      }

      // ìë™ì°¨ ì´ë™ í•¨ìˆ˜ë“¤
      function moveCarLeft() {
        if (!gameState.gameRunning) return;
        if (gameState.carPosition > 0) {
          gameState.carPosition--;
        }
      }

      function moveCarRight() {
        if (!gameState.gameRunning) return;
        if (gameState.carPosition < 2) {
          gameState.carPosition++;
        }
      }

      // ê³µ íŠ€ê¸°ê¸° ê²Œì„
      function startBallBounceGame() {
        currentGame = "ball-bounce";
        gameState = {
          score: 0,
          ballX: 200,
          ballY: 100,
          ballVx: 3,
          ballVy: -4,
          paddleX: 160,
          paddleWidth: 80,
          gameRunning: false,
          lives: 3,
          level: 1,
          ballSize: 20,
          paddleSpeed: 8,
          touchStartX: null,
          paddleStartX: null,
        };

        showGameScreen();
        updateBallBounceUI();

        // í‚¤ë³´ë“œì™€ í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener("keydown", handleBallBounceKey);
        document.addEventListener("mousemove", handleBallBounceMouse);
        document.addEventListener("touchstart", handleBallBounceTouchStart);
        document.addEventListener("touchmove", handleBallBounceTouchMove);
      }

      function updateBallBounceUI() {
        const content = document.getElementById("game-content");
        const {
          score,
          lives,
          level,
          ballX,
          ballY,
          paddleX,
          paddleWidth,
          gameRunning,
        } = gameState;

        content.innerHTML = `
          <div class="mb-4">
            <h4 class="text-lg font-bold text-purple-700 mb-2">âš½ ê³µ íŠ€ê¸°ê¸°</h4>
            <p class="text-sm text-gray-600">ê³µì´ ë°”ë‹¥ì— ë–¨ì–´ì§€ì§€ ì•Šë„ë¡ íŒ¨ë“¤ì„ ì›€ì§ì´ì„¸ìš”!</p>
            <div class="flex justify-between text-sm text-gray-600 mt-2">
              <span>ì ìˆ˜: ${score}</span>
              <span>ìƒëª…: ${lives}</span>
              <span>ë ˆë²¨: ${level}</span>
            </div>
          </div>
          
          <div class="relative bg-gradient-to-b from-blue-400 to-blue-600 rounded-lg overflow-hidden border-2 border-gray-600 mx-auto" style="width: 400px; max-width: 100%; height: 320px;">
            <!-- ê³µ -->
            <div id="ball" class="absolute w-5 h-5 bg-yellow-400 rounded-full shadow-lg transition-all duration-75" 
                 style="left: ${ballX}px; top: ${ballY}px;">
              <div class="w-full h-full bg-gradient-to-br from-yellow-300 to-yellow-500 rounded-full"></div>
            </div>
            
            <!-- íŒ¨ë“¤ -->
            <div id="paddle" class="absolute bottom-4 bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-lg transition-all duration-75" 
                 style="left: ${paddleX}px; width: ${paddleWidth}px; height: 12px;"></div>
            
            ${
              !gameRunning
                ? `
              <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
                <div class="text-center text-white">
                  <div class="text-2xl mb-2">âš½</div>
                  <p class="text-lg font-bold mb-2">ì¤€ë¹„ë˜ë©´ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!</p>
                  <p class="text-sm opacity-75">ë§ˆìš°ìŠ¤ë‚˜ í„°ì¹˜ë¡œ íŒ¨ë“¤ ì¡°ì‘</p>
                </div>
              </div>
            `
                : ""
            }
          </div>
          
          <div class="mt-4 text-center">
            <button id="start-ball-btn" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
              ${gameRunning ? "ê²Œì„ ì¤‘..." : "ì‹œì‘!"}
          </button>
          </div>
        `;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document
          .getElementById("start-ball-btn")
          ?.addEventListener("click", startBallGame);
      }

      function startBallGame() {
        if (gameState.gameRunning) return;

        gameState.gameRunning = true;
        gameState.ballX = 200;
        gameState.ballY = 100;
        gameState.ballVx = 3;
        gameState.ballVy = -4;

        updateBallBounceUI();
        gameState.gameLoop = setInterval(ballGameLoop, 16); // 60fps
      }

      function ballGameLoop() {
        if (!gameState.gameRunning) return;

        // ê³µ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        gameState.ballX += gameState.ballVx;
        gameState.ballY += gameState.ballVy;

        // ë²½ ì¶©ëŒ ê²€ì‚¬ (ê³µì˜ í¬ê¸° ê³ ë ¤) - ì˜¤ë¥¸ìª½ ë²½ ë²„ê·¸ ìˆ˜ì •
        const ballSize = gameState.ballSize;
        if (gameState.ballX <= ballSize / 2) {
          gameState.ballX = ballSize / 2;
          gameState.ballVx = Math.abs(gameState.ballVx); // í•­ìƒ ì–‘ìˆ˜ë¡œ
        } else if (gameState.ballX >= 400 - ballSize / 2) {
          gameState.ballX = 400 - ballSize / 2;
          gameState.ballVx = -Math.abs(gameState.ballVx); // í•­ìƒ ìŒìˆ˜ë¡œ
        }
        if (gameState.ballY <= ballSize / 2) {
          gameState.ballY = ballSize / 2;
          gameState.ballVy = -gameState.ballVy;
        }

        // ë°”ë‹¥ ì¶©ëŒ ê²€ì‚¬ (íŒ¨ë“¤ ì¶©ëŒ í›„ì—ë§Œ)
        if (gameState.ballY >= 320 - ballSize / 2 && gameState.ballVy > 0) {
          gameState.lives--;
          if (gameState.lives <= 0) {
            endBallGame();
            return;
          }

          // ê³µ ë¦¬ì…‹
          gameState.ballX = 200;
          gameState.ballY = 100;
          gameState.ballVx = 3;
          gameState.ballVy = -4;
        }

        // íŒ¨ë“¤ ì¶©ëŒ ê²€ì‚¬ (ë” ì •í™•í•œ ì¶©ëŒ ê°ì§€) - ë°” ì¶©ëŒ ë²„ê·¸ ìˆ˜ì •
        if (
          gameState.ballY + ballSize / 2 >= 300 &&
          gameState.ballY - ballSize / 2 <= 300 + 20 && // íŒ¨ë“¤ ë†’ì´ 20px
          gameState.ballX + ballSize / 2 >= gameState.paddleX &&
          gameState.ballX - ballSize / 2 <= gameState.paddleX + gameState.paddleWidth &&
          gameState.ballVy > 0 // ê³µì´ ì•„ë˜ë¡œ ë–¨ì–´ì§€ê³  ìˆì„ ë•Œë§Œ
        ) {
          gameState.ballY = 300 - ballSize / 2; // ê³µì„ íŒ¨ë“¤ ìœ„ì— ì •í™•íˆ ìœ„ì¹˜
          gameState.ballVy = -Math.abs(gameState.ballVy); // ì¦‰ì‹œ ìœ„ë¡œ ë°˜ì‚¬
          gameState.score += 10;

          // ì†ë„ ì¦ê°€
          gameState.ballVx *= 1.02;
          gameState.ballVy *= 1.02;

          // ë ˆë²¨ ì—…
          if (gameState.score % 100 === 0) {
            gameState.level++;
            gameState.paddleWidth = Math.max(50, gameState.paddleWidth - 5);
          }
        }

        updateBallBounceUI();
      }

      function endBallGame() {
        gameState.gameRunning = false;
        clearInterval(gameState.gameLoop);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        document.removeEventListener("keydown", handleBallBounceKey);
        document.removeEventListener("mousemove", handleBallBounceMouse);
        document.removeEventListener("touchstart", handleBallBounceTouchStart);
        document.removeEventListener("touchmove", handleBallBounceTouchMove);

        // ì ìˆ˜ ì €ì¥
        saveGameScore("ball-bounce", gameState.score, {
          score: gameState.score,
          level: gameState.level,
          lives: gameState.lives,
        });

        // ê²°ê³¼ í™”ë©´ í‘œì‹œ
        const content = document.getElementById("game-content");
        content.innerHTML = `
          <div class="text-center py-8">
            <div class="text-6xl mb-4">ğŸ†</div>
            <h4 class="text-xl font-bold text-purple-700 mb-2">ê²Œì„ ì¢…ë£Œ!</h4>
            <p class="text-lg text-gray-700 mb-2">ìµœì¢… ì ìˆ˜: <span class="font-bold text-purple-600">${gameState.score}ì </span></p>
            <p class="text-sm text-gray-600 mb-4">ë„ë‹¬ ë ˆë²¨: ${gameState.level}</p>
            <button id="restart-ball-game" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
              ë‹¤ì‹œ í”Œë ˆì´
            </button>
            </div>
          `;

        document
          .getElementById("restart-ball-game")
          ?.addEventListener("click", () => {
            startBallBounceGame();
          });
      }

      function handleBallBounceKey(e) {
        if (!gameState.gameRunning) return;

        if (e.key === "ArrowLeft" && gameState.paddleX > 0) {
          gameState.paddleX -= gameState.paddleSpeed;
        } else if (e.key === "ArrowRight" && gameState.paddleX < 300) {
          gameState.paddleX += gameState.paddleSpeed;
        }
      }

      function handleBallBounceMouse(e) {
        if (!gameState.gameRunning) return;

        const gameArea = document.querySelector(".relative.bg-gradient-to-b");
        if (!gameArea) return;

        const rect = gameArea.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        gameState.paddleX = Math.max(
          0,
          Math.min(300, mouseX - gameState.paddleWidth / 2)
        );
      }

      // í„°ì¹˜ ì‹œì‘ ì‹œ ì´ˆê¸° ìœ„ì¹˜ ì €ì¥
      function handleBallBounceTouchStart(e) {
        if (!gameState.gameRunning) return;

        e.preventDefault();
        const touch = e.touches[0];
        const gameArea = document.querySelector(".relative.bg-gradient-to-b");
        if (!gameArea) return;

        const rect = gameArea.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;

        // í„°ì¹˜ ì‹œì‘ ì‹œ ì´ˆê¸° ìœ„ì¹˜ì™€ íŒ¨ë“¤ ìœ„ì¹˜ ì €ì¥
        gameState.touchStartX = touchX;
        gameState.paddleStartX = gameState.paddleX;
      }

      // í„°ì¹˜ ì´ë™ ì‹œ ìŠ¬ë¼ì´ë“œë¡œ íŒ¨ë“¤ ì´ë™ (ê°œì„ ëœ ë°©ì‹)
      function handleBallBounceTouchMove(e) {
        if (!gameState.gameRunning) return;

        e.preventDefault();
        const touch = e.touches[0];
        const gameArea = document.querySelector(".relative.bg-gradient-to-b");
        if (!gameArea) return;

        const rect = gameArea.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;
        const gameWidth = rect.width;

        // í„°ì¹˜ ìœ„ì¹˜ë¥¼ ê²Œì„ í™”ë©´ ë¹„ìœ¨ë¡œ ë³€í™˜
        const touchRatio = touchX / gameWidth;
        const newPaddleX = touchRatio * (400 - gameState.paddleWidth);

        // ê²½ê³„ ë‚´ì—ì„œë§Œ ì´ë™
        gameState.paddleX = Math.max(0, Math.min(400 - gameState.paddleWidth, newPaddleX));
      }

      // ê²Œì„ ì ìˆ˜ ë°ì´í„° ë¡œë“œ
      function loadGameScores() {
        if (!currentUser) return;

        const unsubscribe = onSnapshot(
          collection(db, "gameScores"),
          (snapshot) => {
            gameScores = {};
            snapshot.forEach((doc) => {
              const data = doc.data();
              if (!gameScores[data.gameType]) {
                gameScores[data.gameType] = [];
              }
              gameScores[data.gameType].push({
                id: doc.id,
                ...data,
              });
            });
            console.log("ê²Œì„ ì ìˆ˜ ë¡œë“œë¨:", gameScores);
          },
          (error) => {
            console.error("ê²Œì„ ì ìˆ˜ ë¡œë“œ ì˜¤ë¥˜:", error);
          }
        );

        return unsubscribe;
      }

      // ê²Œì„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("number-guess-btn")
          ?.addEventListener("click", startNumberGuessGame);
        document
          .getElementById("color-memory-btn")
          ?.addEventListener("click", startColorMemoryGame);
        document
          .getElementById("car-racing-btn")
          ?.addEventListener("click", startCarRacingGame);

        document
          .getElementById("ball-bounce-btn")
          ?.addEventListener("click", startBallBounceGame);

        document
          .getElementById("game-back-btn")
          ?.addEventListener("click", showGameSelection);
        document
          .getElementById("game-restart-btn")
          ?.addEventListener("click", () => {
            if (currentGame === "number-guess") startNumberGuessGame();
            else if (currentGame === "color-memory") startColorMemoryGame();
            else if (currentGame === "car-racing") startCarRacingGame();
            else if (currentGame === "ball-bounce") startBallBounceGame();
          });

        // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document
          .getElementById("games-tab-btn")
          ?.addEventListener("click", () => {
            document.getElementById("games-tab-btn").className =
              "flex-1 py-2 px-4 text-center font-medium text-purple-600 border-b-2 border-purple-600";
            document.getElementById("ranking-tab-btn").className =
              "flex-1 py-2 px-4 text-center font-medium text-gray-500 hover:text-gray-700";
            showGameSelectionFromRanking();
          });

        document
          .getElementById("ranking-tab-btn")
          ?.addEventListener("click", () => {
            document.getElementById("ranking-tab-btn").className =
              "flex-1 py-2 px-4 text-center font-medium text-purple-600 border-b-2 border-purple-600";
            document.getElementById("games-tab-btn").className =
              "flex-1 py-2 px-4 text-center font-medium text-gray-500 hover:text-gray-700";
            showRankingScreen();
          });
      });

      /* ===== ë¬¸ì˜í•˜ê¸° íƒ­ ===== */
      /* ===== ë¬¸ì˜ ëª¨ë‹¬ ===== */
      function openInquiryModal() {
        const modal = document.getElementById("inquiry-modal");
        modal.classList.remove("hidden");
        renderInquiryList();
        setupInquirySubmit();
      }

      function renderInquiryList() {
        const isAdmin =
          currentUser && adminList.includes(currentUser.studentId);
        const listContainer = document.getElementById("modal-suggestions-list");

        const list = (suggestionsData || [])
          .map(
            (s) => `
          <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow">
            <div class="text-sm text-gray-500 flex items-center justify-between mb-2">
              <span class="font-medium">
                <i class="fas fa-user-circle mr-1 text-orange-500"></i>
                ${saf(s.name || "ìµëª…")} Â· ${
              s.timestamp?.toDate
                ? new Date(s.timestamp.toDate()).toLocaleString("ko-KR")
                : "-"
            }
              </span>
              ${
                isAdmin
                  ? `<button class="text-red-600 text-xs hover:text-red-800 transition-colors" data-act="del-sug" data-id="${s.id}">
                      <i class="fas fa-trash"></i> ì‚­ì œ
                    </button>`
                  : ""
              }
            </div>
            ${
              s.title
                ? `<div class="font-bold text-gray-800 mb-2 text-base">${saf(
                    s.title
                  )}</div>`
                : ""
            }
            <div class="text-gray-700 whitespace-pre-wrap">${saf(
              s.text || ""
            )}</div>
          </div>
        `
          )
          .join("");

        listContainer.innerHTML =
          list ||
          `<div class="text-center py-8 text-gray-400">
          <i class="fas fa-inbox text-3xl mb-2"></i>
          <p>ì•„ì§ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>`;

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        listContainer.onclick = async (e) => {
          const b = e.target.closest("button[data-act='del-sug']");
          if (b) {
            if (!confirm("ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
              await deleteDoc(doc(db, "suggestions", b.dataset.id));
              showAlert("ğŸ—‘ï¸", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
              renderInquiryList(); // ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
            } catch (err) {
              console.warn(err);
              showAlert("ğŸ˜¥", "ì‚­ì œ ì‹¤íŒ¨");
            }
          }
        };
      }

      function setupInquirySubmit() {
        const submitBtn = document.getElementById("modal-sug-submit");
        const titleInput = document.getElementById("modal-sug-title");
        const textInput = document.getElementById("modal-sug-text");

        // ì´ì „ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ë³µì œ
        const newSubmitBtn = submitBtn.cloneNode(true);
        submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);

        newSubmitBtn.onclick = async () => {
          const title = titleInput.value.trim();
          const text = textInput.value.trim();

          if (!text) return showAlert("ğŸ˜¥", "ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

          try {
            await addDoc(collection(db, "suggestions"), {
              studentId: currentUser?.studentId || "",
              name: currentUser?.name || "ìµëª…",
              title,
              text,
              timestamp: serverTimestamp(),
            });

            titleInput.value = "";
            textInput.value = "";
            showAlert("âœ…", "ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê³ ë§ˆì›Œìš”!");
            renderInquiryList(); // ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ë“±ë¡ ì‹¤íŒ¨");
          }
        };
      }

      function renderSuggestionsTab(isAdmin) {
        const c = document.getElementById("suggestions-tab");
        if (!c) return;

        // suggestions íƒ­ì€ ì´ì œ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹„ì›Œë‘ 
        c.innerHTML = `
          <div class="section text-center py-12">
            <div class="mb-4">
              <i class="fas fa-question-circle text-6xl text-orange-500 mb-4"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">ë¬¸ì˜í•˜ê¸°</h3>
            <p class="text-gray-600 mb-6">ìƒë‹¨ì˜ ë¬¸ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¬¸ì˜ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>
            <button 
              onclick="openInquiryModal()" 
              class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
              <i class="fas fa-paper-plane mr-2"></i>ë¬¸ì˜í•˜ê¸°
            </button>
          </div>
        `;
      }

      /* ===== ë¡œë“œë§µ íƒ­ ===== */
      function renderRoadmapTab(isAdmin) {
        const c = document.getElementById("roadmap-tab");
        if (!c) return;

        // ë§ˆê°ëœ ì´ë²¤íŠ¸ë§Œ ê°€ì ¸ì˜¤ê¸°
        const closedEvents = eventsData.filter((ev) => ev.status === "closed");

        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë¶„ë¥˜
        const mtEvents = closedEvents.filter((ev) => ev.type === "mt");
        const generalEvents = closedEvents.filter(
          (ev) => ev.type === "general" || ev.type === "assembly"
        );
        const tastingEvents = closedEvents.filter(
          (ev) => ev.type === "tasting"
        );

        // ë¯¸ì‹íšŒì˜ ê²½ìš° ì‹ë‹¹ ì •ë³´ ì¶”ì¶œ
        const tastingRestaurants = [];
        tastingEvents.forEach((ev) => {
          if (ev.restaurants && ev.restaurants.length > 0) {
            ev.restaurants.forEach((restaurant) => {
              // ì´ ì‹ë‹¹ì„ ì‹ ì²­í•œ ì‚¬ëŒë“¤ì˜ studentId ëª©ë¡
              const participantIds = (restaurant.reservations || []).map(
                (r) => r.studentId
              );

              // ì´ ì‹ë‹¹ì„ ì‹ ì²­í•œ ì‚¬ëŒë“¤ì˜ ë¦¬ë·°ë§Œ í•„í„°ë§
              const restaurantReviews = (ev.reviews || []).filter((review) =>
                participantIds.includes(review.studentId)
              );

              tastingRestaurants.push({
                eventId: ev.id,
                eventTitle: ev.title,
                eventDate: ev.datetime,
                restaurantName: restaurant.name,
                restaurantInfo: restaurant.info,
                restaurantImage: restaurant.imageUrl,
                restaurantCategory: restaurant.category || "ê¸°íƒ€",
                participantCount: participantIds.length,
                reviews: restaurantReviews,
              });
            });
          }
        });

        // í‰ê·  ë³„ì  ê³„ì‚° í•¨ìˆ˜
        const calculateAverageRating = (reviews) => {
          if (!reviews || reviews.length === 0) return 0;
          const sum = reviews.reduce((acc, r) => acc + (r.rating || 0), 0);
          return (sum / reviews.length).toFixed(1);
        };

        // ë³„ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
        const renderStars = (rating) => {
          const fullStars = Math.floor(rating);
          const hasHalfStar = rating % 1 >= 0.5;
          let stars = "";
          for (let i = 0; i < fullStars; i++) {
            stars += '<i class="fas fa-star text-yellow-400"></i>';
          }
          if (hasHalfStar) {
            stars += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
          }
          const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
          for (let i = 0; i < emptyStars; i++) {
            stars += '<i class="far fa-star text-gray-300"></i>';
          }
          return stars;
        };

        // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨í‹°ì½˜ ë°˜í™˜ í•¨ìˆ˜
        const getCategoryEmoji = (category) => {
          switch (category) {
            case "í•œì‹":
              return "ğŸš";
            case "ì¼ì‹":
              return "ğŸ£";
            case "ì¤‘ì‹":
              return "ğŸ¥Ÿ";
            case "ì–‘ì‹":
              return "ğŸ";
            case "ë””ì €íŠ¸":
              return "ğŸ°";
            default:
              return "ğŸ½ï¸";
          }
        };

        // ì‹ë‹¹ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (ë¯¸ì‹íšŒìš©)
        const createRestaurantCard = (restaurant) => {
          const avgRating = calculateAverageRating(restaurant.reviews);
          const reviewCount = restaurant.reviews.length;
          const categoryEmoji = getCategoryEmoji(restaurant.restaurantCategory);

          return `
            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden hover:shadow-lg transition-all" data-restaurant-id="${
              restaurant.eventId
            }">
              ${
                restaurant.restaurantImage
                  ? `
                <div class="w-full h-48 overflow-hidden relative">
                  <img 
                    src="${saf(restaurant.restaurantImage)}" 
                    alt="${saf(restaurant.restaurantName)}"
                    class="w-full h-full object-cover"
                    onerror="this.parentElement.style.display='none'"
                  >
                  ${
                    isAdmin
                      ? `
                    <button 
                      class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold shadow-lg transition-colors"
                      data-action="delete-restaurant"
                      data-event-id="${restaurant.eventId}"
                      data-restaurant-name="${saf(restaurant.restaurantName)}"
                      title="ì‹ë‹¹ ì‚­ì œ">
                      <i class="fas fa-trash mr-1"></i>ì‹ë‹¹ ì‚­ì œ
                    </button>
                  `
                      : ""
                  }
                </div>
              `
                  : ""
              }
              
              <div class="p-4">
                <div class="mb-3">
                  <div class="flex items-start justify-between mb-1">
                    <h4 class="text-xl font-bold text-gray-800 flex-1">
                      <span class="mr-2 text-2xl">${categoryEmoji}</span>
                      ${saf(restaurant.restaurantName || "(ì‹ë‹¹ ì´ë¦„ ì—†ìŒ)")}
                    </h4>
                    ${
                      isAdmin && !restaurant.restaurantImage
                        ? `
                      <button 
                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold shadow transition-colors ml-2"
                        data-action="delete-restaurant"
                        data-event-id="${restaurant.eventId}"
                        data-restaurant-name="${saf(restaurant.restaurantName)}"
                        title="ì‹ë‹¹ ì‚­ì œ">
                        <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                      </button>
                    `
                        : ""
                    }
                  </div>
                  ${
                    restaurant.restaurantInfo
                      ? `<p class="text-sm text-gray-600">${saf(
                          restaurant.restaurantInfo
                        )}</p>`
                      : ""
                  }
                  <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-calendar mr-1"></i>
                    ${new Date(restaurant.eventDate).toLocaleDateString(
                      "ko-KR",
                      {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                      }
                    )} Â· ${restaurant.eventTitle}
                  </p>
                  <p class="text-xs text-gray-500">
                    <i class="fas fa-users mr-1"></i>
                    ${restaurant.participantCount}ëª… ì°¸ê°€
                  </p>
                  
                  <!-- ì¹´í…Œê³ ë¦¬ í‘œì‹œ -->
                  <div class="mt-2 flex items-center gap-2">
                    <span class="text-xs text-gray-500 flex items-center">
                      <i class="fas fa-tags mr-1"></i>ì¹´í…Œê³ ë¦¬:
                    </span>
                    ${
                      isAdmin
                        ? `
                      <select 
                        class="text-xs px-2 py-1 border border-gray-300 rounded-lg focus:border-orange-400 focus:outline-none bg-white"
                        data-action="update-category"
                        data-event-id="${restaurant.eventId}"
                        data-restaurant-name="${saf(
                          restaurant.restaurantName
                        )}">
                        <option value="í•œì‹" ${
                          restaurant.restaurantCategory === "í•œì‹"
                            ? "selected"
                            : ""
                        }>ğŸš í•œì‹</option>
                        <option value="ì¼ì‹" ${
                          restaurant.restaurantCategory === "ì¼ì‹"
                            ? "selected"
                            : ""
                        }>ğŸ£ ì¼ì‹</option>
                        <option value="ì¤‘ì‹" ${
                          restaurant.restaurantCategory === "ì¤‘ì‹"
                            ? "selected"
                            : ""
                        }>ğŸ¥Ÿ ì¤‘ì‹</option>
                        <option value="ì–‘ì‹" ${
                          restaurant.restaurantCategory === "ì–‘ì‹"
                            ? "selected"
                            : ""
                        }>ğŸ ì–‘ì‹</option>
                        <option value="ë””ì €íŠ¸" ${
                          restaurant.restaurantCategory === "ë””ì €íŠ¸"
                            ? "selected"
                            : ""
                        }>ğŸ° ë””ì €íŠ¸</option>
                        <option value="ê¸°íƒ€" ${
                          !restaurant.restaurantCategory ||
                          restaurant.restaurantCategory === "ê¸°íƒ€"
                            ? "selected"
                            : ""
                        }>ğŸ½ï¸ ê¸°íƒ€</option>
                      </select>
                    `
                        : `
                      <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold">
                        ${
                          restaurant.restaurantCategory === "í•œì‹"
                            ? "ğŸš í•œì‹"
                            : restaurant.restaurantCategory === "ì¼ì‹"
                            ? "ğŸ£ ì¼ì‹"
                            : restaurant.restaurantCategory === "ì¤‘ì‹"
                            ? "ğŸ¥Ÿ ì¤‘ì‹"
                            : restaurant.restaurantCategory === "ì–‘ì‹"
                            ? "ğŸ ì–‘ì‹"
                            : restaurant.restaurantCategory === "ë””ì €íŠ¸"
                            ? "ğŸ° ë””ì €íŠ¸"
                            : "ğŸ½ï¸ ê¸°íƒ€"
                        }
                      </span>
                    `
                    }
                  </div>
                </div>

                ${
                  reviewCount > 0
                    ? `
                  <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-3 mb-3 border border-orange-100">
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1">
                          ${renderStars(parseFloat(avgRating))}
                        </div>
                        <span class="text-2xl font-bold text-gray-800">${avgRating}</span>
                      </div>
                      <span class="text-sm text-gray-600 bg-white px-2 py-1 rounded-full">${reviewCount}ëª… í‰ê°€</span>
                    </div>
                    
                    ${
                      restaurant.reviews.length > 0
                        ? `
                      <div class="mt-3 space-y-2">
                        <p class="text-xs font-semibold text-gray-700 mb-2">
                          <i class="fas fa-comment-dots mr-1"></i>í›„ê¸°
                        </p>
                        <div class="review-list" data-event-id="${
                          restaurant.eventId
                        }" data-restaurant-name="${saf(
                            restaurant.restaurantName
                          )}" data-show-all="false">
                          ${restaurant.reviews
                            .filter((r) => r.comment && r.comment.trim())
                            .slice(0, 3)
                            .map(
                              (r) => `
                            <div class="bg-white rounded-lg p-3 border border-orange-100 shadow-sm relative review-item">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-700">
                                  <i class="fas fa-user-circle mr-1 text-orange-500"></i>
                                  ìµëª…
                                </span>
                                <div class="flex items-center gap-2">
                                  <div class="flex items-center gap-0.5">
                                    ${renderStars(r.rating || 0)}
                                  </div>
                                  ${
                                    isAdmin
                                      ? `
                                    <button 
                                      class="text-red-500 hover:text-red-700 transition-colors"
                                      data-action="delete-review"
                                      data-event-id="${restaurant.eventId}"
                                      data-student-id="${r.studentId}"
                                      title="í›„ê¸° ì‚­ì œ">
                                      <i class="fas fa-trash text-xs"></i>
                                    </button>
                                  `
                                      : ""
                                  }
                                </div>
                              </div>
                              <p class="text-sm text-gray-600 whitespace-pre-wrap">${saf(
                                r.comment
                              )}</p>
                            </div>
                          `
                            )
                            .join("")}
                        </div>
                        ${
                          restaurant.reviews.filter(
                            (r) => r.comment && r.comment.trim()
                          ).length > 3
                            ? `<button 
                                class="w-full text-xs text-orange-600 hover:text-orange-700 font-semibold text-center mt-2 py-2 bg-orange-50 hover:bg-orange-100 rounded-lg transition-colors border border-orange-200"
                                data-action="toggle-reviews"
                                data-event-id="${restaurant.eventId}"
                                data-restaurant-name="${saf(
                                  restaurant.restaurantName
                                )}">
                                <i class="fas fa-chevron-down mr-1"></i>
                                ì™¸ ${
                                  restaurant.reviews.filter(
                                    (r) => r.comment && r.comment.trim()
                                  ).length - 3
                                }ê°œ í›„ê¸° ë” ë³´ê¸°
                              </button>`
                            : ""
                        }
                      </div>
                    `
                        : ""
                    }
                  </div>
                `
                    : `
                  <div class="bg-gray-50 rounded-lg p-4 text-center">
                    <p class="text-sm text-gray-500">
                      <i class="fas fa-info-circle mr-1"></i>
                      ì•„ì§ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤
                    </p>
                  </div>
                `
                }
              </div>
            </div>
          `;
        };

        // ì´ë²¤íŠ¸ ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (MT, ì¼ë°˜ ì´ë²¤íŠ¸ìš©)
        const createEventCard = (ev) => {
          const avgRating = calculateAverageRating(ev.reviews || []);
          const reviewCount = ev.reviews ? ev.reviews.length : 0;

          return `
            <div class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-all">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeBadgeClass(
                      ev.type
                    )}">
                      ${typeLabel(ev.type)}
                    </span>
                  </div>
                  <h4 class="text-lg font-bold text-gray-800 mb-1">${saf(
                    ev.title || "(ì œëª© ì—†ìŒ)"
                  )}</h4>
                  <p class="text-sm text-gray-600">
                    <i class="fas fa-calendar mr-1"></i>
                    ${new Date(ev.datetime).toLocaleDateString("ko-KR", {
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    })}
                  </p>
                </div>
              </div>

              ${
                ev.type === "tasting" && reviewCount > 0
                  ? `
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-3 mb-3">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <div class="flex items-center gap-1">
                        ${renderStars(parseFloat(avgRating))}
                      </div>
                      <span class="text-lg font-bold text-gray-800">${avgRating}</span>
                      <span class="text-sm text-gray-600">(${reviewCount}ëª… í‰ê°€)</span>
                    </div>
                  </div>
                  
                  ${
                    ev.reviews && ev.reviews.length > 0
                      ? `
                    <div class="mt-3 space-y-2">
                      <p class="text-xs font-semibold text-gray-700 mb-2">
                        <i class="fas fa-comment-dots mr-1"></i>í›„ê¸°
                      </p>
                      ${ev.reviews
                        .filter((r) => r.comment && r.comment.trim())
                        .slice(0, 3)
                        .map(
                          (r) => `
                        <div class="bg-white rounded-lg p-2 border border-orange-100">
                          <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-semibold text-gray-700">${saf(
                              r.name || "ìµëª…"
                            )}</span>
                            <div class="flex items-center gap-0.5">
                              ${renderStars(r.rating || 0)}
                            </div>
                          </div>
                          <p class="text-xs text-gray-600 whitespace-pre-wrap">${saf(
                            r.comment
                          )}</p>
                        </div>
                      `
                        )
                        .join("")}
                      ${
                        ev.reviews.filter((r) => r.comment && r.comment.trim())
                          .length > 3
                          ? `<p class="text-xs text-gray-500 text-center mt-1">ì™¸ ${
                              ev.reviews.filter(
                                (r) => r.comment && r.comment.trim()
                              ).length - 3
                            }ê°œ í›„ê¸° ë”ë³´ê¸°...</p>`
                          : ""
                      }
                    </div>
                  `
                      : ""
                  }
                </div>
              `
                  : ""
              }

              ${
                ev.type !== "tasting" && reviewCount > 0
                  ? `
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                  <p class="text-sm text-gray-600">
                    <i class="fas fa-users mr-1"></i>
                    ${reviewCount}ëª…ì´ í‰ê°€í–ˆìŠµë‹ˆë‹¤
                  </p>
                </div>
              `
                  : ""
              }

              ${
                reviewCount === 0
                  ? `
                <div class="bg-gray-50 rounded-lg p-3">
                  <p class="text-sm text-gray-500 text-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    ì•„ì§ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤
                  </p>
                </div>
              `
                  : ""
              }
            </div>
          `;
        };

        c.innerHTML = `
          <div class="section">
            <div class="mb-4">
              <h3 class="text-2xl font-bold text-gray-800 mb-2">
                <i class="fas fa-utensils mr-2 text-orange-600"></i>
                ë¯¸ì‹íšŒ í›„ê¸°
              </h3>
              <p class="text-sm text-gray-600 mb-3">
                <i class="fas fa-heart mr-1 text-orange-500"></i>
                Foodie íšŒì›ë“¤ê³¼ í•¨ê»˜í–ˆë˜ ë¯¸ì‹íšŒ, ê·¸ë“¤ì´ ë‚¨ê²¨ì¤€ ì§„ì†”í•œ í›„ê¸°ì…ë‹ˆë‹¤
              </p>
              <div class="text-sm text-gray-600 bg-orange-50 border border-orange-200 rounded-lg px-3 py-2 inline-block">
                ì´ <span class="font-bold text-orange-600">${
                  tastingRestaurants.length
                }</span>ê°œ ì‹ë‹¹
              </div>
            </div>
            
            ${
              tastingRestaurants.length > 0
                ? `
            <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
            <div class="mb-4">
              <div class="flex flex-wrap gap-2">
                <button 
                  class="category-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all border-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white border-orange-600 shadow-md"
                  data-category="all">
                  ğŸ  ì „ì²´ (${tastingRestaurants.length})
                </button>
                <button 
                  class="category-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all border-2 border-gray-300 bg-white text-gray-700 hover:border-orange-400 hover:bg-orange-50"
                  data-category="í•œì‹">
                  ğŸš í•œì‹ (${
                    tastingRestaurants.filter(
                      (r) => r.restaurantCategory === "í•œì‹"
                    ).length
                  })
                </button>
                <button 
                  class="category-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all border-2 border-gray-300 bg-white text-gray-700 hover:border-orange-400 hover:bg-orange-50"
                  data-category="ì¼ì‹">
                  ğŸ£ ì¼ì‹ (${
                    tastingRestaurants.filter(
                      (r) => r.restaurantCategory === "ì¼ì‹"
                    ).length
                  })
                </button>
                <button 
                  class="category-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all border-2 border-gray-300 bg-white text-gray-700 hover:border-orange-400 hover:bg-orange-50"
                  data-category="ì¤‘ì‹">
                  ğŸ¥Ÿ ì¤‘ì‹ (${
                    tastingRestaurants.filter(
                      (r) => r.restaurantCategory === "ì¤‘ì‹"
                    ).length
                  })
                </button>
                <button 
                  class="category-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all border-2 border-gray-300 bg-white text-gray-700 hover:border-orange-400 hover:bg-orange-50"
                  data-category="ì–‘ì‹">
                  ğŸ ì–‘ì‹ (${
                    tastingRestaurants.filter(
                      (r) => r.restaurantCategory === "ì–‘ì‹"
                    ).length
                  })
                </button>
                <button 
                  class="category-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all border-2 border-gray-300 bg-white text-gray-700 hover:border-orange-400 hover:bg-orange-50"
                  data-category="ë””ì €íŠ¸">
                  ğŸ° ë””ì €íŠ¸ (${
                    tastingRestaurants.filter(
                      (r) => r.restaurantCategory === "ë””ì €íŠ¸"
                    ).length
                  })
                </button>
                <button 
                  class="category-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all border-2 border-gray-300 bg-white text-gray-700 hover:border-orange-400 hover:bg-orange-50"
                  data-category="ê¸°íƒ€">
                  ğŸ½ï¸ ê¸°íƒ€ (${
                    tastingRestaurants.filter(
                      (r) =>
                        !r.restaurantCategory || r.restaurantCategory === "ê¸°íƒ€"
                    ).length
                  })
                </button>
              </div>
            </div>
            
            <!-- ê²€ìƒ‰ì°½ -->
            <div class="mb-4">
              <div class="relative">
                <input 
                  type="text" 
                  id="restaurant-search-input"
                  placeholder="ì‹ë‹¹ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰... (ì˜ˆ: ì˜ë“±ë™ê³¨ëª©ê¸¸)"
                  class="w-full px-4 py-3 pl-12 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-400 transition-colors text-gray-900 placeholder-gray-400"
                />
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <button 
                  id="clear-search-btn"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors hidden"
                  title="ê²€ìƒ‰ ì´ˆê¸°í™”">
                  <i class="fas fa-times-circle"></i>
                </button>
              </div>
              <div id="search-result-count" class="mt-2 text-sm text-gray-600"></div>
            </div>
            `
                : ""
            }
            
            <!-- ë¯¸ì‹íšŒ ì‹ë‹¹ ëª©ë¡ -->
            <div id="restaurant-list-container">
              ${
                tastingRestaurants.length > 0
                  ? `<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="restaurant-cards">${tastingRestaurants
                      .map(createRestaurantCard)
                      .join("")}</div>`
                  : `<div class="text-center py-12 text-gray-400">
                      <i class="fas fa-utensils text-4xl mb-3"></i>
                      <p>ì•„ì§ ì§„í–‰ëœ ë¯¸ì‹íšŒê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>`
              }
            </div>
          </div>
        `;

        // ê²€ìƒ‰ ë° í•„í„° ê¸°ëŠ¥
        const searchInput = document.getElementById("restaurant-search-input");
        const clearSearchBtn = document.getElementById("clear-search-btn");
        const searchResultCount = document.getElementById(
          "search-result-count"
        );
        const restaurantCardsContainer =
          document.getElementById("restaurant-cards");
        const categoryFilterBtns = document.querySelectorAll(
          ".category-filter-btn"
        );

        let currentCategory = "all"; // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬

        if (searchInput && tastingRestaurants.length > 0) {
          const performSearch = () => {
            const searchTerm = searchInput.value.trim().toLowerCase();

            // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™” ë²„íŠ¼ í‘œì‹œ
            if (searchTerm) {
              clearSearchBtn.classList.remove("hidden");
            } else {
              clearSearchBtn.classList.add("hidden");
            }

            // ì¹´í…Œê³ ë¦¬ í•„í„°ë§
            let filtered = tastingRestaurants;
            if (currentCategory !== "all") {
              filtered = filtered.filter((r) => {
                if (currentCategory === "ê¸°íƒ€") {
                  return (
                    !r.restaurantCategory || r.restaurantCategory === "ê¸°íƒ€"
                  );
                }
                return r.restaurantCategory === currentCategory;
              });
            }

            // ê²€ìƒ‰ í•„í„°ë§
            const filteredRestaurants = searchTerm
              ? filtered.filter((r) =>
                  r.restaurantName.toLowerCase().includes(searchTerm)
                )
              : filtered;

            // ê²€ìƒ‰ ê²°ê³¼ ì¹´ìš´íŠ¸ í‘œì‹œ
            if (searchTerm) {
              searchResultCount.innerHTML = `
                <i class="fas fa-search mr-1"></i>
                ê²€ìƒ‰ ê²°ê³¼: <span class="font-bold text-orange-600">${
                  filteredRestaurants.length
                }</span>ê°œ ì‹ë‹¹
                ${
                  filteredRestaurants.length === 0
                    ? '<span class="text-red-500 ml-2">(ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤)</span>'
                    : ""
                }
              `;
            } else {
              searchResultCount.innerHTML = "";
            }

            // ê²°ê³¼ ë Œë”ë§
            if (filteredRestaurants.length > 0) {
              restaurantCardsContainer.innerHTML = filteredRestaurants
                .map(createRestaurantCard)
                .join("");
            } else if (searchTerm) {
              restaurantCardsContainer.innerHTML = `
                <div class="col-span-2 text-center py-12 text-gray-400">
                  <i class="fas fa-search text-4xl mb-3"></i>
                  <p class="text-lg font-semibold mb-2">"${saf(
                    searchTerm
                  )}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                  <p class="text-sm">ë‹¤ë¥¸ ì‹ë‹¹ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
                </div>
              `;
            } else if (currentCategory !== "all") {
              // ì¹´í…Œê³ ë¦¬ë§Œ ì„ íƒë˜ê³  ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•Œ ë¹ˆ ê²°ê³¼ í‘œì‹œ
              const categoryName =
                currentCategory === "í•œì‹"
                  ? "ğŸš í•œì‹"
                  : currentCategory === "ì¼ì‹"
                  ? "ğŸ£ ì¼ì‹"
                  : currentCategory === "ì¤‘ì‹"
                  ? "ğŸ¥Ÿ ì¤‘ì‹"
                  : currentCategory === "ì–‘ì‹"
                  ? "ğŸ ì–‘ì‹"
                  : currentCategory === "ë””ì €íŠ¸"
                  ? "ğŸ° ë””ì €íŠ¸"
                  : "ğŸ½ï¸ ê¸°íƒ€";
              restaurantCardsContainer.innerHTML = `
                <div class="col-span-2 text-center py-12 text-gray-400">
                  <i class="fas fa-utensils text-4xl mb-3"></i>
                  <p class="text-lg font-semibold mb-2">${categoryName} ì¹´í…Œê³ ë¦¬ì— ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤</p>
                  <p class="text-sm">ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”</p>
                </div>
              `;
            } else {
              // ê¸°ë³¸ ìƒíƒœ (ì „ì²´ í‘œì‹œ)
              restaurantCardsContainer.innerHTML = filteredRestaurants
                .map(createRestaurantCard)
                .join("");
            }
          };

          // ì‹¤ì‹œê°„ ê²€ìƒ‰
          searchInput.addEventListener("input", performSearch);

          // ê²€ìƒ‰ ì´ˆê¸°í™” ë²„íŠ¼
          clearSearchBtn.addEventListener("click", () => {
            searchInput.value = "";
            performSearch();
            searchInput.focus();
          });

          // Enter í‚¤ë¡œ ê²€ìƒ‰
          searchInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              performSearch();
            }
          });

          // ì¹´í…Œê³ ë¦¬ í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
          categoryFilterBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
              const category = btn.dataset.category;
              currentCategory = category;

              // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
              categoryFilterBtns.forEach((b) => {
                b.classList.remove(
                  "bg-gradient-to-r",
                  "from-orange-500",
                  "to-orange-600",
                  "text-white",
                  "border-orange-600",
                  "shadow-md"
                );
                b.classList.add("border-gray-300", "bg-white", "text-gray-700");
              });

              btn.classList.remove(
                "border-gray-300",
                "bg-white",
                "text-gray-700"
              );
              btn.classList.add(
                "bg-gradient-to-r",
                "from-orange-500",
                "to-orange-600",
                "text-white",
                "border-orange-600",
                "shadow-md"
              );

              // ê²€ìƒ‰ ì¬ì‹¤í–‰
              performSearch();
            });
          });
        }

        // ê´€ë¦¬ì ì „ìš©: ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (isAdmin) {
          c.addEventListener("click", async (e) => {
            const deleteReviewBtn = e.target.closest(
              "[data-action='delete-review']"
            );
            const deleteRestaurantBtn = e.target.closest(
              "[data-action='delete-restaurant']"
            );

            // í›„ê¸° ì‚­ì œ
            if (deleteReviewBtn) {
              const eventId = deleteReviewBtn.dataset.eventId;
              const studentId = deleteReviewBtn.dataset.studentId;

              if (
                !confirm(
                  "ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ í›„ê¸°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                )
              )
                return;

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(db, async (transaction) => {
                  const eventDoc = await transaction.get(eventRef);
                  if (!eventDoc.exists())
                    throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                  const eventData = eventDoc.data();
                  const reviews = eventData.reviews || [];

                  // í•´ë‹¹ studentIdì˜ ë¦¬ë·° ì œê±°
                  const updatedReviews = reviews.filter(
                    (r) => r.studentId !== studentId
                  );

                  transaction.update(eventRef, { reviews: updatedReviews });
                });

                showAlert("âœ…", "í›„ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderRoadmapTab(isAdmin); // ë‹¤ì‹œ ë Œë”ë§
              } catch (error) {
                console.error("í›„ê¸° ì‚­ì œ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "í›„ê¸° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            }

            // ì‹ë‹¹ ì‚­ì œ
            if (deleteRestaurantBtn) {
              const eventId = deleteRestaurantBtn.dataset.eventId;
              const restaurantName = deleteRestaurantBtn.dataset.restaurantName;

              if (
                !confirm(
                  `"${restaurantName}" ì‹ë‹¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‹ë‹¹ì˜ ì˜ˆì•½ ì •ë³´ì™€ ê´€ë ¨ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
                )
              )
                return;

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(db, async (transaction) => {
                  const eventDoc = await transaction.get(eventRef);
                  if (!eventDoc.exists())
                    throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                  const eventData = eventDoc.data();
                  const restaurants = eventData.restaurants || [];

                  // í•´ë‹¹ ì‹ë‹¹ ì œê±°
                  const updatedRestaurants = restaurants.filter(
                    (r) => r.name !== restaurantName
                  );

                  transaction.update(eventRef, {
                    restaurants: updatedRestaurants,
                  });
                });

                showAlert("âœ…", "ì‹ë‹¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderRoadmapTab(isAdmin); // ë‹¤ì‹œ ë Œë”ë§
              } catch (error) {
                console.error("ì‹ë‹¹ ì‚­ì œ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "ì‹ë‹¹ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            }
          });

          // ì¹´í…Œê³ ë¦¬ ë“œë¡­ë‹¤ìš´ change ì´ë²¤íŠ¸
          c.addEventListener("change", async (e) => {
            const updateCategorySelect = e.target.closest(
              "[data-action='update-category']"
            );
            if (updateCategorySelect) {
              const eventId = updateCategorySelect.dataset.eventId;
              const restaurantName =
                updateCategorySelect.dataset.restaurantName;
              const newCategory = updateCategorySelect.value;

              if (
                !confirm(
                  `"${restaurantName}" ì‹ë‹¹ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ "${newCategory}"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
                )
              ) {
                // ì·¨ì†Œ ì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¼
                const event = eventsData.find((e) => e.id === eventId);
                if (event && event.restaurants) {
                  const restaurant = event.restaurants.find(
                    (r) => r.name === restaurantName
                  );
                  if (restaurant) {
                    updateCategorySelect.value = restaurant.category || "ê¸°íƒ€";
                  }
                }
                return;
              }

              try {
                const eventRef = doc(db, "events", eventId);
                await runTransaction(db, async (transaction) => {
                  const eventDoc = await transaction.get(eventRef);
                  if (!eventDoc.exists())
                    throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                  const eventData = eventDoc.data();
                  const restaurants = eventData.restaurants || [];

                  // í•´ë‹¹ ì‹ë‹¹ì˜ ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸
                  const updatedRestaurants = restaurants.map((r) => {
                    if (r.name === restaurantName) {
                      return { ...r, category: newCategory };
                    }
                    return r;
                  });

                  transaction.update(eventRef, {
                    restaurants: updatedRestaurants,
                  });
                });

                showAlert("âœ…", "ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderRoadmapTab(isAdmin); // ë‹¤ì‹œ ë Œë”ë§
              } catch (error) {
                console.error("ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì˜¤ë¥˜:", error);
                showAlert("ğŸ˜¥", "ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              }
            }
          });
        }

        // í›„ê¸° ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        c.addEventListener("click", (e) => {
          const toggleBtn = e.target.closest("[data-action='toggle-reviews']");
          if (toggleBtn) {
            const eventId = toggleBtn.dataset.eventId;
            const restaurantName = toggleBtn.dataset.restaurantName;

            // data ì†ì„±ìœ¼ë¡œ ì§ì ‘ ì°¾ê¸°
            const reviewList = c.querySelector(
              `.review-list[data-event-id="${eventId}"][data-restaurant-name="${restaurantName}"]`
            );

            if (!reviewList) return;

            const isShowingAll = reviewList.dataset.showAll === "true";

            // í•´ë‹¹ ì‹ë‹¹ì˜ ëª¨ë“  í›„ê¸° ê°€ì ¸ì˜¤ê¸°
            const restaurant = tastingRestaurants.find(
              (r) =>
                r.eventId === eventId && r.restaurantName === restaurantName
            );

            if (!restaurant) return;

            const allReviews = restaurant.reviews.filter(
              (r) => r.comment && r.comment.trim()
            );

            if (isShowingAll) {
              // ì ‘ê¸° - 3ê°œë§Œ ë³´ì—¬ì£¼ê¸°
              reviewList.innerHTML = allReviews
                .slice(0, 3)
                .map(
                  (r) => `
                  <div class="bg-white rounded-lg p-3 border border-orange-100 shadow-sm relative review-item">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-semibold text-gray-700">
                        <i class="fas fa-user-circle mr-1 text-orange-500"></i>
                        ìµëª…
                      </span>
                      <div class="flex items-center gap-2">
                        <div class="flex items-center gap-0.5">
                          ${renderStars(r.rating || 0)}
                        </div>
                        ${
                          isAdmin
                            ? `
                          <button 
                            class="text-red-500 hover:text-red-700 transition-colors"
                            data-action="delete-review"
                            data-event-id="${restaurant.eventId}"
                            data-student-id="${r.studentId}"
                            title="í›„ê¸° ì‚­ì œ">
                            <i class="fas fa-trash text-xs"></i>
                          </button>
                        `
                            : ""
                        }
                      </div>
                    </div>
                    <p class="text-sm text-gray-600 whitespace-pre-wrap">${saf(
                      r.comment
                    )}</p>
                  </div>
                `
                )
                .join("");
              reviewList.dataset.showAll = "false";
              toggleBtn.innerHTML = `<i class="fas fa-chevron-down mr-1"></i>ì™¸ ${
                allReviews.length - 3
              }ê°œ í›„ê¸° ë” ë³´ê¸°`;
            } else {
              // í¼ì¹˜ê¸° - ëª¨ë“  í›„ê¸° ë³´ì—¬ì£¼ê¸°
              reviewList.innerHTML = allReviews
                .map(
                  (r) => `
                  <div class="bg-white rounded-lg p-3 border border-orange-100 shadow-sm relative review-item">
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-semibold text-gray-700">
                        <i class="fas fa-user-circle mr-1 text-orange-500"></i>
                        ìµëª…
                      </span>
                      <div class="flex items-center gap-2">
                        <div class="flex items-center gap-0.5">
                          ${renderStars(r.rating || 0)}
                        </div>
                        ${
                          isAdmin
                            ? `
                          <button 
                            class="text-red-500 hover:text-red-700 transition-colors"
                            data-action="delete-review"
                            data-event-id="${restaurant.eventId}"
                            data-student-id="${r.studentId}"
                            title="í›„ê¸° ì‚­ì œ">
                            <i class="fas fa-trash text-xs"></i>
                          </button>
                        `
                            : ""
                        }
                      </div>
                    </div>
                    <p class="text-sm text-gray-600 whitespace-pre-wrap">${saf(
                      r.comment
                    )}</p>
                  </div>
                `
                )
                .join("");
              reviewList.dataset.showAll = "true";
              toggleBtn.innerHTML = `<i class="fas fa-chevron-up mr-1"></i>í›„ê¸° ì ‘ê¸°`;
            }
          }
        });
      }

      /* ===== ëª…ì˜ˆì˜ ì „ë‹¹ ê´€ë¦¬ì ===== */
      function renderHOFAdmin(container) {
        const cards = (historyData || [])
          .map(
            (h) => `
          <div class="border rounded p-3 bg-white flex items-start gap-3">
            ${
              h.imageUrl
                ? `<img src="${saf(
                    h.imageUrl
                  )}" class="w-24 h-24 object-cover rounded" onerror="this.style.display='none'">`
                : ""
            }
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <div class="truncate font-semibold">${saf(
                  h.title || "(ì œëª© ì—†ìŒ)"
                )}</div>
                <div class="text-sm text-gray-500">${
                  h.date ? saf(h.date) : "-"
                }</div>
              </div>
              ${
                h.subtitle
                  ? `<div class="text-sm text-orange-700">${saf(
                      h.subtitle
                    )}</div>`
                  : ""
              }
              ${
                h.description
                  ? `<div class="text-sm text-gray-700 mt-1 line-clamp-2">${saf(
                      h.description
                    )}</div>`
                  : ""
              }
              <div class="mt-2 space-x-2">
                <button class="text-blue-600 text-sm" data-act="edit-hof" data-id="${
                  h.id
                }"><i class="fas fa-pen"></i> ìˆ˜ì •</button>
                <button class="text-red-600 text-sm" data-act="del-hof" data-id="${
                  h.id
                }"><i class="fas fa-trash"></i> ì‚­ì œ</button>
              </div>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = `
          <div class="grid grid-cols-1 gap-4">
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">ëª…ì˜ˆì˜ ì „ë‹¹ ë“±ë¡</h3>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
                  <input id="hof-title" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                  <input id="hof-date" type="date" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë¶€ì œ (ì„ íƒ)</label>
                  <input id="hof-subtitle" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ë¶€ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
                  <input id="hof-image" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                  <textarea id="hof-desc" rows="4" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
              </div>
              <div class="mt-2 space-x-2">
                <button id="hof-add" class="px-4 py-2 bg-orange-500 text-white rounded">ì¶”ê°€</button>
                <button id="hof-reset" class="px-3 py-2 bg-gray-200 rounded">ë¦¬ì…‹</button>
              </div>
            </div>

            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">ë“±ë¡ëœ í•­ëª©</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${
                cards || `<div class="text-gray-400">í•­ëª© ì—†ìŒ</div>`
              }</div>
            </div>
          </div>
        `;

        container.onclick = async (e) => {
          const b = e.target.closest("button[data-act]");
          if (!b) return;
          const id = b.dataset.id;
          if (b.dataset.act === "del-hof") {
            if (!confirm("ì‚­ì œí•˜ì‹œê² ì–´ìš”?")) return;
            try {
              await deleteDoc(doc(db, "history", id));
              showAlert("ğŸ—‘ï¸", "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
              console.warn(err);
              showAlert("ğŸ˜¥", "ì‚­ì œ ì‹¤íŒ¨");
            }
          }
          if (b.dataset.act === "edit-hof") {
            const item = historyData.find((x) => x.id === id) || {};
            el.blockEditorTitle.textContent = "ëª…ì˜ˆì˜ ì „ë‹¹ ìˆ˜ì •";
            el.blockEditorBody.innerHTML = `
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
                  <input id="eh-title" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="${saf(
                    item.title || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                  <input id="eh-date" type="date" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" value="${saf(
                    item.date || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ë¶€ì œ</label>
                  <input id="eh-subtitle" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ë¶€ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="${saf(
                    item.subtitle || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¯¸ì§€ URL</label>
                  <input id="eh-image" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”" value="${saf(
                    item.imageUrl || ""
                  )}">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                  <textarea id="eh-desc" rows="4" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">${saf(
                    item.description || ""
                  )}</textarea>
                </div>
              </div>`;
            el.blockEditor.classList.remove("hidden");
            el.blockEditorSave.onclick = async () => {
              try {
                await updateDoc(doc(db, "history", id), {
                  title: document.getElementById("eh-title").value.trim(),
                  date: document.getElementById("eh-date").value,
                  subtitle: document.getElementById("eh-subtitle").value.trim(),
                  imageUrl: document.getElementById("eh-image").value.trim(),
                  description: document.getElementById("eh-desc").value.trim(),
                });
                el.blockEditor.classList.add("hidden");
                showAlert("âœ…", "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
              } catch (e) {
                console.warn(e);
                showAlert("ğŸ˜¥", "ìˆ˜ì • ì‹¤íŒ¨");
              }
            };
            el.blockEditorCancel.onclick = () =>
              el.blockEditor.classList.add("hidden");
          }
        };

        container.querySelector("#hof-add").onclick = async () => {
          const title = container.querySelector("#hof-title").value.trim();
          const date = container.querySelector("#hof-date").value;
          const subtitle = container
            .querySelector("#hof-subtitle")
            .value.trim();
          const imageUrl = container.querySelector("#hof-image").value.trim();
          const description = container.querySelector("#hof-desc").value.trim();
          if (!title || !date)
            return showAlert("ğŸ˜¥", "ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          try {
            await addDoc(collection(db, "history"), {
              title,
              date,
              subtitle,
              imageUrl,
              description,
              createdAt: serverTimestamp(),
            });
            [
              "hof-title",
              "hof-date",
              "hof-subtitle",
              "hof-image",
              "hof-desc",
            ].forEach((id) => (container.querySelector("#" + id).value = ""));
            showAlert("ğŸ‰", "ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ë“±ë¡ ì‹¤íŒ¨");
          }
        };
        container.querySelector("#hof-reset").onclick = () => {
          [
            "hof-title",
            "hof-date",
            "hof-subtitle",
            "hof-image",
            "hof-desc",
          ].forEach((id) => (container.querySelector("#" + id).value = ""));
        };
      }

      /* ===== ì‹œìŠ¤í…œ ì„¤ì • ê´€ë¦¬ì ===== */
      function renderSystemAdmin(container) {
        const signup = signupSettings || { open: false, start: "", end: "" };
        const dues = duesSettings || {
          enabled: false,
          bank: "",
          number: "",
          holder: "",
          amount: "",
          note: "",
        };
        const admins = adminList || [];

        container.innerHTML = `
          <div class="grid grid-cols-1 gap-4">
            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">íšŒì›ê°€ì… ê¸°ê°„</h3>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                <select id="set-signup-open" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="auto" ${
                    signup.open ? "" : "selected"
                  }>ê¸°ê°„ ê¸°ë°˜</option>
                  <option value="force" ${
                    signup.open ? "selected" : ""
                  }>í•­ìƒ ì—´ê¸°</option>
                </select>
                <input id="set-signup-start" type="date" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  value="${saf(
                  signup.start || ""
                )}">
                <input id="set-signup-end" type="date" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  value="${saf(
                  signup.end || ""
                )}">
                <button id="set-signup-save" class="px-3 py-2 bg-orange-500 text-white rounded">ì €ì¥</button>
              </div>
              <p class="text-xs text-gray-500 mt-1">* "í•­ìƒ ì—´ê¸°" ì„ íƒ ì‹œ ê¸°ê°„ê³¼ ë¬´ê´€í•˜ê²Œ íšŒì›ê°€ì…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">íšŒë¹„/ê³„ì¢Œ ì„¤ì •</h3>
              <div class="grid grid-cols-1 md:grid-cols-6 gap-2">
                <select id="set-dues-enabled" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="false" ${
                    dues.enabled ? "" : "selected"
                  }>ì‚¬ìš© ì•ˆ í•¨</option>
                  <option value="true" ${
                    dues.enabled ? "selected" : ""
                  }>ì‚¬ìš©</option>
                </select>
                <input id="set-dues-bank"   class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="ì€í–‰" value="${saf(
                  dues.bank || ""
                )}">
                <input id="set-dues-number" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="ê³„ì¢Œë²ˆí˜¸" value="${saf(
                  dues.number || ""
                )}">
                <input id="set-dues-holder" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="ì˜ˆê¸ˆì£¼" value="${saf(
                  dues.holder || ""
                )}">
                <input id="set-dues-amount" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  placeholder="ê¸ˆì•¡(ìˆ«ì)" value="${saf(
                  dues.amount || ""
                )}">
                <input id="set-dues-note"   class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  md:col-span-2" placeholder="ì•ˆë‚´ ë¬¸êµ¬" value="${saf(
                  dues.note || ""
                )}">
                <button id="set-dues-save" class="px-3 py-2 bg-orange-500 text-white rounded md:col-span-1">ì €ì¥</button>
              </div>
            </div>

            <div class="section">
              <h3 class="text-xl font-bold text-gray-800 mb-2">ê´€ë¦¬ì</h3>
              <div class="flex items-center gap-2 mb-2">
                <input id="admin-add-id" class="px-3 py-2 border rounded bg-white  text-gray-900  border-gray-300  flex-1" placeholder="í•™ë²ˆ ì…ë ¥">
                <button id="admin-add-btn" class="px-3 py-2 bg-gray-800 text-white rounded">ì¶”ê°€</button>
              </div>
              <div class="border rounded divide-y bg-white">
                ${
                  (admins || []).length
                    ? admins
                        .map(
                          (id) => `
                  <div class="flex items-center justify-between px-3 py-2">
                    <div class="font-mono">${saf(id)}</div>
                    <button class="text-red-600 text-sm" data-act="admin-remove" data-id="${saf(
                      id
                    )}"><i class="fas fa-trash"></i> ì œê±°</button>
                  </div>
                `
                        )
                        .join("")
                    : `<div class="px-3 py-2 text-gray-400">ë“±ë¡ëœ ê´€ë¦¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`
                }
              </div>
              <p class="text-xs text-gray-500 mt-2">* ë¹„ìƒì‹œ: ë¡œê·¸ì¸ í™”ë©´ì—ì„œ í•™ë²ˆì— <b>${saf(
                MASTER_CODE
              )}</b> ì…ë ¥ í›„ ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.</p>
            </div>
          </div>
        `;

        // ì €ì¥ í•¸ë“¤ëŸ¬
        container.querySelector("#set-signup-save").onclick = async () => {
          const mode = container.querySelector("#set-signup-open").value;
          const start = container.querySelector("#set-signup-start").value;
          const end = container.querySelector("#set-signup-end").value;
          const open = mode === "force";
          try {
            await setDoc(
              doc(db, "settings", "signup"),
              { open, start, end },
              { merge: true }
            );
            showAlert("âœ…", "íšŒì›ê°€ì… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ì €ì¥ ì‹¤íŒ¨");
          }
        };

        container.querySelector("#set-dues-save").onclick = async () => {
          const enabled =
            container.querySelector("#set-dues-enabled").value === "true";
          const bank = container.querySelector("#set-dues-bank").value.trim();
          const number = container
            .querySelector("#set-dues-number")
            .value.trim();
          const holder = container
            .querySelector("#set-dues-holder")
            .value.trim();
          const amount = container
            .querySelector("#set-dues-amount")
            .value.trim();
          const note = container.querySelector("#set-dues-note").value.trim();
          try {
            await setDoc(
              doc(db, "settings", "dues"),
              { enabled, bank, number, holder, amount, note },
              { merge: true }
            );
            showAlert("âœ…", "íšŒë¹„/ê³„ì¢Œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ì €ì¥ ì‹¤íŒ¨");
          }
        };

        // ê´€ë¦¬ì ì¶”ê°€/ì œê±°
        container.querySelector("#admin-add-btn").onclick = async () => {
          const sid = container.querySelector("#admin-add-id").value.trim();
          if (!sid) return showAlert("ğŸ˜¥", "í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
          try {
            await runTransaction(db, async (tx) => {
              const ref = doc(db, "admins", "list");
              const snap = await tx.get(ref);
              const arr = snap.exists() ? snap.data().studentIds || [] : [];
              if (!arr.includes(sid)) arr.push(sid);
              tx.set(ref, { studentIds: arr }, { merge: true });
            });
            container.querySelector("#admin-add-id").value = "";
            showAlert("âœ…", "ê´€ë¦¬ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ì¶”ê°€ ì‹¤íŒ¨");
          }
        };
        container.onclick = async (e) => {
          const b = e.target.closest("button[data-act='admin-remove']");
          if (!b) return;
          const sid = b.dataset.id;
          if (!confirm(`ê´€ë¦¬ìì—ì„œ ì œê±°í• ê¹Œìš”?\n${sid}`)) return;
          try {
            await runTransaction(db, async (tx) => {
              const ref = doc(db, "admins", "list");
              const snap = await tx.get(ref);
              const arr = snap.exists() ? snap.data().studentIds || [] : [];
              const next = arr.filter((x) => x !== sid);
              tx.set(ref, { studentIds: next }, { merge: true });
            });
            showAlert("âœ…", "ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } catch (e) {
            console.warn(e);
            showAlert("ğŸ˜¥", "ì œê±° ì‹¤íŒ¨");
          }
        };
      }

      /* ===== ë¹„ìƒ ê´€ë¦¬ì ì„ëª… ===== */
      async function addEmergencyAdmin() {
        const sid = document.getElementById("new-admin-id").value.trim();
        if (!sid) return showAlert("ğŸ˜¥", "í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.");
        try {
          await runTransaction(db, async (tx) => {
            const ref = doc(db, "admins", "list");
            const snap = await tx.get(ref);
            const arr = snap.exists() ? snap.data().studentIds || [] : [];
            if (!arr.includes(sid)) arr.push(sid);
            tx.set(ref, { studentIds: arr }, { merge: true });
          });
          closeEmergencyModal();
          showAlert("âœ…", `ê´€ë¦¬ìì— ${saf(sid)}ë¥¼(ì„) ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
        } catch (e) {
          console.warn(e);
          showAlert("ğŸ˜¥", "ê´€ë¦¬ì ì„ëª… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      /* ===== ì „ì—­: ì—ë””í„° ëª¨ë‹¬ ë°– í´ë¦­ ì‹œ ë‹«í˜ ë°©ì§€(ëª…ì‹œ ë²„íŠ¼ë§Œ) ===== */
      // ì´ë¯¸ ê° ì‚¬ìš©ì²˜ì—ì„œ cancelê³¼ save í•¸ë“¤ëŸ¬ë¥¼ ì§€ì •í•¨

      // ë¡œë”© ì§„í–‰ë¥  ê´€ë¦¬
      let loadingProgress = 0;
      const totalLoadingSteps = 2; // ì´ ë¡œë”© ë‹¨ê³„ ìˆ˜ (ê°„ì†Œí™”)

      function updateLoadingProgress(step, text) {
        // stepì´ 1ì´ë©´ ë°ì´í„° ë¡œë”© ì¤‘ (90%ê¹Œì§€), stepì´ 2ë©´ ì™„ë£Œ (100%)
        if (step === 1) {
          // ë°ì´í„° ë¡œë”© ì¤‘ì¼ ë•ŒëŠ” 90%ê¹Œì§€ë§Œ
          loadingProgress = Math.min(90, 90);
        } else if (step === 2) {
          // ì™„ë£Œ ì‹œì—ëŠ” 100%
          loadingProgress = 100;
        } else if (step === 3) {
          // 70% ì´ìƒ
          loadingProgress = 75;
        } else if (step === 4) {
          // 90% ì´ìƒ
          loadingProgress = 90;
        }

        const progressBar = document.getElementById("progress-bar");
        const loadingText = document.getElementById("loading-text");

        if (progressBar) {
          // ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
          progressBar.style.transition =
            "width 0.8s cubic-bezier(0.4, 0, 0.2, 1)";
          progressBar.style.width = `${loadingProgress}%`;
          if (loadingProgress >= 100) {
            progressBar.classList.remove("loading");
          }
        }

        if (loadingText && text) {
          // 70% ì´ìƒì¼ ë•ŒëŠ” "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!" ë©”ì‹œì§€ë¡œ ë³€ê²½
          let displayText = text;
          // ëª¨ë“  ë¡œë”© ë©”ì‹œì§€ë¥¼ "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!"ë¡œ í†µì¼
          if (text && text.includes("ë§›ìˆëŠ” ì‹ì‚¬ë¥¼ ìœ„í•´")) {
            displayText = "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!";
          }

          // í…ìŠ¤íŠ¸ í˜ì´ë“œ íš¨ê³¼
          if (
            loadingText.style.opacity === "0" ||
            loadingText.style.opacity === ""
          ) {
            loadingText.style.opacity = "1";
            loadingText.style.transition = "opacity 0.3s ease";
          }
          loadingText.textContent = displayText;
        }

        console.log(`ë¡œë”© ì§„í–‰ë¥ : ${loadingProgress}% - ${text || ""}`);
      }

      // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
      function hideLoadingScreen() {
        const loadingScreen = document.getElementById("loading-screen");
        if (loadingScreen) {
          loadingScreen.classList.add("hidden");
        }
      }

      // ===================== ì´ˆê¸°í™” =====================
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", function () {
        // 1ë‹¨ê³„: ì´ˆê¸° ë Œë”ë§
        updateLoadingProgress(1, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
        applyHomeLayoutOrder();
        renderRoadmap();
        renderBlocks();

        // í˜ì´ì§€ ë¡œë“œ í›„ 2ì´ˆ ë’¤ì— ì»¨í…ì¸  ìƒíƒœ ì¬í™•ì¸ (ë” ë¹ ë¥¸ ê²€ì‚¬)
        setTimeout(() => {
          checkContentLoaded();
        }, 2000);

        // ì˜ˆì•½ëœ ê¸€ë“¤ í™•ì¸
        setTimeout(() => {
          checkScheduledPosts();
        }, 2000); // 2ì´ˆ í›„ ì‹¤í–‰ (ë¡œê·¸ì¸ ì™„ë£Œ í›„)

        // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì¼ì • ë‹¤ì‹œ ë Œë”ë§
        let resizeTimeout;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (typeof renderHorizontalRoadmap === "function") {
              renderHorizontalRoadmap();
            }
          }, 250);
        });
        updateSignupUI();

        // 2ë‹¨ê³„: ì‚¬ìš©ì ì •ë³´ í™•ì¸
        updateLoadingProgress(2, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
        const savedUser = localStorage.getItem("foodieUser");
        if (savedUser) {
          try {
            currentUser = JSON.parse(savedUser);
            // 3ë‹¨ê³„: ë°ì´í„° ë¡œë”©
            updateLoadingProgress(3, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
            setTimeout(() => {
              renderAll();
            }, 1200); // ë¡œë“œë§µ ë¡œë”© ì‹œê°„ ê³ ë ¤í•˜ì—¬ ì—°ì¥
          } catch (e) {
            console.warn("ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:", e);
            updateLoadingProgress(3, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
            setTimeout(() => {
              renderAll();
            }, 1200); // ë¡œë“œë§µ ë¡œë”© ì‹œê°„ ê³ ë ¤í•˜ì—¬ ì—°ì¥
          }
        } else {
          // ìë™ ë¡œê·¸ì¸ ì‹œë„
          updateLoadingProgress(3, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
          attemptAutoLogin().then((success) => {
            updateLoadingProgress(4, "ì˜ ë¨¹ê² ìŠµë‹ˆë‹¤!");
            setTimeout(() => {
              renderAll();
            }, 1200); // ë¡œë“œë§µ ë¡œë”© ì‹œê°„ ê³ ë ¤í•˜ì—¬ ì—°ì¥
          });
        }
      });

      // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ë Œë”ë§ ë³´ì¥
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden && currentUser) {
          setTimeout(() => {
            renderAll();
          }, 100);
        }
      });

      // ìœˆë„ìš° í¬ì»¤ìŠ¤ ì‹œ ë Œë”ë§ ë³´ì¥
      window.addEventListener("focus", () => {
        if (currentUser) {
          setTimeout(() => {
            renderAll();
          }, 100);
        }
      });

      // ===================== ì´ë²¤íŠ¸ ëª¨ë‹¬ ê´€ë¦¬ =====================
      function openEventModal(mode = "create", eventId = null) {
        const modal = document.getElementById("event-modal");
        const title = document.getElementById("event-modal-title");
        const content = document.getElementById("event-modal-content");

        if (mode === "create") {
          title.textContent = "ì´ë²¤íŠ¸Â·ë¯¸ì‹íšŒ ìƒì„±";
          content.innerHTML = adminEventsPanelHTML();
          modal.classList.remove("hidden");
          bindAdminEventsPanel();
        } else if (mode === "edit" && eventId) {
          title.textContent = "ì´ë²¤íŠ¸Â·ë¯¸ì‹íšŒ ìˆ˜ì •";
          content.innerHTML = adminEventsPanelHTML();
          modal.classList.remove("hidden");
          bindAdminEventsPanel();
          // DOMì´ ë Œë”ë§ëœ í›„ í¼ ë¡œë“œ
          setTimeout(() => {
            loadEventToForm(eventId);
          }, 0);
        }
      }

      function closeEventModal() {
        const modal = document.getElementById("event-modal");
        modal.classList.add("hidden");
        resetEventForm();
      }

      // ì´ë²¤íŠ¸ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      document.addEventListener("click", (e) => {
        if (e.target.id === "create-event-btn") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          openEventModal("create");
        } else if (e.target.id === "auto-close-btn") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ìë™ ë§ˆê°ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          autoCloseExpiredEvents();
        } else if (
          e.target.id === "event-modal-close" ||
          e.target.closest("#event-modal-close")
        ) {
          closeEventModal();
        } else if (e.target.closest("#event-modal")) {
          // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
          if (e.target.id === "event-modal") {
            closeEventModal();
          }
        }
      });

      // ì´ë²¤íŠ¸ ì•¡ì…˜ í´ë¦­ í•¸ë“¤ëŸ¬
      document.addEventListener("click", (e) => {
        const actionButton = e.target.closest("[data-act]");
        if (!actionButton) return;

        const act = actionButton.dataset.act;
        const id = actionButton.dataset.id;
        const rid = actionButton.dataset.rid;

        onEventActionClick(act, id, rid);
      });

      function onEventActionClick(act, id, rid) {
        if (act === "reserve-general") return reserveGeneral(id);
        if (act === "cancel-general") return cancelGeneral(id);
        if (act === "cancel-wait-general") return cancelWaitGeneral(id);
        if (act === "reserve-tasting") return reserveTasting(id, rid);
        if (act === "cancel-tasting") return cancelTasting(id, rid);
        if (act === "cancel-wait-tasting") return cancelWaitTasting(id, rid);
        if (act === "admin-edit") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return openEventModal("edit", id);
        }
        if (act === "admin-close") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return closeEvent(id);
        }
        if (act === "admin-reopen") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return reopenEvent(id);
        }
        if (act === "admin-archive") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return archiveEvent(id);
        }
        if (act === "admin-unpost") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return unpostEvent(id);
        }
        if (act === "group-maker") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return openGroupMakerModal(id);
        }
        if (act === "admin-delete") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return deleteEvent(id);
        }
        if (act === "export-xlsx") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ ëª…ë‹¨ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return exportApplicantsXLSX(id);
        }
        if (act === "write-review") return openReviewModal(id);
        if (act === "admin-confirm-activity") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ í™œë™ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return confirmActivity(id);
        }
        if (act === "admin-cancel-activity") {
          if (!isFullAdmin()) {
            showAlert("ğŸ”’", "ê´€ë¦¬ìë§Œ í™œë™ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }
          return cancelActivity(id);
        }
      }

      // ì´ë²¤íŠ¸ ìˆœì„œ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("click", (e) => {
        if (e.target.closest('[data-act="move-event-up"]')) {
          const eventId = e.target.closest('[data-act="move-event-up"]').dataset
            .id;
          moveEventUp(eventId);
        }

        if (e.target.closest('[data-act="move-event-down"]')) {
          const eventId = e.target.closest('[data-act="move-event-down"]')
            .dataset.id;
          moveEventDown(eventId);
        }
      });

      // ì´ë²¤íŠ¸ ë°ì´í„°ë¥¼ í¼ì— ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
      function loadEventToForm(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) return;

        editingEventId = eventId;

        // null ì²´í¬ ì¶”ê°€
        const eventType = document.getElementById("event-type");
        const eventTitle = document.getElementById("event-title");
        const eventDatetime = document.getElementById("event-datetime");
        const eventDeadline = document.getElementById("event-deadline");
        const eventLimit = document.getElementById("event-limit");
        const eventStatus = document.getElementById("event-status");

        if (eventType) eventType.value = event.type || "tasting";
        if (eventTitle) eventTitle.value = event.title || "";
        if (eventDatetime) eventDatetime.value = event.datetime || "";
        if (eventDeadline) eventDeadline.value = event.deadline || "";
        if (eventLimit) eventLimit.value = event.limit || "";
        if (eventStatus) eventStatus.value = event.status || "open";

        // íšŒë¹„ ì •ë³´ ë¡œë“œ (MT/ì´íšŒì¸ ê²½ìš°)
        const p = event.payment || {};
        const payBank = document.getElementById("pay-bank");
        const payNumber = document.getElementById("pay-number");
        const payHolder = document.getElementById("pay-holder");
        const payNote = document.getElementById("pay-note");

        if (payBank) payBank.value = p.bank || "";
        if (payNumber) payNumber.value = p.number || "";
        if (payHolder) payHolder.value = p.holder || "";
        if (payNote) payNote.value = p.note || "";

        // ì‹ë‹¹ ì •ë³´ ë¡œë“œ
        const wrap = document.getElementById("event-restaurants-wrap");
        if (wrap) {
          if (event.type === "tasting" && event.restaurants) {
            wrap.innerHTML =
              event.restaurants
                .map((r) =>
                  restaurantFieldHTML(
                    r.name || "",
                    r.info || "",
                    r.capacity || "",
                    r.imageUrl || "",
                    r.id || "",
                    r.category || "ê¸°íƒ€"
                  )
                )
                .join("") || restaurantFieldHTML();
          } else {
            wrap.innerHTML = restaurantFieldHTML();
          }
        }

        onTypeChange(event.type || "tasting");
      }

      /* ===== í‰ê°€ ì‘ì„± ê¸°ëŠ¥ ===== */
      function openReviewModal(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
        if (!event) return;

        const existingReview = event.reviews?.find(
          (r) => r.studentId === currentUser.studentId
        );

        document.getElementById(
          "review-modal-title"
        ).textContent = `${event.title} í‰ê°€`;
        document.getElementById("review-modal-content").innerHTML = `
          <div class="space-y-4">
            <div class="text-sm text-gray-600">
              <p><strong>ì´ë²¤íŠ¸:</strong> ${saf(event.title)}</p>
              <p><strong>ì¼ì‹œ:</strong> ${new Date(
                event.datetime
              ).toLocaleDateString("ko-KR")}</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">í‰ì </label>
              <div class="flex gap-1 mb-2 items-center" id="rating-stars">
                ${Array.from({ length: 5 }, (_, i) => {
                  const rating = i + 1;
                  const currentRating = existingReview?.rating || 0;
                  const isSelected = rating <= currentRating;

                  return `<button type="button" class="star-rating-btn text-3xl transition-all hover:scale-110" data-rating="${rating}">
                    <i class="fas fa-star ${
                      isSelected ? "text-yellow-400" : "text-gray-300"
                    }"></i>
                  </button>`;
                }).join("")}
              </div>
              <p class="text-xs text-gray-500 text-center">
                1ì  ë‹¨ìœ„ë¡œ í‰ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë³„ì„ í´ë¦­í•˜ì„¸ìš”)
              </p>
              <div class="text-center mt-2">
                <span class="text-2xl font-bold text-orange-600" id="current-rating-display">${
                  existingReview?.rating || 0
                }</span>
                <span class="text-sm text-gray-600">ì </span>
              </div>
            </div>
            
            <div>
              <label for="review-comment" class="block text-sm font-medium text-gray-700 mb-2">í›„ê¸°</label>
              <textarea id="review-comment" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" 
                        placeholder="ì´ë²¤íŠ¸ì— ëŒ€í•œ ì†Œê°ì´ë‚˜ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”...">${
                          existingReview?.comment || ""
                        }</textarea>
            </div>
            
            <div class="flex gap-3 pt-4">
              <button type="button" id="save-review" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                <i class="fas fa-save mr-2"></i>
                ${existingReview ? "ìˆ˜ì •í•˜ê¸°" : "ì €ì¥í•˜ê¸°"}
              </button>
              <button type="button" id="cancel-review" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        `;

        // ë³„ì  í´ë¦­ ì´ë²¤íŠ¸ (0.5ì  ë‹¨ìœ„)
        let selectedRating = existingReview?.rating || 0;

        const updateStarDisplay = (rating) => {
          document.querySelectorAll(".star-rating-btn").forEach((btn) => {
            const btnRating = parseFloat(btn.dataset.rating);
            const star = btn.querySelector("i");

            // star ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (star) {
              if (btnRating <= rating) {
                star.classList.remove("text-gray-300");
                star.classList.add("text-yellow-400");
              } else {
                star.classList.remove("text-yellow-400");
                star.classList.add("text-gray-300");
              }
            }
          });

          // í˜„ì¬ ì ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
          const ratingDisplay = document.getElementById(
            "current-rating-display"
          );
          if (ratingDisplay) {
            ratingDisplay.textContent = rating;
          }
        };

        // ë³„ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll(".star-rating-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            selectedRating = parseFloat(btn.dataset.rating);
            updateStarDisplay(selectedRating);
          });
        });

        // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        document
          .getElementById("save-review")
          .addEventListener("click", async () => {
            const comment = document
              .getElementById("review-comment")
              .value.trim();
            if (selectedRating === 0) {
              showAlert("âš ï¸", "í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            try {
              await saveEventReview(eventId, selectedRating, comment);
              closeReviewModal();
              renderHistoryTab(isAdmin);
              showAlert("âœ…", "í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (error) {
              showAlert("ğŸ˜¥", "í‰ê°€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          });

        // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document
          .getElementById("cancel-review")
          .addEventListener("click", closeReviewModal);

        document.getElementById("review-modal").classList.remove("hidden");
      }

      async function saveEventReview(eventId, rating, comment) {
        const eventRef = doc(db, "events", eventId);

        await runTransaction(db, async (transaction) => {
          const eventDoc = await transaction.get(eventRef);
          if (!eventDoc.exists()) throw new Error("ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          const eventData = eventDoc.data();
          const reviews = eventData.reviews || [];

          // ê¸°ì¡´ í‰ê°€ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€
          const existingIndex = reviews.findIndex(
            (r) => r.studentId === currentUser.studentId
          );
          const review = {
            studentId: currentUser.studentId,
            studentName: currentUser.name,
            rating: rating,
            comment: comment,
            createdAt:
              existingIndex >= 0
                ? reviews[existingIndex].createdAt
                : new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          };

          if (existingIndex >= 0) {
            reviews[existingIndex] = review;
          } else {
            reviews.push(review);
          }

          transaction.update(eventRef, { reviews: reviews });
        });
      }

      function closeReviewModal() {
        document.getElementById("review-modal").classList.add("hidden");
      }

      // í‰ê°€ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("click", (e) => {
        if (
          e.target.id === "review-modal-close" ||
          e.target.closest("#review-modal-close")
        ) {
          closeReviewModal();
        }
        if (e.target.id === "review-modal" && !e.target.closest(".bg-white")) {
          closeReviewModal();
        }
      });

      /* ===== ë¸”ë¡ ê´€ë¦¬ ëª¨ë‹¬ ê¸°ëŠ¥ ===== */
      function openBlockModal(
        blockType = null,
        blockId = null,
        position = null
      ) {
        const modal = document.getElementById("block-management-modal");
        const title = document.getElementById("block-modal-title");
        const content = document.getElementById("block-modal-content");

        if (blockType && blockId) {
          // í¸ì§‘ ëª¨ë“œ
          console.log("=== ë¸”ë¡ ìˆ˜ì • ëª¨ë“œ ===");
          console.log("blockType:", blockType);
          console.log("blockId:", blockId);
          console.log("blocksData:", blocksData);

          const block = blocksData.find((b) => b.id === blockId);
          console.log("ì°¾ì€ ë¸”ë¡:", block);

          if (!block) {
            console.error("ë¸”ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
            return;
          }

          title.textContent = `${getBlockTypeName(blockType)} ë¸”ë¡ ìˆ˜ì •`;
          content.innerHTML = generateBlockForm(blockType, block);

          // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ (í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ)
          setTimeout(() => {
            const loadExistingData = () => {
              console.log("=== loadExistingData í˜¸ì¶œë¨ (í¸ì§‘ ëª¨ë“œ) ===");
              console.log("blockType:", blockType);
              console.log("block:", block);

              if (blockType === "scores") {
                if (block?.payload?.teams) {
                  console.log("ê¸°ì¡´ íŒ€ ë°ì´í„° ë¡œë“œ ì¤‘...", block.payload.teams);
                  block.payload.teams.forEach((team) => {
                    console.log("íŒ€ ì¶”ê°€:", team);
                    addModalScoreRow(team.name || "", team.score || 0);
                  });
                } else {
                  console.log("ìƒˆ ë¸”ë¡ ìƒì„± - ê¸°ë³¸ í–‰ ì¶”ê°€");
                  addModalScoreRow("", 0);
                }
              } else if (blockType === "qa") {
                if (block?.payload?.items) {
                  block.payload.items.forEach((item) => {
                    addModalQAItem(item.q || "", item.a || "");
                  });
                } else {
                  addModalQAItem("", "");
                }
              }
            };
            loadExistingData();
          }, 100);
        } else {
          // ìƒì„± ëª¨ë“œ
          title.textContent = "ìƒˆ ê³µì§€ ì¶”ê°€";
          content.innerHTML = generateBlockTypeSelector();
        }

        modal.classList.remove("hidden");
      }

      function closeBlockModal() {
        document
          .getElementById("block-management-modal")
          .classList.add("hidden");
      }

      // Make functions globally accessible for onclick handlers
      window.closeBlockModal = closeBlockModal;
      window.addModalScoreRow = addModalScoreRow;
      window.addModalQAItem = addModalQAItem;

      function getBlockTypeName(type) {
        const names = {
          notice: "ê³µì§€",
          qa: "Q&A",
          scores: "ì»¤ìŠ¤í…€ ì ìˆ˜íŒ",
          roadmap: "ë¡œë“œë§µ",
        };
        return names[type] || type;
      }

      function generateBlockTypeSelector() {
        return `
          <div class="space-y-4">
            <h4 class="text-lg font-semibold text-gray-700">ë¸”ë¡ íƒ€ì… ì„ íƒ</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <button type="button" class="p-4 border-2 border-orange-200 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition-colors" onclick="selectBlockType('notice')">
                <div class="text-center">
                  <i class="fas fa-bullhorn text-2xl text-orange-500 mb-2"></i>
                  <h5 class="font-semibold text-gray-800">ê³µì§€ ë¸”ë¡</h5>
                  <p class="text-sm text-gray-600">ì¤‘ìš”í•œ ê³µì§€ì‚¬í•­ì„ í‘œì‹œí•©ë‹ˆë‹¤</p>
                </div>
              </button>
              <button type="button" class="p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-colors" onclick="selectBlockType('qa')">
                <div class="text-center">
                  <i class="fas fa-question-circle text-2xl text-blue-500 mb-2"></i>
                  <h5 class="font-semibold text-gray-800">Q&A ë¸”ë¡</h5>
                  <p class="text-sm text-gray-600">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ê³¼ ë‹µë³€</p>
                </div>
              </button>
              <button type="button" class="p-4 border-2 border-green-200 rounded-lg hover:border-green-400 hover:bg-green-50 transition-colors" onclick="selectBlockType('scores')">
                <div class="text-center">
                  <i class="fas fa-trophy text-2xl text-green-500 mb-2"></i>
                  <h5 class="font-semibold text-gray-800">ì ìˆ˜íŒ ë¸”ë¡</h5>
                  <p class="text-sm text-gray-600">íŒ€ë³„ ì ìˆ˜ì™€ ìˆœìœ„ í‘œì‹œ</p>
                </div>
              </button>
              <button type="button" class="p-4 border-2 border-purple-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-colors" onclick="selectBlockType('roadmap')">
                <div class="text-center">
                  <i class="fas fa-map-signs text-2xl text-purple-500 mb-2"></i>
                  <h5 class="font-semibold text-gray-800">ë¡œë“œë§µ ë¸”ë¡</h5>
                  <p class="text-sm text-gray-600">Foodie í™œë™ ì¼ì •ê³¼ ë¡œë“œë§µ</p>
                </div>
              </button>
            </div>
          </div>
        `;
      }

      function selectBlockType(type) {
        const content = document.getElementById("block-modal-content");
        const title = document.getElementById("block-modal-title");

        title.textContent = `${getBlockTypeName(type)} ë¸”ë¡ ìƒì„±`;
        content.innerHTML = generateBlockForm(type);
      }

      // Make selectBlockType function globally accessible for onclick handlers
      window.selectBlockType = selectBlockType;

      function generateBlockForm(type, existingBlock = null) {
        const isEdit = !!existingBlock;

        if (type === "notice") {
          return `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="modal-notice-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì œëª©" value="${
                  existingBlock?.title || ""
                }">
                <select id="modal-notice-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="true" ${
                    existingBlock?.visible !== false ? "selected" : ""
                  }>ë…¸ì¶œ</option>
                  <option value="false" ${
                    existingBlock?.visible === false ? "selected" : ""
                  }>ìˆ¨ê¹€</option>
                </select>
                <select id="modal-notice-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="" ${
                    !existingBlock?.showWhen ? "selected" : ""
                  }>í•­ìƒ í‘œì‹œ</option>
                  <option value="login" ${
                    existingBlock?.showWhen === "login" ? "selected" : ""
                  }>ë¡œê·¸ì¸ì‹œë§Œ</option>
                  <option value="logout" ${
                    existingBlock?.showWhen === "logout" ? "selected" : ""
                  }>ë¡œê·¸ì•„ì›ƒì‹œë§Œ</option>
                </select>
              </div>
              <textarea id="modal-notice-html" rows="6" class="w-full px-3 py-2 border rounded" placeholder="ë‚´ìš©(HTML/í…ìŠ¤íŠ¸)">${
                existingBlock?.payload?.html || ""
              }</textarea>
              <div class="flex gap-3">
                <button type="button" onclick="saveBlock('notice', '${
                  existingBlock?.id || ""
                }')" class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>${isEdit ? "ìˆ˜ì •" : "ìƒì„±"}
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          `;
          loadExistingData();
        }

        if (type === "qa") {
          return `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="modal-qa-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ì œëª©" value="${
                  existingBlock?.title || ""
                }">
                <select id="modal-qa-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="true" ${
                    existingBlock?.visible !== false ? "selected" : ""
                  }>ë…¸ì¶œ</option>
                  <option value="false" ${
                    existingBlock?.visible === false ? "selected" : ""
                  }>ìˆ¨ê¹€</option>
                </select>
                <select id="modal-qa-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="" ${
                    !existingBlock?.showWhen ? "selected" : ""
                  }>í•­ìƒ í‘œì‹œ</option>
                  <option value="login" ${
                    existingBlock?.showWhen === "login" ? "selected" : ""
                  }>ë¡œê·¸ì¸ì‹œë§Œ</option>
                  <option value="logout" ${
                    existingBlock?.showWhen === "logout" ? "selected" : ""
                  }>ë¡œê·¸ì•„ì›ƒì‹œë§Œ</option>
                </select>
              </div>
              <div id="modal-qa-items" class="space-y-2"></div>
              <button type="button" onclick="addModalQAItem()" class="text-sm bg-blue-100 text-blue-700 border border-blue-300 px-3 py-1 rounded hover:bg-blue-200 transition-colors">
                <i class="fas fa-plus mr-1"></i>ì§ˆë¬¸ ì¶”ê°€
              </button>
              <div class="flex gap-3">
                <button type="button" onclick="saveBlock('qa', '${
                  existingBlock?.id || ""
                }')" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>${isEdit ? "ìˆ˜ì •" : "ìƒì„±"}
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          `;
          loadExistingData();
        }

        if (type === "scores") {
          return `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="modal-scores-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ë¸”ë¡ ì´ë¦„(ì œëª©)" value="${
                  existingBlock?.title || ""
                }">
                <select id="modal-scores-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="true" ${
                    existingBlock?.visible !== false ? "selected" : ""
                  }>ë…¸ì¶œ</option>
                  <option value="false" ${
                    existingBlock?.visible === false ? "selected" : ""
                  }>ìˆ¨ê¹€</option>
                </select>
                <select id="modal-scores-showWhen" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="" ${
                    !existingBlock?.showWhen ? "selected" : ""
                  }>í•­ìƒ í‘œì‹œ</option>
                  <option value="login" ${
                    existingBlock?.showWhen === "login" ? "selected" : ""
                  }>ë¡œê·¸ì¸ì‹œë§Œ</option>
                  <option value="logout" ${
                    existingBlock?.showWhen === "logout" ? "selected" : ""
                  }>ë¡œê·¸ì•„ì›ƒì‹œë§Œ</option>
                </select>
              </div>
              <div id="modal-scores-rows" class="space-y-2"></div>
              <button type="button" onclick="addModalScoreRow()" class="text-sm bg-green-100 text-green-700 border border-green-300 px-3 py-1 rounded hover:bg-green-200 transition-colors">
                <i class="fas fa-plus mr-1"></i>íŒ€ ì¶”ê°€
              </button>
              <div class="flex gap-3">
                <button type="button" onclick="saveBlock('scores', '${
                  existingBlock?.id || ""
                }')" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>${isEdit ? "ìˆ˜ì •" : "ìƒì„±"}
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          `;
        }

        if (type === "roadmap") {
          return `
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <input id="modal-roadmap-title" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="í™œë™ ì´ë¦„" value="${
                  existingBlock?.title || ""
                }">
                <input id="modal-roadmap-date" type="date" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" value="${
                  existingBlock?.payload?.date || ""
                }">
                <select id="modal-roadmap-visible" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="true" ${
                    existingBlock?.visible !== false ? "selected" : ""
                  }>ë…¸ì¶œ</option>
                  <option value="false" ${
                    existingBlock?.visible === false ? "selected" : ""
                  }>ìˆ¨ê¹€</option>
                </select>
              </div>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">í‘œì‹œ ì¡°ê±´</label>
                  <select id="modal-roadmap-showWhen" class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300">
                  <option value="" ${
                    !existingBlock?.showWhen ? "selected" : ""
                  }>í•­ìƒ í‘œì‹œ</option>
                  <option value="login" ${
                    existingBlock?.showWhen === "login" ? "selected" : ""
                  }>ë¡œê·¸ì¸ì‹œë§Œ</option>
                  <option value="logout" ${
                    existingBlock?.showWhen === "logout" ? "selected" : ""
                  }>ë¡œê·¸ì•„ì›ƒì‹œë§Œ</option>
                </select>
                <input id="modal-roadmap-order" type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300" placeholder="ìˆœì„œ (ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ì•ì— í‘œì‹œ)" value="${
                  existingBlock?.order || ""
                }">
              </div>
              <textarea id="modal-roadmap-description" rows="3" class="w-full px-3 py-2 border rounded" placeholder="í™œë™ ì„¤ëª… (ì„ íƒì‚¬í•­)">${
                existingBlock?.payload?.description || ""
              }</textarea>
              <div class="flex gap-2">
                <button type="button" onclick="saveBlock('roadmap', '${
                  existingBlock?.id || ""
                }')" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                  <i class="fas fa-save mr-2"></i>${isEdit ? "ìˆ˜ì •" : "ìƒì„±"}
                </button>
                <button type="button" onclick="closeBlockModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                  ì·¨ì†Œ
                </button>
              </div>
            </div>
          `;
          loadExistingData();
        }

        return '<p class="text-gray-500">ì•Œ ìˆ˜ ì—†ëŠ” ë¸”ë¡ íƒ€ì…ì…ë‹ˆë‹¤.</p>';
      }

      // ë¸”ë¡ ì €ì¥ í•¨ìˆ˜
      async function saveBlock(type, blockId = null) {
        try {
          const isEdit = !!blockId;

          if (type === "notice") {
            const title = document
              .getElementById("modal-notice-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-notice-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-notice-showWhen")?.value || "";
            const html =
              document.getElementById("modal-notice-html")?.value || "";

            if (!title) {
              showAlert("ğŸ˜¥", "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "notice",
                title,
                visible,
                showWhen,
                payload: { html },
              });
              showAlert("âœ…", "ê³µì§€ ë¸”ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "notice",
                title,
                visible,
                showWhen,
                payload: { html },
                order: ord,
              });
              showAlert("ğŸ‰", "ê³µì§€ ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          }

          if (type === "qa") {
            const title = document
              .getElementById("modal-qa-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-qa-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-qa-showWhen")?.value || "";
            const items = getModalQAItems();

            if (!title) {
              showAlert("ğŸ˜¥", "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }
            if (items.length === 0) {
              showAlert("ğŸ˜¥", "ì§ˆë¬¸/ë‹µë³€ì„ 1ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");
              return;
            }

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "qa",
                title,
                visible,
                showWhen,
                payload: { items },
              });
              showAlert("âœ…", "Q&A ë¸”ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "qa",
                title,
                visible,
                showWhen,
                payload: { items },
                order: ord,
              });
              showAlert("ğŸ‰", "Q&A ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          }

          if (type === "scores") {
            const title = document
              .getElementById("modal-scores-title")
              ?.value.trim();
            const visible =
              document.getElementById("modal-scores-visible")?.value === "true";
            const showWhen =
              document.getElementById("modal-scores-showWhen")?.value || "";
            const teams = getModalScoreTeams();

            if (!title) {
              showAlert("ğŸ˜¥", "ë¸”ë¡ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }
            if (teams.length === 0) {
              showAlert("ğŸ˜¥", "ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¡°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
              return;
            }

            const payload = { teams };

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "scores",
                title,
                visible,
                showWhen,
                payload,
              });
              showAlert("âœ…", "ì ìˆ˜íŒ ë¸”ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "scores",
                title,
                visible,
                showWhen,
                payload,
                order: ord,
              });
              showAlert("ğŸ‰", "ì ìˆ˜íŒ ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          }

          if (type === "roadmap") {
            const title = document
              .getElementById("modal-roadmap-title")
              ?.value.trim();
            const date = document.getElementById("modal-roadmap-date")?.value;
            const visible =
              document.getElementById("modal-roadmap-visible")?.value ===
              "true";
            const showWhen =
              document.getElementById("modal-roadmap-showWhen")?.value || "";
            const order =
              parseInt(document.getElementById("modal-roadmap-order")?.value) ||
              0;
            const description =
              document
                .getElementById("modal-roadmap-description")
                ?.value.trim() || "";

            if (!title) {
              showAlert("ğŸ˜¥", "í™œë™ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }
            if (!date) {
              showAlert("ğŸ˜¥", "í™œë™ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
              return;
            }

            const payload = { date, description };

            if (isEdit) {
              await updateDoc(doc(db, "homepageBlocks", blockId), {
                type: "roadmap",
                title,
                visible,
                showWhen,
                order,
                payload,
              });
              showAlert("âœ…", "ë¡œë“œë§µ ë¸”ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
              const ord = blocksData?.length || 0;
              await addDoc(collection(db, "homepageBlocks"), {
                type: "roadmap",
                title,
                visible,
                showWhen,
                order: order || ord,
                payload,
              });
              showAlert("ğŸ‰", "ë¡œë“œë§µ ë¸”ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          }

          closeBlockModal();
          // ë¸”ë¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          if (document.getElementById("subtab-container")) {
            renderHomeBlocksAdmin(document.getElementById("subtab-container"));
          }
        } catch (error) {
          console.error("ë¸”ë¡ ì €ì¥ ì˜¤ë¥˜:", error);
          showAlert("ğŸ˜¥", "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // Make saveBlock function globally accessible for onclick handlers
      window.saveBlock = saveBlock;

      // ëª¨ë‹¬ Q&A ì•„ì´í…œ ìˆ˜ì§‘
      function getModalQAItems() {
        const rows = [...document.querySelectorAll("#modal-qa-items .qa-row")];
        return rows
          .map((row) => ({
            q: row.querySelector("[data-q]")?.value.trim() || "",
            a: row.querySelector("[data-a]")?.value.trim() || "",
          }))
          .filter((item) => item.q && item.a);
      }

      // ëª¨ë‹¬ ì ìˆ˜ íŒ€ ìˆ˜ì§‘
      function getModalScoreTeams() {
        const rows = [
          ...document.querySelectorAll("#modal-scores-rows .score-row"),
        ];
        return rows
          .map((row) => ({
            name: row.querySelector("[data-name]")?.value.trim() || "",
            score: Number(row.querySelector("[data-score]")?.value || 0),
          }))
          .filter((team) => team.name);
      }

      // ëª¨ë‹¬ Q&A ì•„ì´í…œ ì¶”ê°€
      function addModalQAItem(q = "", a = "") {
        const container = document.getElementById("modal-qa-items");
        if (!container) return;

        container.insertAdjacentHTML(
          "beforeend",
          `
          <div class="qa-row border rounded-lg p-4 bg-gray-50 mb-3">
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">ì§ˆë¬¸</label>
              <textarea data-q class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 min-h-[80px] resize-y" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì¤„ë°”ê¿ˆ(Enter)ìœ¼ë¡œ ë¬¸ë‹¨ì„ ë‚˜ëˆŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤">${saf(
                q
              )}</textarea>
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">ë‹µë³€</label>
              <textarea data-a class="w-full px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 min-h-[120px] resize-y" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”&#10;ì¤„ë°”ê¿ˆ(Enter)ìœ¼ë¡œ ë¬¸ë‹¨ì„ ë‚˜ëˆŒ ìˆ˜ ìˆìŠµë‹ˆë‹¤">${saf(
                a
              )}</textarea>
            </div>
            <div class="flex justify-end">
              <button type="button" class="remove-qa bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors" onclick="this.closest('.qa-row').remove()">
                <i class="fas fa-trash mr-1"></i>ì‚­ì œ
              </button>
            </div>
          </div>
        `
        );
      }

      // ëª¨ë‹¬ ì ìˆ˜ í–‰ ì¶”ê°€
      function addModalScoreRow(name = "", score = 0) {
        console.log("=== addModalScoreRow í˜¸ì¶œ ===");
        console.log("name:", name, "score:", score);

        const container = document.getElementById("modal-scores-rows");
        console.log("container:", container);

        if (!container) {
          console.error("modal-scores-rows ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          return;
        }

        // ì¤‘ë³µ íŒ€ ì´ë¦„ ì²´í¬ (ë¹ˆ ì´ë¦„ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
        if (name.trim()) {
          const existingRows = container.querySelectorAll(".score-row");
          for (const row of existingRows) {
            const existingName = row.querySelector("[data-name]")?.value.trim();
            if (existingName && existingName === name.trim()) {
              showAlert("ğŸ˜¥", `"${name}" íŒ€ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
              return;
            }
          }
        }

        container.insertAdjacentHTML(
          "beforeend",
          `
          <div class="score-row grid grid-cols-12 gap-2">
            <input data-name class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-7" placeholder="ì¡° ì´ë¦„" value="${saf(
              name
            )}">
            <input data-score type="number" class="px-3 py-2 border rounded bg-white text-gray-900 border-gray-300 col-span-4" placeholder="ì ìˆ˜" value="${saf(
              score
            )}">
            <button type="button" class="remove-score-row text-red-600 col-span-1" onclick="this.closest('.score-row').remove()">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `
        );
        console.log("ì ìˆ˜ í–‰ ì¶”ê°€ ì™„ë£Œ");
      }

      // ë¸”ë¡ ê´€ë¦¬ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener("click", (e) => {
        if (
          e.target.id === "block-modal-close" ||
          e.target.closest("#block-modal-close")
        ) {
          closeBlockModal();
        }
        if (
          e.target.id === "block-management-modal" &&
          !e.target.closest(".bg-white")
        ) {
          closeBlockModal();
        }
      });

      // ìë™ ë§ˆê° ìŠ¤ì¼€ì¤„ëŸ¬ ì´ˆê¸°í™”
      setupAutoCloseScheduler();

      // ===================== (ë) =====================
    </script>

    <!-- ë¸”ë¡ ê´€ë¦¬ ëª¨ë‹¬ -->
    <div
      id="block-management-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9996]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="block-modal-title" class="text-2xl font-bold text-gray-800">
            ë¸”ë¡ ê´€ë¦¬
          </h3>
          <button
            id="block-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="block-modal-content">
          <!-- ë¸”ë¡ ê´€ë¦¬ í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <!-- í‰ê°€ ì‘ì„± ëª¨ë‹¬ -->
    <div
      id="review-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9997]"
    >
      <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-md w-full">
        <div class="flex justify-between items-center mb-6">
          <h3 id="review-modal-title" class="text-xl font-bold text-gray-800">
            ì´ë²¤íŠ¸ í‰ê°€
          </h3>
          <button
            id="review-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="review-modal-content">
          <!-- í‰ê°€ í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <!-- ì´ë²¤íŠ¸ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <div
      id="event-modal"
      class="hidden fixed inset-0 bg-black/50 flex justify-center items-center px-4 z-[9998]"
    >
      <div
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 id="event-modal-title" class="text-2xl font-bold text-gray-800">
            ì´ë²¤íŠ¸Â·ë¯¸ì‹íšŒ ìƒì„±
          </h3>
          <button
            id="event-modal-close"
            class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full transition-colors"
            title="ë‹«ê¸°"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>
        <div id="event-modal-content">
          <!-- ì´ë²¤íŠ¸ ìƒì„± í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
  </body>
</html>
